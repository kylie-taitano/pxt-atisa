name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
      
      - name: Install PXT CLI
        run: |
          sudo npm install -g pxt
      
      - name: Install dependencies
        run: |
          npm install
      
      - name: Clone pxt-core
        run: |
          if [ ! -d ../pxt ]; then
            # Using atisatech fork with customizations integration branch
            git clone --depth=1 -b atisa-customizations https://github.com/atisatech/pxt.git ../pxt
            cd ../pxt
            npm install
            npm run build
          fi
        working-directory: .
      
      - name: Clone pxt-common-packages
        run: |
          if [ ! -d ../pxt-common-packages ]; then
            git clone --depth=1 https://github.com/microsoft/pxt-common-packages.git ../pxt-common-packages
            cd ../pxt-common-packages
            npm install
          fi
        working-directory: .
      
      - name: Link pxt dependencies
        run: |
          rm -rf node_modules/pxt-core
          rm -rf node_modules/pxt-common-packages
          pxt link ../pxt
          pxt link ../pxt-common-packages
      
      - name: Build static package
        run: |
          pxt staticpkg --route pxt-atisa || true
      
      - name: Deploy to gh-pages
        if: success()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Save source static files BEFORE switching branches (git reset --hard wipes them)
          if [ -d "docs/static" ]; then
            mkdir -p /tmp/source-static
            cp -r docs/static/* /tmp/source-static/ 2>/dev/null || true
          fi
          # Save source docs (markdown, etc.) excluding docs/static
          echo "=== DEBUG: Checking for docs directory ==="
          pwd
          ls -la | grep docs || echo "docs not in current directory"
          if [ -d "docs" ]; then
            echo "✅ docs/ directory found"
            echo "=== DEBUG: Listing docs contents ==="
            ls -la docs/ | head -20
            echo "=== DEBUG: Checking for tutorial file ==="
            ls -la docs/projects/chanukah/light-up-your-menorah.md 2>&1 && echo "✅ Tutorial file found in source!" || echo "❌ Tutorial file NOT in source!"
            mkdir -p /tmp/source-docs
            echo "=== DEBUG: Running rsync to save docs ==="
            rsync -av --exclude "static" docs/ /tmp/source-docs/ 2>&1 | head -20 || echo "⚠️ rsync failed"
            echo "=== DEBUG: Verifying saved docs ==="
            ls -la /tmp/source-docs/projects/chanukah/ 2>&1 | head -10 || echo "⚠️ chanukah folder not in saved docs"
          else
            echo "❌ docs/ directory NOT FOUND in source!"
          fi
          
          # Create or checkout gh-pages branch
          git checkout --orphan gh-pages || git checkout gh-pages
          git reset --hard
          
          # Copy built files (if build succeeded)
          if [ -d "built/packaged/pxt-atisa" ]; then
            echo "✅ Build succeeded - copying built files"
            cp -r built/packaged/pxt-atisa/* .
          else
            echo "⚠️ Build failed or incomplete - built/packaged/pxt-atisa not found"
            echo "=== DEBUG: Checking if built directory exists ==="
            ls -la built/ 2>&1 | head -10 || echo "⚠️ built/ directory does not exist"
          fi
          
          # Copy source static files (pxt staticpkg doesn't include them)
          # Always restore these regardless of build status
          if [ -d "/tmp/source-static" ]; then
            mkdir -p docs/static
            cp -r /tmp/source-static/* docs/static/ 2>/dev/null || true
            # Also copy to /static/ for markdown references that use /static/ paths
            mkdir -p static
            cp -r /tmp/source-static/* static/ 2>/dev/null || true
          fi
          
          # Restore source docs (markdown, etc.) so docs/*.md are available on gh-pages
          # Always restore these regardless of build status
          echo "=== DEBUG: Restoring docs to gh-pages ==="
          if [ -d "/tmp/source-docs" ]; then
            echo "✅ /tmp/source-docs exists"
            echo "=== DEBUG: Contents of /tmp/source-docs ==="
            ls -la /tmp/source-docs/ | head -20
            mkdir -p docs
            echo "=== DEBUG: Running rsync to restore docs ==="
            rsync -av /tmp/source-docs/ docs/ 2>&1 | head -20 || echo "⚠️ rsync restore failed"
            echo "=== DEBUG: Verifying restored docs ==="
            ls -la docs/projects/chanukah/light-up-your-menorah.md 2>&1 && echo "✅ Tutorial file restored!" || echo "❌ Tutorial file NOT restored!"
          else
            echo "❌ /tmp/source-docs does NOT exist - docs were not saved!"
          fi
          
          # Cleanup (always run regardless of build status)
          rm -rf built node_modules pxt_modules libs .github .vscode .pxt
          rm -f .gitignore .cursorrules LICENSE README.md SECURITY.md .travis.yml .clang-format .gitattributes
          find . -name "*.md" -not -path "./docs/*" -delete || true
          
          # Final verification
          echo "=== DEBUG: Final check - docs directory contents ==="
          ls -la docs/ 2>&1 | head -20 || echo "⚠️ docs/ directory is empty or missing"
          echo "=== DEBUG: Final check - tutorial file ==="
          find . -name "light-up-your-menorah.md" 2>&1 && echo "✅ Tutorial file found somewhere!" || echo "❌ Tutorial file NOT FOUND anywhere!"
          
          # Ensure .nojekyll exists to bypass Jekyll processing for static assets
          touch .nojekyll
          
          # Final verification before commit
          echo "=== Verification: Static files ==="
          ls -la docs/static/logo.svg 2>/dev/null && echo "✅ logo.svg exists" || echo "❌ logo.svg missing"
          ls -la docs/static/Microsoft-logo* 2>/dev/null && echo "✅ Microsoft-logo files exist" || echo "❌ Microsoft-logo files missing"
          
          # Commit and push
          git add -A
          git commit -m "Deploy to GitHub Pages [skip ci]" || exit 0
          git push -f origin gh-pages || exit 0
