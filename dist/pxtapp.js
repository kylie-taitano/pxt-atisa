var e=(()=>{function U(e,t){postMessage({action:Ue,cbn:t,result:e})}function m(e){var t=[];return t[e-1]=void 0,t}function b(e,t){return r(e[0]+t[0],e[1]+t[1])}function P(e,t){return r=~~Math.max(Math.min(e[1]/a,2147483647),-2147483648)&~~Math.max(Math.min(t[1]/a,2147483647),-2147483648),(e=e=w(e)&w(t))<0&&(e+=a),[e,r*a];var r}function v(e,t){var r,i;return e[0]==t[0]&&e[1]==t[1]?0:(r=e[1]<0,i=t[1]<0,r&&!i||(r||!i)&&L(e,t)[1]<0?-1:1)}function r(e,t){var r,i;for(e%=0x10000000000000000,t=(t%=0x10000000000000000)-(r=t%a)+(i=Math.floor(e/a)*a),e=e-i+r;e<0;)e+=a,t-=a;for(;4294967295<e;)e-=a,t+=a;for(t%=0x10000000000000000;0x7fffffff00000000<t;)t-=0x10000000000000000;for(;t<-0x8000000000000000;)t+=0x10000000000000000;return[e,t]}function N(e,t){return e[0]==t[0]&&e[1]==t[1]}function y(e){return 0<=e?[e,0]:[e+a,-a]}function w(e){return 2147483648<=e[0]?~~Math.max(Math.min(e[0]-a,2147483647),-2147483648):~~Math.max(Math.min(e[0],2147483647),-2147483648)}function i(e){return e<=30?1<<e:i(30)*i(e-30)}function O(e,t){var r;if(t&=63,N(e,Pe))return t?_:e;if(e[1]<0)throw Error("Neg");return t=i(t),r=e[1]*t%0x10000000000000000,0x8000000000000000<=(r+=t=(e=e[0]*t)-e%a)&&(r-=0x10000000000000000),[e-=t,r]}function R(e,t){t=i(t&=63);return r(Math.floor(e[0]/t),e[1]/t)}function L(e,t){return r(e[0]-t[0],e[1]-t[1])}function M(e,t){return e.Mc=t,e.Lc=0,e.Yb=t.length,e}function c(e){return e.Lc>=e.Yb?-1:255&e.Mc[e.Lc++]}function D(e){return e.Mc=m(32),e.Yb=0,e}function u(e){var t=e.Mc;return t.length=e.Yb,t}function F(e,t){e.Mc[e.Yb++]=t<<24>>24}function B(e,t,r,i){j(t,r,e.Mc,e.Yb,i),e.Yb+=i}function j(e,t,r,i,n){for(var s=0;s<n;++s)r[i+s]=e[t+s]}function $(t,r,i,n,s){var a;if(v(n,I)<0)throw Error("invalid length "+n);t.Tb=n;var o=(e=>{var t;for(e.v=m(4),e.a=[],e.d={},e.C=m(192),e.bb=m(12),e.hb=m(12),e.Ub=m(12),e.vc=m(12),e._=m(192),e.K=[],e.Sb=m(114),e.S=g({},4),e.$=Ae({}),e.i=Ae({}),e.A={},e.m=[],e.P=[],e.lb=[],e.nc=m(16),e.x=m(4),e.Q=m(4),e.Xb=[_],e.uc=[_],e.Kc=[0],e.fc=m(5),e.yc=m(128),e.vb=0,e.X=1,e.D=0,e.Hb=-1,t=e.mb=0;t<4096;++t)e.a[t]={};for(t=0;t<4;++t)e.K[t]=g({},6);return e})({}),l=o,c=l,u=1<<s.s;c.ab=u;for(var d,h=0;1<<h<u;++h);c.$b=2*h,l.n=s.f,c=s.m,d=(s=l).X,s.X=c,s.b&&d!=s.X&&(s.wb=-1,s.b=null),l.eb=0,l.fb=3,l.Y=2,l.y=3,o.Gc=void 0===e.disableEndMark;var p=o,c=i;p.fc[0]=9*(5*p.Y+p.eb)+p.fb<<24>>24;for(var f=0;f<4;++f)p.fc[1+f]=p.ab>>8*f<<24>>24;for(B(c,p.fc,0,5),a=0;a<64;a+=8)F(i,255&w(R(n,a)));t.yb=(o.W=0,o.oc=r,o.pc=0,(d=o).b||(s={},l=4,d.X||(l=2),((e,t)=>{e.qb=2<t,e.qb?(e.w=0,e.xb=4,e.R=66560):(e.w=2,e.xb=3,e.R=0)})(s,l),d.b=s),((e,t,r)=>{var i,n;if(null==e.V||e.u!=r||e.I!=t)for(e.I=t,e.qc=(1<<t)-1,e.u=r,e.V=m(n=1<<e.u+e.I),i=0;i<n;++i)e.V[i]=(e=>(e.tb=m(768),e))({})})(d.A,d.eb,d.fb),d.ab==d.wb&&d.Hb==d.n||(((e,t,r,i,n)=>{t<1073741567&&(e.Fc=16+(i>>1),((e,t,r,i)=>{t=(e.Bc=t)+(e._b=r)+i,null!=e.c&&e.Kb==t||(e.c=null,e.Kb=t,e.c=m(e.Kb)),e.H=e.Kb-r})(e,t+r,i+n,256+~~((t+r+i+n)/2)),e.ob=i,e.p!=(r=t+1)&&(e.L=m(2*(e.p=r))),n=65536,e.qb&&(n=t-1,16777216<(n=(n=(n=(n=(n|=n>>1)|n>>2)|n>>4)|n>>8)>>1|65535)&&(n>>=1),e.Ec=n,++n,n+=e.R),n!=e.rc)&&(e.ub=m(e.rc=n))})(d.b,d.ab,4096,d.n,274),d.wb=d.ab,d.Hb=d.n),o.d.Ab=i,(e=>{var t=e;t.l=0;for(var r=t.J=0;r<4;++r)t.v[r]=0;var i,n=e.d,s=(n.mc=_,n.xc=_,n.E=-1,n.Jb=1,n.Oc=0,x(e.C),x(e._),x(e.bb),x(e.hb),x(e.Ub),x(e.vc),x(e.Sb),e.A),a=1<<s.u+s.I;for(i=0;i<a;++i)x(s.V[i].tb);for(var o=0;o<4;++o)x(e.K[o].G);ve(e.$,1<<e.Y),ve(e.i,1<<e.Y),x(e.S.G),e.N=0,e.jb=0,e.q=0,e.s=0})(o),de(o),ue(o),o.$.rb=o.n+1-2,ke(o.$,1<<o.Y),o.i.rb=o.n+1-2,ke(o.i,1<<o.Y),o.g=_,c=o,(t={}).cb=c,t.Z=null,t.zc=1,t)}function V(e,t,r){return e.Nb=D({}),$(e,M({},t),e.Nb,y(t.length),r),e}function q(e,t,r){for(var i,n,s,a="",o=[],l=0;l<5;++l){if(-1==(n=c(t)))throw Error("truncated input");o[l]=n<<24>>24}if(!((e,t)=>{var r,i,n,s,a;if(!(t.length<5)){for(n=(a=255&t[0])%9,s=(a=~~(a/9))%5,a=~~(a/5),i=r=0;i<4;++i)r+=(255&t[1+i])<<8*i;return!(99999999<r)&&((e,t,r,i)=>{if(!(8<t||4<r||4<i)){var n=e.gb,s=r,a,o;if(null==n.V||n.u!=t||n.I!=s)for(n.I=s,n.qc=(1<<s)-1,n.u=t,n.V=m(o=1<<n.u+n.I),a=0;a<o;++a)n.V[a]=(e=>(e.Ib=m(768),e))({});return se(e.Rb,r=1<<i),se(e.sb,r),e.Dc=r-1,1}})(e,n,s,a)&&((e,t)=>!(t<0)&&(e.Ob!=t&&(e.Ob=t,e.nb=Math.max(e.Ob,1),((e,t)=>{null!=e.Lb&&e.M==t||(e.Lb=m(t)),e.M=t,e.o=0,e.h=0})(e.B,Math.max(e.nb,4096))),1))(e,r)}})(i=(e=>{e.B={},e.e={},e.Gb=m(192),e.Zb=m(12),e.Cb=m(12),e.Db=m(12),e.Eb=m(12),e.pb=m(192),e.kb=m(4),e.kc=m(114),e.Fb=h({},4),e.Rb=oe({}),e.sb=oe({}),e.gb={};for(var t=0;t<4;++t)e.kb[t]=h({},6);return e})({}),o))throw Error("corrupted input");for(l=0;l<64;l+=8){if(-1==(n=c(t)))throw Error("truncated input");a=(n=1==(n=n.toString(16)).length?"0"+n:n)+""+a}/^0+$|^f+$/i.test(a)?e.Tb=I:(s=parseInt(a,16),e.Tb=4294967295<s?I:y(s)),e.yb=(s=r,r=e.Tb,(e=i).e.Ab=t,ne(e.B),e.B.cc=s,(e=>{e.B.h=0,e.B.o=0,x(e.Gb),x(e.pb),x(e.Zb),x(e.Cb),x(e.Db),x(e.Eb),x(e.kc);var t,r,i=e.gb;for(r=1<<i.u+i.I,t=0;t<r;++t)x(i.V[t].Ib);for(var n=0;n<4;++n)x(e.kb[n].G);le(e.Rb),le(e.sb),x(e.Fb.G);var s=e.e;s.Bb=0,s.E=-1;for(var a=0;a<5;++a)s.Bb=s.Bb<<8|c(s.Ab)})(e),e.U=0,e.ib=0,e.Jc=0,e.Ic=0,e.Qc=0,e.Nc=r,e.g=_,e.jc=0,((e,t)=>(e.Z=t,e.cb=null,e.zc=1,e))({},e))}function H(e,t){return e.Nb=D({}),q(e,M({},t),e.Nb),e}function z(e,t){return e.c[e.f+e.o+t]}function G(e,t,r,i){var n,s;for(e.T&&e.o+t+i>e.h&&(i=e.h-(e.o+t)),++r,s=e.f+e.o+t,n=0;n<i&&e.c[s+n]==e.c[s+n-r];++n);return n}function W(e){return e.h-e.o}function ee(e){var t,r,i,n;if(!e.T)for(;;){if(!(n=-e.f+e.Kb-e.h))return;if(t=e.cc,r=e.c,i=e.f+e.h,n=n,-1==(r=t.Lc>=t.Yb?-1:(n=Math.min(n,t.Yb-t.Lc),j(t.Mc,t.Lc,r,i,n),t.Lc+=n,n)))return e.zb=e.h,e.H<e.f+e.zb&&(e.zb=e.H-e.f),e.T=1;e.h+=r,e.o+e._b<=e.h&&(e.zb=e.h-e._b)}}function te(e,t){e.f+=t,e.zb-=t,e.o-=t,e.h-=t}function k(e){++e.k>=e.p&&(e.k=0);var t,r=e;if(++r.o,r.zb<r.o){if(t=r.f+r.o,r.H<t){var i,n,s=r,a=s.f+s.o-s.Bc;for(0<a&&--a,n=s.f+s.h-a,i=0;i<n;++i)s.c[i]=s.c[a+i];s.f-=a}ee(r)}1073741823==e.o&&(t=e.o-e.p,re(e.L,2*e.p,t),re(e.ub,e.rc,t),te(e,t))}function re(e,t,r){for(var i,n=0;n<t;++n)(i=e[n]||0)<=r?i=0:i-=r,e[n]=i}function n(e){var t=e.o-e.h;t&&(B(e.cc,e.Lb,e.h,t),e.M<=e.o&&(e.o=0),e.h=e.o)}function ie(e,t){t=e.o-t-1;return t<0&&(t+=e.M),e.Lb[t]}function ne(e){n(e),e.cc=null}function A(e){return(e-=2)<4?e:3}function J(e){return e<4?0:e<10?e-3:e-6}function d(e){if(e.zc){if(e.cb){r=e,((e,t,r,i)=>{var n,s,a,o,l,c,u,d,h,p,f,m;{var g;t[0]=_,r[0]=_,i[0]=1,e.oc&&(e.b.cc=e.oc,(g=e.b).f=0,g.o=0,g.h=0,g.T=0,ee(g),g.k=0,te(g,-1),e.W=1,e.oc=null)}if(!e.pc){if(e.pc=1,N(f=e.g,_)){if(!W(e.b))return he(e,w(e.g));me(e),p=w(e.g)&e.y,T(e.d,e.C,(e.l<<4)+p,0),e.l=J(e.l),s=z(e.b,-e.s),Ee(X(e.A,w(e.g),e.J),e.d,s),e.J=s,--e.s,e.g=b(e.g,Ne)}if(W(e.b))for(;;){if(c=((e,t)=>{var r,M,D,i,n,s,F,a,o,l,c,u,d,B,h,p,f,j,$,m,g,V,b,v,y,w,A,k,E,x,T,S,q,C,H,I,_,U,P,N,O,R;if(e.jb!=e.q)return L=e.a[e.q].r-e.q,e.mb=e.a[e.q].j,e.q=e.a[e.q].r,L;if(e.q=e.jb=0,e.N?(c=e.vb,e.N=0):c=me(e),y=e.D,(b=W(e.b)+1)<2)return e.mb=-1,1;for(273<b&&(b=273),a=_=0;a<4;++a)e.x[a]=e.v[a],e.Q[a]=G(e.b,-1,e.x[a],273),e.Q[a]>e.Q[_]&&(_=a);if(e.Q[_]>=e.n)return e.mb=_,L=e.Q[_],fe(e,L-1),L;if(e.n<=c)return e.mb=e.m[y-1]+4,fe(e,c-1),c;if(s=z(e.b,-1),h=z(e.b,-e.v[0]-1-1),c<2&&s!=h&&e.Q[_]<2)return e.mb=-1,1;{var L;e.a[0].Hc=e.l,T=t&e.y,e.a[1].z=Z[e.C[(e.l<<4)+T]>>>2]+Q(X(e.A,t,e.J),7<=e.l,h,s),xe(e.a[1]),p=Z[2048-e.C[(e.l<<4)+T]>>>2],I=p+Z[2048-e.bb[e.l]>>>2],h==s&&(U=I+((e,t,r)=>Z[e.hb[t]>>>2]+Z[e._[(t<<4)+r]>>>2])(e,e.l,T),e.a[1].z>U)&&(e.a[1].z=U,(L=e.a[1]).j=0,L.t=0)}if((l=c>=e.Q[_]?c:e.Q[_])<2)return e.mb=e.a[1].j,1;for(e.a[1].r=0,e.a[0].bc=e.x[0],e.a[0].ac=e.x[1],e.a[0].dc=e.x[2],e.a[0].lc=e.x[3],o=l;e.a[o--].z=268435455,2<=o;);for(a=0;a<4;++a)if(!((H=e.Q[a])<2))for(q=I+Y(e,a,e.l,T);i=q+K(e.i,H-2,T),(k=e.a[H]).z>i&&(k.z=i,k.r=0,k.j=a,k.t=0),2<=--H;);if(V=p+Z[e.bb[e.l]>>>2],(o=2<=e.Q[0]?e.Q[0]+1:2)<=c){for(w=0;o>e.m[w];)w+=2;for(;F=e.m[w+1],i=V+pe(e,F,o,T),(k=e.a[o]).z>i&&(k.z=i,k.r=0,k.j=F+4,k.t=0),o!=e.m[w]||(w+=2)!=y;++o);}for(r=0;;){if(++r==l)return ce(e,r);if(f=me(e),y=e.D,e.n<=f)return e.vb=f,e.N=1,ce(e,r);if(++t,x=e.a[r].r,N=e.a[r].t?(--x,J(N=e.a[r].Ac?(N=e.a[e.a[r].r2].Hc,e.a[r].j2<4?N<7?8:11:N<7?7:10):e.a[x].Hc)):e.a[x].Hc,x==r-1?N=e.a[r].j?J(N):N<7?9:11:(N=e.a[r].t&&e.a[r].Ac?(x=e.a[r].r2,E=e.a[r].j2,N<7?8:11):(E=e.a[r].j)<4?N<7?8:11:N<7?7:10,x=e.a[x],E<4?E?1==E?(e.x[0]=x.ac,e.x[1]=x.bc,e.x[2]=x.dc,e.x[3]=x.lc):2==E?(e.x[0]=x.dc,e.x[1]=x.bc,e.x[2]=x.ac,e.x[3]=x.lc):(e.x[0]=x.lc,e.x[1]=x.bc,e.x[2]=x.ac,e.x[3]=x.dc):(e.x[0]=x.bc,e.x[1]=x.ac,e.x[2]=x.dc,e.x[3]=x.lc):(e.x[0]=E-4,e.x[1]=x.bc,e.x[2]=x.ac,e.x[3]=x.dc)),e.a[r].Hc=N,e.a[r].bc=e.x[0],e.a[r].ac=e.x[1],e.a[r].dc=e.x[2],e.a[r].lc=e.x[3],x=e.a[r].z,s=z(e.b,-1),h=z(e.b,-e.x[0]-1-1),M=x+Z[e.C[(N<<4)+(T=t&e.y)]>>>2]+Q(X(e.A,t,z(e.b,-2)),7<=N,h,s),m=e.a[r+1],j=0,m.z>M&&(m.z=M,m.r=r,m.j=-1,m.t=0,j=1),p=x+Z[2048-e.C[(N<<4)+T]>>>2],I=p+Z[2048-e.bb[N]>>>2],h!=s||r>m.r&&!m.j||(U=I+(Z[e.hb[N]>>>2]+Z[e._[(N<<4)+T]>>>2]),m.z>=U&&(m.z=U,m.r=r,m.j=0,m.t=0,j=1)),v=W(e.b)+1,!((b=v=4095-r<v?4095-r:v)<2)){if(b>e.n&&(b=e.n),!j&&h!=s&&(R=Math.min(v-1,e.n),2<=(d=G(e.b,0,e.x[0],R)))){for(O=J(N),S=t+1&e.y,g=M+Z[2048-e.C[(O<<4)+S]>>>2]+Z[2048-e.bb[O]>>>2],A=r+1+d;l<A;)e.a[++l].z=268435455;i=g+(K(e.i,d-2,S)+Y(e,0,O,S)),(k=e.a[A]).z>i&&(k.z=i,k.r=r+1,k.j=0,k.t=1,k.Ac=0)}for(P=2,C=0;C<4;++C)if(!((u=G(e.b,-1,e.x[C],b))<2)){B=u;do{for(;l<r+u;)e.a[++l].z=268435455}while(i=I+(K(e.i,u-2,T)+Y(e,C,N,T)),(k=e.a[r+u]).z>i&&(k.z=i,k.r=r,k.j=C,k.t=0),2<=--u);if(u=B,C||(P=u+1),u<v&&(R=Math.min(v-1-u,e.n),2<=(d=G(e.b,u,e.x[C],R)))){for(O=N<7?8:11,S=t+u&e.y,D=I+(K(e.i,u-2,T)+Y(e,C,N,T))+Z[e.C[(O<<4)+S]>>>2]+Q(X(e.A,t+u,z(e.b,u-1-1)),1,z(e.b,u-1-(e.x[C]+1)),z(e.b,u-1)),O=J(O),$=D+Z[2048-e.C[(O<<4)+(S=t+u+1&e.y)]>>>2],g=$+Z[2048-e.bb[O]>>>2],A=u+1+d;l<r+A;)e.a[++l].z=268435455;i=g+(K(e.i,d-2,S)+Y(e,0,O,S)),(k=e.a[r+A]).z>i&&(k.z=i,k.r=r+u+1,k.j=0,k.t=1,k.Ac=1,k.r2=r,k.j2=C)}}if(b<f){for(f=b,y=0;f>e.m[y];y+=2);e.m[y]=f,y+=2}if(P<=f){for(V=p+Z[e.bb[N]>>>2];l<r+f;)e.a[++l].z=268435455;for(w=0;P>e.m[w];)w+=2;for(u=P;;++u)if(n=e.m[w+1],i=V+pe(e,n,u,T),(k=e.a[r+u]).z>i&&(k.z=i,k.r=r,k.j=n+4,k.t=0),u==e.m[w]){if(u<v&&(R=Math.min(v-1-u,e.n),2<=(d=G(e.b,u,n,R)))){for(O=N<7?7:10,S=t+u&e.y,D=i+Z[e.C[(O<<4)+S]>>>2]+Q(X(e.A,t+u,z(e.b,u-1-1)),1,z(e.b,u-(n+1)-1),z(e.b,u-1)),O=J(O),$=D+Z[2048-e.C[(O<<4)+(S=t+u+1&e.y)]>>>2],g=$+Z[2048-e.bb[O]>>>2],A=u+1+d;l<r+A;)e.a[++l].z=268435455;i=g+(K(e.i,d-2,S)+Y(e,0,O,S)),(k=e.a[r+A]).z>i&&(k.z=i,k.r=r+u+1,k.j=0,k.t=1,k.Ac=1,k.r2=r,k.j2=n+4)}if((w+=2)==y)break}}}}})(e,w(e.g)),d=e.mb,p=w(e.g)&e.y,o=(e.l<<4)+p,1==c&&-1==d)T(e.d,e.C,o,0),s=z(e.b,-e.s),m=X(e.A,w(e.g),e.J),e.l<7?Ee(m,e.d,s):(u=z(e.b,-e.v[0]-1-e.s),((e,t,r,i)=>{var n,s,a,o,l=1,c=1;for(s=7;0<=s;--s)n=i>>s&1,o=c,l&&(o+=1+(a=r>>s&1)<<8,l=a==n),T(t,e.tb,o,n),c=c<<1|n})(m,e.d,u,s)),e.J=s,e.l=J(e.l);else{if(T(e.d,e.C,o,1),d<4){if(T(e.d,e.bb,e.l,1),d?(T(e.d,e.hb,e.l,1),1==d?T(e.d,e.Ub,e.l,0):(T(e.d,e.Ub,e.l,1),T(e.d,e.vc,e.l,d-2))):(T(e.d,e.hb,e.l,0),T(e.d,e._,o,1==c?0:1)),1==c?e.l=e.l<7?9:11:(we(e.i,e.d,c-2,p),e.l=e.l<7?8:11),a=e.v[d],0!=d){for(l=d;1<=l;--l)e.v[l]=e.v[l-1];e.v[0]=a}}else{for(T(e.d,e.bb,e.l,0),e.l=e.l<7?7:10,we(e.$,e.d,c-2,p),m=be(d-=4),u=A(c),E(e.K[u],e.d,m),4<=m&&(h=d-(n=(2|1&m)<<(o=(m>>1)-1)),m<14?((e,t,r,i,n)=>{var s,a,o=1;for(a=0;a<i;++a)T(r,e,t+o,s=1&n),o=o<<1|s,n>>=1})(e.Sb,n-m-1,e.d,o,h):(Se(e.d,h>>4,o-4),Te(e.S,e.d,15&h),++e.Qb)),a=d,l=3;1<=l;--l)e.v[l]=e.v[l-1];e.v[0]=a,++e.Mb}e.J=z(e.b,c-1-e.s)}if(e.s-=c,e.g=b(e.g,y(c)),!e.s){if(128<=e.Mb&&de(e),16<=e.Qb&&ue(e),t[0]=e.g,r[0]=(e=>b(b(y(e.Jb),e.mc),[4,0]))(e.d),!W(e.b))return he(e,w(e.g));if(0<=v(L(e.g,f),[4096,0]))return e.pc=0,i[0]=0}}else he(e,w(e.g))}})(r.cb,r.cb.Xb,r.cb.uc,r.cb.Kc),r.Pb=r.cb.Xb[0];if(r.cb.Kc[0]){{var t=r.cb;ge(t),t.d.Ab=null}r.zc=0}}else{t=e;r=(e=>{var t;if(t=w(e.g)&e.Dc,l(e.e,e.Gb,(e.U<<4)+t)){if(l(e.e,e.Zb,e.U))i=0,l(e.e,e.Cb,e.U)?(l(e.e,e.Db,e.U)?(l(e.e,e.Eb,e.U)?(r=e.Qc,e.Qc=e.Ic):r=e.Ic,e.Ic=e.Jc):r=e.Jc,e.Jc=e.ib,e.ib=r):l(e.e,e.pb,(e.U<<4)+t)||(e.U=e.U<7?9:11,i=1),i||(i=ae(e.sb,e.e,t)+2,e.U=e.U<7?8:11);else if(e.Qc=e.Ic,e.Ic=e.Jc,e.Jc=e.ib,i=2+ae(e.Rb,e.e,t),e.U=e.U<7?7:10,4<=(r=s(e.kb[A(i)],e.e))){if(t=(r>>1)-1,e.ib=(2|1&r)<<t,r<14)e.ib+=((e,t,r,i)=>{var n,s,a=1,o=0;for(s=0;s<i;++s)n=l(r,e,t+a),a=(a<<1)+n,o|=n<<s;return o})(e.kc,e.ib-r-1,e.e,t);else if(e.ib+=((e,t)=>{var r,i,n=0;for(r=t;0!=r;--r)e.E>>>=1,e.Bb-=e.E&(i=e.Bb-e.E>>>31)-1,n=n<<1|1-i,-16777216&e.E||(e.Bb=e.Bb<<8|c(e.Ab),e.E<<=8);return n})(e.e,t-4)<<4,e.ib+=((e,t)=>{var r,i,n=1,s=0;for(i=0;e.F>i;++i)r=l(t,e.G,n),n=(n<<1)+r,s|=r<<i;return s})(e.Fb,e.e),e.ib<0)return-1==e.ib?1:-1}else e.ib=r;if(0<=v(y(e.ib),e.g)||e.ib>=e.nb)return-1;((e,t,r)=>{var i=e.o-t-1;for(i<0&&(i+=e.M);0!=r;--r)i>=e.M&&(i=0),e.Lb[e.o++]=e.Lb[i++],e.M<=e.o&&n(e)})(e.B,e.ib,i),e.g=b(e.g,y(i)),e.jc=ie(e.B,0)}else{t=((e,t,r)=>e.V[((t&e.qc)<<e.u)+((255&r)>>>8-e.u)])(e.gb,w(e.g),e.jc),e.jc=e.U<7?((e,t)=>{for(var r=1;(r=r<<1|l(t,e.Ib,r))<256;);return r<<24>>24})(t,e.e):((e,t,r)=>{var i,n,s=1;do{if(n=r>>7&1,r<<=1,i=l(t,e.Ib,(1+n<<8)+s),s=s<<1|i,n!=i){for(;s<256;)s=s<<1|l(t,e.Ib,s);break}}while(s<256);return s<<24>>24})(t,e.e,ie(e.B,e.ib));{var r=e.B;var i=e.jc;r.Lb[r.o++]=i,r.M<=r.o&&n(r)}e.U=J(e.U),e.g=b(e.g,Ne)}return 0})(t.Z);if(-1==r)throw Error("corrupted input");t.Pb=I,t.Pc=t.Z.g,(r||0<=v(t.Z.Nc,_)&&0<=v(t.Z.g,t.Z.Nc))&&(n(t.Z.B),ne(t.Z.B),t.Z.e.Ab=null,t.zc=0)}return e.zc}throw Error("bad state");var r}function se(e,t){for(;t>e.O;++e.O)e.ec[e.O]=h({},3),e.hc[e.O]=h({},3)}function ae(e,t,r){return l(t,e.wc,0)?8+(l(t,e.wc,1)?8+s(e.tc,t):s(e.hc[r],t)):s(e.ec[r],t)}function oe(e){return e.wc=m(2),e.ec=m(16),e.hc=m(16),e.tc=h({},8),e.O=0,e}function le(e){x(e.wc);for(var t=0;e.O>t;++t)x(e.ec[t].G),x(e.hc[t].G);x(e.tc.G)}function ce(e,t){var r,i,n,s;for(e.jb=t,n=e.a[t].r,i=e.a[t].j;e.a[t].t&&(xe(e.a[n]),e.a[n].r=n-1,e.a[t].Ac)&&(e.a[n-1].t=0,e.a[n-1].r=e.a[t].r2,e.a[n-1].j=e.a[t].j2),s=n,r=i,i=e.a[s].j,n=e.a[s].r,e.a[s].j=r,e.a[s].r=t,0<(t=s););return e.mb=e.a[0].j,e.q=e.a[0].r}function ue(e){for(var t=0;t<16;++t)e.nc[t]=((e,t)=>{var r,i,n=1,s=0;for(i=e.F;0!=i;--i)r=1&t,t>>>=1,s+=f(e.G[n],r),n=n<<1|r;return s})(e.S,t);e.Qb=0}function de(e){for(var t,r,i,n,s,a,o,l=4;l<128;++l)s=be(l),e.yc[l]=((e,t,r,i)=>{var n,s,a=1,o=0;for(s=r;0!=s;--s)n=1&i,i>>>=1,o+=Z[(2047&(e[t+a]-n^-n))>>>2],a=a<<1|n;return o})(e.Sb,(t=(2|1&s)<<(i=(s>>1)-1))-s-1,i,l-t);for(n=0;n<4;++n){for(r=e.K[n],a=n<<6,s=0;e.$b>s;++s)e.P[a+s]=p(r,s);for(s=14;e.$b>s;++s)e.P[a+s]+=(s>>1)-1-4<<6;for(o=128*n,l=0;l<4;++l)e.lb[o+l]=e.P[a+l];for(;l<128;++l)e.lb[o+l]=e.P[a+be(l)]+e.yc[l]}e.Mb=0}function he(e,t){var r;ge(e),r=t&(t=e).y,t.Gc&&(T(t.d,t.C,(t.l<<4)+r,1),T(t.d,t.bb,t.l,0),t.l=t.l<7?7:10,we(t.$,t.d,0,r),r=A(2),E(t.K[r],t.d,63),Se(t.d,67108863,26),Te(t.S,t.d,15));for(var i=0;i<5;++i)Ce(e.d)}function pe(e,t,r,i){var n=A(r);return(t<128?e.lb[128*n+t]:e.P[(n<<6)+((n=t)<131072?o[n>>6]+12:n<134217728?o[n>>16]+32:o[n>>26]+52)]+e.nc[15&t])+K(e.$,r-2,i)}function Y(e,t,r,i){var n;return t?(n=Z[2048-e.hb[r]>>>2],1==t?n+=Z[e.Ub[r]>>>2]:n=(n+=Z[2048-e.Ub[r]>>>2])+f(e.vc[r],t-2)):(n=Z[e.hb[r]>>>2],n+=Z[2048-e._[(r<<4)+i]>>>2]),n}function fe(e,t){if(0<t){var r,i,n,s,a,o,l,c,u,d,h,p,f,m=e.b,g=t;do{if(m.h>=m.o+m.ob)c=m.ob;else if((c=m.h-m.o)<m.xb){k(m);continue}for(u=m.p<m.o?m.o-m.p:0,i=m.f+m.o,f=m.qb?(f=Oe[255&m.c[i]]^255&m.c[i+1],m.ub[1023&f]=m.o,f^=(255&m.c[i+2])<<8,m.ub[1024+(65535&f)]=m.o,(f^Oe[255&m.c[i+3]]<<5)&m.Ec):255&m.c[i]^(255&m.c[i+1])<<8,n=m.ub[m.R+f],m.ub[m.R+f]=m.o,h=1+(m.k<<1),p=m.k<<1,o=l=m.w,r=m.Fc;;){if(n<=u||0==r--){m.L[h]=m.L[p]=0;break}if(s=((s=m.o-n)<=m.k?m.k-s:m.k-s+m.p)<<1,m.c[(d=m.f+n)+(a=o<l?o:l)]==m.c[i+a]){for(;++a!=c&&m.c[d+a]==m.c[i+a];);if(a==c){m.L[p]=m.L[s],m.L[h]=m.L[1+s];break}}(255&m.c[i+a])>(255&m.c[d+a])?(m.L[p]=n,n=m.L[p=1+s],l=a):(m.L[h]=n,n=m.L[h=s],o=a)}k(m)}while(0!=--g);e.s+=t}}function me(e){var t=0;return e.D=((e,t)=>{var r,i,n,s,a,o,l,c,u,d,h,p,f,m,g,b,v,y,w,A;if(e.h>=e.o+e.ob)f=e.ob;else if((f=e.h-e.o)<e.xb)return k(e),0;for(m=e.p<e.o?e.o-e.p:0,i=e.f+e.o,g=1,u=c=b=0,A=e.qb?(c=1023&(A=Oe[255&e.c[i]]^255&e.c[i+1]),u=65535&(A^=(255&e.c[i+2])<<8),(A^Oe[255&e.c[i+3]]<<5)&e.Ec):255&e.c[i]^(255&e.c[i+1])<<8,n=e.ub[e.R+A]||0,e.qb&&(s=e.ub[c]||0,a=e.ub[1024+u]||0,e.ub[c]=e.o,e.ub[1024+u]=e.o,m<s&&e.c[e.f+s]==e.c[i]&&(t[b++]=g=2,t[b++]=e.o-s-1),m<a&&e.c[e.f+a]==e.c[i]&&(a==s&&(b-=2),t[b++]=g=3,t[b++]=e.o-a-1,s=a),0!=b)&&s==n&&(b-=2,g=1),e.ub[e.R+A]=e.o,y=1+(e.k<<1),w=e.k<<1,0!=(h=p=e.w)&&m<n&&e.c[e.f+n+e.w]!=e.c[i+e.w]&&(t[b++]=g=e.w,t[b++]=e.o-n-1),r=e.Fc;;){if(n<=m||0==r--){e.L[y]=e.L[w]=0;break}if(o=((l=e.o-n)<=e.k?e.k-l:e.k-l+e.p)<<1,e.c[(v=e.f+n)+(d=h<p?h:p)]==e.c[i+d]){for(;++d!=f&&e.c[v+d]==e.c[i+d];);if(g<d&&(t[b++]=g=d,t[b++]=l-1,d==f)){e.L[w]=e.L[o],e.L[y]=e.L[1+o];break}}(255&e.c[i+d])>(255&e.c[v+d])?(e.L[w]=n,n=e.L[w=1+o],p=d):(e.L[y]=n,n=e.L[y=o],h=d)}return k(e),b})(e.b,e.m),0<e.D&&(t=e.m[e.D-2])==e.n&&(t+=G(e.b,t-1,e.m[e.D-1],273-t)),++e.s,t}function ge(e){e.b&&e.W&&(e.b.cc=null,e.W=0)}function be(e){return e<2048?o[e]:e<2097152?o[e>>10]+20:o[e>>20]+40}function ve(e,t){x(e.db);for(var r=0;r<t;++r)x(e.Vb[r].G),x(e.Wb[r].G);x(e.ic.G)}function ye(e,t,r,i,n){var s=Z[e.db[0]>>>2],a=Z[2048-e.db[0]>>>2],o=a+Z[e.db[1]>>>2],l=a+Z[2048-e.db[1]>>>2],c=0;for(c=0;c<8;++c){if(r<=c)return;i[n+c]=s+p(e.Vb[t],c)}for(;c<16;++c){if(r<=c)return;i[n+c]=o+p(e.Wb[t],c-8)}for(;c<r;++c)i[n+c]=l+p(e.ic,c-8-8)}function we(e,t,r,i){var n,s;n=e,t=t,s=i,(r=r)<8?(T(t,n.db,0,0),E(n.Vb[s],t,r)):(r-=8,T(t,n.db,0,1),r<8?(T(t,n.db,1,0),E(n.Wb[s],t,r)):(T(t,n.db,1,1),E(n.ic,t,r-8))),0==--e.sc[i]&&(ye(e,i,e.rb,e.Cc,272*i),e.sc[i]=e.rb)}function Ae(e){var t=e;t.db=m(2),t.Vb=m(16),t.Wb=m(16),t.ic=g({},8);for(var r=0;r<16;++r)t.Vb[r]=g({},3),t.Wb[r]=g({},3);return e.Cc=[],e.sc=[],e}function K(e,t,r){return e.Cc[272*r+t]}function ke(e,t){for(var r=0;r<t;++r)ye(e,r,e.rb,e.Cc,272*r),e.sc[r]=e.rb}function X(e,t,r){return e.V[((t&e.qc)<<e.u)+((255&r)>>>8-e.u)]}function Ee(e,t,r){for(var i,n=1,s=7;0<=s;--s)T(t,e.tb,n,i=r>>s&1),n=n<<1|i}function Q(e,t,r,i){var n,s,a=1,o=7,l=0;if(t)for(;0<=o;--o)if(l+=f(e.tb[(1+(s=r>>o&1)<<8)+a],n=i>>o&1),a=a<<1|n,s!=n){--o;break}for(;0<=o;--o)l+=f(e.tb[a],n=i>>o&1),a=a<<1|n;return l}function xe(e){e.j=-1,e.t=0}function h(e,t){return e.F=t,e.G=m(1<<t),e}function s(e,t){for(var r=1,i=e.F;0!=i;--i)r=(r<<1)+l(t,e.G,r);return r-(1<<e.F)}function g(e,t){return e.F=t,e.G=m(1<<t),e}function E(e,t,r){for(var i,n=1,s=e.F;0!=s;)T(t,e.G,n,i=r>>>--s&1),n=n<<1|i}function p(e,t){for(var r,i=1,n=0,s=e.F;0!=s;)n+=f(e.G[i],r=t>>>--s&1),i=(i<<1)+r;return n}function Te(e,t,r){for(var i,n=1,s=0;e.F>s;++s)T(t,e.G,n,i=1&r),n=n<<1|i,r>>=1}function l(e,t,r){var i=t[r],n=(e.E>>>11)*i;return(-2147483648^e.Bb)<(-2147483648^n)?(e.E=n,t[r]=i+(2048-i>>>5)<<16>>16,-16777216&e.E||(e.Bb=e.Bb<<8|c(e.Ab),e.E<<=8),0):(e.E-=n,e.Bb-=n,t[r]=i-(i>>>5)<<16>>16,-16777216&e.E||(e.Bb=e.Bb<<8|c(e.Ab),e.E<<=8),1)}function x(e){for(var t=e.length-1;0<=t;--t)e[t]=1024}function T(e,t,r,i){var n=t[r],s=(e.E>>>11)*n;i?(e.xc=b(e.xc,P(y(s),[4294967295,0])),e.E-=s,t[r]=n-(n>>>5)<<16>>16):(e.E=s,t[r]=n+(2048-n>>>5)<<16>>16),-16777216&e.E||(e.E<<=8,Ce(e))}function Se(e,t,r){for(var i=r-1;0<=i;--i)e.E>>>=1,1==(t>>>i&1)&&(e.xc=b(e.xc,y(e.E))),-16777216&e.E||(e.E<<=8,Ce(e))}function Ce(e){var t,r,i,n,s=w((r=e.xc,i=32,n=R(r,i&=63),n=r[1]<0?b(n,O([2,0],63-i)):n));if(0!=s||v(e.xc,[4278190080,0])<0){for(e.mc=b(e.mc,y(e.Jb)),t=e.Oc;F(e.Ab,t+s),t=255,0!=--e.Jb;);e.Oc=w(e.xc)>>>24}++e.Jb,e.xc=O(P(e.xc,[16777215,0]),8)}function f(e,t){return Z[(2047&(e-t^-t))>>>2]}function Ie(e){for(var t,r,i,n=0,s=0,a=e.length,o=[],l=[];n<a;++n,++s){if(128&(t=255&e[n]))if(192==(224&t)){if(a<=n+1)return e;if(128!=(192&(r=255&e[++n])))return e;l[s]=(31&t)<<6|63&r}else{if(224!=(240&t))return e;if(a<=n+2)return e;if(128!=(192&(r=255&e[++n])))return e;if(128!=(192&(i=255&e[++n])))return e;l[s]=(15&t)<<12|(63&r)<<6|63&i}else{if(!t)return e;l[s]=t}16383==s&&(o.push(String.fromCharCode.apply(String,l)),s=-1)}return 0<s&&(l.length=s,o.push(String.fromCharCode.apply(String,l))),o.join("")}function _e(e){var t,r,i,n=[],s=0,a=e.length;if("object"==typeof e)return e;for(var o=e,l=a,c=n,u=0,d=0;d<l;++d)c[u++]=o.charCodeAt(d);for(i=0;i<a;++i)1<=(t=n[i])&&t<=127?++s:s+=!t||128<=t&&t<=2047?2:3;for(r=[],i=s=0;i<a;++i)1<=(t=n[i])&&t<=127?r[s++]=t<<24>>24:(!t||128<=t&&t<=2047?r[s++]=(192|t>>6&31)<<24>>24:(r[s++]=(224|t>>12&15)<<24>>24,r[s++]=(128|t>>6&63)<<24>>24),r[s++]=(128|63&t)<<24>>24);return r}function S(e){return e[1]+e[0]}var t,Ue=3,C="function"==typeof setImmediate?setImmediate:setTimeout,a=4294967296,I=[4294967295,-a],Pe=[0,-0x8000000000000000],_=[0,0],Ne=[1,0],Oe=(()=>{for(var e,t,r=[],i=0;i<256;++i){for(t=i,e=0;e<8;++e)0!=(1&t)?t=t>>>1^-306674912:t>>>=1;r[i]=t}return r})(),o=(()=>{for(var e,t,r=2,i=[0,1],n=2;n<22;++n)for(t=1<<(n>>1)-1,e=0;e<t;++e,++r)i[r]=n<<24>>24;return i})(),Z=(()=>{for(var e,t,r=[],i=8;0<=i;--i)for(e=1<<9-i,t=1<<9-i-1;t<e;++t)r[t]=(i<<6)+(e-t<<6>>>9-i-1);return r})(),Re=(t=[{s:16,f:64,m:0},{s:20,f:64,m:0},{s:19,f:64,m:1},{s:20,f:64,m:1},{s:21,f:128,m:1},{s:22,f:128,m:1},{s:23,f:128,m:1},{s:24,f:255,m:1},{s:25,f:255,m:1}],function(e){return t[e-1]||t[6]});return"undefined"==typeof onmessage||"undefined"!=typeof window&&void 0!==window.document||(onmessage=function(t){t&&t.gc&&(2==t.gc.action?e.decompress(t.gc.gc,t.gc.cbn):1==t.gc.action&&e.compress(t.gc.gc,t.gc.Rc,t.gc.cbn))}),{compress:function(e,t,i,n){var s,r,a={},o=void 0===i&&void 0===n;if("function"!=typeof i&&(r=i,i=n=0),n=n||function(e){return void 0!==r?U(e,r):void 0},i=i||function(e,t){return void 0!==r?postMessage({action:1,cbn:r,result:e,error:t}):void 0},o){for(a.c=V({},_e(e),Re(t));d(a.c.yb););return u(a.c.Nb)}try{a.c=V({},_e(e),Re(t)),n(0)}catch(e){return i(null,e)}C(function e(){try{for(var t,r=(new Date).getTime();d(a.c.yb);)if(s=S(a.c.yb.Pb)/S(a.c.Tb),200<(new Date).getTime()-r)return n(s),C(e,0),0;n(1),t=u(a.c.Nb),C(i.bind(null,t),0)}catch(e){i(null,e)}},0)},decompress:function(e,n,s){var a,r,o,l,c={},t=void 0===n&&void 0===s;if("function"!=typeof n&&(r=n,n=s=0),s=s||function(e){return void 0!==r?U(o?e:-1,r):void 0},n=n||function(e,t){return void 0!==r?postMessage({action:2,cbn:r,result:e,error:t}):void 0},t){for(c.d=H({},e);d(c.d.yb););return Ie(u(c.d.Nb))}try{c.d=H({},e),l=S(c.d.Tb),o=-1<l,s(0)}catch(e){return n(null,e)}C(function e(){try{for(var t,r=0,i=(new Date).getTime();d(c.d.yb);)if(++r%1e3==0&&200<(new Date).getTime()-i)return o&&(a=S(c.d.yb.Z.g)/l,s(a)),C(e,0),0;s(1),t=Ie(u(c.d.Nb)),C(n.bind(null,t),0)}catch(e){n(null,e)}},0)}}})(),pxt,pxt,pxt,pxt,pxt,pxt,ts,pxtc=(this.LZMA=this.LZMA_WORKER=e,((e,t)=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).DOMPurify=t()})(this,function(){var i=Object.hasOwnProperty,s=Object.setPrototypeOf,a=Object.isFrozen,be=Object.keys,ve=Object.freeze,e=Object.seal,n=Object.create,t="undefined"!=typeof Reflect&&Reflect,o=(o=t.apply)||function(e,t,r){return e.apply(t,r)},ve=ve||function(e){return e},e=e||function(e){return e},l=(l=t.construct)||function(e,t){return new(Function.prototype.bind.apply(e,[null].concat((e=>{if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)})(t))))},ye=r(Array.prototype.forEach),we=r(Array.prototype.indexOf),Ae=r(Array.prototype.join),ke=r(Array.prototype.pop),Ee=r(Array.prototype.push),xe=r(Array.prototype.slice),Te=r(String.prototype.toLowerCase),Se=r(String.prototype.match),Ce=r(String.prototype.replace),qe=r(String.prototype.indexOf),He=r(String.prototype.trim),Ie=r(RegExp.prototype.test),ze=c(RegExp),_e=c(TypeError);function r(n){return function(e){for(var t=arguments.length,r=Array(1<t?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];return o(n,e,r)}}function c(i){return function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return l(i,t)}}function Ue(e,t){s&&s(e,null);for(var r=t.length;r--;){var i,n=t[r];"string"==typeof n&&(i=Te(n))!==n&&(a(t)||(t[r]=i),n=i),e[n]=!0}return e}function Pe(e){var t=n(null),r=void 0;for(r in e)o(i,e,[r])&&(t[r]=e[r]);return t}var Ne=ve(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Oe=ve(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","audio","canvas","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","video","view","vkern"]),Re=ve(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Le=ve(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover"]),Me=ve(["#text"]),De=ve(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","face","for","headers","height","hidden","high","href","hreflang","id","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","playsinline","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","xmlns"]),Fe=ve(["accent-height","accumulate","additive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","targetx","targety","transform","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Be=ve(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),je=ve(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Ge=e(/\{\{[\s\S]*|[\s\S]*\}\}/gm),We=e(/<%[\s\S]*|[\s\S]*%>/gm),Je=e(/^data-[\-\w.\u00B7-\uFFFF]/),Ye=e(/^aria-[\-\w]+$/),Ke=e(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Xe=e(/^(?:\w+script|data):/i),Qe=e(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),$e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function Ve(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}return function L(){var o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"undefined"==typeof window?null:window,c=function(e){return L(e)};if(c.version="2.0.17",c.removed=[],o&&o.document&&9===o.document.nodeType){var l=o.document,M=!1,s=o.document,D=o.DocumentFragment,e=o.HTMLTemplateElement,u=o.Node,t=o.NodeFilter,r=o.NamedNodeMap,F=void 0===r?o.NamedNodeMap||o.MozNamedAttrMap:r,B=o.Text,j=o.Comment,$=o.DOMParser,r=o.trustedTypes,d=("function"==typeof e&&(e=s.createElement("template")).content&&e.content.ownerDocument&&(s=e.content.ownerDocument),((e,t)=>{if("object"!==(void 0===e?"undefined":$e(e))||"function"!=typeof e.createPolicy)return null;var r=null,t="dompurify"+((r=t.currentScript&&t.currentScript.hasAttribute("data-tt-policy-suffix")?t.currentScript.getAttribute("data-tt-policy-suffix"):r)?"#"+r:"");try{return e.createPolicy(t,{createHTML:function(e){return e}})}catch(e){return console.warn("TrustedTypes policy "+t+" could not be created."),null}})(r,l)),V=d&&S?d.createHTML(""):"",e=s,a=e.implementation,q=e.createNodeIterator,H=e.getElementsByTagName,z=e.createDocumentFragment,G=l.importNode,r={};try{r=Pe(s).documentMode?s.documentMode:{}}catch(L){}var i={},h=(c.isSupported=a&&void 0!==a.createHTMLDocument&&9!==r,Ge),p=We,W=Je,J=Ye,Y=Xe,K=Qe,n=Ke,f=null,X=Ue({},[].concat(Ve(Ne),Ve(Oe),Ve(Re),Ve(Le),Ve(Me))),m=null,Q=Ue({},[].concat(Ve(De),Ve(Fe),Ve(Be),Ve(je))),g=null,b=null,Z=!0,v=!0,ee=!1,y=!1,w=!1,A=!1,k=!1,E=!1,x=!1,T=!1,te=!1,S=!1,re=!0,C=!0,I=!1,_={},ie=Ue({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","plaintext","script","style","svg","template","thead","title","video","xmp"]),ne=null,se=Ue({},["audio","video","img","source","image","track"]),U=null,ae=Ue({},["alt","class","for","id","label","name","pattern","placeholder","summary","title","value","style","xmlns"]),P=null,oe=s.createElement("form"),le=function(e){P&&P===e||(e=Pe(e=e&&"object"===(void 0===e?"undefined":$e(e))?e:{}),f="ALLOWED_TAGS"in e?Ue({},e.ALLOWED_TAGS):X,m="ALLOWED_ATTR"in e?Ue({},e.ALLOWED_ATTR):Q,U="ADD_URI_SAFE_ATTR"in e?Ue(Pe(ae),e.ADD_URI_SAFE_ATTR):ae,ne="ADD_DATA_URI_TAGS"in e?Ue(Pe(se),e.ADD_DATA_URI_TAGS):se,g="FORBID_TAGS"in e?Ue({},e.FORBID_TAGS):{},b="FORBID_ATTR"in e?Ue({},e.FORBID_ATTR):{},_="USE_PROFILES"in e&&e.USE_PROFILES,Z=!1!==e.ALLOW_ARIA_ATTR,v=!1!==e.ALLOW_DATA_ATTR,ee=e.ALLOW_UNKNOWN_PROTOCOLS||!1,y=e.SAFE_FOR_JQUERY||!1,w=e.SAFE_FOR_TEMPLATES||!1,A=e.WHOLE_DOCUMENT||!1,x=e.RETURN_DOM||!1,T=e.RETURN_DOM_FRAGMENT||!1,te=e.RETURN_DOM_IMPORT||!1,S=e.RETURN_TRUSTED_TYPE||!1,E=e.FORCE_BODY||!1,re=!1!==e.SANITIZE_DOM,C=!1!==e.KEEP_CONTENT,I=e.IN_PLACE||!1,n=e.ALLOWED_URI_REGEXP||n,w&&(v=!1),T&&(x=!0),_&&(f=Ue({},[].concat(Ve(Me))),m=[],!0===_.html&&(Ue(f,Ne),Ue(m,De)),!0===_.svg&&(Ue(f,Oe),Ue(m,Fe),Ue(m,je)),!0===_.svgFilters&&(Ue(f,Re),Ue(m,Fe),Ue(m,je)),!0===_.mathMl)&&(Ue(f,Le),Ue(m,Be),Ue(m,je)),e.ADD_TAGS&&Ue(f=f===X?Pe(f):f,e.ADD_TAGS),e.ADD_ATTR&&Ue(m=m===Q?Pe(m):m,e.ADD_ATTR),e.ADD_URI_SAFE_ATTR&&Ue(U,e.ADD_URI_SAFE_ATTR),C&&(f["#text"]=!0),A&&Ue(f,["html","head","body"]),f.table&&(Ue(f,["tbody"]),delete g.tbody),ve&&ve(e),P=e)},ce=function(t){Ee(c.removed,{element:t});try{t.parentNode.removeChild(t)}catch(e){t.outerHTML=V}},N=function(e,t){try{Ee(c.removed,{attribute:t.getAttributeNode(e),from:t})}catch(e){Ee(c.removed,{attribute:null,from:t})}t.removeAttribute(e)},ue=function(e){var t,r=void 0,i=void 0,n=(E?e="<remove></remove>"+e:i=(n=Se(e,/^[\r\n\t ]+/))&&n[0],d?d.createHTML(e):e);try{r=(new $).parseFromString(n,"text/html")}catch(e){}return M&&Ue(g,["title"]),r&&r.documentElement||((t=(r=a.createHTMLDocument("")).body).parentNode.removeChild(t.parentNode.firstElementChild),t.outerHTML=n),e&&i&&r.body.insertBefore(s.createTextNode(i),r.body.childNodes[0]||null),H.call(r,A?"html":"body")[0]};if(c.isSupported)try{var de=ue("<x/><title>&lt;/title&gt;&lt;img&gt;");Ie(/<\/title/,de.querySelector("title").innerHTML)&&(M=!0)}catch(de){}var he=function(e){return q.call(e.ownerDocument||e,e,t.SHOW_ELEMENT|t.SHOW_COMMENT|t.SHOW_TEXT,function(){return t.FILTER_ACCEPT},!1)},O=function(e){return"object"===(void 0===u?"undefined":$e(u))?e instanceof u:e&&"object"===(void 0===e?"undefined":$e(e))&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName},R=function(e,t,r){i[e]&&ye(i[e],function(e){e.call(c,t,r,P)})},pe=function(e){var t;if(R("beforeSanitizeElements",e,null),((r=e)instanceof B||r instanceof j||"string"==typeof r.nodeName&&"string"==typeof r.textContent&&"function"==typeof r.removeChild&&r.attributes instanceof F&&"function"==typeof r.removeAttribute&&"function"==typeof r.setAttribute&&"string"==typeof r.namespaceURI)&&!Se(e.nodeName,/[\u0080-\uFFFF]/)){var r=Te(e.nodeName);if(R("uponSanitizeElement",e,{tagName:r,allowedTags:f}),"svg"!==r&&"math"!==r||0===e.querySelectorAll("p, br, form, table").length){if(f[r]&&!g[r])return"noscript"===r&&Ie(/<\/noscript/i,e.innerHTML)||"noembed"===r&&Ie(/<\/noembed/i,e.innerHTML)?(ce(e),!0):(!y||O(e.firstElementChild)||O(e.content)&&O(e.content.firstElementChild)||!Ie(/</g,e.textContent)||(Ee(c.removed,{element:e.cloneNode()}),e.innerHTML?e.innerHTML=Ce(e.innerHTML,/</g,"&lt;"):e.innerHTML=Ce(e.textContent,/</g,"&lt;")),w&&3===e.nodeType&&(t=e.textContent,t=Ce(t,h," "),t=Ce(t,p," "),e.textContent!==t)&&(Ee(c.removed,{element:e.cloneNode()}),e.textContent=t),R("afterSanitizeElements",e,null),!1);if(C&&!ie[r]&&"function"==typeof e.insertAdjacentHTML)try{var i=e.innerHTML;e.insertAdjacentHTML("AfterEnd",d?d.createHTML(i):i)}catch(e){}}}return ce(e),!0},fe=function(e,t,r){if(re&&("id"===t||"name"===t)&&(r in s||r in oe))return!1;if(!(v&&Ie(W,t)||Z&&Ie(J,t))){if(!m[t]||b[t])return!1;if(!U[t]&&!Ie(n,Ce(r,K,""))&&("src"!==t&&"xlink:href"!==t&&"href"!==t||"script"===e||0!==qe(r,"data:")||!ne[e])&&(!ee||Ie(Y,Ce(r,K,"")))&&r)return!1}return!0},me=function(e){var t=void 0,r=void 0,i=(R("beforeSanitizeAttributes",e,null),e.attributes);if(i){for(var n={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:m},r=i.length;r--;){o=i[r];var s=o.name,a=o.namespaceURI,t=He(o.value),o=Te(s);if(n.attrName=o,n.attrValue=t,n.keepAttr=!0,n.forceKeepAttr=void 0,R("uponSanitizeAttribute",e,n),t=n.attrValue,!n.forceKeepAttr){if("name"===o&&"IMG"===e.nodeName&&i.id)l=i.id,i=xe(i,[]),N("id",e),N(s,e),we(i,l)>r&&e.setAttribute("id",l.value);else{if("INPUT"===e.nodeName&&"type"===o&&"file"===t&&n.keepAttr&&(m[o]||!b[o]))continue;"id"===s&&e.setAttribute(s,""),N(s,e)}if(n.keepAttr)if(y&&Ie(/\/>/i,t))N(s,e);else if(Ie(/svg|math/i,e.namespaceURI)&&Ie(ze("</("+Ae(be(ie),"|")+")","i"),t))N(s,e);else{w&&(t=Ce(t,h," "),t=Ce(t,p," "));var l=e.nodeName.toLowerCase();if(fe(l,o,t))try{a?e.setAttributeNS(a,s,t):e.setAttribute(s,t),ke(c.removed)}catch(e){}}}}R("afterSanitizeAttributes",e,null)}},ge=function e(t){var r,i=he(t);for(R("beforeSanitizeShadowDOM",t,null);r=i.nextNode();)R("uponSanitizeShadowNode",r,null),pe(r)||(r.content instanceof D&&e(r.content),me(r));R("afterSanitizeShadowDOM",t,null)};c.sanitize=function(e,t){var r,i=void 0,n=void 0,s=void 0;if("string"!=typeof(e=e||"\x3c!--\x3e")&&!O(e)){if("function"!=typeof e.toString)throw _e("toString is not a function");if("string"!=typeof(e=e.toString()))throw _e("dirty is not a string, aborting")}if(!c.isSupported){if("object"===$e(o.toStaticHTML)||"function"==typeof o.toStaticHTML){if("string"==typeof e)return o.toStaticHTML(e);if(O(e))return o.toStaticHTML(e.outerHTML)}return e}if(k||le(t),c.removed=[],!(I="string"==typeof e?!1:I))if(e instanceof u)1===(t=(i=ue("\x3c!--\x3e")).ownerDocument.importNode(e,!0)).nodeType&&"BODY"===t.nodeName||"HTML"===t.nodeName?i=t:i.appendChild(t);else{if(!x&&!w&&!A&&-1===e.indexOf("<"))return d&&S?d.createHTML(e):e;if(!(i=ue(e)))return x?null:V}i&&E&&ce(i.firstChild);for(var a=he(I?e:i);r=a.nextNode();)3===r.nodeType&&r===n||pe(r)||(r.content instanceof D&&ge(r.content),me(r),n=r);if(n=null,I)return e;if(x){if(T)for(s=z.call(i.ownerDocument);i.firstChild;)s.appendChild(i.firstChild);else s=i;return s=te?G.call(l,s,!0):s}t=A?i.outerHTML:i.innerHTML;return w&&(t=Ce(t,h," "),t=Ce(t,p," ")),d&&S?d.createHTML(t):t},c.setConfig=function(e){le(e),k=!0},c.clearConfig=function(){P=null,k=!1},c.isValidAttribute=function(e,t,r){P||le({});e=Te(e),t=Te(t);return fe(e,t,r)},c.addHook=function(e,t){"function"==typeof t&&(i[e]=i[e]||[],Ee(i[e],t))},c.removeHook=function(e){i[e]&&ke(i[e])},c.removeHooks=function(e){i[e]&&(i[e]=[])},c.removeAllHooks=function(){i={}}}else c.isSupported=!1;return c}()}),pxt=pxt||{},(c=>{var e;{var u=c.analytics||(c.analytics={});let a={},o={},r=!1,l;function n(t){Object.keys(t).forEach(e=>{"string"==typeof t[e]?a[e]=t[e]:o[e]=t[e]})}(e=l=u.ConsoleTickOptions||(u.ConsoleTickOptions={}))[e.Off=0]="Off",e[e.Short=1]="Short",e[e.Verbose=2]="Verbose",u.consoleTicks=l.Off,u.addDefaultProperties=n,u.enable=function(t){if(c.aiTrackException&&c.aiTrackEvent&&!r){r=!0,n({lang:t="string"==typeof t&&0!=t.length?t:"en"}),c.debug("setting up app insights");let s=c.tickEvent,i=(c.tickEvent=function(e,i,t){var r,n;if(i=c.Util.cleanData(i),u.consoleTicks!=l.Off&&(r=u.consoleTicks==l.Short?"":(new Date).toLocaleTimeString(void 0,{hour12:!1})+" - Tick - ",n=`${e} ${i?JSON.stringify(i):"<no data>"} `+(t?JSON.stringify(t):"<no opts>"),c.log(r+n)),s&&s(e,i,t),null!=t&&t.interactiveConsent&&c.setInteractiveConsent(!0),i){let t=Object.assign({},a),r=Object.assign({},o);Object.keys(i).forEach(e=>{"string"==typeof i[e]?t[e]=i[e]:"number"==typeof i[e]?r[e]=i[e]:t[e]=JSON.stringify(i[e]||"")}),c.aiTrackEvent(e,t,r)}else c.aiTrackEvent(e)},c.reportException),e=(c.reportException=function(e,t){t=c.Util.cleanData(t),i&&i(e,t);var r={target:c.appTarget.id,version:c.appTarget.versions.target};t&&c.Util.jsonMergeFrom(r,t),c.aiTrackException(e,"exception",r)},c.reportError);c.reportError=function(t,r,i){i=c.Util.cleanData(i),e&&e(t,r,i);try{throw r}catch(e){t={target:c.appTarget.id,version:c.appTarget.versions.target,category:t,message:r};i&&c.Util.jsonMergeFrom(t,i),c.aiTrackException(e,"error",t)}}}},u.trackPerformanceReport=function(){var e,t;c.perf.perfReportLogged||(e=c.perf.report())&&({durations:e,milestones:t}=e,c.tickEvent("performance.milestones",t),c.tickEvent("performance.durations",e))}}})(pxt=pxt||{}),pxt=pxt||{},(e=>{{e=e.AudioContextManager||(e.AudioContextManager={});let r=0,i,n,s,a=!1;function o(){return i=i||(()=>{if(window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext)try{return new window.AudioContext}catch(e){}})()}function t(){i&&(s.gain.setTargetAtTime(0,i.currentTime,.015),r=0)}e.mute=function(e){i&&(a=e,t(),e)&&n&&(n.disconnect(),s.disconnect(),n=void 0,s=void 0)},e.stop=t,e.frequency=function(){return r},e.tone=function(e){if(!a&&!(isNaN(e)||e<0)){r=e;var t=o();if(t)try{n||((n=t.createOscillator()).type="triangle",(s=t.createGain()).gain.value=0,s.connect(t.destination),n.connect(s),n.start(0)),n.frequency.linearRampToValueAtTime(e,i.currentTime),s.gain.setTargetAtTime(.2,i.currentTime,.015)}catch(e){n=void 0}}}}})(pxt=pxt||{}),(p=>{{var f=p.auth||(p.auth={});let l="auth",c="csrf-token",u="login-state",r="user-state",d="interactive-login-until",t=!1;f.DEFAULT_USER_PREFERENCES=()=>({language:p.appTarget.appTheme.defaultLocale,highContrast:!1,accessibleBlocks:!1,colorThemeIds:{},reader:"",skillmap:{mapProgress:{},completedTags:{}},email:!1});let e,a=(f.client=function(){if(!t)return e},0),o=0;async function m(e,t){return t?p.storage.shared.setAsync(l,e,t):p.storage.shared.delAsync(l,e)}async function s(e){try{return await p.storage.shared.getAsync(l,e)}catch(e){}}async function i(){var e=await s(c);return f.cachedHasAuthToken=!!e,e}async function n(){return!!await i()}async function g(){return f.cachedHasAuthToken=!1,m(c,void 0)}async function b(){let t;try{t=await p.storage.shared.getAsync(l,r)}catch(e){t={}}return f.cachedUserState=t}async function v(e){return f.cachedUserState=Object.assign({},e),p.storage.shared.setAsync(l,r,e)}async function y(){return f.cachedUserState=void 0,p.storage.shared.delAsync(l,r)}async function w(e){var t={};return(e=e||await i())&&(t.authorization="mkcd "+e),t["x-pxt-target"]=null==(e=p.appTarget)?void 0:e.id,t}f.cachedHasAuthToken=!1,f.getAuthTokenAsync=i,f.hasAuthTokenAsync=n,f.getUserStateAsync=b,f.getAuthHeadersAsync=w;class x{constructor(){this.initialUserPreferences_=void 0,this.initialAuthCheck_=void 0,this.patchQueue=[],e=this}async initAsync(){var e=await b();this.setUserProfileAsync(null==e?void 0:e.profile),this.setUserPreferencesAsync(null==e?void 0:e.preferences)}async loginAsync(e,t,r=void 0){if(k()&&(i=e,0<A().filter(e=>e.id===i).length)){r=null!=r?r:h,this.clearAuthStateAsync();var i,r={key:(Math.PI*Math.random()).toString(36).slice(2),callbackState:r,callbackPathname:window.location.pathname,idp:e,persistent:t},n=(parseInt(await s(d))||0)>Date.now(),t=p.Util.stringifyQueryString("/api/auth/login",{response_type:"token",provider:e,persistent:t,redirect_uri:""+window.location.origin+window.location.pathname+"?authcallback=1&state="+r.key,prompt:n?"select_account":"silent"}),n=await this.apiAsync(t);if(n.success)r.authCodeVerifier=n.resp.authCodeVerifier,await p.storage.shared.setAsync(l,u,r),p.tickEvent("auth.login.start",{provider:e}),window.location.href=n.resp.loginUrl;else try{await this.onSignInFailed()}catch(e){}}}async logoutAsync(e){if(k()){await x.staticLogoutAsync(e);try{await this.onStateCleared()}catch(e){}try{await this.onSignedOut()}catch(e){}}}static async staticLogoutAsync(t){if(k()){p.tickEvent("auth.logout"),await m(d,(Date.now()+6e4).toString()),t=t?t.startsWith("#")?t:"#"+t:"";t=""+window.location.origin+window.location.pathname+window.location.search+t;let e="";try{var r=p.Util.stringifyQueryString("/api/auth/logout",{redirect_uri:t,authcallback:"1"}),i=await x.staticApiAsync(r);i.success&&(e=i.resp.logoutUrl)}catch(e){}await g(),await y(),p.BrowserUtils.hasWindow()&&(e?window.location.href=e:(window.location.href=t,location.reload()))}}async deleteProfileAsync(){if(await this.loggedInAsync()){var e=await b(),e=null==(e=null==e?void 0:e.profile)?void 0:e.id,t=await this.apiAsync("/api/user",null,"DELETE");if(t.err)try{await this.onApiError(t.err)}catch(e){}else try{await this.clearAuthStateAsync();try{await this.onProfileDeleted(e)}catch(e){}}finally{p.tickEvent("auth.profile.deleted")}}}async initialUserPreferencesAsync(){if(await this.loggedInAsync())return this.initialUserPreferences_||(this.initialUserPreferences_=this.fetchUserPreferencesAsync()),this.initialUserPreferences_}async userProfileAsync(){var e;if(await this.loggedInAsync())return e=await b(),Object.assign({},e.profile)}async userPreferencesAsync(){var e=await b();return Object.assign({},e.preferences)}async authCheckAsync(){var e,t;if(k()&&await n())return null!=(e=null==(t=await b())?void 0:t.profile)&&e.id?this.initialAuthCheck_||(this.initialAuthCheck_=Promise.resolve(t.profile)):this.initialAuthCheck_||(this.initialAuthCheck_=this.fetchUserAsync()),this.initialAuthCheck_}async loggedInAsync(){return!!await this.authCheckAsync()&&this.hasUserIdAsync()}async updateUserProfileAsync(e){var t;return!!await this.loggedInAsync()&&(t=await b(),(t=await this.apiAsync("/api/user/profile",{id:t.profile.id,username:e.username,avatarUrl:e.avatarUrl})).success&&await this.setUserProfileAsync(t.resp),t.success)}async patchUserPreferencesAsync(e,t={}){let i=async()=>({success:!0,res:await this.userPreferencesAsync()});if(!(e=(e=Array.isArray(e)?e:[e]).filter(e=>!!e)).length)return i();let n=(e,t,r)=>{var i=p.U.deepCopy(e);ts.pxtc.jsonPatch.patchInPlace(i,t);let n=ts.pxtc.jsonPatch.diff(e,i);return n=n.length&&r?n.filter(r):n};var r=await this.userPreferencesAsync(),s=n(r,e,t.filter);if(!s.length)return i();if(ts.pxtc.jsonPatch.patchInPlace(r,s),await this.setUserPreferencesAsync(r),!await this.loggedInAsync())return i();this.patchQueue.push({ops:e,filter:t.filter}),clearTimeout(a);s=async()=>{if(o=0,!this.patchQueue.length)return i();var e=await this.apiAsync("/api/user/preferences");if(!e.success)return p.reportError("identity","failed to fetch preferences for patch",e),{success:!1,res:void 0};let t=p.U.deepCopy(e.resp)||f.DEFAULT_USER_PREFERENCES();var r=this.patchQueue,r=(this.patchQueue=[],r.forEach(e=>{e=n(t,e.ops,e.filter);ts.pxtc.jsonPatch.patchInPlace(t,e)}),pxtc.jsonPatch.diff(e.resp,t)),e=await this.apiAsync("/api/user/preferences",r,"PATCH");return e.success?this.setUserPreferencesAsync(e.resp):p.reportError("identity","failed to patch preferences",e),{success:e.success,res:e.resp}};return t.immediate||(o=o||p.U.now(),1e4<p.U.now()-o)?s():(a=setTimeout(s,1e3),{success:!1,res:void 0})}async hasUserIdAsync(){var e;return!!k()&&(await n()?!(null==(e=null==(e=await b())?void 0:e.profile)||!e.id):void 0)}async fetchUserAsync(){var e,t;if(k()&&await n())return null!=(e=null==(t=await b())?void 0:t.profile)&&e.id?t.profile:(e=await this.apiAsync("/api/user/profile")).success?(t=e.resp,await this.setUserProfileAsync(t),t):void 0}async setUserProfileAsync(e){var t=await this.hasUserIdAsync(),e=(await this.transformUserProfileAsync(e),await this.hasUserIdAsync());try{await this.onUserProfileChanged()}catch(e){}if(e&&!t)try{await this.onSignedIn()}catch(e){}else if(!e&&t)try{await this.onSignedOut()}catch(e){}}async setUserPreferencesAsync(e){var t=await b(),t=null!=(t=null==t?void 0:t.preferences)?t:f.DEFAULT_USER_PREFERENCES(),r=ts.pxtc.jsonPatch.diff(t,e),t=await this.transformUserPreferencesAsync(Object.assign(Object.assign({},t),e));try{await this.onUserPreferencesChanged(r)}catch(e){}return t}async fetchUserPreferencesAsync(){if(await this.loggedInAsync()){await b();var e=await this.apiAsync("/api/user/preferences");if(e.success)if(e.resp)return this.setUserPreferencesAsync(e.resp)}}async transformUserProfileAsync(e){var t=await b();return await v(t=Object.assign(Object.assign({},t),{profile:Object.assign({},e)})),t.profile}async transformUserPreferencesAsync(e){var t=await b();return await v(t=Object.assign(Object.assign({},t),{preferences:Object.assign({},e)})),t.preferences}async clearAuthStateAsync(){await g(),await y();try{await this.onStateCleared()}catch(e){}}async apiAsync(e,t,r,i){return x.staticApiAsync(e,t,r,i)}static async staticApiAsync(t,e,r,i){i=await w(i);return t=p.BrowserUtils.isLocalHostDev()?""+p.cloud.DEV_BACKEND+t:t,p.Util.requestAsync({url:t,headers:i,data:e,method:r||(e?"POST":"GET"),withCredentials:!0}).then(e=>({statusCode:e.statusCode,resp:e.json,success:2===Math.floor(e.statusCode/100),err:null})).catch(async e=>(/logout/.test(t)||401!=e.statusCode||await x.staticLogoutAsync(),{statusCode:e.statusCode,err:e,resp:null,success:!1}))}}f.AuthClient=x;let h={hash:"",params:{}};function A(){var e;return Object.keys((null==(e=null==(e=p.appTarget)?void 0:e.cloud)?void 0:e.cloudProviders)||{}).map(e=>p.appTarget.cloud.cloudProviders[e]).filter(e=>e.identity).sort((e,t)=>e.order-t.order)}function k(){return!t&&!p.BrowserUtils.isPxtElectron()&&0<A().length}function E(e,t){return e.id===t.id&&e.sourceURL===t.sourceURL}f.loginCallbackAsync=async function(e){let t,r=Object.assign({},h);do{if(!(t=await p.storage.shared.getAsync(l,u)))return void p.debug("Auth state not found in storge.");await p.storage.shared.delAsync(l,u);var i=e.state;if(!i||t.key!==i)return void p.debug("Failed to get auth state for key");r=Object.assign(Object.assign({},h),t.callbackState);i=e.error;if(i){var n=e.error_description;p.tickEvent("auth.login.error",{error:i,provider:t.idp}),p.log(`Auth failed: ${i}:`+n),r=Object.assign({},h);break}i=e.token;if(!i){p.debug("Missing authToken in auth callback.");break}t.authCodeVerifier&&(n=p.Util.stringifyQueryString("/api/otac/check",{persistent:t.persistent}),await x.staticApiAsync(n,null,null,t.authCodeVerifier)),i=i,f.cachedHasAuthToken=!!i,await m(c,i),await m(d,void 0),p.tickEvent("auth.login.success",{provider:t.idp})}while(0);var s=r.hash.startsWith("#")?r.hash:"#"+r.hash,a=p.Util.stringifyQueryString("",r.params),o=t.callbackPathname.startsWith("/")?t.callbackPathname:"/"+t.callbackPathname;window.location.href=""+o+a+s},f.identityProviders=A,f.identityProvider=function(t){return A().filter(e=>e.id===t).shift()},f.hasIdentity=k,f.enableAuth=function(e=!0){t=!e},f.userName=function(e){var t;return null!=(e=null!=(t=null==(t=null==e?void 0:e.idp)?void 0:t.displayName)?t:null==(t=null==e?void 0:e.idp)?void 0:t.username)?e:"??"},f.identityProviderId=function(e){return null==(e=null==e?void 0:e.idp)?void 0:e.provider},f.firstName=function(e){return(null==(e=p.auth.userName(e))?void 0:e.split(" ").shift())||e},f.userInitials=function(e){return e=p.auth.userName(e),ts.pxtc.Util.initials(e)},f.generateUserProfilePicDataUrl=function(e){if(null!=(t=null==(t=null==e?void 0:e.idp)?void 0:t.picture)&&t.encoded){var t=window.URL||window.webkitURL;try{var r=p.Util.stringToUint8Array(atob(e.idp.picture.encoded)),i=new Blob([r],{type:e.idp.picture.mimeType});e.idp.picture.dataUrl=t.createObjectURL(i)}catch(e){}}},f.badgeEquals=E,f.hasBadge=function(e,t){return e.badges.some(e=>E(e,t))}}})(pxt=pxt||{}),(pxt||(pxt={})).tickEvent=function(e){},(e=>{let t;var r;(r=t=e.LogLevel||(e.LogLevel={}))[r.Debug=0]="Debug",r[r.Info=1]="Info",r[r.Log=1]="Log",r[r.Warning=2]="Warning",r[r.Error=3]="Error";class i{constructor(){this.setLogLevel(t.Info)}setLogLevel(e){this.logLevel=e}getLogLevel(){return this.logLevel}info(...e){this.shouldLog(t.Info)&&null!=console&&console.info&&console.info.call(null,...e)}log(...e){this.shouldLog(t.Log)&&null!=console&&console.log&&console.log.call(null,...e)}debug(...e){this.shouldLog(t.Debug)&&null!=console&&console.debug&&console.debug.call(null,...e)}error(...e){this.shouldLog(t.Error)&&null!=console&&console.error&&console.error.call(null,...e)}warn(...e){this.shouldLog(t.Warning)&&null!=console&&console.warn&&console.warn.call(null,...e)}shouldLog(e){return e>=this.logLevel}}let n=new(e.ConsoleLogger=i);e.info=function(...e){n.info(...e)},e.log=function(...e){n.log(...e)},e.debug=function(...e){n.debug(...e)},e.error=function(...e){n.error(...e)},e.warn=function(...e){n.warn(...e)},e.setLogger=function(e){var t=null==n?void 0:n.getLogLevel();n=e,void 0!==t&&n.setLogLevel(t)},e.setLogLevel=function(e){n.setLogLevel(e)}})(pxt=pxt||{}),(e=>{(e.pxtc||(e.pxtc={})).__dummy=42})(ts=ts||{}),ts.pxtc),ts,pxt,pxt,pxt,pxt,pxt,pxt,Measurements,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,ts,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,pxt,ts,pxt,pxt,pxt,pxt,ts,pxt,ts,pxtmelody,pxtmelody,pxtmelody,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim;(s=>{s=s.pxtc||(s.pxtc={});{var l=s.Util||(s.Util={});function a(e){return e.replace(/[^\w .!?\-$]/g,e=>{e=e.charCodeAt(0).toString(16);return"\\u"+"0000".substr(0,4-e.length)+e})}l.assert=function(e,t="Assertion failed"){if(!e)throw new Error(t)},l.flatClone=function(t){if(null==t)return null;let r={};return Object.keys(t).forEach(e=>{r[e]=t[e]}),r},l.clone=function(e){return null==e?null:JSON.parse(JSON.stringify(e))},l.htmlEscape=function(e){return e&&e.replace(/([^\w .!?\-$])/g,e=>"&#"+e.charCodeAt(0)+";")},l.htmlUnescape=function(e){return e&&e.replace(/(&#\d+;)/g,e=>String.fromCharCode(Number(e.substr(2,e.length-3))))},l.jsStringQuote=a,l.jsStringLiteral=function(e){return'"'+a(e)+'"'};let t="en",r={},e={},i=!(l.initials=function(e){return(/^\w+@/.test(e)?e.match(/^\w\w/).shift():((e=e.match(/\b\w/g)||[]).shift()||"")+(e.pop()||"")).toUpperCase()});function o(){return t}function c(e){var t=/^(\w{2,3})-(\w{2,4}$)/i.exec(e);return t&&t[1]&&t[2]?[t[1].toLowerCase()+"-"+t[2].toUpperCase(),t[1].toLowerCase(),t[1].toLowerCase()+"-"+t[2].toLowerCase()]:[(e||"en").toLowerCase()]}function u(e,o){return 0==o.length?e:e.replace(/\{([0-9]+)(\:[^\}]+)?\}/g,function(e,r,t){r=o[parseInt(r)];let i="";var n=/^:f(\d*)\.(\d+)/.exec(t);if(n){var s=parseInt(n[2]);let e=parseInt(n[1])||0;var a=/^0/.test(n[1])?"0":" ";let t=r.toFixed(s);if(0<e&&0<s&&(e+=s+1),0<e)for(;t.length<e;)t=a+t;i=t}else i=":x"==t?"0x"+r.toString(16):void 0===r?"(undef)":null===r?"(null)":r.toString?r.toString():r+"";return":a"==t?/^\s*[euioah]/.test(i.toLowerCase())?i="an "+i:/^\s*[bcdfgjklmnpqrstvwxz]/.test(i.toLowerCase())&&(i="a "+i):":s"==t?i=1==r?"":"s":":q"==t?i=l.htmlEscape(i):":jq"==t?i=l.jsStringQuote(i):":uri"==t?i=encodeURIComponent(i).replace(/'/g,"%27").replace(/"/g,"%22"):":url"==t?i=encodeURI(i).replace(/'/g,"%27").replace(/"/g,"%22"):":%"==t&&(i=(100*r).toFixed(1).toString()+"%"),i})}l.enableLiveLocalizationUpdates=function(){i=!0},l.liveLocalizationEnabled=function(){return i},l.localeInfo=function(){return(i?"live-":"")+t},l.userLanguage=o,l.normalizeLanguageCode=c,l.setUserLanguage=function(e){t=c(e)[0]},l.isUserLanguageRtl=function(){return/^ar|dv|fa|ha|he|ks|ku|ps|ur|yi/i.test(t)},l.TRANSLATION_LOCALE="pxt",l.isTranslationMode=function(){return t==l.TRANSLATION_LOCALE},l._localize=function(e){return r[e]||e},l.getLocalizedStrings=function(){return r},l.setLocalizedStrings=function(e){r=e},l.translationsCache=function(){return e},l.fmt_va=u,l.fmt=function(e,...t){return u(e,t)};let n={};function d(e,t){if(!e)return e;n[e]=(n[e]||0)+1;let r=l._localize(e);return u(r=r.replace(/^\{(id|loc):[^\}]+\}/g,""),t)}l.dumpLocStats=function(){let t={};Object.keys(n).sort((e,t)=>n[t]-n[e]).forEach(e=>t[e]=e),pxt.log("prioritized list of strings:"),pxt.log(JSON.stringify(t,null,2))},l.lf_va=d,l.lf=function(e,...t){return d(e,t)},l.rlf=function(e,...t){return d(e,t)},l.lookup=function(e,t){return e.hasOwnProperty(t)?e[t]:null},l.isoTime=function(e){return e=new Date(1e3*e),l.fmt("{0}-{1:f02.0}-{2:f02.0} {3:f02.0}:{4:f02.0}:{5:f02.0}",e.getFullYear(),e.getMonth()+1,e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds())},l.userError=function(e){throw(e=new Error(e)).isUserError=!0,e},l.deq=function t(r,i){if(r!==i){if(!r||!i)return"Null value";if("object"!=typeof r||"object"!=typeof i)return"Unable to compare "+r+", "+i;if(Array.isArray(r)){if(!Array.isArray(i))return"Expected array";if(r.length!=i.length)return"Expected array of length "+r.length+", got "+i.length;for(let e=0;e<r.length;e++)if(null!=t(r[e],i[e]))return"Expected array value "+r[e]+" got "+i[e]}else{var n=Object.keys(r),e=Object.keys(r);if(n.length!=e.length)return"Expected "+n.length+" keys, got "+e.length;for(let e=0;e<n.length;e++){if(!Object.prototype.hasOwnProperty.call(i,n[e]))return"Missing key "+n[e];if(null!=t(r[n[e]],i[n[e]]))return"Expected value of "+n[e]+" to be "+r[n[e]]+", got "+i[n[e]]}}}return null},l.deepEqual=function t(r,i){if(r===i)return!0;if(r&&i&&"object"==typeof r&&"object"==typeof i){var e,n=Array.isArray(r),s=Array.isArray(i);if(n&&s){if(r.length!==i.length)return!1;for(let e=0;e<r.length;++e)if(!t(r[e],i[e]))return!1}else{if(n!==s)return!1;if((n=Object.keys(r)).length!==Object.keys(i).length)return!1;for(e of n){if(!i.hasOwnProperty(e))return!1;if(!t(r[e],i[e]))return!1}}return!0}return r!=r&&i!=i}}})(ts=ts||{});let lf=ts.pxtc.Util.lf,getCellId=((e=>{(e=e.pxtc||(e.pxtc={})).decodeBase64=function(e){return atob(e)},e.encodeBase64=function(e){return btoa(e)}})(ts=ts||{}),(a=>{var e,u=a.pxtc||(a.pxtc={});{var f=u.Util||(u.Util={});function i(t,r){if(r)for(let e=0;e<r.length;++e)t.push(r[e])}function r(t){var r=[];for(let e=0;e<t.length;++e)i(r,t[e]);return r}function n(e){return e&&"object"==typeof e&&!Array.isArray(e)}function o(t,r,i,n,s){void 0===n&&(n=0),void 0===s&&(s=i.length-n);for(let e=0;e<s;++e)t[r+e]=i[n+e]}function s(e,t){return e==t?0:e<t?-1:1}f.CancellationToken=class{constructor(){this.pending=!1,this.cancelled=!1}startOperation(){this.pending=!0}isRunning(){return this.pending}onProgress(e){this.progressHandler=e}reportProgress(e,t){this.progressHandler&&this.progressHandler(e,t)}cancel(){this.cancelled=!0,this.pending=!1}cancelAsync(){return this.cancelled||!this.pending?(this.cancelled=!0,this.pending=!1,Promise.resolve()):(this.cancelled=!0,this.deferred=new Promise(e=>{this.resolve=e}),this.deferred)}isCancelled(){return this.cancelled}throwIfCancelled(){if(this.isCancelled())throw new Error}resolveCancel(){this.pending=!1,this.deferred&&(this.resolve(),this.deferred=void 0,this.resolve=void 0)}},f.codalHash16=function(e){let n=[251,175,119,215,81,14,79,191,103,49,181,143,186,157,0,232,31,32,55,60,152,58,17,237,174,70,160,144,220,90,57,223,59,3,18,140,111,166,203,196,134,243,124,95,222,179,197,65,180,48,36,15,107,46,233,130,165,30,123,161,209,23,97,16,40,91,219,61,100,10,210,109,250,127,22,138,29,108,244,67,207,9,178,204,74,98,126,249,167,116,34,77,193,200,121,5,20,113,71,35,128,13,182,94,25,226,227,199,75,27,41,245,230,224,43,225,177,26,155,150,212,142,218,115,241,73,88,105,39,114,62,255,192,201,145,214,168,158,221,148,154,122,12,84,82,163,44,139,228,236,205,242,217,11,187,146,159,64,86,239,195,42,106,198,118,112,184,172,87,2,173,117,176,229,247,253,137,185,99,164,102,147,45,66,231,52,141,211,194,206,246,238,56,110,78,248,63,240,189,93,92,51,53,183,19,171,72,50,33,104,101,69,8,252,83,120,76,135,85,54,202,125,188,213,96,235,136,208,162,129,190,132,156,38,47,1,7,254,24,4,216,131,89,21,28,133,37,153,149,80,170,68,6,169,234,151];if(e){var r=e;var i=2;var s,a=new Uint8Array(r.length);for(let e=0;e<r.length;++e){var o=r.charCodeAt(e);a[e]=255&o}let t=0;for(let e=0;e<i;++e)s=(t=>{let r=0;for(let e=0;e<t.length;e++){var i=t[e];r=n[r^i]}return r})(a),t|=s<<8*e,a[0]=(a[0]+1)%255;return t}return 0},f.bufferSerial=function(t,r="",i="?",n=255){for(let e=0;e<r.length;++e){var s=r[e];t[i]=(t[i]||"")+s,("\n"===s||t[i].length>n)&&(s=t[i],t[i]="",window.postMessage({type:"serial",id:i,data:s},"*"))}},f.blobReadAsDataURL=function(i){return i?new Promise((e,t)=>{let r=new FileReader;r.onload=()=>e(r.result),r.onerror=e=>t(e),r.readAsDataURL(i)}):Promise.resolve(void 0)},f.fileReadAsBufferAsync=function(i){return i?new Promise((t,e)=>{let r=new FileReader;r.onerror=e=>t(null),r.onload=e=>t(new Uint8Array(r.result)),r.readAsArrayBuffer(i)}):Promise.resolve(null)},f.fileReadAsTextAsync=function(i){return i?new Promise((t,e)=>{let r=new FileReader;r.onerror=e=>t(null),r.onload=e=>t(r.result),r.readAsText(i)}):Promise.resolve(null)},f.sanitizeFileName=function(e){return e.replace(/[()\\\/.,?*^:<>!;'#$%^&|"@+={}\[\]~`\x00-\x1F]/g,"").trim().replace(/\s+/g,"-")},f.repeatMap=function(t,r){t=t||0;var i=[];for(let e=0;e<t;++e)i.push(r(e));return i},f.listsEqual=function(t,r){if(!t||!r||t.length!==r.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==r[e])return!1;return!0},f.oops=function(e="OOPS"){throw new Error(e)},f.reversed=function(e){return(e=e.slice(0)).reverse(),e},f.arrayEquals=function(t,r,i=(e,t)=>e===t){if(t!=r){if(!t&&r||!r&&t||t.length!==r.length)return!1;for(let e=0;e<t.length;e++)if(!i(t[e],r[e]))return!1}return!0},f.iterMap=function(t,r){Object.keys(t).forEach(e=>r(e,t[e]))},f.mapMap=function(t,r){let i={};return Object.keys(t).forEach(e=>i[e]=r(e,t[e])),i},f.values=function(t){return Object.keys(t||{}).map(e=>t[e])},f.pushRange=i,f.concatArrayLike=r,f.concat=r,f.memcpy=o,f.uint8ArrayConcat=function(e){let t=0;for(var r of e)t+=r.length;var i,n=new Uint8Array(t);let s=0;for(i of e)o(n,s,i),s+=i.length;return n},f.jsonTryParse=function(e){try{return JSON.parse(e)}catch(e){}},f.jsonMergeFrom=function t(r,i){i&&Object.keys(i).forEach(e=>{n(r[e])&&n(i[e])?t(r[e],i[e]):r[e]=f.clone(i[e])})},f.jsonCopyFrom=function(e,t){var r,i=f.clone(t);for(r of Object.keys(t))e[r]=i[r]},f.jsonFlatten=function(e){let i={},n=(e,t)=>{if(null!==t&&"object"==typeof t){f.assert(!Array.isArray(t)),e&&(e+=".");for(var r of Object.keys(t))n(e+r,t[r])}else i[e]=t};return n("",e),i},f.jsonUnFlatten=function(r){var i,e={};for(i of Object.keys(r)){let t=e;var n=i.split(".");for(let e=0;e<n.length;++e){var s=n[e];e==n.length-1?t[s]=r[i]:("object"!=typeof t[s]&&(t[s]={}),t=t[s])}}return e},f.strcmp=s,f.stringMapEq=function(e,t){var r,i=Object.keys(e),n=Object.keys(t);if(i.length!=n.length)return!1;for(r of i){if(!t.hasOwnProperty(r))return!1;if(e[r]!==t[r])return!1}return!0},f.endsWith=function(e,t){return!(e.length<t.length||0!=t.length&&e.slice(-t.length)!=t)},f.startsWith=function(e,t){return!(e.length<t.length||0!=t.length&&e.slice(0,t.length)!=t)},f.contains=function(e,t){return!(e.length<t.length)&&(0==t.length||-1<e.indexOf(t))},f.replaceAll=function(e,t,r){return t?e.split(t).join(r):e},f.snakify=function(r){let i=r.toUpperCase(),t=r.toLowerCase();if(r==i||r==t)return r;if(0<r.lastIndexOf("_"))return r;var n,s=e=>r[e]!=t[e];let a="",o=0;for(;o<r.length;){let e=s(o),t=o;for(;t<r.length;){if(e&&(n=t,r[n]!=i[n])){if(2<t-o){t--;break}e=!1}if(!e&&s(t))break;t++}a&&(a+="_"),a+=r.slice(o,t),o=t}return a.toUpperCase()===a?a:a.toLowerCase()},f.sortObjectFields=function(t){var e=Object.keys(t);e.sort(s);let r={};return e.forEach(e=>r[e]=t[e]),r},f.chopArray=function(t,r){var i=[];for(let e=0;e<t.length;e+=r)i.push(t.slice(e,e+r));return i},f.unique=function(e,r){let i=[],n={};return e.forEach(e=>{var t=r(e);n.hasOwnProperty(t)||(n[t]=null,i.push(e))}),i},f.groupBy=function(e,r){let i={};return e.forEach(e=>{var t=r(e);i.hasOwnProperty(t)||(i[t]=[]),i[t].push(e)}),i},f.toDictionary=function(e,t){let r={};return e.forEach(e=>{r[t(e)]=e}),r},f.toSet=function(e,t){let r={};return e.forEach(e=>{r[t(e)]=!0}),r},f.deepCopy=function e(t){if("object"!=typeof t||null===t)return t;var r,i=Array.isArray(t)?[]:{};for(r in t){var n=t[r];i[r]=e(n)}return i},f.toArray=function(t){if(Array.isArray(t))return t;var r=[];if(t)for(let e=0;e<t.length;++e)r.push(t[e]);return r},f.indexOfMatching=function(t,r){for(let e=0;e<t.length;++e)if(r(t[e]))return e;return-1};let t=Promise.resolve();async function l(t,r,i){let n=0;var s=[];let a=[];for(let e=0;e<t;e++){var o=(async()=>{for(;n<r.length;){var e=n++,t=r[e];a[e]=await i(t)}})();s.push(o)}try{await Promise.all(s)}catch(e){throw n=r.length,e}return a}function d(r,i){let n={};return e=>{var t=r(e);return n.hasOwnProperty(t)?n[t]:n[t]=i(e)}}function h(e){return e=e&&e.replace(/\\/g,"/")}function p(r){let i={url:""+encodeURI(r.url.replace(/[?#].*/,"...")),method:""+(r.method||"GET")};return pxt.perf.measureStart(Measurements.NetworkRequest),f.httpRequestCoreAsync(r).then(e=>{var t=e.statusCode;return(r.successCodes||[304,200,201,202]).indexOf(t)<0&&!r.allowHttpErrors?(t=f.lf("Bad HTTP status code: {0} at {1}; message: {2}",e.statusCode,r.url,(e.text||"").slice(0,500)),(t=new Error(t)).statusCode=e.statusCode,Promise.reject(t)):(e.text&&/application\/json/.test(e.headers["content-type"])&&(e.json=u.U.jsonTryParse(e.text)),e)}).then(e=>{var t=e.headers["content-length"];return t?i.sizeInBytes=""+t:e.text&&pxt.perf.isEnabled()&&(t=(new TextEncoder).encode(e.text),i.sizeInBytes=t.length+""),i.statusCode=""+e.statusCode,e}).finally(()=>{pxt.perf.measureEnd(Measurements.NetworkRequest,i)})}function m(r,i){let n="";if(r)for(let t=0;t<r.length;++t){let e=r.charCodeAt(t);var s;e<=127?n+=r.charAt(t):e<=2047?n+=String.fromCharCode(192|e>>6,128|63&e):(!i&&55296<=e&&e<=56319&&(s=r.charCodeAt(++t),isNaN(s)||(e=65536+(e-55296<<10)+(s-56320))),e<=65535?n+=String.fromCharCode(224|e>>12,128|e>>6&63,128|63&e):n+=String.fromCharCode(240|e>>18,128|e>>12&63,128|e>>6&63,128|63&e))}return n}function g(){return Date.now()}function b(){var e=new Uint8Array(4);return f.getRandomBuf(e),new Uint32Array(e.buffer)[0]}function v(n,s,a){function t(r){pxt.debug(`downloading translations for ${n} `+s);var e=pxt.BrowserUtils.isLocalHost()||pxt.webConfig.isStatic?"https://makecode.com/api/":"";let t=e+`translations?lang=${encodeURIComponent(n)}&filename=${encodeURIComponent(s)}&approved=true`;var i={};return a&&!pxt.Cloud.useCdnApi()&&(i["If-None-Match"]=a),(e?p:pxt.Cloud.apiRequestWithCdnAsync)({url:t,headers:i}).then(t=>304==t.statusCode||200==t.statusCode?(a=t.headers.etag||"",pxt.BrowserUtils.translationDbAsync().then(e=>e.setAsync(n,s,a,t.json||r)).then(()=>t.json||r)):t.json,e=>{pxt.log("failed to load translations from "+t)})}return pxt.BrowserUtils.translationDbAsync().then(e=>e.getAsync(n,s)).then(e=>e?(a=e.etag,300<(Date.now()-e.time)/1e3&&t(e.strings),e.strings):t())}function y(e){var[e,t]=f.normalizeLanguageCode(e),r=pxt.appTarget.appTheme;if(r&&r.availableLocales){if(-1<r.availableLocales.indexOf(e))return!0;if(t&&-1<r.availableLocales.indexOf(t))return!0}return!1}f.nextTick=function(e){t.then(e)},f.delay=async function(t,e){return e=await e,await new Promise(e=>setTimeout(()=>e(),t)),e},f.promiseMapAll=function(e,t){return Promise.all(e.map(e=>t(e)))},f.promiseMapAllSeries=function(e,t){return l(1,e,t)},f.promisePoolAsync=l,f.memoizeString=function(e){return d(e=>e,e)},f.promiseTimeout=async function(r,e,i){let n,s;var t=new Promise((e,t)=>{s=e,n=setTimeout(()=>{s=void 0,clearTimeout(n),t(i||`Promise timed out after ${r}ms`)},r)});return Promise.race([e,t]).then(e=>(s&&(clearTimeout(n),s()),e))},f.defer=function(){let i,r,n,e=!1;return{resolve:function(t){e?pxt.debug("Deferred promise already resolved"):(r?r(t):i=i||new Promise(function(e){e(t)}),e=!0)},reject:function(r){e?pxt.debug("Deferred promise already resolved"):(n?n(r):i=i||new Promise(function(e,t){t(r)}),e=!0)},promise:new Promise(function(e,t){i?e(i):(r=e,n=t)})}},f.memoize=d,f.debounce=function(i,n,s){let a;return function(){let e=this,t=arguments;var r=s&&!a;return clearTimeout(a),a=setTimeout(function(){a=null,s||i.apply(e,t)},n),r&&i.apply(e,t),a}},f.AdaptiveDebouncer=class{constructor(e,t=300,r=2e3,i=2){this.func=e,this.minDelay=t,this.maxDelay=r,this.slowdownFactor=i,this.lastPoke=0,this.recentGaps=[],this.wrapped=()=>{this.timeout=null,this.func()}}poke(){var e=Date.now();if(this.lastPoke){var t=e-this.lastPoke;if(t<10)return;for(t<4e3&&this.recentGaps.push(t);10<this.recentGaps.length;)this.recentGaps.shift()}this.lastPoke=e}trigger(){let e=this.maxDelay;var t;this.lastPoke&&((t=this.recentGaps.slice()).sort(),t=t[t.length>>1]||1,e=Math.min(Math.max(t*this.slowdownFactor|0,this.minDelay),this.maxDelay),t=Date.now()-this.lastPoke,(e-=t)<0&&(e=0),this.lastPoke=null),clearTimeout(this.timeout),this.timeout=setTimeout(this.wrapped,e)}},f.throttle=function(i,n,s){let a;return function(){let e=this,t=arguments;var r=s&&!a;a=a||setTimeout(function(){a=null,s||i.apply(e,t)},n),r&&i.apply(e,t)}},f.randomPermute=function(t){for(let e=0;e<t.length;++e){var r=b()%t.length,i=t[e];t[e]=t[r],t[r]=i}},f.randomPick=function(e){return 0==e.length?null:e[b()%e.length]},f.timeSince=function(e){let t=(Date.now()-(e*=1e3))/1e3;return isNaN(t)?"":t<-30?(t=-t)<60?f.lf("in a few seconds"):t<120?f.lf("in a minute"):t<3600?f.lf("in {0} minute{0:s}",Math.floor(t/60)):t<7200?f.lf("in an hour"):t<86400?f.lf("in {0} hour{0:s}",Math.floor(t/60/60)):t<2592e3?f.lf("in {0} day{0:s}",Math.floor(t/60/60/24)):t<31536e3?f.lf("in {0} month{0:s}",Math.floor(t/60/60/24/30)):f.lf("in {0} year{0:s}",Math.floor(t/60/60/24/365)):t<0?f.lf("now"):t<10?f.lf("a few seconds ago"):t<60?f.lf("{0} second{0:s} ago",Math.floor(t)):t<120?f.lf("a minute ago"):t<3600?f.lf("{0} minute{0:s} ago",Math.floor(t/60)):t<7200?f.lf("an hour ago"):t<86400?f.lf("{0} hour{0:s} ago",Math.floor(t/60/60)):t<2592e3?f.lf("{0} day{0:s} ago",Math.floor(t/60/60/24)):t<31536e3?f.lf("{0} month{0:s} ago",Math.floor(t/60/60/24/30)):f.lf("{0} year{0:s} ago",Math.floor(t/60/60/24/365))},f.unicodeToChar=function(e){return e.replace(/\\u([\d\w]{4})/gi,function(e,t){return String.fromCharCode(parseInt(t,16))})},f.escapeForRegex=function(e){return null==e?void 0:e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},f.stripUrlProtocol=function(e){return null==e?void 0:e.replace(/.*?:\/\//g,"")},f.normalizePath=h,f.pathJoin=function(e,t){if(h(e),h(t),e||t)return e?t?("/"!==e.charAt(e.length-1)&&(e+="/"),e+(t="/"==t.charAt(0)?t.substring(1):t)):e:t},f.isNodeJS="undefined"==typeof window,f.requestAsync=p,f.httpGetTextAsync=function(e){return p({url:e}).then(e=>e.text)},f.httpGetJsonAsync=function(e){return p({url:e}).then(e=>e.json)},f.httpPostJsonAsync=function(e,t){return p({url:e,data:t||{}}).then(e=>e.json)},f.stringToUint8Array=function(t){var r=t.length,i=new Uint8Array(r);for(let e=0;e<r;++e)i[e]=255&t.charCodeAt(e);return i},f.uint8ArrayToString=function(t){var r=t.length;let i="";for(let e=0;e<r;++e)i+=String.fromCharCode(t[e]);return i},f.fromUTF8=function(t){if(!t)return"";let r="";for(let e=0;e<t.length;++e){var i=255&t.charCodeAt(e);r+=37==i||127<i?"%"+i.toString(16):t.charAt(e)}return decodeURIComponent(r)},f.toUTF8=m,f.toHex=function(t){let r="";for(let e=0;e<t.length;++e)r+=("0"+t[e].toString(16)).slice(-2);return r},f.fromHex=function(t){var r=new Uint8Array(t.length>>1);for(let e=0;e<t.length;e+=2)r[e>>1]=parseInt(t.slice(e,e+2),16);return r},f.PromiseQueue=class{constructor(){this.promises={}}enqueue(i,n){return new Promise((e,t)=>{let r=this.promises[i];(r=r||(this.promises[i]=[])).push(()=>n().finally(()=>{r.shift(),0==r.length?delete this.promises[i]:r[0]()}).then(e,t)),1==r.length&&r[0]()})}},f.PromiseBuffer=class{constructor(){this.waiting=[],this.available=[]}drain(){for(var e of this.waiting)e(new Error("Promise Buffer Reset"));this.waiting=[],this.available=[]}pushError(e){this.push(e)}push(e){var t=this.waiting.shift();t?t(e):this.available.push(e)}shiftAsync(e=0){var t;return 0<this.available.length?(t=this.available.shift())instanceof Error?Promise.reject(t):Promise.resolve(t):new Promise((t,r)=>{let i=e=>{(e instanceof Error?r:t)(e)};this.waiting.push(i),0<e&&u.U.delay(e).then(()=>{var e=this.waiting.indexOf(i);0<=e&&(this.waiting.splice(e,1),r(new Error("Timeout")))})})}},f.now=g,f.nowSeconds=function(){return Math.round(g()/1e3)},f.timeout=function(t){return new Promise(e=>setTimeout(()=>e(),t))},f.runWithBackoffAsync=async function(e,t,r,i,n,s,a=1.5){let o=r;for(var l=Date.now();Date.now()-l<n;){var c=await e();if(t(c))return c;await pxt.Util.timeout(o),o=Math.min(o*a,i)}throw new Error(s)},f.cpuUs=()=>{let e="undefined"!=typeof performance?performance.now.bind(performance)||performance.moznow.bind(performance)||performance.msNow.bind(performance)||performance.webkitNow.bind(performance)||performance.oNow.bind(performance):Date.now;return f.cpuUs=()=>1e3*e(),f.cpuUs()},f.getMime=function(e){if(!(e=/\.([a-zA-Z0-9]+)$/.exec(e)))return"application/octet-stream";switch(e[1].toLowerCase()){case"txt":return"text/plain";case"html":case"htm":return"text/html";case"css":return"text/css";case"js":return"application/javascript";case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"ico":return"image/x-icon";case"manifest":return"text/cache-manifest";case"webmanifest":return"application/manifest+json";case"json":return"application/json";case"svg":return"image/svg+xml";case"eot":return"application/vnd.ms-fontobject";case"ttf":return"font/ttf";case"woff":return"application/font-woff";case"woff2":return"application/font-woff2";case"md":return"text/markdown";case"xml":return"application/xml";case"m4a":return"audio/m4a";case"mp3":return"audio/mp3";case"wasm":return"application/wasm";default:return"application/octet-stream"}},f.randomUint32=b,f.guidGen=function(){function e(){return(65536|b()).toString(16).slice(-4)}return e()+e()+"-"+e()+"-4"+e().slice(-3)+"-"+e()+"-"+e()+e()+e()},f.downloadLiveTranslationsAsync=v,f.pxtLangCookieId="PXT_LANG",f.langCookieExpirationDays=30,f.allLanguages={af:{englishName:"Afrikaans",localizedName:"Afrikaans"},ar:{englishName:"Arabic",localizedName:""},az:{englishName:"Azerbaijani",localizedName:" "},bg:{englishName:"Bulgarian",localizedName:""},bi:{englishName:"Bislama",localizedName:"Bislama"},bn:{englishName:"Bengali",localizedName:""},ca:{englishName:"Catalan",localizedName:"Catal"},cs:{englishName:"Czech",localizedName:"etina"},cy:{englishName:"Welsh",localizedName:"Cymraeg"},da:{englishName:"Danish",localizedName:"Dansk"},de:{englishName:"German",localizedName:"Deutsch"},el:{englishName:"Greek",localizedName:""},en:{englishName:"English",localizedName:"English"},"es-ES":{englishName:"Spanish (Spain)",localizedName:"Espaol (Espaa)"},"es-MX":{englishName:"Spanish (Mexico)",localizedName:"Espaol (Mxico)"},et:{englishName:"Estonian",localizedName:"Eesti"},eu:{englishName:"Basque",localizedName:"Euskara"},fa:{englishName:"Persian",localizedName:""},fi:{englishName:"Finnish",localizedName:"Suomi"},fil:{englishName:"Filipino",localizedName:"Filipino"},fo:{englishName:"Faroese",localizedName:"froyskt"},fr:{englishName:"French",localizedName:"Franais"},"fr-CA":{englishName:"French (Canada)",localizedName:"Franais (Canada)"},"ga-IE":{englishName:"Irish",localizedName:"Gaeilge"},gl:{englishName:"Galician",localizedName:"galego"},gn:{englishName:"Guarani",localizedName:"Avae'"},"gu-IN":{englishName:"Gujarati",localizedName:""},haw:{englishName:"Hawaiian",localizedName:"lelo Hawaii"},hi:{englishName:"Hindi",localizedName:""},he:{englishName:"Hebrew",localizedName:""},hr:{englishName:"Croatian",localizedName:"Hrvatski"},hu:{englishName:"Hungarian",localizedName:"Magyar"},"hy-AM":{englishName:"Armenian (Armenia)",localizedName:" ()"},id:{englishName:"Indonesian",localizedName:"Bahasa Indonesia"},is:{englishName:"Icelandic",localizedName:"slenska"},it:{englishName:"Italian",localizedName:"Italiano"},ja:{englishName:"Japanese",localizedName:""},"ja-HIRA":{englishName:"Hiragana",localizedName:""},ka:{englishName:"Georgian",localizedName:""},kab:{englishName:"Kabyle",localizedName:""},kk:{englishName:"Kazakh",localizedName:" "},km:{englishName:"Khmer",localizedName:""},kmr:{englishName:"Kurmanji (Kurdish)",localizedName:""},kn:{englishName:"Kannada",localizedName:""},ko:{englishName:"Korean",localizedName:""},lt:{englishName:"Lithuanian",localizedName:"Lietuvi"},lv:{englishName:"Latvian",localizedName:"Latvieu"},"ml-IN":{englishName:"Malayalam",localizedName:""},mr:{englishName:"Marathi",localizedName:""},ms:{englishName:"Malay",localizedName:"Melayu"},nl:{englishName:"Dutch",localizedName:"Nederlands"},no:{englishName:"Norwegian",localizedName:"Norsk"},nb:{englishName:"Norwegian Bokmal",localizedName:"Norsk bokml"},"nn-NO":{englishName:"Norwegian Nynorsk",localizedName:"Norsk nynorsk"},"pa-IN":{englishName:"Punjabi",localizedName:""},pl:{englishName:"Polish",localizedName:"Polski"},ps:{englishName:"Pashto",localizedName:""},"pt-BR":{englishName:"Portuguese (Brazil)",localizedName:"Portugus (Brasil)"},"pt-PT":{englishName:"Portuguese (Portugal)",localizedName:"Portugus (Portugal)"},ro:{englishName:"Romanian",localizedName:"Romn"},ru:{englishName:"Russian",localizedName:""},sat:{englishName:"Santali",localizedName:""},"si-LK":{englishName:"Sinhala",localizedName:""},sk:{englishName:"Slovak",localizedName:"Slovenina"},sl:{englishName:"Slovenian",localizedName:"Slovenski"},sq:{englishName:"Albanian",localizedName:"shqip"},sr:{englishName:"Serbian (Cyrillic)",localizedName:"Srpski"},su:{englishName:"Sundanese",localizedName:" "},"sv-SE":{englishName:"Swedish",localizedName:"Svenska"},sw:{englishName:"Swahili",localizedName:"Kiswahili"},"sw-TZ":{englishName:"Swahili (Tanzania)",localizedName:"Kiswahili (Tanzania)"},ta:{englishName:"Tamil",localizedName:""},te:{englishName:"Telugu",localizedName:""},th:{englishName:"Thai",localizedName:""},tl:{englishName:"Tagalog",localizedName:" "},tr:{englishName:"Turkish",localizedName:"Trke"},uk:{englishName:"Ukrainian",localizedName:""},"ur-IN":{englishName:"Urdu (India)",localizedName:" ()"},"ur-PK":{englishName:"Urdu (Pakistan)",localizedName:" ()"},vi:{englishName:"Vietnamese",localizedName:"Ting vit"},"zh-CN":{englishName:"Chinese (Simplified)",localizedName:"()"},"zh-TW":{englishName:"Chinese (Traditional)",localizedName:"()"}},f.isLocaleEnabled=y,f.updateLocalizationAsync=function(e){let{targetId:r,baseUrl:i,force:t}=e,n=e.code;if((n="en-US"===(n=f.normalizeLanguageCode(n)[0])?"en":n)===f.userLanguage()||!y(n)&&!t)return pxt.debug(`loc: ${n} (using built-in)`),Promise.resolve();pxt.debug("loc: "+n);let s=pxt.Util.liveLocalizationEnabled();return w(r,i,n,s,a.pxtc.Util.TranslationsKind.Editor).then(e=>{var t;return e&&(f.setUserLanguage(n),null!=(t=pxt.analytics)&&t.addDefaultProperties({lang:n}),f.setLocalizedStrings(e)),a.pxtc.Util.downloadTranslationsAsync(r,i,n,s,a.pxtc.Util.TranslationsKind.Apis).then(e=>{e&&(a.pxtc.apiLocalizationStrings=e)})})};let c;function w(e,r,i,t,n){if(n=n||c.Editor,"en-US"===(i=f.normalizeLanguageCode(i)[0])||"en"===i)return Promise.resolve(void 0);let s=i+`/${t}/`+n;if(f.translationsCache()[s])return Promise.resolve(f.translationsCache()[s]);let a;switch(n){case c.Editor:a=[{staticName:"strings.json",path:"strings.json"},{staticName:"target-strings.json",path:e+"/target-strings.json"}];break;case c.Sim:a=[{staticName:"sim-strings.json",path:e+"/sim-strings.json"}];break;case c.Apis:a=[{staticName:"bundled-strings.json",path:e+"/bundled-strings.json"}];break;case c.SkillMap:a=[{staticName:"skillmap-strings.json",path:"/skillmap-strings.json"}]}let o;function l(t){t&&(o=o||{},Object.keys(t).filter(e=>!!t[e]).forEach(e=>o[e]=t[e]))}if(t){let t=0;return u.U.promiseMapAllSeries(a,e=>v(i,e.path).then(l,e=>{pxt.log(e.message),++t})).then(()=>(t&&(f.translationsCache()[s]=o),t!==a.length&&o?Promise.resolve(o):(pxt.tickEvent("translations.livetranslationsfailed"),w(e,r,i,!1,n))))}return Promise.all(a.map(e=>f.httpGetJsonAsync(r+`locales/${i}/`+e.staticName).catch(e=>{}))).then(e=>{let t={};e.forEach(e=>pxt.Util.jsonMergeFrom(t,e)),Object.keys(t).length&&(o=t,f.translationsCache()[s]=o)},e=>{pxt.error("failed to load localizations")}).then(()=>o)}function A(e){var t,r={};for(t of Object.keys(e))r[t]=k(e[t]);return r}function k(e){var t;return{attributes:Object.assign({},e.attributes),parameters:null==(t=e.parameters)?void 0:t.map(E),extendsTypes:e.extendsTypes?[...e.extendsTypes]:void 0,pkgs:e.pkgs?[...e.pkgs]:void 0,combinedProperties:e.combinedProperties?[...e.combinedProperties]:void 0,name:e.name,namespace:e.namespace,fileName:e.fileName,kind:e.kind,retType:e.retType,isInstance:e.isInstance,isContextual:e.isContextual,qName:e.qName,pkg:e.pkg,snippet:e.snippet,snippetName:e.snippetName,snippetWithMarkers:e.snippetWithMarkers,pySnippet:e.pySnippet,pySnippetName:e.pySnippetName,pySnippetWithMarkers:e.pySnippetWithMarkers,blockFields:e.blockFields,isReadOnly:e.isReadOnly,pyName:e.pyName,pyQName:e.pyQName,snippetAddsDefinitions:e.snippetAddsDefinitions}}function E(e){var t;return{name:e.name,description:e.description,type:e.type,pyTypeString:e.pyTypeString,initializer:e.initializer,default:e.default,properties:null==(t=e.properties)?void 0:t.map(x),handlerParameters:null==(t=e.handlerParameters)?void 0:t.map(x),options:e.options?u.U.clone(e.options):void 0,isEnum:e.isEnum}}function x(e){return{name:e.name,type:e.type}}function T(e){if(e){var t;for(t of[{label:"Google API Key",regex:/AIza[A-Za-z0-9_\\\-]{35}/},{label:"Slack Token",regex:/xox[pbar]\-[A-Za-z0-9]/},{label:"GitHub Token",regex:/(gh[psuro]_[a-zA-Z0-9]{36}|github_pat_[a-zA-Z0-9]{22}_[a-zA-Z0-9]{59})/},{label:"Generic Secret",regex:/\b(token|signature|password|passwd|pwd|android:value)[^a-zA-Z0-9]{0,200}/i},{label:"CLI Credentials",regex:/((login|psexec|(certutil|psexec)\.exe).{1,50}(\s-u(ser(name)?)?\s+.{3,100})?\s-(admin|user|vm|root)?p(ass(word)?)?\s+["']?[^$\-\/\s]|(^|[\s\r\n\\])net(\.exe)?.{1,5}(user\s+|share\s+\/user:| user -? secrets ? set) \s + [^ $\s \/])/},{label:"JWT Token",regex:/\beyJ[A-Za-z0-9_\-]+?\.[A-Za-z0-9_\-]+?\.[A-Za-z0-9_\-]+?\b/},{label:"Email",regex:/\b[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,63}\b/i}])if(t.regex.test(e))return`<REDACTED: ${t.label}>`}return e}(e=c=f.TranslationsKind||(f.TranslationsKind={}))[e.Editor=0]="Editor",e[e.Sim=1]="Sim",e[e.Apis=2]="Apis",e[e.SkillMap=3]="SkillMap",f.downloadTranslationsAsync=w,f.capitalize=function(e){return e&&e[0].toLocaleUpperCase()+e.slice(1)},f.uncapitalize=function(e){return(e||"").split(/(?=[A-Z])/g).join(" ").toLowerCase()},f.camelCaseToLowercaseWithSpaces=function(e){return e.replace(/([A-Z])/gm," $1").toLocaleLowerCase().trim()},f.snakeCaseToLowercaseWithSpaces=function(e){return e.replace(/_/g," ").toLocaleLowerCase().trim()},f.range=function(t){var r=[];for(let e=0;e<t;++e)r.push(e);return r},f.multipartPostAsync=function(e,r={},t=null,i=null){let n="--------------------------0461489f461126c5",s="";Object.keys(r).forEach(e=>{var t;t=r[e=e],s=(s+=n+"\r\n")+'Content-Disposition: form-data; name="'+e+'"\r\n\r\n'+t+"\r\n"}),t&&(i=i,a=(t=t).split("/").reverse()[0],s=(s=s+n+'\r\nContent-Disposition: form-data; name="files['+t+']"; filename="'+a+'"\r\n')+"\r\n"+i+"\r\n"),s+=n+"--\r\n";var a,t={url:e,method:"POST",headers:{"Content-Type":"multipart/form-data; boundary="+n.slice(2)},data:s};return f.httpRequestCoreAsync(t)},f.toDataUri=function(e,t){return/^https?:/i.test(e)||/^data:/i.test(e)?e:(t||/^<svg/i.test(e)&&(t="image/svg+xml"),/xml|svg/.test(t)?`data:${t},`+encodeURIComponent(e):`data:${t||"image/png"};base64,`+u.encodeBase64(m(e)))},f.imageMagic=1496611453,f.imageHeaderSize=36,f.encodeBlobAsync=function(t,e){var r=f.imageHeaderSize+e.length,i=3*(t.width*t.height-1);let n=1;for(;n<4&&!(i*n>=8*r);)n++;var s=i*n>>3,a=r-s;let o=0;var l=t.width*t.height*4;if(0<a){var c=3*t.width,a=(o=Math.ceil(a/c),document.createElement("canvas"));a.width=t.width,a.height=t.height+o;let e=a.getContext("2d");e.drawImage(t,0,0),t=a}function u(t,r,i,n){let s=0,a=0,o=n[a++];var l=(1<<i)-1;let c=!0;for(;c;){let e=o>>s&l;var u=8-s;if(u<=i){if(a>=n.length){if(0==u)break;c=!1}o=n[a++],e|=o<<u&l,s=i-u}else s+=i;t[r]=255&(t[r]&~l|e),3==(3&++r)&&(t[r++]=255)}return r}c=pxt.HF2.encodeU32LE([f.imageMagic,e.length,o,0,0,0,0,0,0]),pxt.Util.assert(c.length==f.imageHeaderSize);let d=t.getContext("2d");var h=d.getImageData(0,0,t.width,t.height);u(h.data,0,1,[n]);let p=4;for(p=u(h.data,p,n,c),pxt.Util.assert(0==(3&p)),p=0==o?u(h.data,p,n,e):(a=s-c.length,p=u(h.data,p,n,e.slice(0,a)),u(h.data,l,8,e.slice(a))),p|=3;p<h.data.length;)h.data[p]=255,p+=4;return d.putImageData(h,0,0),t},f.decodeBlobAsync=function(e){return pxt.BrowserUtils.loadCanvasAsync(e).then(e=>{let o=e.getContext("2d").getImageData(0,0,e.width,e.height).data;var t,r,i,n=1&o[0]|(1&o[1])<<1|(1&o[2])<<2;return 5<n||0==n?Promise.reject(new Error(f.lf("Invalid encoded PNG format"))):(t=s(4,n,i=new Uint8Array(pxt.Util.imageHeaderSize)),(i=pxt.HF2.decodeU32LE(i))[0]!=pxt.Util.imageMagic?Promise.reject(new Error(f.lf("Invalid magic in encoded PNG"))):(r=new Uint8Array(i[1]),0<(i=i[2])?(i=(e.height-i)*e.width,s(t,n,e=new Uint8Array((3*(i-1)*n>>3)-pxt.Util.imageHeaderSize)),r.set(e),s(4*i,8,i=new Uint8Array(r.length-e.length)),r.set(i,e.length)):s(t,n,r),r));function s(e,t,r){let i=0,n=0,s=0;for(var a=(1<<t)-1;n<r.length;)s|=(o[e++]&a)<<i,3==(3&e)&&e++,8<=(i+=t)&&(r[n++]=255&s,s>>=8,i-=8);return e}})},f.parseQueryString=function(e){let i={};return e.replace(/\+/g," ").replace(/([^#?&=]+)=([^#?&=]*)/g,(e,t,r)=>(i[decodeURIComponent(t)]=decodeURIComponent(r),"")),i},f.stringifyQueryString=function(e,t){for(var r of Object.keys(t))0<=e.indexOf("?")?e+="&":e+="?",e+=encodeURIComponent(r)+"="+encodeURIComponent(t[r]);return e},f.cloneTargetBundle=function(e){var t=(e=Object.assign({},e)).apiInfo,r=(delete e.apiInfo,e.bundleddirs),i=(delete e.bundleddirs,e.bundledpkgs),n=(delete e.bundledpkgs,e.tutorialInfo),s=(delete e.tutorialInfo,f.clone(e));if(t){s.apiInfo={};for(var a of Object.keys(t)){var o=t[a].apis;s.apiInfo[a]={sha:t[a].sha,apis:{jres:Object.assign({},o.jres),byQName:A(o.byQName)}}}}if(r&&(s.bundleddirs=[...r]),i){s.bundledpkgs={};for(var l of Object.keys(i))s.bundledpkgs[l]=Object.assign({},i[l])}if(n){s.tutorialInfo={};for(var c of Object.keys(n)){var u=n[c];s.tutorialInfo[c]={hash:u.hash,usedBlocks:Object.assign({},u.usedBlocks),snippetBlocks:Object.assign({},u.snippetBlocks),highlightBlocks:Object.assign({},u.highlightBlocks),validateBlocks:Object.assign({},u.validateBlocks)}}}return s},f.cloneApis=A,f.cloneSymbolInfo=k,f.toUTF8Array=function(e){return(new TextEncoder).encode(e)},f.fromUTF8Array=function(e){return(new TextDecoder).decode(e)},f.getHomeUrl=function(){let e,t,r,i=null==(e=pxt.webConfig)?void 0:e.relprefix.substr(0,pxt.webConfig.relprefix.length-3);return pxt.appTarget.appTheme.homeUrl&&i?((null==(t=pxt.appTarget.appTheme.homeUrl)?void 0:t.lastIndexOf("/"))===(null==(r=pxt.appTarget.appTheme.homeUrl)?void 0:r.length)-1&&(i=i.substr(1)),pxt.appTarget.appTheme.homeUrl+i):pxt.appTarget.appTheme.homeUrl},f.isExperienceSupported=function(e){var t=null==(t=null==(t=null==(t=pxt.appTarget)?void 0:t.appTheme)?void 0:t.supportedExperiences)?void 0:t.map(e=>e.toLocaleLowerCase()),e=e.toLocaleLowerCase();return null!=(t=null==t?void 0:t.includes(e))&&t},f.ocvEnabled=function(){var e;return(null==(e=null==(e=pxt.webConfig)?void 0:e.ocv)?void 0:e.appId)&&(null==(e=null==(e=pxt.webConfig)?void 0:e.ocv)?void 0:e.iframeEndpoint)},f.bresenhamLine=function(i,n,s,a,o){var e=s-i,l=a-n;if(0==e){var t=0<=l?a:n;for(let e=0<=l?n:a;e<=t;e++)o(i,e)}else{var c=0<e?1:-1,u=0<l?1:-1,d=Math.abs(l/e);let t=0,r=n;for(let e=i;0<c?e<=s:e>=s;e+=c)for(o(e,r),t+=d;.5<=t;)(0<u?r<=a:r>=a)&&o(e,r),r+=u,--t}},f.isFeatureEnabled=function(e){var t=null==(t=null==(t=pxt.appTarget.appTheme)?void 0:t.enabledFeatures)?void 0:t[e];if(!t)return!1;let r=!0,i=pxt.Cloud.getRegion()?pxt.Cloud.getRegion().toUpperCase():void 0;return r=(r=t.includeRegions?i&&t.includeRegions.some(e=>e.toUpperCase()==i):r)&&t.excludeRegions?i&&!t.excludeRegions.some(e=>e.toUpperCase()==i):r},f.cleanData=function(e){if(!e)return e;let t;if("string"==typeof e)t=T(e);else if("object"==typeof e){t={};for(var[r,i]of Object.entries(e))t[r]="string"==typeof i?T(i):i}else t=e;return t}}})(ts=ts||{}),(e=>{var y=e.pxtc||(e.pxtc={});{e=y.BrowserImpl||(y.BrowserImpl={});y.Util.httpRequestCoreAsync=function(l){return new Promise((e,t)=>{let r,i=!1,n=y.Util.clone(l.headers)||{};r=new XMLHttpRequest,l.responseArrayBuffer&&(r.responseType="arraybuffer"),l.withCredentials&&(r.withCredentials=!0),r.onreadystatechange=()=>{if(!i&&4==r.readyState){i=!0;let t={statusCode:r.status,headers:{},buffer:r.responseBody||r.response,text:l.responseArrayBuffer?void 0:r.responseText};r.getAllResponseHeaders().split(/\r?\n/).forEach(e=>{e=/^\s*([^:]+): (.*)/.exec(e);e&&(t.headers[e[1].toLowerCase()]=e[2])}),e(t)}};var s=l.data,a=l.method||(null==s?"GET":"POST");let o;null==s?o=null:s instanceof Uint8Array?o=s:"object"==typeof s?(o=JSON.stringify(s),n["content-type"]="application/json; charset=utf8"):"string"==typeof s?o=s:y.Util.oops("bad data"),r.open(a,l.url),Object.keys(n).forEach(e=>{r.setRequestHeader(e,n[e])}),null==o?r.send():r.send(o)})},y.Util.sha256=r,y.Util.getRandomBuf=t=>{if(window.crypto)window.crypto.getRandomValues(t);else for(let e=0;e<t.length;++e)t[e]=Math.floor(255*Math.random())};let v=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);function w(e,t){return e>>>t|e<<32-t}function t(e){let g=new Uint32Array(8),b=(g[0]=1779033703,g[1]=3144134277,g[2]=1013904242,g[3]=2773480762,g[4]=1359893119,g[5]=2600822924,g[6]=528734635,g[7]=1541459225,new Uint32Array(64));function t(r){var e=r.length-63;for(let t=0;t<e;t+=64){for(let e=0;e<16;e++){var i=(e<<2)+t;b[e]=r[i]<<24|r[i+1]<<16|r[i+2]<<8|r[i+3]}{c=void 0;u=void 0;d=void 0;h=void 0;p=void 0;f=void 0;m=void 0;var c=g;var u=b;y.Util.assert(8==c.length),y.Util.assert(64==u.length);for(let e=16;e<64;++e){var d=w(u[e-15],7)^w(u[e-15],18)^u[e-15]>>>3,h=w(u[e-2],17)^w(u[e-2],19)^u[e-2]>>>10;u[e]=u[e-16]+d+u[e-7]+h|0}let t=c[0],r=c[1],i=c[2],n=c[3],s=c[4],a=c[5],o=c[6],l=c[7];for(let e=0;e<64;++e){var p=w(s,6)^w(s,11)^w(s,25),f=s&a^~s&o,p=l+p+f+v[e]+u[e]|0,f=w(t,2)^w(t,13)^w(t,22),m=t&r^t&i^r&i;l=o,o=a,a=s,s=n+p|0,n=i,i=r,r=t,t=p+(f+m|0)|0}c[0]+=t,c[1]+=r,c[2]+=i,c[3]+=n,c[4]+=s,c[5]+=a,c[6]+=o,c[7]+=l}}}t(e);let r=64-(e.length+9)%64,i=(64==r&&(r=0),e.length-e.length%64);var n=new Uint8Array(e.length-i+1+r+8);let s=0;for(;i<e.length;)n[s++]=e[i++];for(n[s++]=128;0<r--;)n[s++]=0;let a=8*e.length;for(s=n.length;0<a;)n[--s]=255&a,a>>=8;t(n);let o="";for(let e=0;e<g.length;++e)o+=("000000000"+g[e].toString(16)).slice(-8);return o.toLowerCase()}function r(e){pxt.perf.measureStart(Measurements.Sha256Buffer);e=t(y.Util.toUTF8Array(e));return pxt.perf.measureEnd(Measurements.Sha256Buffer),e}e.sha256buffer=t,e.sha256string=r}})(ts=ts||{}),(e=>{var r=e.pxtc||(e.pxtc={});{e=r.jsonPatch||(r.jsonPatch={});let o={add:(e,t,r)=>{if("object"!=typeof e)throw new Error("jsonPatch: expected object type");if(t in e)throw new Error("jsonPatch: object already contains key "+t);e[t]=r},replace:(e,t,r)=>{if("object"!=typeof e)throw new Error("jsonPatch: expected object type");e[t]=r},remove:(e,t)=>{if("object"!=typeof e)throw new Error("jsonPatch: expected object type");delete e[t]}},l={add:(e,t,r)=>{if(!Array.isArray(e))throw new Error("jsonPatch: expected array type");if(t in e)throw new Error(`jsonPatch: key ${t} already exists in array`);"number"==typeof t&&t===Math.floor(t)?e.splice(t,0,r):e[t]=r},replace:(e,t,r)=>{if(!Array.isArray(e))throw new Error("jsonPatch: expected array type");"number"==typeof t&&t===Math.floor(t)?e.splice(t,1,r):e[t]=r},remove:(e,t)=>{if(!Array.isArray(e))throw new Error("jsonPatch: expected array type");"number"==typeof t&&t===Math.floor(t)?e.splice(t,1):delete e[t]}};e.diff=function(e,t){let l={add:[],remove:[],replace:[]};function c(e,t){return!Array.isArray(e)||(e=Number.parseFloat(t),Number.isNaN(e))?t:e}return function e(t,r,i){if(!Object.is(t,r)){r=r||{},t=t||{};for(var n of Object.keys(t))n in r||(n=c(t,n),l.remove.push({op:"remove",path:i.concat(n)}));for(var s of Object.keys(r)){var a=t[s],o=r[s];(s=c(r,s))in t?"object"!=typeof a&&"object"!=typeof o&&a!==o||typeof a!=typeof o||Array.isArray(a)!==Array.isArray(o)?l.replace.push({op:"replace",path:i.concat(s),value:o}):e(a,o,i.concat(s)):void 0!==r[s]&&(i.length&&l.add.push({op:"add",path:i,value:Array.isArray(r)?[]:{}}),l.add.push({op:"add",path:i.concat(s),value:o}))}}}(e,t,[]),[...l.remove.reverse(),...l.replace,...l.add.sort((e,t)=>e.path.length-t.path.length)]},e.patchInPlace=function(i,e){if(!i||"object"!=typeof i)throw new Error("jsonPatch: Must be an object or an array.");for(var n of e){var s=n.path.slice(),a=s.pop();if(null==a)throw new Error("jsonPatch: missing last key");let e=i,t=s.shift();for(;null!=t;){if(!(t in e))throw new Error("jsonPatch: missing parent element "+t);e=e[t],t=s.shift()}if(Array.isArray(e)&&"number"!=typeof a)throw new Error("jsonPatch: expected numeric index for array object");let r=Array.isArray(e)?l:o;"remove"===n.op?r.remove(e,a):"add"!==n.op||a in e?"replace"===n.op&&r.replace(e,a,n.value):r.add(e,a,n.value)}},e.opsAreEqual=function(e,t){return e.op===t.op&&r.U.arrayEquals(e.path,t.path)}}})(ts=ts||{}),(r=>{var i,e;i=r.pxtc||(r.pxtc={}),(e=(e=i.jsonPatch||(i.jsonPatch={})).tests||(e.tests={})).diffTests=function(){var e;for(e of[{comment:"test 1",obja:{a:4,b:5},objb:{a:3,b:5},expected:[{op:"replace",path:["a"],value:3}]},{comment:"test 2",obja:{a:3,b:5},objb:{a:4,c:5},expected:[{op:"remove",path:["b"]},{op:"replace",path:["a"],value:4},{op:"add",path:["c"],value:5}]},{comment:"test 3",obja:{a:4,b:[1,2,3]},objb:{a:3,b:[1,2,4]},expected:[{op:"replace",path:["a"],value:3},{op:"replace",path:["b",2],value:4}]},{comment:"test 4",obja:{a:3,b:[1,2,4]},objb:{a:3,b:[1,2,4,5]},expected:[{op:"add",path:["b"],value:[]},{op:"add",path:["b",3],value:5}]},{comment:"test 5",obja:{a:4,b:{c:3}},objb:{a:4,b:{c:4}},expected:[{op:"replace",path:["b","c"],value:4}]},{comment:"test 6",obja:{a:4,b:{c:4}},objb:{a:5,b:{d:4}},expected:[{op:"remove",path:["b","c"]},{op:"replace",path:["a"],value:5},{op:"add",path:["b"],value:{}},{op:"add",path:["b","d"],value:4}]},{comment:"test 7",obja:{a:4,b:[2,"foo"]},objb:{a:4,b:[2,"foo",["this","that"]]},expected:[{op:"add",path:["b"],value:[]},{op:"add",path:["b",2],value:["this","that"]}]}]){pxt.log(e.comment);var t=r.pxtc.jsonPatch.diff(e.obja,e.objb);i.U.deepEqual(t,e.expected)?pxt.log("succeeded"):(pxt.error("FAILED"),pxt.log("got",t),pxt.log("exp",e.expected))}},e.patchTests=function(){var e;for(e of[{comment:"test 1",obj:{a:"foo",b:[4,11]},patches:[{op:"remove",path:["b"]},{op:"replace",path:["a"],value:4},{op:"add",path:["c"],value:5}],expected:{a:4,c:5}},{comment:"test 2",obj:{a:4,b:[1,2,3]},patches:[{op:"replace",path:["a"],value:3},{op:"replace",path:["b",2],value:4},{op:"add",path:["b",3],value:9}],expected:{a:3,b:[1,2,4,9]}},{comment:"test 3",obj:{a:4,b:{c:3}},patches:[{op:"replace",path:["a"],value:5},{op:"remove",path:["b","c"]},{op:"add",path:["b","d"],value:4}],expected:{a:5,b:{d:4}}},{comment:"test 4",obj:{a:4},patches:[{op:"add",path:["b"],value:[]},{op:"add",path:["b",0],value:"foo"},{op:"add",path:["b",1],value:"bar"}],expected:{a:4,b:["foo","bar"]},validate:e=>e.b&&e.b.forEach}])pxt.log(e.comment),r.pxtc.jsonPatch.patchInPlace(e.obj,e.patches),!i.U.deepEqual(e.obj,e.expected)||!e.validate||e.validate(e.obj)?pxt.log("succeeded"):e.expected&&(pxt.error("FAILED"),pxt.log("got",e.obj),pxt.log("exp",e.expected))}})(ts=ts||{}),(e=>{e.perf||(e.perf={})})(pxt=pxt||{}),pxt.perf.isEnabled||(pxt.perf.isEnabled=()=>!1),pxt.perf.report||(pxt.perf.report=()=>{}),pxt.perf.recordMilestone||(pxt.perf.recordMilestone=()=>{}),pxt.perf.measureStart||(pxt.perf.measureStart=()=>{}),pxt.perf.measureEnd||(pxt.perf.measureEnd=()=>{}),(n=>{n.U=pxtc.Util,n.Util=pxtc.Util;let i,r={};n.setAppTarget=function(e){n.appTarget=e||{},c(),i=n.U.cloneTargetBundle(n.appTarget)};let o;function s(e,t){/^csv-/.test(e)?n.setAppTargetVariant(e.replace(/^csv-*/,"")):n.appTarget&&(r[e]=t,n.U.jsonCopyFrom(n.appTarget.compile.switches,r),n.U.jsonCopyFrom(i.compile.switches,r))}n.setBundledApiInfo=function(e){for(var t of Object.keys(e)){var r,i=e[t].apis.byQName;for(r of Object.keys(i)){var n=i[r],s=r.lastIndexOf("."),a=n.pyQName,s=i[r]={kind:Math.abs(n.kind||7),qName:r,namespace:r.slice(0,s<0?0:s),name:r.slice(s+1),pyQName:a,pyName:a?a.slice(a.lastIndexOf(".")+1):void 0,fileName:"",attributes:n.attributes||{},retType:n.retType||"void",parameters:n.parameters?n.parameters.map(e=>({name:e.name,description:e.description||"",type:e.type||"number",initializer:e.initializer,default:e.default,options:e.options||{},isEnum:!!e.isEnum,handlerParameters:e.handlerParameters})):null,extendsTypes:n.extendsTypes,snippet:n.kind&&n.kind<0?null:void 0,isInstance:!!n.isInstance,isReadOnly:!!n.isReadOnly},a=s.attributes;a.paramDefl||(a.paramDefl={}),a.callingConvention||(a.callingConvention=0),a.paramHelp||(a.paramHelp={}),a.jsDoc||(a.jsDoc=""),a._name=s.name.replace(/@.*/,"")}}o=e},n.getBundledApiInfo=function(){return o},n.savedAppTheme=function(){return i?i.appTheme:void 0},n.setCompileSwitch=s,n.setCompileSwitches=function(e){if(e)for(var t of e.split(/[\s,;:]+/))t&&("-"==t[0]?s(t.slice(1),!1):s(t,!0))};let a;function l(e,t,r){if(Array.isArray(e))return e.map(e=>l(e,t,r));if("object"!=typeof e)return"string"==typeof e&&t.test(e)?r(e):e;for(var i of Object.keys(e))e[i]=l(e[i],t,r);return e}function c(){let e=n.appTarget.compile;(e=e||(n.appTarget.compile={isNative:!1,hasHex:!1,switches:{}})).hasHex&&!e.nativeType&&(e.nativeType=pxtc.NATIVE_TYPE_THUMB),e.switches||(e.switches={}),e.nativeType==pxtc.NATIVE_TYPE_VM&&(e.sourceMap=!0),n.U.jsonCopyFrom(e.switches,r),e.jsRefCounting=!1,e.useUF2||e.useELF||null!=e.noSourceInFlash||(e.noSourceInFlash=!0),void 0===e.utf8&&(e.utf8=!0),n.appTarget.appTheme||(n.appTarget.appTheme={}),n.appTarget.appTheme.embedUrl||(n.appTarget.appTheme.embedUrl=n.appTarget.appTheme.homeUrl);var t=n.appTarget.compileService;if(t&&t.yottaTarget&&!t.yottaBinary&&(t.yottaBinary="pxt-microbit-app-combined.hex"),n.appTarget=l(n.appTarget,/^@cdnUrl@/i,e=>n.BrowserUtils.patchCdn(e)),n.appTarget.bundledpkgs&&Object.keys(n.appTarget.bundledpkgs).forEach(e=>{var e=n.appTarget.bundledpkgs[e],t=JSON.parse(e[n.CONFIG_NAME]);t.icon&&(t.icon=n.BrowserUtils.patchCdn(t.icon)),e[n.CONFIG_NAME]=n.Package.stringifyConfig(t)}),"undefined"!=typeof window){let t={"lockededitor=1":{appTheme:{lockedEditor:!0}},"hidemenu=1":{appTheme:{hideMenuBar:!0}}},r=(n.appTarget.queryVariants&&n.Util.jsonCopyFrom(t,n.appTarget.queryVariants),window.location.href);Object.keys(t).forEach(e=>{new RegExp(e,"i").exec(r)&&(e=t[e])&&n.U.jsonMergeFrom(n.appTarget,e)})}}function u(e=!1){n.perf.measureStart(Measurements.ReloadAppTargetVariant);var t,r=e?"":JSON.stringify(n.appTarget);n.appTarget=n.U.cloneTargetBundle(i),n.appTargetVariant&&((t=n.appTarget.variants&&n.appTarget.variants[n.appTargetVariant])?n.U.jsonMergeFrom(n.appTarget,t):n.U.userError(lf("Variant '{0}' not defined in pxtarget.json",n.appTargetVariant))),c(),!e&&n.onAppTargetChanged&&r!=JSON.stringify(n.appTarget)&&n.onAppTargetChanged(),n.perf.measureEnd(Measurements.ReloadAppTargetVariant)}function t(){return{relprefix:"/--",workerjs:"/worker.js",monacoworkerjs:"/monacoworker.js",gifworkerjs:"/gifjs/gif.worker.js",serviceworkerjs:"/serviceworker.js",typeScriptWorkerJs:"/tsworker.js",pxtVersion:"local",pxtRelId:"localRelId",pxtCdnUrl:"/cdn/",commitCdnUrl:"/cdn/",blobCdnUrl:"/blb/",cdnUrl:"/cdn/",targetUrl:"",targetVersion:"local",targetRelId:"",targetId:n.appTarget?n.appTarget.id:"",simUrl:"/sim/simulator.html",simserviceworkerUrl:"/simulatorserviceworker.js",simworkerconfigUrl:"/sim/workerConfig.js",partsUrl:"/sim/siminstructions.html"}}n.bundledSvg=function(t){if(t){var r=a&&a[t];if(r)return r;if(n.appTarget.simulator&&n.appTarget.simulator.dynamicBoardDefinition){a=a||{};r=n.appTarget.bundledpkgs[t];if(r){if(JSON.parse(r["pxt.json"]).core&&r["board.json"]){var i=JSON.parse(r["board.json"]);if(i&&i.visual&&i.visual.image){let e=i.visual.image;/^pkg:\/\//.test(e)&&(e=r[e.slice(6)]),a[t]="data:image/svg+xml;base64,"+ts.pxtc.encodeBase64(n.Util.toUTF8(e))}}return a[t]}}}},n.replaceStringsInJsonBlob=l,n.reloadAppTargetVariant=u,n.setAppTargetVariant=function(e,t={}){n.debug("app variant: "+e),(t.force||n.appTargetVariant!==e&&(n.appTargetVariant||e))&&(n.appTargetVariant=e,u(t.temporary))},n.setHwVariant=function(e,t){e=e.replace(/.*---/,""),/^[\w\-]+$/.test(e)?(n.hwVariant=e,n.hwName=t||e):(n.hwVariant=null,n.hwName=null),n.debug(`hwVariant: ${n.hwVariant} (${n.hwName})`)},n.hasHwVariants=function(){return!!n.appTarget.variants&&Object.keys(n.appTarget.bundledpkgs).some(e=>/^hw---/.test(e))},n.getHwVariants=function(){return n.appTarget.variants?Object.keys(n.appTarget.bundledpkgs).filter(e=>/^hw---/.test(e)).map(e=>JSON.parse(n.appTarget.bundledpkgs[e][n.CONFIG_NAME])).filter(e=>!!n.appTarget.appTheme.experimentalHw||!e.experimentalHw):[]},n.getActiveHwVariant=function(){return n.hwVariant},n.options={},n.reportException=function(e,t){if(n.error(e),t)try{n.error(t)}catch(e){}},n.reportError=function(e,t,r){if(n.error(e+": "+t),r)try{n.log(JSON.stringify(r,null,2))}catch(e){}},n.localWebConfig=t,n.getOnlineCdnUrl=function(){var e;return n.webConfig&&(e=/^(https:\/\/[^\/]+)/.exec(n.webConfig.commitCdnUrl))?e[1]:null},n.setupWebConfig=function(e){e?n.webConfig=e:n.webConfig||(n.webConfig=t())},n.getEmbeddedScript=function(e){return n.U.lookup(n.appTarget.bundledpkgs||{},e)};let e=void 0;function d(){return e=e||n.Cloud.downloadTargetConfigAsync().then(e=>e||{},e=>({}))}function h(e=null){return(e=e||n.appTarget.compile).nativeType==ts.pxtc.NATIVE_TYPE_VM?e.useESP?e.useUF2?ts.pxtc.BINARY_UF2:ts.pxtc.BINARY_ESP:ts.pxtc.BINARY_PXT64:e.useUF2&&!e.switches.rawELF?ts.pxtc.BINARY_UF2:e.useELF?ts.pxtc.BINARY_ELF:ts.pxtc.BINARY_HEX}n.targetConfigAsync=d,n.packagesConfigAsync=function(){return d().then(e=>e?e.packages:void 0)},n.CONFIG_NAME="pxt.json",n.SIMSTATE_JSON=".simstate.json",n.SERIAL_EDITOR_FILE="serial.txt",n.README_FILE="README.md",n.GITIGNORE_FILE=".gitignore",n.ASSETS_FILE="assets.json",n.CLOUD_ID="pxt/",n.BLOCKS_PROJECT_NAME="blocksprj",n.JAVASCRIPT_PROJECT_NAME="tsprj",n.PYTHON_PROJECT_NAME="pyprj",n.MAIN_BLOCKS="main.blocks",n.MAIN_TS="main.ts",n.MAIN_PY="main.py",n.DEFAULT_GROUP_NAME="other",n.TILEMAP_CODE="tilemap.g.ts",n.TILEMAP_JRES="tilemap.g.jres",n.IMAGES_CODE="images.g.ts",n.IMAGES_JRES="images.g.jres",n.TUTORIAL_CODE_START="_onCodeStart.ts",n.TUTORIAL_CODE_STOP="_onCodeStop.ts",n.TUTORIAL_INFO_FILE="tutorial-info-cache.json",n.TUTORIAL_CUSTOM_TS="tutorial.custom.ts",n.BREAKPOINT_TABLET=991,n.PALETTES_FILE="_palettes.json",n.HISTORY_FILE="_history",n.outputName=h,n.isOutputText=function(e=null){return h(e)==ts.pxtc.BINARY_HEX}})(pxt=pxt||{}),(a=>{{var v=a.blocks||(a.blocks={});let s="this";v.showBlockIdInTooltip=!1,v.requirePxtBlockly=()=>{},v.requireBlockly=()=>{},v.registerFieldEditor=()=>{},v.MATH_FUNCTIONS={unary:["sqrt","sin","cos","tan","asin","acos"],binary:["atan2"],infix:["idiv","imul"]},v.ROUNDING_FUNCTIONS=["round","ceil","floor","trunc"],v.builtinFunctionInfo={"Math.abs":{blockId:"math_op3",params:["x"]},"Math.min":{blockId:"math_op2",params:["x","y"]},"Math.max":{blockId:"math_op2",params:["x","y"]}},v.normalizeBlock=function(e,t=a.log){if(!e)return e;let r=e.replace(/(?:^|[^\\])([%$])\s+/g,"$1");return r!=e&&(t("block has extra spaces: "+e),e=r),(r=(e=r).replace(/([%$]\w+)\s*=\s*(\w+)/,"$1=$2"))!=e&&(t("block has space between %name and = : "+e),e=r),r=r.replace(/\s*\|\s*/g,"|")},v.compileInfo=function(o){let e,l={parameters:[],actualNameToParam:{},definitionNameToParam:{},handlerArgs:[]},t=!(1!=o.kind&&2!=o.kind||o.attributes.defaultInstance||o.isStatic),c=("boolean"!=typeof o.isInstance||null!=(e=o.attributes)&&e.defaultInstance||(t=o.isInstance),!!o.attributes._def),u=c?o.attributes._def.parameters.slice(0):void 0,d=c?u.length:o.parameters?o.parameters.length:0,h=v.builtinFunctionInfo[o.qName],p=(c&&o.attributes._expandedDef&&u.push(...o.attributes._expandedDef.parameters),{}),f=u?u.filter(e=>!e.ref||(p[e.name]=e,!1)):[];if(t&&c&&u.length){var r=p[s]||u[0],i=r.name,n=!r.shadowBlockId||"variables_get"===r.shadowBlockId;let e=o.attributes.paramDefl[i]||o.attributes.paramDefl.this;n&&(e=r.varName||e),l.thisParameter={actualName:s,definitionName:i,shadowBlockId:r.shadowBlockId,type:o.namespace,defaultValue:e,definitionIndex:u.indexOf(r),fieldEditor:m(i,s),fieldOptions:g(i,s),shadowOptions:b(i,s)}}if(o.parameters){let a=t&&!p[s]?1:0;o.parameters.forEach((t,r)=>{let i;if(p[t.name]?i=p[t.name]:a<f.length&&(i=f[a],++a),i||!c){let e=void 0;t.options&&t.options.min&&t.options.max&&(e={min:t.options.min.value,max:t.options.max.value});var n=i?i.name:h?h.params[a++]:t.name,s=i&&("variables_get"===i.shadowBlockId||"lists_create_with"==i.shadowBlockId);l.parameters.push({actualName:t.name,type:t.type,defaultValue:s&&i.varName||t.default,definitionName:n,definitionIndex:i?u.indexOf(i):r,shadowBlockId:i&&i.shadowBlockId,isOptional:!!u&&u.indexOf(i)>=d,fieldEditor:m(n,t.name),fieldOptions:g(n,t.name),shadowOptions:b(n,t.name),range:e})}t.handlerParameters&&t.handlerParameters.forEach(t=>{l.handlerArgs.push({name:t.name,type:t.type,inBlockDef:!!u&&u.some(e=>e.ref&&e.name===t.name),localizationKey:o.qName+"|handlerParam|"+t.name})})})}return l.parameters.forEach(e=>{l.actualNameToParam[e.actualName]=e,l.definitionNameToParam[e.definitionName]=e}),l;function m(e,t){return o.attributes.paramFieldEditor&&(o.attributes.paramFieldEditor[e]||o.attributes.paramFieldEditor[t])}function g(e,t){return o.attributes.paramFieldEditorOptions&&(o.attributes.paramFieldEditorOptions[e]||o.attributes.paramFieldEditorOptions[t])}function b(e,t){return o.attributes.paramShadowOptions&&(o.attributes.paramShadowOptions[e]||o.attributes.paramShadowOptions[t])}},v.hasHandler=function(e){return e.parameters&&e.parameters.some(e=>{var t;return"() => void"==e.type||"Action"==e.type||!(null==(t=e.properties)||!t.length)||!(null==(t=e.handlerParameters)||!t.length)})},v.getHelpUrl=function(e){if(e.attributes.help){var t=e.attributes.help.replace(/^\//,"");if(/^github:/.test(t))return t;if("none"!==t)return"/reference/"+t}else if(e.pkg&&!a.appTarget.bundledpkgs[e.pkg])return(t=e.qName.toLowerCase().split("."))[0]==e.pkg&&t.shift(),`/pkg/${e.pkg}#`+encodeURIComponent(t.join("-"))},v.reporterTypeForArgType=function(e){let t="boolean"!==e&&"number"!==e&&"string"!==e?"argument_reporter_custom":"argument_reporter_"+e;return t=/^(?:Array<(?:.+)>)|(?:(?:.+)\[\])$/.test(e)?"argument_reporter_array":t},v.defaultIconForArgType=function(e=""){switch(e){case"number":return"calculator";case"string":return"text width";case"boolean":return"random";case"Array":return"list";default:return"align justify"}},v.parseFields=function(e){return e.split("|").map((e,t)=>{var r=/([^%]*)\s*%([a-zA-Z0-9_]+)/.exec(e);if(!r)return{n:e,ni:t};let i=r[1];return{n:e,ni:t,pre:i=i&&i.trim(),p:r[2]}})};let n;function t(){if((n={device_while:{name:a.Util.lf("a loop that repeats while the condition is true"),tooltip:a.Util.lf("Run the same sequence of actions while the condition is met."),url:"/blocks/loops/while",category:"loops",block:{message0:a.Util.lf("while %1"),appendField:a.Util.lf("{id:while}do")}},pxt_controls_for:{name:a.Util.lf("a loop that repeats the number of times you say"),tooltip:a.Util.lf("Have the variable '{0}' take on the values from 0 to the end number, counting by 1, and do the specified blocks."),url:"/blocks/loops/for",category:"loops",block:{message0:a.Util.lf("for %1 from 0 to %2"),variable:a.Util.lf("{id:var}index"),appendField:a.Util.lf("{id:for}do")}},controls_simple_for:{name:a.Util.lf("a loop that repeats the number of times you say"),tooltip:a.Util.lf("Have the variable '{0}' take on the values from 0 to the end number, counting by 1, and do the specified blocks."),url:"/blocks/loops/for",category:"loops",block:{message0:a.Util.lf("for %1 from 0 to %2"),variable:a.Util.lf("{id:var}index"),appendField:a.Util.lf("{id:for}do")}},pxt_controls_for_of:{name:a.Util.lf("a loop that repeats for each value in an array"),tooltip:a.Util.lf("Have the variable '{0}' take the value of each item in the array one by one, and do the specified blocks."),url:"/blocks/loops/for-of",category:"loops",block:{message0:a.Util.lf("for element %1 of %2"),variable:a.Util.lf("{id:var}value"),appendField:a.Util.lf("{id:for_of}do")}},controls_for_of:{name:a.Util.lf("a loop that repeats for each value in an array"),tooltip:a.Util.lf("Have the variable '{0}' take the value of each item in the array one by one, and do the specified blocks."),url:"/blocks/loops/for-of",category:"loops",block:{message0:a.Util.lf("for element %1 of %2"),variable:a.Util.lf("{id:var}value"),appendField:a.Util.lf("{id:for_of}do")}},math_op2:{name:a.Util.lf("minimum or maximum of 2 numbers"),tooltip:{min:a.Util.lf("smaller value of 2 numbers"),max:a.Util.lf("larger value of 2 numbers")},url:"/blocks/math",operators:{op:["min","max"]},category:"math"},math_op3:{name:a.Util.lf("absolute number"),tooltip:a.Util.lf("absolute value of a number"),url:"/reference/math",category:"math",block:{message0:a.Util.lf("absolute of %1")}},math_number:{name:a.Util.lf("{id:block}number"),url:"/types/number",category:"math",tooltip:a.appTarget&&a.appTarget.compile?a.Util.lf("a decimal number"):a.Util.lf("an integer number")},math_integer:{name:a.Util.lf("{id:block}number"),url:"/types/number",category:"math",tooltip:a.Util.lf("an integer number")},math_whole_number:{name:a.Util.lf("{id:block}number"),url:"/types/number",category:"math",tooltip:a.Util.lf("a whole number")},math_number_minmax:{name:a.Util.lf("{id:block}number"),url:"/blocks/math",category:"math"},math_arithmetic:{name:a.Util.lf("arithmetic operation"),url:"/blocks/math",tooltip:{ADD:a.Util.lf("Return the sum of the two numbers."),MINUS:a.Util.lf("Return the difference of the two numbers."),MULTIPLY:a.Util.lf("Return the product of the two numbers."),DIVIDE:a.Util.lf("Return the quotient of the two numbers."),POWER:a.Util.lf("Return the first number raised to the power of the second number.")},operators:{OP:["ADD","MINUS","MULTIPLY","DIVIDE","POWER"]},category:"math",block:{MATH_ADDITION_SYMBOL:a.Util.lf("{id:op}+"),MATH_SUBTRACTION_SYMBOL:a.Util.lf("{id:op}-"),MATH_MULTIPLICATION_SYMBOL:a.Util.lf("{id:op}"),MATH_DIVISION_SYMBOL:a.Util.lf("{id:op}/"),MATH_POWER_SYMBOL:a.Util.lf("{id:op}**")}},math_modulo:{name:a.Util.lf("division remainder"),tooltip:a.Util.lf("Return the remainder from dividing the two numbers."),url:"/blocks/math",category:"math",block:{MATH_MODULO_TITLE:a.Util.lf("remainder of %1 / %2")}},math_js_op:{name:a.Util.lf("math function"),tooltip:{sqrt:a.Util.lf("Returns the square root of the argument"),sin:a.Util.lf("Returns the sine of the argument"),cos:a.Util.lf("Returns the cosine of the argument"),acos:a.Util.lf("Returns the arccosine of the argument"),asine:a.Util.lf("Returns the arcsine of the argument"),tan:a.Util.lf("Returns the tangent of the argument"),atan2:a.Util.lf("Returns the arctangent of the quotient of the two arguments"),idiv:a.Util.lf("Returns the integer portion of the division operation on the two arguments"),imul:a.Util.lf("Returns the integer portion of the multiplication operation on the two arguments")},url:"/blocks/math",operators:{OP:["sqrt","sin","cos","tan","atan2","idiv","imul"]},category:"math",block:{sqrt:a.Util.lf("{id:op}square root"),sin:a.Util.lf("{id:op}sin"),cos:a.Util.lf("{id:op}cos"),asin:a.Util.lf("{id:op}asin"),acos:a.Util.lf("{id:op}acos"),tan:a.Util.lf("{id:op}tan"),atan2:a.Util.lf("{id:op}atan2"),idiv:a.Util.lf("{id:op}integer /"),imul:a.Util.lf("{id:op}integer ")}},math_js_round:{name:a.Util.lf("rounding functions"),tooltip:{round:a.Util.lf("Increases the argument to the next higher whole number if its fractional part is more than one half"),ceil:a.Util.lf("Increases the argument to the next higher whole number"),floor:a.Util.lf("Decreases the argument to the next lower whole number"),trunc:a.Util.lf("Removes the fractional part of the argument")},url:"/blocks/math",operators:{OP:["round","ceil","floor","trunc"]},category:"math",block:{round:a.Util.lf("{id:op}round"),ceil:a.Util.lf("{id:op}ceiling"),floor:a.Util.lf("{id:op}floor"),trunc:a.Util.lf("{id:op}truncate")}},variables_change:{name:a.Util.lf("update the value of a number variable"),tooltip:a.Util.lf("Changes the value of the variable by this amount"),url:"/blocks/variables/change",category:"variables",block:{message0:a.Util.lf("change %1 by %2")}},controls_repeat_ext:{name:a.Util.lf("a loop that repeats and increments an index"),tooltip:a.Util.lf("Do some statements several times."),url:"/blocks/loops/repeat",category:"loops",block:{CONTROLS_REPEAT_TITLE:a.Util.lf("repeat %1 times"),CONTROLS_REPEAT_INPUT_DO:a.Util.lf("{id:repeat}do")}},variables_get:{name:a.Util.lf("get the value of a variable"),tooltip:a.Util.lf("Returns the value of this variable."),url:"/blocks/variables",category:"variables",block:{VARIABLES_GET_CREATE_SET:a.Util.lf("Create 'set %1'")}},variables_get_reporter:{name:a.Util.lf("get the value of a variable"),tooltip:a.Util.lf("Returns the value of this variable."),url:"/blocks/variables",category:"variables",block:{VARIABLES_GET_CREATE_SET:a.Util.lf("Create 'set %1'")}},variables_set:{name:a.Util.lf("assign the value of a variable"),tooltip:a.Util.lf("Sets this variable to be equal to the input."),url:"/blocks/variables/assign",category:"variables",block:{VARIABLES_SET:a.Util.lf("set %1 to %2")}},controls_if:{name:a.Util.lf("a conditional statement"),tooltip:{CONTROLS_IF_TOOLTIP_1:a.Util.lf("If a value is true, then do some statements."),CONTROLS_IF_TOOLTIP_2:a.Util.lf("If a value is true, then do the first block of statements. Otherwise, do the second block of statements."),CONTROLS_IF_TOOLTIP_3:a.Util.lf("If the first value is true, then do the first block of statements. Otherwise, if the second value is true, do the second block of statements."),CONTROLS_IF_TOOLTIP_4:a.Util.lf("If the first value is true, then do the first block of statements. Otherwise, if the second value is true, do the second block of statements. If none of the values are true, do the last block of statements.")},tooltipSearch:"CONTROLS_IF_TOOLTIP_2",url:"/blocks/logic/if",category:"logic",block:{CONTROLS_IF_MSG_IF:a.Util.lf("{id:logic}if"),CONTROLS_IF_MSG_THEN:a.Util.lf("{id:logic}then"),CONTROLS_IF_MSG_ELSE:a.Util.lf("{id:logic}else"),CONTROLS_IF_MSG_ELSEIF:a.Util.lf("{id:logic}else if")}},lists_create_with:{name:a.Util.lf("create an array"),tooltip:a.Util.lf("Creates a new array."),url:"/reference/arrays/create",category:"arrays",blockTextSearch:"LISTS_CREATE_WITH_INPUT_WITH",block:{LISTS_CREATE_EMPTY_TITLE:a.Util.lf("empty array"),LISTS_CREATE_WITH_INPUT_WITH:a.Util.lf("array of"),LISTS_CREATE_WITH_CONTAINER_TITLE_ADD:a.Util.lf("array"),LISTS_CREATE_WITH_ITEM_TITLE:a.Util.lf("value")}},lists_length:{name:a.Util.lf("array length"),tooltip:a.Util.lf("Returns the number of items in an array."),url:"/reference/arrays/length",category:"arrays",block:{LISTS_LENGTH_TITLE:a.Util.lf("length of array %1")}},lists_index_get:{name:a.Util.lf("get a value in an array"),tooltip:a.Util.lf("Returns the value at the given index in an array."),url:"/reference/arrays/get",category:"arrays",block:{message0:a.Util.lf("%1 get value at %2")}},lists_index_set:{name:a.Util.lf("set a value in an array"),tooltip:a.Util.lf("Sets the value at the given index in an array"),url:"/reference/arrays/set",category:"arrays",block:{message0:a.Util.lf("%1 set value at %2 to %3")}},logic_compare:{name:a.Util.lf("comparing two numbers"),tooltip:{LOGIC_COMPARE_TOOLTIP_EQ:a.Util.lf("Return true if both inputs equal each other."),LOGIC_COMPARE_TOOLTIP_NEQ:a.Util.lf("Return true if both inputs are not equal to each other."),LOGIC_COMPARE_TOOLTIP_LT:a.Util.lf("Return true if the first input is smaller than the second input."),LOGIC_COMPARE_TOOLTIP_LTE:a.Util.lf("Return true if the first input is smaller than or equal to the second input."),LOGIC_COMPARE_TOOLTIP_GT:a.Util.lf("Return true if the first input is greater than the second input."),LOGIC_COMPARE_TOOLTIP_GTE:a.Util.lf("Return true if the first input is greater than or equal to the second input.")},url:"/blocks/logic/boolean",category:"logic",block:{search:"=  <  > "}},logic_operation:{name:a.Util.lf("boolean operation"),tooltip:{LOGIC_OPERATION_TOOLTIP_AND:a.Util.lf("Return true if both inputs are true."),LOGIC_OPERATION_TOOLTIP_OR:a.Util.lf("Return true if at least one of the inputs is true.")},url:"/blocks/logic/boolean",category:"logic",block:{LOGIC_OPERATION_AND:a.Util.lf("{id:op}and"),LOGIC_OPERATION_OR:a.Util.lf("{id:op}or")}},logic_negate:{name:a.Util.lf("logical negation"),tooltip:a.Util.lf("Returns true if the input is false. Returns false if the input is true."),url:"/blocks/logic/boolean",category:"logic",block:{LOGIC_NEGATE_TITLE:a.Util.lf("not %1")}},logic_boolean:{name:a.Util.lf("a `true` or `false` value"),tooltip:a.Util.lf("Returns either true or false."),url:"/blocks/logic/boolean",category:"logic",block:{LOGIC_BOOLEAN_TRUE:a.Util.lf("{id:boolean}true"),LOGIC_BOOLEAN_FALSE:a.Util.lf("{id:boolean}false")}},text:{name:a.Util.lf("a piece of text"),tooltip:a.Util.lf("A letter, word, or line of text."),url:"/types/string",category:"text",block:{search:a.Util.lf("a piece of text")}},text_length:{name:a.Util.lf("number of characters in the string"),tooltip:a.Util.lf("Returns the number of letters (including spaces) in the provided text."),url:"/reference/text/length",category:"text",block:{TEXT_LENGTH_TITLE:a.Util.lf("length of %1")}},text_join:{name:a.Util.lf("join items to create text"),tooltip:a.Util.lf("Create a piece of text by joining together any number of items."),url:"/reference/text/join",category:"text",block:{TEXT_JOIN_TITLE_CREATEWITH:a.Util.lf("join")}},procedures_defnoreturn:{name:a.Util.lf("define the function"),tooltip:a.Util.lf("Create a function."),url:"/types/function/define",category:"functions",block:{PROCEDURES_DEFNORETURN_TITLE:a.Util.lf("function"),PROCEDURE_ALREADY_EXISTS:a.Util.lf("A function named '%1' already exists.")}},procedures_callnoreturn:{name:a.Util.lf("call the function"),tooltip:a.Util.lf("Call the user-defined function."),url:"/types/function/call",category:"functions",block:{PROCEDURES_CALLNORETURN_TITLE:a.Util.lf("call function")}},function_return:{name:a.Util.lf("return a value from within a function"),tooltip:a.Util.lf("Return a value from within a user-defined function."),url:"/types/function/return",category:"functions",block:{message_with_value:a.Util.lf("return %1"),message_no_value:a.Util.lf("return")}},function_definition:{name:a.Util.lf("define the function"),tooltip:a.Util.lf("Create a function."),url:"/types/function/define",category:"functions",block:{FUNCTIONS_EDIT_OPTION:a.Util.lf("Edit Function")}},function_call:{name:a.Util.lf("call the function"),tooltip:a.Util.lf("Call the user-defined function."),url:"/types/function/call",category:"functions",block:{FUNCTIONS_CALL_TITLE:a.Util.lf("call"),FUNCTIONS_GO_TO_DEFINITION_OPTION:a.Util.lf("Go to Definition")}},function_call_output:{name:a.Util.lf("call the function with a return value"),tooltip:a.Util.lf("Call the user-defined function with a return value."),url:"/types/function/call",category:"functions",block:{}}})[pxtc.ON_START_TYPE]={name:a.Util.lf("on start event"),tooltip:a.Util.lf("Run code when the program starts"),url:"/blocks/on-start",category:"loops",block:{message0:a.Util.lf("on start %1 %2")}},n[pxtc.PAUSE_UNTIL_TYPE]={name:a.Util.lf("pause until"),tooltip:a.Util.lf("Pause execution of code until the given boolean expression is true"),url:"/blocks/pause-until",category:"loops",block:{message0:a.Util.lf("pause until %1")}},n[pxtc.TS_BREAK_TYPE]={name:a.Util.lf("break"),tooltip:a.Util.lf("Break out of the current loop or switch"),url:"/blocks/loops/break",category:"loops",block:{message0:a.Util.lf("break")}},n[pxtc.TS_CONTINUE_TYPE]={name:a.Util.lf("continue"),tooltip:a.Util.lf("Skip current iteration and continues with the next iteration in the loop"),url:"/blocks/loops/continue",category:"loops",block:{message0:a.Util.lf("continue")}},a.blocks.showBlockIdInTooltip)for(var e of Object.keys(n)){var t=n[e].tooltip;if("object"==typeof t&&null!==t)for(var r in t)t.hasOwnProperty(r)&&(n[e].tooltip[r]=`${t[r]} (id: ${e})`);else n[e].tooltip=`${n[e].tooltip} (id: ${e})`}}v.blockDefinitions=function(){return n||t(),n},v.getBlockDefinition=function(e){return n||t(),n[e]},v.initInContextTranslationAsync=async function(){n||t();let i={};return await Promise.all(a.Util.values(n).filter(e=>e.block).map(async r=>{var e=Object.keys(r.block);r.translationIds=a.Util.values(r.block),await Promise.all(e.map(async e=>{var t=await a.crowdin.inContextLoadAsync(r.block[e]);r.block[e]=t,/^[A-Z_]+$/.test(e)&&(i[e]=t)}))})),i}}})(pxt=pxt||{}),(u=>{{var o=u.BrowserUtils||(u.BrowserUtils={});function s(){return"undefined"!=typeof navigator}function e(){return s()&&/(Win32|Win64|WOW64)/i.test(navigator.platform)}function l(){return s()&&/mobi/i.test(navigator.userAgent)}function c(){return s()&&/Mac/i.test(navigator.platform)}function d(){return!!navigator&&/Linux/i.test(navigator.platform)}function h(){return s()&&/arm/i.test(navigator.platform)}function p(){return s()&&/Edge/i.test(navigator.userAgent)}function f(){return s()&&/Trident/i.test(navigator.userAgent)}function m(){return!p()&&!f()&&!!navigator&&(/Chrome/i.test(navigator.userAgent)||/Chromium/i.test(navigator.userAgent))}function g(){return!m()&&!p()&&!!navigator&&/(Macintosh|Safari|iPod|iPhone|iPad)/i.test(navigator.userAgent)}function b(){return!g()&&!!navigator&&(/Firefox/i.test(navigator.userAgent)||/Seamonkey/i.test(navigator.userAgent))}function v(){return s()&&/Opera|OPR/i.test(navigator.userAgent)}function y(){return s()&&/Midori/i.test(navigator.userAgent)}function w(){return s()&&/Epiphany/i.test(navigator.userAgent)}function A(){return"undefined"!=typeof window&&("ontouchstart"in window||navigator&&0<navigator.maxTouchPoints)}function k(){return"undefined"!=typeof window&&!!window.pxtElectron}function E(){return"undefined"!=typeof window&&!!window.ipcRenderer}function x(){return k()||E()}function T(e){var t;try{return"undefined"!=typeof window&&/^https?:\/\/(?:localhost|127\.0\.0\.1|192\.168\.\d{1,3}\.\d{1,3}|[a-zA-Z0-9.-]+\.local):\d+\/?/.test(window.location.href)&&(e||!/nolocalhost=1/.test(window.location.href))&&!(null!=(t=null==u?void 0:u.webConfig)&&t.isStatic)}catch(e){return!1}}function S(){return"undefined"!=typeof window&&!!window.PointerEvent}function C(){return e()?"windows":c()?"mac":d()&&h()?"rpi":d()?"linux":"unknown"}function I(){return p()?"edge":w()?"epiphany":y()?"midori":v()?"opera":f()?"ie":m()?"chrome":g()?"safari":b()?"firefox":"unknown"}function _(){if(!s())return null;let e=[];return v()&&(e=/(Opera|OPR)\/([0-9\.]+)/i.exec(navigator.userAgent)),(e=w()?/Epiphany\/([0-9\.]+)/i.exec(navigator.userAgent):y()?/Midori\/([0-9\.]+)/i.exec(navigator.userAgent):g()?(e=/Version\/([0-9\.]+)/i.exec(navigator.userAgent))||/(Macintosh|iPod( touch)?|iPhone|iPad); (CPU|Intel).*?OS (X )?(\d+)/i.exec(navigator.userAgent):(m()?/(Chrome|Chromium)\/([0-9\.]+)/i:p()?/Edge\/([0-9\.]+)/i:f()?/(MSIE |rv:)([0-9\.]+)/i:/(Firefox|Seamonkey)\/([0-9\.]+)/i).exec(navigator.userAgent))&&0!=e.length?e[e.length-1]:null}o.isDocumentVisible=function(){return"undefined"!=typeof window&&"visible"===document.visibilityState},o.isIFrame=function(){try{return window&&window.self!==window.top}catch(e){return!0}},o.hasNavigator=s,o.hasWindow=function(){return"undefined"!=typeof window},o.isWindows=e,o.isWindows10=function(){return s()&&/(Win32|Win64|WOW64)/i.test(navigator.platform)&&/Windows NT 10/i.test(navigator.userAgent)},o.isMobile=l,o.isIOS=function(){return s()&&(/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&1<navigator.maxTouchPoints)},o.isAndroid=function(){return s()&&/android/i.test(navigator.userAgent)},o.isMac=c,o.isLinux=d,o.isARM=h,o.isEdge=p,o.isChromiumEdge=function(){return s()&&/Edg\//i.test(navigator.userAgent)},o.isIE=f,o.isChrome=m,o.isSafari=g,o.isFirefox=b,o.isOpera=v,o.isMidori=y,o.isEpiphany=w,o.isTouchEnabled=A,o.isPxtElectron=k,o.isIpcRenderer=E,o.isElectron=x,o.isWinRT=()=>"undefined"!=typeof Windows,o.isLocalHost=T,o.isLocalHostDev=function(){return T()&&!x()},o.isSkillmapEditor=function(){try{return/skill(?:s?)map=1/i.test(window.location.href)}catch(e){return!1}},o.isTabletSize=function(){return(null==window?void 0:window.innerWidth)<=u.BREAKPOINT_TABLET},o.isComputerSize=function(){return(null==window?void 0:window.innerWidth)>u.BREAKPOINT_TABLET},o.isInGame=function(){return!!/inGame=1/i.exec(window.location.href)},o.hasFileAccess=function(){var e=u.appTarget.appTheme.disableFileAccessinMaciOs&&(u.BrowserUtils.isMac()||u.BrowserUtils.isIOS()),t=u.appTarget.appTheme.disableFileAccessinAndroid&&u.BrowserUtils.isAndroid();return!e&&!t},o.noSharedLocalStorage=function(){try{return/nosharedlocalstorage/i.test(window.location.href)}catch(e){return!1}},o.useOldTutorialLayout=function(){var e;if(null!=(e=null==(e=u.appTarget)?void 0:e.appTheme)&&e.legacyTutorial)return!0;try{return/tutorialview=old/.test(window.location.href)}catch(e){return!1}},o.hasPointerEvents=S,o.os=C,o.browser=I,o.browserVersion=_;let a=!1;function $(){return l()&&g()&&!/downloadWindowOpen=0/i.test(window.location.href)}function U(t,e,r){var i=$(),n=_(),s=parseInt(n||"0");if(i)r?r.location.href=t:window.open(t,"_self");else if(u.BrowserUtils.isSafari()&&(s<10||0==n.indexOf("10.0")||l())){let e=document.getElementById("downloader");e||(u.debug("injecting downloader iframe"),(e=document.createElement("iframe")).id="downloader",e.style.position="absolute",e.style.right="0",e.style.bottom="0",e.style.zIndex="-1",e.style.width="1px",e.style.height="1px",document.body.appendChild(e)),e.src=t}else/^data:/i.test(t)&&(u.BrowserUtils.isEdge()||u.BrowserUtils.isIE())?(i=atob(t.split(",")[1]),r=u.Util.stringToUint8Array(i),s=new Blob([r],{type:"img/png"}),window.navigator.msSaveOrOpenBlob(s,e)):"string"==typeof(n=window.document.createElement("a")).download?(n.href=t,n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n)):document.location.href=t}function V(e,t){let r="data";l()&&g()&&u.appTarget.appTheme.mobileSafariDownloadProtocol&&(r=u.appTarget.appTheme.mobileSafariDownloadProtocol);var i=/downloadProtocol=([a-z0-9:/?]+)/i.exec(window.location.href);return(r=i?i[1]:r)+":"+t+";base64,"+e}function P(e,t,r={}){u.debug("trigger download");var i,{contentType:r="application/octet-stream",userContextWindow:n,onError:s,maintainObjectURL:a}=r,o=null==(o=window.URL)?void 0:o.createObjectURL,l=u.appTarget.appTheme.disableBlobObjectDownload;let c;try{o&&!l?(U(i=o(new Blob([u.Util.stringToUint8Array(atob(e))],{type:r})),t,n),a?c=i:window.setTimeout(()=>window.URL.revokeObjectURL(c),0)):U(c=V(e,t),t,n)}catch(e){s&&s(e),u.debug("saving failed")}return c}function q(r){let i=document.createElement("img");return new Promise((e,t)=>{i.onload=()=>e(i),i.onerror=()=>e(void 0),i.crossOrigin="anonymous",i.src=r})}function N(e){return/^https?:\/\//i.test(e)?e:(window.MonacoPaths||{})[e]||(u.U.startsWith(e,u.webConfig.commitCdnUrl)?e:u.webConfig.commitCdnUrl+e)}o.isBrowserSupported=function(){var e,t,r,i,n,s;return!navigator||!!/bot|crawler|spider|crawling/i.test(navigator.userAgent)||(null==(e=(null==(e=u.appTarget)?void 0:e.unsupportedBrowsers)||(null==(e=window.pxtTargetBundle)?void 0:e.unsupportedBrowsers))||!e.some(e=>e.id==I()))&&(e=_(),i=parseInt(e||"0"),s=m()&&38<=i,n=b()&&31<=i,t=p(),r=g()&&9<=i,i=v()&&m()&&21<=i,s=s||n||t||r||i,n=y()||d()&&h()&&w(),s=(s=s&&!n)||/anybrowser=(true|1)/.test(window.location.href),a||(u.log(`Browser: ${I()} ${e} on `+C()),s||u.tickEvent("browser.unsupported",{useragent:navigator.userAgent}),a=!0),s)},o.devicePixelRatio=function(){var e,t;return"undefined"!=typeof window&&window.screen?(e=window.screen.systemXDPI,t=window.screen.logicalXDPI,void 0!==e&&void 0!==t&&t<e?e/t:window&&void 0!==window.devicePixelRatio?window.devicePixelRatio:1):1},o.browserDownloadBinText=function(e,t,r){return P(ts.pxtc.encodeBase64(e),t,r)},o.browserDownloadText=function(e,t,r){return P(ts.pxtc.encodeBase64(u.Util.toUTF8(e)),t,r)},o.isBrowserDownloadInSameWindow=$,o.isBrowserDownloadWithinUserContext=function(){var e=_(),e=parseInt(e||"0");return l()&&g()&&11<=e||/downloadUserContext=1/i.test(window.location.href)},o.browserDownloadDataUri=U,o.browserDownloadUInt8Array=function(e,t,r){return P(ts.pxtc.encodeBase64(u.Util.uint8ArrayToString(e)),t,r)},o.toDownloadDataUri=V,o.browserDownloadBase64=P,o.loadImageAsync=q,o.loadCanvasAsync=function(e){return q(e).then(e=>{var t=document.createElement("canvas");return t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),t})},o.scaleImageData=function(e,t){var r=document.createElement("canvas"),i=document.createElement("canvas"),n=(r.width=e.width,r.height=e.height,i.width=e.width*t,i.height=e.height*t,r.getContext("2d")),i=i.getContext("2d");return n.putImageData(e,0,0),i.imageSmoothingEnabled=!1,i.scale(t,t),i.drawImage(r,0,0),i.getImageData(0,0,e.width*t,e.height*t)},o.imageDataToPNG=function(e,t=1){var r,i,n,s;if(e)return r=document.createElement("canvas"),i=document.createElement("canvas"),r.width=e.width,r.height=e.height,i.width=e.width*t,i.height=e.height*t,n=r.getContext("2d"),s=i.getContext("2d"),n.putImageData(e,0,0),s.imageSmoothingEnabled=!1,s.scale(t,t),s.drawImage(r,0,0),i.toDataURL("image/png")},o.encodeToPngAsync=function(r,e){let{width:s,height:a,pixelDensity:o=4,maxSize:l=1e7,text:c}=e||{};return new Promise((i,e)=>{let n=new Image;n.onload=function(){let t=document.createElement("canvas");var e=t.getContext("2d");t.width=(s||n.width)*o,t.height=(a||n.height)*o,c&&(e.fillStyle="#fff",e.fillRect(0,0,t.width,t.height)),e.drawImage(n,0,0,s,a,0,0,t.width,t.height);let r=t.toDataURL("image/png");for(;r.length>l;)t.width=t.width/2>>0,t.height=t.height/2>>0,u.debug(`screenshot size ${r.length}b, shrinking to ${t.width}x`+t.height),e.drawImage(n,0,0,s,a,0,0,t.width,t.height),r=t.toDataURL("image/png");c?u.lzmaCompressAsync(c).then(e=>{e=u.Util.encodeBlobAsync(t,e);i(e.toDataURL("image/png"))}):i(r)},n.onerror=e=>{u.reportError("png","png rendering failed"),i(void 0)};try{var t=new URL(r);"http:"!==t.protocol&&"https:"!==t.protocol||t.host===window.location.host||n.setAttribute("crossOrigin","anonymous")}catch(e){}n.src=r})},o.resolveCdnUrl=N,o.loadStyleAsync=function(e,t){let i="style-"+(e=t?"rtl"+e:e);if(document.getElementById(i))return Promise.resolve();let n=N(e);return(t=u.Util.toArray(document.head.getElementsByTagName("link")).filter(e=>e.getAttribute("href")==n)[0])?(t.id||(t.id=i),Promise.resolve()):new Promise((e,t)=>{var r=document.createElement("link");r.href=n,r.rel="stylesheet",r.type="text/css",r.id=i,r.addEventListener("load",()=>e()),r.addEventListener("error",e=>t(e)),document.head.appendChild(r)})};let n={};o.loadScriptAsync=function(e){let i=N(e),t=n[i];return t=t||(n[i]=new Promise((e,t)=>{u.debug("script: loading "+i);var r=document.createElement("script");r.type="text/javascript",r.addEventListener("load",()=>e()),r.addEventListener("error",e=>{delete n[i],t(e)}),r.src=i,r.async=!0,document.body.appendChild(r)}))},o.loadAjaxAsync=function(i){return new Promise((e,t)=>{let r=new XMLHttpRequest;r.onreadystatechange=function(){r.readyState==XMLHttpRequest.DONE&&(200==r.status?e(r.responseText):t(r.status))},r.open("GET",i,!0),r.send()})};let t;function H(e,t){return e?t?(e.indexOf("/")==e.length-1?e.substring(0,e.length-1):e)+"/"+(0==t.indexOf("/")?t.substring(1):t):e:t}function z(){var e=s()&&window.navigator;return e&&e.storage&&e.storage.estimate?e.storage.estimate():Promise.resolve({})}o.loadBlocklyAsync=function(){if(!t){u.debug("blockly: delay load");let e=u.BrowserUtils.loadStyleAsync("blockly.css",ts.pxtc.Util.isUserLanguageRtl());e=e.then(()=>{u.debug("blockly: loaded")}),t=e}return t},o.patchCdn=function(e){var t;return e&&((t=u.getOnlineCdnUrl())?e.replace("@cdnUrl@",t):e.replace(/@cdnUrl@\/(blob|commit)\/[a-f0-9]{40}\//,"./"))},o.initTheme=function(){var e,t,r=u.appTarget.appTheme;r&&r.accentColor&&((e=document.createElement("style")).type="text/css",e.appendChild(document.createTextNode(`.ui.accent { color: ${r.accentColor}; }
                .ui.inverted.menu .accent.active.item, .ui.inverted.accent.menu  { background-color: ${r.accentColor}; }`)),document.getElementsByTagName("head")[0].appendChild(e)),u.Util.isUserLanguageRtl()&&(u.debug("rtl layout"),u.BrowserUtils.addClass(document.body,"rtl"),document.body.style.direction="rtl",(e=(r=u.Util.toArray(document.head.getElementsByTagName("link"))).filter(e=>u.Util.endsWith(e.getAttribute("href"),"semantic.css"))[0])&&(t=e.getAttribute("data-rtl"))&&(u.debug("swapping to "+t),e.setAttribute("href",t)),e=r.filter(e=>u.Util.endsWith(e.getAttribute("href"),"blockly.css"))[0])&&(t=e.getAttribute("data-rtl"))&&(u.debug("swapping to "+t),e.setAttribute("href",t),e.removeAttribute("data-rtl"))},o.changeHash=function(e,t){"#"!=e.charAt(0)&&(e="#"+e),t?window.location.hash=e:window.history.replaceState("","",e)},o.urlJoin=H,o.joinURLs=function(...t){let r;if(t)for(let e=0;e<t.length;e++)r=H(r,t[e]);return r},o.storageEstimateAsync=z,o.scheduleStorageCleanup=s()&&navigator.storage&&navigator.storage.estimate?ts.pxtc.Util.throttle(function(){z().then(e=>(u.debug(`storage estimate: ${e.usage/e.quota*100>>0}%, ${e.usage/1e6>>0}/${e.quota/1e6>>0}Mb`),e.quota&&e.usage&&1e6<e.quota&&.9<e.usage/e.quota?(u.log("quota usage exceeded, clearing translations"),u.tickEvent("storage.cleanup"),O()):Promise.resolve())).catch(e=>{u.reportException(e)})},1e4,!1):()=>{},o.stressTranslationsAsync=function t(){let r="...";for(let e=0;e<16;++e)r+=r+Math.random();return u.log(`adding entry ${2*r.length} bytes`),u.U.delay(1).then(()=>G()).then(e=>e.setAsync("foobar",Math.random().toString(),null,void 0,r)).then(()=>u.BrowserUtils.storageEstimateAsync()).then(e=>!e.quota||e.usage/e.quota<.8?t():Promise.resolve())};class M{constructor(){this.translations={}}key(e,t){return e+`|${t}|master`}get(e,t){return this.translations[this.key(e,t)]}getAsync(e,t){return Promise.resolve(this.get(e,t))}set(e,t,r,i,n,s){this.translations[this.key(e,t)]={etag:r,time:i,strings:n,md:s}}setAsync(e,t,r,i,n){return this.set(e,t,r,u.Util.now(),i),Promise.resolve()}clearAsync(){return this.translations={},Promise.resolve()}}class D{constructor(e,t,r,i,n=!1){this.name=e,this.version=t,this.upgradeHandler=r,this.quotaExceededHandler=i,this.skipErrorLog=n}throwIfNotOpened(){if(!this._db)throw new Error("Database not opened; call IDBWrapper.openAsync() first")}errorHandler(e,t,r){this.skipErrorLog?r(e):(u.error(new Error(this.name+` IDBWrapper error for ${t}: `+e.message)),r(e),"QuotaExceededError"==e.name&&(u.log("storage quota exceeded..."),u.tickEvent("storage.quotaexceedederror"),this.quotaExceededHandler)&&this.quotaExceededHandler())}getObjectStore(e,t="readonly"){return this.throwIfNotOpened(),this._db.transaction([e],t).objectStore(e)}static deleteDatabaseAsync(i){return new Promise((e,t)=>{let r=(window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB).deleteDatabase(i);r.onsuccess=()=>e(),r.onerror=()=>t(r.error)})}openAsync(){return new Promise((e,t)=>{let r=(window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB).open(this.name,this.version);r.onsuccess=()=>{this._db=r.result,e()},r.onerror=()=>this.errorHandler(r.error,"open",t),r.onupgradeneeded=e=>this.upgradeHandler(e,r)})}getAsync(i,n){return new Promise((e,t)=>{let r=this.getObjectStore(i).get(n);r.onsuccess=()=>e(r.result),r.onerror=()=>this.errorHandler(r.error,"get",t)})}getAllAsync(n){return new Promise((e,t)=>{let r=this.getObjectStore(n).openCursor(),i=[];r.onsuccess=()=>{r.result?(i.push(r.result.value),r.result.continue()):e(i)},r.onerror=()=>this.errorHandler(r.error,"getAll",t)})}setAsync(n,s){return new Promise((e,t)=>{var r=this.getObjectStore(n,"readwrite");let i;(i=null!=s.id?r.put(s):r.add(s)).onsuccess=()=>e(),i.onerror=()=>this.errorHandler(i.error,"set",t)})}deleteAsync(i,n){return new Promise((e,t)=>{let r=this.getObjectStore(i,"readwrite").delete(n);r.onsuccess=()=>e(),r.onerror=()=>this.errorHandler(r.error,"delete",t)})}deleteAllAsync(i){return new Promise((e,t)=>{let r=this.getObjectStore(i,"readwrite").clear();r.onsuccess=()=>e(),r.onerror=()=>this.errorHandler(r.error,"deleteAll",t)})}getObjectStoreWrapper(e){return new F(this,e)}}o.IDBWrapper=D;class F{constructor(e,t){this.db=e,this.storeName=t}getAsync(e){return this.db.getAsync(this.storeName,e)}getAllAsync(){return this.db.getAllAsync(this.storeName)}setAsync(e){return this.db.setAsync(this.storeName,e)}async deleteAsync(e){await this.db.deleteAsync(this.storeName,e)}async deleteAllAsync(){await this.db.deleteAllAsync(this.storeName)}}o.IDBObjectStoreWrapper=F;class B{constructor(e){this.db=e,this.mem=new M}static dbName(){return"__pxt_translations_"+(u.appTarget.id||"")}static createAsync(){function t(){let e=new D(B.dbName(),2,(e,t)=>{t.result.createObjectStore(B.TABLE,{keyPath:B.KEYPATH})},()=>{O().catch(e=>{})});return e.openAsync().then(()=>new B(e))}return t().catch(e=>(u.log("db: failed to open database, try delete entire store..."),D.deleteDatabaseAsync(B.dbName()).then(()=>t())))}getAsync(t,r){t=(t||"en-US").toLowerCase();var e=this.mem.key(t,r),i=this.mem.get(t,r);return i?Promise.resolve(i):this.db.getAsync(B.TABLE,e).then(e=>e?(this.mem.set(t,r,e.etag,e.time,e.strings),Promise.resolve(e)):Promise.resolve(void 0)).catch(e=>Promise.resolve(void 0))}setAsync(e,t,r,i,n){e=(e||"en-US").toLowerCase();var s=this.mem.key(e,t),a=u.Util.now(),e=(this.mem.set(e,t,r,a,i,n),i&&Object.keys(i).filter(e=>!i[e]).forEach(e=>delete i[e]),{id:s,etag:r,time:a,strings:i,md:n});return this.db.setAsync(B.TABLE,e).finally(()=>o.scheduleStorageCleanup()).catch(e=>(u.log(`db: set failed (${e.message}), recycling...`),this.clearAsync()))}clearAsync(){return this.db.deleteAllAsync(B.TABLE).then(()=>u.debug("db: all clean")).catch(e=>{u.error("db: failed to delete all")})}}B.TABLE="files",B.KEYPATH="id";let r;function G(){return u.Util.isNodeJS?Promise.resolve(new M):r=r||B.createAsync().catch(()=>new M)}function O(){function t(){let t=B.dbName();return D.deleteDatabaseAsync(t).then(()=>{r=void 0}).catch(e=>{u.log("db: failed to delete "+t),r=void 0})}return r?r.then(e=>e.clearAsync()).catch(e=>t().then()):t()}function R(e){e=JSON.stringify(e)+u.appTarget.versions.pxt+"_"+u.appTarget.versions.target;return pxtc.U.sha256(e)}function W(e,t){return e+"|"+(t||"master")}o.translationDbAsync=G,o.clearTranslationDbAsync=O,o.getTutorialCodeHash=R;class j{constructor(e){this.db=e}static dbName(){return"__pxt_tutorialinfo_"+(u.appTarget.id||"")}static createAsync(){function t(){let e=new u.BrowserUtils.IDBWrapper(j.dbName(),2,(e,t)=>{t.result.createObjectStore(j.TABLE,{keyPath:j.KEYPATH})},()=>{u.BrowserUtils.IDBWrapper.deleteDatabaseAsync(j.dbName())});return e.openAsync().then(()=>new j(e))}return t().catch(e=>(u.log("db: failed to open tutorial info database, try delete entire store..."),u.BrowserUtils.IDBWrapper.deleteDatabaseAsync(j.dbName()).then(()=>t())))}getAsync(e,t,r){let i=W(e,r),n=R(t);return this.db.getAsync(j.TABLE,i).then(e=>{if(e&&e.hash==n&&u.Util.now()-(e.time||0)<864e5)return e;this.db.deleteAsync(j.TABLE,i)})}setAsync(e,t,r,i,n,s){u.perf.measureStart(Measurements.TutorialInfoDbSetAsync);r=R(r);return this.setWithHashAsync(e,t,r,i,n)}setWithHashAsync(e,r,t,i,n,s){u.perf.measureStart(Measurements.TutorialInfoDbSetAsync);e=W(e,s);let a={};Object.keys(r).forEach(t=>{Object.keys(r[t]).forEach(e=>{a[e]=r[t][e]})});s={id:e,time:u.Util.now(),hash:t,snippets:r,blocks:a,highlightBlocks:i,validateBlocks:n};return this.db.setAsync(j.TABLE,s).then(()=>{u.perf.measureEnd(Measurements.TutorialInfoDbSetAsync)})}clearAsync(){return this.db.deleteAllAsync(j.TABLE).then(()=>u.debug("db: all clean")).catch(e=>{u.error("db: failed to delete all")})}}j.TABLE="info",j.KEYPATH="id";let i;function L(e){return e.split(/\s+/).filter(e=>!!e)}function J(){var e=new RegExp(u.Util.escapeForRegex(u.Util.pxtLangCookieId)+"=(.*?)(?:;|$)").exec(document.cookie);return e&&e[1]||null}o.tutorialInfoDbAsync=function(){return i=i||j.createAsync()},o.clearTutorialInfoDbAsync=function(){function t(){let t=j.dbName();return D.deleteDatabaseAsync(t).then(()=>{i=void 0}).catch(e=>{u.log("db: failed to delete "+t),i=void 0})}return i?i.then(e=>e.clearAsync()).catch(e=>t().then()):t()},o.pointerEvents=S()?{up:"pointerup",down:["pointerdown"],move:"pointermove",enter:"pointerenter",leave:"pointerleave"}:A()?{up:"mouseup",down:["mousedown","touchstart"],move:"touchmove",enter:"touchenter",leave:"touchend"}:{up:"mouseup",down:["mousedown"],move:"mousemove",enter:"mouseenter",leave:"mouseleave"},o.getPageX=function(e){return("pageX"in e?e:e.changedTouches[0]).pageX},o.getPageY=function(e){return("pageY"in e?e:e.changedTouches[0]).pageY},o.getClientX=function(e){return("clientX"in e?e:e.changedTouches[0]).clientX},o.getClientY=function(e){return("clientY"in e?e:e.changedTouches[0]).clientY},o.popupWindow=function(e,t,r,i){try{var n=window.screenLeft||window.screenX,s=window.screenTop||window.screenY,a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,o="width="+r+", height="+i+", top="+((window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight)/2-i/2+s)+", left="+(a/2-r/2+n),l=window.open(e,t,u.BrowserUtils.isIpcRenderer()?void 0:o);return l.focus&&l.focus(),l}catch(e){return u.tickEvent("pxt.popupError",{msg:e.message}),null}},o.containsClass=function(r,e){return L(e).every(e=>{return e=e,(t=r).classList?t.classList.contains(e):!((t.className+"").split(/\s+/).indexOf(e)<0);var t})},o.addClass=function(r,e){L(e).forEach(e=>{var t;e=e,(t=r).classList?t.classList.add(e):(t.className+"").split(/\s+/).indexOf(e)<0&&(t.className.baseVal+=" "+e)})},o.removeClass=function(r,e){L(e).forEach(e=>{var t;t=e,(e=r).classList?e.classList.remove(t):e.className.baseVal=(e.className+"").split(/\s+/).filter(e=>e!=t).join(" ")})},o.getCookieLang=J,o.setCookieLang=function(e,t=!1){u.Util.allLanguages[e]&&e!==J()&&(u.tickEvent("menu.lang.setcookielang",{lang:e,docs:""+t}),(t=new Date).setTime(t.getTime()+24*u.Util.langCookieExpirationDays*60*60*1e3),document.cookie=`${u.Util.pxtLangCookieId}=${e}; expires=${t.toUTCString()}; path=/`)},o.cacheBustingUrl=function(e){return e&&(/[?&]rnd=/.test(e)?e:`${e}${0<e.indexOf("?")?"&":"?"}rnd=`+Math.random())},o.appendUrlQueryParams=function(e,t){var r,i,n=[];for([r,i]of t.entries())n.push(encodeURIComponent(r)+"="+encodeURIComponent(i));return n.length&&(-1!==e.indexOf("?")?e+="&"+n.join("&"):e+="?"+n.join("&")),e},o.legacyCopyText=function(e){e.focus(),e.setSelectionRange(0,9999);try{var t=document.execCommand("copy");return u.debug("copy: "+t),!!t}catch(e){return!1}},o.setApplicationTheme=function(e){var t=document.body,r=t.classList;for(let e=0;e<r.length;e++)/^theme-/.test(r[e])&&t.classList.remove(r[e]);e&&t.classList.add("theme-"+e)},o.isElement=function(e){return e.nodeType===Node.ELEMENT_NODE}}})(pxt=pxt||{}),(t=>{{var r=t.cloud||(t.cloud={});let e="https://staging.pxt.io";r.DEV_BACKEND=e,r.DEV_REGION="US",r.devBackendType=function(){return"https://makecode.com"===r.DEV_BACKEND?"prod":r.DEV_BACKEND===e?"staging":"http://localhost:8080"===r.DEV_BACKEND?"localhost":"prod"},r.cloudStatus={none:{value:"none"},synced:{value:"synced",icon:"cloud-saved-b",tooltip:lf("Project saved to cloud"),shortStatus:lf("saved"),longStatus:lf("Saved to cloud"),indicator:""},justSynced:{value:"justSynced",icon:"cloud-saved-b",tooltip:lf("Project saved to cloud"),shortStatus:lf("saved!"),longStatus:lf("Saved to cloud!"),indicator:""},offline:{value:"offline",icon:"cloud-error-b",tooltip:lf("Unable to connect to cloud"),shortStatus:lf("offline"),longStatus:lf("Offline"),indicator:lf("offline")},syncing:{value:"syncing",icon:"cloud-saving-b",tooltip:lf("Saving project to cloud..."),shortStatus:lf("saving..."),longStatus:lf("Saving to cloud..."),indicator:lf("syncing...")},conflict:{value:"conflict",icon:"cloud-error-b",tooltip:lf("Project was edited in two places and the changes conflict"),shortStatus:lf("conflict!"),longStatus:lf("Project has a conflict!"),indicator:"!"},localEdits:{value:"localEdits",icon:"cloud-saving-b",tooltip:lf("Project has local changes and will save to cloud soon."),shortStatus:"",longStatus:"",indicator:"*"}}}})(pxt=pxt||{}),(e=>{var r;(e=(r=e.commands||(e.commands={})).WebUSBPairResult||(r.WebUSBPairResult={}))[e.Failed=0]="Failed",e[e.Success=1]="Success",e[e.UserRejected=2]="UserRejected",r.deployCoreAsync=void 0,r.deployFallbackAsync=void 0,r.hasDeployFn=()=>r.deployCoreAsync||r.deployFallbackAsync,r.deployAsync=(e,t)=>(r.deployCoreAsync||r.deployFallbackAsync)(e,t),r.patchCompileResultAsync=void 0,r.browserDownloadAsync=void 0,r.saveOnlyAsync=void 0,r.renderBrowserDownloadInstructions=void 0,r.renderUsbPairDialog=void 0,r.renderIncompatibleHardwareDialog=void 0,r.showUploadInstructionsAsync=void 0,r.saveProjectAsync=void 0,r.electronDeployAsync=void 0,r.electronFileDeployAsync=void 0,r.webUsbPairDialogAsync=void 0,r.onTutorialCompleted=void 0,r.perfMeasurementThresholdMs=void 0,r.onPerfMilestone=void 0,r.onPerfMeasurement=void 0,r.workspaceLoadedAsync=void 0,r.getDownloadMenuItems=void 0,r.notifyProjectCompiled=void 0,r.notifyProjectSaved=void 0,r.onDownloadButtonClick=void 0,r.getDefaultProjectName=void 0,r.onMarkdownActivityLoad=void 0})(pxt=pxt||{}),(u=>{function r(e){var e=u.toolbox.convertColor(e),t=parseInt(e.slice(1,3),16)/255,r=parseInt(e.slice(3,5),16)/255,e=parseInt(e.slice(5,7),16)/255;return.2126*(t<=.03928?t/12.92:Math.pow((.055+t)/1.055,2.4))+.7152*(r<=.03928?r/12.92:Math.pow((.055+r)/1.055,2.4))+.0722*(e<=.03928?e/12.92:Math.pow((.055+e)/1.055,2.4))}function n(e,t){return(r(e)+.05)/(r(t)+.05)}function o(e){return("0"+e.toString(16)).slice(-2)}u.getWhiteContrastingBackground=function(t){if(!(4.5<=n("#ffffff",t))){var r=(e=>{let t=u.toolbox.convertColor(e),r=parseInt(t.slice(1,3),16)/255,i=parseInt(t.slice(3,5),16)/255,n=parseInt(t.slice(5,7),16)/255,s=Math.max(Math.max(r,i),n),a=Math.min(Math.min(r,i),n),o=s-a,l;0==o?l=0:s===r?l=((i-n)/o%6+6)%6:s===i?l=(n-r)/o+2:s===n&&(l=(r-i)/o+4);var e=(a+s)/2,c=0==o?0:o/(1-Math.abs(2*e-1));return{h:60*l,s:c,l:e}})(t);let e=r.l-.05;for(;0<e;){var i=(e=>{let t=(1-Math.abs(2*e.l-1))*e.s,r=e.h/60,i=t*(1-Math.abs(r%2-1)),n;void 0===e.h?n=[0,0,0]:r<=1?n=[t,i,0]:r<=2?n=[i,t,0]:r<=3?n=[0,t,i]:r<=4?n=[0,i,t]:r<=5?n=[i,0,t]:r<=6&&(n=[t,0,i]),e=e.l-.5*t;var s=Math.round(255*(n[0]+e)),a=Math.round(255*(n[1]+e)),e=Math.round(255*(n[2]+e));return"#"+o(s)+o(a)+o(e)})({h:r.h,s:r.s,l:e});if(4.5<=n("#ffffff",i))return i;e-=.05}u.warn("Couldn't find a contrasting background for color "+t)}return t},u.contrastRatio=n})(pxt=pxt||{}),(e=>{e.TutorialInfoDbSetAsync="tutorial info db setAsync",e.ReloadAppTargetVariant="reloadAppTargetVariant",e.Sha256Buffer="sha256buffer",e.WebworkerRecvHandler="webworker recvHandler",e.NetworkRequest="network.request"})(Measurements=Measurements||{}),(n=>{function e(){let e;return e||(e=n.U.isNodeJS?Promise.resolve(require("lzma")):Promise.resolve(window.LZMA)).then(e=>(e||n.reportError("lzma","failed to load"),e)),e}n.lzmaDecompressAsync=function(i){return e().then(t=>new Promise((r,e)=>{try{t.decompress(i,(e,t)=>{t&&n.debug("lzma decompression failed"),r(t?void 0:e)})}catch(e){e&&n.debug("lzma decompression failed"),r(void 0)}}))},n.lzmaCompressAsync=function(i){return e().then(t=>new Promise((r,e)=>{try{t.compress(i,7,(e,t)=>{t&&n.reportException(t),r(t?void 0:new Uint8Array(e))})}catch(e){n.reportException(e),r(void 0)}}))}})(pxt=pxt||{}),(Ae=>{{var e=Ae.cpp||(Ae.cpp={}),ke=pxtc.Util;let ve=ke.lf,ye={"pxt::mkAction":1,"pxt::dumpPerfCounters":1,"pxt::deepSleep":1,"pxt::getConfig":1,"pxtrt::mkMap":1,"pxtrt::mapSet":1,"pxtrt::stclo":1,"pxtrt::mklocRef":1,"pxtrt::stlocRef":1,"pxtrt::ldlocRef":1,"pxtrt::panic":1};function Ee(r="namespace"){let i="",n="",e=(e,t="")=>{n!=e&&(n&&(i+="}\n"),e&&(i+=t||r+" "+e+" {\n"),n=e)},t="    ";return{setNs:e,clear:()=>{i="",n=""},write:e=>{e.trim()?(e=e.trim().replace(/^\s*/gm,t).replace(/^(\s*)\*/gm,(e,t)=>t+" *"),i+=e+"\n"):i+="\n"},incrIndent:()=>{t+="    "},decrIndent:()=>{t=t.slice(4)},finish:()=>(e(""),i)}}function xe(e){if(!e)return null;e=e.trim();var t=/^\((.*)\)/.exec(e);return t&&(e=t[1]),/^-?(\d+|0[xX][0-9a-fA-F]+)$/.test(e)?parseInt(e):null}e.nsWriter=Ee,e.parseCppInt=xe;let we={};class Te extends Error{constructor(e){super(e),this.isUserError=!0,this.message=e}}function l(t){if(!t)return"";let r="";for(let e=0;e<t.length;++e){var i=255&t[e];r+=37==i||127<i?"%"+i.toString(16):String.fromCharCode(i)}return decodeURIComponent(r)}function c(e){let t="",r=0;for(;r<e.length;r+=2)t=e[r]+e[r+1]+t;return Ae.Util.assert(r==e.length),t}function s(r){var i=[65,20,14,47,184,47,162,187];e:for(let t=0;t<r.length;t+=16)if(r[t]==i[0]){for(let e=0;e<i.length;++e)if(r[t+e]!=i[e])continue e;var e,n=r[t+8]|r[t+9]<<8,s=r[t+10]|r[t+11]<<8|r[t+12]<<16|r[t+13]<<24,s=(t+=16)+n+s;if(!(r.length<s))return e=r.slice(t,t+n),n=r.slice(t+n,s),{meta:l(e),text:n}}return null}function a(e){if(e){let r=0,i=0,n=0,s,a=0;if(e.split(/\r?\n/).forEach(e=>{var t=/^:10....0[0E]41140E2FB82FA2BB(....)(....)(....)(....)(..)/.exec(e);if(t)r=parseInt(c(t[1]),16),i=parseInt(c(t[2]),16),n=r+i,s=new Uint8Array(n);else if(0<n&&(t=/^:10....0[0E](.*)(..)$/.exec(e))){let e=t[1];for(;0<n&&0<e.length;)s[a++]=parseInt(e[0]+e[1],16),e=e.slice(2),n--}}),s&&0==n&&a==s.length){var t=new Uint8Array(r),o=new Uint8Array(i);for(let e=0;e<r;++e)t[e]=s[e];for(let e=0;e<i;++e)o[e]=s[r+e];return{meta:l(t),text:o}}}}function t(e){function t(e){return Ae.debug(e),Promise.reject(new Error(e))}let r;var i;if(Ae.HF2.read32(e,0)==ts.pxtc.UF2.UF2_MAGIC_START0&&(i=ts.pxtc.UF2.toBin(e))&&(r=s(i.buf)),1179403647==Ae.HF2.read32(e,0)&&(r=s(e)),58==e[0]&&(i=l(e),r=a(i||"")),!r||!r.meta||!r.text)return t("This .hex file doesn't contain source.");let n=JSON.parse(r.meta);return n?"LZMA"==n.compression?Ae.lzmaDecompressAsync(r.text).then(e=>{var t;return e?(t=e.slice(0,n.headerSize||n.metaSize||0),e=e.slice(t.length),t&&Ae.Util.jsonCopyFrom(n,JSON.parse(t)),{meta:n,source:e}):null}):n.compression?t(`Compression type ${n.compression} not supported.`):Promise.resolve({source:l(r.text)}):t("This .hex file is not valid.")}e.PkgConflictError=Te,e.getExtensionInfo=function(M){var D={__appVariant:Ae.appTargetVariant||""},F="dal.d.ts";let r="/source/",e="";var t,B=[];for(t of M.sortedDeps(!0).sort((e,t)=>"this"==e.id?1:"this"==t.id?-1:ke.strcmp(e.id,t.id)))t.disablesVariant(Ae.appTargetVariant)||t.resolvedDependencies().some(e=>e.disablesVariant(Ae.appTargetVariant))?(e&&(e+=", "),e+=t.id,Ae.debug(`disable variant ${Ae.appTargetVariant} due to `+t.id)):(B.push(t),t.addSnapshot(D,[F,".h",".cpp"]));var j=JSON.stringify(D),i=we[j];if(i)return Ae.debug("Using cached extinfo"),(i=ke.flatClone(i)).disabledDeps=e,i;Ae.debug("Generating new extinfo");let m=pxtc.emptyExtInfo(),n=(m.disabledDeps=e,Ae.appTarget.compileService),s=(n=n||{gittag:"none",serviceId:"nocompile"},n=ke.clone(n),M.getTargetOptions()),$=(s=s||{isNative:!1,hasHex:!1,switches:{}},i=!!n.platformioIni,"codal"==n.buildEngine||"dockercodal"==n.buildEngine);var a,V,o,l,c="dockermake"==n.buildEngine||"dockercross"==n.buildEngine,u="dockerespidf"==n.buildEngine;let g=!(i||$||c||u),q=s.nativeType==pxtc.NATIVE_TYPE_VM,H=(i?r="/src/":$||c?r="/pxtapp/":u&&(r="/main/"),"// Configuration defines\n"),b="\nPXT_SHIMS_BEGIN\n",v="",z="",G=`#include "pxt.h"
`,W="",y=e=>W+=`   ${Y}(${J}): ${e}
`,J=0,Y="",w=Ee("namespace"),A=Ee("declare namespace"),k=Ee("declare namespace"),K="",X={},Q={},Z={true:"1",false:"0",null:"0",NULL:"0"};function E(e){return e.trim().replace(/[\_\*]$/,"")}for(a of B){0<=a.getFiles().indexOf(F)&&(V=a.host().readFile(a,F),Ae.Util.assert(!!V,F+" not found in "+a.id),V.split(/\r?\n/).forEach(e=>{e=/^\s*(\w+) = (.*),/.exec(e);e&&(Z[e[1]]=e[2])}));for(o of a.getFiles())(0<=["Makefile","sdkconfig.defaults","CMakeLists.txt"].indexOf(o)||ke.endsWith(o,".mk"))&&(m.generatedFiles["/"+o]=a.host().readFile(a,o))}let ee=["0","false","PXT_UTF8"],x={};function te(e){return e.replace(/\/\/.*/,"").replace(/\/\*/,"")}s.switches.boxDebug&&(x.PXT_BOX_DEBUG=1),s.utf8&&(x.PXT_UTF8=1),s.switches.profile&&(x.PXT_PROFILE=1),s.switches.gcDebug&&(x.PXT_GC_DEBUG=1),s.switches.numFloat&&(x.PXT_USE_FLOAT=1),s.nativeType==pxtc.NATIVE_TYPE_VM&&(x.PXT_VM=1);let T=0,S=!1,C="",I="",_="",re=!1;function ie(){A.setNs(""),A.write(""),A.write(""),(_||I)&&(A.write(I),A.write(_),_="",I="")}function ne(e,u){C="",I="",_="",re=!1;let d,t=-1;function h(){var e=C.replace(/Methods$/,"");return e==C?null:e}function p(e){switch(e.replace(/\s+/g,"")){case"void":return"void";case"int32_t":case"int":return"int32";case"uint32_t":case"unsigned":return"uint32";case"TNumber":case"float":case"double":return"number";case"uint16_t":return"uint16";case"int16_t":case"short":return"int16";case"uint8_t":case"byte":return"uint8";case"int8_t":case"sbyte":return"int8";case"bool":return s.shortPointers&&y("use 'boolean' not 'bool' on 8 bit targets"),"boolean";case"StringData*":case"String":case"ImageLiteral_":case"ImageLiteral":return"string";case"Action":return"() => void";case"TValue":return"any";default:return E(e)}}function f(e){switch(e=e.replace(/\s+/g,"")){case"int32_t":case"uint32_t":case"unsigned":case"uint16_t":case"int16_t":case"short":case"uint8_t":case"byte":case"int8_t":case"sbyte":case"int":case"ramint_t":return"I";case"void":return"V";case"float":return"F";case"TNumber":return"N";case"TValue":return"T";case"bool":return"B";case"double":return"D";case"ImageLiteral_":return"T";case"String":return"S";default:return ke.lookup(X,e)?"I":"_"+e.replace(/[\*_]+$/,"")}}e=e.replace(/^(\s*#\s*if\s+(\w+)\s*$)([^]*?)(^\s*#\s*(elif|else|endif)\s*$)/gm,(e,t,r,i,n)=>0<=ee.indexOf(r)&&!x[r]?t+i.replace(/[^\n]/g,"")+n:e),J=0,S=!1,T=0,k.setNs(""),A.setNs(""),e.split(/\r?\n/).forEach(e=>{++J;var n=te(e),s=e,a=te(s);if(S&&0<=a.indexOf("}")&&(S=!1,k.write("}")),S){var r=/^\s*(\w+)\s*(=\s*(.*?))?,?\s*$/.exec(a);if(r){var i=r[1];let e=r[3],t="";e?(e=e.trim(),null!=(r=ke.lookup(Z,e))&&(t="  // "+e,e=r),null==(T=xe(e))&&y("cannot determine value of "+a)):(T++,e=T+""),k.write(`    ${E(i)} = ${e},`+t)}else k.write(s)}r=/^\s*enum\s+(|class\s+|struct\s+)(\w+)\s*({|$)/.exec(n);if(r&&(a=r[2],i=r[3],S=!0,T=-1,k.write(""),k.write(""),(_||I)&&(k.write(I),k.write(_),_="",I=""),k.write(`declare const enum ${E(a)} `+i),X[a]=!0,u||(w.setNs(C),w.write(`enum ${r[2]} : int;`))),s=e,!S&&!(/^\s*\/\*\*/.test(s)?(re=!0,I=s+"\n",/\*\//.test(s)&&(re=!1),1):re?(I+=s+"\n",/\*\//.test(s)&&(re=!1),1):/^\s*\/\/%/.test(s)&&(_+=s+"\n",1)))if(/^typedef.*;\s*$/.test(e)&&(w.setNs(C),w.write(e)),n=/^\s*namespace\s+(\w+)/.exec(e))C=n[1],h()?(ie(),a=h(),A.setNs(C,`declare interface ${a} {`)):(_||I)&&(ie(),A.setNs(E(C)),k.setNs(E(C)));else if((n=/^PXT_ABI\((\w+)\)/.exec(e))&&!q&&(b+=`PXT_FNPTR(::${n[1]}),
`,z+=`extern "C" void ${n[1]}();
`,m.functions.push({name:n[1],argsFmt:[],value:0})),(n=/^\s*PXT_EXPORT\(([:\&\w]+)\)/.exec(e))&&(m.vmPointers||(m.vmPointers=[]),m.vmPointers.push(n[1])),(n=/^#define\s+PXT_COMM_BASE\s+([0-9a-fx]+)/.exec(e))&&(m.commBase=parseInt(n[1])),n=/^\s*(\w+)([\*\&]*\s+[\*\&]*)(\w+)\s*\(([^\(\)]*)\)\s*(;\s*$|\{|$)/.exec(e),_&&n){d=null;let t=pxtc.parseCommentString(_);C||y("missing namespace declaration");s=(n[1]+n[2]).replace(/\s+/g,"");let e=n[3];a=n[4];_=_.trim().replace(/ \w+\.defl=\w+/g,"");let r=[f(s)],i=[];var o=a.split(/,/).filter(e=>!!e).map(e=>{e=((e,t)=>{t=t.trim();let r=/(.*)=\s*(-?\w+)$/.exec(t),i="",n="";var s;return r&&(i=r[2],n="?",t=r[1].trim()),(r=/^(.*?)(\w+)$/.exec(t))?(s=r[2],e.paramDefl[s]&&(i=e.paramDefl[s],n="?"),e=i?ke.lookup(Z,i):null,(i=null!=e?e:i)&&(null==xe(i)&&y("Invalid default value (non-integer): "+i),_+=` ${s}.defl=`+i),{name:s+n,type:r[1]}):(y("invalid argument: "+t),{name:"???",type:"int"})})(t,e);return r.push(f(e.type)),i.push(e.type.replace(/ /g,"")),e.name+": "+p(e.type)}),l={name:C+"::"+e,argsFmt:r,value:null};I&&(A.setNs(E(C)),A.write(""),A.write(I),/ImageLiteral/.test(n[4])&&!/imageLiteral=/.test(_)&&(_+=" imageLiteral=1"),_+=" shim="+l.name,A.write(_),e=E(e),h()?((c=(o[0]||"").replace(/^.*:\s*/,"").trim()).toLowerCase()!=h().toLowerCase()&&y(ve("Invalid first argument; should be of type '{0}', but is '{1}'",h(),c)),o.shift(),0==o.length&&/\bproperty\b/.test(_)?A.write(`${e}: ${p(s)};`):A.write(`${e}(${o.join(", ")}): ${p(s)};`)):A.write(`function ${e}(${o.join(", ")}): ${p(s)};`)),I="",_="",u||(w.setNs(C),w.write(`${s} ${e}(${a});`)),m.functions.push(l),void(g?b+="(uint32_t)(void*)::"+l.name+",\n":q?(ke.startsWith(l.name,"pxt::op_")||ye[l.name]||t.expose||!ke.startsWith(l.name,"pxt::")&&!ke.startsWith(l.name,"pxtrt::"))&&(c=((s,a)=>{if("FiberContext*"==a[0])return"::"+s.name;var e="_wrp_"+s.name.replace(/:/g,"_");if(!Q[s.name]){Q[s.name]=!0,v+=`
void ${e}(FiberContext *ctx) {
`;var o=a.length,l=[];let i=!1,n="";for(let r=0;r<o;++r){var c=s.argsFmt[r+1],u=a[r];let e="I"==c?"toInt":"B"==c?"numops::toBool":"";c=r==o-1?"ctx->r0":`ctx->sp[${o-r-2}]`;let t="";switch(u){case"TValue":case"TNumber":break;case"Action":e="asRefAction";break;case"String":e="convertToString",t="ctx, ",i=!0;break;default:e=e||"as"+u.replace(/\*/g,"")}n+=`  ${u} a${r} = (${u}) ${e}(${t}${c});
`,l.push("a"+r)}i&&(v+="  auto prevSP = ctx->sp;\n"),v+=n,i&&(v+="  if (panicCode) { ctx->sp = prevSP; return; }\n");var t=`::${s.name}(${l.join(", ")})`;"V"==s.argsFmt[0]?v=v+`  ${t};
`+`  ctx->r0 = NULL;
`:"I"==s.argsFmt[0]?v+=`  ctx->r0 = fromInt(${t});
`:"B"==s.argsFmt[0]?v+=`  ctx->r0 = fromBool(${t});
`:v+=`  ctx->r0 = (TValue)${t};
`,i&&(v+="  ctx->sp = prevSP;\n"),1<o&&(v+=`  ctx->sp += ${o-1};
`),v+=`}
`}return e})(l,i),o=l.argsFmt.length-1,b+=`{ "${l.name}", (OpFun)(void*)${c}, ${o} },
`):b+="PXT_FNPTR(::"+l.name+"),\n")}else{n=/^\s*extern const (\w+) (\w+);/.exec(e);if(_&&n)s={name:C+"::"+n[2],argsFmt:[],value:null},m.functions.push(s),q||(b+="PXT_FNPTR(&::"+s.name+"),\n"),_="";else{if(n=/^\s*(\w+)\s+(\w+)\s*;/.exec(e),_&&n){var a=pxtc.parseCommentString(_),c=(a.indexedInstanceNS&&(d=a,A.setNs(a.indexedInstanceNS),t=0),n[1]),o=n[2];if(d)return _=_.trim(),_+=` fixedInstance shim=${d.indexedInstanceShim}(${t++})`,A.write(""),A.write(I),A.write(_),A.write(`const ${o}: ${p(c)};`),I="",void(_="")}_&&e.trim()&&(y("declaration not understood: "+e),_="",I="")}}})}let se=ke.clone(n.yottaConfig||{}),d={},ae={},oe={};if(g&&s.hasHex&&(R=n,ke.assert(!!R.yottaCorePackage),ke.assert(!!R.githubCorePackage),ke.assert(!!R.gittag),L=R.githubCorePackage+"#"+n.gittag,m.yotta.dependencies[R.yottaCorePackage]=L),M){let e=!1;for(var h of B){W="",he=fe=pe=P=N=de=ue=le=ce=U=f=p=void 0;var p=h,f=((f=p.config.platformio)&&f.dependencies&&ke.jsonCopyFrom(m.platformio.dependencies,f.dependencies),m.npmDependencies&&p.config.npmDependencies&&ke.jsonCopyFrom(m.npmDependencies,p.config.npmDependencies),p.config.codal);if($&&f)for(var le of f.libraries||[]){var U=Ae.github.parseRepoId(le),le=(U||ke.userError(ve("codal library {0} doesn't look like github repo",le)),Ae.github.stringifyRepo(U)),ce=ke.lookup(oe,U.project);ce?Ae.github.stringifyRepo(ce)!=le&&ke.userError(ve("conflict between codal libraries: {0} and {1}",Ae.github.stringifyRepo(ce),le)):oe[U.project]=U}if(f=p.config.yotta){if(f.dependencies&&ke.jsonCopyFrom(m.yotta.dependencies,f.dependencies),f.config){var P,ue=ke.jsonFlatten(f.config);for(P of Object.keys(ue)){var de=ke.lookup(ae,P),N=ue[P];if(!de||de.config.yotta.configIsJustDefaults)ae[P]=p,se[P]=N;else if(se[P]!==N)if(!p.parent.config.yotta||!p.parent.config.yotta.ignoreConflicts)throw(N=new Te(ve("conflict on yotta setting {0} between extensions {1} and {2}",P,p.id,de.id))).pkg0=de,N.pkg1=p,N.settingName=P,N}}if(f.optionalConfig){var he,pe=ke.jsonFlatten(f.optionalConfig);for(he of Object.keys(pe)){var fe=pe[he];d[he]=fe}}}h==M?(e=!0,A.clear(),k.clear()):ke.assert(!e);let t=e=>ke.endsWith(e,".h");for(l of h.getFiles().filter(t).concat(h.getFiles().filter(e=>!t(e)))){var O=t(l);if(O||ke.endsWith(l,".cpp")){let e=h.config.name+"/"+l;("base"==h.config.name||/^core($|---)/.test(h.config.name))&&O&&(e=l),O&&(G+=`#include "${g?r.slice(1):""}${e}"
`);var me=h.readFile(l);null==me&&ke.userError(ve("C++ file {0} is missing in extension {1}.",l,h.config.name)),Y=e,ne(me,O),m.extensionFiles[r+e]=me,0==h.level&&(m.onlyPublic=!1),h.verProtocol()&&"pub"!=h.verProtocol()&&"embed"!=h.verProtocol()&&(m.onlyPublic=!1)}(ke.endsWith(l,".c")||ke.endsWith(l,".S")||ke.endsWith(l,".s"))&&(O=h.readFile(l),m.extensionFiles[r+h.config.name+"/"+l.replace(/\.S$/,".s")]=O)}W&&(K+=ve("Extension {0}:\n",h.id)+W)}e||(A.clear(),k.clear())}function ge(t){return Object.keys(m.extensionFiles).concat(Object.keys(m.generatedFiles)).filter(e=>ke.endsWith(e,t)).map(e=>e.slice(1))}K&&ke.userError(K),ke.jsonCopyFrom(d,se),ke.iterMap(d,(e,t)=>{null===t&&delete d[e]}),Object.keys(d).filter(e=>/-/.test(e)).forEach(e=>{var t=d[e];delete d[e],d[e.replace(/-/g,"_")]=t}),!g&&n.yottaConfigCompatibility&&Object.keys(d).forEach(e=>d["YOTTA_CFG_"+e]=d[e]),d.PXT_TARGET=JSON.stringify(Ae.appTarget.id);var be,R=ke.jsonUnFlatten(d);if(c){var L={name:"pxt-app",private:!0,dependencies:m.npmDependencies};m.generatedFiles["/package.json"]=JSON.stringify(L,null,4)+"\n"}else if(u){c=ke.concatArrayLike([ge(".c"),ge(".cpp"),ge(".s")]).map(e=>e.slice(r.length-1)).concat(["main.cpp"]);c.push("pointers.cpp"),m.generatedFiles[r+"CMakeLists.txt"]=`idf_component_register(
  SRCS
`+c.map(e=>`    "${e}"
`).join("")+`  INCLUDE_DIRS
    "."
)
`}else if($){L=n;let r=ke.clone(L.codalDefinitions)||{},e=L.codalTarget;"string"==typeof e&&(e+=".json");u={target:e,definitions:r,config:r,application:"pxtapp",output_folder:"build",pxt_gitrepo:L.githubCorePackage,pxt_gittag:L.gittag,libraries:ke.values(oe).map(e=>({name:e.project,url:"https://github.com/"+e.fullName,branch:e.tag||"master",type:"git"}))};0==u.libraries.length&&delete u.libraries,ke.iterMap(ke.jsonFlatten(R),(e,t)=>{e=e.replace(/^codal\./,"device.").toUpperCase().replace(/\./g,"_"),r[e]=t}),m.generatedFiles["/codal.json"]=JSON.stringify(u,null,4)+"\n",Ae.debug("codal.json: "+m.generatedFiles["/codal.json"]),m.codal=u}else if(i){let r=n.platformioIni.slice();r.push("lib_deps ="),ke.iterMap(m.platformio.dependencies,(e,t)=>{e=/[@#\/]/.test(t)?t:e+"@"+t;r.push("  "+e)}),m.generatedFiles["/platformio.ini"]=r.join("\n")+"\n"}else{m.yotta.config=R;let e="pxt-app";c={name:e=n.yottaBinary?n.yottaBinary.replace(/-combined/,"").replace(/\.hex$/,""):e,version:"0.0.0",description:"Auto-generated. Do not edit.",license:"n/a",dependencies:m.yotta.dependencies,targetDependencies:{},bin:"./source"};m.generatedFiles["/module.json"]=JSON.stringify(c,null,4)+"\n",Ae.debug("module.json: "+m.generatedFiles["/module.json"])}for(be of Object.keys(x))H+=`#define ${be} ${x[be]}
`;if(s.uf2Family&&(H+=`#define PXT_UF2_FAMILY ${s.uf2Family}
`),m.generatedFiles[r+"pointers.cpp"]=G+w.finish()+z+v+b+"\nPXT_SHIMS_END\n",m.generatedFiles[r+"pxtconfig.h"]=H,Ae.debug("pxtconfig.h: "+m.generatedFiles[r+"pxtconfig.h"]),g&&(m.generatedFiles["/config.json"]=JSON.stringify(R,null,4)+"\n",Ae.debug("yotta config.json: "+m.generatedFiles["/config.json"])),m.generatedFiles[r+"main.cpp"]=`
#include "pxt.h"
#ifdef PXT_MAIN
PXT_MAIN
#else
int main() {
    uBit.init();
    pxt::start();
    release_fiber();
    return 0;   // your program will never reach this line.
}
#endif
`,m.generatedFiles["/Makefile"]){let r="";L=(e,t)=>{r+=`${e} = ${ge(t).join(" ")}\n`};L("PXT_C",".c"),L("PXT_CPP",".cpp"),L("PXT_S",".s"),L("PXT_HEADERS",".h"),r=r+"PXT_SOURCES := $(PXT_C) $(PXT_S) $(PXT_CPP)\n"+"PXT_OBJS := $(addprefix bld/, $(PXT_C:.c=.o) $(PXT_S:.s=.o) $(PXT_CPP:.cpp=.o))\n",m.generatedFiles["/Makefile.inc"]=r}return m.generatedFiles["/functions.json"]=JSON.stringify(m.functions,null,1),u=m.extensionFiles,ke.jsonCopyFrom(u,m.generatedFiles),i={config:n.serviceId,tag:n.gittag,replaceFiles:u,dependencies:g?m.yotta.dependencies:null},c=JSON.stringify(i),m.sha=ke.sha256(c),m.skipCloudBuild=!!n.skipCloudBuild,m.compileData=ts.pxtc.encodeBase64(ke.toUTF8(c)),m.shimsDTS=A.finish(),m.enumsDTS=k.finish(),(we=10<Object.keys(we).length?{}:we)[j]=m},e.unpackSourceFromHexFileAsync=function(e){if(e)return Ae.Util.fileReadAsBufferAsync(e).then(e=>t(new Uint8Array(e)))},e.unpackSourceFromHexAsync=t}})(pxt=pxt||{}),(u=>{{var i=u.hexloader||(u.hexloader={});let t={},r,s={};function a(e){return t.hasOwnProperty(e.sha)||(t[e.sha]=(t=>{let c="";return i.showLoading(u.U.lf("Compiling (this may take a minute)...")),u.tickEvent("cppcompile.start"),(e=>e.skipCloudBuild?Promise.resolve({hex:["SKIP"]}):u.webConfig&&u.webConfig.isStatic?u.Util.requestAsync({url:`${u.webConfig.cdnUrl}hexcache/${e.sha}.hex`}).then(e=>e.text?(e={enums:[],functions:[],hex:e.text.split(/\r?\n/)},Promise.resolve(e)):(u.log("Hex info not found in bundled hex cache"),Promise.resolve())).catch(e=>(u.log("Error fetching hex info from bundled hex cache"),Promise.resolve())):u.Cloud.localToken&&window&&u.BrowserUtils.isLocalHost()?((e,t)=>u.Cloud.localRequestAsync(e,t).then(e=>e.json))("compile/"+e.sha).then(e=>e&&!e.notInOfflineCache&&e.hex?(e.hex=e.hex.split(/\r?\n/),e):Promise.resolve(void 0)).catch(e=>Promise.resolve(void 0)):Promise.resolve(void 0))(t).then(e=>e?(u.tickEvent("cppcompile.cachehit"),e):(()=>{var e;return r||(e=u.getOnlineCdnUrl(),r=e?Promise.resolve(e):(e=u.webConfig&&u.webConfig.isStatic,u.Cloud.privateGetAsync("clientconfig",e).then(e=>e.primaryCdnUrl)))})().then(e=>(c=e+"/compile/"+t.sha,u.U.httpGetTextAsync(c+".hex"))).then(e=>e,e=>u.Cloud.privatePostAsync("compile/extension",{data:t.compileData},!0).then(l=>new Promise((r,e)=>{let i=0,n=8e3,s=3e5,a=u.U.now(),o=()=>{if(i++,u.U.now()-a>s)return u.log("abandoning C++ build"),u.tickEvent("cppcompile.cancel",{retry:i}),r(null),null;let t=l.hex.replace(/\.hex/,".json");return u.log(`polling C++ build ${t} (attempt #${i})`),u.tickEvent("cppcompile.poll",{retry:i}),u.Util.httpGetJsonAsync(t).then(e=>{u.log("build log "+t.replace(/\.json$/,".log")),u.tickEvent("cppcompile.done",{success:null!=e&&e.success?1:0,retry:i,duration:u.U.now()-a}),e.success?(u.log("fetching "+c+".hex"),r(u.U.httpGetTextAsync(c+".hex"))):(u.log("build failed"),e.mbedresponse&&e.mbedresponse.result&&e.mbedresponse.result.exception&&u.log(e.mbedresponse.result.exception),r(null))},e=>(u.log(`waiting ${n/1e3|0}s for C++ build...`),setTimeout(o,n),null))};o()}))).then(e=>(i.hideLoading(),{hex:e&&e.split(/\r?\n/)}))).finally(()=>{i.hideLoading()})})(e)),t[e.sha]}function o(r,i,n,e,s=10){return r.cacheStoreAsync(n,e).then(()=>r.cacheGetAsync(i)).then(e=>{let t;try{t=JSON.parse(e||"[]")}catch(e){u.error("invalid cache entry, clearing entry"),t=[]}(t=t.filter(e=>e!=n)).unshift(n);e=t.slice(s);return t=t.slice(0,s),u.U.promiseMapAll(e,e=>r.cacheStoreAsync(e,"[]")).then(()=>r.cacheStoreAsync(i,JSON.stringify(t)))})}function l(r,i,n){return r.cacheGetAsync(i).then(e=>{let t;try{t=JSON.parse(e||"[]")}catch(e){return u.error("invalid cache entry, clearing entry"),r.cacheStoreAsync(i,"[]")}return t[0]!=n?((t=t.filter(e=>e!=n)).unshift(n),r.cacheStoreAsync(i,JSON.stringify(t))):null})}i.showLoading=e=>{},i.hideLoading=()=>{},i.storeWithLimitAsync=o,i.recordGetAsync=l,i.getHexInfoAsync=function(i,r,e){if(!r.sha)return Promise.resolve(null);var t=s[r.sha];if(t)return Promise.resolve(t);u.debug("get hex info: "+r.sha);let n="hex-"+r.sha;return i.cacheGetAsync(n).then(e=>{let t;try{t=e?JSON.parse(e):null}catch(e){u.log("invalid cache entry, clearing entry"),t=null}return t&&t.hex?(u.debug("cache hit, size="+e.length),t.hex=(r=>{var s=[];for(let t=0;t<r.length;t++){var i=/^([@!])(....)$/.exec(r[t]);if(i){let e=parseInt(i[2],16);var a=r[++t];let n="";if("@"==i[1]){n="";let e=parseInt(a,16);for(;0<e--;)n+="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"}else n=ts.pxtc.decodeBase64(a);u.Util.assert(0<n.length),u.Util.assert(n.length%16==0);for(let i=0;i<n.length;){var o=[16,e>>8&255,255&e,0];e+=16;for(let e=0;e<16;++e)o.push(n.charCodeAt(i++));let t=0;for(let e=0;e<o.length;++e)t+=o[e];o.push(255&-t);let r=":";for(let e=0;e<o.length;++e){var l=255&o[e];l<=15&&(r+="0"),r+=l.toString(16)}s.push(r.toUpperCase())}}else s.push(r[t])}return s})(t.hex),l(i,"hex-keys",n).then(()=>t)):a(r).then(e=>{var t=e.hex,r=(e.hex=(n=>{let s=[],a=0;for(let i=0;i<n.length;i+=a){let e=-1,r="",t=(a=0,!1);for(;a<500;){var o=/^:10(....)00(.{32})(..)$/.exec(n[i+a]);if(!o)break;var l=o[2],c=/^0+$/.test(l),u=parseInt(o[1],16);if(-1==e)t=c,s.push((t?"@":"!")+o[1]),e=u-16;else{if(c!=t)break;if(e+16!=u)break}t||(r+=l),e=u,a++}if(0==a)s.push(n[i]),a=1;else if(t)s.push(a.toString(16));else{let t="";for(let e=0;e<r.length;e+=2)t+=String.fromCharCode(parseInt(r.slice(e,e+2),16));s.push(ts.pxtc.encodeBase64(t))}}return s})(e.hex),JSON.stringify(e));return e.hex=t,o(i,"hex-keys",n,r).then(()=>e)}).catch(e=>(u.reportException(e,{sha:r.sha}),Promise.resolve(null)))}).then(e=>(e&&((s=20<Object.keys(s).length?{}:s)[r.sha]=e),e))}}})(pxt=pxt||{}),(s=>{var e;(e=s.crowdin||(s.crowdin={})).KEY_VARIABLE="CROWDIN_KEY",e.testMode=!1,e.setTestMode=function(){s.crowdin.testMode=!0,s.log("CROWDIN TEST MODE - files will NOT be uploaded")},e.inContextLoadAsync=function(i){let n=document.createElement("input");n.type="text",n.setAttribute("class","hidden"),n.value=i;var e=new Promise((t,e)=>{let r=new MutationObserver(()=>{var e;i!=n.value&&(e=s.Util.rlf(n.value),n.remove(),r.disconnect(),t(e))});r.observe(n,{attributes:!0})});return document.body.appendChild(n),e}})(pxt=pxt||{}),(f=>{var e;{var t=f.diff||(f.diff={});function A(r,e){if(!r)return[];if(e){var i=[];let t=0;for(let e=0;e<r.length;e++)"\n"===r.charAt(e)&&(i.push(r.substring(t,e+1)),t=e+1);return i.push(r.substring(t)),i}return r.split(/\r?\n/)}t.toLines=A;let w;function m(e,t,n={}){n.ignoreWhitespace&&(e=e.replace(/[\r\n]+$/,""),t=t.replace(/[\r\n]+$/,""));var s=A(e,!0),a=A(t,!0);let o=Math.min(n.maxDiffSize||1024,s.length+a.length);if(0==o)return[];let l=65520<s.length?Uint32Array:Uint16Array,c={},u=0,d=r(s),h=r(a);function r(e){var t,r=new l(e.length);let i=0;for(t of e)n.ignoreWhitespace&&(t=t.replace(/\s+$/g,"").replace(/^\s+/g,"")),c.hasOwnProperty(t)?r[i]=c[t]:(++u,r[i]=u,c[t]=u),i++;return r}let i=new l(2*o+1),p=-1;for(let e=0;e<=o;e++)null!=y(e,i)&&(p=e);if(-1==p)return null;var f=[];let m=null;for(let t=0;t<=p;t++){let e=f.length?f[f.length-1].slice(0):new l(2*p+1);if(f.push(e),null!=(m=y(t,e)))break}var g=[];let b=m;for(let i=f.length-1;0<=i;i--){let t=f[i],r=0,e=0;var v=(r=b==-i||b!=i&&t[o+b-1]<t[o+b+1]?(e=b+1,t[o+e]):(e=b-1,t[o+e]+1))-b;for(let e=t[o+b]-r-1;0<=e;--e)g.push([w.Unchanged,a[v+e]]);e==b-1?g.push([w.Deleted,s[r-1]]):0<v&&g.push([w.Added,a[v-1]]),b=e}return g.reverse(),g;function y(i,n){for(let r=-i;r<=i;r+=2){let e=0,t=(e=r==-i||r!=i&&n[o+r-1]<n[o+r+1]?n[o+r+1]:n[o+r-1]+1)-r;for(;e<d.length&&t<h.length&&d[e]==h[t];)e++,t++;if((n[o+r]=e)>=d.length&&t>=h.length)return r}return null}}function g(e,t,r={}){var i=m(e,t,r);if(r.context==1/0||r.full)return i.map(h);let n=1,s=1,a=0;for(var o=[],l=r.context||3;a<i.length;){let e=a;for(;e<i.length&&i[e][0]===w.Unchanged;)e++;if(e==i.length)break;var c=e-l,u=c-a,u=(0<u&&(n+=u,s+=u,a=c),o.length),c=n,d=s;o.push("@@");let t=a,r=0;for(;t<i.length;){if(i[t][0]===w.Unchanged){if(++r>2*l+2){t-=l+2;break}}else r=0;t++}for(;a<t;){switch(o.push(h(i[a])),i[a][0]){case w.Deleted:n++;break;case w.Added:s++;break;case w.Unchanged:n++,s++}a++}o[u]=`@@ -${c},${n-c} +${d},${s-d} @@`}return o}function h([e,t]){let r;return(r=e===w.Added?"+ ":e===w.Deleted?"- ":"  ")+t.replace(/\r?\n/,"")}function s(e){return A(e).map(e=>e.replace(/;\s*$/,"")).join("\n")}function b(e){e=/^@@ -(\d+),(\d+) \+(\d+),(\d+)/.exec(e);return e&&{oldStart:parseInt(e[1])-1,oldLength:parseInt(e[2]),newStart:parseInt(e[3])-1,newLength:parseInt(e[4])}}(e=w=w||{})[e.Added=1]="Added",e[e.Deleted=-1]="Deleted",e[e.Unchanged=0]="Unchanged",t.compute=m,t.computeFormattedDiff=g,t.computePatch=function(e,t){var s=m(e,t,{full:!0,maxDiffSize:2048});if(s){var a=s;let e=[],t="",r="",i="",n=w.Unchanged;var o=()=>{e.push({start1:t.length,length1:i.length,diffs:[[w.Added,r]]}),t+=r,r="",i=""};for(let e=0;e<a.length;e++){var[l,c]=a[e];l==w.Unchanged?(n!==w.Unchanged&&o(),t+=c):l===w.Added?r+=c:l===w.Deleted&&(n===w.Added&&o(),i+=c),n=l}return n!==w.Unchanged&&o(),e}return[{start1:0,length1:e.length,diffs:[[w.Added,t]]}]},t.applyPatch=function(e,t){let r=e;for(var i of t){var n=i.diffs.filter(e=>e[0]!==w.Deleted).map(e=>e[1]).join("");r=r.substring(0,i.start1)+n+r.substring(i.start1+i.length1)}return r},t.diff3=function(e,t,r,o,l){var c=i(e),u=i(r);if(c&&u){var d=A(e),h=A(r);let n=0;var p=[];let s=0,a=0;for(let i=0;i<c.length-1;)if(c[i]==s&&u[i]==a)p.push(d[s]),s++,a++,i++;else{let e=!0,t=!0,r=i;for(;r<c.length&&(c[r]!=s+r-i&&(e=!1),u[r]!=a+r-i&&(t=!1),null==c[r]||null==u[r]);)r++;if(f.U.assert(r<c.length),e)for(;a<u[r];)p.push(h[a++]);else if(t)for(;s<c[r];)p.push(d[s++]);else if(d.slice(s,c[r]).join("\n")==h.slice(a,u[r]).join("\n"))for(;s<c[r];)p.push(d[s++]);else{for(n++,p.push("<<<<<<< "+o);s<c[r];)p.push(d[s++]);for(p.push("=======");a<u[r];)p.push(h[a++]);p.push(">>>>>>> "+l)}i=r,s=c[r],a=u[r]}return{merged:p.join("\n"),numConflicts:n};function i(r){r=m(t,r,{context:1/0});if(r){var i,n=[];let e=0,t=0;for(i of r)i[0]==w.Added?e++:i[0]==w.Deleted?(n[t]=null,t++):i[0]==w.Unchanged?(n[t]=e,e++,t++):f.U.oops();return n.push(e+1),n}}}},t.removeTrailingSemiColumns=s,t.split=function(e,t){var r=e.split(/-{10,}/,2);if(r.length<2)return{fileA:e,fileB:void 0};let i=r[0].replace(/\n$/,""),n=r[1].replace(/^\n/,"");return t&&t.removeTrailingSemiColumns&&(i=s(i),n=s(n)),{fileA:i,fileB:n}},t.parseDiffMarker=b,t.render=function(e,t,a={}){let o=g(e,t,a);if(!o)return f.dom.el("div",null,pxtc.Util.lf("Too many differences to render diff."));let l={"@":"diff-marker"," ":"diff-unchanged","+":"diff-added","-":"diff-removed"},c=0,u=0,d="",h=f.dom.el("tbody"),p=(e=f.dom.el("table",{class:"diffview "+(a.update?"update":"")},h),null);return o.forEach((e,t)=>{var r=b(e),r=(r?(c=r.oldStart,u=r.newStart):("+"!=e[0]&&c++,"-"!=e[0]&&u++),o[t+1]?o[t+1][0]:""),i=o[t+2]?o[t+2][0]:"",n=e.slice(2);let s=f.dom.el("code",null,n);p?(s=p,p=null):"-"!=e[0]||" "!=d&&"@"!=d||"+"!=r||" "!=i&&"@"!=i&&""!=i||(n=((e,t)=>{var r=g(e.split("").join("\n"),t.split("").join("\n"),{context:1/0});if(!r)return{a:f.dom.el("div",{class:"inline-diff"},f.dom.el("code",null,e)),b:f.dom.el("div",{class:"inline-diff"},f.dom.el("code",null,t))};var i=[],n=[];for(let t=0;t<r.length;){let e=t;for(var s=r[t][0];r[e]&&r[e][0]==s;)e++;var a=r.slice(t,e).map(e=>e.slice(2)).join("");" "==s?(i.push(f.dom.el("code",{class:"ch-common"},a)),n.push(f.dom.el("code",{class:"ch-common"},a))):"-"==s?i.push(f.dom.el("code",{class:"ch-removed"},a)):"+"==s?n.push(f.dom.el("code",{class:"ch-added"},a)):f.Util.oops(),t=e}return{a:f.dom.el("div",{class:"inline-diff"},i),b:f.dom.el("div",{class:"inline-diff"},n)}})(e.slice(2),o[t+1].slice(2)),s=n.a,p=n.b),d=e[0],a.hideMarkerLine&&"@"==d||a.hideRemoved&&"-"==d||(r="@"==d,i=""+l[d],h.appendChild(f.dom.el("tr",{class:i},[!a.hideLineNumbers&&f.dom.el("td",{class:"line-a","data-content":c}),!a.hideLineNumbers&&f.dom.el("td",{class:"line-b","data-content":u}),r&&f.dom.el("td",{colspan:2,class:"change"},f.dom.el("code",null,e)),!a.hideMarker&&!r&&f.dom.el("td",{class:"marker","data-content":d}),!r&&f.dom.el("td",{class:"change"},s)])))}),e},t.resolveMergeConflictMarker=function(e,t,r,i){var n=f.diff.toLines(e);let s=t;for(;s<n.length&&!/^<<<<<<<[^<]/.test(n[s]);)s++;let a=s+1;for(;a<n.length&&!/^=======$/.test(n[a]);)a++;let o=a+1;for(;o<n.length&&!/^>>>>>>>[^>]/.test(n[o]);)o++;if(o>=n.length)return f.debug(`diff marker mistmatch: ${n.length} -> ${s} ${a} `+o),e;if(n[s]=void 0,n[a]=void 0,n[o]=void 0,!r)for(let e=s;e<=a;++e)n[e]=void 0;if(!i)for(let e=a;e<=o;++e)n[e]=void 0;return n.filter(e=>void 0!==e).join("\n")},t.mergeDiff3Config=function(e,t,r){var i=f.Util.jsonTryParse(e);let n=f.Util.jsonTryParse(t);var s=f.Util.jsonTryParse(r);if(i&&!s)return e;if(!i)return r||t;if(!n&&s&&(n=s),i&&n&&s){delete i.installedVersion,delete n.installedVersion,delete s.installedVersion;var a,o,l={};for(a of f.U.unique(Object.keys(n).concat(Object.keys(i)).concat(Object.keys(s)),e=>e)){var c=i[a],u=n[a],d=s[a];if(JSON.stringify(c)==JSON.stringify(d))void 0!==c&&(l[a]=c);else switch(a){case"name":l[a]=(p=d,(o=c)==(h=u)||p!=h&&o==lf("Untitled")?p:o);break;case"version":l[a]=0<f.semver.strcmp(c,d)?c:d;break;case"languageRestriction":case"preferredEditor":case"targetVersion":l[a]=c;break;case"public":l[a]=c&&d;break;case"files":case"testFiles":var h=((e,t,r)=>{var i,n=[];for(i of f.U.unique(t.concat(e).concat(r),e=>e)){var s=-1<e.indexOf(i),a=-1<r.indexOf(i),o=-1<t.indexOf(i);s==a||a==o?s&&n.push(i):a&&n.push(i)}return n})(c||[],u||[],d||[]);if(!h)return;l[a]=h.length?h:void 0;break;case"dependencies":case"testDependencies":var p=((e,t,r)=>{var i,n={};for(i of f.U.unique(Object.keys(t).concat(Object.keys(e)).concat(Object.keys(r)),e=>e)){var s,a,o=e[i],l=r[i],c=t[i];o==l?o&&(n[i]=o):(s=f.github.parseRepoId(o),a=f.github.parseRepoId(l),s&&a&&f.semver.tryParse(s.tag)&&f.semver.tryParse(a.tag)&&s.owner&&s.project&&s.owner==a.owner&&s.project==a.project?(a=(0<f.semver.strcmp(s.tag,a.tag)?s:a).tag,n[i]=`github:${s.owner}/${s.project}#`+a):l==c?o&&(n[i]=o):l&&(n[i]=l))}return n})(c||{},u||{},d||{});if(Object.keys(p).length)return;l[a]=p;break;case"description":if(c&&!d)l[a]=c;else{if(c||!d)return;l[a]=d}break;default:return}}return f.Package.stringifyConfig(l)}},t.hasMergeConflictMarker=function(e){return e&&/^(<<<<<<<[^<]|>>>>>>>[^>])/m.test(e)},t.reconstructConfig=function(t,r,e,i){var n={};let s=e.tree.tree.map(e=>e.path).filter(e=>/\.(ts|blocks|md|jres|asm|json)$/.test(e)).filter(e=>e!=f.CONFIG_NAME);return(s=t.fileName?s.filter(e=>0===e.indexOf(t.fileName)).map(e=>e.slice(t.fileName.length+1)):s).find(e=>/\.ts$/.test(e))||(i.config.files.filter(e=>s.indexOf(e)<0).forEach(e=>{s.push(e),r[e]=i.files[e]}),f.Util.jsonCopyFrom(n,i.config.dependencies)),Object.keys(n).length||(n[f.appTarget.corepkg]="*"),{name:"",files:s,dependencies:n,preferredEditor:s.find(e=>/.blocks$/.test(e))?f.BLOCKS_PROJECT_NAME:f.JAVASCRIPT_PROJECT_NAME}}}})(pxt=pxt||{}),(i=>{var e;(e=i.discourse||(i.discourse={})).extractSharedIdFromPostUrl=function(e){return i.Util.httpGetJsonAsync(e+".json").then(e=>e.post_stream&&e.post_stream.posts&&e.post_stream.posts[0]&&e.post_stream.posts[0].link_counts.map(e=>i.Cloud.parseScriptId(e.url)).filter(e=>!!e)[0])},e.topicsByTag=function(r,e){return e=(r=r.replace(/\/$/,""))+`/tag/${e}.json`,i.Util.httpGetJsonAsync(e).then(e=>{let t=i.Util.toDictionary(e.users,e=>e.id.toString());return e.topic_list.topics.map(e=>({id:e.id,title:e.title,url:r+`/t/${e.slug}/`+e.id,imageUrl:e.image_url,author:t[e.posters[0].user_id].username,cardType:"forumUrl"}))})}})(pxt=pxt||{}),(p=>{{var T=p.docs||(p.docs={}),S=pxtc.Util;let y,A={},k={};var e="\x3c!-- @CMD@ @ARGS@ --\x3e";let E={parent:e,short:e,description:"\x3c!-- desc --\x3e",activities:"\x3c!-- activities --\x3e",explicitHints:"\x3c!-- hints --\x3e",flyoutOnly:"\x3c!-- flyout --\x3e",hideToolbox:"\x3c!-- hideToolbox --\x3e",hideIteration:"\x3c!-- iter --\x3e",codeStart:"\x3c!-- start --\x3e",codeStop:"\x3c!-- stop --\x3e",autoOpen:"\x3c!-- autoOpen --\x3e",autoexpandOff:"\x3c!-- autoexpandOff --\x3e",preferredEditor:"\x3c!-- preferredEditor --\x3e"};function t(e,t,r){return e.split(t).join(r)}function r(e){return e=t(e,"&","&amp;"),e=t(e,"<","&lt;"),e=t(e,">","&gt;"),e=t(e,'"',"&quot;"),e=t(e,"'","&#39;")}function C(e){return e&&r(e.replace(/\&([#a-z0-9A-Z]+);/g,(e,t)=>{switch(t){case"amp":return"&";case"lt":return"<";case"gt":return">";case"quot":return'"';default:return"#"==t[0]?String.fromCharCode(parseInt(t.slice(1))):e}}))}T.htmlQuote=r,T.html2Quote=C;let w=[{rx:/^vimeo\.com\/(\d+)/i,cmd:"### @vimeo $1"},{rx:/^(www\.youtube\.com\/watch\?v=|youtu\.be\/)([\w\-]+(\#t=([0-9]+m[0-9]+s|[0-9]+m|[0-9]+s))?)/i,cmd:"### @youtube $2"}],x=(T.requireMarked=()=>"undefined"!=typeof marked?marked:"undefined"!=typeof require?require("marked"):void 0,T.requireDOMSanitizer=()=>"undefined"!=typeof DOMPurify?DOMPurify.sanitize:"undefined"!=typeof require?require("DOMPurify").sanitize:void 0,e=>`<div class='ui negative message'>${r(e)}</div>`);function I(n){let s=S.clone(A),a=S.clone(k),o=S.clone(E),l={},c={},r=n.params;var e=n.theme;n.boxes=s,n.macros=a,n.settings=o,n.html=n.html.replace(/<aside\s+([^<>]+)>([^]*?)<\/aside>/g,(e,t,r)=>{var t=(t=>{for(var r,i={};t.trim();){let e=/\s*([^=\s]+)=("([^"]*)"|'([^']*)'|(\S*))/.exec(t);e?(r=e[3]||e[4]||e[5]||"",i[e[1].toLowerCase()]=r):i[(e=/^\s*(\S+)/.exec(t))[1]]="true",t=t.slice(e[0].length)}return i})(t),i=t["data-name"]||t.id;return i?(/box/.test(t.class)?s[i]=r:/aside/.test(t.class)?s[i]=`<!-- BEGIN-ASIDE ${i} -->${r}<!-- END-ASIDE -->`:/setting/.test(t.class)?o[i]=r:/menu/.test(t.class)?l[i]=r:/toc/.test(t.class)?c[i]=r:a[i]=r,`<!-- macro ${i} -->`):x("id or data-name missing on macro")});let u=(e,t)=>{let r=l.item;var i={NAME:e.name};if(e.subitems)r=l["toc-dropdown"]||(0==t?l["top-dropdown"]:l["inner-dropdown"]),i.ITEMS=e.subitems.map(e=>u(e,t+1)).join("\n");else{if(/^-+$/.test(e.name)&&(r=l.divider),e.path&&!/^(https?:|\/)/.test(e.path))return x("Invalid link: "+e.path);i.LINK=e.path}return P(r,i,["ITEMS"])},d=[{name:lf("Docs"),href:"/docs"}];var i=n.TOC||e.TOC||[];let h=[],p=e=>{for(var t of e.subitems||[])if(p(t))return h.push(e),!0;return!(!n.filepath||!e.path||n.filepath!=e.path||(h.push(e),0))},f=(i.forEach(p),(e,t)=>{let r=c.item;var i={NAME:e.name};return e.path&&!/^(https?:|\/)/.test(e.path)?x("Invalid link: "+e.path):(/^\//.test(e.path)&&n.versionPath&&(e.path="/"+n.versionPath+e.path),i.LINK=e.path,0<=h.indexOf(e)?(i.ACTIVE="active",i.EXPANDED="true",d.push({name:e.name,href:e.path})):i.EXPANDED="false",e.subitems&&0<e.subitems.length?(r=c["toc-dropdown"]?""!==e.name?c["toc-dropdown"]:c["toc-dropdown-noLink"]:0==t?""!==e.name?c["top-dropdown"]:c["top-dropdown-noHeading"]:1==t?c["inner-dropdown"]:c["nested-dropdown"],i.ITEMS=e.subitems.map(e=>f(e,t+1)).join("\n")):/^-+$/.test(e.name)&&(r=c.divider),P(r,i,["ITEMS"]))}),t=(r.menu=(e.docMenu||[]).map(e=>u(e,0)).join("\n"),r.TOC=i.map(e=>f(e,0)).join("\n"),e.appStoreID&&(r.appstoremeta=`<meta name="apple-itunes-app" content="app-id=${S.htmlEscape(e.appStoreID)}"/>`),"");1<d.length&&(t=`
            <nav class="ui breadcrumb" aria-label="${lf("Breadcrumb")}">
                ${d.map((e,t)=>`<a class="${t==d.length-1?"active":""} section"
                        href="${C(e.href)}" aria-current="${t==d.length-1?"page":""}">${C(e.name)}</a>`).join('<i class="right chevron icon divider"></i>')}
            </nav>`),r.breadcrumb=t,e.boardName&&(r.boardname=C(e.boardName)),e.boardNickname&&(r.boardnickname=C(e.boardNickname)),e.driveDisplayName&&(r.drivename=C(e.driveDisplayName)),e.homeUrl&&(r.homeurl=C(e.homeUrl)),r.targetid=e.id||"???",r.targetname=e.name||"Microsoft MakeCode",r.docsheader=e.docsHeader||"Documentation",r.orgtitle="MakeCode";var i=e.docsLogo&&S.htmlEscape(e.docsLogo),m=(e.organizationWideLogo||e.organizationLogo)&&S.htmlEscape(e.organizationWideLogo||e.organizationLogo),g=e.organizationLogo&&S.htmlEscape(e.organizationLogo),i=(r.targetlogo=i?`<img aria-hidden="true" role="presentation" class="ui ${e.logoWide?"small":"mini"} image" src="${i}" />`:"",r.orglogo=m?`<img aria-hidden="true" role="presentation" class="ui image" src="${m}" />`:"",r.orglogomobile=g?`<img aria-hidden="true" role="presentation" class="ui image" src="${g}" />`:"",n.ghEditURLs||[]);if(i.length){let e=`<p style="margin-top:1em">
`,t=lf("Edit this page on GitHub");for(var b of i)e+=`<a href="${b}"><i class="write icon"></i>${t}</a><br>
`,t=lf("Edit template of this page on GitHub");e+=`</p>
`,r.github=e}else r.github="";var v,m=`
            <a href="#maincontent" class="ui item link" tabindex="0" role="menuitem">${lf("Skip to main content")}</a>
        `,g=(r.accMenu=m,lf("Print this page")),i=(r.printBtn=`
            <button id="printbtn" class="circular ui icon right floated button hideprint" title="${g}" aria-label="${g}">
                <i class="icon print"></i>
            </button>
        `,`
            <a id="togglesidebar" class="launch icon item" tabindex="0" title="Side menu" aria-label="${lf("Side menu")}" role="menuitem" aria-expanded="false">
                <i class="content icon"></i>
            </a>
        `),m=(r.sidebarToggle=i,["tocsearch1","tocsearch2"].map(e=>`
                <input type="search" name="q" placeholder="${lf("Search...")}" aria-label="${lf("Search Documentation")}">
                <i onclick="document.getElementById('${e}').submit();" tabindex="0" class="search link icon" aria-label="${lf("Search")}" role="button"></i>
            `));r.searchBar1=m[0],r.searchBar2=m[1];let y="";e.accentColor&&(y+=`
.ui.accent { color: ${e.accentColor}; }
.ui.inverted.accent { background: ${e.accentColor}; }
`),r.targetstyle=y,r.tocclass=e.lightToc?"lighttoc":"inverted";for(v of Object.keys(e)){var w=e[v];void 0===r[v]&&"string"==typeof w&&(r[v]=w)}n.finish=()=>P(n.html,r,["body","menu","accMenu","TOC","prev","next","printBtn","breadcrumb","targetlogo","orglogo","orglogomobile","github","JSON","appstoremeta","sidebarToggle","searchBar1","searchBar2"])}function _(e){e.image=function(i,t,r){if(i.startsWith("youtube:"))return'<div class="tutorial-video-embed"><iframe class="yt-embed" src="https://www.youtube.com/embed/'+i.split(":").pop()+'" title="'+r+'" frameborder="0" allowFullScreen allow="autoplay; picture-in-picture"></iframe></div>';if(i.startsWith("azuremedia:")){let e=i.split(":")[1];var n=e.split("?");let t,r;n[1]&&(e=n[0],n=n[1],t=null==(s=/start(?:time)?=(\d+)/i.exec(n))?void 0:s[1],r=null==(s=/end(?:time)?=(\d+)/i.exec(n))?void 0:s[1]);var n=new URL(`https://makecodeprodmediaeastus-usea.streaming.media.azure.net/${e}/manifest(format=mpd-time-csf).mpd`),s=(t&&(n.hash="t="+t,n.searchParams.append("startTime",t)),r&&n.searchParams.append("endTime",r),`<div class="tutorial-video-embed"><video class="ams-embed" controls src="${n.toString()}" /></div>`);return s}{let e='<img class="ui image" src="'+i+'" alt="'+r+'"';return t&&(e+=' title="'+t+'"'),e=(e+=' loading="lazy"')+(this.options.xhtml?"/>":">")}},e.listitem=function(e){var t=/^\s*\[( |x)\]/i.exec(e);return t?`<li class="${" "==t[1]?"unchecked":"checked"}">`+e.slice(t[0].length)+"</li>\n":"<li>"+e+"</li>\n"},e.heading=function(e,t,r){var i=/(.*)#([\w\-]+)\s*$/.exec(e);let n="";return i&&(e=i[1],n=i[2]),(e=e&&e.replace(/@(fullscreen|unplugged|showdialog|showhint)/gi,"")).match(/\{([\s\S]+)\}/)&&(e=e.match(/\{([\s\S]+)\}/)[1].trim()),""===n&&(n=e.toLowerCase().replace(/[^\w]+/g,"-")),`<h${t} id="${this.options.headerPrefix}${n}">${e}</h${t}>`}}function U(e,n){return e.replace(/<!--\s*@(ifn?def)\s+(\w+)\s*-->([^]*?)<!--\s*@endif\s*-->/g,(e,t,r,i)=>"ifdef"==t&&n[r]||"ifndef"==t&&!n[r]?`<!-- ${t} ${r} -->${i}<!-- endif -->`:`<!-- ${t} ${r} endif -->`)}function P(e,i,n=[]){return e?e.replace(/@(\w+)@/g,(e,t)=>{let r=S.lookup(i,t)||"";return r+="",r=n.indexOf(t)<0?C(r):r}):""}T.prepTemplate=I,T.setupRenderer=_,T.renderConditionalMacros=U,T.renderMarkdown=function(o){let e=!0,l=(o.pubinfo||(e=!1,o.pubinfo={}),o.pubinfo),t=(o.theme||(o.theme={}),delete o.pubinfo.private,l.time&&(d=parseInt(l.time),l.timems||(l.timems=1e3*d+""),l.humantime||(l.humantime=S.isoTime(d))),l.name&&(l.dirname=l.name.replace(/[^A-Za-z0-9_]/g,"-"),l.title=l.name),e&&(l.JSON=JSON.stringify(l,null,4).replace(/</g,"\\u003c")),o.template),c=(t=U(t=t.replace(/<!--\s*@include\s+(\S+)\s*-->/g,(e,t)=>"\x3c!-- include "+t+" --\x3e\n"+((o.theme.htmlDocIncludes||{})[t]||"")+"\n\x3c!-- end include --\x3e\n"),l),{html:t=o.locale?N(t,o.locale).text:t,theme:o.theme,filepath:o.filepath,versionPath:o.versionPath,ghEditURLs:o.ghEditURLs,params:l,TOC:o.TOC}),s=(I(c),new(y=y||T.requireMarked()).Renderer),a=(_(s),s.link);s.link=function(e,t,r){var i=new RegExp("^[/#]").test(e),n=i?"":"_blank";return i&&c.versionPath&&(e="/"+c.versionPath+e),a.call(s,e,t,r).replace(/^<a /,`<a ${n?`target="${n}"`:""} rel="nofollow noopener" `)};var r,i,n,u,d=T.requireDOMSanitizer();y.setOptions({renderer:s,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,sanitizer:d,smartLists:!0,smartypants:!0});let h=o.markdown,p=(o.repo&&(h+=`
\`\`\`package
${o.repo.name.replace(/^pxt-/,"")}=github:${o.repo.fullName}#${o.repo.tag||"master"}
\`\`\`
`),h=(h=h.replace(/^\s*https?:\/\/(\S+)\s*$/gm,(e,t)=>{for(var i of w){let r=i.rx.exec(t);if(r)return i.cmd.replace(/\$(\d+)/g,(e,t)=>r[parseInt(t)]||"")+"\n"}return e})).replace(/@([a-z]+)@/gi,(e,t)=>{var r=l[t];return!r&&o.throwOnError&&S.userError("unknown macro "+t),r||"unknown macro"}),y(h)),f=(p=(p=p.replace(/&lt;br\s*\/&gt;/gi,"<br/>")).replace(/(<img [^>]* src=")\/docs\/static\/([^">]+)"/g,(e,t,r)=>t+"/static/"+r+'"'),""),m=0;function g(e,t,r){let i=r;return e<=m&&(i=f+i,f="",m=0),i}p=p.replace(/<h(\d)[^>]+>\s*([~@])?\s*(.*?)<\/h\d>/g,(e,t,r,i)=>{var n,s=/^(\w+)\s+(.*)/.exec(i),i=s?s[1]:i,s=(s=s?s[2]:"",C(s)),i=C(i);if(t=parseInt(t),r){if("@"!=r)return i?(r=S.lookup(c.boxes,i))?(a=r.split("@BODY@"),n=g(t,f,a[0].replace("@ARGS@",s)),f=a[1],(a=r.match(/data-[^>\s]+/gi))&&0<=a.indexOf("data-inferred")&&(m=t),n):(o.throwOnError&&S.userError("Unknown box: ~ "+i),x("Unknown box: ~ "+i)):(r=f,f="",r);{let e=S.lookup(c.settings,i);if(null!=e)l[i]=s;else if(null==(e=S.lookup(c.macros,i)))return o.throwOnError&&S.userError("Unknown command: @"+i),x("Unknown command: @"+i);var a={ARGS:s,CMD:i};return g(t,f,P(e,a,["ARGS","CMD"]))}}return g(t,f,e)}),f&&(p+=f),l.title||(d=/<h1[^<>]*>([^<>]+)<\/h1>/.exec(p))&&(l.title=C(d[1])),l.description||(d=/<p>([^]+?)<\/p>/.exec(p))&&(l.description=C(d[1])),(d=/<div class="ui embed mdvid"[^<>]+?data-placeholder="([^"]+)"[^>]*\/?>/i.exec(p)||/<img class="ui [^"]*image" src="([^"]+)"[^>]*\/?>/i.exec(p))&&(l.cardLogo=C(d[1])),l.twitter=C(o.theme.twitter||"@msmakecode");let b={main:""};p=(p=p.replace(/<!-- BEGIN-ASIDE (\S+) -->([^]*?)<!-- END-ASIDE -->/g,(e,t,r)=>{var i=S.lookup(b,t);return b[t]=(i||"")+r,"\x3c!-- aside --\x3e"})).replace(/\n<\/code>/g,"</code>"),b.main=p,p="";for(r of Object.keys(b))p+=(i=r+"-container",n=b[r],P(c.boxes[i]||"@BODY@",{BODY:n},["BODY"]));l.body=p,l.name=l.title||"";for(u of Object.keys(o.theme)){var v=o.theme[u];"string"==typeof v&&(l["theme_"+u]=v)}return c.finish()},T.embedUrl=function(e,t,r,i){return`<div style="position:relative;height:0;padding-bottom:70%;overflow:hidden;"><iframe style="position:absolute;top:0;left:0;width:100%;height:100%;" src="${e+`#${t}:`+r}" frameborder="0" sandbox="allow-popups allow-forms allow-scripts allow-same-origin"></iframe></div>`},T.runUrl=function(e,t,r){return`<div style="position:relative;height:0;padding-bottom:${t};overflow:hidden;"><iframe style="position:absolute;top:0;left:0;width:100%;height:100%;" src="${e}?id=${encodeURIComponent(r)}" allowfullscreen="allowfullscreen" sandbox="allow-popups allow-forms allow-scripts allow-same-origin" frameborder="0"></iframe></div>`},T.codeEmbedUrl=function(e,t,r){return e=e+"---codeembed#pub:"+t,`<div style="position:relative;height:calc(${r=Math.ceil(r||300)}px + 5em);width:100%;overflow:hidden;"><iframe style="position:absolute;top:0;left:0;width:100%;height:100%;" src="${e}" allowfullscreen="allowfullscreen" frameborder="0" sandbox="allow-scripts allow-same-origin"></iframe></div>`};let o={b:1,strong:1,em:1};function N(e,i){let n={};function s(e){var t,e=/^(\s*)([^]*?)(\s*)$/.exec(e);let r=e[2].replace(/\s+/g," ");return""==r||/^((IE=edge,.*|width=device-width.*|(https?:\/\/|\/)[\w@\/\.]+|@[\-\w]+@|\{[^\{\}]+\}|[^a-zA-Z]*|(&nbsp;)+)\s*)+$/.test(r)?null:((t=S.lookup(i,r))?r=t:n[r]="",e[1]+r+e[3])}function a(e){return e.replace(/&llt;/g,"<").replace(/&ggt;/g,">")}return{text:e=(e=(e=(e="<start>"+(e=e.replace(/<([\/\w]+)([^<>]*)>/g,(e,t,r)=>{var i=t.replace(/^\//,"").toLowerCase();return 1===o[i]?"&llt;"+t+r+"&ggt;":e}))).replace(/(<([\/\w]+)([^<>]*)>)([^<>]+)/g,(e,t,r,i,n)=>"script"==r||"style"==r||null==(r=s(a(n)))?a(e):t+r)).replace(/(<[^<>]*)(content|placeholder|alt|title)="([^"]+)"/g,(e,t,r,i)=>null==s(i)?e:t+r+'="'+i.replace(/"/g,"''")+'"')).replace(/^<start>/g,""),missing:n}}function f(e,i){let t=0;var n,s=[{level:0,id:"",title:"",start:t,text:"",children:[]}],e=(e=e.replace(/\r/g,"")).split(/\n/);let a={};for(n of e){let e=/^\s*(#+)\s*(.*?)(#(\S+)\s*)?$/.exec(n),r=null;if(i&&e)if(e[4])if(a[e[4]])e=null;else{r=function e(t,r){if(t.id==r)return t;for(var i of t.children)if(i=e(i,r))return i;return null}(i,e[4]);let t=e=>{e.id&&(a[e.id]=!0),e.children.forEach(t)};r&&t(r)}else e=null;if(e){var o={level:i?1:e[1].length,title:e[2].trim(),id:e[4]||"",start:t,text:"",children:[]};if(r){n="";for(let e=0;e<r.level;++e)n+="#";n=(n=(n+=" ")+(o.title||r.title))+(" #"+o.id)}for(;s[s.length-1].level>=o.level;)s.pop();s[s.length-1].children.push(o),s.push(o)}s[s.length-1].text+=n+"\n",t++}return s[0]}T.translate=N,T.buildTOC=function(e){if(!e)return null;var t=p.docs.requireMarked(),r=T.requireDOMSanitizer(),r={renderer:new t.Renderer,gfm:!0,tables:!1,breaks:!1,pedantic:!1,sanitize:!0,sanitizer:r,smartLists:!1,smartypants:!1},i={name:"dummy",subitems:[]};let n=[],s=(n.push(i),t=t.lexer(e,r),!1);return t.forEach(e=>{switch(e.type){case"heading":e.depth;break;case"list_start":break;case"list_item_start":case"loose_item_start":s=!0;var t={name:"",path:"",subitems:[]};return void n.push(t);case"text":let i=n[n.length-1];0<=e.text.indexOf("[")?e.text.replace(/\[(.*?)\]\((.*?)\)/i,function(e,t,r){i.name=t,i.path=r.replace(".md","")}):s&&(i.name=e.text);break;case"list_item_end":case"loose_item_end":t=n.pop();n[n.length-1].subitems.push(t)}s=!1}),(e=i.subitems)&&0!=e.length?e:null};let h=!(T.visitTOC=function(e,t){e.forEach(function(e){t(e),e.subitems&&e.subitems.forEach(t)})});function m(e,t){function r(e,t,r){var i=m(e,t).trim();if(i!=(r=r.trim()))throw p.log(`*** Template:
${e}
*** Input:
${t}
*** Expected:
${r}
*** Output:
`+i),new Error("augment docs test fail")}if(h||(h=!0,r(n=`
# T0
## Examples #ex
### Example 1
TEx1
### Example 2 #ex2
TEx2
### Example 3
TEx3

## See also #also
TAlso
`,"",n),r(n," ",n),r(n,`
# @extends
# #ex2
My example
## See Also These! #also
My links
`,`
# T0
## Examples #ex
### Example 1
TEx1
### Example 2 #ex2
My example
### Example 3
TEx3

## See Also These! #also
My links
`),r(n,`
# @extends
### #ex
Foo
#### Example 1
Ex1
#### Example 2x #ex2
Ex2
## See Also These! #also
My links
`,`
# T0
## Examples #ex
Foo
#### Example 1
Ex1
#### Example 2x #ex2
Ex2
## See Also These! #also
My links
`)),!t)return e;var i,n=f(e,null),e=f(t,n);let s={},a={};for(i of e.children)S.assert(0==i.children.length),S.assert(!!i.id),s[i.id]=i.text;let o=e=>{e.id&&void 0!==s[e.id]&&(a[e.id]=!0,e.text=s[e.id],e.children=[]),e.children.forEach(o)},l=(o(n),""),c=e=>{l+=e.text,e.children.forEach(c)},u=(c(n),"");var d,t=e.text.replace(/^\s*#+\s*@extends.*/gm,"").replace(/^\s*\n/gm,"");t.trim()&&(u+=t.trim()+"\n");for(d of e.children)a[d.id]||(u+=d.text);return u&&(l+="## Couldn't apply replacement logic to:\n"+u),l}T.augmentDocs=m}})(pxt=pxt||{}),(e=>{(e.dom||(e.dom={})).el=function(e,t,r){let i=document.createElement(e);return t&&Object.keys(t).forEach(e=>i.setAttribute(e,t[e]+"")),function t(e){Array.isArray(e)?e.forEach(e=>t(e)):"string"==typeof e?i.appendChild(document.createTextNode(e)):e instanceof HTMLElement&&i.appendChild(e)}(r),i}})(pxt=pxt||{}),(c=>{var e;function u(e){e=/```package\s+((.|\s)+?)\s*```/i.exec(e);let t=void 0;return e&&(t={},e[1].split("\n").map(e=>e.replace(/\s*/g,"")).filter(e=>!!e).map(e=>e.split("=")).forEach(e=>t[e[0]]=e[1]||"*")),t}function d(e){e=/```config\s+((.|\s)+?)\s*```/i.exec(e);let t=[];return e&&e[1].split("\n").map(e=>e.replace(/\s*/g,"")).filter(e=>!!e).map(e=>e.split("=")).filter(e=>"feature"==e[0]&&!!e[1]).forEach(e=>t.push(e[1])),t.length?t:void 0}function h(e){var t,e=/```jres\s+((.|\s)+?)\s*```/i.exec(e);if(e)return e=e[1],t=JSON.parse(e),{jres:e,ts:c.emitTilemapsFromJRes(t)}}function p(e){e=/```assetjson\s+((.|\s)+?)\s*```/i.exec(e);return e?c.tutorial.parseAssetJson(e[1]):{}}function f(e){e=/```simtheme\s+([\s\S]*?)```/i.exec(e);return e?c.tutorial.parseSimThemeJson(e[1]):{}}function a(e){let t=c.Util.jsonTryParse(e);return null!=(t=t&&!Array.isArray(t)?[t]:t)&&t.length||null!=(t=e.split(/^---$/gm).filter(e=>!!e).map(e=>{let n={};return e.replace(/^\s*(?:-|\*)\s+(\w+)\s*:\s*(.*)$/gm,(e,t,r)=>{var i;return"flags"==t?n[t]=r.split(","):"otherAction"===t?(i=r.split(",").map(e=>null==e?void 0:e.trim()),(n.otherActions||(n.otherActions=[])).push({url:i[0],editor:i[1],cardType:i[2]})):n[t]=r,""}),!!Object.keys(n).length&&n}).filter(e=>!!e))&&t.length?t:void 0}function t(e){if(!e)return[];let r=[],i=!1,n=void 0,s="";return e.split(/\r?\n/).forEach(e=>{var t;/^## /.test(e)?n=e.substr(2).trim():/^(### ~ |```)codecard$/.test(e)?i=!0:/^(### ~|```)$/.test(e)?(i=!1,n&&s&&(null!=(t=a(s))&&t.length?r.push({name:n,cards:t}):c.log("invalid gallery format")),s="",n=void 0):i&&(s+=e+"\n")}),r.forEach(e=>e.cards.forEach(t=>{var e;!t.otherActions||t.otherActions.length||"tutorial"!=t.cardType&&"example"!=t.cardType||(e=["js"],c.appTarget.appTheme.python&&e.unshift("py"),t.otherActions=e.map(e=>({url:t.url,cardType:t.cardType,editor:e})))})),r}(e=c.gallery||(c.gallery={})).parsePackagesFromMarkdown=u,e.parseFeaturesFromMarkdown=d,e.parseJResFromMarkdown=h,e.parseTemplateProjectJSON=p,e.parseSimThemeJSON=f,e.parseExampleMarkdown=function(e,t){if(t){var r,i,n,s,a,o,l=/```(blocks?|typescript|python|spy|sim)\s+((.|\s)+?)\s*```/i.exec(t);if(l)return r=u(t),i=l[1],n=l[2],s=d(t),a=h(t),o=f(t),(e={name:e,filesOverride:{[c.MAIN_BLOCKS]:'<xml xmlns="http://www.w3.org/1999/xhtml"></xml>',["python"===l[1]?c.MAIN_PY:c.MAIN_TS]:n},dependencies:r,features:s,snippetType:i,source:n,simTheme:o}).filesOverride=Object.assign(Object.assign({},e.filesOverride),p(t)),a&&(e.filesOverride[c.TILEMAP_JRES]=a.jres,e.filesOverride[c.TILEMAP_CODE]=a.ts),e}},e.parseCodeCards=a,e.parseCodeCardsHtml=function(e){let t=[],r;return Array.from(e.children).forEach(e=>{"UL"===e.tagName||"OL"===e.tagName?(r=r||{},Array.from(e.querySelectorAll("li")).forEach(e=>{var t,e=e.innerText,e=/^\s*(\w+)\s*:\s*(.*)$/.exec(e);e&&(t=e[1],r[t]=e[2].trim(),"flags"===t)&&(r[t]=r[t].split(/,\s*/))})):"HR"==e.tagName&&(r&&t.push(r),r=void 0)}),r&&t.push(r),!(null==(t=0===t.length&&"CODE"===e.tagName?c.Util.jsonTryParse(e.textContent):t)||!t.length)&&t},e.parseGalleryMardown=t,e.loadGalleryAsync=function(e){return c.Cloud.markdownAsync(e).then(e=>t(e))},e.codeCardsToMarkdown=function(e){return`### ~ codecard

${(e||[]).map(t=>Object.keys(t).filter(e=>!!t[e]).map(e=>"otherActions"===e?t[e].map(e=>`* otherAction: ${e.url}, ${e.editor||""}, `+(e.cardType||"")).join("\n"):`* ${e}: `+t[e]).join("\n")).join(`

---

`)}

### ~
`}})(pxt=pxt||{}),(o=>{class e{constructor(e){this.io=e,this.q=new o.U.PromiseQueue,this.dataBuf="",this.numSent=0,this.pktSize=400,this.trace=!1,this.bmpMode=!0,this.targetInfo="",this.onEvent=e=>{},this.io.onData=e=>this.onData(e)}onData(e){for(this.dataBuf+=o.U.uint8ArrayToString(e);0<this.dataBuf.length;){var t=this.dataBuf[0];if("+"==t)this.dataBuf=this.dataBuf.slice(1);else if("$"==t||"%"==t){var r=this.decodeResp(this.dataBuf.slice(1));if(null==r)break;"$"==t?(this.io.sendPacketAsync(this.buildCmd("+")),this.onResponse?this.onResponse(r):0<this.numSent&&this.io.error("unexpected response: "+r)):this.onEvent(r)}else this.io.error("invalid character: "+t)}}buildCmd(t){if("+"==t)return o.U.stringToUint8Array(t);let r="";for(let e=0;e<t.length;++e){var i=t.charAt(e);"}"==i||"#"==i||"$"==i?r=(r+="}")+String.fromCharCode(32^i.charCodeAt(0)):r+=i}let n=0;t=r;for(let e=0;e<t.length;++e)n=n+t.charCodeAt(e)&255;return r="$"+t+"#"+("0"+n.toString(16)).slice(-2),o.U.stringToUint8Array(r)}decodeResp(r){let i="";for(let t=0;t<r.length;++t){var e=r[t];if("}"==e)++t,i+=String.fromCharCode(32^r.charCodeAt(t));else if("*"==e){++t;let e=r.charCodeAt(t)-29;for(var n=i.charAt(i.length-1);0<e--;)i+=n}else{if("#"==e)return 2==r.slice(t+1,t+3).length?(this.dataBuf=r.slice(t+3),i):null;i+=e}}return null}sendCmdOKAsync(e){return this.sendCmdAsync(e,e=>"OK"==e)}error(e){this.io.error(e),this.io.disconnectAsync()}sendCmdAsync(r,i){this.numSent++;let e=this.buildCmd(r);return this.q.enqueue("one",()=>null===i?this.io.sendPacketAsync(e).then(()=>null):new Promise(t=>{this.onResponse=e=>{this.onResponse=null,this.trace&&o.log(`GDB: '${r}' -> '${e}'`),void 0===i||i(e)||this.error(`Invalid GDB command response: '${r}' -> '${e}'`),t(e)},this.io.sendPacketAsync(e)}))}sendRCmdAsync(e){return this.sendMCmdAsync("qRcmd,"+o.U.toHex(o.U.stringToUint8Array(e)))}sendMCmdAsync(i){this.numSent++;let e=this.buildCmd(i),n="";return this.q.enqueue("one",()=>new Promise(r=>{this.onResponse=e=>{var t;"OK"!=e&&"O"==e[0]?n+=(t=e.slice(1),o.U.uint8ArrayToString(o.U.fromHex(t))):("OK"!=e&&(n+=" - "+e),this.onResponse=null,this.trace&&o.log(`Final GDB: '${i}' -> '${n}'`),r(n))},this.io.sendPacketAsync(e)}))}write32Async(e,t){var r=new Uint8Array(4);return o.HF2.write32(r,0,t),this.writeMemAsync(e,r)}writeMemAsync(e,t){var r=this.pktSize/2-10;return o.U.assert(t.length<r),this.sendCmdOKAsync("M"+e.toString(16)+","+t.length.toString(16)+":"+o.U.toHex(t)).then(e=>{o.log(e)})}readMemAsync(e,s){let a=this.pktSize/2-6;if(s>a){let i=new Uint8Array(s),n=t=>{let r=Math.min(s-t,a);return 0==r?Promise.resolve(i):this.readMemAsync(e+t,r).then(e=>(o.U.memcpy(i,t,e),n(t+r)))};return n(0)}return this.sendCmdAsync("m"+e.toString(16)+","+s.toString(16)).then(e=>o.U.fromHex(e))}initBMPAsync(){return Promise.resolve().then(()=>this.sendRCmdAsync("swdp_scan")).then(e=>(this.targetInfo=e,this.sendCmdAsync("vAttach;1",e=>"T"==e[0]))).then(()=>{})}initAsync(){return o.U.delay(1e3).then(()=>this.sendCmdAsync("!")).then(()=>this.sendCmdAsync("qSupported")).then(e=>{let i={};return e=(e=";"+e+";").replace(/;([^;]+)[=:]([^:;]+)/g,(e,t,r)=>(i[t]=r,";")),this.pktSize=parseInt(i.PacketSize)||1024,o.log("GDB-server caps: "+JSON.stringify(i)+" "+e.replace(/;+/g,";")),this.bmpMode?this.initBMPAsync():this.sendCmdAsync("c").then(()=>{})})}}o.GDBServer=e})(pxt=pxt||{}),(c=>{var e;{var o=c.github||(c.github={});function l(){var e;return!!o.forceProxy||!(c.U.isNodeJS||null!=(e=null==(e=null==c?void 0:c.appTarget)?void 0:e.cloud)&&e.noGithubProxy)}o.token=null,o.forceProxy=!1;let n={};function u(n){var e;return n.method=null!=(e=n.method)?e:"GET",function r(e){var t;let i=c.U.clone(n);o.token&&(i.headers||(i.headers={}),i.url==a?i.headers.Authorization="bearer "+o.token:(i.url=c.BrowserUtils.cacheBustingUrl(i.url),i.headers.Authorization="token "+o.token));i.allowHttpErrors=null!=(t=i.allowHttpErrors)&&t;return c.U.requestAsync(i).catch(t=>{if(c.tickEvent("github.error",{statusCode:t.statusCode}),o.handleGithubNetworkError){let e=o.handleGithubNetworkError(i,t);if(e)return r(!1)}throw t})}(o.token)}function d(e){return u({url:e,method:"GET"}).then(e=>e.json)}function h(e){return c.Cloud.apiRequestWithCdnAsync({url:"gh/"+e,forceLiveEndpoint:!0}).then(e=>e.json)}function p(e){c.log("github proxy error: "+e.message),c.debug(e)}o.isOrgAsync=function(e){return u({url:"https://api.github.com/orgs/"+e,method:"GET",allowHttpErrors:!0}).then(e=>200==e.statusCode)};class M{constructor(){this.latestVersions={},this.configs={},this.packages={}}proxyWithCdnLoadPackageAsync(e,t){let r=e+"/"+t;var i=this.packages[r];return i?(c.debug(`github cache ${e}/${t}/text`),Promise.resolve(i)):h(U((i=C(e)).slug,t,i.fileName,"text")).then(e=>this.packages[r]={files:e})}cacheConfig(e,t){t=c.Package.parseAndValidConfig(t);return this.configs[e]=t,c.U.clone(t)}async loadConfigAsync(e,t){t||(c.debug("dep: default to master branch"),t="master");var r=e+"/"+t,i=this.configs[r];if(i)return c.debug(`github cache ${e}/${t}/config`),c.U.clone(i);if(l())try{var n=await this.proxyWithCdnLoadPackageAsync(e,t);return this.cacheConfig(r,n.files[c.CONFIG_NAME])}catch(e){p(e)}i=await m(e,t,c.CONFIG_NAME);return this.cacheConfig(r,i)}async latestVersionAsync(e,t){let r=this.latestVersions[e];return r||(c.debug("dep: resolve latest version of "+e),this.latestVersions[e]=r=await c.github.latestVersionAsync(e,t,!0,!1)),r}async loadPackageAsync(e,t){if(t||(c.debug("load pkg: default to master branch"),t="master"),l())try{return await this.proxyWithCdnLoadPackageAsync(e,t).then(e=>c.U.clone(e))}catch(e){p(e)}return this.githubLoadPackageAsync(e,t)}githubLoadPackageAsync(n,r){return w(n,r).then(i=>{let t=n+"/"+i;var e=this.packages[t];return e?(c.debug(`github cache ${n}/${r}/text`),Promise.resolve(c.U.clone(e))):(c.log(`Downloading ${n}/${r} -> `+i),m(n,i,c.CONFIG_NAME).then(e=>{let r={files:{}};r.files[c.CONFIG_NAME]=e;e=JSON.parse(e);return c.U.promiseMapAll(c.allPkgFiles(e).slice(1),t=>m(n,i,t).then(e=>{r.files[t]=e})).then(()=>(this.packages[t]=r,c.U.clone(r)))}))})}async loadTutorialMarkdown(e,t){e=(await r(e=L(e),t)).resp,t=e.markdown;return c.Util.assert("object"==typeof t),await this.cacheReposAsync(e),t.repo}async cacheReposAsync(e){var t,r;"object"==typeof e.markdown&&(t=e.markdown,this.cacheRepo(t.repo));for(r of e.dependencies)this.cacheRepo(r)}cacheRepo(e){let t=e.repo;e.subPath&&(t+="/"+e.subPath);var r=t,i=(this.packages[r+="/"+e.sha]={files:e.files},e.latestVersion&&this.cacheLatestVersion(t,e.latestVersion),e.files["pxt.json"]);i&&(e=r+"/"+(e.version||"master"),this.cacheConfig(r,i),this.cacheConfig(e,i))}cacheLatestVersion(e,t){this.latestVersions[e]=t}}function f(t,e,r){return u({url:"https://api.github.com/repos/"+U(t.slug,"contents",t.fileName,r+"?ref="+e),method:"GET"}).then(e=>{e=e.json;return n[t.slug]=!0,e&&"base64"==e.encoding&&null!=e.content?c.Util.fromUTF8(atob(e.content)):c.U.httpGetTextAsync(e.download_url)})}function m(e,t,r){let i=C(e);return n[i.slug]?f(i,t,r):c.U.requestAsync({url:"https://raw.githubusercontent.com/"+U(i.slug,t,i.fileName,r),allowHttpErrors:!0}).then(e=>200==e.statusCode?e.text:f(i,t,r))}async function r(e,t,r,i){let n=c.Cloud.apiRequestWithCdnAsync;var s=new URLSearchParams;t&&s.set("ref",t),r&&(s.set("noCache","1"),n=c.Cloud.privateRequestAsync);t=c.BrowserUtils.appendUrlQueryParams("ghtutorial/"+e,s),r=await n({url:t,method:"GET",headers:i?{"If-None-Match":i}:void 0});let a;return{resp:a=304===r.statusCode?void 0:r.json,etag:r.headers.etag}}function g(e,t,r,i){return u({url:/^https:/.test(e)?e:"https://api.github.com/repos/"+e,headers:r,method:i||"POST",data:t,successCodes:[200,201,202,204]}).then(e=>e.json)}function b(e,t){let r=1;for(;e.refs[t+r];)r++;return t+r}async function v(e,t,r){return await g(e+"/git/refs",{ref:"refs/heads/"+t,sha:r}),t}function y(e,r="tags",t,i){e=C(e),t=t,t=!!o.forceProxy||!(o.token&&!t)&&l();let n=null;t=t?c.U.httpGetJsonAsync(c.BrowserUtils.cacheBustingUrl(`${c.Cloud.apiRoot}gh/${e.slug}/refs`+(i?"?nocache=1":""))).then(t=>{var e=Object.keys(t.refs).filter(e=>c.U.startsWith(e,"refs/"+r+"/")).map(e=>({ref:e,object:{sha:t.refs[e]}}));return n=t.refs.HEAD,e}):d(`https://api.github.com/repos/${e.slug}/git/refs/${r}/?per_page=100`);let s=e=>e.replace(/^refs\/[^\/]+\//,"");return t.then(e=>{e.sort((e,t)=>c.semver.strcmp(s(e.ref),s(t.ref)));var t,r={};for(t of e)r[s(t.ref)]=t.object.sha;return{refs:r,head:n}},e=>404==e.statusCode?{refs:{}}:Promise.reject(e))}function i(e){return"commit"==e.object.type?Promise.resolve(e.object.sha):"tag"==e.object.type?d(e.object.url).then(e=>"commit"==e.object.type?e.object.sha:Promise.reject(new Error("Bad type (2nd order) "+e.object.type))):Promise.reject(new Error("Bad type "+e.object.type))}function w(e,t){if(/^[a-f0-9]{40}$/.test(t))return Promise.resolve(t);let r=C(e);return d(`https://api.github.com/repos/${r.slug}/git/refs/tags/`+t).then(i,e=>d(`https://api.github.com/repos/${r.slug}/git/refs/heads/`+t).then(i))}async function A(e,t,r){return t=t||await o.db.latestVersionAsync(e,r),o.db.loadConfigAsync(e,t)}async function k(e,t){var r,i=C(e);if(i){if(!T(i,t))return i.tag||(i.tag=await o.db.latestVersionAsync(i.slug,t)),i=await o.db.loadPackageAsync(i.fullName,i.tag),(t=N(t,e))&&(r=c.Package.parseAndValidConfig(i.files[c.CONFIG_NAME]))&&(c.log(`auto-disable ${t.join(",")} due to targetconfig entry for `+e),r.disablesVariants=t,i.files[c.CONFIG_NAME]=c.Package.stringifyConfig(r)),i;c.tickEvent("github.download.banned"),c.log("Github repo is banned")}else c.log("Unknown GitHub syntax")}o.MemoryGithubDb=M,o.downloadTextAsync=m,o.downloadMarkdownTutorialInfoAsync=r,o.downloadTutorialMarkdownAsync=async function(e,t){return o.db.loadTutorialMarkdown(e,t)},o.db=new M,o.authenticatedUserAsync=function(){return o.token?d("https://api.github.com/user"):Promise.resolve(void 0)},o.getCommitsAsync=function(e,t){return d("https://api.github.com/repos/"+C(e).slug+"/commits?sha="+t).then(e=>e.map(e=>{var t=e.commit;return t.url=e.url,t.sha=e.sha,t}))},o.getCommitAsync=function(e,t){return d("https://api.github.com/repos/"+C(e).slug+"/git/commits/"+t).then(t=>d(t.tree.url+"?recursive=1").then(e=>(t.tree=e,t)))},o.createObjectAsync=function(e,t,r){return g(C(e).slug+"/git/"+t+"s",r).then(e=>e.sha)},o.postCommitComment=function(e,t,r,i,n){return g(C(e).slug+`/commits/${t}/comments`,{body:r,path:i,position:n}).then(e=>e.id)},o.fastForwardAsync=async function(e,t,r){return 200==(await u({url:`https://api.github.com/repos/${C(e).slug}/git/refs/heads/`+t,method:"PATCH",allowHttpErrors:!0,data:{sha:r,force:!1}})).statusCode},o.putFileAsync=async function(e,t,r){e=C(e),await u({url:"https://api.github.com/repos/"+c.github.join(e.slug,"contents",e.fileName,t),method:"PUT",allowHttpErrors:!0,data:{message:lf("Initialize empty repo"),content:btoa(c.U.toUTF8(r)),branch:"master"},successCodes:[201]})},o.createTagAsync=async function(e,t,r){await g(e+"/git/refs",{ref:"refs/tags/"+t,sha:r})},o.createReleaseAsync=async function(e,t,r){await g(e+"/releases",{tag_name:t,target_commitish:r,name:t,draft:!1,prerelease:!1})},o.createPRFromBranchAsync=async function(e,t,r,i,n){return null==(e=await g(e+"/pulls",{title:i,body:n||lf("Automatically created from MakeCode."),head:r,base:t,maintainer_can_modify:!0}))?void 0:e.html_url},o.mergeAsync=function(t,e,r,i){return u({url:`https://api.github.com/repos/${C(t).slug}/merges`,method:"POST",successCodes:[201,204,409],data:{base:e,head:r,commit_message:i}}).then(e=>{if(201==e.statusCode||204==e.statusCode)return e.json.sha;if(409==e.statusCode)return null;throw c.U.userError(lf("Cannot merge in github.com/{1}; code: {2}",t,e.statusCode))})},o.getRefAsync=function(e,t){return d("https://api.github.com/repos/"+e+"/git/refs/heads/"+(t=t||"master")).then(i).catch(e=>{404!=e.statusCode&&Promise.reject(e)})},o.getNewBranchNameAsync=async function(e,t="patch-"){return b(await y(e,"heads"),t)},o.createNewBranchAsync=v,o.forkRepoAsync=async function(e,t,r="pr-"){var i=E(await g((e=C(e)).slug+"/forks",{}),{fullName:e.fullName,fileName:e.fileName}),n=Date.now()+3e5;let s=null;for(;!s&&Date.now()<n;){await c.U.delay(1e3);try{s=await y(i.slug,"heads")}catch(e){}}if(s)return e=b(s,r),await v(i.slug,e,t),i.fullName+"#"+e;throw new Error(lf("Timeout waiting for fork"))},o.listRefsAsync=function(e,t="tags",r,i){return y(e,t,r,i).then(e=>Object.keys(e.refs))},o.listRefsExtAsync=y,o.pkgConfigAsync=A,o.downloadPackageAsync=k,o.downloadLatestPackageAsync=async function(e,t,r){var i=await c.packagesConfigAsync(),t=await c.github.latestVersionAsync(e.slug,i,t,r),r=e.fullName+"#"+t,e=(await c.github.downloadPackageAsync(r,i),await A(e.fullName,t,i));return{version:"github:"+r,config:e}},o.cacheProjectDependenciesAsync=async function(i){var e=null==(e=Object.keys(i.dependencies))?void 0:e.filter(e=>I(i.dependencies[e]));if(e.length){let r=await c.packagesConfigAsync();await Promise.all(e.map(async e=>{var t=i.dependencies[e];if(!await k(t,r))throw new Error(lf("Cannot load extension {0} from {1}",e,t))}))}};let s;function t(e){return c.Cloud.cdnApiUrl(`gh/${e.fullName}/icon`)}function E(e,t){var r;if(e)return(r={owner:e.owner.login.toLowerCase(),slug:e.full_name.toLowerCase(),fullName:((null==t?void 0:t.fullName)||e.full_name).toLowerCase(),fileName:null==(r=null==t?void 0:t.fileName)?void 0:r.toLocaleLowerCase(),name:e.name,description:e.description,defaultBranch:e.default_branch,tag:null==t?void 0:t.tag,updatedAt:Math.round(new Date(e.updated_at).getTime()/1e3),fork:e.fork,private:e.private}).status=x(r,null==t?void 0:t.config),r}function x(e,t){return e?T(e,t)?s.Banned:((e,t)=>{var r;return!(!((t,e)=>!(!t||!e||!(t.owner&&e.approvedOrgs&&e.approvedOrgs.some(e=>e.toLowerCase()==t.owner.toLowerCase()))))(e,t)&&(r=null==(r=null==e?void 0:e.fullName)?void 0:r.toLowerCase(),e=null==(e=null==e?void 0:e.slug)?void 0:e.toLowerCase(),null==t||!t.approvedRepoLib||!r&&!e||!t.approvedRepoLib[r]&&!t.approvedRepoLib[e]))})(e,t)?s.Approved:s.Unknown:s.Unknown}function T(e,i){var t,n;if(t=e,!(!(n=i)||t&&t.owner&&(!n.bannedOrgs||!n.bannedOrgs.some(e=>e.toLowerCase()==t.owner.toLowerCase()))))return 1;if(i){if(!e)return 1;let t=null==(n=e.fullName)?void 0:n.toLowerCase(),r=null==(n=e.slug)?void 0:n.toLowerCase();return!(!i.bannedRepos||!i.bannedRepos.some(e=>e&&(e.toLowerCase()==t||e.toLowerCase()==r)))}}async function S(e,t){e=C(e);if(e){var r,i,n=x(e,t);if(n!=s.Banned){if(l())try{return i=n,await h((r=e).slug).then(e=>{if(e)return{github:!0,owner:r.owner,fullName:r.fullName,fileName:r.fileName,slug:r.slug,name:r.fileName?e.name+"-"+r.fileName:e.name,description:e.description,defaultBranch:e.defaultBranch||"master",tag:r.tag,status:i}}).catch(e=>{c.reportException(e)})}catch(e){p(e)}return E(await d("https://api.github.com/repos/"+e.slug),{config:t,fullName:e.fullName,fileName:e.fileName,tag:e.tag})}}}function C(t){if(t){t=(t=t.trim()).replace(/\/$/,"");var r=/^https:\/\/([^./#]+)\.github\.io\/([^/#]+)\/?$/i.exec(t),r=(t=(t=(t=(t=r?`github:${r[1]}/`+r[2]:t).replace(/^github:/i,"")).replace(/^https:\/\/github\.com\//i,"")).replace(/\.git\b/i,""),/^([^#\/:]+)\/([^#\/:]+)(\/([^#]+))?(#([^\/:]*))?$/.exec(t));if(r){var t=r[1],i=r[2];let e=r[4];var r=r[6],n=e&&/^tree\/([^\/]+\/)/.exec(e);return n&&(e=e.slice(n[0].length)),{owner:t,project:i,slug:U(t,i),fullName:U(t,i,e),tag:r,fileName:e}}}}function I(e){return!!e&&"github:"==e.slice(0,7)}function _(e,t=!1){return e?"github:"+(t?e.fullName:e.fullName.toLowerCase())+(e.tag?"#"+e.tag:""):void 0}function U(...e){return e.filter(e=>!!e).join("/")}function P(e,t){return e&&(t=C(t))?(e.approvedRepoLib,e.approvedRepoLib&&(null==(e=c.U.lookup(e.approvedRepoLib,t.slug.toLowerCase()))?void 0:e.upgrades)):null}function N(e,t){e=P(e,t)||[];if(e)for(var r of e){var r=/^dv:(.*)/.exec(r);if(r)return(r=r[1].split(/,/)).some(e=>!/^\w+$/.test(e))?null:r}return null}function O(e,s,t,r){let a=C(e);return a?S(a.slug,s).then(n=>{if(n)return y(n.slug,"tags",t,r).then(e=>{var r=Object.keys(e.refs),r=c.semver.sortLatestTags(r),i=c.appTarget.versions&&c.semver.tryParse(c.appTarget.versions.target);if(i&&s.releases&&s.releases["v"+i.major]){let t=s.releases["v"+i.major].map(e=>c.github.parseRepoId(e)).filter(e=>e&&e.fullName.toLowerCase()==a.fullName.toLowerCase())[0];if(t){if(r.some(e=>e==t.tag))return c.debug(`approved release ${t.fullName}#${t.tag} for v`+i.major),Promise.resolve(t.tag);c.reportError("packages",`approved release ${t.fullName}#${t.tag} for v${i.major} not found anymore`,{repo:n.fullName})}}return r[0]?Promise.resolve(r[0]):e.head||w(n.slug,n.defaultBranch)})}):Promise.resolve(null)}(e=s=o.GitRepoStatus||(o.GitRepoStatus={}))[e.Unknown=0]="Unknown",e[e.Approved=1]="Approved",e[e.Banned=2]="Banned",o.isDefaultBranch=function(e,t){return t&&t.defaultBranch?e===t.defaultBranch:/^(main|master)$/.test(e)},o.listUserReposAsync=function(){return R(`{
  viewer {
    repositories(first: 100, affiliations: [OWNER, COLLABORATOR], orderBy: {field: PUSHED_AT, direction: DESC}) {
      nodes {
        name
        description
        full_name: nameWithOwner
        private: isPrivate
        fork: isFork
        updated_at: updatedAt
        owner {
          login
        }
        defaultBranchRef {
          name
        }
        pxtjson: object(expression: "HEAD:pxt.json") {
          ... on Blob {
            text
          }
        }
        readme: object(expression: "HEAD:README.md") {
          ... on Blob {
            text
          }
        }
      }
    }
  }
}`).then(e=>e.data.viewer.repositories.nodes.filter(e=>e.pxtjson).filter(e=>{e.default_branch=e.defaultBranchRef.name;var t=c.Package.parseAndValidConfig(e.pxtjson&&e.pxtjson.text),e=e.readme&&e.readme.text;return!!t&&(t.supportedTargets?-1<t.supportedTargets.indexOf(c.appTarget.id):e&&-1<e.indexOf("PXT/"+c.appTarget.id))}).map(e=>E(e,{fullName:e.full_name})))},o.createRepoAsync=function(e,t,r){return g("https://api.github.com/user/repos",{name:e,description:t,private:!!r,has_issues:!0,has_projects:!1,has_wiki:!1,allow_rebase_merge:!1,allow_merge_commit:!0,delete_branch_on_merge:!1}).then(e=>E(e))},o.enablePagesAsync=async function(e){var t=C(e);let r=void 0;try{var i=await d(`https://api.github.com/repos/${t.slug}/pages`);i&&(r=i.html_url)}catch(e){}if(!r)try{var n=await g(`https://api.github.com/repos/${t.slug}/pages`,{source:{branch:"master",path:"/"}},{Accept:"application/vnd.github.switcheroo-preview+json"});r=n.html_url}catch(e){c.tickEvent("github.pages.error"),c.reportException(e)}if(r){i=await d("https://api.github.com/repos/"+e);if(i&&!i.homepage)try{await g("https://api.github.com/repos/"+e,{homepage:r},void 0,"PATCH")}catch(e){c.tickEvent("github.homepage.error")}}},o.repoIconUrl=function(e){if(e.status==s.Approved)return t(e)},o.mkRepoIconUrl=t,o.repoStatus=x,o.isRepoHidden=function(e,t){var r;return!(e&&t&&(r=null==(r=e.fullName)?void 0:r.toLowerCase(),e=null==(e=e.slug)?void 0:e.toLowerCase(),!(r=t.approvedRepoLib[r]||t.approvedRepoLib[e])||!r.hidden))},o.repoAsync=S,o.searchAsync=function(e,t){var r;return t?0<(r=e.split("|").map(C).filter(e=>!!e)).length?Promise.all(r.map(e=>S(e.fullName,t))).then(e=>e.filter(e=>e&&e.status!=s.Banned)):c.U.httpGetJsonAsync(`${c.Cloud.apiRoot}ghsearch/${c.appTarget.id}/${c.appTarget.platformid||c.appTarget.id}?q=`+encodeURIComponent(e)).then(e=>e.items.map(e=>E(e,{config:t,fullName:e.full_name})).filter(e=>e.status==s.Approved||t.allowUnapproved&&e.status==s.Unknown).filter(e=>!c.appTarget.appTheme.githubUrl||"https://github.com/"+e.fullName!=c.appTarget.appTheme.githubUrl.toLowerCase())).catch(e=>[]):Promise.resolve([])},o.parseRepoId=C,o.toGithubDependencyPath=function(e,t){let r="github:"+e;return t&&(r+="#"+t),r},o.isGithubId=I,o.stringifyRepo=_,o.normalizeRepoId=function(e,t){if(e=C(e))return!e.tag&&t&&(e.tag=t),_(e)},o.join=U,o.upgradedPackageReferenceAsync=async function e(t,r){var i,n=P(t,r);if(!n)return null;for(i of n){var s=/^move:(.*)$/.exec(i);if(s){if(o=C(s[1]))return o.tag||(o.tag=await O(s[1],t)),l=C(r),!o.fileName&&l.fileName&&(o.fileName=l.fileName,o.fullName=U(o.owner,o.project,o.fileName)),l=_(o),c.debug(`upgrading ${r} to ${l}}`),await e(t,l)||l;c.log("cannot parse move target: "+s[1])}var a,o,l=(o=/^min:(.*)/.exec(i))&&c.semver.tryParse(o[1]);if(l)return s=C(r),(a=c.semver.tryParse(s.tag))&&c.semver.cmp(a,l)<0?(s.tag=o[1],c.debug(`upgrading ${r} to `+o[1]),_(s)):(a||c.log(`not upgrading ${r} - cannot parse version`),null);N(t,r)||c.log(`invalid upgrade rule: ${r} -> `+i)}return r},o.upgradedPackageId=function(e,t){return(e=N(e,t))?t+"?dv="+e.join(","):t},o.latestVersionAsync=O,o.resolveMonoRepoVersions=function(r){r=c.Util.clone(r);let i={};return Object.keys(r).map(e=>({id:e,ghid:o.parseRepoId(r[e])})).filter(e=>null==(e=e.ghid)?void 0:e.tag).forEach(e=>{var t=e.ghid;let r=i[t.slug];(r=r||(i[t.slug]={tag:t.tag,deps:[]})).deps.push(e),c.semver.strcmp(r.tag,t.tag)<0&&(c.debug("dep: resolve later monorepo tag to "+c.github.stringifyRepo(t)),r.tag=t.tag)}),c.U.values(i).forEach(t=>t.deps.forEach(e=>{e.ghid.tag!==t.tag&&(c.debug(`dep: ${c.github.stringifyRepo(e.ghid)} -> `+t.tag),e.ghid.tag=t.tag,r[e.id]=c.github.stringifyRepo(e.ghid))})),r},o.GIT_JSON=".git.json";let a="https://api.github.com/graphql";function R(e){e=JSON.stringify({query:e});return g(a,e)}function L(e){var t;return/^github\:/i.test(e)&&(e=e.slice(7)),e=/^https?\:/i.test(e)&&(e=new URL(e).pathname.slice(1),t=/^((?:[^\/]+\/){2})blob\/[^\/]+\/(.*)\.md$/.exec(e))?t[1]+t[2]:e}o.lookupFile=function(e,t,r){if(!t)return null;let i=U(e.fileName,r);return t.tree.tree.find(e=>e.path==i)},o.ghGraphQLQueryAsync=R,o.findPRNumberforBranchAsync=function(e,t){return e=C(e),R(`
{
    repository(owner: ${JSON.stringify(e.owner)}, name: ${JSON.stringify(e.project)}) {
        pullRequests(last: 1, states: [OPEN, MERGED], headRefName: ${JSON.stringify(t)}) {
            edges {
                node {
                    number
                    state
                    mergeable
                    baseRefName
                    url
                    isDraft
                }
            }
        }
    }
}
`).then(e=>{var e=e.data.repository.pullRequests.edges[0];return e&&e.node?{number:(e=e.node).number,mergeable:e.mergeable,state:e.state,title:e.title,url:e.url,base:e.baseRefName}:{number:-1}})},o.getPagesStatusAsync=function(e){return d(`https://api.github.com/repos/${e}/pages`).catch(e=>({status:null}))},o.normalizeTutorialPath=L}})(pxt=pxt||{}),(e=>{e.REFCNT_FLASH="0xfffe",e.VTABLE_MAGIC=249,e.ValTypeObject=4,(e=e.BuiltInType||(e.BuiltInType={}))[e.BoxedString=1]="BoxedString",e[e.BoxedNumber=2]="BoxedNumber",e[e.BoxedBuffer=3]="BoxedBuffer",e[e.RefAction=4]="RefAction",e[e.RefImage=5]="RefImage",e[e.RefCollection=6]="RefCollection",e[e.RefRefLocal=7]="RefRefLocal",e[e.RefMap=8]="RefMap",e[e.RefMImage=9]="RefMImage",e[e.MMap=10]="MMap",e[e.BoxedString_SkipList=11]="BoxedString_SkipList",e[e.BoxedString_ASCII=12]="BoxedString_ASCII",e[e.ZPin=13]="ZPin",e[e.User0=16]="User0"})(pxt=pxt||{}),(c=>{{var u=c.HF2||(c.HF2={});function o(e,t,r){e[t+0]=r>>0&255,e[t+1]=r>>8&255,e[t+2]=r>>16&255,e[t+3]=r>>24&255}function l(e,t,r){e[t+0]=r>>0&255,e[t+1]=r>>8&255}function s(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}function d(e,t){return e[t]|e[t+1]<<8}function r(t){var r=new Uint8Array(4*t.length);for(let e=0;e<t.length;++e)o(r,4*e,t[e]);return r}u.HF2_CMD_BININFO=1,u.HF2_MODE_BOOTLOADER=1,u.HF2_MODE_USERSPACE=2,u.HF2_CMD_INFO=2,u.HF2_CMD_RESET_INTO_APP=3,u.HF2_CMD_RESET_INTO_BOOTLOADER=4,u.HF2_CMD_START_FLASH=5,u.HF2_CMD_WRITE_FLASH_PAGE=6,u.HF2_CMD_CHKSUM_PAGES=7,u.HF2_CMD_READ_WORDS=8,u.HF2_CMD_WRITE_WORDS=9,u.HF2_CMD_DMESG=16,u.HF2_FLAG_SERIAL_OUT=128,u.HF2_FLAG_SERIAL_ERR=192,u.HF2_FLAG_CMDPKT_LAST=64,u.HF2_FLAG_CMDPKT_BODY=0,u.HF2_FLAG_MASK=192,u.HF2_SIZE_MASK=63,u.HF2_STATUS_OK=0,u.HF2_STATUS_INVALID_CMD=1,u.HF2_STATUS_EXEC_ERR=2,u.HF2_STATUS_EVENT=128,u.HF2_CMD_JDS_CONFIG=32,u.HF2_CMD_JDS_SEND=33,u.HF2_EV_JDS_PACKET=8388640,u.CUSTOM_EV_JACDAC="jacdac",u.HF2_EV_MASK=8388608,u.write32=o,u.write16=l,u.read32=s,u.read16=d,u.encodeU32LE=r;let t=!(u.decodeU32LE=function(t){var r=[];for(let e=0;e<t.length;e+=4)r.push(s(t,e));return r});function h(e){t?c.log("HF2: "+e):c.debug("HF2: "+e)}u.enableLog=function(){t=!0};class i{constructor(o){var e;this.io=o,this.initialized=!1,this.cmdSeq=c.U.randomUint32(),this.lock=new c.U.PromiseQueue,this.flashing=!1,this.rawMode=!1,this.maxMsgSize=63,this.bootloaderMode=!1,this.reconnectTries=0,this.autoReconnect=!1,this.icon=(null==(e=c.appTarget.appTheme.downloadDialogTheme)?void 0:e.deviceIcon)||"usb",this.msgs=new c.U.PromiseBuffer,this.eventHandlers={},this.jacdacAvailable=!1,this.onSerial=(e,t)=>{},this.onCustomEvent=(e,t)=>{},this.onConnectionChanged=()=>{};let l=[];o.onDeviceConnectionChanged=e=>this.disconnectAsync().then(()=>e&&this.reconnectAsync()),o.onSerial=(e,t)=>this.onSerial(e,t),o.onData=e=>{var r=e[0]&u.HF2_FLAG_MASK,t=63&e[0],i=new Uint8Array(t);if(c.U.memcpy(i,0,e,1,t),r&u.HF2_FLAG_SERIAL_OUT)this.onSerial(i,r==u.HF2_FLAG_SERIAL_ERR);else if(l.push(i),r!=u.HF2_FLAG_CMDPKT_BODY){c.U.assert(r==u.HF2_FLAG_CMDPKT_LAST);let e=0;for(var n of l)e+=n.length;var s,a=new Uint8Array(e);let t=0;for(s of l)c.U.memcpy(a,t,s),t+=s.length;l=[],a[2]&u.HF2_STATUS_EVENT?o.onEvent(a):this.msgs.push(a)}},o.onEvent=e=>{var t=s(e,0),r=c.U.lookup(this.eventHandlers,t+"");r?r(e.slice(4)):h("unhandled event: "+t.toString(16))},o.onError=e=>{h("recv error: "+e.message),this.autoReconnect&&(this.autoReconnect=!1,this.reconnectAsync().then(()=>{this.autoReconnect=!0},e=>{h("reconnect error: "+e.message)}))},this.onEvent(u.HF2_EV_JDS_PACKET,e=>{this.onCustomEvent(u.CUSTOM_EV_JACDAC,e)})}resetState(){this.initialized=!1,this.lock=new c.U.PromiseQueue,this.info=null,this.infoRaw=null,this.pageSize=null,this.flashSize=null,this.maxMsgSize=63,this.bootloaderMode=!1,this.msgs.drain()}onEvent(e,t){c.U.assert(!!(e&u.HF2_EV_MASK)),this.eventHandlers[e+""]=t}sendCustomEventAsync(e,t){return e==u.CUSTOM_EV_JACDAC?this.jacdacAvailable?this.talkAsync(u.HF2_CMD_JDS_SEND,t).then(()=>{}):Promise.resolve():Promise.reject(new Error("invalid custom event type"))}isConnected(){return this.io.isConnected()&&this.initialized}isConnecting(){return this.io.isConnecting()||this.io.isConnected()&&!this.initialized}reconnectAsync(){return this.resetState(),h("reconnect raw="+this.rawMode),this.io.reconnectAsync().then(()=>this.initAsync()).catch(e=>{if(this.reconnectTries<5)return this.reconnectTries++,h(`error ${e.message}; reconnecting attempt #`+this.reconnectTries),c.U.delay(500).then(()=>this.reconnectAsync());throw e})}disconnectAsync(){return h("disconnect"),this.io.disconnectAsync()}error(e){return this.io.error(e)}talkAsync(e,t){if(this.io.talksAsync)return this.io.talksAsync([{cmd:e,data:t}]).then(e=>e[0]);let r=8;t&&(r+=t.length);var i=new Uint8Array(r);let n=65535&++this.cmdSeq,s=(o(i,0,e),l(i,4,n),l(i,6,0),t&&c.U.memcpy(i,8,t,0,t.length),0),a=()=>this.msgs.shiftAsync(1e3).then(e=>{if(d(e,0)!=n){if(s<3)return s++,h(`message out of sync, (${n} vs ${d(e,0)}); will re-try`),a();this.error("out of sync")}let t="";switch(e[3]&&(t="; info="+e[3]),e[2]){case u.HF2_STATUS_OK:return e.slice(4);case u.HF2_STATUS_INVALID_CMD:this.error("invalid command"+t);break;case u.HF2_STATUS_EXEC_ERR:this.error("execution error"+t);break;default:this.error("error "+e[2]+t)}return null});return this.sendMsgAsync(i).then(a)}sendMsgAsync(e){return this.sendMsgCoreAsync(e)}sendSerialAsync(e,t=!1){return this.io.sendSerialAsync?this.io.sendSerialAsync(e,t):this.sendMsgCoreAsync(e,t?2:1)}sendMsgCoreAsync(i,e=0){let n=new Uint8Array(64),s=t=>{let r=i.length-t;if(r<=0)return Promise.resolve();63<r?(r=63,n[0]=u.HF2_FLAG_CMDPKT_BODY):n[0]=u.HF2_FLAG_CMDPKT_LAST,e&&(n[0]=1==e?u.HF2_FLAG_SERIAL_OUT:u.HF2_FLAG_SERIAL_ERR),n[0]|=r;for(let e=0;e<r;++e)n[e+1]=i[t+e];return this.io.sendPacketAsync(n).then(()=>s(t+r))};return this.lock.enqueue("out",()=>s(0))}switchToBootloaderAsync(){return this.bootloaderMode?Promise.resolve():(h("Switching into bootloader mode"),this.io.isSwitchingToBootloader&&this.io.isSwitchingToBootloader(),this.maybeReconnectAsync().then(()=>this.talkAsync(u.HF2_CMD_START_FLASH).then(()=>{},e=>this.talkAsync(u.HF2_CMD_RESET_INTO_BOOTLOADER).then(()=>{},e=>{}).then(()=>this.reconnectAsync().catch(e=>{throw"devicenotfound"===e.type&&(e.type="repairbootloader"),e})))).then(()=>this.initAsync()).then(()=>{this.bootloaderMode||this.error("cannot switch into bootloader mode")}))}isFlashing(){return!!this.flashing}reflashAsync(e){h("reflash"),c.U.assert(c.appTarget.compile.useUF2);e=e.outfiles[pxtc.BINARY_UF2];let t=pxtc.UF2.parseFile(c.Util.stringToUint8Array(atob(e)));return this.flashing=!0,this.io.reconnectAsync().then(()=>this.flashAsync(t)).then(()=>c.U.delay(100)).finally(()=>this.flashing=!1).then(()=>this.reconnectAsync())}writeWordsAsync(e,t){return c.U.assert(t.length<=64),this.talkAsync(u.HF2_CMD_WRITE_WORDS,r([e,t.length].concat(t))).then(()=>{})}readWordsAsync(e,t){var r=new Uint8Array(8);return o(r,0,e),o(r,4,t),c.U.assert(t<=64),this.talkAsync(u.HF2_CMD_READ_WORDS,r)}pingAsync(){return this.rawMode?Promise.resolve():this.talkAsync(u.HF2_CMD_BININFO).then(e=>{})}maybeReconnectAsync(){return this.pingAsync().catch(e=>this.reconnectAsync().then(()=>this.pingAsync()))}flashAsync(i){let r=Date.now(),n=0,s=e=>{var t,r;return e>=i.length?Promise.resolve():(t=i[e],o(r=new Uint8Array(4+t.payloadSize),0,t.targetAddr),c.U.memcpy(r,4,t.data,0,t.payloadSize),this.talkAsync(u.HF2_CMD_WRITE_FLASH_PAGE,r).then(()=>s(e+1)))};return this.switchToBootloaderAsync().then(()=>{var e=256*i.length;return h(`Starting flash (${Math.round(e/1024)}kB).`),n=Date.now(),16384<this.pageSize?i:a(i,(e,t)=>this.readWordsAsync(e,t))}).then(e=>{e.length!=i.length&&(e=256*(i=e).length,h(`Performing partial flash (${Math.round(e/1024)}kB).`))}).then(()=>s(0)).then(()=>{var e=Date.now(),t=e-r,e=e-n;h(`Flashing done at ${Math.round(256*i.length/e*1e3/1024)} kB/s in ${t}ms (reset ${t-e}ms). Resetting.`)}).then(()=>this.talkAsync(u.HF2_CMD_RESET_INTO_APP).catch(e=>{})).then(()=>{})}initAsync(){return this.rawMode?(this.initialized=!0,Promise.resolve()):Promise.resolve().then(()=>this.talkAsync(u.HF2_CMD_BININFO)).then(e=>(this.bootloaderMode=e[0]==u.HF2_MODE_BOOTLOADER,this.pageSize=s(e,4),this.flashSize=s(e,8)*this.pageSize,this.maxMsgSize=s(e,12),this.familyID=s(e,16),h(`Connected; msgSize ${this.maxMsgSize}B; flash ${this.flashSize/1024}kB; ${this.bootloaderMode?"bootloader":"application"} mode; family=0x`+this.familyID.toString(16)),this.talkAsync(u.HF2_CMD_INFO))).then(e=>{this.infoRaw=c.Util.fromUTF8Array(e),c.debug("Info: "+this.infoRaw);let i={};("Header: "+this.infoRaw).replace(/^([\w\-]+):\s*([^\n\r]*)/gm,(e,t,r)=>(i[t.replace(/-/g,"")]=r,"")),this.info=i;e=/v(\d\S+)(\s+(\S+))?/.exec(this.info.Header);this.info.Parsed=e?{Version:e[1],Features:e[3]||""}:{Version:"?",Features:""},h(`Board-ID: ${this.info.BoardID} v${this.info.Parsed.Version} f`+this.info.Parsed.Features)}).then(()=>this.talkAsync(u.HF2_CMD_JDS_CONFIG,new Uint8Array([1])).then(()=>{this.jacdacAvailable=!0},e=>{this.jacdacAvailable=!1})).then(()=>{this.reconnectTries=0,this.initialized=!0,this.io.onConnectionChanged()})}}function a(i,e){if(!c.appTarget.compile.flashChecksumAddr)return Promise.resolve(i);var r,t=pxtc.UF2.readBytes(i,c.appTarget.compile.flashChecksumAddr,48);let n=pxtc.parseChecksumBlock(t);return n?(r=e,(c.appTarget.compile.flashChecksumAddr?r(c.appTarget.compile.flashChecksumAddr,12).then(e=>{let t=pxtc.parseChecksumBlock(e);return t?r(t.endMarkerPos,1).then(e=>s(e,0)!=t.endMarker?(c.log("end-marker mismatch"),null):t):null}):Promise.resolve(null)).then(e=>{if(!e)return i;let r=e.regions.filter(t=>n.regions.some(e=>t.checksum==e.checksum&&t.length==e.length&&t.start==e.start));if(0==r.length)return i;h("skipping flash at: "+r.map(e=>`${pxtc.assembler.tohex(e.start)} (${e.length/1024}kB)`).join(", "));let t=t=>r.some(e=>e.start<=t&&t<e.start+e.length);return i.filter(e=>!(t(e.targetAddr)&&t(e.targetAddr+e.payloadSize-1)))})):Promise.resolve(i)}u.Wrapper=i,u.mkHF2PacketIOWrapper=function(e){return c.debug("packetio: wrapper hf2"),new i(e)},u.onlyChangedBlocksAsync=a}})(pxt=pxt||{}),(u=>{{var m=u.HWDBG||(u.HWDBG={}),g=u.Util,b=u.HF2;let e=1409050336,t=665147697,r=1888490768,i=b.read32,s=!1,h,n,a,o,p,f,l,c;function v(e){return 1&e?e>>1:0!=e?2&e?e==m.taggedNull?null:e!=m.taggedFalse&&(e==m.taggedTrue||{tagged:e>>2}):{ptr:e}:void 0}function d(e,t){var r;if(g.assert(!(3&e)),g.assert(0<=e),e<2097152)return r=new Uint8Array(t),e-=l.start,g.memcpy(r,0,l.buf,e,t),Promise.resolve(r);var i=c.maxMsgSize-32;if(i<t){for(var n=[];0<t;){var s=Math.min(i,t);n.push(d(e,s)),t-=s,e+=s}return Promise.all(n).then(g.uint8ArrayConcat)}return c.readWordsAsync(e,Math.ceil(t/4)).then(e=>e.length>t?e.slice(0,t):e)}function y(i){if("object"!=typeof i||!i)return Promise.resolve(i);if("number"!=typeof i.ptr)return Promise.resolve(i);{if(3&i.ptr)return Promise.resolve({unalignedPtr:i.ptr});let r=0;return d(i.ptr,56).then(t=>{r=b.read16(t,2);let e=t.length;return r==u.BuiltInType.BoxedString||r==u.BuiltInType.BoxedBuffer?e=b.read16(t,4)+6:r==u.BuiltInType.BoxedNumber&&(e=12),e>t.length?d(i.ptr+t.length,e-t.length).then(e=>g.uint8ArrayConcat([t,e])):e<t.length?t.slice(0,e):t}).then(e=>r==u.BuiltInType.BoxedString?g.uint8ArrayToString(e.slice(6)):r==u.BuiltInType.BoxedBuffer?{type:"buffer",data:e.slice(6)}:r==u.BuiltInType.BoxedNumber?new Float64Array(e.buffer.slice(4))[0]:{type:"unknown",tag:r,refcnt:b.read16(e,0),data:e.slice(4)})}}function w(r){var e=[];for(let t of Object.keys(r))e.push(y(r[t]).then(e=>{r[t]=e}));return Promise.all(e).then(()=>{})}function A(e){var t,r=h.breakpoints;let i=r[0],n=1/0;for(t of r){var s=e-t.binAddr;0<=s&&s<n&&(n=s,i=t)}return i}function k(t){if(s)return Promise.resolve();s=!0;let d;return S().then(i=>{var e=b.decodeU32LE(t)[0],n={};for(let r of h.procDebugInfo[0].locals){let e=i.globals;let t=(()=>{switch(r.type){case"uint32":return b.read32(e,r.index);case"int32":return 0|b.read32(e,r.index);case"uint16":return b.read16(e,r.index);case"int16":return b.read16(e,r.index)<<16>>16;case"uint8":return e[r.index];case"int8":return e[r.index]<<24>>24;default:return null}})();null===t&&(g.assert(0==(3&r.index)),t=v(b.read32(e,r.index))),n[r.name]=t}return p=A(e),d={type:"debugger",subtype:"breakpoint",breakpointId:p.id,globals:n,stackframes:[]},a(),c.talkAsync(r)}).then(e=>{{var n=b.decodeU32LE(e),s=d;let t=p.binAddr,r=0,i=h.procDebugInfo.filter(e=>e.codeStartLoc<=t&&t<=e.codeEndLoc)[0];for(;;){if(!i)break;if(i==h.procDebugInfo[0])break;var a,o=A(t),l=g.clone(o),c=(l.functionName=i.name,l.argumentNames=i.args&&i.args.map(e=>e.name),s.stackframes.push({locals:{},funcInfo:l,breakpointId:o.id}),s.stackframes[s.stackframes.length-1]);let e=0;for(a of i.locals)g.assert(a.index==e++),c.locals[a.name]=v(n[r++]);t=2147483646&n[r++];var u,l=f[t+""];for(u of i.args)c.locals[u.name]=v(n[r+(i.args.length-1-u.index)]);if(!l)break;i=l.from,r+=l.stack-i.localsMark}}e=[d.globals].concat(d.stackframes.map(e=>e.locals));return g.promiseMapAll(e,w)}).then(()=>m.postMessage(d))}function E(){s=!1,n=new Promise((e,t)=>{a=e})}function x(e=!1){return Promise.resolve().then(()=>c.talkAsync(t,b.encodeU32LE([e?1:3]))).then(E)}function T(){return n=n||Promise.resolve()}function S(){return(o?Promise.resolve(o):c.talkAsync(e).then(e=>o={numGlobals:i(e,0),globalsPtr:i(e,4)})).then(e=>c.readWordsAsync(e.globalsPtr,e.numGlobals)).then(e=>({staticState:o,globals:e}))}m.taggedUndefined=0,m.taggedNull=6,m.taggedFalse=10,m.taggedTrue=66,m.postMessage=e=>u.log(e),m.decodeValue=v,m.heapExpandAsync=y,m.heapExpandMapAsync=w,m.startDebugAsync=function(n,e){return(c=e).onEvent(915601917,k),s=!1,h=null,o=null,Promise.resolve().then(()=>{h=n,f={};var e,t,r=[];for(e of n.procDebugInfo)r[e.idx]=e;for(t of n.procDebugInfo)for(var i of t.calls)f[i.addr+""]={from:t,to:r[i.procIndex],stack:i.stack}}).then(()=>{var e=h.outfiles[pxtc.BINARY_UF2],e=g.stringToUint8Array(atob(e));return l=pxtc.UF2.toBin(e),c.reflashAsync(h).then(()=>c.reconnectAsync())}).then(()=>c.talkAsync(287358355).catch(e=>{})).then(()=>g.delay(200)).then(()=>c.reconnectAsync()).then(E).then(T)},m.handleMessage=function(t){if(u.log("HWDBGMSG",t),"debugger"==t.type){let e=!1;switch(t.subtype){case"stepinto":e=!0;case"stepover":x(e)}}},m.resumeAsync=x,m.waitForHaltAsync=T,m.getHwStateAsync=S}})(pxt=pxt||{}),(f=>{class e{logTime(){var e;this.start&&(e=Date.now()-this.start,f.debug("Icon creation: "+e+"ms"))}convert(e){this.start||(this.start=Date.now());let t=atob(e.slice(e.indexOf(",")+1)),r=t.charCodeAt(0),i=t.charCodeAt(1),n=t.charCodeAt(2);return 135===r&&(r=224|t.charCodeAt(1),i=t.charCodeAt(2)|t.charCodeAt(3)<<8,n=t.charCodeAt(4)|t.charCodeAt(5)<<8,t=t.slice(4)),225!=r&&228!=r?null:(this.palette||this.setPalette(f.appTarget.runtime.palette.map(function(e){return[(e=parseInt(e.replace(/#/,""),16))>>0&255,e>>8&255,e>>16&255,255]})),225==r?this.genMonochrome(t,i,n):(e=(f.BrowserUtils.isEdge()||f.BrowserUtils.isIE())&&i<100&&n<100?3:1,this.genColor(t,i,n,e)))}setPalette(t){t[0][3]=0,this.palette=new Uint8Array(4*t.length);for(let e=0;e<t.length;++e)this.palette[4*e+0]=t[e][0],this.palette[4*e+1]=t[e][1],this.palette[4*e+2]=t[e][2],this.palette[4*e+3]=t[e][3]}genMonochrome(t,r,i){var n=r+3&-4,s=54+this.palette.length,e=s+n*i,a=new Uint8Array(e);a[0]=66,a[1]=77,f.HF2.write32(a,2,e),f.HF2.write32(a,10,s),f.HF2.write32(a,14,40),f.HF2.write32(a,18,r),f.HF2.write32(a,22,-i),f.HF2.write16(a,26,1),f.HF2.write16(a,28,8),f.HF2.write32(a,38,2835),f.HF2.write32(a,42,2835),f.HF2.write32(a,46,this.palette.length>>2),a.set(this.palette,54);let o=4,l=s,c=1,u=t.charCodeAt(o++);for(let e=0;e<r;++e){l=s+e;for(let e=0;e<i;++e)a[l]=u&c?1:0,l+=n,256==(c<<=1)&&(c=1,u=t.charCodeAt(o++))}return"data:image/bmp;base64,"+btoa(f.U.uint8ArrayToString(a))}genColor(n,e,s,a){var t=e*(a=Math.max(1,0|a)),o=s*a,l=t<<2,e=138+l*o,c=new Uint8Array(e);c[0]=66,c[1]=77,f.HF2.write32(c,2,e),f.HF2.write32(c,10,138),f.HF2.write32(c,14,124),f.HF2.write32(c,18,t),f.HF2.write32(c,22,-o),f.HF2.write16(c,26,1),f.HF2.write16(c,28,32),f.HF2.write16(c,30,3),f.HF2.write32(c,38,2835),f.HF2.write32(c,42,2835),f.HF2.write32(c,54,16711680),f.HF2.write32(c,58,65280),f.HF2.write32(c,62,255),f.HF2.write32(c,66,4278190080),c[70]=66,c[71]=71,c[72]=82,c[73]=115;let u=4,d=138,h=!0;for(let e=0;e<t;e++){let t=!1;d=138+(e<<2);var p=u;let r=n.charCodeAt(u++),i=t?(r>>4&15)<<2:(15&r)<<2;for(let e=0;e<o;e++)r&&(h=!1),c[d]=this.palette[i],c[d+1]=this.palette[i+1],c[d+2]=this.palette[i+2],c[d+3]=this.palette[i+3],d+=l,e%a==a-1&&(t&&(r=n.charCodeAt(u++)),t=!t,i=t?(r>>4&15)<<2:(15&r)<<2);if(h&&(c[141]=1),e%a==a-1)for(s%2||--u;3&u;)u++;else u=p}return"data:image/bmp;base64,"+btoa(f.U.uint8ArrayToString(c))}}f.ImageConverter=e,f.convertUint8BufferToPngUri=function(t,e){var r=new f.ImageConverter,i=[];for(let e=0;e<16;e++)i.push([t[3*e+2],t[3*e+1],t[3*e+0],255]);return r.setPalette(i),e=String.fromCharCode.apply(null,e),e="data:image/x-mkcd-f4;base64,"+btoa(e),r.convert(e)}})(pxt=pxt||{}),(o=>{var e;function l(){let t={"tsconfig.json":e.TS_CONFIG,"test.ts":`// ${lf("tests go here; this will not be compiled when this package is used as an extension.")}
`,"_config.yml":`makecode:
  target: @TARGET@
  platform: @PLATFORM@
  home_url: @HOMEURL@
theme: jekyll-theme-slate
include:
  - assets
  - README.md
`,Makefile:`all: deploy

build:
	pxt build

deploy:
	pxt deploy

test:
	pxt test
`,Gemfile:`source 'https://rubygems.org'
gem 'github-pages', group: :jekyll_plugins`,"README.md":`
> ${lf("Open this page at {0}","[https://@REPOOWNER@.github.io/@REPONAME@/](https://@REPOOWNER@.github.io/@REPONAME@/)")}

## ${lf("Use as Extension")}

${lf("This repository can be added as an **extension** in MakeCode.")}

* ${lf("open [@HOMEURL@](@HOMEURL@)")}
* ${lf("click on **New Project**")}
* ${lf("click on **Extensions** under the gearwheel menu")}
* ${lf("search for **https://github.com/@REPO@** and import")}

## ${lf("Edit this project")}

${lf("To edit this repository in MakeCode.")}

* ${lf("open [@HOMEURL@](@HOMEURL@)")}
* ${lf("click on **Import** then click on **Import URL**")}
* ${lf("paste **https://github.com/@REPO@** and click import")}

#### ${lf("Metadata (used for search, rendering)")}

* for PXT/@TARGET@
<script src="https://makecode.com/gh-pages-embed.js"></script><script>makeCodeRender("{{ site.makecode.home_url }}", "{{ site.github.owner_name }}/{{ site.github.repository_name }}");</script>
`,".gitignore":`# MakeCode
built
node_modules
yotta_modules
yotta_targets
pxt_modules
.pxt
_site
*.db
*.tgz
.header.json
.simstate.json
`,".vscode/settings.json":`{
    "editor.formatOnType": true,
    "files.autoSave": "afterDelay",
    "files.watcherExclude": {
        "**/.git/objects/**": true,
        "**/built/**": true,
        "**/node_modules/**": true,
        "**/yotta_modules/**": true,
        "**/yotta_targets": true,
        "**/pxt_modules/**": true,
        "**/.pxt/**": true
    },
    "files.associations": {
        "*.blocks": "html",
        "*.jres": "json"
    },
    "search.exclude": {
        "**/built": true,
        "**/node_modules": true,
        "**/yotta_modules": true,
        "**/yotta_targets": true,
        "**/pxt_modules": true,
        "**/.pxt": true
    },
    "files.exclude": {
        "**/pxt_modules": true,
        "**/.pxt": true
    }
}`,".vscode/extensions.json":`{
    "recommendations": ["ms-edu.pxt-vscode-web"]
}`},r=i();return r&&Object.keys(r).forEach(e=>t[e]=r[e]),t}function i(){var e=o.appTarget.bundledpkgs[o.template.TEMPLATE_PRJ];if(e)return delete(e=o.Util.clone(e))[o.CONFIG_NAME],e}(e=o.template||(o.template={})).TS_CONFIG=`{
    "compilerOptions": {
        "target": "ES5",
        "noImplicitAny": true,
        "outDir": "built",
        "rootDir": "."
    },
    "exclude": ["pxt_modules/**/*test.ts"]
}
`,e.defaultFiles=l,e.targetTemplateFiles=i,e.TEMPLATE_PRJ="template",e.packageFiles=function(e){var t,r,i=o.appTarget.blocksprj||o.appTarget.tsprj,n=o.U.clone(i.config),s=(delete n.installedVersion,delete n.additionalFilePath,delete n.additionalFilePaths,n.preferredEditor=n.files.find(e=>/\.blocks$/.test(e))?o.BLOCKS_PROJECT_NAME:o.JAVASCRIPT_PROJECT_NAME,n.name=e,n.public=!0,n.version||(n.version="0.0.0"),{}),a=l();for(t in a)s[t]=a[t];for(r in i.files)"README.md"!=r&&(s[r]=i.files[r]);return e=Object.keys(s).filter(e=>/\.(blocks|md|ts|asm|cpp|h|py)$/.test(e)),n.files=e.filter(e=>!/test/.test(e)),n.testFiles=e.filter(e=>/test/.test(e)),n.supportedTargets=[o.appTarget.id],s[o.CONFIG_NAME]=o.Package.stringifyConfig(n),s},e.packageFilesFixup=function(r,e){let i=JSON.parse(r[o.CONFIG_NAME]);e&&o.Util.jsonMergeFrom(i,e),o.webConfig&&(Object.keys(o.webConfig).forEach(e=>i[e.toLowerCase()]=o.webConfig[e]),i.platform=o.appTarget.platformid||o.appTarget.id,i.target=o.appTarget.id,i.docs=o.appTarget.appTheme.homeUrl||"./",i.homeurl=o.appTarget.appTheme.homeUrl||"???"),o.U.iterMap(r,(e,t)=>{t=t.replace(/@([A-Z]+)@/g,(e,t)=>i[t.toLowerCase()]||""),r[e]=t})}})(pxt=pxt||{}),(k=>{var e,r;{var i=k.blocks||(k.blocks={});let w;(e=w=i.NT||(i.NT={}))[e.Prefix=0]="Prefix",e[e.Postfix=1]="Postfix",e[e.Infix=2]="Infix",e[e.Block=3]="Block",e[e.NewLine=4]="NewLine";let A,t=((e=A=i.GlueMode||(i.GlueMode={}))[e.None=0]="None",e[e.WithSpace=1]="WithSpace",e[e.NoSpace=2]="NoSpace",["break","case","catch","class","const","continue","debugger","default","delete","do","else","enum","export","extends","false","finally","for","function","if","import","in","instanceof","new","null","return","super","switch","this","throw","true","try","typeof","var","void","while","with"]);function n(e){return"`"+e.replace(/[\\`${}]/g,e=>"\\"+e)+"`"}function s(e){return 20<e.length&&/\n/.test(e)?n(e):JSON.stringify(e)}function a(e,t,r){return{type:e,op:t,children:r}}function l(){return a(w.NewLine,"",[])}function c(e,t){return a(w.Prefix,e,t)}function u(e,t,r){return a(w.Infix,t,null==e?[r]:[e,r])}function E(e){return c(e,[])}function d(e){return a(w.Block,"",e)}function x(e){return c("",e)}function h(e,t=!1){var r,i=[];for(r of e)t?(0<i.length&&i.push(E(",")),i.push(l())):0<i.length&&i.push(E(", ")),i.push(r);return t&&i.push(l()),x(i)}function p(e,t,r=!1,i=!1){return x(i?[u(t[0],".",E(e)),E("("),h(t.slice(1),r),E(")")]:[E(e),E("("),h(t,r),E(")")])}function f(e,t,r,i){return p(e+"."+t,r,i)}function m(e,t){return k.U.assert(2==t.length),u(t[0],e,t[1])}i.backtickLit=n,i.stringLit=s,i.mkNode=a,i.mkNewLine=l,i.mkPrefix=c,i.mkPostfix=function(e,t){return a(w.Postfix,t,e)},i.mkInfix=u,i.mkText=E,i.mkBlock=d,i.mkGroup=x,i.mkStmt=function(...e){var t=e[e.length-1];return t&&t.type==w.Block||e.push(l()),x(e)},i.mkCommaSep=h,(r=e=i.Helpers||(i.Helpers={})).mkArrayLiteral=function(e,t){return x([E("["),h(e,t),E("]")])},r.mkNumberLiteral=function(e){return E(e.toString())},r.mkBooleanLiteral=function(e){return E(e?"true":"false")},r.mkStringLiteral=function(e){return E(s(e))},r.mkPropertyAccess=function(e,t){return x([u(t,".",E(e))])},r.mkCall=p,r.stdCall=function(e,t,r){return p(e,t,r)},r.extensionCall=function(e,t,r){return p(e,t,r,!0)},r.namespaceCall=f,r.mathCall=function(e,t){return f("Math",e,t,!1)},r.mkGlobalRef=E,r.mkSimpleCall=m,r.mkWhile=function(e,t){return x([E("while ("),e,E(")"),d(t)])},r.mkComment=function(e){return E("// "+e)},r.mkMultiComment=function(e){let i=[E("/**"),l()];return e.split("\n").forEach((e,t,r)=>{e&&(i.push(E(" * "+e)),i.push(l()),t<r.length-1)&&(i.push(E(" * ")),i.push(l()))}),x(i.concat([E(" */"),l()]))},r.mkAssign=function(e,t){return m("=",[e,t])},r.mkParenthesizedExpression=function(e){return b(g([e]).output)?e:x([E("("),e,E(")")])},i.H=e;let o={"=":3,"+=":3,"-=":3,"?":4,":":4,"||":5,"&&":6,"|":7,"^":8,"&":9,"==":10,"!=":10,"===":10,"!==":10,"<":11,">":11,"<=":11,">=":11,">>":12,">>>":12,"<<":12,"+":13,"-":13,"*":14,"/":14,"%":14,"**":15,"!":16,"~":16,"P-":16,"P+":16,"++":16,"--":16,".":18};function g(e){let u=[],d={},h="",p="",f=[{}],m=0;function g(e){"string"==typeof e&&(m+=(e.match(/\n/g)||[]).length),h+=e}e=x(e);return function e(r,i){if(r.type!=w.Infix)for(var t of r.children)e(t,-1);else{let t=[];var n,s=k.U.lookup(o,r.op);function a(e){"P"==e[0]&&(e=e.slice(1)),t.push(E(e))}null==s&&k.U.oops("bad infix op: "+r.op),s<i&&a("("),1==r.children.length?(a(r.op),e(r.children[0],s),t.push(r.children[0])):(n=3!=s&&"**"!=r.op,e(r.children[0],n?s:s+.1),t.push(r.children[0]),"."==r.op?a("."):a(" "+r.op+" "),e(r.children[1],n?s+.1:s),t.push(r.children[1])),s<i&&a(")"),r.type=w.Prefix,r.op="",r.children=t}}(e,-1),b(e),h||g("\n"),{output:h,sourceMap:u};function b(e){e.glueToBlock&&(y(),e.glueToBlock==A.WithSpace)&&g(" ");var t=m,r=h.length;switch(e.type){case w.Infix:k.U.oops("no infix should be left");break;case w.NewLine:g("\n"+p);break;case w.Block:var i=e,n=i.noFinalNewline?"":"\n";if(0==i.children.length)v(" {\n\t\n}"+n);else{var s,a=k.U.clone(f[f.length-1]||{});f.push(a),p+="    "," "!=h[h.length-1]&&v(" "),v("{\n");for(s of i.children)b(s);p=p.slice(4),y(),v("\n}"+n),f.pop()}break;case w.Prefix:e.canIndentInside?g(e.op.replace(/\n/g,"\n"+p+"    ")):g(e.op),e.children.forEach(b);break;case w.Postfix:e.children.forEach(b),e.canIndentInside?g(e.op.replace(/\n/g,"\n"+p+"    ")):g(e.op)}var o,l=m,c=Math.max(h.length,1);e.id&&(d[e.id]?((o=d[e.id]).startLine=Math.min(o.startLine,t),o.endLine=Math.max(o.endLine,l),o.startPos=Math.min(o.startPos,r),o.endPos=Math.max(o.endPos,c)):(o={id:e.id,startLine:t,startPos:r,endLine:l,endPos:c},d[e.id]=o,u.push(o)))}function v(e){g(e.replace(/\n/g,"\n"+p))}function y(){h=h.replace(/\n *$/,function(){return m--,""})}}function b(r){if("("===r[0]&&")"===r[r.length-1]){let t=1;for(let e=1;e<r.length;e++){var i=r[e];if("("===i)t++;else if(")"===i&&0===--t)return e===r.length-1}}return!1}i.flattenNode=g,i.isReservedWord=function(e){return-1!==t.indexOf(e)},i.isParenthesized=b}})(pxt=pxt||{}),(c=>{var n;{var s=n=c.sprite||(c.sprite={});let a=[".","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];s.BLOCKLY_TILESET_TYPE="BLOCKLY_TILESET_TYPE",s.TILE_PREFIX="tile",s.TILE_NAMESPACE="myTiles",s.IMAGES_NAMESPACE="myImages",s.IMAGE_PREFIX="image",s.ANIMATION_NAMESPACE="myAnimations",s.ANIMATION_PREFIX="anim",s.SONG_NAMESPACE="mySongs",s.JSON_NAMESPACE="myFiles",s.SONG_PREFIX="song",s.JSON_PREFIX="file";class x{constructor(e,t,r=0,i=0,n){this.width=e,this.height=t,this.x0=r,this.y0=i,this.width||(this.width=16),this.height||(this.height=16),this.buf=n||new Uint8ClampedArray(this.dataLength())}static fromData(e){return new x(e.width,e.height,e.x0,e.y0,e.data)}set(e,t,r){e<this.width&&t<this.height&&0<=e&&0<=t&&(e=this.coordToIndex(e,t),this.setCore(e,r))}get(e,t){return e<this.width&&t<this.height&&0<=e&&0<=t?(e=this.coordToIndex(e,t),this.getCore(e)):0}copy(r=0,i=0,e=this.width,n=this.height){var s=new x(e,n);s.x0=r,s.y0=i;for(let t=0;t<e;t++)for(let e=0;e<n;e++)s.set(t,e,this.get(r+t,i+e));return s}apply(r,i=!1){var n;for(let t=0;t<r.width;t++)for(let e=0;e<r.height;e++)!(n=r.get(t,e))&&i||this.set(r.x0+t,r.y0+e,n)}equals(t){if(this.width!==t.width||this.height!==t.height||this.x0!==t.x0||this.y0!==t.y0||this.buf.length!==t.buf.length)return!1;for(let e=0;e<this.buf.length;e++)if(this.buf[e]!==t.buf[e])return!1;return!0}data(){return{width:this.width,height:this.height,x0:this.x0,y0:this.y0,data:this.buf}}resize(e,t){return u(this,e,t)}coordToIndex(e,t){return e+t*this.width}getCore(e){var t=Math.floor(e/2);return e%2==0?15&this.buf[t]:(240&this.buf[t])>>4}setCore(e,t){var r=Math.floor(e/2);this.buf[r]=e%2==0?240&this.buf[r]|15&t:15&this.buf[r]|(15&t)<<4}dataLength(){return Math.ceil(this.width*this.height/2)}}s.Bitmap=x;class T extends x{static fromData(e){return new T(e.width,e.height,e.x0,e.y0,e.data)}copy(r=0,i=0,e=this.width,n=this.height){var s=new T(e,n);s.x0=r,s.y0=i;for(let t=0;t<e;t++)for(let e=0;e<n;e++)s.set(t,e,this.get(r+t,i+e));return s}resize(e,t){return d(this,e,t)}getCore(e){return this.buf[e]}setCore(e,t){this.buf[e]=t}dataLength(){return this.width*this.height}}s.Tilemap=T;class S{constructor(e,t,r){this.tilemap=e,this.tileset=t,this.layers=r,this.nextId=0}cloneData(e=!1){var t=this.tilemap.copy(),r={tileWidth:this.tileset.tileWidth,tiles:this.tileset.tiles.map(e=>Object.assign(Object.assign({},e),{bitmap:x.fromData(e.bitmap).copy().data()}))},i=x.fromData(this.layers).copy().data(),t=new S(t,r,i);return e&&(t.nextId=this.nextId,t.projectReferences=null==(r=this.projectReferences)?void 0:r.slice(),t.tileOrder=null==(i=this.tileOrder)?void 0:i.slice(),t.editedTiles=null==(e=this.editedTiles)?void 0:e.slice(),t.deletedTiles=null==(r=this.deletedTiles)?void 0:r.slice()),t}equals(e){return this.tilemap.equals(e.tilemap)&&b(this.tileset,e.tileset)&&g(this.layers,e.layers)}}function r(e){return t(atob(e.slice(e.indexOf(",")+1)))}function t(n){let e=n.charCodeAt(0),s=n.charCodeAt(1),a=n.charCodeAt(2);135===e&&(e=224|n.charCodeAt(1),s=n.charCodeAt(2)|n.charCodeAt(3)<<8,a=n.charCodeAt(4)|n.charCodeAt(5)<<8,n=n.slice(4));var o=new c.sprite.Bitmap(s,a);let l=4;if(225===e){let r=1,i=n.charCodeAt(l++);for(let t=0;t<s;++t)for(let e=0;e<a;++e)o.set(t,e,i&r?1:0),256==(r<<=1)&&(r=1,i=n.charCodeAt(l++))}else for(let t=0;t<s;t++){for(let e=0;e<a;e+=2){var r=n.charCodeAt(l++);o.set(t,e,15&r),e!=a-1&&o.set(t,e+1,r>>4&15)}for(;3&l;)l++}return o}function o(e,t){!(e=(e=(e=e.replace(/[ `]|(?:&#96;)|(?:&#9;)|(?:hex)/g,"").trim()).replace(/^["`\(\)]*/,"").replace(/["`\(\)]*$/,"")).replace(/&#10;/g,"\n"))&&t&&(e=t);var t=parseInt(e.substr(0,2),16)|parseInt(e.substr(2,2),16)<<8,r=parseInt(e.substr(4,2),16)|parseInt(e.substr(6,2),16)<<8,e=w(e.substring(8));return T.fromData({width:t,height:r,x0:0,y0:0,data:e})}function l(e){return""+i(e.width,2)+i(e.height,2)+A(e.data().data)}function i(e,t){let r=e.toString(16);var i=t<<1;for(1&r.length&&(r="0"+r);r.length<i;)r+="0";return r}function u(e,t,r){t=new x(t,r);return t.apply(e),t}function d(e,t,r){t=new T(t,r);return t.apply(e),t}function h(e,t="img"){var r=(e=(e=(e=(e=e.replace(/[ `]|(?:&#96;)|(?:&#9;)|(?:img)/g,"").trim()).replaceAll(t,"")).replace(/^["`\(\)]*/,"").replace(/["`\(\)]*$/,"")).replace(/&#10;/g,"\n")).split("\n"),i=[];let n=0;for(let e=0;e<r.length;e++){var s=r[e],a=[];for(let e=0;e<s.length;e++)switch(s[e]){case"0":case".":a.push(0);break;case"1":case"#":a.push(1);break;case"2":case"T":a.push(2);break;case"3":case"t":a.push(3);break;case"4":case"N":a.push(4);break;case"5":case"n":a.push(5);break;case"6":case"G":a.push(6);break;case"7":case"g":a.push(7);break;case"8":a.push(8);break;case"9":a.push(9);break;case"a":case"A":case"R":a.push(10);break;case"b":case"B":case"P":a.push(11);break;case"c":case"C":case"p":a.push(12);break;case"d":case"D":case"O":a.push(13);break;case"e":case"E":case"Y":a.push(14);break;case"f":case"F":case"W":a.push(15);break;default:if(!/\s/.test(s[e]))return}a.length&&(i.push(a),n=Math.max(n,a.length))}var o=i.length,l=new x(n,o);for(let t=0;t<o;t++){var c=i[t];for(let e=0;e<n;e++)e<c.length?l.set(e,t,c[e]):l.set(e,t,0)}return l}function p(e,t="img"){let r="";return r="python"===e?t+'("""':t+"`"}function f(e){let t="";return t+="python"===e?'""")':"`"}function m(r,e,t="img"){if(!r||0===r.height||0===r.width)return"";let i=p(e,t);if(r){var n=300<r.width*r.height?"":" ";for(let t=0;t<r.height;t++){i+="\n";for(let e=0;e<r.width;e++)i+=a[r.get(e,t)]+n}}return i=(i+="\n")+f(e)}function g(e,t){return e===t||!(!e&&t||!t&&e)&&c.sprite.Bitmap.fromData(e).equals(c.sprite.Bitmap.fromData(t))}function b(e,t){return e.tileWidth===t.tileWidth&&c.U.arrayEquals(e.tiles,t.tiles,c.assetEquals)}function v(e){switch(e){case 4:return"TileScale.Four";case 8:return"TileScale.Eight";case 16:return"TileScale.Sixteen";case 32:return"TileScale.ThirtyTwo";default:return Math.floor(Math.log2(e)).toString()}}function y(e){switch(e=e.replace(/\s/g,"")){case"TileScale.Four":return 4;case"TileScale.Eight":return 8;case"TileScale.Sixteen":return 16;case"TileScale.ThirtyTwo":return 32;default:return Math.pow(2,parseInt(e))}}function w(t){var r=new Uint8ClampedArray(t.length>>1);for(let e=0;e<t.length;e+=2)r[e>>1]=parseInt(t.slice(e,e+2),16);return r}function A(t){var r="0123456789abcdef";let i="";for(let e=0;e<t.length;++e)i=(i+=r[t[e]>>4])+r[15&t[e]];return i}function k(e,t,r){e[t]=255&r,e[t+1]=r>>8&255}function E(e){e=(e=>{if(e){if(6===e.length)return parseInt("0x"+e);if(7===e.length)return parseInt("0x"+e.substr(1))}return 0})(e);return[e>>16&255,e>>8&255,255&e]}s.TilemapData=S,s.Bitmask=class{constructor(e,t){this.width=e,this.height=t,this.mask=new Uint8Array(Math.ceil(e*t/8))}set(e,t){e+=this.width*t;this.mask[e>>3]|=1<<(7&e)}get(e,t){e+=this.width*t;return this.mask[e>>3]>>(7&e)&1}},s.encodeTilemap=function(e,t,r){return e?`tiles.createTilemap(${i=e.tilemap,i?`hex\`${l(i)}\``:"hex``"}, ${m(x.fromData(e.layers),t)}, [${e.tileset.tiles.map(e=>{var t=r;return t&&t[e.id]?t[e.id]:e.id})}], ${v(e.tileset.tileWidth)})`:"null";var i},s.decodeTilemap=function(e,t,r){var i,n,s,a;return(e=c.Util.htmlUnescape(e).trim()).trim()&&-1!==e.indexOf("(")?(s=(e=(e=e.substr(e.indexOf("(")+1)).substr(0,e.lastIndexOf(")"))).substr(0,e.indexOf(",")),i=(e=e.substr(s.length+1)).substr(0,e.indexOf(",")),n=(e=e.substr(i.length+1)).substr(0,e.lastIndexOf("]")+1),e=e=e.substr(n.length+1),new S(o(s),{tiles:(a=r,(s=(s=n).replace(/[\[\]]/g,""))?s.split(",").filter(e=>!!e.trim()).map(e=>{var t=e,r=a;if(0===(t=t.trim()).indexOf("img"))return e=h(t),r.createNewTile(e.data());switch(t){case"myTiles.tile0":case"myTiles.transparency16":return r.getTransparency(16);case"myTiles.transparency8":return r.getTransparency(8);case"myTiles.transparency4":return r.getTransparency(4);case"myTiles.transparency32":return r.getTransparency(32);default:return r.resolveTile(t)}}):[]),tileWidth:y(e)},h(i).data())):null},s.trimTilemapTileset=function(e){var r=e.tileset.tiles.slice(),i=e.tilemap;let n={};n[r[0].id]=!0;for(let t=0;t<i.width;t++)for(let e=0;e<i.height;e++)n[r[i.get(t,e)].id]=!0;let t=e.editedTiles||[];var s=r.filter(e=>n[e.id]||"*"===e.id.charAt(0)||-1!==t.indexOf(e.id));if(s.length!==r.length){var a=[];for(let e=0;e<r.length;e++)a.push(s.indexOf(r[e]));for(let t=0;t<i.width;t++)for(let e=0;e<i.height;e++)i.set(t,e,a[i.get(t,e)]);e.tileset.tiles=s}},s.isEmptyTilemap=function(e){var r=e.tileset.tiles,i=e.tilemap,n=r[0].id;for(let t=0;t<i.width;t++)for(let e=0;e<i.height;e++)if(r[i.get(t,e)].id!==n)return!1;return!0},s.computeAverageColor=function(r,e){var i=e.map(E),n=[0,0,0];let s=0;for(let t=0;t<r.width;t++)for(let e=0;e<r.height;e++){var a=r.get(t,e);a&&(++s,a=i[a],n[0]+=a[0],n[1]+=a[1],n[2]+=a[2])}return s?"#"+(t=>{let r="";for(let e=0;e<t.length;++e)r+=("0"+t[e].toString(16)).slice(-2);return r})(n.map(e=>Math.floor(e/s))):"#00000000"},s.getBitmap=function(e,t){return(e=e.apis.byQName[t])?r(e.attributes.jresURL):null},s.getBitmapFromJResURL=r,s.hexToBitmap=t,s.filterItems=function(e,t){let n=(t=t.filter(e=>!!e).map(e=>e.toLowerCase())).filter(e=>0!==e.indexOf("!")),s=t.filter(e=>0===e.indexOf("!")&&1<e.length).map(e=>e.substring(1));return e.filter(e=>{return i=e,n.every(t=>{let r="?"+t;return i.tags.some(e=>e===t||e===r)})&&(r=e,s.every(t=>!r.tags.some(e=>e===t)));var r,i})},s.getGalleryItems=function(e,t){i=e.apis,n=t;let r=c.Util.values(i.byQName).filter(e=>4===e.kind&&e.attributes.fixedInstance&&((e,t,r)=>t==r||!(!(e=e.byQName[t])||!e.extendsTypes)&&0<=e.extendsTypes.indexOf(r))(i,e.retType,n));var i,n;r=r.filter(e=>e.namespace!=s.TILE_NAMESPACE);{e=r;let t=new c.ImageConverter;e.forEach(e=>{e.attributes.jresURL&&!e.attributes.iconURL&&0==e.attributes.jresURL.indexOf("data:image/x-mkcd-f")&&(e.attributes.iconURL=t.convert(e.attributes.jresURL))})}return r.map(e=>{var t=(e.attributes.tags||"").split(" ").filter(e=>!!e).map(e=>c.Util.startsWith(e,"category-")?e:e.toLowerCase());return{qName:e.qName,src:e.attributes.iconURL,alt:e.qName,tags:t}})},s.base64EncodeBitmap=function(e){let r=x.fromData(e);return e=pxtc.f4EncodeImg(e.width,e.height,4,(e,t)=>r.get(e,t)),btoa(c.U.uint8ArrayToString(w(e)))},s.tilemapLiteralToTilemap=o,s.hexEncodeTilemap=l,s.formatByte=i,s.resizeBitmap=u,s.resizeTilemap=d,s.imageLiteralToBitmap=h,s.encodeAnimationString=function(e,t){var r=e.map(e=>e.data);let i=new Uint8ClampedArray(8+r[0].length*r.length),n=(k(i,0,t),k(i,2,e[0].width),k(i,4,e[0].height),k(i,6,e.length),8);return r.forEach(e=>{i.set(e,n),n+=e.length}),btoa(c.sprite.uint8ArrayToHex(i))},s.addMissingTilemapTilesAndReferences=function(e,r){var i=e.getProjectTiles(r.data.tileset.tileWidth,!0);r.data.projectReferences=[];for(let t of i.tiles)r.data.tileset.tiles.some(e=>e.id===t.id)||r.data.tileset.tiles.push(t),e.isAssetUsed(t,null,[r.id])&&r.data.projectReferences.push(t.id)},s.updateTilemapReferencesFromResult=function(r,e){var i=e.data;if(i.deletedTiles)for(var t of i.deletedTiles)r.deleteTile(t);if(i.editedTiles)for(let t of i.editedTiles){var n=i.tileset.tiles.findIndex(e=>e.id===t),s=i.tileset.tiles[n];s&&(i.tileset.tiles[n]=r.updateTile(s))}for(let e=0;e<i.tileset.tiles.length;e++){var a=i.tileset.tiles[e];a.jresData||(i.tileset.tiles[e]=r.resolveTile(a.id))}c.sprite.trimTilemapTileset(i)},s.isTilemapEmptyOrUnused=function(r,e,t){var i=n.Bitmap.fromData(r.data.layers);for(let t=0;t<r.data.tilemap.width;t++)for(let e=0;e<r.data.tilemap.height;e++)if(r.data.tilemap.get(t,e)||i.get(t,e))return!1;return!e.isAssetUsed(r,t)},s.imageLiteralFromDimensions=function(t,r,i,e){let n=p(e);var s=300<t*r?"":" ";for(let e=0;e<r;e++){n+="\n";for(let e=0;e<t;e++)n+=a[i]+s}return n=(n+="\n")+f(e)},s.bitmapToImageLiteral=m,s.bitmapEquals=g,s.tilesetEquals=b,s.tileWidthToTileScale=v,s.tileScaleToTileWidth=y,s.hexToUint8Array=w,s.uint8ArrayToHex=A,s.colorStringToRGB=E}})(pxt=pxt||{}),(a=>{var o=a.sprite||(a.sprite={});{var e=o.legacy||(o.legacy={});let s=new RegExp(`^\\s*${o.TILE_NAMESPACE}\\s*\\.\\s*${o.TILE_PREFIX}(\\d+)\\s*$`);class l{constructor(e,t,r){this.tilemap=e,this.tileset=t,this.layers=r,this.nextId=0}}e.LegacyTilemapData=l,e.decodeTilemap=function(e,t){var r,i,n;return null!=(e=null==(n=a.Util.htmlUnescape(e))?void 0:n.trim())&&e.trim()?(n=(e=(e=e.substr(e.indexOf("(")+1)).substr(0,e.lastIndexOf(")"))).substr(0,e.indexOf(",")),r=(e=e.substr(n.length+1)).substr(0,e.indexOf(",")),i=(e=e.substr(r.length+1)).substr(0,e.lastIndexOf("]")+1),e=e=e.substr(i.length+1),new l(o.tilemapLiteralToTilemap(n),{tiles:(n=(n=i).replace(/[\[\]]/g,""))?n.split(",").filter(e=>!!e.trim()).map(e=>{var t;return 0===(e=e.trim()).indexOf("img")?{data:o.imageLiteralToBitmap(e).data()}:(t=s.exec(e))?{data:null,projectId:Number(t[1])}:{data:null,qualifiedName:e}}):[],tileWidth:o.tileScaleToTileWidth(e)},o.imageLiteralToBitmap(r).data())):new l(new o.Tilemap(16,16),{tileWidth:16,tiles:[]},new o.Bitmap(16,16).data())},e.tileToBlocklyVariable=function(e){return`${e.projectId};${e.data.width};${e.data.height};`+pxtc.Util.toHex(e.data.data)},e.blocklyVariableToTile=function(e){return 4!==(e=e.split(";")).length?null:{projectId:parseInt(e[0]),data:{width:parseInt(e[1]),height:parseInt(e[2]),data:new Uint8ClampedArray(pxtc.Util.fromHex(e[3])),x0:0,y0:0}}}}})(pxt=pxt||{}),(s=>{{var e=s.storage||(s.storage={});class o{constructor(){this.items={}}removeItem(e){delete this.items[e]}getItem(e){return this.items[e]}setItem(e,t){this.items[e]=t}clear(){this.items={}}}class l{constructor(e){this.storageId=e,this.type="localstorage"}targetKey(e){return this.storageId+"/"+e}removeItem(e){window.localStorage.removeItem(this.targetKey(e))}getItem(e){return window.localStorage[this.targetKey(e)]}setItem(e,t){window.localStorage[this.targetKey(e)]=t}clear(){var t=this.targetKey(""),r=[];for(let e=0;e<window.localStorage.length;++e){var i=window.localStorage.key(e);0==i.indexOf(t)&&r.push(i)}r.forEach(e=>window.localStorage.removeItem(e))}}function a(){var e;return s.appTarget?s.appTarget.id:(e=window.pxtConfig)?e.targetId:(e=window.pxtTargetBundle)?e.id:""}e.storageId=a;let n;function r(){if(!n){var t=a();let e=!1;if(!s.shell.isSandboxMode())try{var r=s.Util.guidGen(),i=(window.localStorage[t]=r,window.localStorage[t]);e=i===r}catch(e){}e?(n=new l(t),s.debug("storage: local under "+t)):(n=new o,s.debug("storage: in memory"))}}e.setLocal=function(e,t){r(),n.setItem(e,t)},e.getLocal=function(e){return r(),n.getItem(e)},e.removeLocal=function(e){r(),n.removeItem(e)},e.clearLocal=function(){r(),n.clear()}}})(pxt=pxt||{}),(s=>{var t=s.storage||(s.storage={});{t=t.shared||(t.shared={});let e=!0,n="http://localhost:3232/api/store/";function a(){return e&&s.BrowserUtils.isLocalHostDev()&&!s.BrowserUtils.noSharedLocalStorage()}function o(){return s.BrowserUtils.isChromiumEdge()?"chromium-edge":s.BrowserUtils.browser()}t.getAsync=async function(e,t){if(a()){e+="-"+o();var r=await s.Util.requestAsync({url:n+encodeURIComponent(e)+"/"+encodeURIComponent(t),method:"GET",allowHttpErrors:!0});if(204===r.statusCode)throw new Error(`Missing ${t} not available in `+e);return r.json||r.text||void 0}return r=s.storage.getLocal(e+":"+t),s.Util.jsonTryParse(r)||r},t.setAsync=async function(t,r,i){if(void 0===i)await s.storage.shared.delAsync(t,r);else{let e="";e="object"==typeof i?JSON.stringify(i):i.toString(),a()?(t+="-"+o(),i={type:"object"==typeof i?"json":"text",val:e},i=JSON.stringify(i),await s.Util.requestAsync({url:n+encodeURIComponent(t)+"/"+encodeURIComponent(r),method:"POST",data:i})):s.storage.setLocal(t+":"+r,e)}},t.delAsync=async function(e,t){a()?(e+="-"+o(),await s.Util.requestAsync({url:n+encodeURIComponent(e)+"/"+encodeURIComponent(t),method:"DELETE",allowHttpErrors:!0})):s.storage.removeLocal(e+":"+t)}}})(pxt=pxt||{}),(pxt||(pxt={})).getSectionsFromMarkdownMetadata=function(e){var t,r,i,e=e.split(/\r?\n/);let n=[],s=null,a=null,o=null,l=[],c=0;for(t of e)if(t.trim()){if(t.startsWith("#")){var u=/^(#+)\s*(.+)$/.exec(t);if(u){d(),s={headerKind:1===u[1].length?"single":2===u[1].length?"double":"triple",header:u[2],attributes:{}},a=null,o=null,c=0;continue}}s&&(u=(t=>{let r=0;for(let e=0;e<t.length;e++)if(" "===t.charAt(e))r++;else{if("\t"!==t.charAt(e))return r;r+=4}return 0})(t),r=t.trim(),r=/^[*-]\s+(?:([^:]+):)?(.*)$/.exec(r))&&(1<Math.abs(u-c)&&a&&(u>c?(i={key:a,items:[]},l.length?l[l.length-1].items.push(i):(s.listAttributes||(s.listAttributes={}),s.listAttributes[a]=i),a=null,l.push(i)):(i=l.pop(),a&&o&&(null!=i&&i.items.push((a+":"+o).trim()),o=null)),c=u),r)&&(r[1]?(a&&o&&(l.length?l[l.length-1].items.push((a+":"+o).trim()):s.attributes[a]=o.trim()),a=r[1].trim().toLowerCase(),o=r[2]):a&&(o+=r[2]))}else o&&(o+="\n");return d(),n;function d(){s&&(a&&o&&(l.length?l[l.length-1].items.push((a+":"+o).trim()):s.attributes[a]=o.trim()),n.push(s)),l=[]}},(r=>{var i;{var n=r.multiplayer||(r.multiplayer={});let e,t=((i=e=e||{})[i.PROD=0]="PROD",i[i.STAGING=1]="STAGING",i[i.LOCAL=2]="LOCAL",e.STAGING);n.ABSOLUTE_LINKS={PROD_BETA:"https://arcade.makecode.com/beta--multiplayer",STAGING_BETA:"https://arcade.staging.pxt.io/beta--multiplayer",LOCAL:"http://localhost:3000"},n.RELATIVE_LINKS={PROD:"/--multiplayer",BETA:"/beta--multiplayer"},n.SHORT_LINKS={PROD:"https://aka.ms/a9",PROD_BETA:"https://aka.ms/a9b",STAGING:"https://aka.ms/a9s",STAGING_BETA:"https://aka.ms/a9sb"},n.RELATIVE_LINK=()=>{if(r.BrowserUtils.isLocalHostDev())switch(t){case e.PROD:return n.ABSOLUTE_LINKS.PROD_BETA;case e.STAGING:return n.ABSOLUTE_LINKS.STAGING_BETA;case e.LOCAL:return n.ABSOLUTE_LINKS.LOCAL}return window.location.pathname.startsWith("/beta")?n.RELATIVE_LINKS.BETA:n.RELATIVE_LINKS.PROD},n.SHORT_LINK=()=>{if(r.BrowserUtils.isLocalHostDev())switch(t){case e.PROD:return n.SHORT_LINKS.PROD_BETA;case e.STAGING:return n.SHORT_LINKS.STAGING_BETA;case e.LOCAL:return n.ABSOLUTE_LINKS.LOCAL}return window.location.host.endsWith(".staging.pxt.io")?window.location.pathname.startsWith("/beta")?n.SHORT_LINKS.STAGING_BETA:n.SHORT_LINKS.STAGING:window.location.pathname.startsWith("/beta")?n.SHORT_LINKS.PROD_BETA:n.SHORT_LINKS.PROD},n.makeHostLink=function(e,t){return`${t?n.SHORT_LINK():n.RELATIVE_LINK()}?host=`+encodeURIComponent(e)},n.makeJoinLink=function(e,t){return`${t?n.SHORT_LINK():n.RELATIVE_LINK()}?join=`+encodeURIComponent(e)}}})(pxt=pxt||{}),(t=>{var e;function p(e,t,r){var i=new Uint8Array(2);new Uint16Array(i.buffer)[0]=0|r,e[t]=i[0],e[t+1]=i[1]}function c(e,t){var r=new Uint8Array(2);return r[0]=e[t],r[1]=e[t+1],new Uint16Array(r.buffer)[0]}function f(t){var r=new Uint8Array(5+7*t.steps.length);r[0]=t.steps.length,p(r,1,t.startFrequency),p(r,3,t.startVolume);for(let e=0;e<t.steps.length;e++){var i=5+7*e;r[i]=t.steps[e].waveform,p(r,1+i,t.steps[e].frequency),p(r,3+i,t.steps[e].volume),p(r,5+i,t.steps[e].duration)}return r}function m(t,r,i){var n=new Uint8Array(5+t.notes.length);p(n,0,t.startTick),p(n,2,t.endTick),n[4]=t.notes.length;for(let e=0;e<t.notes.length;e++)n[5+e]=((e,t,r)=>{if(r)return e.note;let i=0;return"flat"===e.enharmonicSpelling?i=1:"sharp"===e.enharmonicSpelling&&(i=2),e.note-12*(t-2)|i<<6})(t.notes[e],r,i);return n}function a(t){if(t.drums){var r,i,n=t,s=n.drums.map(f),a=s.reduce((e,t)=>t.length+e,0),o=n.notes.map(e=>m(e,0,!0)),l=o.reduce((e,t)=>t.length+e,0),c=new Uint8Array(6+a+l);c[0]=n.id,c[1]=1,p(c,2,a);let e=4;for(r of s)c.set(r,e),e+=r.length;p(c,e,l),e+=2;for(i of o)c.set(i,e),e+=i.length;return c}{var u=t;var d,n=(e=>{var t,r=new Uint8Array(28);return r[0]=e.waveform,p(r,1,e.ampEnvelope.attack),p(r,3,e.ampEnvelope.decay),p(r,5,e.ampEnvelope.sustain),p(r,7,e.ampEnvelope.release),p(r,9,e.ampEnvelope.amplitude),p(r,11,(null==(t=e.pitchEnvelope)?void 0:t.attack)||0),p(r,13,(null==(t=e.pitchEnvelope)?void 0:t.decay)||0),p(r,15,(null==(t=e.pitchEnvelope)?void 0:t.sustain)||0),p(r,17,(null==(t=e.pitchEnvelope)?void 0:t.release)||0),p(r,19,(null==(t=e.pitchEnvelope)?void 0:t.amplitude)||0),r[21]=(null==(t=e.ampLFO)?void 0:t.frequency)||0,p(r,22,(null==(t=e.ampLFO)?void 0:t.amplitude)||0),r[24]=(null==(t=e.pitchLFO)?void 0:t.frequency)||0,p(r,25,(null==(t=e.pitchLFO)?void 0:t.amplitude)||0),r[27]=e.octave,r})(u.instrument),a=u.notes.map(e=>m(e,u.instrument.octave,!1)),s=a.reduce((e,t)=>t.length+e,0),h=new Uint8Array(6+n.length+s);h[0]=u.id,h[1]=0,p(h,2,n.length);let e=4;h.set(n,e),e+=n.length,p(h,e,s),e+=2;for(d of a)h.set(d,e),e+=d.length;return h;return}}function u(t,r,i,n){var s={startTick:c(t,r),endTick:c(t,r+2),notes:[]};for(let e=0;e<t[r+4];e++)s.notes.push(((e,t,r)=>{var i=e>>6,r={note:r?e:(63&e)+12*(t-2),enharmonicSpelling:"normal"};return 1==i?r.enharmonicSpelling="flat":2==i&&(r.enharmonicSpelling="sharp"),r})(t[r+5+e],i,n));return s}function r(e){return{ticksPerBeat:8,beatsPerMeasure:4,beatsPerMinute:120,measures:e,tracks:[{id:0,name:lf("Dog"),notes:[],iconURI:"music-editor/dog.png",instrument:{waveform:1,octave:4,ampEnvelope:{attack:10,decay:100,sustain:500,release:100,amplitude:1024},pitchLFO:{frequency:5,amplitude:0}}},{id:1,name:lf("Duck"),notes:[],iconURI:"music-editor/duck.png",instrument:{waveform:15,octave:4,ampEnvelope:{attack:5,decay:530,sustain:705,release:450,amplitude:1024},pitchEnvelope:{attack:5,decay:40,sustain:0,release:100,amplitude:40},ampLFO:{frequency:3,amplitude:20},pitchLFO:{frequency:6,amplitude:2}}},{id:2,name:lf("Cat"),notes:[],iconURI:"music-editor/cat.png",instrument:{waveform:12,octave:5,ampEnvelope:{attack:150,decay:100,sustain:365,release:400,amplitude:1024},pitchEnvelope:{attack:120,decay:300,sustain:0,release:100,amplitude:50},pitchLFO:{frequency:10,amplitude:6}}},{id:3,name:lf("Fish"),notes:[],iconURI:"music-editor/fish.png",instrument:{waveform:1,octave:3,ampEnvelope:{attack:220,decay:105,sustain:1024,release:350,amplitude:1024},ampLFO:{frequency:5,amplitude:100},pitchLFO:{frequency:1,amplitude:4}}},{id:4,name:lf("Car"),notes:[],iconURI:"music-editor/car.png",instrument:{waveform:16,octave:4,ampEnvelope:{attack:5,decay:100,sustain:1024,release:30,amplitude:1024},pitchLFO:{frequency:10,amplitude:4}}},{id:5,name:lf("Computer"),notes:[],iconURI:"music-editor/computer.png",instrument:{waveform:15,octave:2,ampEnvelope:{attack:10,decay:100,sustain:500,release:10,amplitude:1024}}},{id:6,name:lf("Burger"),notes:[],iconURI:"music-editor/burger.png",instrument:{waveform:1,octave:2,ampEnvelope:{attack:10,decay:100,sustain:500,release:100,amplitude:1024}}},{id:7,name:lf("Cherry"),notes:[],iconURI:"music-editor/cherry.png",instrument:{waveform:2,octave:3,ampEnvelope:{attack:10,decay:100,sustain:500,release:100,amplitude:1024}}},{id:8,name:lf("Lemon"),notes:[],iconURI:"music-editor/lemon.png",instrument:{waveform:14,octave:2,ampEnvelope:{attack:5,decay:70,sustain:870,release:50,amplitude:1024},pitchEnvelope:{attack:10,decay:45,sustain:0,release:100,amplitude:20},ampLFO:{frequency:1,amplitude:50},pitchLFO:{frequency:2,amplitude:1}}},{id:9,name:lf("Drums"),notes:[],iconURI:"music-editor/explosion.png",instrument:{waveform:11,octave:4,ampEnvelope:{attack:10,decay:100,sustain:500,release:100,amplitude:1024}},drums:[{startFrequency:100,startVolume:1024,steps:[{waveform:3,frequency:120,duration:10,volume:1024},{waveform:3,frequency:1,duration:100,volume:0}]},{startFrequency:200,startVolume:1024,steps:[{frequency:0,volume:0,duration:100,waveform:1}]},{startFrequency:100,startVolume:1024,steps:[{frequency:0,volume:0,duration:250,waveform:1}]},{startFrequency:175,startVolume:1024,steps:[{waveform:1,frequency:200,duration:10,volume:1024},{waveform:1,frequency:150,duration:20,volume:1024},{waveform:5,frequency:1,duration:20,volume:100},{waveform:5,frequency:1,duration:300,volume:0}]},{startFrequency:220,startVolume:1024,steps:[{waveform:1,frequency:250,duration:10,volume:1024},{waveform:1,frequency:200,duration:20,volume:1024},{waveform:5,frequency:2e3,duration:20,volume:100},{waveform:5,frequency:2e3,duration:200,volume:0}]},{startFrequency:400,startVolume:500,steps:[{frequency:450,volume:500,duration:10,waveform:5},{frequency:400,volume:20,duration:20,waveform:5}]},{startFrequency:400,startVolume:0,steps:[{frequency:450,volume:500,duration:5,waveform:5},{frequency:900,volume:5,duration:50,waveform:5},{frequency:900,volume:0,duration:250,waveform:5}]},{startFrequency:400,startVolume:0,steps:[{frequency:450,volume:500,duration:5,waveform:5},{frequency:900,volume:200,duration:50,waveform:5},{frequency:900,volume:5,duration:100,waveform:5},{frequency:900,volume:0,duration:400,waveform:5}]},{startFrequency:400,startVolume:0,steps:[{frequency:450,volume:500,duration:5,waveform:5},{frequency:900,volume:200,duration:100,waveform:5},{frequency:900,volume:5,duration:200,waveform:5},{frequency:900,volume:0,duration:500,waveform:5}]},{startFrequency:3500,startVolume:1024,steps:[{frequency:4e3,volume:0,duration:10,waveform:4},{frequency:3500,volume:800,duration:1,waveform:4},{frequency:4e3,volume:0,duration:40,waveform:4},{frequency:3500,volume:400,duration:1,waveform:4},{frequency:4e3,volume:0,duration:40,waveform:4}]},{startFrequency:2e3,startVolume:1024,steps:[{frequency:1800,volume:15,duration:100,waveform:4},{frequency:1800,volume:0,duration:200,waveform:4}]},{startFrequency:200,startVolume:200,steps:[{frequency:125,volume:200,duration:25,waveform:14},{frequency:100,volume:15,duration:50,waveform:14},{frequency:120,volume:0,duration:250,waveform:14}]},{startFrequency:300,startVolume:200,steps:[{frequency:225,volume:200,duration:25,waveform:14},{frequency:200,volume:15,duration:50,waveform:14},{frequency:220,volume:0,duration:250,waveform:14}]},{startFrequency:500,startVolume:200,steps:[{frequency:425,volume:200,duration:25,waveform:14},{frequency:400,volume:15,duration:50,waveform:14},{frequency:420,volume:0,duration:250,waveform:14}]},{startFrequency:200,startVolume:1024,steps:[{frequency:75,volume:0,duration:200,waveform:1}]},{startFrequency:300,startVolume:1024,steps:[{frequency:200,volume:0,duration:200,waveform:1}]},{startFrequency:400,startVolume:1024,steps:[{frequency:300,volume:0,duration:200,waveform:1}]},{startFrequency:200,startVolume:1024,steps:[{frequency:200,volume:15,duration:100,waveform:4},{frequency:150,volume:0,duration:200,waveform:4}]},{startFrequency:450,startVolume:1024,steps:[{frequency:350,volume:15,duration:100,waveform:4},{frequency:300,volume:0,duration:100,waveform:4}]},{startFrequency:2500,startVolume:1024,steps:[{frequency:2500,volume:100,duration:150,waveform:4},{frequency:2550,volume:0,duration:500,waveform:4}]},{startFrequency:3e3,startVolume:1024,steps:[{frequency:3e3,volume:100,duration:300,waveform:4},{frequency:3060,volume:0,duration:500,waveform:4}]},{startFrequency:800,startVolume:0,steps:[{frequency:800,volume:1024,duration:10,waveform:4},{frequency:800,volume:0,duration:490,waveform:4}]},{startFrequency:400,startVolume:0,steps:[{frequency:400,volume:1024,duration:10,waveform:4},{frequency:400,volume:0,duration:400,waveform:4}]},{startFrequency:2e3,startVolume:1024,steps:[{frequency:2e3,volume:100,duration:150,waveform:16},{frequency:2e3,volume:0,duration:200,waveform:16}]}]}]}}(e=(e=t.assets||(t.assets={})).music||(e.music={})).encodeSongToHex=function(e){return e=(e=>{var t,r=e.tracks.filter(e=>0<e.notes.length).map(a),i=r.reduce((e,t)=>t.length+e,0),n=new Uint8Array(7+i);n[0]=0,p(n,1,e.beatsPerMinute),n[3]=e.beatsPerMeasure,n[4]=e.ticksPerBeat,n[5]=e.measures,n[6]=r.length;let s=7;for(t of r)n.set(t,s),s+=t.length;return n})(e),t.U.toHex(e)},e.decodeSongFromHex=function(r){r=t.U.fromHex(r);{var i=r;let e={beatsPerMinute:c(i,1),beatsPerMeasure:i[3],ticksPerBeat:i[4],measures:i[5],tracks:[]},t=7;for(;t<i.length;){var[n,s]=((n,s)=>{if(n[s+1]){var i=n,a=s;let e={id:i[a],instrument:{ampEnvelope:{attack:0,decay:0,sustain:0,release:0,amplitude:0},waveform:0},notes:[],drums:[]},t=c(i,a+2),r=a+4;for(;r<a+4+t;)e.drums.push(((t,r)=>{var i={startFrequency:c(t,r+1),startVolume:c(t,r+3),steps:[]};for(let e=0;e<t[r];e++){var n=r+5+7*e;i.steps.push({waveform:t[n],frequency:c(t,n+1),volume:c(t,n+3),duration:c(t,n+5)})}return i})(i,r)),r+=5+7*e.drums[e.drums.length-1].steps.length;var o=c(i,r);for(r+=2;r<a+4+t+o;)e.notes.push(u(i,r,0,!0)),r+=5+e.notes[e.notes.length-1].notes.length;return[e,r]}{var l=n,n=s;let e={id:l[n],instrument:((e,t)=>({waveform:e[t],ampEnvelope:{attack:c(e,t+1),decay:c(e,t+3),sustain:c(e,t+5),release:c(e,t+7),amplitude:c(e,t+9)},pitchEnvelope:{attack:c(e,t+11),decay:c(e,t+13),sustain:c(e,t+15),release:c(e,t+17),amplitude:c(e,t+19)},ampLFO:{frequency:e[t+21],amplitude:c(e,22)},pitchLFO:{frequency:e[t+24],amplitude:c(e,25)},octave:e[t+27]}))(l,n+4),notes:[]},t=n+4+c(l,n+2),r=c(l,t),i=t+2;for(;i<t+2+r;)e.notes.push(u(l,i,e.instrument.octave,!1)),i+=5+e.notes[e.notes.length-1].notes.length;return[e,i]}})(i,t);t=s,e.tracks.push(n)}return e}},e.cloneSong=function(e){return Object.assign(Object.assign({},e),{tracks:e.tracks.map(e=>Object.assign(Object.assign({},e),{instrument:e.instrument&&Object.assign(Object.assign({},e.instrument),{ampEnvelope:Object.assign({},e.instrument.ampEnvelope),pitchEnvelope:e.instrument.pitchEnvelope&&Object.assign({},e.instrument.pitchEnvelope),ampLFO:e.instrument.ampLFO&&Object.assign({},e.instrument.ampLFO),pitchLFO:e.instrument.pitchLFO&&Object.assign({},e.instrument.pitchLFO)}),drums:e.drums&&e.drums.map(e=>Object.assign(Object.assign({},e),{steps:e.steps.map(e=>Object.assign({},e))})),notes:e.notes.map(e=>Object.assign(Object.assign({},e),{notes:e.notes.slice()}))}))})},e.songEquals=function(e,t){return function t(r,i){{if(typeof r!=typeof i)return!1;if("object"!=typeof r)return r===i;if(Array.isArray(r)){if(r.length!==i.length)return!1;for(let e=0;e<r.length;e++)if(!t(r[e],i[e]))return!1;return!0}}let e=Object.keys(r);let n=Object.keys(i);if(e.length!==n.length)return!1;for(var s of e){if(-1===n.indexOf(s))return!1;if(!t(r[s],i[s]))return!1}return!0}(e,t)},e.inflateSong=function(i){var e=r(1);i.tracks=e.tracks.map((e,t)=>{var r=i.tracks.find(e=>e.id===t);return r&&(e.notes=r.notes),e})},e.getSongInfo=function(e){return{ticksPerBeat:e.ticksPerBeat,beatsPerMeasure:e.beatsPerMeasure,beatsPerMinute:e.beatsPerMinute,measures:e.measures}},e.getEmptySong=r})(pxt=pxt||{}),(m=>{let s=["name","version","description","license","dependencies","files","testFiles","testDependencies","fileDependencies","public","targetVersions","supportedTargets","preferredEditor","languageRestriction","additionalFilePath","additionalFilePaths"];class p{constructor(e,t,r,i,n){this.id=e,this._verspec=t,this.parent=r,this.depName=n,this.level=-1,this.isLoaded=!1,this.ignoreTests=!1,this.cppOnly=!1,i&&(this.level=i.level+1),this.addedBy=[i]}static stringifyConfig(e){var t,r,i=e,n={};for(t of s)i.hasOwnProperty(t)&&(n[t]=i[t]);for(r of Object.keys(i))n.hasOwnProperty(r)||(n[r]=i[r]);return JSON.stringify(n,null,4)+"\n"}static parseAndValidConfig(e){let t=m.Util.jsonTryParse(e);return t&&void 0!==t.name&&"string"==typeof t.name&&t.files&&Array.isArray(t.files)&&t.files.every(e=>"string"==typeof e)&&t.dependencies&&Object.keys(t.dependencies).every(e=>"string"==typeof t.dependencies[e])&&t}static async getConfigAsync(e,t,r){var i,n;if(m.github.isGithubId(r))return i=m.github.parseRepoId(r),n=await m.packagesConfigAsync(),await m.github.repoAsync(i.fullName,n)?await m.github.pkgConfigAsync(i.fullName,i.tag,n):null;if(r.startsWith("workspace:"))return r.slice("workspace:".length),null;if(!r.startsWith("pub:"))return i=m.patching.upgradePackageReference(e,t,r),n=m.appTarget.bundledpkgs[i],JSON.parse(n[m.CONFIG_NAME]);{let e=r.slice("pub:".length);try{var s=await m.Cloud.downloadScriptFilesAsync(e);return JSON.parse(s[m.CONFIG_NAME])}catch(e){return m.log(`Unable to fetch files for published script '${r}'`),null}}}static corePackages(){let t=m.appTarget.bundledpkgs;return Object.keys(t).map(e=>JSON.parse(t[e][m.CONFIG_NAME])).filter(e=>!!e)}disablesVariant(e){return this.config&&this.config.disablesVariants&&0<=this.config.disablesVariants.indexOf(e)}invalid(){return/^invalid:/.test(this.version())}version(){return this.resolvedVersion||this._verspec}verProtocol(){var e=this.version().split(":");return 1<e.length?e[0]:""}verArgument(){var e=this.verProtocol();return e?this.version().slice(e.length+1):this.version()}targetVersion(){return this.parent&&this.parent!=this?this.parent.targetVersion():this.config.targetVersions?this.config.targetVersions.target:void 0}async commonDownloadAsync(){var e,t=this.verProtocol();let r;return"pub"==t?r=await m.Cloud.downloadScriptFilesAsync(this.verArgument()):"github"==t?(e=await m.packagesConfigAsync(),e=await m.github.downloadPackageAsync(this.verArgument(),e),r=e.files):"embed"==t?r=m.getEmbeddedScript(this.verArgument()):"pkg"==t&&(e=(this.parent||this).readFile(this.verArgument()),(t=m.U.jsonTryParse(e))||m.log("unable to find "+this.verArgument()),r=t),r}writeAssetPackFiles(){var e,t=JSON.parse(JSON.stringify(this.config));t.files=t.files.filter(e=>e.endsWith(".jres")),t.files.push("gallery.ts"),t.dependencies={},t.assetPack=!0,this.config=t,this.saveConfig();let r="";for(e of t.files){var i,n=this.readFile(e),n=m.U.jsonTryParse(n);n&&([n,i]=m.emitGalleryDeclarations(n,this.getNamespaceName()),this.writeFile(e,JSON.stringify(n,null,4)),r+=i)}this.writeFile("gallery.ts",r)}getNamespaceName(){let e=this,t=e.addedBy[0];for(var r=[];t&&t!==e;)e.depName&&r.push(e.depName),t=(e=t).addedBy[0];return r.reverse().map(e=>ts.pxtc.escapeIdentifier(e)).join(".")}host(){return this.parent._host}readFile(e){return this.host().readFile(this,e)}writeFile(e,t){this.host().writeFile(this,e,t,!0)}readGitJson(){var e=this.readFile(m.github.GIT_JSON);return m.Util.jsonTryParse(e)}resolveDep(e){return this.parent.deps.hasOwnProperty(e)?this.parent.deps[e]:null}saveConfig(){var e=m.U.clone(this.config),e=(delete e.additionalFilePaths,m.Package.stringifyConfig(e));this.host().writeFile(this,m.CONFIG_NAME,e)}setPreferredEditor(e){this.config.preferredEditor!=e&&(this.config.preferredEditor=e,this.saveConfig())}getPreferredEditor(){var e,t=this.config.preferredEditor;return t||(!(0<=this.getFiles().indexOf(m.MAIN_BLOCKS))||(t=this.readFile(m.MAIN_BLOCKS),e=this.readFile(m.MAIN_TS),!t&&e)?m.JAVASCRIPT_PROJECT_NAME:m.BLOCKS_PROJECT_NAME)}parseJRes(e={}){for(var t of this.getFiles())m.U.endsWith(t,".jres")&&r(JSON.parse(this.readFile(t)),e);return e}isAssetPack(){var e;return 0<this.level&&!(null==(e=this.config)||!e.assetPack)}resolveVersionAsync(){let e,r=this._verspec;if(m.getEmbeddedScript(this.id))this.resolvedVersion=r="embed:"+this.id;else if(r&&"*"!=r){if("github"==this.verProtocol()){let t=m.github.parseRepoId(this._verspec);var i;t&&!t.tag&&this.parent&&(m.debug("dep: unbound github extensions, trying to resolve tag"),i=m.semver.sortLatestTags(m.Util.values((null==(e=this.parent)?void 0:e.deps)||{}).map(e=>m.github.parseRepoId(e.version())).filter(e=>(null==e?void 0:e.slug)===t.slug).map(e=>e.tag))[0])&&(t.tag=i,this.resolvedVersion=r=m.github.stringifyRepo(t),m.debug(`dep: github patched ${this._verspec} to `+r))}}else this.configureAsInvalidPackage(lf("version not specified for {0}",this.id)),r=this._verspec;return Promise.resolve(r)}downloadAsync(){return this.resolveVersionAsync().then(e=>{if(this.invalid())m.debug("skip download of invalid package "+this.id);else if(/^embed:/.test(e)||this.installedVersion!=e)return m.debug("downloading "+e),this.host().downloadPackageAsync(this).then(()=>{this.loadConfig(),this.isAssetPack()&&this.writeAssetPackFiles(),m.debug(`installed ${this.id} /`+e)})})}loadConfig(){var e;0!=this.level&&this.invalid()||((e=this.readFile(m.CONFIG_NAME))||m.U.userError(`extension ${this.id} is missing `+m.CONFIG_NAME),this.parseConfig(e),0!=this.level&&(this.installedVersion=this.version()),this.saveConfig())}validateConfig(){this.config.dependencies||m.U.userError("Missing dependencies in config of: "+this.id),Array.isArray(this.config.files)||m.U.userError("Missing files in config of: "+this.id),"string"==typeof this.config.name&&this.config.name||(this.config.name=lf("Untitled")),this.config.targetVersions&&this.config.targetVersions.target&&this.config.targetVersions.targetId===m.appTarget.id&&m.appTarget.versions&&0<m.semver.majorCmp(this.config.targetVersions.target,m.appTarget.versions.target)&&m.U.userError(lf("{0} requires target version {1} (you are running {2})",this.config.name,this.config.targetVersions.target,m.appTarget.versions.target))}isPackageInUse(r,e=this.readFile(m.MAIN_TS)){let i=null;var t=m.patching.computePatches(this.targetVersion(),"missingPackage");return t&&t.forEach(t=>{Object.keys(t.map).forEach(e=>{t.map[e]===r&&(i=new RegExp(e,"g"))})}),(i=i||new RegExp(r+"\\.","g")).test(e)}upgradePackagesAsync(){return this.config||this.loadConfig(),m.packagesConfigAsync().then(async i=>{let n=0,s={},e=[];return m.U.iterMap(this.config.dependencies,(t,r)=>{e.push((async()=>{var e;m.github.isGithubId(r)&&(e=await m.github.upgradedPackageReferenceAsync(i,r))&&e!=r&&(m.log(`upgrading dep ${t}: ${r} -> `+e),s[r]=e,this.config.dependencies[t]=e,n++)})())}),await Promise.all(e),n&&this.saveConfig(),n&&s})}getMissingPackages(n,s){var e=m.patching.computePatches(this.targetVersion(),"missingPackage");let a={};return s&&e&&e.forEach(i=>{Object.keys(i.map).forEach(e=>{var t=new RegExp(e,"g");let r=i.map[e];s.replace(t,e=>(n.dependencies[r]||(a[r]="*"),""))})}),a}findConflictsAsync(e,u){let d=[],h;return Promise.resolve().then(()=>"string"==typeof e?p.getConfigAsync(this.targetVersion(),e,u):Promise.resolve(e)).then(e=>{if(h=e){let c=h.yotta?m.U.jsonFlatten(h.yotta.config):null;this.parent.sortedDeps().forEach(t=>{var r,i;if(h.core&&t.config.core&&h.name!=t.config.name)(i=new m.cpp.PkgConflictError(lf("conflict between core extensions {0} and {1}",h.name,t.id))).pkg0=t,d.push(i);else{let e=!1;if(c){var n=t.config||JSON.parse(t.readFile(m.CONFIG_NAME));if(!!n&&!!n.yotta&&!!t.config.yotta.config){var s,a=m.U.jsonFlatten(n.yotta.config);for(s of Object.keys(c)){var o=a[s],l=h.yotta.configIsJustDefaults||n.yotta.configIsJustDefaults;!a.hasOwnProperty(s)||o===c[s]||l||t.parent.config.yotta&&t.parent.config.yotta.ignoreConflicts||((o=new m.cpp.PkgConflictError(lf("conflict on yotta setting {0} between extensions {1} and {2}",s,h.name,t.id))).pkg0=t,o.settingName=s,d.push(o),e=!0)}}}e||h.name!==t.id||t._verspec===u||/^file:/.test(t._verspec)||/^file:/.test(u)||(i=/^github:/.test(t._verspec)&&m.github.parseRepoId(t._verspec),r=/^github:/.test(u)&&m.github.parseRepoId(u),i&&r&&i.fullName===r.fullName&&!(r.tag&&m.semver.strcmp(i.tag,r.tag)<0))||((i=new m.cpp.PkgConflictError(lf("version mismatch for extension {0} (added: {1}, adding: {2})",t.id,t._verspec,u))).pkg0=t,i.isVersionConflict=!0,d.push(i))}})}return Object.keys(null!=(e=null==h?void 0:h.dependencies)?e:{}).reduce((e,t)=>e.then(()=>this.findConflictsAsync(t,h.dependencies[t])).then(e=>d.push.apply(d,e)),Promise.resolve())}).then(()=>{let i=e=>{let t=[];return e.addedBy.forEach(e=>{e.id!==this.id&&(t.push.apply(i(e)),t.push(e))}),t},e=[];return d.forEach(r=>{e.push.apply(e,i(r.pkg0).map(e=>{var t=new m.cpp.PkgConflictError(r.isVersionConflict?lf("a dependency of {0} has a version mismatch with extension {1} (added: {1}, adding: {2})",e.id,h.name,r.pkg0._verspec,u):lf("conflict on yotta setting {0} between extensions {1} and {2}",r.settingName,h.name,r.pkg0.id));return t.pkg0=e,t}))}),d.push.apply(d,e),d=d.filter((t,r)=>{for(let e=0;e<r;++e)if(t.pkg0.id===d[e].pkg0.id)return!1;return!0})})}configureAsInvalidPackage(e){m.log(`invalid package ${this.id}: `+e),this._verspec="invalid:"+this.id,this.config={name:this.id,description:e,dependencies:{},files:[]}}parseConfig(e,t){try{var r=JSON.parse(e);this.config=r}catch(e){this.configureAsInvalidPackage(lf("Syntax error in pxt.json")),m.tickEvent("package.invalidConfigEncountered")}var i,e=JSON.stringify(this.config);for(i in this.config.dependencies){var n=m.patching.upgradePackageReference(this.targetVersion(),i,this.config.dependencies[i]);n!=i&&(delete this.config.dependencies[i],n)&&(this.config.dependencies[n]="*")}t&&(this.config.targetVersions={target:t}),JSON.stringify(this.config)!=e&&this.saveConfig(),this.validateConfig()}patchCorePackage(){m.Util.assert(m.appTarget.simulator&&m.appTarget.simulator.dynamicBoardDefinition),m.Util.assert(0==this.level);var e,t=Object.keys(this.config.dependencies).filter(e=>!!e&&(e==m.BLOCKS_PROJECT_NAME||e==m.JAVASCRIPT_PROJECT_NAME||JSON.parse((m.appTarget.bundledpkgs[e]||{})[m.CONFIG_NAME]||"{}").core));0==t.length?(e=m.Package.corePackages()).length&&this.config.dependencies[e[0].name]:1<t.length&&(t.pop(),t.forEach(e=>{m.log("removing core package "+e),delete this.config.dependencies[e]}))}resolvedDependencies(){return Object.keys(this.dependencies()).map(e=>this.resolveDep(e))}dependencies(e=!1){if(!this.config)return{};let r=m.Util.clone(this.config.dependencies||{});return 0==this.level&&this.config.testDependencies&&m.Util.iterMap(this.config.testDependencies,(e,t)=>{"*"==t&&!m.appTarget.bundledpkgs[e]||(r[e]=t)}),e&&this.config.cppDependencies&&m.Util.jsonMergeFrom(r,this.config.cppDependencies),r}async loadAsync(c=!1,e){if(!this.isLoaded){0!=this.level||m.appTarget.multiVariants||m.setAppTargetVariant(null),this.isLoaded=!0;var r,i=this.readFile(m.CONFIG_NAME);if(null==i?c||m.U.userError("Package not installed: "+this.id+", did you forget to run `pxt install`?"):this.parseConfig(i),c||await this.upgradePackagesAsync(),c&&(await this.downloadAsync(),0!==this.level)&&!this.isAssetPack())for(var n of this.addedBy)if(null!=(n=n.config.assetPacks)&&n[this.id]){this.writeAssetPackFiles();break}c&&(i=await this.upgradePackagesAsync())&&(Object.keys(i).forEach(e=>m.tickEvent("package.doubleload",{extension:e})),m.log("upgraded, downloading again"),m.debug(i),await this.downloadAsync()),m.appTarget.simulator&&m.appTarget.simulator.dynamicBoardDefinition&&(0==this.level&&this.patchCorePackage(),this.config.compileServiceVariant&&m.setAppTargetVariant(this.config.compileServiceVariant),0<=this.config.files.indexOf("board.json"))&&((i=m.appTarget.simulator.boardDefinition=JSON.parse(this.readFile("board.json"))).id=this.config.name,m.appTarget.appTheme.boardName=i.boardName||lf("board"),m.appTarget.appTheme.driveDisplayName=i.driveDisplayName||lf("DRIVE"),i=e=>{var t,r=/^pkg:\/\/(.*)/.exec(e);return r?(r=r[1],t=this.readFile(r),m.U.toDataUri(t,m.U.getMime(r))):e},"object"==typeof(r=m.appTarget.simulator.boardDefinition).visual)&&((r=r.visual).image=i(r.image),r.outlineImage=i(r.outlineImage));let l=(e,t)=>{if(m.debug(`version spec mismatch: ${e._verspec} != `+t),/^github:/.test(e._verspec)&&/^github:/.test(t)){var r=m.github.parseRepoId(e._verspec),i=m.github.parseRepoId(t);if(null!=r&&r.slug&&(null==r?void 0:r.slug)===(null==i?void 0:i.slug)){var r=(null==r?void 0:r.tag)||(null==(r=e.config)?void 0:r.version),n=i.tag;if(r&&!n)return void m.debug(`unversioned ${t}, using `+r);n=m.semver.strcmp(r,i.tag);if(0==n)return void m.debug("resolved version are "+r);if(0<n)return void m.debug(`auto-upgraded ${t} to `+r)}}/^file:/.test(e._verspec)||/^file:/.test(t)?m.debug("ignore file: mismatch issues"):e.configureAsInvalidPackage(lf("version mismatch"))},t=async(i,n,s=!1)=>{i=i||n.dependencies(s),m.debug(`deps: ${n.id}->`+Object.keys(i).join(", ")),i=m.github.resolveMonoRepoVersions(i),m.debug(`deps: resolved ${n.id}->`+Object.keys(i).join(", "));for(var a of Object.keys(i)){let e=i[a]||"*",t=(m.debug(`dep: load ${n.id}.${a}${s?"++":""}: `+e),"hw"==a&&m.hwVariant&&(a="hw---"+m.hwVariant),m.github.parseRepoId(e));var o;null!=t&&t.slug&&(o=Object.values(n.parent.deps).map(e=>m.github.parseRepoId(e._verspec)).filter(e=>(null==e?void 0:e.slug)===t.slug).map(e=>e.tag).reduce((e,t)=>0<m.semver.strcmp(e,t)?e:t,"0.0.0"),m.debug(`dep: common repo ${t.slug} version found `+o),0<m.semver.strcmp(o,"0.0.0"))&&(!t.tag||0<m.semver.strcmp(o,t.tag))&&(m.debug(`dep: upgrade from ${t.tag} to `+o),t.tag=o,e=m.github.stringifyRepo(t,!0));let r=n.resolveDep(a);r?(r.invalid()||r._verspec===e||l(r,e),!r.invalid()&&s||(r.level=Math.min(r.level,n.level+1),r.addedBy.push(n))):(r=new p(a,e,n.parent,n,a),s&&(r.cppOnly=!0),n.parent.deps[a]=r,await(n.parent.deps[a.replace(/---.*/,"")]=r).loadAsync(c))}};if(await t(null,this),this.patchAppTargetPalette(),this.config.screenSize&&m.appTarget.runtime&&(m.appTarget.runtime.screenSize=m.U.clone(this.config.screenSize)),0===this.level){i=this.readFile(m.MAIN_TS);if(i){var s,a=this.getMissingPackages(this.config,i);let e=!1;for(s of Object.keys(a)){var o,u=await this.findConflictsAsync(s,a[s]);u.length?(o=u.map(e=>e.pkg0.id).join(", "),u=u.map(e=>e.settingName).filter(e=>!!e).join(", "),m.log(`skipping missing package ${s} because it conflicts with the following packages: ${o} (conflicting settings: ${u})`)):(m.log("adding missing package "+s),e=!0,this.config.dependencies[s]="*",(o={})[s]=a[s],await t(o,this))}e&&(this.saveConfig(),this.validateConfig())}await Promise.all(m.U.values(this.parent.deps).map(e=>t(null,e,!0)))}m.debug("  installed "+this.id)}}getFiles(){let e,t=(e=0!=this.level||this.ignoreTests?this.config.files.slice(0):this.config.files.concat(this.config.testFiles||[]),this.config.fileDependencies);return e=this.config.fileDependencies?e.filter(r=>{let i=e=>{var t;return"!"==(e=e.trim())[0]?!i(e.slice(1)):/^[\w-]+$/.test(e)?!(!(t=this.parent.resolveDep(e))||t.cppOnly):(t=/^target:(\w+)$/.exec(e))?t[1]==m.appTarget.id||t[1]==m.appTarget.platformid:(p.depWarnings[e]||(p.depWarnings[e]=!0,m.log(`invalid dependency expression: ${e} in ${this.id}/`+r)),!1)};var e=m.U.lookup(t,r);return!e||!e.trim()||e.split("||").some(e=>e.split("&&").every(i))}):e}addSnapshot(e,r=[""]){for(let t of this.getFiles())r.some(e=>m.U.endsWith(t,e))&&(e[this.id+"/"+t]=this.readFile(t));e[this.id+"/"+m.CONFIG_NAME]=this.readFile(m.CONFIG_NAME)}packageLocalizationStringsAsync(r){let i=m.appTarget.id;var e=[this.config.name+"-jsdoc",this.config.name];let n={};m.appTarget.appTheme;return this.config.skipLocalization?Promise.resolve(n):m.Util.liveLocalizationEnabled()&&"this"!=this.id&&m.appTarget.bundledpkgs[this.id]?(m.debug("loading live translations for "+this.id),Promise.all(e.map(t=>m.Util.downloadLiveTranslationsAsync(r,i+`/${t}-strings.json`).then(e=>{e&&Object.keys(e).length?m.Util.jsonMergeFrom(n,e):(m.tickEvent("translations.livetranslationsfailed",{filename:t}),m.Util.jsonMergeFrom(n,this.bundledStringsForFile(r,t)))}).catch(e=>{m.tickEvent("translations.livetranslationsfailed",{filename:t}),m.log(`error while downloading ${i}/${t}-strings.json`),m.Util.jsonMergeFrom(n,this.bundledStringsForFile(r,t))}))).then(()=>n)):(e.map(e=>this.bundledStringsForFile(r,e)).filter(e=>!!e).forEach(e=>m.Util.jsonMergeFrom(n,e)),Promise.resolve(n))}bundledStringsForFile(t,e){let r={};var[i,n,s]=m.Util.normalizeLanguageCode(t),a=this.config.files;let o=`_locales/${i}/${e}-strings.json`;if(s&&-1===a.indexOf(o)&&(o=`_locales/${s}/${e}-strings.json`),n&&-1===a.indexOf(o)&&(o=`_locales/${n}/${e}-strings.json`),-1<a.indexOf(o))try{r=JSON.parse(this.readFile(o))}catch(e){m.reportError("extension","Extension localization JSON failed to parse",{fileName:o,lang:t,extension:this.verArgument()}),"github"===this.verProtocol()&&m.tickEvent("loc.errors.json",{repo:this.verArgument(),file:o})}return r}patchAppTargetPalette(){this.config.palette&&m.appTarget.runtime&&(m.appTarget.runtime.palette=m.U.clone(this.config.palette),this.config.paletteNames)&&(m.appTarget.runtime.paletteNames=this.config.paletteNames)}}p.depWarnings={},m.Package=p;class e extends p{constructor(e){super("this","file:.",null,null,null),this._host=e,this.deps={},(this.parent=this).addedBy=[this],this.level=0,this.deps[this.id]=this}installAllAsync(e){return this.loadAsync(!0,e)}sortedDeps(r=!1){let i={},n=[],s=e=>e.config?Object.keys(e.config.cppDependencies||{}).length:0,a=e=>{var t;e&&!m.U.lookup(i,e.id)&&(i[e.id]=!0,(t=Object.keys(e.dependencies(r)).map(e=>this.resolveDep(e))).sort((e,t)=>s(t)-s(e)||m.U.strcmp(e.id,t.id)),t.forEach(a),n.push(e.id))};return a(this),n.map(e=>this.resolveDep(e))}localizationStringsAsync(t){let r={};return Promise.all(m.Util.values(this.deps).map(e=>e.packageLocalizationStringsAsync(t).then(t=>{t&&Object.keys(t).forEach(e=>{r[e]||(r[e]=t[e])})}))).then(()=>{let t=m.U.getLocalizedStrings();return Object.keys(r).forEach(e=>{!m.U.startsWith(e,"{id:subcategory}")&&!m.U.startsWith(e,"{id:group}")||t[e]||(t[e]=r[e])}),m.U.setLocalizedStrings(t),Promise.resolve(r)})}getTargetOptions(){let t=m.U.clone(m.appTarget.compile);return m.U.assert(!!t),t.utf8||this.sortedDeps(!0).forEach(e=>{e.config&&e.config.utf8&&(m.debug("forcing utf8 mode: pkg="+e.id),t.utf8=!0)}),t}getJRes(){if(!this._jres){this._jres={};for(var e of this.sortedDeps())e.parseJRes(this._jres);var t=(m.appTarget.runtime&&m.appTarget.runtime.palette?m.appTarget.runtime.palette:["#000000","#ffffff"]).map(e=>("000000"+parseInt(e.replace(/#/,""),16).toString(16)).slice(-6)).join("");this._jres.__palette={id:"__palette",data:t,dataEncoding:"hex",mimeType:"application/x-palette"}}return this._jres}updateJRes(){this._jres&&this.parseJRes(this._jres)}resolveBannedCategories(){if(void 0===this._resolvedBannedCategories){let t=[];m.appTarget&&m.appTarget.runtime&&m.appTarget.runtime.bannedCategories&&m.appTarget.runtime.bannedCategories.length&&(t=m.appTarget.runtime.bannedCategories.slice(),Object.keys(this.deps).map(e=>this.deps[e]).filter(e=>!!e).map(e=>m.Util.jsonTryParse(e.readFile(m.CONFIG_NAME))).filter(e=>e&&e.requiredCategories).forEach(e=>e.requiredCategories.forEach(e=>{e=t.indexOf(e);-1<e&&t.splice(e,1)})),this._resolvedBannedCategories=t),this._resolvedBannedCategories=t,this._resolvedBannedCategories.length||(this._resolvedBannedCategories=null)}return this._resolvedBannedCategories}async getCompileOptionsAsync(n=this.getTargetOptions()){let e,i={sourceFiles:[],fileSystem:{},target:n,name:this.config?this.config.name:""},s=(e,t)=>{this.config.files.indexOf(e)<0&&m.U.userError(lf("please add '{0}' to \"files\" in {1}",e,m.CONFIG_NAME)),t="// Auto-generated. Do not edit.\n"+t+"\n// Auto-generated. Do not edit. Really.\n",this.host().readFile(this,e,!0)!==t&&(m.debug(`updating ${e} (size=${t.length})...`),this.host().writeFile(this,e,t,!0))},a=m.appTarget.disabledVariants,o=!1,l=async e=>{var t={extinfo:null,target:null},r=m.appTargetVariant;e&&m.setAppTargetVariant(e,{temporary:!0});let i;try{t.target=m.appTarget.compile,i=m.cpp.getExtensionInfo(this),o||!i.shimsDTS&&!i.enumsDTS||(o=!0,i.shimsDTS&&s("shims.d.ts",i.shimsDTS),i.enumsDTS&&s("enums.d.ts",i.enumsDTS))}finally{e&&m.setAppTargetVariant(r,{temporary:!0})}i.appVariant=e;r=n.isNative?await this.host().getHexInfoAsync(i):null;return i=m.U.flatClone(i),n.keepCppFiles||(delete i.compileData,delete i.generatedFiles,delete i.extensionFiles),i.hexinfo=r,t.extinfo=i,t};await this.loadAsync(),i.bannedCategories=this.resolveBannedCategories(),m.debug("building: "+this.sortedDeps().map(e=>null==(e=e.config)?void 0:e.name).join(", "));let c,u=(m.appTarget.multiVariants?(c=m.appTargetVariant?[m.appTargetVariant]:m.appTarget.alwaysMultiVariant||m.appTarget.compile.switches.multiVariant?m.appTarget.multiVariants:[m.appTarget.multiVariants[0]],!m.appTarget.alwaysMultiVariant&&a&&(c=c.filter(e=>!a.includes(e)))):c=[null],null);var t,r,d;await Promise.all(c.map(async e=>{u&&m.debug("building for "+e);var t=await l(e),r=t.extinfo;r.appVariant=e,r.outputPrefix=1!=c.length&&e?e+"-":"",-1<(null==a?void 0:a.indexOf(e))&&(r.disabledDeps=r.disabledDeps||"user-disabled"),u?i.otherMultiVariants.push(t):(t.target.isNative=i.target.isNative,i.target=t.target,u=r,i.otherMultiVariants=[])})),i.extinfo=u,i.target.preferredEditor=this.getPreferredEditor(),!(m.appTarget.compile.shortPointers||"vm"==m.appTarget.compile.nativeType||this.config.binaryonly||!i.target.isNative)&&(t=await this.filesToBePublishedAsync(!0),f=JSON.stringify({name:this.config.name,comment:this.config.description,status:"unpublished",scriptId:this.installedVersion,cloudId:m.CLOUD_ID+m.appTarget.id,editor:this.getPreferredEditor(),targetVersions:m.appTarget.versions}),t=JSON.stringify(t),r=await m.lzmaCompressAsync(f+t))&&(i.embedMeta=JSON.stringify({compression:"LZMA",headerSize:f.length,textSize:t.length,name:this.config.name,eURL:m.appTarget.appTheme.embedUrl,eVER:m.appTarget.versions?m.appTarget.versions.target:"",pxtTarget:m.appTarget.id}),i.embedBlob=ts.pxtc.encodeBase64(m.U.uint8ArrayToString(r)));for(d of this.sortedDeps())for(var h of d.getFiles())if(/\.(ts|asm|py)$/.test(h)){let e=h;0<d.level&&(e="pxt_modules/"+d.id+"/"+h),i.sourceFiles.push(e),i.fileSystem[e]=d.readFile(h)}i.jres=this.getJRes();var p,f=m.appTarget.runtime&&m.appTarget.runtime.functionsOptions;i.allowedArgumentTypes=f&&f.extraFunctionEditorTypes&&f.extraFunctionEditorTypes.map(e=>e.typeName).concat("number","boolean","string"),i.unfetteredInitializers=null==(e=m.appTarget.compile)?void 0:e.unfetteredInitializers;for(p of this.sortedDeps())p.patchAppTargetPalette();return this.patchAppTargetPalette(),i}prepareConfigToBePublished(){let n=m.U.clone(this.config);return delete n.installedVersion,delete n.additionalFilePath,delete n.additionalFilePaths,n.targetVersions||(n.targetVersions=m.Util.clone(m.appTarget.versions)),m.U.iterMap(n.dependencies,(e,t)=>{if(!t||/^(file|workspace):/.test(t)){t="*";try{var r,i=this.resolveDep(e).readGitJson();i&&i.repo&&((r=m.github.parseRepoId(i.repo)).tag=i.commit.tag||i.commit.sha,t=m.github.stringifyRepo(r))}catch(e){}n.dependencies[e]=t}}),n.files=n.files.filter(e=>e!==m.HISTORY_FILE),n}filesToBePublishedAsync(i=!1){let n={};return this.loadAsync().then(()=>{i||this.config.public||m.U.userError('Only packages with "public":true can be published');var e,t,r=this.prepareConfigToBePublished();n[m.CONFIG_NAME]=m.Package.stringifyConfig(r);for(e of this.getFiles())e!==m.CONFIG_NAME&&e!==m.HISTORY_FILE&&(null==(t=this.readFile(e))&&m.U.userError("referenced file missing: "+e),n[e]=t);return m.U.sortObjectFields(n)})}saveToJsonAsync(){return this.filesToBePublishedAsync(!0).then(e=>({meta:{cloudId:m.CLOUD_ID+m.appTarget.id,targetVersions:m.appTarget.versions,editor:this.getPreferredEditor(),name:this.config.name},source:JSON.stringify(e,null,2)}))}compressToFileAsync(){return this.saveToJsonAsync().then(e=>m.lzmaCompressAsync(JSON.stringify(e,null,2)))}computePartDefinitions(i){if(!i||!i.length)return{};let n={};return this.sortedDeps().forEach(r=>{var t=r.readFile("pxtparts.json");if(t)try{let e=JSON.parse(t);Object.keys(e).forEach(t=>{if(0<=i.indexOf(t)){t=n[t]=e[t];if("string"==typeof t.visual.image&&/\.svg$/i.test(t.visual.image)){let e=r.readFile(t.visual.image);e||m.reportError("parts","invalid part definition",{error:"missing visual "+t.visual.image}),/^data:image\/svg\+xml/.test(e)||(e="data:image/svg+xml,"+encodeURIComponent(e)),t.visual.image=e}}})}catch(e){m.reportError("parts","invalid pxtparts.json file")}}),n}}function r(i,n={}){var s,a=i["*"]||{};for(s of Object.keys(i))if("*"!=s){let e=i[s],t=(e="string"==typeof e?{data:e}:e).namespace||a.namespace||"";t&&!t.endsWith(".")&&(t+=".");var o=e.id||t+s;let r=e.icon;var l=e.mimeType||a.mimeType,c=e.dataEncoding||a.dataEncoding||"base64";r||"base64"!=c||"image/png"!=l&&"image/jpeg"!=l||(r="data:"+l+";base64,"+e.data),n[o]={id:o,data:e.data,dataEncoding:c,icon:r,namespace:t,mimeType:l,tilemapTile:e.tilemapTile,displayName:e.displayName,tileset:e.tileset,tags:e.tags}}return n}m.MainPackage=e,m.inflateJRes=r,m.allPkgFiles=function(e){return[m.CONFIG_NAME].concat(e.files||[]).concat(e.testFiles||[])},m.isPkgBeta=function(e){return e&&/\bbeta\b/.test(e.description)}})(pxt=pxt||{}),(l=>{{var c=l.packetio||(l.packetio={});let i,r,n=()=>{},s,a;c.isActive=function(){return!!i},c.isConnected=function(){return!(null==i||!i.isConnected())},c.isConnecting=function(){return!(null==i||!i.isConnecting())},c.icon=function(){var e;return!!i&&(i.icon||(null==(e=l.appTarget.appTheme.downloadDialogTheme)?void 0:e.deviceIcon)||"usb")},c.unsupportedParts=function(){return null!=i&&i.unsupportedParts?i.unsupportedParts():[]},c.deviceVariant=function(){return null==i?void 0:i.devVariant};let o;function u(){if(o)return o;let t=Promise.resolve();if(i){l.debug("packetio: disconnect");let e=i;t=t.then(()=>e.disconnectAsync()).then(()=>e.io.disposeAsync()).catch(e=>{l.reportException(e)}).finally(()=>{r=void 0,i=void 0,o=void 0}),n&&(t=t.then(()=>n())),o=t}return t}c.disconnectAsync=u,c.configureEvents=function(e,t,r){n=e,s=t,a=r,i&&(i.io.onConnectionChanged=n,i.onSerial=s,i.onCustomEvent=r)},c.sendCustomEventAsync=function(e,t){return i?i.sendCustomEventAsync(e,t):Promise.resolve()},c.initAsync=function(t=!1){if(l.debug("packetio: init "+(t?"(force)":"")),!r){let e=Promise.resolve();t&&(e=e.then(()=>u())),r=e.then(()=>i?Promise.resolve(i):c.mkPacketIOAsync?(l.debug("packetio: new wrapper"),c.mkPacketIOAsync().then(e=>(e.onConnectionChanged=n,i=c.mkPacketIOWrapper(e),s&&(i.onSerial=s),a&&(i.onCustomEvent=a),n&&n(),i))):(l.debug("packetio: not defined, skipping"),Promise.resolve(void 0))).finally(()=>{r=void 0})}return r}}})(pxt=pxt||{}),(s=>{var e;function i(e,t,r){let i=s.semver.tryParse(e||"0.0.0")||s.semver.tryParse("0.0.0"),n=[];return Object.keys(t).filter(e=>s.semver.inRange(e,i)).forEach(e=>n=n.concat(t[e])),(n=r?n.filter(e=>e.type==r):n).length?n:void 0}function r(e,t,r){let i=t;return r&&(r.filter(e=>"api"===e.type).forEach(r=>{Object.keys(r.map).forEach(e=>{var t=new RegExp(e,"g");i=i.replace(t,r.map[e])})}),r.filter(e=>"userenum"===e.type).forEach(r=>{Object.keys(r.map).forEach(e=>{var t=new RegExp("enum\\s+"+e+"\\s*{","gm"),t=(i=i.replace(t,`enum ${r.map[e]} {`),new RegExp(`(^|[^_a-zA-Z0-9])${e}(\\s*\\.)`,"g"));i=i.replace(t,`$1${r.map[e]}$2`)})})),i}(e=s.patching||(s.patching={})).computePatches=function(e,t){var r=s.appTarget.compile?s.appTarget.compile.patches:void 0;if(r)return i(e,r,t)},e.computePyPatches=function(e,t){var r=s.appTarget.compile?s.appTarget.compile.pyPatches:void 0;if(r)return i(e,r,t)},e.upgradePackageReference=function(e,t,r){if("*"!=r)return t;r=s.patching.computePatches(e,"package");let i=t;return r&&r.forEach(t=>{Object.keys(t.map).forEach(e=>{i==e&&(i=t.map[e])})}),i},e.patchJavaScript=function(e,t){return r(0,t,s.patching.computePatches(e))},e.patchPython=function(e,t){return r(0,t,s.patching.computePyPatches(e))}})(pxt=pxt||{}),(e=>{e.react||(e.react={})})(pxt=pxt||{}),(a=>{var t;function s(r,i){if(r){if(i){let t=r.major-i.major||r.minor-i.minor||r.patch-i.patch;if(t)return t;if(0==r.pre.length&&0<i.pre.length)return 1;if(0<r.pre.length&&0==i.pre.length)return-1;for(let e=0;e<r.pre.length+1;++e){var n=r.pre[e],s=i.pre[e];if(!n)return s?-1:0;if(!s)return 1;if(/^\d+$/.test(n)){if(!/^\d+$/.test(s))return-1;if(t=parseInt(n)-parseInt(s))return t}else{if(/^\d+$/.test(s))return 1;if(t=a.U.strcmp(n,s))return t}}return 0}return-1}return i?1:0}function o(e,t){t=l(e)||l(t);return t||a.U.userError(a.U.lf("'{0}' doesn't look like a semantic version number",e)),t}function l(e){if(!e)return null;if("*"===e)return{major:Number.MAX_SAFE_INTEGER,minor:Number.MAX_SAFE_INTEGER,patch:Number.MAX_SAFE_INTEGER,pre:[],build:[]};/^v\d/i.test(e)&&(e=e.slice(1));e=/^(\d+)\.(\d+)\.(\d+)(-([0-9a-zA-Z\-\.]+))?(\+([0-9a-zA-Z\-\.]+))?$/.exec(e);return e?{major:parseInt(e[1]),minor:parseInt(e[2]),patch:parseInt(e[3]),pre:e[5]?e[5].split("."):[],build:e[7]?e[7].split("."):[]}:null}function c(e){let t=e.major+"."+e.minor+"."+e.patch;return e.pre.length&&(t+="-"+e.pre.join(".")),e.build.length&&(t+="+"+e.build.join(".")),t}function r(e,t){var r=l(e),i=l(t);return r||i?s(r,i):a.U.strcmp(e,t)}function u(e,t){var r,e=e.split(" - ");return 2==e.length&&(r=l(e[0]),e=l(e[1]),!(!r||!e))&&(!t||(r=s(r,t),t=s(t,e),r<=0&&t<0))}(t=a.semver||(a.semver={})).cmp=s,t.parse=o,t.tryParse=l,t.normalize=function(e){return c(o(e))},t.stringify=c,t.majorCmp=function(e,t){return e=l(e),t=l(t),e.major-t.major},t.strcmp=r,t.inRange=u,t.sortLatestTags=function(e){return(e=e.filter(e=>!!t.tryParse(e))).sort(r),e.reverse(),e},t.bump=function(e,t){let r=o(c(e));switch(t){case"major":r.major++,r.minor=0,r.patch=0;break;case"minor":r.minor++,r.patch=0;break;case"patch":r.patch++;break;default:r=a.semver.parse(t)}return r},t.test=function(){a.log("Test semver");var r=["0.9.0","1.0.0-0.3.7","1.0.0-alpha","1.0.0-alpha.1","1.0.0-alpha.beta","1.0.0-beta","1.0.0-beta.2","1.0.0-beta.11","1.0.0-rc.1","1.0.0-x.7.z.92","1.0.0","1.0.1","1.9.0","1.10.0","1.11.0"];for(let t=0;t<r.length;++t){var i=o(r[t]);a.log(r[t],i),a.U.assert(c(i)==r[t]);for(let e=0;e<r.length;++e){var n=s(i,o(r[e]));a.log(r[t],r[e],n),t<e?a.U.assert(n<0):t>e?a.U.assert(0<n):a.U.assert(0==n)}}var e=l("1.2.3");a.U.assert(u("0.1.2 - 2.2.3",e)),a.U.assert(u("1.2.3 - 2.2.3",e)),a.U.assert(!u("0.0.0 - 1.2.3",e)),a.U.assert(!u("1.2.4 - 4.2.3",e)),a.U.assert(!u("0.0.0 - 0.0.1",e))}})(pxt=pxt||{}),(e=>{var u;{var E=e.pxtc||(e.pxtc={});function t(e){return E.Util.values(e.byQName).filter(e=>e.attributes.block&&/^{[^:]+:[^}]+}/.test(e.attributes.block)).forEach(e=>{e.attributes.block=e.attributes.block.replace(/^{[^:]+:[^}]+}/,"")}),e}E.assert=E.Util.assert,E.oops=E.Util.oops,E.U=E.Util,E.ON_START_TYPE="pxt-on-start",E.ON_START_COMMENT="on start",E.HANDLER_COMMENT="code goes here",E.TS_STATEMENT_TYPE="typescript_statement",E.TS_DEBUGGER_TYPE="debugger_keyword",E.TS_BREAK_TYPE="break_keyword",E.TS_CONTINUE_TYPE="continue_keyword",E.TS_OUTPUT_TYPE="typescript_expression",E.TS_RETURN_STATEMENT_TYPE="function_return",E.PAUSE_UNTIL_TYPE="pxt_pause_until",E.COLLAPSED_BLOCK="pxt_collapsed_block",E.FUNCTION_DEFINITION_TYPE="function_definition",E.BINARY_JS="binary.js",E.BINARY_ASM="binary.asm",E.BINARY_HEX="binary.hex",E.BINARY_UF2="binary.uf2",E.BINARY_ELF="binary.elf",E.BINARY_PXT64="binary.pxt64",E.BINARY_ESP="binary.bin",E.BINARY_SRCMAP="binary.srcmap",E.NATIVE_TYPE_THUMB="thumb",E.NATIVE_TYPE_VM="vm",E.BLOCK_TRANSLATION_CACHE_KEY="_blocks",E.BuildSourceMapHelpers=function(n,t,r){let s={ts:(u=e=>{let t=e.split("\n").map(e=>e.length),r=t.reduce(({lens:e,sum:t},r)=>({lens:[...e,t+r+1],sum:t+r+1}),{lens:[],sum:0}).lens;return{posToLineCol:i=>{var e=r.reduce((e,t,r)=>i<t?e:r+1,0);return[e,t[e]-(r[e]-i)+1]},lineColToPos:(e,t)=>(r[e-1]||0)+t}})(t),py:u(r)},a=e=>e.endPos-e.startPos,i=(e,t)=>{let{startPos:r,endPos:i}=e;return n.filter(e=>e[t].startPos<=r&&i<=e[t].endPos)},o=(e,r)=>{e=i(e,r);return e.reduce((e,t)=>a(t[r])<a(e[r])?t:e,e[0])};const e={allOverlaps:e=>i(e,"ts"),smallestOverlap:e=>o(e,"ts")},l={allOverlaps:e=>i(e,"py"),smallestOverlap:e=>o(e,"py")};var c=(u=(i,n)=>e=>{e=e;var t,[e,r]=[s[i].lineColToPos(e.line,e.column),e.length],r=e+r,e=o({startPos:e,endPos:r},i);if(e)return[r,t]=s[n].posToLineCol(e[n].startPos),{fileName:"main."+n,start:e[n].startPos,length:a(e[n]),line:r,column:t}})("ts","py"),u=u("py","ts");return{ts:Object.assign(Object.assign(Object.assign({},s.ts),e),{locToLoc:c,getText:e=>t.substring(e.startPos,e.endPos)}),py:Object.assign(Object.assign(Object.assign({},s.py),l),{locToLoc:u,getText:e=>r.substring(e.startPos,e.endPos)})}},E.computeUsedParts=function(t,e,r=!1){if(!t.usedSymbols||!pxt.appTarget.simulator||!r&&!pxt.appTarget.simulator.parts)return[];let i=(e,t)=>{e&&(e=e.split(/[ ,]+/g),t.push(...e.filter(e=>!!e&&t.indexOf(e)<0)))},n=[],s=[];if(Object.keys(t.usedSymbols).forEach(e=>{e=t.usedSymbols[e];i(null==e?void 0:e.attributes.parts,n),i(null==e?void 0:e.attributes.hiddenParts,s)}),e){let t=pxt.appTarget.simulator.boardDefinition.onboardComponents;t&&("ignorebuiltin"===e?n=n.filter(e=>-1===t.indexOf(e)):"onlybuiltin"===e&&(n=n.filter(e=>0<=t.indexOf(e))))}return(n=n.filter(e=>s.indexOf(e)<0)).sort(),n=n.reverse()},E.buildSimJsInfo=function(e){return{js:e.outfiles[E.BINARY_JS],targetVersion:pxt.appTarget.versions.target,fnArgs:e.usedArguments,parts:E.computeUsedParts(e,"ignorebuiltin"),usedBuiltinParts:E.computeUsedParts(e,"onlybuiltin"),allParts:E.computeUsedParts(e,void 0,!0),breakpoints:null==(e=e.breakpoints)?void 0:e.map(e=>e.id)}},E.blocksCategory=function(e){return(e=e?e.attributes.blockNamespace||e.namespace:void 0)?E.Util.capitalize(e.split(".")[0]):void 0},E.getBlocksInfo=function(e,t){let r,i,p=[],f={},m={},g={};var n,s,a,o,l={},c={};function u(r,i){var n="get"==r,s="set"==r,a="number"==i.retType,o=n?m:s?f:g,l=i.namespace+"."+i.retType;let c=E.U.lookup(o,l);if(!c){var u=`@${r}@`;let e,t;i.attributes.blockCombineShadow&&(d=(h=i.attributes.blockCombineShadow).match(/^([^,.]*),?([^,.]*)$/))&&3==d.length&&(e=d[1].trim(),0!=(t=d[2].trim()).length||E.Util.endsWith(h,",")||(t=e,e=""));var d=(i.attributes.blockSetVariable||i.namespace.toLocaleLowerCase())+"="+(e||""),h="value="+(t||"");(c=o[l]={attributes:{blockId:`${a?i.namespace:l}_blockCombine_`+r,callingConvention:0,group:i.attributes.group,paramDefl:{},jsDoc:n?E.U.lf("Read value of a property on an object"):E.U.lf("Update value of property on an object")},name:u,namespace:i.namespace,fileName:i.fileName,qName:l+"."+u,pkg:i.pkg,kind:2,parameters:[{name:"property",description:n?E.U.lf("the name of the property to read"):E.U.lf("the name of the property to change"),isEnum:!0,type:"@combined@"},{name:"value",description:s?E.U.lf("the new value of the property"):E.U.lf("the amount by which to change the property"),type:i.retType}].slice(0,n?1:2),retType:n?i.retType:"void",combinedProperties:[]}).attributes.block=n?`%${d} %property`:s?E.U.lf("set %{0} %property to %{1}",d,h):E.U.lf("change %{0} %property by %{1}",d,h),T(c.attributes),pxt.Util.isTranslationMode()&&(c.attributes.translationId=c.attributes.block,c.attributes.block=n?`%${d} %property`:s?`set %${d} %property to %`+h:`change %${d} %property by %`+h,T(c.attributes),pxt.crowdin.inContextLoadAsync(c.attributes.translationId).then(e=>{c.attributes.block=e,T(c.attributes)})),p.push(c)}c.combinedProperties.push(i.qName)}for(n of E.Util.values(e.byQName)){if("ENUM_GET"===n.attributes.shim&&n.attributes.enumName&&n.attributes.blockId){let e=!1;if(l[n.attributes.enumName]&&(pxt.warn(`Enum block ${n.attributes.blockId} trying to overwrite enum `+n.attributes.enumName),e=!0),n.attributes.enumMemberName||(pxt.warn(`Enum block ${n.attributes.blockId} should specify enumMemberName`),e=!0),n.attributes.enumPromptHint||(pxt.warn(`Enum block ${n.attributes.blockId} should specify enumPromptHint`),e=!0),n.attributes.enumInitialMembers&&n.attributes.enumInitialMembers.length||(pxt.warn(`Enum block ${n.attributes.blockId} should specify enumInitialMembers`),e=!0),e)continue;var d=parseInt(n.attributes.enumStartValue);l[n.attributes.enumName]={blockId:n.attributes.blockId,name:n.attributes.enumName,memberName:n.attributes.enumMemberName,firstValue:isNaN(d)?void 0:d,isBitMask:n.attributes.enumIsBitMask,isHash:n.attributes.enumIsHash,initialMembers:n.attributes.enumInitialMembers,promptHint:n.attributes.enumPromptHint}}if("KIND_GET"===n.attributes.shim&&n.attributes.blockId){var h=n.attributes.kindNamespace||n.attributes.blockNamespace||n.namespace;if(c[h]){pxt.warn("More than one block defined for kind "+h);continue}var b=[];if(e.byQName[h])for(var v of E.Util.values(e.byQName))v.namespace===h&&v.attributes.isKind&&b.push(v.name);c[h]={blockId:n.attributes.blockId,name:h,memberName:n.attributes.kindMemberName||h,initialMembers:b,promptHint:n.attributes.enumPromptHint||E.Util.lf("Create a new kind..."),createFunctionName:n.attributes.kindCreateFunction||"create"}}if(n.attributes.blockCombine)/@set/.test(n.name)||u("get",n),n.isReadOnly||("number"==n.retType&&u("change",n),u("set",n));else if(n.attributes.block&&!n.attributes.fixedInstance&&7!=n.kind&&5!=n.kind&&9!=n.kind&&8!=n.kind&&!n.attributes.blockIdentity){if(n.attributes.blockId||(n.attributes.blockId=n.qName.replace(/\./g,"_")),"true"==n.attributes.block){let e=E.U.uncapitalize(n.name);1!=n.kind&&2!=n.kind||(e+=" %"+n.namespace.toLowerCase());for(s of null!=(i=null==(r=n.parameters)?void 0:r.filter(e=>!x(e)))?i:[])e+=" %"+s.name;n.attributes.block=e,T(n.attributes)}p.push(n)}}for(a of p){var y=E.U.lookup(e.byQName,a.namespace);if(y){var w,A=y.attributes,k=a.attributes;for(w of["blockNamespace","color","blockGap"])void 0===k[w]&&A[w]&&(k[w]=A[w])}}return{apis:e,blocks:p=t&&(o=t).length?p.filter(e=>{e=(e.attributes.blockNamespace||e.namespace).split(".")[0];return-1===o.indexOf(e)}):p,blocksById:pxt.Util.toDictionary(p,e=>e.attributes.blockId),enumsByName:l,kindsByName:c}},E.tsSnippetToPySnippet=function(e,t){var r={true:"True",false:"False",null:"None"}[e];return r||(t&&6==t.kind||!t&&e.includes(".")?(r=e.lastIndexOf("."),t=e.substr(0,r),r=e.substr(r+1),r=E.U.snakify(r).toUpperCase(),t?t+"."+r:r):e)},E.apiLocalizationStrings={},E.localizeApisAsync=async function(u,e){let d=E.Util.userLanguage();if("en"==d)return Promise.resolve(t(u));let h=d.toLowerCase(),p=h+"|jsdoc",f=h+"|block",m=await e.localizationStringsAsync(d);return E.apiLocalizationStrings&&E.Util.jsonMergeFrom(m,E.apiLocalizationStrings),e=E.Util.values(u.byQName).filter(e=>e.attributes._translatedLanguageCode!==d),await E.Util.promiseMapAll(e,async i=>{var e=i.attributes.useLoc||i.attributes.blockAliasFor;let n=e&&u.byQName[e],r=(i.attributes._untranslatedJsDoc&&(i.attributes.jsDoc=i.attributes._untranslatedJsDoc),i.attributes._untranslatedBlock&&(i.attributes.jsDoc=i.attributes._untranslatedBlock),(e,t)=>{var r;return m[i.qName+e]||(null==(r=i.attributes.locs)?void 0:r[t])||n&&(m[n.qName+e]||(null==(r=n.attributes.locs)?void 0:r[t]))});var e=r("",p),e=(e&&(i.attributes._untranslatedJsDoc||(i.attributes._untranslatedJsDoc=i.attributes.jsDoc),i.attributes.jsDoc=e),null!=(e=i.parameters)&&e.forEach(e=>{var t="|param|"+e.name,t=r(t,h+t);t&&(e.description=t)}),m["{id:category}"+E.Util.capitalize(i.qName)]);let t=m[i.qName+"|block"]||(null==(l=i.attributes.locs)?void 0:l[f]);if(i.attributes.block){var s,a,o,l=pxt.blocks.compileInfo(i);if(l.handlerArgs)for(var c of l.handlerArgs)m[c.localizationKey]?(o=a=s=void 0,s=c.localizationKey,a=m[c.localizationKey],(o=pxt.Util.translationsCache())[E.BLOCK_TRANSLATION_CACHE_KEY]||(o[E.BLOCK_TRANSLATION_CACHE_KEY]={}),o[E.BLOCK_TRANSLATION_CACHE_KEY][s]=a):(o=c.localizationKey,s=void 0,(s=pxt.Util.translationsCache())[E.BLOCK_TRANSLATION_CACHE_KEY]&&delete s[E.BLOCK_TRANSLATION_CACHE_KEY][o])}(t=!t&&n&&(l=m[n.qName+"|block"]||(null==(l=n.attributes.locs)?void 0:l[f]),i.attributes.block===(n.attributes._untranslatedBlock||n.attributes.block))&&l?l:t)&&pxt.Util.isTranslationMode()&&(i.attributes.translationId=t,t=await pxt.crowdin.inContextLoadAsync(t)),e?(i.attributes.block?i.attributes.block=t||i.attributes.block:i.attributes.block=e,T(i.attributes)):i.attributes.block&&t?(l=pxt.blocks.compileInfo(i),e=i.attributes.block,i.attributes.block=pxt.blocks.normalizeBlock(t,e=>{pxt.tickEvent("loc.normalized",{block:i.attributes.block,lang:d,error:e})}),i.attributes._untranslatedBlock||(i.attributes._untranslatedBlock=e),e!=i.attributes.block&&(T(i.attributes),((e,t)=>{if(e.parameters.length==t.parameters.length){for(var r of e.parameters){var i=t.actualNameToParam[r.actualName];if(!i||r.type!=i.type||r.shadowBlockId!=i.shadowBlockId||r.definitionName!=i.definitionName)return void pxt.debug(`Parameter ${r.actualName} type, shadow block, or definition name does not match after localization`)}return 1}pxt.debug("Localized block has extra or missing parameters")})(l,pxt.blocks.compileInfo(i))||(pxt.reportError("loc.errors","block has non matching arguments",{block:i.attributes.blockId,lang:d,originalDefinition:e,translatedBlock:i.attributes.block}),pxt.tickEvent("loc.errors",{block:i.attributes.blockId,lang:d}),i.attributes.block=e,T(i.attributes)))):T(i.attributes),i.attributes._translatedLanguageCode=d}),t(u)},E.getBlockTranslationsCacheKey=function(e){var t=pxt.Util.translationsCache();if(t[E.BLOCK_TRANSLATION_CACHE_KEY])return t[E.BLOCK_TRANSLATION_CACHE_KEY][e]},E.emptyExtInfo=function(){let e=pxt.appTarget.compileService;var t=!!(e=e||{}).platformioIni,r="dockermake"==e.buildEngine||"dockercross"==e.buildEngine||"dockerespidf"==e.buildEngine,i={functions:[],generatedFiles:{},extensionFiles:{},sha:"",compileData:"",shimsDTS:"",enumsDTS:"",onlyPublic:!0};return t?i.platformio={dependencies:{}}:r?i.npmDependencies={}:i.yotta={config:{},dependencies:{}},i};let i=["weight","imageLiteral","gridLiteral","topblockWeight","inlineInputModeLimit"],n=["advanced","handlerStatement","forceStatement","afterOnStart","optionalVariableArgs","blockHidden","constantShim","blockCombine","enumIsBitMask","enumIsHash","decompileIndirectFixedInstances","topblock","callInDebugger","duplicateShadowOnDrag","argsNullable","compileHiddenArguments","expandArgumentsInToolbox"];function x(e){return"Action"===e.type||/^\([^\)]*\)\s*=>/.test(e.type)}function T(r){var e;function t(e){return r._shadowOverrides&&e.parameters.forEach(e=>{var t=r._shadowOverrides[e.name];"unset"===t?delete e.shadowBlockId:null!=t&&(e.shadowBlockId=t)}),e}r.block&&(e=r.block.split("||"),r._def=t(s(e[0])),r._def||pxt.debug("Unable to parse block def for id: "+r.blockId),e[1]&&(r._expandedDef=t(s(e[1]))),e[1])&&!r._expandedDef&&pxt.debug("Unable to parse expanded block def for id: "+r.blockId)}function s(i){var n=[];let e,s=0;for(;s<i.length;s++){let t=i[s];var a=s;let r;switch(t){case"*":case"_":var o=b(e=>e==t),l="_"===t?2:0;1===o.length?r={kind:1<<l,content:o}:2===o.length?r={kind:2<<l,content:o}:3===o.length?r={kind:3<<l,content:o}:s=a;break;case"`":l=v("`");void 0===l?s=a:r={kind:256,content:l};break;case"|":r={kind:32};break;case"\\":s<i.length-1&&(r={kind:16,content:i[1+s++]});break;case"[":o=v("]");if(void 0!==o&&"("===i[1+s++]){var c=v(")");if(void 0!==c){r={kind:512,content:o,type:c};break}}s=a;break;case"$":case"%":var u,c=b(e=>/[a-zA-Z0-9_=]/.test(e),!0).split("=");if(2<c.length)s=a;else{let e;"("!==i[s+1]||(u=s,++s,e=v(")"))||(s=u),r={kind:"$"===t?1024:64,content:c[0],type:c[1],name:e}}}r?(e&&n.push({kind:128,content:e}),e=void 0,n.push(r)):e?e+=t:e=t}e&&n.push({kind:128,content:e});let r=[];var t=[];let d=[],h=0,p="",f=[];for(let e=0;e<n.length;e++){var m=n[e].kind,g=d[d.length-1];15&m?(A(n[e].content),m&h?g&m?(d.pop(),(g=g&(h^=m)|m&h)&&d.push(g)):y():(h|=m,d.push(m))):144&m?p+=n[e].content:1120&m&&w(),64==m?(g={kind:"param",name:n[e].content,shadowBlockId:n[e].type,ref:!1},n[e].name&&(g.varName=n[e].name),r.push(g),t.push(g)):1024==m?(g={kind:"param",name:n[e].content,shadowBlockId:n[e].type,ref:!0},n[e].name&&(g.varName=n[e].name),r.push(g),t.push(g)):256==m?(A(),f.push({kind:"image",uri:n[e].content})):512==m?(A(),f.push({kind:"label",text:n[e].content,cssClass:n[e].type})):32==m&&r.push({kind:"break"})}return w(),{parts:r,parameters:t};function b(e,t=!1){let r="";for(t&&s++;s<i.length&&e(i[s]);)r+=i[s],++s;return r&&s--,r}function v(t){var e=b(e=>e!==t,!0);if(i[s+1]===t)return++s,e}function y(){let e="";var t,r=[];for(t of f)t.kind?(r.push({content:e,styles:0}),r.push(t),e=""):(e+=t.content,t.endingToken&&(e+=t.endingToken));f=r,e&&f.push({content:e,styles:0}),d=[],h=0}function w(){for(A(),h&&y();f.length;){var e,t=f.shift();t.kind?r.push(t):t.content&&(e=[],10&t.styles&&e.push("bold"),5&t.styles&&e.push("italics"),r.push({kind:"label",text:t.content,style:e}))}}function A(e){f.push({content:p,styles:h,endingToken:e}),p=""}}function p(t){var r=e=>t[e]+(t[e+1]<<8)+(t[e+2]<<16)+(t[e+3]<<24)>>>0;if(!t||512!=t.length||r(0)!=u.UF2_MAGIC_START0||r(4)!=u.UF2_MAGIC_START1||r(t.length-4)!=u.UF2_MAGIC_END)return null;var e=r(8);let i=r(16),n=(476<i&&(i=256),null),s=0,a=0;if(e&u.UF2_FLAG_FILE){let e=t.slice(32+i);var o=e.indexOf(0);0<=o&&(e=e.slice(0,o)),n=E.U.fromUTF8Array(e),a=r(28)}return e&u.UF2_FLAG_FAMILY_ID_PRESENT&&(s=r(28)),{flags:e,targetAddr:r(12),payloadSize:i,blockNo:r(20),numBlocks:r(24),fileSize:a,familyId:s,data:t.slice(32,32+i),filename:n}}function a(e,t){return!!e&&e.targetAddr<=t&&t<e.targetAddr+e.payloadSize}function d(e,t,r){e[t]=255&r,e[t+1]=r>>8&255,e[t+2]=r>>16&255,e[t+3]=r>>24&255}function o(e){return{currBlock:null,currPtr:-1,blocks:[],ptrs:[],filesize:0,familyId:(e="string"==typeof e?parseInt(e):e)||0}}function l(t){for(let e=0;e<t.blocks.length;++e)d(t.blocks[e],20,e),d(t.blocks[e],24,t.blocks.length),t.filename&&d(t.blocks[e],28,t.filesize)}function h(t,e,r,i=0){let n=t.currBlock;var s=e>>8;let a=256-(255&e);if(r.length>a){var o=new Uint8Array(r);for(h(t,e,o.slice(0,a));a<r.length;){var l=Math.min(a+256,r.length);h(t,e+a,o.slice(a,l)),a=l}}else{if(s!=t.currPtr){n=null;for(let e=0;e<t.ptrs.length;++e)if(t.ptrs[e]==s){n=t.blocks[e];break}if(!n){n=new Uint8Array(512),t.filename?i|=u.UF2_FLAG_FILE:t.familyId&&(i|=u.UF2_FLAG_FAMILY_ID_PRESENT),d(n,0,u.UF2_MAGIC_START0),d(n,4,u.UF2_MAGIC_START1),d(n,8,i),d(n,12,s<<8),d(n,16,256),d(n,20,t.blocks.length),d(n,28,t.familyId),d(n,508,u.UF2_MAGIC_END);for(let e=32;e<288;++e)n[e]=255;t.filename&&E.U.memcpy(n,288,E.U.toUTF8Array(t.filename)),t.blocks.push(n),t.ptrs.push(s)}t.currPtr=s,t.currBlock=n}var c=32+(255&e);for(let e=0;e<r.length;++e)n[c+e]=r[e];t.filesize=Math.max(t.filesize,r.length+e)}}E.parseCommentString=function(e){let l={paramDefl:{},callingConvention:0,_source:e},c=!0;for(;c;)c=!1,e=e.replace(/\/\/%[ \t]*([\w\.-]+)(=(("[^"\n]*")|'([^'\n]*)'|([^\s]*)))?/,(e,t,r,i,n,s,a)=>{let o=n?JSON.parse(n):r?n||s||a:"true";return o=o||"",E.U.startsWith(t,"block.loc.")?(l.locs||(l.locs={}),l.locs[t.slice("block.loc.".length).toLowerCase()+"|block"]=o):E.U.startsWith(t,"jsdoc.loc.")?(l.locs||(l.locs={}),l.locs[t.slice("jsdoc.loc.".length).toLowerCase()+"|jsdoc"]=o):E.U.contains(t,".loc.")?(l.locs||(l.locs={}),r=t.slice(0,t.indexOf(".loc.")),n=t.slice(t.indexOf(".loc.")+".loc.".length),l.locs[n+"|param|"+r]=o):E.U.endsWith(t,".defl")?(-1<o.indexOf(" ")?l.paramDefl[t.slice(0,t.length-5)]=`"${o}"`:l.paramDefl[t.slice(0,t.length-5)]=o,l.explicitDefaults||(l.explicitDefaults=[]),l.explicitDefaults.push(t.slice(0,t.length-5))):E.U.endsWith(t,".shadow")?(l._shadowOverrides||(l._shadowOverrides={}),l._shadowOverrides[t.slice(0,t.length-7)]=o):E.U.endsWith(t,".snippet")?(l.paramSnippets||(l.paramSnippets={}),s=t.slice(0,t.length-8),l.paramSnippets[s]||(l.paramSnippets[s]={}),l.paramSnippets[s].ts=o):E.U.endsWith(t,".pySnippet")?(l.paramSnippets||(l.paramSnippets={}),a=t.slice(0,t.length-10),l.paramSnippets[a]||(l.paramSnippets[a]={}),l.paramSnippets[a].python=o):E.U.endsWith(t,".fieldEditor")?(l.paramFieldEditor||(l.paramFieldEditor={}),l.paramFieldEditor[t.slice(0,t.length-12)]=o):E.U.contains(t,".fieldOptions.")?(l.paramFieldEditorOptions||(l.paramFieldEditorOptions={}),n=t.slice(0,t.indexOf(".fieldOptions.")),r=t.slice(t.indexOf(".fieldOptions.")+14,t.length),l.paramFieldEditorOptions[n]||(l.paramFieldEditorOptions[n]={}),l.paramFieldEditorOptions[n][r]=o):E.U.contains(t,".shadowOptions.")?(l.paramShadowOptions||(l.paramShadowOptions={}),s=t.slice(0,t.indexOf(".shadowOptions.")),a=t.slice(t.indexOf(".shadowOptions.")+15,t.length),l.paramShadowOptions[s]||(l.paramShadowOptions[s]={}),l.paramShadowOptions[s][a]=o):E.U.endsWith(t,".min")?(l.paramMin||(l.paramMin={}),l.paramMin[t.slice(0,t.length-4)]=o):E.U.endsWith(t,".max")?(l.paramMax||(l.paramMax={}),l.paramMax[t.slice(0,t.length-4)]=o):l[t]=o,c=!0,"//% "});for(var t of i)"string"==typeof l[t]&&(l[t]=parseInt(l[t]));for(var r of n)"string"==typeof l[r]&&(l[r]="true"==l[r]||"1"==l[r]);if(l.trackArgs&&(l.trackArgs=l.trackArgs.split(/[ ,]+/).map(e=>parseInt(e)||0)),l.enumInitialMembers&&(l.enumInitialMembers=l.enumInitialMembers.split(/[ ,]+/)),l.blockExternalInputs&&!l.inlineInputMode&&(l.inlineInputMode="external"),l.paramHelp={},l.jsDoc="",e=e.replace(/\/\*\*([^]*?)\*\//g,(e,t)=>(t=(t=t.replace(/\n\s*(\*\s*)?/g,"\n")).replace(/^\s*@param\s+(\w+)\s+(.*)$/gm,(e,t,r)=>{if(l.paramHelp[t]=r,!l.paramDefl[t]){r=/\beg\.?:\s*(.+)/.exec(r);if(r&&r[1]){r=/(?:"([^"]*)")|(?:'([^']*)')|(?:([^\s,]+))/g.exec(r[1]);if(r){let e=r[1]||r[2]||r[3];-1<(e=e||"").indexOf(" ")?l.paramDefl[t]=`"${e}"`:l.paramDefl[t]=e}}}return""}),l.jsDoc+=t,"")),l.jsDoc=l.jsDoc.trim(),l.async&&(l.callingConvention=1),l.promise&&(l.callingConvention=2),l.jres&&(l.whenUsed=!0),l.subcategories)try{l.subcategories=JSON.parse(l.subcategories)}catch(e){l.subcategories=void 0}if(l.groups)try{l.groups=JSON.parse(l.groups)}catch(e){l.groups=void 0}if(l.groupIcons)try{l.groupIcons=JSON.parse(l.groupIcons)}catch(e){l.groupIcons=void 0}if(l.groupHelp)try{l.groupHelp=JSON.parse(l.groupHelp)}catch(e){l.groupHelp=void 0}return T(l),l},E.parameterTypeIsArrowFunction=x,E.updateBlockDef=T,E.parseBlockDefinition=s,E.parseChecksumBlock=function(t,r=0){var e=pxt.HF2.read32(t,r);if(133083260!=(2147483647&e))return pxt.log("no checksum block magic"),null;var i=pxt.HF2.read32(t,r+4),n=pxt.HF2.read32(t,r+8);if(3&i)return pxt.log("invalid end marker position"),null;var s=1<<(255&n);if(s!=pxt.appTarget.compile.flashCodeAlign)return pxt.log("invalid page size: "+s),null;var a={magic:e,endMarkerPos:i,endMarker:n,regions:[]};for(let e=r+12;e<t.length-7;e+=8){var o={start:s*pxt.HF2.read16(t,e),length:s*pxt.HF2.read16(t,e+2),checksum:pxt.HF2.read32(t,e+4)};if(!o.length||!o.checksum)break;a.regions.push(o)}return a},(u=E.UF2||(E.UF2={})).UF2_MAGIC_START0=171066965,u.UF2_MAGIC_START1=2656915799,u.UF2_MAGIC_END=179400496,u.UF2_FLAG_NONE=0,u.UF2_FLAG_NOFLASH=1,u.UF2_FLAG_FILE=4096,u.UF2_FLAG_FAMILY_ID_PRESENT=8192,u.parseBlock=p,u.parseFile=function(t){var r=[];for(let e=0;e<t.length;e+=512){var i=p(t.slice(e,e+512));i&&r.push(i)}return r},u.toBin=function(t,r=void 0){if(t.length<512)return null;let i=-1,n=-1;var e,s=[];for(let e=0;e<t.length;++e){var a=512*e,o=p(t.slice(a,512+a));if(o){if(r&&o.targetAddr+256>r)break;-1==i&&(i=o.targetAddr,n=i);var l=o.targetAddr-i;l<0||l%4||1048576<l||(0<l&&s.push(new Uint8Array(l)),s.push(t.slice(32+a,32+a+o.payloadSize)),i=o.targetAddr+o.payloadSize)}}let c=0;for(e of s)c+=e.length;if(0==c)return null;var u,d=new Uint8Array(c);let h=0;for(u of s)for(let e=0;e<u.length;++e)d[h++]=u[e];return{buf:d,start:n}},u.readBytes=function(t,r,i){var n=new Uint8Array(i);let s;for(let e=0;e<i;++e,++r)(s=a(s,r)?s:t.filter(e=>a(e,r))[0])&&(n[e]=s.data[r-s.targetAddr]);return n},u.newBlockFile=o,u.finalizeFile=l,u.concatFiles=function(e){for(var t of e)l(t),t.filename=null;var r,i=o();i.blocks=E.U.concat(e.map(e=>e.blocks));for(r of e)r.blocks=[];return i},u.serializeFile=function(e){l(e);let t="";for(var r of e.blocks)t+=E.Util.uint8ArrayToString(r);return t},u.readBytesFromFile=function e(t,r,i){var n,s,a=r>>8;let o;if(a==t.currPtr)o=t.currBlock;else{for(let e=0;e<t.ptrs.length;++e)if(t.ptrs[e]==a){o=t.blocks[e];break}o&&(t.currPtr=a,t.currBlock=o)}return o?(n=new Uint8Array(i),s=Math.min(i,256-(255&r)),E.U.memcpy(n,0,o,32+(255&r),s),0<(i-=s)&&(r=e(t,r+s,i),E.U.memcpy(n,s,r)),n):null},u.writeBytes=h,u.writeHex=function(t,r){let i="0000";for(let e=0;e<r.length;++e){var n=/:02000004(....)/.exec(r[e]);if(n&&(i=n[1]),n=/^:..(....)00(.*)[0-9A-F][0-9A-F]$/.exec(r[e])){var s=parseInt(i+n[1],16),a=n[2],o=[];for(let e=0;e<a.length;e+=2)o.push(parseInt(a[e]+a[e+1],16));h(t,s,o)}}}}})(ts=ts||{}),(e=>{(e=(e=(e=e.pxtc||(e.pxtc={})).service||(e.service={})).ExtensionType||(e.ExtensionType={}))[e.Bundled=1]="Bundled",e[e.Github=2]="Github",e[e.ShareScript=3]="ShareScript"})(ts=ts||{}),(h=>{var e;{var t=h.shell||(h.shell={});let a;(e=a=t.EditorLayoutType||(t.EditorLayoutType={}))[e.IDE=0]="IDE",e[e.Sandbox=1]="Sandbox",e[e.Widget=2]="Widget",e[e.Controller=3]="Controller";let o;(e=o=t.ControllerMode||(t.ControllerMode={}))[e.None=0]="None",e[e.Basic=1]="Basic",e[e.App=2]="App";let l,c=o.None,u=!1,d=!1;function r(){if(void 0===l){if(h.BrowserUtils.hasWindow()){var e=/sandbox=1|#sandbox|#sandboxproject/i.test(window.location.href)||h.BrowserUtils.isIFrame(),t=/nosandbox=1/i.test(window.location.href),r=/controller=(0|1|2)/i.exec(window.location.href),r=(c=r&&h.BrowserUtils.isIFrame()?parseInt(r[1]):c)!==o.None,i=/readonly=1/i.test(window.location.href),n=/editorlayout=(widget|sandbox|ide)/i.exec(window.location.href),s=/noproject=1/i.test(window.location.href);if(l=a.IDE,t?l=a.Widget:r?l=a.Controller:e&&(l=a.Sandbox),r&&i&&(u=!0),r&&s&&(d=!0),n)switch(n[1].toLowerCase()){case"widget":l=a.Widget;break;case"sandbox":l=a.Sandbox;break;case"ide":l=a.IDE}}else l=a.Sandbox;h.debug(`shell: layout type ${a[l]}, readonly `+p())}}function i(){return r(),l==a.Sandbox}function n(){return/[?&]timeMachine=1/i.test(window.location.href)}function p(){return!h.BrowserUtils.hasWindow()||n()||i()&&!/[?&]edit=1/i.test(window.location.href)||s()&&u}function s(){return r(),l==a.Controller}t.layoutTypeClass=function(){return r(),h.shell.EditorLayoutType[l].toLowerCase()},t.isSandboxMode=i,t.isTimeMachineEmbed=n,t.isReadOnly=p,t.isNoProject=function(){return d},t.isControllerMode=s,t.getControllerMode=function(){return r(),c},t.isPyLangPref=function(){return"py"==h.storage.getLocal("editorlangpref")},t.getEditorLanguagePref=function(){return h.storage.getLocal("editorlangpref")},t.setEditorLanguagePref=function(e){e.match(/prj$/)&&(e=e.replace(/prj$/,"")),h.storage.setLocal("editorlangpref",e)},t.getToolboxAnimation=function(){return h.storage.getLocal("toolboxanimation")},t.setToolboxAnimation=function(){h.storage.setLocal("toolboxanimation","1")},t.hasHomeScreen=function(){return!h.shell.isControllerMode()&&!h.appTarget.appTheme.lockedEditor}}})(pxt=pxt||{}),(e=>{{var t=e.skillmap||(e.skillmap={});t.USER_VERSION="0.0.1";class r{constructor(){this.db=new e.BrowserUtils.IDBWrapper(r.databaseName,r.version,(e,t)=>{t=t.result;e.oldVersion<1&&(t.createObjectStore(r.projectTable,{keyPath:r.projectKey}),t.createObjectStore(r.userTable,{keyPath:r.userKey}))})}initAsync(){return this.db.openAsync()}getAllProjectsAsync(){return this.db.getAllAsync(r.projectTable).then(e=>e.map(e=>e.project).filter(e=>!e.deleted))}deleteProjectAsync(e){return this.getProjectAsync(e).then(e=>{e.deleted=!0,this.saveProjectAsync(e)})}getProjectAsync(e){return this.db.getAsync(r.projectTable,e).then(e=>null==e?void 0:e.project)}saveProjectAsync(e){return this.db.setAsync(r.projectTable,{id:e.header.id,project:e})}getUserStateAsync(){return this.db.getAsync(r.userTable,"local-user").then(e=>null==e?void 0:e.user)}saveUserStateAsync(e){return this.db.setAsync(r.userTable,{id:"local-user",user:e})}}r.version=6,r.databaseName="local-skill-map",r.projectTable="projects",r.projectKey="id",r.userTable="users",r.userKey="id",t.IndexedDBWorkspace=r}})(pxt=pxt||{}),(e=>{{var b=e.assets||(e.assets={});b.MAX_FREQUENCY=5e3,b.MAX_VOLUME=255,b.renderSoundPath=function(e,t,r){let{startFrequency:i,endFrequency:n,startVolume:s,endVolume:a,wave:o,interpolation:l}=e,c=(i=Math.max(Math.min(i,b.MAX_FREQUENCY),1),n=Math.max(Math.min(n,b.MAX_FREQUENCY),1),s=Math.max(Math.min(s,b.MAX_VOLUME),0),a=Math.max(Math.min(a,b.MAX_VOLUME),0),new y(i+n+1)),u;switch(l){case"linear":u=e=>i+e*(n-i)/t;break;case"curve":u=e=>i+(n-i)*Math.sin(e/t*(Math.PI/2));break;case"logarithmic":u=e=>i+Math.log10(1+e/t*9)*(n-i)}"noise"===o&&(u=()=>c.randomRange(500,5e3));var d=e=>Math.max(Math.min((a-s)/t*e+s,b.MAX_VOLUME),0);let h=t/2;var p=e=>e/b.MAX_VOLUME*(r-2)/2,f=e=>(1-e/b.MAX_FREQUENCY)*(h-10)+10,m=["M 2 "+r/2];let g=0;for(;g<t;)m.push(v(p(d(g)),f(u(g))/2,o,!1,c)),g+=f(u(g))/2,m.push(v(p(d(g)),f(u(g))/2,o,!0,c)),g+=f(u(g))/2;return m.join(" ")},b.renderWaveSnapshot=function(e,t,r,i,n,s){var a=new y(e),o=("noise"===r&&(e=a.randomRange(500,5e3)),e=Math.max(Math.min(e,b.MAX_FREQUENCY),1),t/b.MAX_VOLUME*(n-2)/2),l=i/(e*s/1e3)/2;let c=Math.ceil(i/(2*l));c%2==1&&c++;var u=[`M ${i/2-c*l} `+n/2];let d=0;for(let e=0;e<c;e++)u.push(v(o,l,r,!1,a)),d+=l,u.push(v(o,l,r,!0,a)),d+=l;return u.join(" ")};class y{constructor(e){this.seed=e,this.lfsr=e}next(){return(this.lfsr=this.lfsr>>1^46080&-(1&this.lfsr))/65535}randomRange(e,t){return e+(t-e)*this.next()}}function v(i,n,e,s,a){switch(e){case"triangle":return`l ${n/2} ${s?i:-i} l ${n/2} `+(s?-i:i);case"square":return`v ${s?i:-i} h ${n} v `+(s?-i:i);case"sawtooth":return s?`l ${n} ${i} v `+-i:`v ${-i} l ${n} `+i;case"sine":return`q ${n/2} ${1.9*(s?i:-i)} ${n} 0`;case"noise":var o,l=[],c=[],u=Math.min(4,n/4);let t=s;for(let e=0;e<n;e+=u)c.push(a.randomRange(0,i)*(t?1:-1)),t=!t;c[0]=s?i:-i;let e=c[c.length-1]=0,r=0;for(o of c){var d=Math.min(u,n-r);if(l.push(`v ${o-e} h `+d),e=o,(r+=d)>=n)break}return l.join(" ")}}function m(e,t,r){var i=new Uint8Array(2);new Uint16Array(i.buffer)[0]=0|r,e[t]=i[0],e[t+1]=i[1]}b.soundToInstructionBuffer=function(r,i,n){let{startFrequency:s,endFrequency:a,startVolume:o,endVolume:l,interpolation:e,duration:c}=r;var u=[];if("linear"===r.interpolation&&"none"===r.effect)u.push({frequency:s,volume:o/b.MAX_VOLUME*1024}),u.push({frequency:a,volume:l/b.MAX_VOLUME*1024});else{i=Math.min(i,Math.floor(c/5));let t;switch(e){case"linear":t=e=>s+e*(a-s)/c;break;case"curve":t=e=>s+(a-s)*Math.sin(e/c*(Math.PI/2));break;case"logarithmic":t=e=>s+Math.log10(1+e/c*9)*(a-s)}var d=c/i;for(let e=0;e<i;e++){var h={frequency:Math.max(t(e*d),1),volume:(h=e*d,(o+h*(l-o)/c)/b.MAX_VOLUME*1024)};"tremolo"===r.effect?e%2==0?h.volume=Math.max(h.volume-500*n,0):h.volume=Math.min(h.volume+500*n,1023):"vibrato"===r.effect?e%2==0?h.frequency=Math.max(h.frequency-100*n,1):h.frequency=h.frequency+100*n:"warble"===r.effect&&(e%2==0?h.frequency=Math.max(h.frequency-1e3*n,1):h.frequency=h.frequency+1e3*n),u.push(h)}}var t=new Uint8Array(12*(u.length-1)),p=Math.floor(c/(u.length-1));for(let e=0;e<u.length-1;e++){var f=12*e;t[f]=(e=>{switch(e){case"square":return 15;case"sine":return 3;case"triangle":return 1;case"noise":return 18;case"sawtooth":return 2}})(r.wave),m(t,2+f,u[e].frequency),m(t,4+f,p),m(t,6+f,u[e].volume),m(t,8+f,u[e+1].volume),m(t,10+f,u[e+1].frequency)}return t}}})(pxt=pxt||{}),(r=>{var e;(e=r.streams||(r.streams={})).createStreamAsync=function(e,t){return r.Cloud.privatePostAsync("streams",{target:e,name:t||"data"}).then(e=>e)},e.postPayloadAsync=function(e,t){return r.Util.assert(!!e.privatekey),r.Cloud.privatePostAsync(e.id+"/data?privatekey="+e.privatekey,t)}})(pxt=pxt||{}),(r=>{var e;{var n=r.svgUtil||(r.svgUtil={});let t;(e=t=n.PatternUnits||(n.PatternUnits={}))[e.userSpaceOnUse=0]="userSpaceOnUse",e[e.objectBoundingBox=1]="objectBoundingBox";let i;(e=i=n.LengthUnit||(n.LengthUnit={}))[e.em=0]="em",e[e.ex=1]="ex",e[e.px=2]="px",e[e.in=3]="in",e[e.cm=4]="cm",e[e.mm=5]="mm",e[e.pt=6]="pt",e[e.pc=7]="pc",e[e.percent=8]="percent";class o{constructor(e){this.el=s(e)}attr(t){return Object.keys(t).forEach(e=>{this.setAttribute(e,t[e])}),this}setAttribute(e,t){return this.el.setAttribute(e,t.toString()),this}setAttributeNS(e,t,r){return this.el.setAttributeNS(e,t,r.toString()),this}id(e){return this.setAttribute("id",e)}setClass(...e){return this.setAttribute("class",e.join(" "))}appendClass(e){return r.BrowserUtils.addClass(this.el,e),this}removeClass(e){r.BrowserUtils.removeClass(this.el,e)}title(e){this.titleElement||(this.titleElement=s("title"),this.el.firstChild?this.el.insertBefore(this.titleElement,this.el.firstChild):this.el.appendChild(this.titleElement)),this.titleElement.textContent=e}setVisible(e){return this.setAttribute("visibility",e?"visible":"hidden")}}n.BaseElement=o;class l extends o{draw(e){e=(e=>{switch(e){case"text":return new m;case"circle":return new b;case"rect":return new g;case"line":return new v;case"polygon":return new A;case"polyline":return new w;case"path":return new k;default:return new f(e)}})(e);return this.el.appendChild(e.el),e}element(e,t){return t(this.draw(e)),this}group(){var e=new u;return this.el.appendChild(e.el),e}appendChild(e){this.el.appendChild(e.el)}onDown(e){return n.events.down(this.el,e),this}onUp(e){return n.events.up(this.el,e),this}onMove(e){return n.events.move(this.el,e),this}onEnter(e){return n.events.enter(this.el,e),this}onLeave(e){return n.events.leave(this.el,e),this}onClick(e){return n.events.click(this.el,e),this}}n.DrawContext=l;class c extends l{constructor(e){super("svg"),e&&e.appendChild(this.el)}define(e){return this.defs||(this.defs=new h(this.el)),e(this.defs),this}}n.SVG=c;class u extends l{constructor(e){super("g"),e&&e.appendChild(this.el)}translate(e,t){return this.left=e,this.top=t,this.updateTransform()}scale(e){return this.scaleFactor=e,this.updateTransform()}def(){return new h(this.el)}style(){return new p(this.el)}updateTransform(){let e="";return null!=this.left&&(e+=`translate(${this.left} ${this.top})`),null!=this.scaleFactor&&(e+=` scale(${this.scaleFactor})`),this.setAttribute("transform",e),this}}n.Group=u;class d extends l{constructor(){super("pattern")}units(e){return this.setAttribute("patternUnits",e===t.objectBoundingBox?"objectBoundingBox":"userSpaceOnUse")}contentUnits(e){return this.setAttribute("patternContentUnits",e===t.objectBoundingBox?"objectBoundingBox":"userSpaceOnUse")}size(e,t){return this.setAttribute("width",e),this.setAttribute("height",t),this}}n.Pattern=d;class h extends o{constructor(e){super("defs"),e.appendChild(this.el)}create(e,t){let r;switch(e){case"path":r=new k;break;case"pattern":r=new d;break;case"radialGradient":r=new S;break;case"linearGradient":r=new T;break;case"clipPath":r=new C;break;default:r=new o(e)}return r.id(t),this.el.appendChild(r.el),r}}n.DefsElement=h;class p extends o{constructor(e){super("style"),e.appendChild(this.el)}content(e){this.el.textContent=e}}n.StyleElement=p;class f extends l{at(e,t){return this.setAttribute("x",e),this.setAttribute("y",t),this}moveTo(e,t){return this.at(e,t)}fill(e,t){return this.setAttribute("fill",e),null!=t&&this.opacity(t),this}opacity(e){return this.setAttribute("fill-opacity",e)}stroke(e,t){return this.setAttribute("stroke",e),null!=t&&this.strokeWidth(t),this}strokeWidth(e){return this.setAttribute("stroke-width",e)}strokeOpacity(e){return this.setAttribute("stroke-opacity",e)}clipPath(e){return this.setAttribute("clip-path",e)}}n.Drawable=f;class m extends f{constructor(e){super("text"),null!=e&&this.text(e)}text(e){return this.el.textContent=e,this}fontFamily(e){return this.setAttribute("font-family",e)}fontSize(e,t){return this.setAttribute("font-size",a(e,t))}offset(e,t,r){return 0!==e&&this.setAttribute("dx",a(e,r)),0!==t&&this.setAttribute("dy",a(t,r)),this}anchor(e){return this.setAttribute("text-anchor",e)}}n.Text=m;class g extends f{constructor(){super("rect")}width(e,t=i.px){return this.setAttribute("width",a(e,t))}height(e,t=i.px){return this.setAttribute("height",a(e,t))}corner(e){return this.corners(e,e)}corners(e,t){return this.setAttribute("rx",e),this.setAttribute("ry",t),this}size(e,t,r=i.px){return this.width(e,r),this.height(t,r),this}}n.Rect=g;class b extends f{constructor(){super("circle")}at(e,t){return this.setAttribute("cx",e),this.setAttribute("cy",t),this}radius(e){return this.setAttribute("r",e)}}n.Circle=b,class extends f{};class v extends f{constructor(){super("line")}at(e,t,r,i){return this.from(e,t),null!=r&&null!=i&&this.to(r,i),this}from(e,t){return this.setAttribute("x1",e),this.setAttribute("y1",t),this}to(e,t){return this.setAttribute("x2",e),this.setAttribute("y2",t),this}}n.Line=v;class y extends f{points(e){return this.setAttribute("points",e)}with(e){return this.points(e.map(({x:e,y:t})=>e+" "+t).join(","))}}n.PolyElement=y;class w extends y{constructor(){super("polyline")}}n.Polyline=w;class A extends y{constructor(){super("polygon")}}n.Polygon=A;class k extends f{constructor(){super("path"),this.d=new I}update(){return this.setAttribute("d",this.d.toAttribute())}path(e){return e(this.d),this.update()}setD(e){return this.setAttribute("d",e),this}}n.Path=k;class E extends f{constructor(){super("image")}src(e){return this.setAttributeNS("http://www.w3.org/1999/xlink","href",e)}width(e,t=i.px){return this.setAttribute("width",a(e,t))}height(e,t=i.px){return this.setAttribute("height",a(e,t))}size(e,t,r=i.px){return this.width(e,r),this.height(t,r),this}}n.Image=E;class x extends o{units(e){return this.setAttribute("gradientUnits",e===t.objectBoundingBox?"objectBoundingBox":"userSpaceOnUse")}stop(e,t,r){var i=s("stop");return i.setAttribute("offset",e+"%"),null!=t&&i.setAttribute("stop-color",t),null!=r&&i.setAttribute("stop-opacity",r),this.el.appendChild(i),this}}n.Gradient=x;class T extends x{constructor(){super("linearGradient")}start(e,t){return this.setAttribute("x1",e),this.setAttribute("y1",t),this}end(e,t){return this.setAttribute("x2",e),this.setAttribute("y2",t),this}}n.LinearGradient=T;class S extends x{constructor(){super("radialGradient")}center(e,t){return this.setAttribute("cx",e),this.setAttribute("cy",t),this}focus(e,t,r){return this.setAttribute("fx",e),this.setAttribute("fy",t),this.setAttribute("fr",r),this}radius(e){return this.setAttribute("r",e)}}n.RadialGradient=S;class C extends l{constructor(){super("clipPath")}clipPathUnits(e){return e?this.setAttribute("clipPathUnits","objectBoundingBox"):this.setAttribute("clipPathUnits","userSpaceOnUse")}}function s(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}n.ClipPath=C;class I{constructor(){this.ops=[]}clear(){this.ops=[]}moveTo(e,t){return this.op("M",e,t)}moveBy(e,t){return this.op("m",e,t)}lineTo(e,t){return this.op("L",e,t)}lineBy(e,t){return this.op("l",e,t)}cCurveTo(e,t,r,i,n,s){return this.op("C",e,t,r,i,n,s)}cCurveBy(e,t,r,i,n,s){return this.op("c",e,t,r,i,n,s)}qCurveTo(e,t,r,i){return this.op("Q",e,t,r,i)}qCurveBy(e,t,r,i){return this.op("q",e,t,r,i)}sCurveTo(e,t,r,i){return this.op("S",e,t,r,i)}sCurveBy(e,t,r,i){return this.op("s",e,t,r,i)}tCurveTo(e,t){return this.op("T",e,t)}tCurveBy(e,t){return this.op("t",e,t)}arcTo(e,t,r,i,n,s,a){return this.op("A",e,t,r,i?1:0,n?1:0,s,a)}arcBy(e,t,r,i,n,s,a){return this.op("a",e,t,r,i?1:0,n?1:0,s,a)}close(){return this.op("z")}toAttribute(){return this.ops.map(e=>e.op+" "+e.args.join(" ")).join(" ")}op(e,...t){return this.ops.push({op:e,args:t}),this}}function a(e,t){switch(t){case i.em:return e+"em";case i.ex:return e+"ex";case i.px:return e+"px";case i.in:return e+"in";case i.cm:return e+"cm";case i.mm:return e+"mm";case i.pt:return e+"pt";case i.pc:return e+"pc";case i.percent:return e+"%";default:return e.toString()}}n.PathContext=I}})(pxt=pxt||{}),(e=>{function r(){return"undefined"!=typeof window&&("ontouchstart"in window||navigator&&0<navigator.maxTouchPoints)}function i(){return"undefined"!=typeof window&&!!window.PointerEvent}(e=(e=e.svgUtil||(e.svgUtil={})).events||(e.events={})).isTouchEnabled=r,e.hasPointerEvents=i,e.down=function(e,t){i()?e.addEventListener("pointerdown",t):r()?(e.addEventListener("mousedown",t),e.addEventListener("touchstart",t)):e.addEventListener("mousedown",t)},e.up=function(e,t){i()?e.addEventListener("pointerup",t):(r(),e.addEventListener("mouseup",t))},e.enter=function(e,t){i()?e.addEventListener("pointerover",e=>{t(!!(1&e.buttons))}):r()?e.addEventListener("touchstart",e=>{t(!0)}):e.addEventListener("mouseover",e=>{t(!!(1&e.buttons))})},e.leave=function(e,t){i()?e.addEventListener("pointerleave",t):r()?e.addEventListener("touchend",t):e.addEventListener("mouseleave",t)},e.move=function(e,t){i()?e.addEventListener("pointermove",t):r()?e.addEventListener("touchmove",t):e.addEventListener("mousemove",t)},e.click=function(e,t){e.addEventListener("click",t)}})(pxt=pxt||{}),(e=>{e=e.svgUtil||(e.svgUtil={});{var t=e.helpers||(e.helpers={});class r extends e.Text{at(e,t){return this.cx=e,this.cy=t,this.rePosition(),this}text(e,t=12){return super.text(e),this.fontSizePixels=t,this.setAttribute("font-size",t+"px"),this.rePosition(),this}rePosition(){null!=this.cx&&null!=this.cy&&null!=this.fontSizePixels&&(this.setAttribute("x",this.cx),this.setAttribute("y",this.cy),this.setAttribute("text-anchor","middle"),this.setAttribute("alignment-baseline","middle"))}}t.CenteredText=r}})(pxt=pxt||{}),(e=>{(e=e.editor||(e.editor={})).initExtensionsAsync=e=>Promise.resolve({}),e.initFieldExtensionsAsync=e=>Promise.resolve({})})(pxt=pxt||{}),(v=>{v.IMAGE_MIME_TYPE="image/x-mkcd-f4",v.TILEMAP_MIME_TYPE="application/mkcd-tilemap",v.ANIMATION_MIME_TYPE="application/mkcd-animation",v.SONG_MIME_TYPE="application/mkcd-song",v.JSON_MIME_TYPE="application/json";class i{constructor(e){this.type=e,this.assets=[],this.takenNames={},this.listeners=[]}add(e){return this.takenNames[e.id]?this.update(e.id,e):(e=a(e),this.takenNames[e.id]=!0,this.takenNames[h(e)]=!0,e.meta.displayName&&e.meta.displayName!==e.id&&(this.takenNames[e.meta.displayName]&&(e.meta.displayName=this.generateNewDisplayName(e.meta.displayName)),this.takenNames[e.meta.displayName]=!0),this.assets.push(e),a(e))}getSnapshot(t){return t?this.assets.filter(e=>t(e)).map(e=>a(e)):this.assets.map(e=>a(e))}update(e,t){let r;if(this.takenNames[e]){var i=this.lookupByID(e);if(l(i,t))r=t;else{if(!p(t)&&p(i))return v.warn("Refusing to overwrite asset with invalid version"),v.tickEvent("assets.invalidAssetOverwrite",{assetType:t.type}),i;this.removeByID(e),r=this.add(t),this.notifyListener(t.internalID)}}else r=this.add(t);return r}removeByID(t){var e=this.lookupByID(t);this.assets=this.assets.filter(e=>e.id!==t),delete this.takenNames[t],e&&delete this.takenNames[h(e)],null!=e&&e.meta.displayName&&delete this.takenNames[null==e?void 0:e.meta.displayName]}getByID(e){e=this.lookupByID(e);return e&&a(e)}getByDisplayName(e){if(this.takenNames[e])for(var t of this.assets)if(t.meta.displayName===e||h(t)===e)return a(t)}getByValue(e){for(var t of this.assets)if(l(e,t,!0))return t}isIDTaken(e){return!!this.takenNames[e]}clone(){var e=new i(this.type);return e.assets=this.getSnapshot(),e.takenNames=Object.assign({},this.takenNames),e}serializeToJRes(e={},t){for(var r of this.assets)if(!t||t(r)){c=l=o=a=s=n=i=void 0;var i=r,n=e,s=i.id.substr(i.id.lastIndexOf(".")+1),a=i.meta.tags;switch(i.type){case"image":n[s]=i.jresData,(i.meta.displayName||null!=a&&a.length)&&(o={data:i.jresData,mimeType:v.IMAGE_MIME_TYPE},i.meta.displayName&&(o.displayName=i.meta.displayName),null!=a&&a.length&&(o.tags=a),n[s]=o);break;case"tile":var o={data:i.jresData,mimeType:v.IMAGE_MIME_TYPE,tilemapTile:!0,displayName:i.meta.displayName};null!=a&&a.length&&(o.tags=a),n[s]=o;break;case"tilemap":var l=((e,t,r)=>{var i=e.tilemap.data(),n=new Uint8ClampedArray(5+i.data.length+e.layers.data.length);return n[0]=e.tileset.tileWidth,n[1]=255&i.width,n[2]=i.width>>8&255,n[3]=255&i.height,n[4]=i.height>>8&255,n.set(i.data,5),n.set(e.layers.data,5+i.data.length),{id:t,mimeType:v.TILEMAP_MIME_TYPE,data:btoa(v.sprite.uint8ArrayToHex(n)),tileset:e.tileset.tiles.map(e=>e.id),displayName:r}})(i.data,i.id,i.meta.displayName);n[l.id]=l;break;case"animation":n[s]=(e=>{var t,r={namespace:e.id.substr(0,e.id.lastIndexOf(".")),id:e.id.substr(e.id.lastIndexOf(".")+1),mimeType:v.ANIMATION_MIME_TYPE,data:v.sprite.encodeAnimationString(e.frames,e.interval),displayName:e.meta.displayName};return null!=(t=e.meta.tags)&&t.length&&(r.tags=e.meta.tags),r})(i);break;case"song":l={data:v.assets.music.encodeSongToHex(i.song),mimeType:v.SONG_MIME_TYPE,displayName:i.meta.displayName,namespace:v.sprite.SONG_NAMESPACE+"."};null!=a&&a.length&&(l.tags=a),n[s]=l;break;case"json":var c={data:JSON.stringify({data:i.data,fileName:i.fileName}),mimeType:v.JSON_MIME_TYPE,displayName:i.meta.displayName,namespace:v.sprite.JSON_NAMESPACE+"."};null!=a&&a.length&&(c.tags=a),n[s]=c}}return e}addListener(e,t){this.listeners.push({internalID:e,callback:t})}removeListener(t){this.listeners=this.listeners.filter(e=>e.callback!==t)}diff(e){var t,r,i={before:[],after:[]};let n={};for(t of e.assets){n[t.internalID]=!0;var s=this.lookupByInternalID(t.internalID);s&&l(t,s)||(i.before.push(t),i.after.push(s))}for(r of this.assets.filter(e=>!n[e.internalID]))i.before.push(null),i.after.push(r);return i}applyDiff(e,t=!1){var r,i=t?e.after:e.before,n=t?e.before:e.after;v.Util.assert(i.length===n.length);for(let e=0;e<i.length;e++)i[e]?(this.removeByInternalID(i[e].internalID),n[e]&&this.assets.push(n[e]),this.notifyListener(i[e].internalID)):(this.assets.push(n[e]),this.notifyListener(n[e].internalID));this.takenNames={};for(r of this.assets)v.Util.assert(!this.takenNames[r.id]),this.takenNames[r.id]=!0,this.takenNames[h(r)]=!0,r.meta.displayName&&(r.meta.displayName!==r.id&&v.Util.assert(!this.takenNames[r.meta.displayName]),this.takenNames[r.meta.displayName]=!0)}lookupByID(e){for(var t of this.assets)if(t.id===e)return t;return null}lookupByInternalID(e){for(var t of this.assets)if(t.internalID===e)return t;return null}removeByInternalID(t){this.assets=this.assets.filter(e=>e.internalID!==t)}notifyListener(e){for(var t of this.listeners)t.internalID===e&&t.callback()}generateNewDisplayName(e){e=e.replace(/\d+$/,"");let t=0;for(;this.takenNames[e+t];)++t;return e+t}}class r{constructor(){this.needsRebuild=!0,this.nextID=0,this.nextInternalID=0,this.committedState={revision:0,assets:{image:new i("image"),tile:new i("tile"),tilemap:new i("tilemap"),animation:new i("animation"),song:new i("song"),json:new i("json")}},this.state={revision:this.nextID++,assets:{image:new i("image"),tile:new i("tile"),tilemap:new i("tilemap"),animation:new i("animation"),song:new i("song"),json:new i("json")}},this.gallery={revision:0,assets:{image:new i("image"),tile:new i("tile"),tilemap:new i("tilemap"),animation:new i("animation"),song:new i("song"),json:new i("json")}},this.undoStack=[],this.redoStack=[]}getNewInternalId(){return this.nextInternalID++}createNewImage(e=16,t=16){this.onChange();var r=this.generateNewID("image"),e=new v.sprite.Bitmap(e,t).data(),t={internalID:this.getNewInternalId(),id:r,type:"image",bitmap:e,meta:{},jresData:v.sprite.base64EncodeBitmap(e)};return this.getAssetCollection("image").add(t)}createNewAnimation(e=16,t=16){this.onChange();var r=this.generateNewID("animation"),e=new v.sprite.Bitmap(e,t).data(),t={internalID:this.getNewInternalId(),id:r,type:"animation",frames:[e],interval:500,meta:{}};return this.getAssetCollection("animation").add(t)}createNewAnimationFromData(e,t=500,r){this.onChange();var i=this.generateNewID("animation"),i={internalID:this.getNewInternalId(),id:i,type:"animation",frames:e,interval:t,meta:{displayName:r}};return this.getAssetCollection("animation").add(i)}getGalleryTiles(t){return this.extensionTileSets?this.extensionTileSets.map(e=>e.tileSets.find(e=>e.tileWidth===t)).filter(e=>null==e?void 0:e.tiles.length):null}getProjectImages(){return this.getAssetCollection("image").getSnapshot()}getProjectTiles(t,e){var r=this.getAssetCollection("tile").getSnapshot(e=>e.bitmap.width===t);return 0===r.length?e?(this.createNewTile(new v.sprite.Bitmap(t,t).data()),this.getProjectTiles(t,!1)):null:{tileWidth:t,tiles:r}}createNewTile(e,t,r){this.onChange(),t&&!this.isNameTaken("tile",t)||(t=this.generateNewID("tile"));t={internalID:this.getNewInternalId(),id:t,type:"tile",jresData:v.sprite.base64EncodeBitmap(e),bitmap:e,meta:{displayName:r},isProjectTile:!0};return this.getAssetCollection("tile").add(t)}createNewProjectImage(e,t){this.onChange();t={internalID:this.getNewInternalId(),id:this.generateNewID("image"),type:"image",jresData:v.sprite.base64EncodeBitmap(e),meta:{displayName:t},bitmap:e};return this.getAssetCollection("image").add(t)}createNewSong(e,t){this.onChange();e={internalID:this.getNewInternalId(),id:this.generateNewID("song"),type:"song",song:v.assets.music.cloneSong(e),meta:{displayName:t}};return this.getAssetCollection("song").add(e)}createNewJsonAsset(e,t,r){this.onChange();e={internalID:this.getNewInternalId(),id:this.generateNewID("json"),type:"json",data:e,fileName:t,meta:{displayName:r}};return this.getAssetCollection("json").add(e)}updateTile(t){this.onChange();var e=this.resolveProjectTileByInternalID(t.internalID);if(e){if(this.getAssetCollection("tile").update(e.id,t),e.id!==t.id||!v.sprite.bitmapEquals(e.bitmap,t.bitmap))for(var r of this.getAssets("tilemap"))r.data.tileset.tiles.some(e=>e.internalID===t.internalID)&&(r.data.tileset.tiles=r.data.tileset.tiles.map(e=>e.internalID===t.internalID?t:e),this.updateTilemap(r.id,r.data));return t}return null}deleteTile(e){this.onChange(),this.getAssetCollection("tile").removeByID(e)}getProjectTilesetJRes(t){var e={};return this.getAssetCollection("tile").serializeToJRes(e),this.getAssetCollection("tilemap").serializeToJRes(e,e=>!t||!v.sprite.isTilemapEmptyOrUnused(e,this,t)),e["*"]={mimeType:"image/x-mkcd-f4",dataEncoding:"base64",namespace:v.sprite.TILE_NAMESPACE},e}getProjectAssetsJRes(){var e,t={};for(e of Object.keys(this.state.assets))"tilemap"!==e&&"tile"!==e&&this.state.assets[e].serializeToJRes(t);return t["*"]={mimeType:"image/x-mkcd-f4",dataEncoding:"base64",namespace:v.sprite.IMAGES_NAMESPACE},t}getTilemap(e){return this.getAssetCollection("tilemap").getByID(e)}updateTilemap(e,t){var r=this.getAssetCollection("tilemap").getByID(e);return r?(this.onChange(),r=Object.assign(Object.assign({},r),{data:t}),this.getAssetCollection("tilemap").update(e,r),r):null}createNewTilemap(e,t,r=16,i=16){return this.createNewTilemapFromData(this.blankTilemap(t,r,i),e)}blankTilemap(e,t=16,r=16){var i=new v.sprite.Tilemap(t,r),t=new v.sprite.Bitmap(t,r),r={tileWidth:e,tiles:[this.getTransparency(e)]};return new v.sprite.TilemapData(i,r,t.data())}resolveTile(e){return this.lookupAsset("tile",e)}resolveProjectTileByInternalID(t){return this.getAssetCollection("tile").getSnapshot(e=>e.internalID===t)[0]}resolveTileByBitmap(e){let t=v.sprite.base64EncodeBitmap(e);return this.getAssetCollection("tile").getSnapshot(e=>e.jresData===t)[0]}getTransparency(e){var t=v.sprite.TILE_NAMESPACE+".transparency"+e;let r=this.getAssetCollection("tile").getByID(t);return r||(e=new v.sprite.Bitmap(e,e).data(),r={internalID:this.getNewInternalId(),id:t,type:"tile",bitmap:e,jresData:v.sprite.base64EncodeBitmap(e),meta:{},isProjectTile:!0},this.getAssetCollection("tile").add(r))}createNewTilemapFromData(e,t){this.onChange();var r=this.generateNewIDInternal("tilemap",t||lf("level"));return this.getAssetCollection("tilemap").add({internalID:this.getNewInternalId(),id:r,type:"tilemap",meta:{displayName:t||r},data:e}),[r,e]}cloneState(){var e,t={revision:this.state.revision,assets:{}};for(e of Object.keys(this.state.assets))t.assets[e]=this.state.assets[e].clone();return t}undo(){if(this.state.revision!==this.committedState.revision&&this.pushUndo(),this.undoStack.length){var e,t=this.undoStack.pop();for(e of Object.keys(t.assetDiffs))this.getAssetCollection(e).applyDiff(t.assetDiffs[e],!0);this.state.revision=t.beforeRevision,this.redoStack.push(t),this.committedState=this.cloneState(),this.needsRebuild=!0}}redo(){if(this.redoStack.length){var e,t=this.redoStack.pop();for(e of Object.keys(t.assetDiffs))this.getAssetCollection(e).applyDiff(t.assetDiffs[e]);this.state.revision=t.afterRevision,this.undoStack.push(t),this.committedState=this.cloneState(),this.needsRebuild=!0}}pushUndo(){if(!this.undoStack.length||this.committedState.revision!==this.state.revision){this.redoStack=[],this.undoStack.push({beforeRevision:this.committedState.revision,afterRevision:this.state.revision,assetDiffs:{}});var e,t=this.undoStack[this.undoStack.length-1];for(e of Object.keys(this.state.assets))t.assetDiffs[e]=this.state.assets[e].diff(this.committedState.assets[e]);this.committedState=this.cloneState(),this.cleanupTemporaryAssets()}}revision(){return this.state.revision}encodeTilemap(e,t){var r=e.tilemap.data(),i=new Uint8ClampedArray(5+r.data.length+e.layers.data.length);return i[0]=e.tileset.tileWidth,i[1]=255&r.width,i[2]=r.width>>8&255,i[3]=255&r.height,i[4]=r.height>>8&255,i.set(r.data,5),i.set(e.layers.data,5+r.data.length),{id:t,mimeType:v.TILEMAP_MIME_TYPE,data:btoa(v.sprite.uint8ArrayToHex(i)),tileset:e.tileset.tiles.map(e=>e.id)}}forceUpdate(){this.onChange()}isNameTaken(t,e){var r=e=>this.getAssetCollection(t).isIDTaken(e)||this.getAssetCollection(t,!0).isIDTaken(e),i=m(t,e),n=i&&i!==e;return r(e)||n&&r(i)}isAssetUsed(r,i,n){var s;if(0<((null==(s=null==(s=r.meta)?void 0:s.blockIDs)?void 0:s.filter(e=>!n||(null==n?void 0:n.indexOf(e))<0))||[]).length)return!0;if("tile"==r.type)for(var e of this.getAssets("tilemap"))if(!(0<=(null==n?void 0:n.indexOf(e.id)))&&e.data.tileset.tiles.some(e=>e.id===r.id))return!0;if(i){var a=v.Util.escapeForRegex(h(r)),o=v.Util.escapeForRegex(null==(s=r.meta)?void 0:s.displayName)||"";let e;switch(r.type){case"tile":e=`myTiles.${a}|assets.tile\`${a}\``,o&&(e+=`|assets.tile\`${o}\``);break;case"tilemap":e=`tilemap\`${a}\``;break;case"animation":e=`assets.animation\`${a}\``,o&&(e+=`|assets.animation\`${o}\``);break;case"song":e=`assets.song\`${a}\``,o&&(e+=`|assets.song\`${o}\``);break;case"json":e=`assets.json\`${a}\``,o&&(e+=`|assets.json\`${o}\``);break;default:e=`assets.image\`${a}\``,o&&(e+=`|assets.image\`${o}\``)}var l=new RegExp(e,"gm");let t;switch(r.type){case"tile":t=`myTiles.${a}|assets.tile("""${a}""")`,o&&(t+=`|assets.tile("""${o}""")`);break;case"tilemap":t=`assets.tilemap("""${a}""")`;break;case"animation":t=`assets.animation("""${a}""")`,o&&(t+=`|assets.animation("""${o}""")`);break;case"song":t=`assets.song("""${a}""")`,o&&(t+=`|assets.song("""${o}""")`);break;case"json":t=`assets.json("""${a}""")`,o&&(t+=`|assets.json("""${o}""")`);break;default:t=`assets.image("""${a}""")`,o&&(t+=`|assets.image("""${o}""")`)}var c,u=new RegExp(t,"gm");for(c of Object.keys(i))if(!(0<=(null==n?void 0:n.indexOf(c)))){var d=i[c];if(c.match(/((?!\.g).{2}|^.{0,1})\.ts$/i)){if(d.content.match(l))return!0}else if(c.endsWith(".py")&&d.content.match(u))return!0}}return!1}lookupAsset(e,t){return this.getAssetCollection(e).getByID(t)||this.getAssetCollection(e,!0).getByID(t)}lookupAssetByName(e,t){return this.getAssetCollection(e).getByDisplayName(t)}lookupAssetByValue(e,t){return this.getAssetCollection(e).getByValue(t)}getAssets(e){return this.getAssetCollection(e).getSnapshot()}getGalleryAssets(e){return this.getAssetCollection(e).getSnapshot()}lookupBlockAsset(e,t){return this.getAssetCollection(e).getSnapshot(e=>-1!==(null==(e=null==(e=e.meta)?void 0:e.blockIDs)?void 0:e.indexOf(t)))[0]}updateAsset(e){return this.onChange(),"tile"!==e.type?this.getAssetCollection(e.type).update(e.id,e):this.updateTile(e)}duplicateAsset(e,t){this.onChange();var r=a(e),i=t||(null==(t=r.meta)?void 0:t.displayName);let n;switch(e.type){case"image":n=this.createNewProjectImage(r.bitmap,i);break;case"tile":n=this.createNewTile(r.bitmap,null,i);break;case"tilemap":var[s,,]=this.createNewTilemapFromData(r.data,i);n=this.getTilemap(s);break;case"animation":n=this.createNewAnimationFromData(r.frames,r.interval,i);break;case"song":n=this.createNewSong(r.song,i);break;case"json":n=this.createNewJsonAsset(r.data,e.fileName,i)}return n}removeAsset(e){this.onChange(),this.getAssetCollection(e.type).removeByID(e.id)}addChangeListener(e,t){this.getAssetCollection(e.type).addListener(e.internalID,t)}removeChangeListener(e,t){this.getAssetCollection(e).removeListener(t)}loadPackage(e){var t,r,i=e.sortedDeps();this.extensionTileSets=[];for(t of i){var n,s,a="this"===t.id;for(n of this.readImages(t.parseJRes(),a))n.meta.package=t.id,("tile"===n.type?this.getAssetCollection("tile",!a):"image"===n.type?this.getAssetCollection("image",!a):"animation"===n.type?this.getAssetCollection("animation",!a):"json"===n.type?this.getAssetCollection("json",!a):a?(s=v.sprite.IMAGES_NAMESPACE+".",n.id.startsWith(s)&&(n.id=n.id.replace(s,v.sprite.SONG_NAMESPACE+".")),this.getAssetCollection("song")):this.getAssetCollection("song",!0)).add(n)}for(r of i){var o,l="this"===r.id;for(o of c(r.parseJRes()))l?this.getAssetCollection("tilemap").add({internalID:this.getNewInternalId(),type:"tilemap",id:o.id,meta:{displayName:o.displayName||o.id,package:e.id},data:y(o,e=>this.resolveTile(e))}):this.getAssetCollection("tilemap",!0).add({internalID:this.getNewInternalId(),type:"tilemap",id:o.id,meta:{displayName:o.displayName||o.id,package:e.id},data:y(o,e=>this.getAssetCollection("tile",!0).getByID(e))})}this.committedState=this.cloneState(),this.undoStack=[],this.redoStack=[]}loadTilemapJRes(e,t=!1,r=!1){e=v.inflateJRes(e);var i,n=this.readImages(e,!r).filter(e=>"tile"===e.type);let s={};if(r)for(var a of n)this.getAssetCollection("tile",!0).add(a);else for(var o of n){if(t){var l=this.resolveTileByBitmap(o.bitmap);if(l){s[o.id]=l.id;continue}}l=this.createNewTile(o.bitmap,o.id,o.meta.displayName);l.id!==o.id&&(s[o.id]=l.id)}for(i of c(e))this.getAssetCollection("tilemap",r).add({internalID:this.getNewInternalId(),type:"tilemap",id:i.id,meta:{displayName:i.displayName||i.id},data:y(i,e=>(s[e]&&(e=s[e]),this.resolveTile(e)))})}loadAssetsJRes(e,t=!1){e=v.inflateJRes(e);var r,i,n=[];for(r of Object.keys(e)){var s,a,o=e[r];o.tilemapTile?this.getAssetCollection("tile",t).add(this.generateImage(o,"tile")):o.mimeType===v.IMAGE_MIME_TYPE?this.getAssetCollection("image",t).add(this.generateImage(o,"image")):o.mimeType===v.ANIMATION_MIME_TYPE?([s,a]=this.generateAnimation(o),a?n.push(s):this.getAssetCollection("animation",t).add(s)):o.mimeType===v.SONG_MIME_TYPE?this.getAssetCollection("song",t).add(this.generateSong(o)):o.mimeType===v.JSON_MIME_TYPE&&this.getAssetCollection("json",t).add(this.generateJsonAsset(o))}for(i of n)this.getAssetCollection("animation",t).add(this.inflateAnimation(i,this.getAssetCollection("image",t).getSnapshot()))}removeInactiveBlockAssets(t){for(var e of Object.keys(this.state.assets)){i=r=a=s=n=void 0;var r,i,n=this.state.assets[e],s=n.getSnapshot(e=>!e.meta.displayName&&(null==(e=e.meta.blockIDs)?void 0:e.some(e=>-1===t.indexOf(e)))),a=[];for(r of s)(1===r.meta.blockIDs.length||(r.meta.blockIDs=r.meta.blockIDs.filter(e=>-1!==t.indexOf(e)),0===r.meta.blockIDs.length))&&a.push(r);for(i of a)n.removeByID(i.id)}}clone(){var e,t=new r;return t.committedState=s(this.committedState),t.state=s(this.state),t.gallery=s(this.gallery),t.extensionTileSets=null==(e=this.extensionTileSets)?void 0:e.map(e=>Object.assign(Object.assign({},e),{tileSets:e.tileSets.map(e=>Object.assign(Object.assign({},e),{tiles:e.tiles.map(e=>a(e))}))})),t.needsRebuild=this.needsRebuild,t.nextID=this.nextID,t.nextInternalID=this.nextInternalID,t.undoStack=this.undoStack.map(e=>o(e)),t.redoStack=this.undoStack.map(e=>o(e)),t}saveGallerySnapshot(){return this.gallery}loadGallerySnapshot(e){this.gallery=e}generateImage(e,t){return{internalID:this.getNewInternalId(),type:t,id:e.id,meta:{displayName:e.displayName,tags:e.tags},jresData:e.data,bitmap:v.sprite.getBitmapFromJResURL(`data:${v.IMAGE_MIME_TYPE};base64,`+e.data).data()}}generateSong(e){return{internalID:this.getNewInternalId(),type:"song",id:e.id,meta:{displayName:e.displayName,tags:e.tags},song:v.assets.music.decodeSongFromHex(e.data)}}generateJsonAsset(e){var t=JSON.parse(e.data);return{internalID:this.getNewInternalId(),type:"json",id:e.id,meta:{displayName:e.displayName,tags:e.tags},data:t.data,fileName:t.fileName}}generateAnimation(t){if("json"!==t.dataEncoding)return[Object.assign(Object.assign({},w(t)),{internalID:this.getNewInternalId()}),!1];{let e;try{e=JSON.parse(t.data)}catch(e){v.warn("could not parse json data of '"+t.id+"'")}return[{internalID:this.getNewInternalId(),type:"animation",meta:{displayName:t.displayName,tags:t.tags},id:t.id,frames:[],frameIds:e.frames,interval:100,flippedHorizontal:e.flippedHorizontal},!0]}}inflateAnimation(e,r){return e.frames=e.frameIds.map(t=>r.find(e=>e.id===t).bitmap),e.flippedHorizontal&&(e.frames=e.frames.map(e=>{var r=v.sprite.Bitmap.fromData(e),i=new v.sprite.Bitmap(e.width,e.height);for(let t=0;t<i.width;t++)for(let e=0;e<i.height;e++)i.set(t,e,r.get(r.width-t-1,e));return i.data()})),e}generateNewID(e){switch(e){case"animation":return this.generateNewIDInternal("animation",v.sprite.ANIMATION_PREFIX,v.sprite.ANIMATION_NAMESPACE);case"image":return this.generateNewIDInternal("image",v.sprite.IMAGE_PREFIX,v.sprite.IMAGES_NAMESPACE);case"tile":return this.generateNewIDInternal("tile",v.sprite.TILE_PREFIX,v.sprite.TILE_NAMESPACE);case"tilemap":return this.generateNewIDInternal("tilemap",lf("level"));case"song":return this.generateNewIDInternal("song",v.sprite.SONG_PREFIX,v.sprite.SONG_NAMESPACE);case"json":return this.generateNewIDInternal("json",v.sprite.JSON_PREFIX,v.sprite.JSON_NAMESPACE)}}generateNewIDInternal(e,t,r){t=t.replace(/\d+$/,"");var i=r?r+"."+t:t;let n=1;for(;this.isNameTaken(e,i+n);)++n;return i+n}onChange(){this.needsRebuild=!0,this.state.revision=this.nextID++}readImages(e,t=!1){var r,i,n=[],s=[];for(r of Object.keys(e)){var a,o,l=e[r];l.tilemapTile?((a=this.generateImage(l,"tile")).isProjectTile=t,n.push(a)):l.mimeType===v.IMAGE_MIME_TYPE?n.push(this.generateImage(l,"image")):l.mimeType===v.ANIMATION_MIME_TYPE?([a,o]=this.generateAnimation(l),(o?s:n).push(a)):l.mimeType===v.SONG_MIME_TYPE?n.push(this.generateSong(l)):l.mimeType===v.JSON_MIME_TYPE&&n.push(this.generateJsonAsset(l))}for(i of s)n.push(this.inflateAnimation(i,n));return n}cleanupTemporaryAssets(){var e,t=this.getAssetCollection("image");for(e of t.getSnapshot(e=>!(e.meta.displayName||null!=(e=e.meta.blockIDs)&&e.length)))t.removeByID(e.id)}getAssetCollection(e,t=!1){return b(t?this.gallery:this.state,e,!0)}}function c(e){var t,r=[];for(t of Object.keys(e)){var i=e[t];i.mimeType===v.TILEMAP_MIME_TYPE&&r.push(i)}return r}function u(e,t){return"\n"+`    helpers._registerFactory("${e}", function(name: string) {
`+`        switch(helpers.stringTrim(name)) {
`+t.map(e=>e.keys.filter(e=>!!e).map(e=>`            case "${e}":`).join("\n")+`return ${e.expression};`).join("\n")+"\n"+`        }
`+`        return null;
`+`    })
`}function n(e){return v.sprite.Bitmap.fromData(e).copy().data()}function y(e,t){var r=atob(e.data),r=v.U.fromHex(r),i=r[1]|r[2]<<8,n=r[3]|r[4]<<8,e=e.tileset.map(e=>t&&t(e)||{id:e});let s=r[0];var a={tileWidth:s=(s=s||e.length&&(null==(a=e.find(e=>null==(e=e.bitmap)?void 0:e.width))?void 0:a.bitmap.width))||16,tiles:e},e=r.slice(5,5+i*n),o=new v.sprite.Tilemap(i,n,0,0,new Uint8ClampedArray(e)),r=r.slice(5+e.length),e=new v.sprite.Bitmap(i,n,0,0,new Uint8ClampedArray(r)).data();return new v.sprite.TilemapData(o,a,e)}function a(e,t=!1){switch(e.meta=Object.assign({},e.meta),e.meta.temporaryInfo&&(e.meta.temporaryInfo=Object.assign({},e.meta.temporaryInfo)),e.type){case"tile":case"image":return Object.assign(Object.assign({},e),{bitmap:n(e.bitmap)});case"animation":return Object.assign(Object.assign({},e),{frames:e.frames.map(e=>n(e))});case"tilemap":return Object.assign(Object.assign({},e),{data:e.data.cloneData(t)});case"song":return Object.assign(Object.assign({},e),{song:v.assets.music.cloneSong(e.song)});case"json":return Object.assign(Object.assign({},e),{data:v.U.clone(e.data)})}}function s(e){var t,r={revision:e.revision,assets:{}};for(t of Object.keys(e.assets)){var i=e.assets[t];r.assets[t]=i.clone()}return r}function o(e){var t,r=Object.assign(Object.assign({},e),{assetDiffs:{}});for(t of Object.keys(e.assetDiffs)){var i=e.assetDiffs[t];r.assetDiffs[t]=(i=i,Object.assign(Object.assign({},i),{before:i.before.map(e=>a(e)),after:i.after.map(e=>a(e))}))}return r}function l(e,t,r=!1){if(e==t)return!0;if(!e&&t||!t&&e||e.type!==t.type)return!1;if(!(r||e.id===t.id&&v.U.arrayEquals(e.meta.tags,t.meta.tags)&&v.U.arrayEquals(e.meta.blockIDs,t.meta.blockIDs)&&e.meta.displayName===t.meta.displayName))return!1;switch(e.type){case"image":case"tile":return v.sprite.bitmapEquals(e.bitmap,t.bitmap);case"animation":return e.interval===t.interval&&v.U.arrayEquals(e.frames,t.frames,v.sprite.bitmapEquals);case"tilemap":return e.data.equals(t.data);case"song":return v.assets.music.songEquals(e.song,t.song);case"json":return e.fileName===t.fileName&&v.U.deepEqual(e.data,t.data)}}function d(e){e=/^\s*(?:(?:assets\s*\.\s*(image|tile|animation|tilemap|song))|(tilemap))\s*(?:`|\(""")([^`"]+)(?:`|"""\))\s*$/m.exec(e);if(e)return{type:e[1]||e[2],name:e[3].trim()}}function h(e){return m(e.type,e.id)}function p(e){if(!e)return!1;switch(e.type){case"image":case"tile":return!!(i=e).bitmap&&f(v.sprite.Bitmap.fromData(i.bitmap));case"tilemap":return!!((i=e).data&&i.data.tilemap&&i.data.tileset&&i.data.tileset.tileWidth&&null!=(r=i.data.tileset.tiles)&&r.length&&i.data.layers)&&f(v.sprite.Bitmap.fromData(i.data.layers))&&f(i.data.tilemap);case"animation":r=e;return!(null==(t=r.frames)||!t.length||r.interval<=0||r.frames.some(e=>!f(v.sprite.Bitmap.fromData(e))));case"song":return(t=e).song&&0<t.song.ticksPerBeat&&0<t.song.beatsPerMeasure&&0<t.song.measures&&0<t.song.beatsPerMinute&&!!t.song.tracks;case"json":return!!e.data}var t,r,i}function f(e){return 0<e.width&&0<e.height&&!Number.isNaN(e.x0)&&!Number.isNaN(e.y0)&&e.data().data.length===e.dataLength()}function m(e,t,r=!1){let i;switch(e){case"image":i=v.sprite.IMAGES_NAMESPACE+".";break;case"tile":i=v.sprite.TILE_NAMESPACE+".";break;case"tilemap":i="";break;case"animation":i=v.sprite.ANIMATION_NAMESPACE+".";break;case"song":i=v.sprite.SONG_NAMESPACE+".";break;case"json":i=v.sprite.JSON_NAMESPACE+"."}if(i)if(t.startsWith(i)){e=t.substr(i.length);if(-1===e.indexOf("."))return e}else if(!r)return null;return t}function w(e){var t=atob(e.data),r=new Uint8ClampedArray(v.U.fromHex(t)),t=g(r,0),i=g(r,2),n=g(r,4),s=g(r,6),a=Math.ceil(i*n/2);let o=8;var l=[];for(let e=0;e<s;e++){var c=r.slice(o,o+a);l.push({x0:0,y0:0,width:i,height:n,data:c}),o+=a}let u=e.id;return{type:"animation",internalID:0,id:u=u.startsWith(e.namespace)?u:(u=e.namespace+"."+u).replace(/\.\./g,"."),interval:t,frames:l,meta:{displayName:e.displayName,tags:e.tags}}}function g(e,t){return e[t]|e[t+1]<<8}function b(e,t,r=!1){if(!e.assets[t]){if(!r)return;e.assets[t]=new i(t)}return e.assets[t]}v.TilemapProject=r,v.emitGalleryDeclarations=function(i,n){var e=Object.keys(i);let s="";var r={};let a={};var o,l,c={},u=e=>{let t=i[e].namespace||i["*"].namespace;e=i[e].id||e;return t&&(t.endsWith(".")&&(t=t.slice(0,t.length-1)),!e.startsWith(t+"."))?t+"."+e:e};i["*"]&&(c["*"]=Object.assign(Object.assign({},i["*"]),{namespace:n}));for(o of e)if("*"!==o){var d=i[o],h=u(o);let t=ts.pxtc.escapeIdentifier(d.displayName||h.split(".").pop());if(r[t]){var p=t;let e=2;for(;r[t];)t=p+e,e++}r[t]=!0,a[h]=n+"."+t}for(l of e)if("*"!==l){var f=i[l],m=f.mimeType||(null==(m=i["*"])?void 0:m.mimeType);let e,t;var g,b=a[u(l)].split(".").pop();let r=f.tags;r||(r=[],-1!==b.toLowerCase().indexOf("background")&&r.push("background"),-1!==b.toLowerCase().indexOf("dialog")&&r.push("dialog"),f.tilemapTile&&r.push("tile")),m===v.IMAGE_MIME_TYPE?(t="image.ofBuffer(hex``)",e=f.tilemapTile?"images._tile":"images._image"):m===v.ANIMATION_MIME_TYPE?(g=w(f),t=`[${g.frames.map(e=>v.sprite.bitmapToImageLiteral(v.sprite.Bitmap.fromData(e),"typescript")).join(",")}]`):m===v.TILEMAP_MIME_TYPE?(g=y(f),t=v.sprite.encodeTilemap(g,"typescript",a)):m===v.SONG_MIME_TYPE?t=`hex\`${f.data}\``:m===v.JSON_MIME_TYPE&&(t=f.data),s+=`    //% fixedInstance jres whenUsed
`,e&&(s+=`    //% blockIdentity=${e}
`),r.length&&(s+=`    //% tags="${r.join(" ")}"
`),s+=`    export const ${b} = ${t};
`,"string"==typeof f?c[b]=f:(c[b]=Object.assign(Object.assign({},f),{id:a[u(l)],tags:r}),f.namespace&&(c[b].namespace=n,f.namespace.endsWith("."))&&(c[b].namespace+="."),c[b].tileset&&(c[b].tileset=f.tileset.map(e=>a[e]||e)))}return e=lf("Auto-generated code. Do not edit."),[c,`// ${e}
namespace ${n} {
${s}
}
// ${e}
`]},v.emitTilemapsFromJRes=function(e){let t="";var r,i=[],n=[];for(r of Object.keys(e))if("*"!==r){var s,a=e[r];if(a.tilemapTile){let e=r;-1!==e.indexOf(".")&&(e=e.split(".").slice(-1)[0]),t=(t+=`    //% fixedInstance jres blockIdentity=images._tile
`)+`    export const ${e} = image.ofBuffer(hex\`\`);
`,n.push({keys:[a.displayName,m("tile",r,!0)],expression:r})}a.mimeType===v.TILEMAP_MIME_TYPE&&(s=y(a),i.push({keys:[a.displayName,m("tilemap",a.id)],expression:v.sprite.encodeTilemap(s,"typescript")}))}i.length&&(t+=u("tilemap",i)),n.length&&(t+=u("tile",n));var o=lf("Auto-generated code. Do not edit.");return`// ${o}
namespace ${v.sprite.TILE_NAMESPACE} {
${t}
}
// ${o}
`},v.emitProjectImages=function(e){var t,r="",i=[],n=[],s=[],a=[];for(t of Object.keys(e))if("*"!==t){var o=e[t];if("string"==typeof o||o.mimeType===v.IMAGE_MIME_TYPE){let e;var l=[m("image",t,!0)];"string"==typeof o?e=v.sprite.bitmapToImageLiteral(v.sprite.getBitmapFromJResURL(o),"typescript"):(e=v.sprite.bitmapToImageLiteral(v.sprite.getBitmapFromJResURL(o.data),"typescript"),l.push(o.displayName)),i.push({keys:l,expression:e})}else o.mimeType===v.ANIMATION_MIME_TYPE?(l=w(o),n.push({keys:[o.displayName,m("animation",t,!0)],expression:`[${l.frames.map(e=>v.sprite.bitmapToImageLiteral(v.sprite.Bitmap.fromData(e),"typescript")).join(", ")}]`})):o.mimeType===v.SONG_MIME_TYPE?s.push({keys:[m("song",t,!0),o.displayName],expression:`hex\`${o.data}\``}):o.mimeType===v.JSON_MIME_TYPE&&a.push({keys:[m("json",t,!0),o.displayName],expression:o.data})}var c=lf("Auto-generated code. Do not edit."),r=(r=(r=(r+=u("image",i))+u("animation",n))+u("song",s))+u("json",a);return`// ${c}
namespace ${v.sprite.IMAGES_NAMESPACE} {
${r}
}
// ${c}
`},v.cloneAsset=a,v.assetEquals=l,v.validateAssetName=function(e){return!!e&&!/[\u0000-\u001f\u0021-\u002c\u002e\u002f\u003a-\u0040\u005b-\u005e\u0060\u007b-\u007f]/.test(e)},v.getTSReferenceForAsset=function(e,t=!1){let r,i;if(!(i=null!=(r=e.meta)&&r.displayName?e.meta.displayName:h(e)))return"image"===e.type||"tile"===e.type?e.id:void 0;var n=t?'("""':"`",s=t?'""")':"`";switch(e.type){case"tile":return"assets.tile"+n+i+s;case"image":return"assets.image"+n+i+s;case"animation":return"assets.animation"+n+i+s;case"tilemap":return"tilemap"+n+i+s;case"song":return"assets.song"+n+i+s;case"json":return"assets.json"+n+i+s}},v.parseAssetTSReference=d,v.lookupProjectAssetByTSReference=function(e,t){if(e=d(e)){var{type:e,name:r}=e;switch(e){case"tile":return t.lookupAssetByName("tile",r);case"image":return t.lookupAssetByName("image",r);case"tilemap":return t.lookupAssetByName("tilemap",r)||t.lookupAsset("tilemap",r);case"animation":return t.lookupAssetByName("animation",r);case"song":return t.lookupAssetByName("song",r);case"json":return t.lookupAssetByName("json",r)}}},v.getDefaultAssetDisplayName=function(e){switch(e){case"image":return lf("myImage");case"tile":return lf("myTile");case"tilemap":return lf("level");case"animation":return lf("myAnim");case"song":return lf("mySong");case"json":return lf("myFile");default:return lf("asset")}},v.getShortIDForAsset=h,v.validateAsset=p,v.patchTemporaryAsset=function(e,t,r){var i;return e&&!l(e,t)&&(t=a(t,!0),e=-1===e.internalID,i=-1===t.internalID,e&&!i)&&(t.id=r.generateNewID(t.type),t.internalID=r.getNewInternalId()),t}})(pxt=pxt||{}),(n=>{{var e=n.toolbox||(n.toolbox={});let r={},i=(e.blockColors={loops:"#107c10",logic:"#006970",math:"#712672",variables:"#A80000",functions:"#005a9e",text:"#996600",arrays:"#A94400",advanced:"#3c3c3c",addpackage:"#717171",search:"#000",debug:"#e03030",default:"#dddddd",topblocks:"#aa8f00",recipes:"#717171"},e.blockIcons={loops:"",logic:"",math:"",variables:"",functions:"",text:"",arrays:"",advancedcollapsed:"",advancedexpanded:"",more:"",addpackage:"",search:"",debug:"",default:"",topblocks:"",recipes:""},"");function s(e){e=((e,t,r)=>{let i=0,n=0,s=0;if(0==t)i=r,n=r,s=r;else{var a=Math.floor(e/60),e=e/60-a,o=r*(1-t),l=r*(1-t*e),c=r*(1-t*(1-e));switch(a){case 1:i=l,n=r,s=o;break;case 2:i=o,n=r,s=c;break;case 3:i=o,n=l,s=r;break;case 4:i=c,n=o,s=r;break;case 5:i=r,n=o,s=l;break;case 6:case 0:i=r,n=c,s=o}}return[Math.floor(i),Math.floor(n),Math.floor(s)]})(e,.45,165.75);return"#"+t(e[0])+t(e[1])+t(e[2])}function t(e){e=e.toString(16);return 1==e.length?"0"+e:e}function a(e){var t;return null!=(t=null==(t=n.appTarget)?void 0:t.appTheme)&&t.adjustBlockContrast?(r[e]||(r[e]=n.getWhiteContrastingBackground(e)),r[e]):e}e.appendToolboxIconCss=function(e,t){var r;-1<i.indexOf(e)||(1===t.length?(r=n.Util.unicodeToChar(t),i+=`
                .blocklyTreeIcon.${e}::before {
                    content: "${r}";
                }
            `):i+=`
                .blocklyTreeIcon.${e} {
                    background-image: url("${n.Util.pathJoin(n.webConfig.commitCdnUrl,encodeURI(t))}")!important;
                    width: 30px;
                    height: 100%;
                    background-size: 20px !important;
                    background-repeat: no-repeat !important;
                    background-position: 50% 50% !important;
                }
            `)},e.getNamespaceColor=function(e){e=e.toLowerCase();let t;return n.appTarget.appTheme.blockColors&&n.appTarget.appTheme.blockColors[e]?t=n.appTarget.appTheme.blockColors[e]:n.toolbox.blockColors[e]&&(t=n.toolbox.blockColors[e]),t?a(t):""},e.getNamespaceIcon=function(e){return e=e.toLowerCase(),n.appTarget.appTheme.blockIcons&&n.appTarget.appTheme.blockIcons[e]?n.appTarget.appTheme.blockIcons[e]:n.toolbox.blockIcons[e]||""},e.advancedTitle=function(){return n.Util.lf("{id:category}Advanced")},e.addPackageTitle=function(){return n.Util.lf("{id:category}Extensions")},e.recipesTitle=function(){return n.Util.lf("{id:category}Tutorials")},e.convertColor=function(e){e=(t=e)?"0x"==t.substring(0,2)?"#"+t.substring(2):t:"#000000";var t=parseInt(e);return isNaN(t)?e:s(t)},e.hueToRgb=s,e.fadeColor=function(t,r,i){(t=t.replace(/[^0-9a-f]/gi,"")).length<6&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);let n="#";for(let e=0;e<3;e++){var s=parseInt(t.substr(2*e,2),16),s=(s=Math.round(Math.min(Math.max(0,i?s+s*r:s-s*r),255))).toString(16);n+=("00"+s).substr(s.length)}return n},e.getAccessibleBackground=a}})(pxt=pxt||{}),(y=>{{var e=y.tutorial||(y.tutorial={});let b=/^##[^#](.*)$([\s\S]*?)(?=^##[^#]|$(?![\r\n]))/gim,v=/^###[^#](.*)$([\s\S]*?)(?=^###[^#]|$(?![\r\n]))/gim;function w(){return/``` *(sim|block|blocks|filterblocks|spy|ghost|typescript|ts|js|javascript|template|python|jres|assetjson|customts|simtheme|python-template|ts-template|typescript-template|js-template|javascript-template)\s*\n([\s\S]*?)\n```/gim}function A(e,t,o){t=t||b;let l=[];if(e.replace(t,function(e,t,r){var{header:i,hint:n}=((e,t)=>{let r=e=x(e),i;return t?(t=/#+ ~ tutorialhint([\s\S]*)/i,r=e.replace(t,function(e,t){return i=t,""})):(t=e.match(/(^[\s\S]*?\S)\s*((```|\[?\!\[[\s\S]+?\]\(\S+?\)\]?)[\s\S]*)/im))&&2<t.length&&(r=t[1].trim(),i=t[2].trim()),{header:r,hint:i}})(r=r.trim(),o&&o.explicitHints),s=k("local",r),a=E("local",r),r={title:t.match(/^\{.*\}$/)?void 0:t.replace(/@(fullscreen|unplugged|showdialog|showhint|tutorialCompleted|resetDiff)/gi,"").trim(),contentMd:r,headerContentMd:i,localBlockConfig:s,localValidationConfig:a};return/@(fullscreen|unplugged|showdialog|showhint)/i.test(t)&&(r.showHint=!0),/@(unplugged|showdialog)/i.test(t)&&(r.showDialog=!0),/@tutorialCompleted/.test(t)&&(r.tutorialCompleted=!0),/@resetDiff/.test(t)&&(r.resetDiff=!0),n&&(r.hintContentMd=n),l.push(r),""}),0!=e.indexOf("# Not found"))return l;y.debug("tutorial not found")}function k(e,t){let r={md:"",blocks:[]};e=new RegExp(`\`\`\`\\s*blockconfig\\.${e}\\s*\\n([\\s\\S]*?)\\n\`\`\``,"gmi");return t.replace(e,(e,t)=>(r.md+=t+`
`,"")),r}function E(e,t){let r;e=new RegExp(`\`\`\`\\s*validation\\.${e}\\s*\\n([\\s\\S]*?)\\n\`\`\``,"gmi");return t.replace(e,(e,t)=>(r=t,"")),r&&""!=r?{validatorsMetadata:y.getSectionsFromMarkdownMetadata(r).map(e=>({validatorType:e.header,properties:e.attributes}))}:null}function x(e){return e&&e.replace(/```(filterblocks|package|ghost|config|template|jres|assetjson|simtheme|customts|blockconfig\.local|blockconfig\.global|validation\.local|validation\.global)\s*\n([\s\S]*?)\n```/gim,"").trim()}function T(e){if(e)return e=JSON.parse(e),{[y.TILEMAP_JRES]:e[y.TILEMAP_JRES],[y.TILEMAP_CODE]:e[y.TILEMAP_CODE],[y.IMAGES_JRES]:e[y.IMAGES_JRES],[y.IMAGES_CODE]:e[y.IMAGES_CODE]}}function S(e){var t,e=y.Util.jsonTryParse(e);if(e)return t={},e.theme&&(t.theme=e.theme),e.palette&&(t.palette=e.palette),t}e.parseTutorial=function(e){var{metadata:t,body:r}=(e=>{let i={},t=e.replace(/### @(\S+) ([ \S]+)/gi,function(e,t,r){try{i[t]=JSON.parse(r)}catch(e){i[t]=r}return""}),r=i;return void 0!==r.explicitHints&&y.appTarget.appTheme&&y.appTarget.appTheme.tutorialExplicitHints&&(r.explicitHints=!0),{metadata:r,body:t}})(e),{steps:i,activities:n}=((t,r)=>{if(r&&r.activities){var o=r;let s=[],a=[];return t.replace(b,function(e,t,r){let i=a.length,n=(a.push({name:t||lf("Activity {0}",i),step:s.length}),A(r,v,o));return n=n.map(e=>(e.activity=i,e)),s=s.concat(n),""}),{steps:s,activities:a}}{let e=A(t,null,r);return{steps:e=!e||e.length<1?A(t,v,r):e,activities:null}}})(r,t),s=(e=>(e=e.match(/^#[^#](.*)$/im))&&1<e.length?e[1].trim():null)(r);if(i){var{code:r,templateCode:a,templateLanguage:o,editor:l,language:c,jres:u,assetJson:d,customTs:h,simThemeJson:p}=(e=>{let t=void 0,r=w(),i,n=[],s,a,o,l=0,c,u,d;return e.replace(/((?!.)\s)+/g,"\n").replace(r,function(e,t,r){switch(t){case"block":case"blocks":case"blockconfig.local":case"blockconfig.global":case"filterblocks":if(h(y.BLOCKS_PROJECT_NAME))break;return;case"spy":case"python":if(!h(y.PYTHON_PROJECT_NAME))return;"python"==t&&(o=t);break;case"typescript":case"ts":case"javascript":case"js":if(h(y.JAVASCRIPT_PROJECT_NAME))break;return;case"template":s=r;break;case"python-template":if(!h(y.PYTHON_PROJECT_NAME))return;s=r,a="python",o="python";break;case"ts-template":case"typescript-template":case"js-template":case"javascript-template":if(!h(y.JAVASCRIPT_PROJECT_NAME))return;s=r,a="typescript";break;case"jres":i=r;break;case"assetjson":c=r;break;case"simtheme":d=r;break;case"customts":u=r,r=""}return n.push("python"===o?`
${r}
`:`{
${r}
}`),l++,""}),t=t||y.BLOCKS_PROJECT_NAME,{code:n,templateCode:s,templateLanguage:a,editor:t,language:o,jres:i,assetJson:c,customTs:u,simThemeJson:d};function h(e){if(!t||t==e)return t=e,1;y.debug("tutorial ambiguous: contains snippets of different types")}})(r);if(y.BrowserUtils.useOldTutorialLayout()&&"python"===c&&t.flyoutOnly&&(t.flyoutOnly=!1,t.hideToolbox=!0),!0===t.diffs||!1!==t.diffs&&!0!==t.noDiffs&&(l==y.BLOCKS_PROJECT_NAME&&y.appTarget.appTheme.tutorialBlocksDiff||l!=y.BLOCKS_PROJECT_NAME&&y.appTarget.appTheme.tutorialTextDiff)){var f=i;var m=n;let l=void 0;function g(e){let a={typescript:"diff",spy:"diffspy",blocks:"diffblocks",python:"diff"},o=/\s*(\/\/|#)\s*@highlight/gm;return e&&e.replace(/```(typescript|spy|python|blocks|ghost|template)((?:.|[\r\n])+)```/,function(e,t,r){var i=l,n=/^(template|ghost)$/.test(t),s=o.test(r);return r=r.replace(/^\n+/,"").replace(/\n+$/,""),s&&(r=r.replace(o,"")),l=r,!i||s||n?e:`\`\`\`${a[t]}
${i}
----------
${r}
\`\`\``})}f.forEach((e,t)=>{if((e.resetDiff||m&&m.find(e=>e.step==t))&&(l=void 0),e.hintContentMd){var r=g(e.hintContentMd);if(r&&r!=e.hintContentMd)return void(e.hintContentMd=r)}e.headerContentMd&&(r=g(e.headerContentMd))&&r!=e.headerContentMd&&(e.headerContentMd=r)})}f=T(d),d=S(p),p=k("global",e),e=E("global",e);return i.forEach(e=>{e.contentMd=x(e.contentMd),e.headerContentMd=x(e.headerContentMd),e.hintContentMd=x(e.hintContentMd)}),{editor:l,title:s,steps:i,activities:n,code:r,templateCode:a,templateLanguage:o,metadata:t,language:c,jres:u,assetFiles:f,customTs:h,globalBlockConfig:p,globalValidationConfig:e,simTheme:d}}},e.getMetadataRegex=w,e.highlight=function(r){let e=r.textContent;if(e=(e=e.replace(/img\s*\(\s*"{3}[\s\da-f.#tngrpoyw]*"{3}\s*\)/g,'img(""" """)')).replace(/img\s*`[\s\da-f.#tngrpoyw]*`\s*/g,"img` `"),/@highlight/.test(e)){r.textContent="";var i,n=e.split("\n");for(let t=0;t<n.length;++t){0<t&&t<n.length&&r.appendChild(document.createTextNode("\n"));let e=n[t];/@highlight/.test(e)?void 0!==(e=n[++t])&&((i=document.createElement("span")).className="highlight-line",i.textContent=e,r.appendChild(i)):r.appendChild(document.createTextNode(e))}}else r.textContent=e},e.getTutorialOptions=function(e,t,r,i,n){var s=y.tutorial.parseTutorial(e);if(s)return{options:{tutorial:t,tutorialName:s.title||r,tutorialReportId:i,tutorialStep:0,tutorialReady:!0,tutorialHintCounter:0,tutorialStepInfo:s.steps,tutorialActivityInfo:s.activities,tutorialMd:e,tutorialCode:s.code,tutorialRecipe:!!n,templateCode:s.templateCode,templateLanguage:s.templateLanguage,autoexpandStep:null==(t=s.metadata)||!t.autoexpandOff,metadata:s.metadata,language:s.language,jres:s.jres,assetFiles:s.assetFiles,customTs:s.customTs,globalBlockConfig:s.globalBlockConfig,globalValidationConfig:s.globalValidationConfig,simTheme:s.simTheme},editor:s.editor};throw new Error(lf("Invalid tutorial format"))},e.parseCachedTutorialInfo=function(e,n){let s=y.Util.jsonTryParse(e);return s?y.BrowserUtils.tutorialInfoDbAsync().then(e=>{if(n&&s[n]){var t=s[n];t.usedBlocks&&t.hash&&e.setWithHashAsync(n,t.snippetBlocks,t.hash,t.highlightBlocks,t.validateBlocks)}else for(var r of Object.keys(s)){var i=s[r];i.usedBlocks&&i.hash&&e.setWithHashAsync(r,i.snippetBlocks,i.hash,i.highlightBlocks,i.validateBlocks)}}).catch(e=>{}):Promise.resolve()},e.resolveLocalizedMarkdown=function(e,t,r){let i=r||e.fileName||"README",n=(i.endsWith(".md")||(i+=".md"),void 0);var[r,e,s]=y.Util.normalizeLanguageCode(y.Util.userLanguage());return n=(n=r&&e&&s?t[`_locales/${r}/`+i]||t[`_locales/${s}/`+i]||t[`_locales/${e}/`+i]:t[`_locales/${r}/`+i])||t[i]},e.parseAssetJson=T,e.parseSimThemeJson=S,e.getTutorialHighlightedBlocks=async function(e){return null==(e=await(await y.BrowserUtils.tutorialInfoDbAsync()).getAsync(e.tutorial,e.tutorialCode))?void 0:e.highlightBlocks},e.getTutorialValidateBlocks=async function(e){return null==(e=await(await y.BrowserUtils.tutorialInfoDbAsync()).getAsync(e.tutorial,e.tutorialCode))?void 0:e.validateBlocks},e.getRequiredBlockCounts=function(e){if(e){let t={};e=e["validate-exists"];return e&&e.forEach(e=>{t[e]=(t[e]||0)+1}),t}},e.getTutorialStepHash=function(e){var{tutorialStepInfo:e,tutorialStep:t}=e,e=(e=>{let i=[];return null==e||e.replace(/((?!.)\s)+/g,"\n").replace(/``` *(block|blocks)\s*\n([\s\S]*?)\n```/gim,function(e,t,r){return i.push(`{
${r}
}`),""}),i})(e[t].hintContentMd);return y.BrowserUtils.getTutorialCodeHash(e)},e.shouldFilterProject=function(e){return!(!e||!e.hideFromProjects&&!e.hideIteration)}}})(pxt=pxt||{}),(o=>{var e;{var l=o.pxtc||(o.pxtc={});l.flattenDiagnosticMessageText=function(i,n){if("string"==typeof i)return i;{let e=i,t="",r=0;for(;e;){if(r){t+=n;for(let e=0;e<r;e++)t+="  "}t+=e.messageText,r++,e=e.next}return t}};let r,i=((e=r=l.ScriptTarget||(l.ScriptTarget={}))[e.ES3=0]="ES3",e[e.ES5=1]="ES5",e[e.ES6=2]="ES6",e[e.ES2015=2]="ES2015",e[e.Latest=2]="Latest",l.isIdentifierStart=function(e,t){return 65<=e&&e<=90||97<=e&&e<=122||36===e||95===e||127<e&&c(e,t)},l.isIdentifierPart=function(e,t){return 65<=e&&e<=90||97<=e&&e<=122||48<=e&&e<=57||36===e||95===e||127<e&&(e=e,t>=r.ES5?u(e,n):u(e,a))},l.reservedWords=["abstract","any","as","break","case","catch","class","continue","const","constructor","debugger","declare","default","delete","do","else","enum","export","extends","false","finally","for","from","function","get","if","implements","import","in","instanceof","interface","is","let","module","namespace","new","null","package","private","protected","public","require","global","return","set","static","super","switch","symbol","this","throw","true","try","type","typeof","var","void","while","with","yield","async","await","of","Math"],l.keywordTypes=["boolean","number","string"],l.escapeIdentifier=function(e){if(!e)return"_";let t=e.replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_$]/g,e=>o.pxtc.isIdentifierPart(e.charCodeAt(0),o.pxtc.ScriptTarget.ES5)?e:"");return t=t&&o.pxtc.isIdentifierStart(t.charCodeAt(0),o.pxtc.ScriptTarget.ES5)&&-1===l.reservedWords.indexOf(t)?t:"_"+t},[170,170,181,181,186,186,192,214,216,246,248,705,710,721,736,740,748,748,750,750,880,884,886,887,890,893,902,902,904,906,908,908,910,929,931,1013,1015,1153,1162,1319,1329,1366,1369,1369,1377,1415,1488,1514,1520,1522,1568,1610,1646,1647,1649,1747,1749,1749,1765,1766,1774,1775,1786,1788,1791,1791,1808,1808,1810,1839,1869,1957,1969,1969,1994,2026,2036,2037,2042,2042,2048,2069,2074,2074,2084,2084,2088,2088,2112,2136,2208,2208,2210,2220,2308,2361,2365,2365,2384,2384,2392,2401,2417,2423,2425,2431,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2493,2493,2510,2510,2524,2525,2527,2529,2544,2545,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2649,2652,2654,2654,2674,2676,2693,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2749,2749,2768,2768,2784,2785,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2869,2873,2877,2877,2908,2909,2911,2913,2929,2929,2947,2947,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,3001,3024,3024,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3133,3133,3160,3161,3168,3169,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3261,3261,3294,3294,3296,3297,3313,3314,3333,3340,3342,3344,3346,3386,3389,3389,3406,3406,3424,3425,3450,3455,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3585,3632,3634,3635,3648,3654,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3760,3762,3763,3773,3773,3776,3780,3782,3782,3804,3807,3840,3840,3904,3911,3913,3948,3976,3980,4096,4138,4159,4159,4176,4181,4186,4189,4193,4193,4197,4198,4206,4208,4213,4225,4238,4238,4256,4293,4295,4295,4301,4301,4304,4346,4348,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4744,4746,4749,4752,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4822,4824,4880,4882,4885,4888,4954,4992,5007,5024,5108,5121,5740,5743,5759,5761,5786,5792,5866,5870,5872,5888,5900,5902,5905,5920,5937,5952,5969,5984,5996,5998,6e3,6016,6067,6103,6103,6108,6108,6176,6263,6272,6312,6314,6314,6320,6389,6400,6428,6480,6509,6512,6516,6528,6571,6593,6599,6656,6678,6688,6740,6823,6823,6917,6963,6981,6987,7043,7072,7086,7087,7098,7141,7168,7203,7245,7247,7258,7293,7401,7404,7406,7409,7413,7414,7424,7615,7680,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8305,8305,8319,8319,8336,8348,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8505,8508,8511,8517,8521,8526,8526,8544,8584,11264,11310,11312,11358,11360,11492,11499,11502,11506,11507,11520,11557,11559,11559,11565,11565,11568,11623,11631,11631,11648,11670,11680,11686,11688,11694,11696,11702,11704,11710,11712,11718,11720,11726,11728,11734,11736,11742,11823,11823,12293,12295,12321,12329,12337,12341,12344,12348,12353,12438,12445,12447,12449,12538,12540,12543,12549,12589,12593,12686,12704,12730,12784,12799,13312,19893,19968,40908,40960,42124,42192,42237,42240,42508,42512,42527,42538,42539,42560,42606,42623,42647,42656,42735,42775,42783,42786,42888,42891,42894,42896,42899,42912,42922,43e3,43009,43011,43013,43015,43018,43020,43042,43072,43123,43138,43187,43250,43255,43259,43259,43274,43301,43312,43334,43360,43388,43396,43442,43471,43471,43520,43560,43584,43586,43588,43595,43616,43638,43642,43642,43648,43695,43697,43697,43701,43702,43705,43709,43712,43712,43714,43714,43739,43741,43744,43754,43762,43764,43777,43782,43785,43790,43793,43798,43808,43814,43816,43822,43968,44002,44032,55203,55216,55238,55243,55291,63744,64109,64112,64217,64256,64262,64275,64279,64285,64285,64287,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65136,65140,65142,65276,65313,65338,65345,65370,65382,65470,65474,65479,65482,65487,65490,65495,65498,65500]),n=[170,170,181,181,186,186,192,214,216,246,248,705,710,721,736,740,748,748,750,750,768,884,886,887,890,893,902,902,904,906,908,908,910,929,931,1013,1015,1153,1155,1159,1162,1319,1329,1366,1369,1369,1377,1415,1425,1469,1471,1471,1473,1474,1476,1477,1479,1479,1488,1514,1520,1522,1552,1562,1568,1641,1646,1747,1749,1756,1759,1768,1770,1788,1791,1791,1808,1866,1869,1969,1984,2037,2042,2042,2048,2093,2112,2139,2208,2208,2210,2220,2276,2302,2304,2403,2406,2415,2417,2423,2425,2431,2433,2435,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2492,2500,2503,2504,2507,2510,2519,2519,2524,2525,2527,2531,2534,2545,2561,2563,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2620,2620,2622,2626,2631,2632,2635,2637,2641,2641,2649,2652,2654,2654,2662,2677,2689,2691,2693,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2748,2757,2759,2761,2763,2765,2768,2768,2784,2787,2790,2799,2817,2819,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2869,2873,2876,2884,2887,2888,2891,2893,2902,2903,2908,2909,2911,2915,2918,2927,2929,2929,2946,2947,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,3001,3006,3010,3014,3016,3018,3021,3024,3024,3031,3031,3046,3055,3073,3075,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3133,3140,3142,3144,3146,3149,3157,3158,3160,3161,3168,3171,3174,3183,3202,3203,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3260,3268,3270,3272,3274,3277,3285,3286,3294,3294,3296,3299,3302,3311,3313,3314,3330,3331,3333,3340,3342,3344,3346,3386,3389,3396,3398,3400,3402,3406,3415,3415,3424,3427,3430,3439,3450,3455,3458,3459,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3530,3530,3535,3540,3542,3542,3544,3551,3570,3571,3585,3642,3648,3662,3664,3673,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3769,3771,3773,3776,3780,3782,3782,3784,3789,3792,3801,3804,3807,3840,3840,3864,3865,3872,3881,3893,3893,3895,3895,3897,3897,3902,3911,3913,3948,3953,3972,3974,3991,3993,4028,4038,4038,4096,4169,4176,4253,4256,4293,4295,4295,4301,4301,4304,4346,4348,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4744,4746,4749,4752,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4822,4824,4880,4882,4885,4888,4954,4957,4959,4992,5007,5024,5108,5121,5740,5743,5759,5761,5786,5792,5866,5870,5872,5888,5900,5902,5908,5920,5940,5952,5971,5984,5996,5998,6e3,6002,6003,6016,6099,6103,6103,6108,6109,6112,6121,6155,6157,6160,6169,6176,6263,6272,6314,6320,6389,6400,6428,6432,6443,6448,6459,6470,6509,6512,6516,6528,6571,6576,6601,6608,6617,6656,6683,6688,6750,6752,6780,6783,6793,6800,6809,6823,6823,6912,6987,6992,7001,7019,7027,7040,7155,7168,7223,7232,7241,7245,7293,7376,7378,7380,7414,7424,7654,7676,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8204,8205,8255,8256,8276,8276,8305,8305,8319,8319,8336,8348,8400,8412,8417,8417,8421,8432,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8505,8508,8511,8517,8521,8526,8526,8544,8584,11264,11310,11312,11358,11360,11492,11499,11507,11520,11557,11559,11559,11565,11565,11568,11623,11631,11631,11647,11670,11680,11686,11688,11694,11696,11702,11704,11710,11712,11718,11720,11726,11728,11734,11736,11742,11744,11775,11823,11823,12293,12295,12321,12335,12337,12341,12344,12348,12353,12438,12441,12442,12445,12447,12449,12538,12540,12543,12549,12589,12593,12686,12704,12730,12784,12799,13312,19893,19968,40908,40960,42124,42192,42237,42240,42508,42512,42539,42560,42607,42612,42621,42623,42647,42655,42737,42775,42783,42786,42888,42891,42894,42896,42899,42912,42922,43e3,43047,43072,43123,43136,43204,43216,43225,43232,43255,43259,43259,43264,43309,43312,43347,43360,43388,43392,43456,43471,43481,43520,43574,43584,43597,43600,43609,43616,43638,43642,43643,43648,43714,43739,43741,43744,43759,43762,43766,43777,43782,43785,43790,43793,43798,43808,43814,43816,43822,43968,44010,44012,44013,44016,44025,44032,55203,55216,55238,55243,55291,63744,64109,64112,64217,64256,64262,64275,64279,64285,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65024,65039,65056,65062,65075,65076,65101,65103,65136,65140,65142,65276,65296,65305,65313,65338,65343,65343,65345,65370,65382,65470,65474,65479,65482,65487,65490,65495,65498,65500],s=[170,170,181,181,186,186,192,214,216,246,248,543,546,563,592,685,688,696,699,705,720,721,736,740,750,750,890,890,902,902,904,906,908,908,910,929,931,974,976,983,986,1011,1024,1153,1164,1220,1223,1224,1227,1228,1232,1269,1272,1273,1329,1366,1369,1369,1377,1415,1488,1514,1520,1522,1569,1594,1600,1610,1649,1747,1749,1749,1765,1766,1786,1788,1808,1808,1810,1836,1920,1957,2309,2361,2365,2365,2384,2384,2392,2401,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2524,2525,2527,2529,2544,2545,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2649,2652,2654,2654,2674,2676,2693,2699,2701,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2749,2749,2768,2768,2784,2784,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2870,2873,2877,2877,2908,2909,2911,2913,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,2997,2999,3001,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3168,3169,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3294,3294,3296,3297,3333,3340,3342,3344,3346,3368,3370,3385,3424,3425,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3585,3632,3634,3635,3648,3654,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3760,3762,3763,3773,3773,3776,3780,3782,3782,3804,3805,3840,3840,3904,3911,3913,3946,3976,3979,4096,4129,4131,4135,4137,4138,4176,4181,4256,4293,4304,4342,4352,4441,4447,4514,4520,4601,4608,4614,4616,4678,4680,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4742,4744,4744,4746,4749,4752,4782,4784,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4814,4816,4822,4824,4846,4848,4878,4880,4880,4882,4885,4888,4894,4896,4934,4936,4954,5024,5108,5121,5740,5743,5750,5761,5786,5792,5866,6016,6067,6176,6263,6272,6312,7680,7835,7840,7929,7936,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8319,8319,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8497,8499,8505,8544,8579,12293,12295,12321,12329,12337,12341,12344,12346,12353,12436,12445,12446,12449,12538,12540,12542,12549,12588,12593,12686,12704,12727,13312,19893,19968,40869,40960,42124,44032,55203,63744,64045,64256,64262,64275,64279,64285,64285,64287,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65136,65138,65140,65140,65142,65276,65313,65338,65345,65370,65382,65470,65474,65479,65482,65487,65490,65495,65498,65500],a=[170,170,181,181,186,186,192,214,216,246,248,543,546,563,592,685,688,696,699,705,720,721,736,740,750,750,768,846,864,866,890,890,902,902,904,906,908,908,910,929,931,974,976,983,986,1011,1024,1153,1155,1158,1164,1220,1223,1224,1227,1228,1232,1269,1272,1273,1329,1366,1369,1369,1377,1415,1425,1441,1443,1465,1467,1469,1471,1471,1473,1474,1476,1476,1488,1514,1520,1522,1569,1594,1600,1621,1632,1641,1648,1747,1749,1756,1759,1768,1770,1773,1776,1788,1808,1836,1840,1866,1920,1968,2305,2307,2309,2361,2364,2381,2384,2388,2392,2403,2406,2415,2433,2435,2437,2444,2447,2448,2451,2472,2474,2480,2482,2482,2486,2489,2492,2492,2494,2500,2503,2504,2507,2509,2519,2519,2524,2525,2527,2531,2534,2545,2562,2562,2565,2570,2575,2576,2579,2600,2602,2608,2610,2611,2613,2614,2616,2617,2620,2620,2622,2626,2631,2632,2635,2637,2649,2652,2654,2654,2662,2676,2689,2691,2693,2699,2701,2701,2703,2705,2707,2728,2730,2736,2738,2739,2741,2745,2748,2757,2759,2761,2763,2765,2768,2768,2784,2784,2790,2799,2817,2819,2821,2828,2831,2832,2835,2856,2858,2864,2866,2867,2870,2873,2876,2883,2887,2888,2891,2893,2902,2903,2908,2909,2911,2913,2918,2927,2946,2947,2949,2954,2958,2960,2962,2965,2969,2970,2972,2972,2974,2975,2979,2980,2984,2986,2990,2997,2999,3001,3006,3010,3014,3016,3018,3021,3031,3031,3047,3055,3073,3075,3077,3084,3086,3088,3090,3112,3114,3123,3125,3129,3134,3140,3142,3144,3146,3149,3157,3158,3168,3169,3174,3183,3202,3203,3205,3212,3214,3216,3218,3240,3242,3251,3253,3257,3262,3268,3270,3272,3274,3277,3285,3286,3294,3294,3296,3297,3302,3311,3330,3331,3333,3340,3342,3344,3346,3368,3370,3385,3390,3395,3398,3400,3402,3405,3415,3415,3424,3425,3430,3439,3458,3459,3461,3478,3482,3505,3507,3515,3517,3517,3520,3526,3530,3530,3535,3540,3542,3542,3544,3551,3570,3571,3585,3642,3648,3662,3664,3673,3713,3714,3716,3716,3719,3720,3722,3722,3725,3725,3732,3735,3737,3743,3745,3747,3749,3749,3751,3751,3754,3755,3757,3769,3771,3773,3776,3780,3782,3782,3784,3789,3792,3801,3804,3805,3840,3840,3864,3865,3872,3881,3893,3893,3895,3895,3897,3897,3902,3911,3913,3946,3953,3972,3974,3979,3984,3991,3993,4028,4038,4038,4096,4129,4131,4135,4137,4138,4140,4146,4150,4153,4160,4169,4176,4185,4256,4293,4304,4342,4352,4441,4447,4514,4520,4601,4608,4614,4616,4678,4680,4680,4682,4685,4688,4694,4696,4696,4698,4701,4704,4742,4744,4744,4746,4749,4752,4782,4784,4784,4786,4789,4792,4798,4800,4800,4802,4805,4808,4814,4816,4822,4824,4846,4848,4878,4880,4880,4882,4885,4888,4894,4896,4934,4936,4954,4969,4977,5024,5108,5121,5740,5743,5750,5761,5786,5792,5866,6016,6099,6112,6121,6160,6169,6176,6263,6272,6313,7680,7835,7840,7929,7936,7957,7960,7965,7968,8005,8008,8013,8016,8023,8025,8025,8027,8027,8029,8029,8031,8061,8064,8116,8118,8124,8126,8126,8130,8132,8134,8140,8144,8147,8150,8155,8160,8172,8178,8180,8182,8188,8255,8256,8319,8319,8400,8412,8417,8417,8450,8450,8455,8455,8458,8467,8469,8469,8473,8477,8484,8484,8486,8486,8488,8488,8490,8493,8495,8497,8499,8505,8544,8579,12293,12295,12321,12335,12337,12341,12344,12346,12353,12436,12441,12442,12445,12446,12449,12542,12549,12588,12593,12686,12704,12727,13312,19893,19968,40869,40960,42124,44032,55203,63744,64045,64256,64262,64275,64279,64285,64296,64298,64310,64312,64316,64318,64318,64320,64321,64323,64324,64326,64433,64467,64829,64848,64911,64914,64967,65008,65019,65056,65059,65075,65076,65101,65103,65136,65138,65140,65140,65142,65276,65296,65305,65313,65338,65343,65343,65345,65370,65381,65470,65474,65479,65482,65487,65490,65495,65498,65500];function c(e,t){return t>=r.ES5?u(e,i):u(e,s)}function u(r,i){if(!(r<i[0])){let e=0,t=i.length;for(var n;e+1<t;){if(n=e+(t-e)/2,i[n-=n%2]<=r&&r<=i[1+n])return!0;r<i[n]?t=n:e=2+n}}return!1}l.isUnicodeIdentifierStart=c,(e=l.DiagnosticCategory||(l.DiagnosticCategory={}))[e.Warning=0]="Warning",e[e.Error=1]="Error",e[e.Message=2]="Message"}})(ts=ts||{}),(a=>{var e;{var i=a.webBluetooth||(a.webBluetooth={});function t(){return!!navigator&&!!navigator.bluetooth&&"TextDecoder"in window&&a.appTarget.appTheme.bluetoothUartConsole&&a.appTarget.appTheme.bluetoothUartFilters&&0<a.appTarget.appTheme.bluetoothUartFilters.length}function r(){return!!navigator&&!!navigator.bluetooth&&!!a.appTarget.appTheme.bluetoothPartialFlashing}i.isAvailable=function(){return t()||r()},i.hasConsole=t,i.hasPartialFlash=r,i.isValidUUID=function(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/.test(e)};class o{constructor(e,t){this.connectionTimeout=2e4,this.connectPromise=void 0,this.id=e,this.aliveToken=t}debug(e){a.debug(this.id+": "+e)}alivePromise(e){return new Promise((t,r)=>{this.aliveToken.isCancelled()&&r(new Error),e.then(e=>t(e),e=>r(e))})}cancelConnect(){this.connectPromise=void 0}createConnectPromise(){return Promise.resolve()}connectAsync(){return this.connectPromise||(this.connectPromise=this.alivePromise(this.createConnectPromise())),a.Util.promiseTimeout(this.connectionTimeout,this.connectPromise,"connection timeout").then(()=>this.aliveToken.throwIfCancelled()).catch(e=>{throw this.connectPromise=void 0,e})}disconnect(){this.cancelConnect()}kill(){this.disconnect(),this.aliveToken.cancel()}}i.BLERemote=o;class l extends o{constructor(e,t,r){super(e,t.aliveToken),this.device=t,this.autoReconnect=r,this.autoReconnectDelay=1e3,this.disconnectOnAutoReconnect=!1,this.reconnectPromise=void 0,this.failedConnectionServicesVersion=-1,this.handleDisconnected=this.handleDisconnected.bind(this),this.device.device.addEventListener("gattserverdisconnected",this.handleDisconnected)}handleDisconnected(e){this.aliveToken.isCancelled()||(this.disconnect(),this.autoReconnect&&!this.reconnectPromise&&(this.reconnectPromise=a.U.delay(this.autoReconnectDelay).then(()=>this.exponentialBackoffConnectAsync(8,500)).finally(()=>this.reconnectPromise=void 0)))}exponentialBackoffConnectAsync(t,r){return this.debug("retry connect"),this.aliveToken.throwIfCancelled(),this.connectAsync().then(()=>{this.aliveToken.throwIfCancelled(),this.debug("reconnect success"),this.reconnectPromise=void 0}).catch(e=>{if(this.debug("reconnect error "+e.message),this.aliveToken.throwIfCancelled(),this.device.isPaired)if(this.autoReconnect)if(0==t)this.debug("give up, max tries");else{if(this.failedConnectionServicesVersion!=this.device.servicesVersion)return this.debug(`retry connect ${r}ms... (${t} tries left)`),this.device.connected&&(this.failedConnectionServicesVersion=this.device.servicesVersion),this.disconnectOnAutoReconnect&&this.device.disconnect(),a.U.delay(r).then(()=>this.exponentialBackoffConnectAsync(--t,1.8*r));this.debug("services haven't changed, giving up")}else this.debug("autoreconnect disabled");else this.debug("give up, device unpaired");this.reconnectPromise=void 0})}}i.BLEService=l;class c extends l{constructor(e,t,r,i){super(e,t,!0),this.device=t,this.serviceUUID=r,this.txCharacteristicUUID=i,this.handleValueChanged=this.handleValueChanged.bind(this)}createConnectPromise(){return this.debug("connecting"),this.device.connectAsync().then(()=>this.alivePromise(this.device.gatt.getPrimaryService(this.serviceUUID))).then(e=>(this.debug("service connected"),this.service=e,this.alivePromise(this.service.getCharacteristic(this.txCharacteristicUUID)))).then(e=>(this.debug("tx characteristic connected"),this.txCharacteristic=e,this.txCharacteristic.addEventListener("characteristicvaluechanged",this.handleValueChanged),this.txCharacteristic.startNotifications())).then(()=>{a.tickEvent("webble.connected",{id:this.id})})}handlePacket(e){}handleValueChanged(e){e=e.target.value;this.handlePacket(e)}disconnect(){if(super.disconnect(),this.txCharacteristic&&this.device&&this.device.connected)try{this.txCharacteristic.stopNotifications(),this.txCharacteristic.removeEventListener("characteristicvaluechanged",this.handleValueChanged)}catch(e){a.log(this.id+": error "+e.message)}this.service=void 0,this.txCharacteristic=void 0}}i.BLETXService=c;class u extends c{constructor(e){super("hf2",e,u.SERVICE_UUID,u.CHARACTERISTIC_TX_UUID),this.device=e}handlePacket(r){var e=r.getUint8(0);switch(192&e){case u.BLEHF2_FLAG_SERIAL_OUT:case u.BLEHF2_FLAG_SERIAL_ERR:var i=Math.min(r.byteLength-1,-193&e);let t="";for(let e=0;e<i;++e)t+=String.fromCharCode(r.getUint8(e+1));t&&window.postMessage({type:"serial",id:this.device.name||"hf2",data:t},"*")}}}u.SERVICE_UUID="b112f5e6-2679-30da-a26e-0273b6043849",u.CHARACTERISTIC_TX_UUID="b112f5e6-2679-30da-a26e-0273b604384a",u.BLEHF2_FLAG_SERIAL_OUT=128,u.BLEHF2_FLAG_SERIAL_ERR=192,i.HF2Service=u;class d extends c{constructor(e){super("uart",e,d.SERVICE_UUID,d.CHARACTERISTIC_TX_UUID),this.device=e}handlePacket(e){e=(new window.TextDecoder).decode(e);e&&window.postMessage({type:"serial",id:this.device.name||"uart",data:e},"*")}}d.SERVICE_UUID="6e400001-b5a3-f393-e0a9-e50e24dcca9e",d.CHARACTERISTIC_TX_UUID="6e400002-b5a3-f393-e0a9-e50e24dcca9e",i.UARTService=d;let s;(e=s=s||{})[e.Idle=1]="Idle",e[e.StatusRequested=2]="StatusRequested",e[e.PairingModeRequested=4]="PairingModeRequested",e[e.RegionDALRequested=8]="RegionDALRequested",e[e.RegionMakeCodeRequested=16]="RegionMakeCodeRequested",e[e.Flash=32]="Flash",e[e.EndOfTransmision=64]="EndOfTransmision",e[e.USBFlashRequired=128]="USBFlashRequired";class h extends l{constructor(e){super("partial flashing",e,!1),this.device=e,this.state=s.Idle,this.disconnectOnAutoReconnect=!0,this.handleCharacteristic=this.handleCharacteristic.bind(this)}clearFlashData(){this.version=0,this.mode=0,this.regions=[],this.chunkDelay=h.CHUNK_MIN_DELAY,this.hex=void 0,this.bin=void 0,this.magicOffset=void 0,this.dalHash=void 0,this.makeCodeHash=void 0,this.flashReject=void 0,this.flashResolve=void 0,this.flashOffset=void 0}createConnectPromise(){return this.debug("connecting to partial flash service"),this.device.connectAsync().then(()=>this.alivePromise(this.device.gatt.getPrimaryService(h.SERVICE_UUID))).then(e=>(this.debug("connecting to characteristic"),this.alivePromise(e.getCharacteristic(h.CHARACTERISTIC_UUID)))).then(e=>(this.debug("starting notifications"),this.pfCharacteristic=e,this.pfCharacteristic.startNotifications(),this.pfCharacteristic.addEventListener("characteristicvaluechanged",this.handleCharacteristic),this.state==s.PairingModeRequested?(this.debug("checking pairing mode"),this.autoReconnect=!1,this.pfCharacteristic.writeValue(new Uint8Array([h.STATUS]))):Promise.resolve()))}disconnect(){if(super.disconnect(),this.flashPacketToken&&this.flashPacketToken.cancel(),this.pfCharacteristic&&this.device.connected)try{this.pfCharacteristic.stopNotifications(),this.pfCharacteristic.removeEventListener("characteristicvaluechanged",this.handleCharacteristic)}catch(e){a.log("ble: partial flash disconnect error "+e.message)}this.pfCharacteristic=void 0}findMarker(r,i){if(this.bin)for(;r+i.length<this.bin.length;r+=16){let t=!0;for(let e=0;e<i.length;++e)if(i[e]!=this.bin[r+e]){t=!1;break}if(t)return r}return-1}flashAsync(e){return this.hex?(this.debug("flashing already in progress"),Promise.resolve()):(this.device.pauseLog(),this.createFlashPromise(e).finally(()=>this.device.resumeLogOnDisconnection()))}createFlashPromise(e){if(this.hex)return this.debug("flashing already in progress"),Promise.resolve();this.clearFlashData(),this.hex=e;var e=ts.pxtc.UF2.newBlockFile(),t=(ts.pxtc.UF2.writeHex(e,this.hex.split(/\r?\n/)),a.appTarget.compile.flashUsableEnd),e=(this.bin=ts.pxtc.UF2.toBin(a.U.stringToUint8Array(ts.pxtc.UF2.serializeFile(e)),t).buf,this.debug("bin bytes "+this.bin.length),this.magicOffset=this.findMarker(0,h.MAGIC_MARKER),this.debug("magic block "+this.magicOffset.toString(16)),this.magicOffset<0&&(this.debug("magic block not found, not a valid HEX file"),a.U.userError(lf("Invalid file"))),this.debug("bytes to flash "+(this.bin.length-this.magicOffset)),this.magicOffset+h.MAGIC_MARKER.length);return this.dalHash=a.Util.toHex(this.bin.slice(e,e+8)),this.makeCodeHash=a.Util.toHex(this.bin.slice(e+8,e+16)),this.debug("DAL hash "+this.dalHash),this.debug("MakeCode hash "+this.makeCodeHash),this.connectAsync().then(()=>new Promise((e,t)=>(this.flashResolve=e,this.flashReject=t,this.debug("check service version"),this.state=s.StatusRequested,this.pfCharacteristic.writeValue(new Uint8Array([h.STATUS]))))).then(()=>{},e=>{a.log("pf: error "+e.message),this.clearFlashData()})}checkStateTransition(e,t){return!!(this.state&t)||(this.debug(`flash cmd ${e} in state ${this.state.toString(16)} `),this.flashReject(new Error),this.clearFlashData(),!1)}handleCharacteristic(e){this.aliveToken.isCancelled()&&(this.flashReject(new Error),this.clearFlashData());var t=event.target.value,r=new Uint8Array(t.buffer),i=r[0];if(this.state!=s.Idle)switch(i){case h.STATUS:this.checkStateTransition(i,s.StatusRequested|s.PairingModeRequested)&&(this.version=r[1],this.mode=r[2],this.debug(`flash service version ${this.version} mode `+this.mode),this.debug("reading DAL region"),this.state=s.RegionDALRequested,this.pfCharacteristic.writeValue(new Uint8Array([h.REGION_INFO,h.REGION_DAL])).then(()=>{}));break;case h.REGION_INFO:if(this.checkStateTransition(i,s.RegionDALRequested|s.RegionMakeCodeRequested)){var n=this.regions[r[1]]={start:r[2]<<24|r[3]<<16|r[4]<<8|r[5],end:r[6]<<24|r[7]<<16|r[8]<<8|r[9],hash:a.Util.toHex(r.slice(10))};if(this.debug(`read region ${r[1]} start ${n.start.toString(16)} end ${n.end.toString(16)} hash `+n.hash),r[1]==h.REGION_DAL){if(n.hash!=this.dalHash)return a.tickEvent("webble.flash.DALrequired"),this.debug("DAL hash does not match, partial flashing not possible"),this.state=s.USBFlashRequired,this.flashReject(new Error("USB flashing required")),void this.clearFlashData();this.debug("DAL hash match, reading makecode region"),this.state=s.RegionMakeCodeRequested,this.pfCharacteristic.writeValue(new Uint8Array([h.REGION_INFO,h.REGION_MAKECODE])).then(()=>{})}else if(r[1]==h.REGION_MAKECODE)if(n.start!=this.magicOffset&&(this.debug("magic offset and MakeCode region.start not matching"),a.U.userError(lf("Invalid file"))),n.hash==this.makeCodeHash)a.tickEvent("webble.flash.noop"),this.debug("MakeCode hash matches, same code!"),this.debug("restart application mode"),this.pfCharacteristic.writeValue(new Uint8Array([h.RESET,h.MODE_APPLICATION])).then(()=>{this.state=s.Idle,this.flashResolve(),this.clearFlashData()});else{if(this.mode!=h.MODE_PAIRING)return this.debug("application mode, reset into pairing mode"),this.state=s.PairingModeRequested,this.autoReconnect=!0,void this.pfCharacteristic.writeValue(new Uint8Array([h.RESET,h.MODE_PAIRING])).then(()=>{});this.flashOffset=n.start,this.flashPacketNumber=0,this.debug("starting to flash from address "+this.flashOffset.toString(16)),this.flashNextPacket()}}break;case h.FLASH_DATA:if(this.checkStateTransition(i,s.Flash))switch(r[1]){case h.PACKET_OUT_OF_ORDER:this.debug("packet out of order"),this.flashPacketToken.cancel(),this.flashPacketNumber+=4,this.chunkDelay=Math.min(this.chunkDelay+10,h.CHUNK_MAX_DELAY),this.flashNextPacket();break;case h.PACKET_WRITTEN:this.chunkDelay=Math.max(this.chunkDelay-1,h.CHUNK_MIN_DELAY),this.flashOffset+=64,this.flashPacketNumber+=4,this.flashOffset>=this.bin.length?(this.debug("end transmission"),this.state=s.EndOfTransmision,this.pfCharacteristic.writeValue(new Uint8Array([h.END_OF_TRANSMISSION])).finally(()=>{this.flashResolve&&this.flashResolve(),this.clearFlashData()})):this.flashNextPacket()}break;default:this.debug("unknown message "+a.Util.toHex(r)),this.disconnect()}}flashNextPacket(){this.state=s.Flash,this.flashPacketToken=new a.Util.CancellationToken,this.flashPacketToken.startOperation();let t=this.bin.slice(this.flashOffset,this.flashOffset+64),r=(this.debug(`flashing ${this.flashOffset.toString(16)} / ${this.bin.length.toString(16)} ${(this.flashOffset-this.magicOffset)/(this.bin.length-this.magicOffset)*100>>0}%`),new Uint8Array(20));a.U.delay(this.chunkDelay).then(()=>{this.flashPacketToken.throwIfCancelled(),r[0]=h.FLASH_DATA,r[1]=this.flashOffset>>8&255,r[2]=this.flashOffset>>0&255,r[3]=this.flashPacketNumber;for(let e=0;e<16;e++)r[4+e]=t[e];return this.pfCharacteristic.writeValue(r)}).then(()=>a.U.delay(this.chunkDelay)).then(()=>{this.flashPacketToken.throwIfCancelled(),r[0]=h.FLASH_DATA,r[1]=this.flashOffset>>24&255,r[2]=this.flashOffset>>16&255,r[3]=this.flashPacketNumber+1;for(let e=0;e<16;e++)r[4+e]=t[16+e]||0;return this.pfCharacteristic.writeValue(r)}).then(()=>a.U.delay(this.chunkDelay)).then(()=>{this.flashPacketToken.throwIfCancelled(),r[0]=h.FLASH_DATA,r[1]=0,r[2]=0,r[3]=this.flashPacketNumber+2;for(let e=0;e<16;e++)r[4+e]=t[32+e]||0;return this.pfCharacteristic.writeValue(r)}).then(()=>a.U.delay(this.chunkDelay)).then(()=>{this.flashPacketToken.throwIfCancelled(),r[0]=h.FLASH_DATA,r[1]=0,r[2]=0,r[3]=this.flashPacketNumber+3;for(let e=0;e<16;e++)r[4+e]=t[48+e]||0;return this.pfCharacteristic.writeValue(r)}).then(()=>{let e=this.flashOffset,t=()=>a.U.delay(500).then(()=>{if(e!=this.flashOffset||this.flashPacketToken.isCancelled()||this.aliveToken.isCancelled()||this.state!=s.Flash)return Promise.resolve();this.debug("packet transfer deadlock, force restart"),r[0]=h.FLASH_DATA,r[1]=0,r[2]=0,r[3]=-1;for(let e=0;e<16;e++)r[4+e]=0;return this.pfCharacteristic.writeValue(r).then(()=>t())});t().catch(e=>{this.flashReject&&(this.flashReject(new Error("failed packet transfer")),this.clearFlashData())})}).catch(()=>{this.flashPacketToken.resolveCancel()})}}h.SERVICE_UUID="e97dd91d-251d-470a-a062-fa1922dfa9a8",h.CHARACTERISTIC_UUID="e97d3b10-251d-470a-a062-fa1922dfa9a8",h.REGION_INFO=0,h.FLASH_DATA=1,h.PACKET_OUT_OF_ORDER=170,h.PACKET_WRITTEN=255,h.END_OF_TRANSMISSION=2,h.STATUS=238,h.RESET=255,h.MODE_PAIRING=0,h.MODE_APPLICATION=1,h.REGION_SOFTDEVICE=0,h.REGION_DAL=1,h.REGION_MAKECODE=2,h.MAGIC_MARKER=a.Util.fromHex("708E3B92C615A841C49866C975EE5197"),h.CHUNK_MIN_DELAY=0,h.CHUNK_MAX_DELAY=75,i.PartialFlashingService=h;class p extends o{constructor(e){super("ble",new a.Util.CancellationToken),this.device=void 0,this.services=[],this.pendingResumeLogOnDisconnection=!1,this.servicesVersion=0,this.device=e,this.handleDisconnected=this.handleDisconnected.bind(this),this.handleServiceAdded=this.handleServiceAdded.bind(this),this.handleServiceChanged=this.handleServiceChanged.bind(this),this.handleServiceRemoved=this.handleServiceRemoved.bind(this),this.device.addEventListener("gattserverdisconnected",this.handleDisconnected),this.device.addEventListener("serviceadded",this.handleServiceAdded),this.device.addEventListener("servicechanged",this.handleServiceChanged),this.device.addEventListener("serviceremoved",this.handleServiceRemoved),t()&&(this.services.push(this.uartService=new d(this)),this.services.push(this.hf2Service=new u(this))),r()&&this.services.push(this.partialFlashingService=new h(this)),this.aliveToken.startOperation()}startServices(){this.services.filter(e=>e.autoReconnect).forEach(e=>e.connectAsync().catch(()=>{}))}pauseLog(){this.uartService&&(this.uartService.autoReconnect=!1,this.uartService.disconnect()),this.hf2Service&&(this.hf2Service.autoReconnect=!1,this.hf2Service.disconnect())}resumeLogOnDisconnection(){this.pendingResumeLogOnDisconnection=!0}resumeLog(){this.uartService&&(this.uartService.autoReconnect=!0,this.uartService.connectAsync().catch(()=>{})),this.hf2Service&&(this.hf2Service.autoReconnect=!0,this.hf2Service.connectAsync().catch(()=>{}))}get isPaired(){return this===i.bleDevice}get name(){return this.device.name||"?"}get connected(){return this.device&&this.device.gatt&&this.device.gatt.connected}get gatt(){return this.device.gatt}createConnectPromise(){return this.debug("connecting gatt server"),this.alivePromise(this.device.gatt.connect().then(()=>this.debug("gatt server connected")))}handleServiceAdded(e){this.debug("service added"),this.servicesVersion++}handleServiceRemoved(e){this.debug("service removed"),this.servicesVersion++}handleServiceChanged(e){this.debug("service changed"),this.servicesVersion++}handleDisconnected(e){this.debug("disconnected"),this.disconnect(),this.pendingResumeLogOnDisconnection&&(this.pendingResumeLogOnDisconnection=!1,a.U.delay(500).then(()=>this.resumeLog()))}disconnect(){if(super.disconnect(),this.services.forEach(e=>e.disconnect()),this.connected){this.debug("disconnect");try{this.device.gatt&&this.device.gatt.connected&&this.device.gatt.disconnect()}catch(e){this.debug("gatt disconnect error "+e.message)}}}}function n(){if(i.bleDevice)return Promise.resolve();a.log("ble: requesting device");var e=[];return t()&&(e.push(d.SERVICE_UUID),e.push(u.SERVICE_UUID)),r()&&e.push(h.SERVICE_UUID),navigator.bluetooth.requestDevice({filters:a.appTarget.appTheme.bluetoothUartFilters,optionalServices:e}).then(e=>(a.log("ble: received device "+e.name),i.bleDevice=new p(e),i.bleDevice.startServices(),i.bleDevice.connectAsync()))}i.BLEDevice=p,i.bleDevice=void 0,i.isPaired=function(){return!!i.bleDevice},i.pairAsync=function(){return i.bleDevice&&(i.bleDevice.kill(),i.bleDevice=void 0),n().catch(e=>{i.bleDevice&&i.bleDevice.aliveToken&&i.bleDevice.aliveToken.resolveCancel(),a.log("ble: error "+e.message)})},i.flashAsync=function(e,t){a.tickEvent("webble.flash");let r=e.outfiles[ts.pxtc.BINARY_HEX];return n().then(()=>i.bleDevice.partialFlashingService.flashAsync(r)).then(()=>a.tickEvent("webble.flash.success")).catch(e=>{throw a.tickEvent("webble.fail.fail",{message:e.message}),e})}}})(pxt=pxt||{}),(s=>{{var n=s.usb||(s.usb={});class c extends Error{constructor(e){super(e),this.message=e}}n.USBError=c,n.filters=[{classCode:255,subclassCode:42}];let i=!0;n.setFilters=function(e){i=!1,n.filters=e};class u{constructor(){this.ready=!1,this.connecting=!1,this.readLoopStarted=!1,this.onDeviceConnectionChanged=e=>{},this.onConnectionChanged=()=>{},this.onData=e=>{},this.onError=e=>{},this.onEvent=e=>{},this.enabled=!1,this.handleUSBConnected=this.handleUSBConnected.bind(this),this.handleUSBDisconnected=this.handleUSBDisconnected.bind(this)}enable(){var e;this.enabled||(this.enabled=!0,this.log("registering webusb events"),null!=(e=navigator.usb)&&e.addEventListener("disconnect",this.handleUSBDisconnected,!1),null!=(e=navigator.usb)&&e.addEventListener("connect",this.handleUSBConnected,!1))}disable(){var e;this.enabled&&(this.enabled=!1,this.log("unregistering webusb events"),null!=(e=navigator.usb)&&e.removeEventListener("disconnect",this.handleUSBDisconnected),null!=(e=navigator.usb))&&e.removeEventListener("connect",this.handleUSBConnected)}async disposeAsync(){this.disable()}handleUSBDisconnected(e){this.log("device disconnected"),e.device==this.dev&&(this.log("clear device"),this.clearDev(),null!=(e=this.onDeviceConnectionChanged))&&e.call(this,!1)}handleUSBConnected(e){var e=e.device;this.log("device connected "+e.serialNumber),this.dev||this.connecting||(this.log("attach device"),null!=(e=this.onDeviceConnectionChanged)&&e.call(this,!0))}clearDev(){var e;this.dev&&(this.dev=null,this.epIn=null,(this.epOut=null)!=(e=this.onConnectionChanged))&&e.call(this)}error(e){throw new c(s.U.lf("USB error on device {0} ({1})",this.dev.productName,e))}log(e){s.debug("webusb: "+e)}async disconnectAsync(){if(this.ready=!1,this.dev){this.log("close device");try{await this.dev.close()}catch(e){}this.clearDev(),await s.U.delay(500)}}async forgetAsync(){var e;if(null==(e=this.dev)||!e.forget)return!1;try{var t=this.dev;return await this.disconnectAsync(),await t.forget(),!0}catch(e){return!1}}async reconnectAsync(){this.log("reconnect"),this.setConnecting(!0);try{await this.disconnectAsync();var e=await r();await this.connectAsync(e)}finally{this.setConnecting(!1)}}setConnecting(e){e!=this.connecting&&(this.connecting=e,null!=(e=this.onConnectionChanged))&&e.call(this)}isConnecting(){return this.connecting}isConnected(){return!!this.dev&&this.ready}async connectAsync(t){var e,r;if(this.log(`trying to connect (${t.length} devices)`),0==t.length)throw(e=new Error("Device not found.")).type="devicenotfound",e;this.setConnecting(!0);try{this.lastKnownDeviceSerialNumber&&((r=t.find(e=>e.serialNumber===this.lastKnownDeviceSerialNumber))?(this.log("last known device spotted"),t.splice(t.indexOf(r),1),t.unshift(r)):(this.log("delay for last known device"),await s.U.delay(2e3)));for(let e=0;e<t.length;++e){var i=t[e];this.dev=i,this.log(`connect device: ${i.manufacturerName} `+i.productName),this.log(`serial number: ${i.serialNumber} ${this.lastKnownDeviceSerialNumber===i.serialNumber?"(last known device)":""} `);try{return void await this.initAsync()}catch(e){this.dev=void 0,this.log("connection failed, "+e.message)}}var n=new Error(s.U.lf("Device in use or not found."));throw n.type="devicelocked",n}finally{this.setConnecting(!1)}}async sendPacketAsync(e){if(!this.dev)throw new Error("Disconnected");s.Util.assert(e.length<=64),this.epOut?"ok"!=(await this.dev.transferOut(this.epOut.endpointNumber,e)).status&&this.error("USB OUT transfer failed"):"ok"!=(await this.dev.controlTransferOut({requestType:"class",recipient:"interface",request:9,value:512,index:this.iface.interfaceNumber},e)).status&&this.error("USB CTRL OUT transfer failed")}async readLoop(){if(!this.readLoopStarted)for(this.readLoopStarted=!0,this.log("start read loop");;)if(this.ready)try{var e=await this.recvPacketAsync();e[0]?this.onData(e):await s.U.delay(500)}catch(e){this.dev&&this.onError(e),await s.U.delay(300)}else await s.U.delay(300)}async recvPacketAsync(e){for(var t=Date.now();!e||Date.now()<t+e;){if(!this.dev)throw new Error("Disconnected");var r=await(this.epIn?this.dev.transferIn(this.epIn.endpointNumber,64):this.dev.controlTransferIn({requestType:"class",recipient:"interface",request:1,value:256,index:this.iface.interfaceNumber},64)),r=("ok"!=r.status&&this.error("USB IN transfer failed"),new Uint8Array(r.data.buffer));if(0!=r.length)return r}this.error("USB IN timed out")}async initAsync(){if(!this.dev)throw new Error("Disconnected");var e=this.dev,t=(this.log("open device"),await e.open(),this.log("select configuration"),await e.selectConfiguration(1),this.log("got "+e.configurations[0].interfaces.length+" interfaces"),e.configurations[0].interfaces.filter(e=>{var t,r=e.alternates[0];for(t of n.filters)if((null==t.classCode||r.interfaceClass===t.classCode)&&!(null!=t.subclassCode&&r.interfaceSubclass!==t.subclassCode||null!=t.protocolCode&&r.interfaceProtocol!==t.protocolCode)){if(0==r.endpoints.length)return!0;if(2==r.endpoints.length&&r.endpoints.every(e=>64==e.packetSize))return!0}return!1})),r=t[t.length-1];this.log(t.length+" matching interfaces; picking "+(r?"#"+r.interfaceNumber:"n/a")),r||this.error("cannot find supported USB interface"),this.altIface=r.alternates[0],this.iface=r,this.altIface.endpoints.length?(this.log("using dedicated endpoints"),this.epIn=this.altIface.endpoints.filter(e=>"in"==e.direction)[0],this.epOut=this.altIface.endpoints.filter(e=>"out"==e.direction)[0],s.Util.assert(64==this.epIn.packetSize),s.Util.assert(64==this.epOut.packetSize)):this.log("using ctrl pipe"),this.log("claim interface"),await e.claimInterface(r.interfaceNumber),this.log("device ready"),this.lastKnownDeviceSerialNumber=this.dev.serialNumber,this.ready=!0,i&&this.readLoop(),null!=(t=this.onConnectionChanged)&&t.call(this)}}async function r(){var e;s.log("webusb: get devices");try{return await(null==(e=navigator.usb)?void 0:e.getDevices())||[]}catch(e){return s.reportException(e),[]}}n.pairAsync=async function(){var e;try{return!!await(null==(e=navigator.usb)?void 0:e.requestDevice({filters:n.filters}))}catch(e){if("NotFoundError"!=e.name)throw e}},n.tryGetDevicesAsync=r;let e,t=(n.mkWebUSBHIDPacketIOAsync=function(){return s.debug("packetio: mk webusb io"),(e=e||new u).enable(),Promise.resolve(e)},n.forgetDeviceAsync=async function(){return s.debug("packetio: forget webusb io"),!!e&&e.forgetAsync()},n.isEnabled=!1,n.setEnabled=function(e){l()||(e=!1),n.isEnabled=e},void 0);async function a(){if(void 0===t)if(s.debug("webusb: checking availability"),null!=(e=null==(e=s.appTarget)?void 0:e.compile)&&e.webUSB){var e=await o();if(e)switch(t=!1,s.tickEvent("webusb.off",{reason:e}),e){case"electron":s.debug("webusb: off, electron");break;case"notimpl":s.debug("webusb: off, not implemented by browser");break;case"oldwindows":s.debug("webusb: off, older windows version");break;case"security":s.debug("webusb: off, security exception")}else t=!0}else t=!1}async function o(){if(s.BrowserUtils.isElectron())return"electron";var e=navigator.usb;if(!e)return"notimpl";var t=/Windows NT (\d+\.\d+)/.exec(navigator.userAgent);if(t&&parseFloat(t[1])<6.3)return"oldwindows";try{await e.getDevices()}catch(e){return"security"}}function l(){return void 0===t&&(s.error("checkAvailableAsync not called"),a()),!!t}n.checkAvailableAsync=a,n.getReasonUnavailable=o,n.isAvailable=l}})(pxt=pxt||{}),(s=>{{var e=s.worker||(s.worker={}),i=s.Util;let r={};function a(s){let a={},o=0,e=new i.PromiseQueue,t=new Promise((e,t)=>{a.ready=e});e.enqueue("main",()=>t);return{opAsync:function(i,n){return e.enqueue("main",()=>new Promise((t,r)=>{var e=""+o++;a[e]=e=>{e?e.errorMessage?r(new Error(e.errorMessage)):t(e):r(new Error("no response"))},s({id:e,op:i,arg:n})}))},recvHandler:e=>{var t;a.hasOwnProperty(e.id)&&(t=a[e.id],delete a[e.id],t(e.result))}}}function n(e){let t=new Worker(e),r=a(e=>t.postMessage(e));return t.onmessage=e=>{s.perf.measureStart(Measurements.WebworkerRecvHandler),r.recvHandler(e.data),s.perf.measureEnd(Measurements.WebworkerRecvHandler)},r}e.getWorker=function(e){let t=r[e];return t=t||(r[e]=n(e))},e.wrap=a,e.makeWebWorker=n,e.makeWebSocket=function(e,t=null){let r=new WebSocket(e),i=[],n=a(e=>{e=JSON.stringify(e);i?i.push(e):r.send(e)});return r.onmessage=e=>{e=JSON.parse(e.data);t&&null==e.id?t(e):n.recvHandler(e)},r.onopen=e=>{s.debug("socket opened");for(var t of i)r.send(t);i=null},r.onclose=e=>{s.debug("socket closed")},r.onerror=e=>{s.debug("socket errored")},n}}})(pxt=pxt||{}),(s=>{var a;function o(){a.apiKey||s.U.userError("YouTube API key missing")}(a=s.youtube||(s.youtube={})).apiKey=void 0,a.playlistItemToCodeCard=function(e){return{name:e.snippet.title.replace(/[^-]*-/,"").trim(),description:e.snippet.description.split(/\n\s+/,1)[0].trim(),youTubeId:e.snippet.resourceId.videoId,youTubePlaylistId:e.snippet.playlistId,imageUrl:(e=e.snippet.thumbnails)&&(null==(e=e.medium||e.high||e.standard||e.default)?void 0:e.url)||""}},a.playlistInfoAsync=function(e){return o(),e=`https://www.googleapis.com/youtube/v3/playlists?part=snippet&id=${e}&key=`+a.apiKey,s.Util.httpGetJsonAsync(e).then(e=>e.items[0])},a.listPlaylistVideosAsync=async function(t){o();let r=[],i=void 0;do{let e=`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${t}&key=`+a.apiKey;i&&(e+="&pageToken="+i);var n=await s.Util.httpGetJsonAsync(e);r=r.concat(n.items),i=n.nextPageToken}while(i);return s.options.debug&&s.debug(JSON.stringify(r,null,2)),r},a.watchUrl=function(e,t){let r=void 0;return e?(r="https://www.youtube.com/watch?v="+e,t&&(r+="&list="+t)):t&&(r="https://www.youtube.com/playlist?list="+t),r}})(pxt=pxt||{}),(e=>{var f=e.pxtc||(e.pxtc={});{var m=f.assembler||(f.assembler={});function g(e,...r){return e.replace(/{(\d+)}/g,(e,t)=>r[+t])}m.debug=!1,m.lf=g;let e=b("opcode name doesn't match","<name>");class a{constructor(e,t,r,i,n){this.opcode=r,this.mask=i,this.is32bit=n,this.canBeShared=!1,f.assert((r&i)==r),this.ei=e,this.code=t.replace(/\s+/g," "),this.friendlyFmt=t.replace(/\$\w+/g,e=>this.ei.encoders[e]?this.ei.encoders[e].pretty:e);n=o(t);this.name=n[0],this.args=n.slice(1)}emit(r){var i=r.words;if(i[0]!=this.name)return e;let n=this.opcode,s=1,a=0;var o=[];let l=null,c=null,u=null;for(let e=0;e<this.args.length;++e){var d=this.args[e];let t=i[s++];if("$"==d[0]){var h=this.ei.encoders[d];let e=null;if(h.isRegister){if(null==(e=this.ei.registerNo(t)))return b("expecting register name",t);this.ei.isPush(this.opcode)?a++:this.ei.isPop(this.opcode)&&a--}else if(h.isImmediate){if(t=t.replace(/^#/,""),null==(e=r.bin.parseOneInt(t)))return b("expecting number",t);this.ei.isAddSP(this.opcode)?a=-(e/this.ei.wordSize()):this.ei.isSubSP(this.opcode)&&(a=e/this.ei.wordSize())}else if(h.isRegList){if("{"!=t)return b("expecting {",t);for(e=0;"}"!=i[s];){if(!(t=i[s++]))return b("expecting }",i[s-2]);var p=this.ei.registerNo(t);if(null==p)return b("expecting register name",t);if(e&1<<p)return b("duplicate register name",t);e|=1<<p,this.ei.isPush(this.opcode)?a++:this.ei.isPop(this.opcode)&&a--,","==i[s]&&s++}t=i[s++]}else if(h.isLabel){if(t=t.replace(/^#/,""),/^[+-]?\d+$/.test(t))e=parseInt(t,10),l="rel"+e;else if(/^0x[0-9a-fA-F]+$/.test(t))e=parseInt(t,16),l="abs"+e;else if(l=t,null==(e=this.ei.getAddressFromLabel(r.bin,this,t,h.isWordAligned))){if(r.bin.finalEmit)return b("unknown label",t);e=8}if(this.ei.is32bit(this)){c=e,u=t;continue}}else f.oops();if(null==e)return b("didn't understand it",t);if(o.push(e),null==(e=h.encode(e)))return b("argument out of range or mis-aligned",t);f.assert(0==(n&e)),n|=e}else if(d!=t)return b("expecting "+d,t)}return i[s]?b("trailing tokens",i[s]):this.ei.is32bit(this)?this.ei.emit32(n,c,r.bin.normalizeExternalLabel(u)):{stack:a,opcode:n,numArgs:o,labelName:r.bin.normalizeExternalLabel(l)}}toString(){return this.friendlyFmt}}m.Instruction=a;class l{constructor(e,t){this.bin=e,this.text=t}getOpExt(){return this.instruction?this.instruction.code:""}getOp(){return this.instruction?this.instruction.name:""}update(e){this.bin.peepOps++,(e=e.replace(/^\s*/,""))||this.bin.peepDel++,e&&(e+="      "),this.text=(e="    "+e)+"; WAS: "+this.text.trim(),this.instruction=null,this.numArgs=null,this.words=o(e)||[],0==this.words.length?this.type="empty":"@"==this.words[0][0]&&(this.type="directive")}}m.Line=l;class c{constructor(e,t){this.id=e,this.description=t,this.sizeAdj=0,this.users=[]}get size(){return this.endLocation-this.startLocation-this.sizeAdj}}class u{constructor(e){this.baseOffset=0,this.checkStack=!0,this.inlineMode=!1,this.normalizeExternalLabel=e=>e,this.currLineNo=0,this.scope="",this.scopeId=0,this.errors=[],this.labels={},this.equs={},this.stackpointers={},this.stack=0,this.commPtr=0,this.peepOps=0,this.peepDel=0,this.peepCounts={},this.stats="",this.throwOnError=!1,this.disablePeepHole=!1,this.stackAtLabel={},this.codeSizeStats=!1,this.labelToObject={},this.idToObject={},this.objSuspendStart=0,this.labelsToObjectDone=!1,this.currLine=new l(this,"<start>"),this.currLine.lineNo=0,this.ei=e,this.ei.file=this}emitShort(e){f.assert(0<=e&&e<=65535),this.buf.push(e)}emitOpCode(e){this.emitShort(e)}location(){return 2*this.buf.length}pc(){return this.location()+this.baseOffset}useLabel(e){this.currObject&&"."!=e[0]&&!this.objSuspendStart&&(e=f.U.lookup(this.labelToObject,e))&&e!=this.currObject&&e.users.length<5&&e.users.indexOf(this.currObject)<0&&e.users.push(this.currObject)}parseOneInt(e){if(!e)return null;if(/^\d+$/.test(e))return parseInt(e,10);var t=e.indexOf("-");if(0<t)return this.parseOneInt(e.slice(0,t))-this.parseOneInt(e.slice(t+1));let r=1;if(0<=e.indexOf("*"))for(var i;null!=(i=/^([^\*]*)\*(.*)$/.exec(e));){var n=this.parseOneInt(i[1]);if(null==n)return null;r*=n,e=i[2]}if("-"==e[0]?(r*=-1,e=e.slice(1)):"+"==e[0]&&(e=e.slice(1)),/^\d+$/.test(e))return r*parseInt(e,10);if(f.U.endsWith(e,"|1"))return 1|this.parseOneInt(e.slice(0,e.length-2));if(f.U.endsWith(e,"-1"))return this.parseOneInt(e.slice(0,e.length-2))-1;if(f.U.endsWith(e,"+1"))return this.parseOneInt(e.slice(0,e.length-2))+1;var s,t=/(.*)>>(\d+)$/.exec(e);if(t)return s=this.parseOneInt(t[1]),(s&=~(-16777216&this.baseOffset))>>parseInt(t[2]);let a=null;return"0"==e[0]&&("x"==e[1]||"X"==e[1]?(s=/^0x([a-f0-9]+)$/i.exec(e))&&(a=parseInt(s[1],16)):"b"!=e[1]&&"B"!=e[1]||(t=/^0b([01]+)$/i.exec(e))&&(a=parseInt(t[1],2))),0<=e.indexOf("@")&&((s=/^(\w+)@(-?\d+)$/.exec(e))&&(1!=r&&this.directiveError(g("multiplication not supported with saved stacks")),this.stackpointers.hasOwnProperty(s[1])?a=this.ei.wordSize()*this.ei.computeStackOffset(s[1],this.stack-this.stackpointers[s[1]]+parseInt(s[2])):this.directiveError(g("saved stack not found"))),s=/^(.*)@(hi|lo|fn)$/.exec(e))&&this.looksLikeLabel(s[1])&&null!=(a=this.lookupLabel(s[1],!0))&&("fn"==s[2]?a=this.ei.toFnPtr(a,this.baseOffset,s[1]):0<=(a>>=1)&&a<=65535?"hi"==s[2]?a=a>>8&255:"lo"==s[2]?a&=255:f.oops():(this.directiveError(g("@hi/lo out of range")),a=null)),null==a&&this.looksLikeLabel(e)&&null!=(a=this.lookupLabel(e,!0))&&1==this.ei.postProcessRelAddress(this,1)&&(a+=this.baseOffset),null==a||isNaN(a)?null:a*r}looksLikeLabel(e){return!/^(r\d|pc|sp|lr)$/i.test(e)&&/^[\.a-zA-Z_][\.:\w+]*$/.test(e)}scopedName(e){return"."==e[0]&&this.scope?this.scope+"$"+e:e}lookupLabel(e,t=!1){this.useLabel(e);let r=null;var i=this.scopedName(e);return this.labels.hasOwnProperty(i)?(r=this.labels[i],r=this.ei.postProcessRelAddress(this,r)):this.lookupExternalLabel&&null!=(r=this.lookupExternalLabel(e))&&(r=this.ei.postProcessAbsAddress(this,r)),null==(r=null==r&&this.equs.hasOwnProperty(i)?this.equs[i]:r)&&t&&(this.finalEmit?this.directiveError(g("unknown label: {0}",e)):r=11111),r}align(e){for(f.assert(2==e||4==e||8==e||16==e);this.location()%e!=0;)this.emitOpCode(0)}pushError(e,t=""){e={scope:this.scope,message:g("  -> Line {2} ('{1}'), error: {0}\n{3}",e,this.currLine.text,this.currLine.lineNo,t),lineNo:this.currLine.lineNo,line:this.currLine.text,coremsg:e,hints:t};if(this.errors.push(e),this.throwOnError)throw new Error(e.message)}directiveError(e){this.pushError(e)}emitString(e,t=!1){function r(e,t){return 255&(e.charCodeAt(t)||0)}e=/^\s*([\w\.]+\s*:\s*)?.\w+\s+(".*")\s*$/.exec(e);let i;if(e&&null!=(i=s(e[2])))if(this.align(2),t)for(let e=0;e<i.length;e++)this.emitShort(i.charCodeAt(e));else for(let e=0;e<i.length+1;e+=2)this.emitShort(r(i,e+1)<<8|r(i,e));else this.directiveError(g("expecting string"))}parseNumber(e){e=this.parseOneInt(e.shift());return null==e?null:e}parseNumbers(e){e=e.slice(1);for(var t=[];;){var r=this.parseNumber(e);if(null==r){this.directiveError(g("cannot parse number at '{0}'",e[0]));break}if(t.push(r),","!=e[0]){if(null==e[0])break;this.directiveError(g("expecting number, got '{0}'",e[0]));break}if(e.shift(),null==e[0])break}return t}emitSpace(e){var t=this.parseNumbers(e);if(1==t.length&&t.push(0),2!=t.length)this.directiveError(g("expecting one or two numbers"));else if(t[0]%2!=0)this.directiveError(g("only even space supported"));else{var r=255&t[1];r|=r<<8;for(let e=0;e<t[0];e+=2)this.emitShort(r)}}emitBytes(e){var t=this.parseNumbers(e);t.length%2!=0&&(this.directiveError(".bytes needs an even number of arguments"),t.push(0));for(let e=0;e<t.length;e+=2){var r=t[e],i=t[e+1];0<=r&&i<=255&&0<=i&&r<=255?this.emitShort(255&r|(255&i)<<8):this.directiveError(g("expecting uint8"))}}emitHex(e){e.slice(1).forEach(t=>{if(","!=t)if(t.length%4!=0)this.directiveError(".hex needs an even number of bytes");else if(/^[a-f0-9]+$/i.test(t))for(let e=0;e<t.length;e+=4){var r=parseInt(t.slice(e,e+4),16);this.emitShort((255&r)<<8|r>>8&255)}else this.directiveError(".hex needs a hex number")})}handleDirective(t){let r=t.words;var e=()=>{2!=r.length&&this.directiveError(g("expecting one argument"))};let i;switch(r[0]){case".object":if(this.codeSizeStats)if("PUSH"==r[1])this.objSuspendStart=this.location();else if("POP"==r[1])this.objSuspendStart&&(this.currObject.sizeAdj+=this.location()-this.objSuspendStart),this.objSuspendStart=0;else{if(this.currObject&&(this.currObject.endLocation=this.location()),this.currObject=f.U.lookup(this.idToObject,r[1]),!this.currObject){var n=t.text.replace(/^[^"]*/,"");let e=r[1];2<r.length&&null==(e=s(n.trim()))&&this.directiveError(g("expecting string in .object")),this.currObject=new c(r[1],e),this.idToObject[r[1]]=this.currObject}this.currObject.sizeAdj=0,this.currObject.startLocation=this.location()}break;case".ascii":case".asciz":case".string":this.emitString(t.text);break;case".utf16":this.emitString(t.text,!0);break;case".align":if(e(),null!=(i=this.parseOneInt(r[1]))){if(0==i)return;i<=4?this.align(1<<i):this.directiveError(g("expecting 1, 2, 3 or 4 (for 2, 4, 8, or 16 byte alignment)"))}else this.directiveError(g("expecting number"));break;case".balign":if(e(),null!=(i=this.parseOneInt(r[1]))){if(1==i)return;2==i||4==i||8==i||16==i?this.align(i):this.directiveError(g("expecting 2, 4, 8, or 16"))}else this.directiveError(g("expecting number"));break;case".p2align":e(),null!=(i=this.parseOneInt(r[1]))?this.align(1<<i):this.directiveError(g("expecting number"));break;case".byte":this.emitBytes(r);break;case".hex":this.emitHex(r);break;case".hword":case".short":case".2bytes":this.parseNumbers(r).forEach(e=>{-32768<=e&&e<=65535?this.emitShort(65535&e):this.directiveError(g("expecting int16"))});break;case".word":case".4bytes":case".long":this.parseNumbers(r).forEach(e=>{-2147483648<=e&&e<=4294967295?(this.emitShort(65535&e),this.emitShort(e>>16&65535)):this.directiveError(g("expecting int32"))});break;case".skip":case".space":this.emitSpace(r);break;case".set":case".equ":/^\w+$/.test(r[1])||this.directiveError(g("expecting name"));n=this.parseNumbers(r.slice(","==r[2]||"="==r[2]?2:1));1!=n.length&&this.directiveError(g("expecting one value")),void 0!==this.equs[r[1]]&&this.equs[r[1]]!=n[0]&&this.directiveError(g("redefinition of {0}",r[1])),this.equs[r[1]]=n[0];break;case".startaddr":this.location()&&this.directiveError(g(".startaddr can be only be specified at the beginning of the file")),e(),this.baseOffset=this.parseOneInt(r[1]);break;case"@stackmark":e(),this.stackpointers[r[1]]=this.stack;break;case"@stackempty":this.checkStack&&(null==this.stackpointers[r[1]]?this.directiveError(g("no such saved stack")):this.stackpointers[r[1]]!=this.stack&&this.directiveError(g("stack mismatch")));break;case"@scope":this.scope=r[1]||"",this.currLineNo=this.scope?0:this.realCurrLineNo;break;case".syntax":case"@nostackcheck":this.checkStack=!1;break;case"@dummystack":e(),this.stack+=this.parseOneInt(r[1]);break;case".section":case".global":this.stackpointers={},this.stack=0,this.scope="$S"+this.scopeId++;break;case".comm":{(r=r.filter(e=>","!=e)).shift();n=this.parseOneInt(r[1]);let e=0;if(e=r[2]?this.parseOneInt(r[2]):4,null==this.lookupLabel(r[0])){for(this.commPtr||(this.commPtr=this.lookupExternalLabel("_pxt_comm_base")||0,this.commPtr)||this.directiveError(g("PXT_COMM_BASE not defined"));this.commPtr&e-1;)this.commPtr++;this.labels[this.scopedName(r[0])]=this.commPtr-this.baseOffset,this.commPtr+=n}break}case".file":case".text":case".cpu":case".fpu":case".eabi_attribute":case".code":case".thumb_func":case".type":case".fnstart":case".save":case".size":case".fnend":case".pad":case".globl":case".local":case"@":break;default:/^\.cfi_/.test(r[0])||this.directiveError(g("unknown directive"))}}handleOneInstruction(e,t){this.codeSizeStats&&e.ldlitLabel&&this.useLabel(e.ldlitLabel);var r=t.emit(e);return!r.error&&(this.stack+=r.stack,this.checkStack&&this.stack<0&&this.pushError(g("stack underflow")),e.location=this.location(),e.opcode=r.opcode,e.stack=r.stack,this.emitOpCode(r.opcode),null!=r.opcode2&&this.emitOpCode(r.opcode2),null!=r.opcode3&&this.emitOpCode(r.opcode3),e.instruction=t,e.numArgs=r.numArgs,!0)}handleInstruction(i){if(!i.instruction||!this.handleOneInstruction(i,i.instruction)){var e=e=>this.ei.instructions.hasOwnProperty(e)?this.ei.instructions[e]:[];if(!i.instruction){var t=e(i.words[0]);for(let e=0;e<t.length;++e)if(this.handleOneInstruction(i,t[e]))return}var n=i.words[0].toLowerCase().replace(/s$/,"").replace(/[^a-z]/g,"");let r="";e=e(n).concat(e(n+"s"));0<e.length&&e.forEach(e=>{var t=e.emit(i);r+=g("   Maybe: {0} ({1} at '{2}')\n",e.toString(),t.error,t.errorAt)}),this.pushError(g("assembly error"),r)}}buildLine(e,t){var r=e=>{e=new l(this,e);return e.scope=this.scope,e.lineNo=this.currLineNo,t.push(e),e};let i=r(e);var n=o(i.text)||[];let s=(i.words=n)[0]||"";if(":"==s.charAt(s.length-1)){var a=/^([\.\w]+):$/.exec(n[0]);if(a){if(i.type="label",i.text=a[1]+":",i.words=[a[1]],!(1<n.length))return;n.shift(),(i=r(e.replace(/^[^:]*:/,""))).words=n,s=n[0]||""}}a=s.charAt(0);"."==a||"@"==a?(i.type="directive","@scope"==i.words[0]&&this.handleDirective(i)):0==i.words.length?i.type="empty":i.type="instruction"}prepLines(e){this.currLineNo=0,this.realCurrLineNo=0,this.lines=[],e.split(/\r?\n/).forEach(e=>{10<this.errors.length||(this.currLineNo++,this.realCurrLineNo++,this.buildLine(e,this.lines))})}iterLines(){this.stack=0,this.buf=[],this.scopeId=0,this.lines.forEach(e=>{var t,r;10<this.errors.length||0!=(this.currLine=e).words.length&&("label"==e.type?(this.currObject&&!this.labelsToObjectDone&&"."!=e.words[0][0]&&(this.labelToObject[e.words[0]]=this.currObject),t=this.scopedName(e.words[0]),this.prevLabel=t,this.finalEmit?(null!=this.equs[t]&&this.directiveError(g(".equ redefined as label")),null==(r=this.labels[t])&&f.oops(),0==this.errors.length&&r!=this.location()&&f.oops(`invalid location: ${this.location()} != ${r} at `+t),f.assert(0<this.errors.length||r==this.location()),this.reallyFinalEmit&&(this.stackAtLabel[t]=this.stack)):this.labels.hasOwnProperty(t)?this.directiveError(g("label redefinition")):this.inlineMode&&/^_/.test(t)?this.directiveError(g("labels starting with '_' are reserved for the compiler")):this.labels[t]=this.location(),e.location=this.location()):"directive"==e.type?this.handleDirective(e):"instruction"==e.type?this.handleInstruction(e):"empty"!=e.type&&f.oops())}),this.labelsToObjectDone=!0,this.currObject=null}getSourceMap(){let e={},i="",n=0,s=0,a=0;function o(){i&&s&&(e[i]||(e[i]=[]),e[i].push(n,s,a-s)),s=0,a=0}return this.lines.forEach((e,t)=>{var r=/^; ([\w\/\.-]+)\(([\d]+),\d+\):/.exec(e.text);r&&(o(),i=r[1],n=parseInt(r[2])),"instruction"==e.type&&(s=s||e.location,a=e.location)}),o(),e}getCodeSizeStats(){if(!this.codeSizeStats)return"";var e,t=f.U.values(this.idToObject);t.sort((e,t)=>t.size-e.size);let r=";\n; Code size:\n;\n";for(e of t)if(r+=`; ${("         "+e.size).slice(-6)} ${e.description} [${e.id}]
`,5<=e.users.length)r+=`;        by many, including ${e.users[0].description}
`;else for(var i of e.users)r+=`;        by ${i.description} [${i.id}]
`;return r}getSource(i,e=1,t=0){let r=0;var n=e=>{var e=this.labels[e]||r,t=e-r;return r=e,t},s=this.buf?this.location():0,a=n("_code_end"),o=n("_helpers_end"),l=n("_vtables_end"),n=n("_literals_end"),c=r,u=s+this.baseOffset&16777215;if(t&&t<u)throw(d=new Error(g("program too big by {0} bytes!",u-t))).ksErrorCode=9283,d;var d=g("; total bytes: {0} ({1}% of {2}k flash with {3} free)",u,(100*u/(t=t||131072)).toFixed(1),(t/1024).toFixed(1),t-u);let h=g("; generated code sizes (bytes): {0} (incl. {1} user, {2} helpers, {3} vtables, {4} lits); src size {5}\n",c,a,o,l,n,s-c)+g("; assembly: {0} lines; density: {1} bytes/stmt; ({2} stmts)\n",this.lines.length,Math.round(100*a/e)/100,e)+d+"\n"+this.stats+this.getCodeSizeStats()+"\n\n",p=!1;return this.lines.forEach((t,r)=>{if("_stored_program"==t.words[0])h+='_stored_program: .string "..."\n',p=!0;else if(p)p=!1;else{let e=t.text;if(i){if("@stackempty"==t.words[0]&&this.lines[r-1].text==t.text)return;if(!(e=e.replace(/; WAS: .*/,"")).trim())return}!m.debug||"label"!=t.type&&"instruction"!=t.type||(e+=` 	; 0x`+(t.location+this.baseOffset).toString(16)),h+=e+"\n"}}),h}peepHole(){var t=this.lines.filter(e=>"empty"!=e.type);for(let e=0;e<t.length;++e){var r,i,n=t[e];/^user/.test(n.scope)||(r=t[e+1])&&(i=t[e+2],"instruction"==n.type)&&this.ei.peephole(n,r,i)}}clearLabels(){this.labels={},this.commPtr=0}peepPass(e){this.disablePeepHole||(this.peepOps=0,this.peepDel=0,this.peepCounts={},this.peepHole(),this.throwOnError=!0,this.finalEmit=!1,this.clearLabels(),this.iterLines(),f.assert(!this.checkStack||0==this.stack),this.finalEmit=!0,this.reallyFinalEmit=e||0==this.peepOps,this.iterLines(),this.stats+=g("; peep hole pass: {0} instructions removed and {1} updated\n",this.peepDel,this.peepOps-this.peepDel))}getLabels(){return this.userLabelsCache||(this.userLabelsCache=f.U.mapMap(this.labels,(e,t)=>t+this.baseOffset)),this.userLabelsCache}emit(e){if(f.assert(null==this.buf),this.prepLines(e),!(0<this.errors.length||(this.clearLabels(),this.iterLines(),this.checkStack&&0!=this.stack&&this.directiveError(g("stack misaligned at the end of the file")),0<this.errors.length)||(this.ei.expandLdlit(this),this.clearLabels(),this.iterLines(),this.finalEmit=!0,this.reallyFinalEmit=this.disablePeepHole,this.iterLines(),0<this.errors.length))){for(let e=0;e<5&&(pxt.debug("Peephole OPT, pass "+e),this.peepPass(5==e),0!=this.peepOps);++e);pxt.debug("emit done")}}}m.File=u;class t extends u{constructor(e){super(e)}}function o(t){var r=[];let i="";e:for(let e=0;e<t.length;++e)switch(t[e]){case"[":case"]":case"!":case"{":case"}":case",":i&&(r.push(i),i=""),r.push(t[e]);break;case" ":case"\t":case"\r":case"\n":i&&(r.push(i),i="");break;case";":break e;default:i+=t[e]}return i&&(r.push(i),i=""),r[0]?r:null}function s(e){e=e.replace(/\\\\/g,"\\B").replace(/\\(['\?])/g,(e,t)=>t).replace(/\\[z0]/g,"\0").replace(/\\x([0-9a-f][0-9a-f])/gi,(e,t)=>"\\u00"+t).replace(/\\B/g,"\\\\");try{return JSON.parse(e)}catch(e){return null}}function b(e,t){return{stack:null,opcode:null,error:e,errorAt:t}}function n(e){return(e<0||65535<e?"0x"+e.toString(16):"0x"+("000"+e.toString(16)).slice(-4)).toLowerCase()}m.VMFile=t,m.AbstractProcessor=class{constructor(){this.file=null,this.addEnc=(e,t,r)=>{t={name:e,pretty:t,encode:r,isRegister:/^\$r\d/.test(e),isImmediate:/^\$i\d/.test(e),isRegList:/^\$rl\d/.test(e),isLabel:/^\$l[a-z]/.test(e)};return this.encoders[e]=t},this.inrange=(e,t,r)=>Math.floor(t)!=t||t<0||e<t?null:r,this.inminmax=(e,t,r,i)=>Math.floor(r)!=r||r<e||t<r?null:i,this.inseq=(e,t)=>{e=e.indexOf(t);return e<0?null:e},this.inrangeSigned=(e,t,r)=>Math.floor(t)!=t||t<-(e+1)||e<t?null:r&(e<<1|1),this.addInst=(e,t,r,i)=>{e=new a(this,e,t,r,i);return this.instructions.hasOwnProperty(e.name)||(this.instructions[e.name]=[]),this.instructions[e.name].push(e),e},this.encoders={},this.instructions={}}toFnPtr(e,t,r){return e}wordSize(){return-1}computeStackOffset(e,t){return t}is32bit(e){return!1}emit32(e,t,r){return null}postProcessRelAddress(e,t){return t}postProcessAbsAddress(e,t){return t}peephole(e,t,r){}registerNo(e){return null}getAddressFromLabel(e,t,r,i=0){return null}isPop(e){return!1}isPush(e){return!1}isAddSP(e){return!1}isSubSP(e){return!1}testAssembler(){f.assert(!1)}expandLdlit(e){}},m.emitErr=b,m.expectError=function(e,t){(e=new u(e)).emit(t),0==e.errors.length&&f.oops("ASMTEST: expecting error for: "+t)},m.tohex=n,m.expect=function(e,t){let r=[];var t=t.replace(/^([0-9a-fA-F]{4,8})\s/gm,(e,t)=>(r.push(parseInt(t.slice(0,4),16)),8==t.length&&r.push(parseInt(t.slice(4,8),16)),"")),i=new u(e);i.throwOnError=!0,i.disablePeepHole=!0,i.emit(t),0<i.errors.length&&(pxt.debug(i.errors[0].message),f.oops("ASMTEST: not expecting errors")),i.buf.length!=r.length&&f.oops("ASMTEST: wrong buf len");for(let e=0;e<r.length;++e)i.buf[e]!=r[e]&&f.oops("ASMTEST: wrong buf content at "+e+" , exp:"+n(r[e])+", got: "+n(i.buf[e]))}}})(ts=ts||{}),(f=>{{var n=f.Cloud||(f.Cloud={}),s=pxtc.Util;n.apiRoot=f.BrowserUtils.isLocalHost()||s.isNodeJS?"https://www.makecode.com/api/":"/api/",n.accessToken="";let r=!(n.localToken=""),i=(n.onOffline=()=>{},void 0);function a(e){let t=new Error(s.lf("Cannot access {0} while offline",e));return t.isOffline=!0,f.U.delay(1e3).then(()=>Promise.reject(t))}function m(e,t){return f.U.requestAsync({url:"/api/"+e,headers:{Authorization:n.localToken},method:t?"POST":"GET",data:t||void 0,allowHttpErrors:!0})}function g(){return f.webConfig&&!f.webConfig.isStatic&&!f.BrowserUtils.isLocalHost()&&!!f.webConfig.cdnUrl&&("undefined"==typeof window||!/nocdn=1/i.test(window.location.href))}function e(e){var t;return e=e.replace(/^\//,""),g()?(t=(t=new Date).getUTCFullYear()+("0"+(t.getUTCMonth()+1)).slice(-2)+("0"+t.getUTCDate()).slice(-2),e.indexOf("?")<0?e+="?":e+="&",f.webConfig.cdnUrl+"/api/"+(e+="cdn="+t)):n.apiRoot+e}function b(t){return g()?(t.url=e(t.url),s.requestAsync(t).catch(e=>o(t,e))):v(t)}function o(e,t){return 0==t.statusCode?(r&&(r=!1,n.onOffline()),a(e.url)):Promise.reject(t)}function v(t){var e;return t.url=null!=(e=f.webConfig)&&e.isStatic&&!t.forceLiveEndpoint?f.webConfig.relprefix+t.url:n.apiRoot+t.url,t.allowGzipPost=!0,n.isOnline()||f.BrowserUtils.isPxtElectron()?(t.headers||(t.headers={}),f.BrowserUtils.isLocalHost()?n.localToken&&(t.headers.Authorization=n.localToken):n.accessToken&&(t.headers["x-td-access-token"]=n.accessToken),s.requestAsync(t).catch(e=>o(t,e))):a(t.url)}function t(){return navigator&&navigator.onLine}n.hasAccessToken=function(){return!!n.accessToken},n.localRequestAsync=m,n.useCdnApi=g,n.cdnApiUrl=e,n.apiRequestWithCdnAsync=b,n.privateRequestAsync=v,n.privateGetTextAsync=function(e,t){return v({url:e,headers:t}).then(e=>e.text)},n.privateGetAsync=function(e,t=!1){return v({url:e,forceLiveEndpoint:t}).then(e=>e.json)},n.downloadTargetConfigAsync=function(){var e;return n.isOnline()?(e=f.appTarget.versions&&f.appTarget.versions.target,e=f.webConfig&&f.webConfig.isStatic?"targetconfig.json":`config/${f.appTarget.id}/targetconfig`+(e?"/v"+e:""),f.BrowserUtils.isLocalHost()?m(e).then(e=>e?e.json:void 0):b({url:e}).then(e=>e.json)):Promise.resolve(void 0)},n.downloadScriptFilesAsync=function(e){return v({url:e+"/text"+(e.startsWith("S")?"?time="+Date.now():""),forceLiveEndpoint:!0}).then(e=>JSON.parse(e.text))},n.downloadScriptMetaAsync=function(e){return v({url:e+(e.startsWith("S")?"?time="+Date.now():""),forceLiveEndpoint:!0}).then(e=>JSON.parse(e.text).meta)},n.downloadBuiltSimJsInfoAsync=async function(e){var t=f.appTarget.versions&&f.appTarget.versions.target||"";return(await v({url:f.U.stringifyQueryString(e+"/js",{v:"v"+t})+(e.startsWith("S")?"&time="+Date.now():""),forceLiveEndpoint:!0})).json},n.markdownAsync=async function(t,r,i,n){var e=24*(c=f.BrowserUtils.isLocalHostDev()?0:36e5)*7;r=r||f.Util.userLanguage();let s=await f.BrowserUtils.translationDbAsync(),a=await s.getAsync(r,t);var o=async()=>{try{var e=await(async(e,t,r,i)=>{let n,s=null==(n=f.webConfig)?void 0:n.isStatic,a=f.appTarget.versions&&f.appTarget.versions.target||"?",o,l=new URLSearchParams;var c,u;if(s?(o=e,u=/\/?docs\//.test(o),c=/\.\w+$/.test(o),u||(u="/"===o[0],o="docs"+(u?"":"/")+o),c||(o+=".md")):(o=`md/${f.appTarget.id}/`+e.replace(/^\//,""),l.set("targetVersion",a)),"en"!=t&&l.set("lang",t),o=f.BrowserUtils.appendUrlQueryParams(o,l),f.BrowserUtils.isLocalHost()&&!f.Util.liveLocalizationEnabled())return m(o).then(e=>404==e.statusCode?v({url:o,method:"GET"}).then(e=>({md:e.text,etag:e.headers.etag})):{md:e.text,etag:void 0});let d=r&&!g()?{"If-None-Match":r}:void 0,h,p;return{md:p=!s&&i?(o=o.replace(/^md\//,"ghtutorial/docs/"),u=(h=await b({url:o,method:"GET",headers:d})).json,await f.github.db.cacheReposAsync(u),u.markdown):(h=await b({url:o,method:"GET",headers:d})).text,etag:h.headers.etag}})(t,r,null==a?void 0:a.etag,n);return!a||e.md&&a.md!==e.md?(await s.setAsync(r,t,e.etag,void 0,e.md),e.md):a.md}catch(e){if(i)throw e;return""}};if(a){var l=Date.now()-a.time,c=c<l;if(e<l)f.tickEvent("markdown.update.wait");else if(c&&(f.tickEvent("markdown.update.background"),o()),a.md)return a.md}return o()},n.privateDeleteAsync=function(e){return v({url:e,method:"DELETE"}).then(e=>e.json)},n.privatePostAsync=function(e,t,r=!1){return v({url:e,data:t||{},forceLiveEndpoint:r}).then(e=>e.json)},n.isLoggedIn=function(){return!!n.accessToken},n.isNavigatorOnline=t,n.isOnline=function(){return r="undefined"!=typeof navigator&&t()?!0:r},n.getServiceUrl=function(){return n.apiRoot.replace(/\/api\/$/,"")},n.getUserId=function(){var e=/^0(\w+)\./.exec(n.accessToken);return e?e[1]:null},n.parseScriptId=function(t){var r=f.appTarget;if(t&&r.appTheme&&null!=(i=r.cloud)&&i.sharing){let e=["makecode.com"];r.appTheme.embedUrl&&e.push(r.appTheme.embedUrl),r.appTheme.shareUrl&&e.push(r.appTheme.shareUrl);var i=`(?:(?:https://)?(?:${(e=s.unique(e,e=>e).map(e=>s.escapeForRegex(s.stripUrlProtocol(e).replace(/\/$/,"")).toLowerCase())).join("|")})/)`,r=new RegExp(`^${i}?(?:v[0-9]+/)?(?:(?:api/oembed\\?url=.*%2F([^&#]*)&.*)|(?:/?([a-z0-9\\-_]+)(?:[#?&].*)?))$`,"i").exec(t.trim()),i=(null==r?void 0:r[1])||(null==r?void 0:r[2]);return/^(_.{12}|S?[0-9\-]{23})$/.test(i)?i:void 0}},n.initRegionAsync=async function(){var e;if(void 0===i)if(f.BrowserUtils.isLocalHost())i=f.cloud.DEV_REGION;else if(null!=(e=f.webConfig)&&e.cdnUrl)try{var t={url:new URL("geo",f.webConfig.cdnUrl).toString()},r=await s.requestAsync(t);200!==r.statusCode&&f.error("Failed to get region: "+r.statusCode),i=r.text.trim()}catch(e){f.error("Unable to determine region",e),i="unknown"}else i="unknown"},n.getRegion=function(){return i||f.error("Accessing region before it is initialized. Call initRegionAsync first."),i}}})(pxt=pxt||{}),(e=>{(e.pxtc||(e.pxtc={})).f4EncodeImg=function(e,r,i,n){let t=[135,i,255&e,e>>8,255&r,r>>8,0,0].map(c).join(""),s=4,a=0,o=0;var l=e=>{a|=e<<o,o==8-i?(t+=c(a),s++,a=0,o=0):o+=i};for(let t=0;t<e;++t){for(let e=0;e<r;++e)l(n(t,e));for(;0!=o;)l(0);if(1<i)for(;3&s;)l(0)}return t;function c(e){return("0"+e.toString(16)).slice(-2)}}})(ts=ts||{}),(e=>{function s(e){let t="";switch(e){case 0:t="C5";break;case 1:t="B";break;case 2:t="A";break;case 3:t="G";break;case 4:t="F";break;case 5:t="E";break;case 6:t="D";break;case 7:t="C"}return t}function i(e){let t=-1;switch(e){case"C5":t=0;break;case"B":t=1;break;case"A":t=2;break;case"G":t=3;break;case"F":t=4;break;case"E":t=5;break;case"D":t=6;break;case"C":t=7}return t}e.MelodyArray=class{constructor(e){this.numCols=8,this.numRows=8,this.polyphonic=!1,e&&(this.tempo=e),this.resetMelody()}setTempo(e){this.tempo=e}getArray(){return this.melody}setArray(e){this.melody=e}getColor(e){return 0}getValue(e,t){return this.melody[e][t]}getWidth(){return this.numCols}getHeight(){return this.numRows}updateMelody(e,t){var r=!this.melody[e][t];if(r&&!this.polyphonic)for(let e=0;e<this.numRows;e++)this.melody[e][t]=!1;this.melody[e][t]=r}getStringRepresentation(){let t="";var i=new Array(this.numCols);let n=0;for(let r=0;r<this.numRows;r++){let t=0;i[r]=[];for(let e=0;e<this.numCols;e++)this.melody[e][r]&&(i[r].push(s(e)),t++);t>n&&(n=t)}if(0==n)return"- - - - - - - - ";for(let e=0;e<n;e++)for(let e=0;e<this.numCols;e++)i[e]&&0<i[e].length?t+=i[e].shift()+" ":t+="- ";return t}parseNotes(e){var r=(e=e.trim()).split(" ");for(let t=0;t<r.length;t++){for(let e=0;e<this.numRows;e++)this.melody[e][t]=!1;"-"!=r[t]&&(this.melody[i(r[t])][t]=!0)}}setPolyphonic(e){this.polyphonic=e}isPolyphonic(){return this.polyphonic}resetMelody(){this.melody=new Array(this.numCols);for(let e=0;e<this.numCols;e++)this.melody[e]=new Array(this.numRows).fill(!1)}},e.rowToNote=s,e.noteToRow=i,e.getColorClass=function(e){let t="melody-default";switch(e){case 0:t="melody-red";break;case 1:t="melody-orange";break;case 2:t="melody-yellow";break;case 3:t="melody-green";break;case 4:t="melody-teal";break;case 5:t="melody-blue";break;case 6:t="melody-purple";break;case 7:t="melody-violet"}return t}})(pxtmelody=pxtmelody||{}),(s=>{function c(e,t,r){var i=document.createElement(e),n=t,e=r;if(n)for(var s of Object.keys(n))"className"===s?i.setAttribute("class",n[s]+""):i.setAttribute(s,n[s]+"");return e&&i.addEventListener("click",e),i}s.MelodyGallery=class{constructor(){this.value=null,this.visible=!1,this.timeouts=[],this.numSamples=s.SampleMelodies.length,this.containerDiv=document.createElement("div"),this.containerDiv.setAttribute("id","melody-editor-gallery-outer"),this.contentDiv=document.createElement("div"),this.contentDiv.setAttribute("id","melody-editor-gallery"),this.contentDiv.setAttribute("role","menu"),this.contentDiv.setAttribute("tabindex","0"),this.keyDownHandler=this.keyDownListener.bind(this),this.contentDiv.addEventListener("keydown",this.keyDownHandler),this.focusHandler=this.focusListener.bind(this),this.contentDiv.addEventListener("focus",this.focusHandler),this.blurHandler=this.blurListener.bind(this),this.contentDiv.addEventListener("blur",this.blurHandler),this.itemBackgroundColor="#DCDCDC",this.itemBorderColor="white",this.initStyles(),this.containerDiv.appendChild(this.contentDiv),this.containerDiv.style.display="none",this.contentDiv.addEventListener("animationend",()=>{this.visible||(this.containerDiv.style.display="none")}),this.contentDiv.addEventListener("wheel",e=>{e.stopPropagation()},!0)}keyDownListener(e){if(this.selectedColRow){var[t,r]=this.selectedColRow,i=pxt.Util.isUserLanguageRtl()?"ArrowRight":"ArrowLeft",n=pxt.Util.isUserLanguageRtl()?"ArrowLeft":"ArrowRight";switch(e.code){case"ArrowUp":this.selectedColRow=[t,Math.max(0,r-1)];break;case"ArrowDown":this.selectedColRow=[t,Math.min(this.selectionButtons.length-1,r+1)];break;case i:this.selectedColRow=[Math.max(0,t-1),r];break;case n:this.selectedColRow=[Math.min(1,t+1),r];break;case"Enter":case"Space":return this.selectedElement.click(),e.stopPropagation(),void e.preventDefault();default:return}this.selectedElement.classList.remove("selected");var[i,n]=this.selectedColRow,i=(this.selectedElement=(0===i?this.selectionButtons:this.previewButtons)[n],this.selectedElement.classList.add("selected"),this.contentDiv.setAttribute("aria-activedescendant",getCellId(i,n)),this.contentDiv.getBoundingClientRect()),n=this.selectedElement.getBoundingClientRect();n.bottom>i.bottom?this.selectedElement.scrollIntoView({block:"end"}):n.top<i.top&&this.selectedElement.scrollIntoView({block:"start"}),e.stopPropagation(),e.preventDefault()}}focusListener(e){this.selectedElement||(this.selectedColRow=[0,0],this.selectedElement=this.selectionButtons[0]),this.selectedElement.classList.add("selected");var[t,r]=this.selectedColRow;this.contentDiv.setAttribute("aria-activedescendant",getCellId(t,r))}blurListener(e){var t;this.contentDiv.removeAttribute("aria-activedescendant"),null!=(t=this.selectedElement)&&t.classList.remove("selected")}getElement(){return this.containerDiv}getValue(){return this.value}show(e){this.pending=e,this.containerDiv.style.display="block",this.buildDom(),this.visible=!0,pxt.BrowserUtils.removeClass(this.contentDiv,"hidden-above"),pxt.BrowserUtils.addClass(this.contentDiv,"shown")}hide(){var e;this.visible=!1,pxt.BrowserUtils.removeClass(this.contentDiv,"shown"),pxt.BrowserUtils.addClass(this.contentDiv,"hidden-above"),this.value=null,this.stopMelody(),this.contentDiv.removeAttribute("aria-activedescendant"),null!=(e=this.selectedElement)&&e.classList.remove("selected"),this.selectedElement=void 0,this.selectedColRow=void 0}clearDomReferences(){this.contentDiv.removeEventListener("keydown",this.keyDownHandler),this.contentDiv.removeEventListener("focus",this.focusHandler),this.contentDiv.removeEventListener("blur",this.blurHandler),this.contentDiv=null,this.containerDiv=null}layout(e,t,r){this.containerDiv.style.left=e+"px",this.containerDiv.style.top=t+"px",this.containerDiv.style.height=r+"px"}getLastFocusableElement(){return this.contentDiv}buildDom(){for(;this.contentDiv.firstChild;)this.contentDiv.removeChild(this.contentDiv.firstChild);var t=s.SampleMelodies;this.playIcons=[],this.selectionButtons=[],this.previewButtons=[];for(let e=0;e<t.length;e++)this.mkButton(t[e],e,"255px","45px")}initStyles(){var e=document.createElement("style");e.textContent=`
            #melody-editor-gallery {
                margin-top: -100%;
            }

            #melody-editor-gallery.hidden-above {
                margin-top: -100%;
                animation: slide-up 0.2s 0s ease;
            }

            #melody-editor-gallery.shown {
                margin-top: 0px;
                animation: slide-down 0.2s 0s ease;
            }

            @keyframes slide-down {
                0% {
                    margin-top: -100%;
                }
                100% {
                    margin-top: 0px;
                }
            }

            @keyframes slide-up {
                0% {
                    margin-top: 0px;
                }
                100% {
                    margin-top: -100%;
                }
            }
            `,this.containerDiv.appendChild(e)}mkButton(e,t,r,i){var n=c("div",{className:"melody-gallery-button melody-editor-card",id:":"+t}),s=c("i",{className:"music icon melody-icon"}),a=c("div",{className:"melody-editor-text"}),o=(a.innerText=e.name,this.createColorBlock(e)),l=c("div",{className:"melody-editor-button left-button",role:"menuitem",title:e.name,tabIndex:-1,id:getCellId(t,0)},()=>this.handleSelection(e)),s=(l.appendChild(s),l.appendChild(a),l.appendChild(o),n.appendChild(l),this.selectionButtons[t]=l,c("div",{className:"melody-editor-button right-button",role:"menuitem",title:lf("Preview {0}",e.name),tabIndex:-1,id:getCellId(t,1)},()=>this.togglePlay(e,t))),a=c("i",{className:"play icon"});this.playIcons[t]=a,s.appendChild(a),n.appendChild(s),this.previewButtons[t]=s,this.contentDiv.appendChild(n)}handleSelection(e){var t;this.pending&&(t=this.pending,this.pending=void 0,t(e.notes))}playNote(e,t,r){let i=0;switch(e){case"C5":i=523;break;case"B":i=494;break;case"A":i=440;break;case"G":i=392;break;case"F":i=349;break;case"E":i=330;break;case"D":i=294;break;case"C":i=262}this.timeouts.push(setTimeout(()=>{pxt.AudioContextManager.tone(i)},t*this.getDuration(r))),this.timeouts.push(setTimeout(()=>{pxt.AudioContextManager.stop()},(t+1)*this.getDuration(r)))}getDuration(e){return 6e4/e}previewMelody(t){this.stopMelody();var r=t.notes.split(" ");for(let e=0;e<r.length;e++)this.playNote(r[e],e,t.tempo)}togglePlay(e,t){let r=this.playIcons[t];pxt.BrowserUtils.containsClass(r,"play icon")?(this.resetPlayIcons(),pxt.BrowserUtils.removeClass(r,"play icon"),pxt.BrowserUtils.addClass(r,"stop icon"),this.previewMelody(e),this.timeouts.push(setTimeout(()=>{pxt.BrowserUtils.removeClass(r,"stop icon"),pxt.BrowserUtils.addClass(r,"play icon")},e.notes.split(" ").length*this.getDuration(e.tempo)))):(pxt.BrowserUtils.removeClass(r,"stop icon"),pxt.BrowserUtils.addClass(r,"play icon"),this.stopMelody())}stopMelody(){for(;this.timeouts.length;)clearTimeout(this.timeouts.shift());pxt.AudioContextManager.stop()}resetPlayIcons(){for(let e=0;e<this.numSamples;e++){var t=this.playIcons[e];if(pxt.BrowserUtils.containsClass(t,"stop icon")){pxt.BrowserUtils.removeClass(t,"stop icon"),pxt.BrowserUtils.addClass(t,"play icon");break}}}createColorBlock(e){var t=document.createElement("div"),r=(pxt.BrowserUtils.addClass(t,"melody-color-block"),e.notes.split(" "));for(let e=0;e<r.length;e++){var i=s.getColorClass(s.noteToRow(r[e])),n=document.createElement("div");0==e?pxt.BrowserUtils.addClass(n,"left-edge sliver "+i):e==r.length-1?pxt.BrowserUtils.addClass(n,"right-edge sliver "+i):pxt.BrowserUtils.addClass(n,"sliver "+i),t.appendChild(n)}return t}}})(pxtmelody=pxtmelody||{}),(e,t)=>`:${e}-`+(0===t?"selection":"preview"));(e=>{class t{constructor(e,t,r){this.name=e,this.notes=t,this.tempo=r}}e.MelodyInfo=t,e.SampleMelodies=[new t(lf("Scale"),"C5 B A G F E D C",120),new t(lf("Reverse"),"C D E F G A B C5",120),new t(lf("Mystery"),"E B C5 A B G A F",120),new t(lf("Gilroy"),"A F E F D G E F",120),new t(lf("Falling"),"C5 A B G A F G E",120),new t(lf("Hopeful"),"G B A G C5 B A B",120),new t(lf("Tokyo"),"B A G A G F A C5",120),new t(lf("Paris"),"G F G A - F E D",120),new t(lf("Rising"),"E D G F B A C5 B",120),new t(lf("Sitka"),"C5 G B A F A C5 B",120)]})(pxtmelody=pxtmelody||{}),(r=>{{var i=r.accessibility||(r.accessibility={});let t,e=!1;function n(e){var t=window.navigator&&/Mac/i.test(window.navigator.platform)?e.metaKey:e.ctrlKey;return"Escape"===e.key?(e.preventDefault(),"escape"):"/"===e.key&&t?(e.preventDefault(),"togglekeyboardcontrolshelp"):"b"===e.key&&t?(e.preventDefault(),"toggleareamenu"):null}i.makeFocusable=function(e){e.setAttribute("focusable","true"),e.setAttribute("tabindex","0")},i.getGlobalAction=n,i.postKeyboardEvent=function(){e||(e=!0,document.addEventListener("keydown",e=>{e=n(e);e&&r.Runtime.postMessage({type:"action",action:e})}))},i.enableKeyboardInteraction=function(e,t,r){t&&e.addEventListener("keydown",e=>{e="number"==typeof e.which?e.which:e.keyCode;32!==e&&13!==e||t()}),r&&e.addEventListener("keyup",e=>{e="number"==typeof e.which?e.which:e.keyCode;32!==e&&13!==e||r()})},i.setAria=function(e,t,r){t&&!e.hasAttribute("role")&&e.setAttribute("role",t),r&&!e.hasAttribute("aria-label")&&e.setAttribute("aria-label",r)},i.setLiveContent=function(e){t||((t=document.createElement("div")).setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.setAttribute("aria-hidden","false"),t.setAttribute("style","position: absolute !important;display: block;visibility: visible;overflow: hidden;width: 1px;height: 1px;margin: -1px;border: 0;padding: 0;clip: rect(0 0 0 0);"),document.body.appendChild(t)),t.textContent!==e&&(t.textContent=e)}}})(pxsim=pxsim||{}),(h=>{let u="blue",d="orange",t=e=>e.reduce((e,t)=>e+(t?1:0),0),n=e=>0<t(e);function s(e){var e=[e.start,e.end],t=e.map(e=>"ground"===e),r=e.map(e=>"threeVolt"===e),i=e.map(e=>"fiveVolt"===e),e=e.map(t=>{{let e=!1;return"string"!=typeof t&&"breadboard"===t.type&&(t=t.row,e=0<=["a","b","c","d","e"].indexOf(t)),e}}),t=n(t),r=n(r),i=n(i),e=n(e);return{topGround:t&&!e,topThreeVolt:r&&!e,topFiveVolt:i&&!e,bottomGround:t&&e,bottomThreeVolt:r&&e,bottomFiveVolt:i&&e,singleGround:t,singleThreeVolt:r,singleFiveVolt:i}}function p(e,t){var r,i,n={};for(r in e)n[r]=e[r];for(i in t)n[i]=t[i];return n}function c(e){h.U.assert(!!e,"Invalid pin: "+e);e=/^(\w+)\.\s*(?:[a-z]*)?([A-Z][A-Z\d_]+)$/.exec(e);return e?e[2]:void 0}function f(e){return"-Z"===e.orientation&&"male"===e.style}h.readPin=c;class r{constructor(e){this.availablePowerPins={top:{fiveVolt:h.mkRange(26,51).map(e=>({type:"breadboard",row:"+",col:""+e})),threeVolt:h.mkRange(26,51).map(e=>({type:"breadboard",row:"+",col:""+e})),ground:h.mkRange(26,51).map(e=>({type:"breadboard",row:"-",col:""+e}))},bottom:{fiveVolt:h.mkRange(1,26).map(e=>({type:"breadboard",row:"+",col:""+e})),threeVolt:h.mkRange(1,26).map(e=>({type:"breadboard",row:"+",col:""+e})),ground:h.mkRange(1,26).map(e=>({type:"breadboard",row:"-",col:""+e}))}},this.opts=e}allocPartIRs(s,a,d){let o=[],l=(r,e,i,t)=>{var n=[];for(let t=0;t<r.numberOfPins;t++){var s=r.pinDefinitions[t];let e;if("string"==typeof s.target)e=s.target;else{var a=s.target.pinInstantiationIdx;if(!i||void 0===i[a])return void h.log(`error: parts no pin found for PinInstantiationIdx: ${a}. (Is the part missing an ArgumentRole or "trackArgs=" annotations?)`);e=i[a]}var a=r.visual.pinLocations[t],o=d.yOffset+a.y,l=Math.round(o/r.visual.pinDistance),o=o-l*r.visual.pinDistance,c=d.xOffset+a.x,u=Math.round(c/r.visual.pinDistance),c=c-u*r.visual.pinDistance;n.push({def:s,loc:a,target:e,bbFit:{partRelativeRowIdx:l,partRelativeColIdx:u,xOffset:c,yOffset:o}})}return{name:e,def:r,pins:n,partParams:t||{},bbFit:d}};var e=s.instantiations||[];return s.instantiation&&e.push(s.instantiation),e.forEach(e=>{if("singleton"===e.kind)o.push(l(s,a));else if("function"===e.kind){let n=e,t=n.fullyQualifiedName.split(","),r={};t.forEach(e=>{this.opts.fnArgs[e]&&this.opts.fnArgs[e].forEach(e=>{r[e]=1})});e=Object.keys(r);e&&e.length?e.forEach(e=>{e=e.split(",");if(e.length!=n.argumentRoles.length)h.log(`error: parts mismatch between number of arguments at callsite (function name: ${t}) vs number of argument roles in part definition (part: ${a}).`);else{let r=[],i={};e.forEach((e,t)=>{var t=n.argumentRoles[t];void 0!==t.partParameter&&(i[t.partParameter]=e),void 0!==t.pinInstantiationIdx&&(t=t.pinInstantiationIdx,e=c(e),r[t]=e)}),o.push(l(s,a,r,i))}}):h.log("error: parts failed to read pin(s) from callsite for: "+t)}}),o.filter(e=>!!e)}computePartDimensions(e,t){var r=e.visual.pinLocations;let i=e.pinDefinitions;var n=e.numberOfPins;h.U.assert(r.length===n,`Mismatch between "numberOfPins" and length of "visual.pinLocations" for "${t}"`),h.U.assert(i.length===n,`Mismatch between "numberOfPins" and length of "pinDefinitions" for "${t}"`),h.U.assert(0<n,`Part "${t}" has no pins`);var s,n=r.map((e,t)=>{return r={idx:t},e=e,t=i[t],p(p(r,e),t);var r}).filter(e=>"-Z"===e.orientation),t=0<n.length,r=e.visual.pinDistance;let a,o,l,c;return t?(t=n[0],n=Math.ceil(t.x/r),s=Math.ceil(t.y/r),a=n*r-t.x,o=s*r-t.y,l=Math.ceil((a+e.visual.width)/r)+1,c=Math.ceil((o+e.visual.height)/r)+1):(l=Math.ceil(e.visual.width/r),c=Math.ceil(e.visual.height/r),a=l*r-e.visual.width,o=c*r-e.visual.height),{xOffset:a,yOffset:o,rowCount:c,colCount:l}}allocColumns(e){var t=e.length,r=h.visuals.BREADBOARD_MID_COLS-e.map(e=>e.colCount).reduce((e,t)=>e+t,0),i=(r<=0&&h.log("Not enough breadboard space!"),Math.floor(r/(t-1+2)));let n=i;i=r-n*(t-1),r=Math.floor(i/2);Math.ceil(i/2);let s=1+r;return e.map(e=>{var t=s;return s+=e.colCount+n,t})}placeParts(e){let r=h.visuals.BREADBOARD_MID_ROWS+2,i=this.allocColumns(e.map(e=>e.bbFit)),n=e.map(e=>{e=r-e.bbFit.rowCount;let t=Math.floor(e/2);return t=(t=4<t?4:t)<1?1:t});return e.map((e,t)=>{var r=n[t];return p({startColumnIdx:i[t],startRowIdx:r},e)})}nextColor(){return(!this.availableWireColors||this.availableWireColors.length<=0)&&(this.availableWireColors=h.visuals.GPIO_WIRE_COLORS.map(e=>e)),this.availableWireColors.pop()}allocWireIRs(o){let l=[];var e=o.pins.map((e,t)=>{var r=e.target;let i;var n=o.startColumnIdx+e.bbFit.partRelativeColIdx,n=h.visuals.getColumnName(n);let s=o.startRowIdx+e.bbFit.partRelativeRowIdx;7<=s&&(s-=2),i=f(e.def)?{type:"breadboard",row:s<5?"j":"a",col:n,style:e.def.style}:{type:"breadboard",row:h.visuals.getRowName(s),col:n,xOffset:e.bbFit.xOffset/o.def.visual.pinDistance,yOffset:e.bbFit.yOffset/o.def.visual.pinDistance,style:e.def.style};let a;return a="ground"===r?u:"threeVolt"===r?"red":"fiveVolt"===r?d:"number"==typeof e.def.colorGroup?l[e.def.colorGroup]||(l[e.def.colorGroup]=this.nextColor()):this.nextColor(),{start:i,end:r,color:a,pinIdx:t}});return p(o,{wires:e})}allocLocation(t,r){if("ground"===t||"threeVolt"===t||"fiveVolt"==t){if("ground"===t&&this.powerUsage.singleGround)return{type:"dalboard",pin:this.getBoardGroundPin()};if("threeVolt"===t&&this.powerUsage.singleThreeVolt)return{type:"dalboard",pin:this.getBoardThreeVoltPin()};if("fiveVolt"===t&&this.powerUsage.singleFiveVolt)return{type:"dalboard",pin:this.getBoardFiveVoltPin()};h.U.assert(!!r.referenceBBPin);var r=this.opts.getBBCoord(r.referenceBBPin),i=[this.availablePowerPins.top.ground[0]||this.availablePowerPins.top.threeVolt[0],this.availablePowerPins.bottom.ground[0]||this.availablePowerPins.bottom.threeVolt[0]].map(e=>this.opts.getBBCoord(e)),i=(i[0]&&i[1]||h.debug(`No more available "${t}" locations!`),0==h.visuals.findClosestCoordIdx(r,i));let e;i?"ground"===t?e=this.availablePowerPins.top.ground:"threeVolt"===t?e=this.availablePowerPins.top.threeVolt:"fiveVolt"===t&&(e=this.availablePowerPins.top.fiveVolt):"ground"===t?e=this.availablePowerPins.bottom.ground:"threeVolt"===t?e=this.availablePowerPins.bottom.threeVolt:"fiveVolt"===t&&(e=this.availablePowerPins.bottom.fiveVolt);var n=e.map(e=>this.opts.getBBCoord(e)),r=h.visuals.findClosestCoordIdx(r,n),n=e[r];return(i?(this.availablePowerPins.top.ground.splice(r,1),this.availablePowerPins.top):(this.availablePowerPins.bottom.ground.splice(r,1),this.availablePowerPins.bottom)).threeVolt.splice(r,1),n}if("breadboard"===t.type)return t;if("MOSI"===t||"MISO"===t||"SCK"===t)return this.opts.boardDef.spiPins||h.debug("No SPI pin mappings found!"),{type:"dalboard",pin:this.opts.boardDef.spiPins[t]};if("SDA"===t||"SCL"===t)return this.opts.boardDef.i2cPins||h.debug("No I2C pin mappings found!"),{type:"dalboard",pin:this.opts.boardDef.i2cPins[t]};h.U.assert("string"==typeof t,"Unknown location type: "+t);i=this.opts.boardDef.gpioPinMap[t]||t;if(i)return{type:"dalboard",pin:i};h.debug("unknown pin location for "+t)}getBoardGroundPin(){var e=this.opts.boardDef.groundPins&&this.opts.boardDef.groundPins[0]||null;return e||h.debug("No available ground pin on board!"),e}getBoardThreeVoltPin(){var e=this.opts.boardDef.threeVoltPins&&this.opts.boardDef.threeVoltPins[0]||null;return e||h.debug("No available 3.3V pin on board!"),e}getBoardFiveVoltPin(){var e=this.opts.boardDef.fiveVoltPins&&this.opts.boardDef.fiveVoltPins[0]||null;return e||h.debug("No available 5V pin on board!"),e}allocPowerWires(e){var t=this.getBoardGroundPin(),r=this.getBoardThreeVoltPin(),i=this.getBoardFiveVoltPin();let n,s;s=this.opts.boardDef.attachPowerOnRight?(n={type:"breadboard",row:"-",col:"50"},{type:"breadboard",row:"-",col:"25"}):(n={type:"breadboard",row:"-",col:"26"},{type:"breadboard",row:"-",col:"1"});var a=[];let o=[];var l=[],t=(e.bottomGround&&e.topGround&&a.push({start:this.allocLocation("ground",{referenceBBPin:n}),end:this.allocLocation("ground",{referenceBBPin:s}),color:u}),e.topGround?a.push({start:this.allocLocation("ground",{referenceBBPin:n}),end:{type:"dalboard",pin:t},color:u}):e.bottomGround&&a.push({start:this.allocLocation("ground",{referenceBBPin:s}),end:{type:"dalboard",pin:t},color:u}),e.bottomThreeVolt&&e.bottomGround?o.push({start:this.allocLocation("threeVolt",{referenceBBPin:n}),end:this.allocLocation("threeVolt",{referenceBBPin:s}),color:"red"}):e.bottomFiveVolt&&e.bottomGround&&l.push({start:this.allocLocation("fiveVolt",{referenceBBPin:n}),end:this.allocLocation("fiveVolt",{referenceBBPin:s}),color:d}),e.topThreeVolt?o.push({start:this.allocLocation("threeVolt",{referenceBBPin:n}),end:{type:"dalboard",pin:r},color:"red"}):e.bottomThreeVolt&&o.push({start:this.allocLocation("threeVolt",{referenceBBPin:s}),end:{type:"dalboard",pin:r},color:d}),e.topFiveVolt&&!e.topThreeVolt?l.push({start:this.allocLocation("fiveVolt",{referenceBBPin:n}),end:{type:"dalboard",pin:i},color:"red"}):e.bottomFiveVolt&&!e.bottomThreeVolt&&l.push({start:this.allocLocation("fiveVolt",{referenceBBPin:s}),end:{type:"dalboard",pin:i},color:d}),[]);0<a.length&&t.push({wireIndices:a.map((e,t)=>t)});let c=a.length;return 0<o.length&&t.push({wireIndices:o.map((e,t)=>t+c)}),0<l.length&&t.push({wireIndices:o.map((e,t)=>t+c+o.length)}),{wires:a.concat(o).concat(l),assembly:t}}allocWire(e){let r=[e.start,e.end],i=r.map(e=>"ground"===e||"threeVolt"===e||"fiveVolt"===e),n=r.map((e,t)=>i[t]?void 0:this.allocLocation(e,{}));if((n=n.map((e,t)=>e||(e=n[1-t],this.allocLocation(r[t],{referenceBBPin:e}))))[0]&&n[1])return{start:n[0],end:n[1],color:e.color}}allocPart(i){var e=i.pins.filter(e=>f(e.def)).map(e=>{let t=i.startRowIdx+e.bbFit.partRelativeRowIdx;7<=t&&(t-=2);var r=h.visuals.getRowName(t),e=i.startColumnIdx+e.bbFit.partRelativeColIdx;return{type:"breadboard",row:r,col:h.visuals.getColumnName(e)}});return{name:i.name,visual:i.def.visual,bbFit:i.bbFit,startColumnIdx:i.startColumnIdx,startRowIdx:i.startRowIdx,breadboardConnections:e,params:i.partParams,simulationBehavior:i.def.simulationBehavior}}allocAll(){var e=this.opts.partsList.map(e=>({name:e,def:this.opts.partDefs[e]})).filter(e=>!!e.def);if(0<e.length){let r=e.map(e=>this.computePartDimensions(e.def,e.name)),i=[];e.forEach((e,t)=>{t=r[t],e=this.allocPartIRs(e.def,e.name,t);i=i.concat(e)});var e=this.placeParts(i).map(e=>this.allocWireIRs(e)),t=e.map(e=>e.wires).reduce((e,t)=>e.concat(t),[]).map(e=>s(e)),t=(this.powerUsage=((t=(t=t).reduce((e,t)=>({topGround:e.topGround||t.topGround,topThreeVolt:e.topThreeVolt||t.topThreeVolt,topFiveVolt:e.topFiveVolt||t.topFiveVolt,bottomGround:e.bottomGround||t.bottomGround,bottomThreeVolt:e.bottomThreeVolt||t.bottomThreeVolt,bottomFiveVolt:e.bottomFiveVolt||t.bottomFiveVolt,singleGround:t.singleGround?null===e.singleGround:e.singleGround,singleThreeVolt:t.singleThreeVolt?null===e.singleThreeVolt:e.singleThreeVolt,singleFiveVolt:t.singleFiveVolt?null===e.singleFiveVolt:e.singleFiveVolt}),{topGround:!1,topThreeVolt:!1,topFiveVolt:!1,bottomGround:!1,bottomThreeVolt:!1,bottomFiveVolt:!1,singleGround:null,singleThreeVolt:null,singleFiveVolt:null})).singleGround&&(t.topGround=t.bottomGround=!1),t.singleThreeVolt&&(t.topThreeVolt=t.bottomThreeVolt=!1),t.singleFiveVolt&&(t.topFiveVolt=t.bottomFiveVolt=!1),t),this.allocPowerWires(this.powerUsage)),e=e.map((e,t)=>{var i=this.allocPart(e),n=e.wires.map(e=>this.allocWire(e));if(!n.some(e=>!e)){let r=[];return e.wires.forEach((e,t)=>{r[e.pinIdx]=t}),{part:i,wires:n,assembly:e.def.assembly.map(e=>({part:e.part,wireIndices:(e.pinIndices||[]).map(e=>r[e])}))}}}).filter(e=>!!e),t=[t].concat(e).filter(e=>e.assembly&&e.assembly.length),e=!t.some(e=>e.part&&e.part.breadboardConnections&&0<e.part.breadboardConnections.length||e.wires&&e.wires.some(e=>"breadboard"==e.end.type&&"croc"!=e.end.style||"breadboard"==e.start.type&&"croc"!=e.start.style));return{partsAndWires:t,wires:[],parts:[],hideBreadboard:e}}return{partsAndWires:[],wires:[],parts:[]}}}h.allocateDefinitions=function(e){return new r(e).allocAll()}})(pxsim=pxsim||{}),(t=>{{var s=t.protocol||(t.protocol={});class e{constructor(e){this.seq=0,this.type=e}}s.Message=e;class r extends e{constructor(e,t){super("response"),this.request_seq=e.seq,this.command=e.command,t?(this.success=!1,this.message=t):this.success=!0}}s.Response=r;class i extends e{constructor(e,t){super("event"),this.event=e,t&&(this.body=t)}}s.Event=i,s.Source=class{constructor(e,t,r=0,i,n){this.name=e,this.path=t,this.sourceReference=r,i&&(this.origin=i),n&&(this.adapterData=n)}},s.Scope=class{constructor(e,t,r=!1){this.name=e,this.variablesReference=t,this.expensive=r}},s.StackFrame=class{constructor(e,t,r,i=0,n=0){this.id=e,this.source=r,this.line=i,this.column=n,this.name=t}},s.Thread=class{constructor(e,t){this.id=e,this.name=t||"Thread #"+e}},s.Variable=class{constructor(e,t,r=0,i,n){this.name=e,this.value=t,this.variablesReference=r,"number"==typeof n&&(this.namedVariables=n),"number"==typeof i&&(this.indexedVariables=i)}},s.Breakpoint=class{constructor(e,t,r,i){this.verified=e;"number"==typeof t&&(this.line=t),"number"==typeof r&&(this.column=r),i&&(this.source=i)}},s.Module=class{constructor(e,t){this.id=e,this.name=t}},s.CompletionItem=class{constructor(e,t,r=0){this.label=e,this.start=t,this.length=r}};class n extends i{constructor(e,t,r=null){super("stopped"),this.body={reason:e,threadId:t},r&&(this.body.text=r)}}s.StoppedEvent=n;class a extends i{constructor(e,t){super("continued"),this.body={threadId:e},"boolean"==typeof t&&(this.body.allThreadsContinued=t)}}s.ContinuedEvent=a;class o extends i{constructor(){super("initialized")}}s.InitializedEvent=o;class l extends i{constructor(e){super("terminated"),"boolean"==typeof e&&(this.body={restart:e})}}s.TerminatedEvent=l;class c extends i{constructor(e,t="console",r){super("output"),this.body={category:t,output:e},void 0!==r&&(this.body.data=r)}}s.OutputEvent=c;class u extends i{constructor(e,t){super("thread"),this.body={reason:e,threadId:t}}}s.ThreadEvent=u;class d extends i{constructor(e,t){super("breakpoint"),this.body={reason:e,breakpoint:t}}}s.BreakpointEvent=d;class h extends i{constructor(e,t){super("module"),this.body={reason:e,module:t}}}s.ModuleEvent=h;class p{constructor(){this._pendingRequests={}}start(e){this._sequence=1,this.host=e,this.host.onData(e=>{var t;"request"===e.type?this.dispatchRequest(e):"response"===e.type&&(t=this._pendingRequests[(e=e).seq])&&(delete this._pendingRequests[e.seq],t(e))})}stop(){this.host&&this.host.close()}sendEvent(e){this.send("event",e)}sendResponse(e){0<e.seq?t.error("attempt to send more than one response for command "+e.command):this.send("response",e)}sendRequest(e,t,r,i){let n={command:e};if(t&&0<Object.keys(t).length&&(n.arguments=t),this.send("request",n),i){this._pendingRequests[n.seq]=i;let t=setTimeout(()=>{clearTimeout(t);var e=this._pendingRequests[n.seq];e&&(delete this._pendingRequests[n.seq],e(new s.Response(n,"timeout")))},r)}}send(e,t){t.type=e,t.seq=this._sequence++,this.host&&(e=JSON.stringify(t),this.host.send(e))}dispatchRequest(e){}}s.ProtocolServer=p;class f extends p{constructor(){super(...arguments),this._debuggerLinesStartAt1=!1,this._debuggerColumnsStartAt1=!1,this._clientLinesStartAt1=!0,this._clientColumnsStartAt1=!0}shutdown(){}dispatchRequest(e){var t,r,i=new s.Response(e);try{"initialize"===e.command?("boolean"==typeof(t=e.arguments).linesStartAt1&&(this._clientLinesStartAt1=t.linesStartAt1),"boolean"==typeof t.columnsStartAt1&&(this._clientColumnsStartAt1=t.columnsStartAt1),"path"!==t.pathFormat?this.sendErrorResponse(i,2018,"debug adapter only supports native paths",null):((r=i).body={},this.initializeRequest(r,t))):"launch"===e.command?this.launchRequest(i,e.arguments):"attach"===e.command?this.attachRequest(i,e.arguments):"disconnect"===e.command?this.disconnectRequest(i,e.arguments):"setBreakpoints"===e.command?this.setBreakPointsRequest(i,e.arguments):"setFunctionBreakpoints"===e.command?this.setFunctionBreakPointsRequest(i,e.arguments):"setExceptionBreakpoints"===e.command?this.setExceptionBreakPointsRequest(i,e.arguments):"configurationDone"===e.command?this.configurationDoneRequest(i,e.arguments):"continue"===e.command?this.continueRequest(i,e.arguments):"next"===e.command?this.nextRequest(i,e.arguments):"stepIn"===e.command?this.stepInRequest(i,e.arguments):"stepOut"===e.command?this.stepOutRequest(i,e.arguments):"stepBack"===e.command?this.stepBackRequest(i,e.arguments):"restartFrame"===e.command?this.restartFrameRequest(i,e.arguments):"goto"===e.command?this.gotoRequest(i,e.arguments):"pause"===e.command?this.pauseRequest(i,e.arguments):"stackTrace"===e.command?this.stackTraceRequest(i,e.arguments):"scopes"===e.command?this.scopesRequest(i,e.arguments):"variables"===e.command?this.variablesRequest(i,e.arguments):"setVariable"===e.command?this.setVariableRequest(i,e.arguments):"source"===e.command?this.sourceRequest(i,e.arguments):"threads"===e.command?this.threadsRequest(i):"evaluate"===e.command?this.evaluateRequest(i,e.arguments):"stepInTargets"===e.command?this.stepInTargetsRequest(i,e.arguments):"gotoTargets"===e.command?this.gotoTargetsRequest(i,e.arguments):"completions"===e.command?this.completionsRequest(i,e.arguments):this.customRequest(e.command,i,e.arguments)}catch(e){this.sendErrorResponse(i,1104,"{_stack}",{_exception:e.message,_stack:e.stack})}}initializeRequest(e,t){e.body.supportsConditionalBreakpoints=!1,e.body.supportsHitConditionalBreakpoints=!1,e.body.supportsFunctionBreakpoints=!1,e.body.supportsConfigurationDoneRequest=!0,e.body.supportsEvaluateForHovers=!1,e.body.supportsStepBack=!1,e.body.supportsSetVariable=!1,e.body.supportsRestartFrame=!1,e.body.supportsStepInTargetsRequest=!1,e.body.supportsGotoTargetsRequest=!1,e.body.supportsCompletionsRequest=!1,this.sendResponse(e)}disconnectRequest(e,t){this.sendResponse(e),this.shutdown()}launchRequest(e,t){this.sendResponse(e)}attachRequest(e,t){this.sendResponse(e)}setBreakPointsRequest(e,t){this.sendResponse(e)}setFunctionBreakPointsRequest(e,t){this.sendResponse(e)}setExceptionBreakPointsRequest(e,t){this.sendResponse(e)}configurationDoneRequest(e,t){this.sendResponse(e)}continueRequest(e,t){this.sendResponse(e)}nextRequest(e,t){this.sendResponse(e)}stepInRequest(e,t){this.sendResponse(e)}stepOutRequest(e,t){this.sendResponse(e)}stepBackRequest(e,t){this.sendResponse(e)}restartFrameRequest(e,t){this.sendResponse(e)}gotoRequest(e,t){this.sendResponse(e)}pauseRequest(e,t){this.sendResponse(e)}sourceRequest(e,t){this.sendResponse(e)}threadsRequest(e){this.sendResponse(e)}stackTraceRequest(e,t){this.sendResponse(e)}scopesRequest(e,t){this.sendResponse(e)}variablesRequest(e,t){this.sendResponse(e)}setVariableRequest(e,t){this.sendResponse(e)}evaluateRequest(e,t){this.sendResponse(e)}stepInTargetsRequest(e,t){this.sendResponse(e)}gotoTargetsRequest(e,t){this.sendResponse(e)}completionsRequest(e,t){this.sendResponse(e)}customRequest(e,t,r){this.sendErrorResponse(t,1014,"unrecognized request",null)}sendErrorResponse(e,t,r,i){let n;"number"==typeof t?(n={id:t,format:r},i&&(n.variables=i),n.showUser=!0):n=t,e.success=!1,f.formatPII(n.format,!0,n.variables),e.body||(e.body={}),e.body.error=n,this.sendResponse(e)}convertClientLineToDebugger(e){return this._debuggerLinesStartAt1?this._clientLinesStartAt1?e:e+1:this._clientLinesStartAt1?e-1:e}convertDebuggerLineToClient(e){return this._debuggerLinesStartAt1?this._clientLinesStartAt1?e:e-1:this._clientLinesStartAt1?e+1:e}convertClientColumnToDebugger(e){return this._debuggerColumnsStartAt1?this._clientColumnsStartAt1?e:e+1:this._clientColumnsStartAt1?e-1:e}convertDebuggerColumnToClient(e){return this._debuggerColumnsStartAt1?this._clientColumnsStartAt1?e:e-1:this._clientColumnsStartAt1?e+1:e}convertClientPathToDebugger(e){return this._clientPathsAreURIs!=this._debuggerPathsAreURIs?this._clientPathsAreURIs?f.uri2path(e):f.path2uri(e):e}convertDebuggerPathToClient(e){return this._debuggerPathsAreURIs!=this._clientPathsAreURIs?this._debuggerPathsAreURIs?f.uri2path(e):f.path2uri(e):e}static path2uri(e){let t=e.replace(/\\/g,"/");return"/"!==t[0]&&(t="/"+t),encodeURI("file://"+t)}static uri2path(e){return e}static formatPII(e,r,i){return e.replace(f._formatPIIRegexp,function(e,t){return!(r&&0<t.length&&"_"!==t[0])&&i[t]&&i.hasOwnProperty(t)?i[t]:e})}}f._formatPIIRegexp=/{([^}]+)}/g,s.DebugSession=f}})(pxsim=pxsim||{}),(e=>{function o(e){e=e.replace(/\\/g,"/");let t=[];return e.split("/").forEach(e=>{".."===e&&t.length?t.pop():e&&"."!==e&&t.push(e)}),t}(e=e.util||(e.util={})).injectPolyphils=function(){String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{value:function(e,t){return void 0!==e&&null!=e&&this.substring(t=!t||t<0?0:+t,t+e.length)===e}}),Array.prototype.fill||Object.defineProperty(Array.prototype,"fill",{writable:!0,enumerable:!0,value:function(e){if(null==this)throw new TypeError("this is null or not defined");var t=Object(this),r=t.length>>>0,i=arguments[1]>>0;let n=i<0?Math.max(r+i,0):Math.min(i,r);for(var i=arguments[2],i=void 0===i?r:i>>0,s=i<0?Math.max(r+i,0):Math.min(i,r);n<s;)t[n]=e,n++;return t}}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{writable:!0,enumerable:!0,value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),r=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");var i=arguments[1];let n=0;for(;n<r;){var s=t[n];if(e.call(i,s,n,t))return s;n++}}}),Uint8Array.prototype.slice||Object.defineProperty(Uint8Array.prototype,"slice",{value:Array.prototype.slice,writable:!0,enumerable:!0}),Uint16Array.prototype.slice||Object.defineProperty(Uint16Array.prototype,"slice",{value:Array.prototype.slice,writable:!0,enumerable:!0}),Uint32Array.prototype.slice||Object.defineProperty(Uint32Array.prototype,"slice",{value:Array.prototype.slice,writable:!0,enumerable:!0}),Uint8Array.prototype.fill||Object.defineProperty(Uint8Array.prototype,"fill",{value:Array.prototype.fill,writable:!0,enumerable:!0}),Uint16Array.prototype.fill||Object.defineProperty(Uint16Array.prototype,"fill",{value:Array.prototype.fill,writable:!0,enumerable:!0}),Uint32Array.prototype.fill||Object.defineProperty(Uint32Array.prototype,"fill",{value:Array.prototype.fill,writable:!0,enumerable:!0}),Uint8Array.prototype.some||Object.defineProperty(Uint8Array.prototype,"some",{value:Array.prototype.some,writable:!0,enumerable:!0}),Uint16Array.prototype.some||Object.defineProperty(Uint16Array.prototype,"some",{value:Array.prototype.some,writable:!0,enumerable:!0}),Uint32Array.prototype.some||Object.defineProperty(Uint32Array.prototype,"some",{value:Array.prototype.some,writable:!0,enumerable:!0}),Uint8Array.prototype.reverse||Object.defineProperty(Uint8Array.prototype,"reverse",{value:Array.prototype.reverse,writable:!0,enumerable:!0}),Uint16Array.prototype.reverse||Object.defineProperty(Uint16Array.prototype,"reverse",{value:Array.prototype.reverse,writable:!0,enumerable:!0}),Uint32Array.prototype.reverse||Object.defineProperty(Uint32Array.prototype,"reverse",{value:Array.prototype.reverse,writable:!0,enumerable:!0}),Math.imul||(Math.imul=function(e,t){var r=65535&e,i=65535&t;return r*i+((e>>>16&65535)*i+r*(t>>>16&65535)<<16>>>0)|0}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");var r=Object(e);for(let e=1;e<arguments.length;e++){var i=arguments[e];if(null!=i)for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r[n]=i[n])}return r},writable:!0,configurable:!0}),Promise.prototype.finally||(Promise.prototype.finally=Promise.prototype.finally||{finally(t){let r=e=>Promise.resolve(t()).then(e);return this.then(e=>r(()=>e),e=>r(()=>Promise.reject(e)))}}.finally)},e.Lazy=class{constructor(e){this._func=e,this._evaluated=!1}get value(){return this._evaluated||(this._value=this._func(),this._evaluated=!0),this._value}},e.getNormalizedParts=o,e.normalizePath=function(e){return o(e).join("/")},e.relativePath=function(e,t){var r=o(e),i=o(t);let n=0;for(;r[n]===i[n]&&++n!==r.length&&n!==i.length;);var s=r.slice(n),a=i.slice(n);for(let e=0;e<s.length;e++)a.unshift("..");return a.join("/")},e.pathJoin=function(...e){let t="";return e.forEach(e=>{e.replace(/\\/g,"/"),e.lastIndexOf("/")===e.length-1&&(e=e.slice(0,e.length-1)),t+="/"+e}),t},e.toArray=function(t){if(Array.isArray(t))return t;var r=[];for(let e=0;e<t.length;++e)r.push(t[e]);return r}})(pxsim=pxsim||{}),(d=>{function h(e,t){switch(typeof e){case"string":case"number":case"boolean":return e;case"function":return{text:"(function)",type:"function"};case"undefined":return null;case"object":var r,i;return e?e instanceof d.RefObject?(t&&(t[e.id]=e),i=(r=d.RefObject.toDebugString(e)).startsWith("[")?"array":r,{id:e.id,preview:r,hasFields:null!==e.fields||r.startsWith("["),type:i}):e._width&&e._height?{text:e._width+"x"+e._height,type:"image"}:{text:"(object)",type:"object"}:null;default:throw new Error}}function a(e,i,t,n,s=!1){{var a=e,o;e=t;let r={};for(o of Object.keys(a))/^__/.test(o)||!/___\d+$/.test(o)||n&&-1===n.indexOf(o)||(r[o]=h(a[o],i));if(a.fields&&e)for(var l of e)l=l.substring(l.lastIndexOf(".")+1),r[l]=h(((e,t)=>{let r={pc:0,arg0:t,fn:e,parent:{}};for(;r.fn;)r=r.fn(r);return r.retval})(a.vtable.iface[l],a),i);if(a.fields)for(var c of Object.keys(a.fields).filter(e=>s||!e.startsWith("_")))r[c]=h(a.fields[c],i);else if(a instanceof d.RefMap)for(var u of a.data)r[u.key]=h(u.val,i);else Array.isArray(a.data)?a.data.forEach((e,t)=>{r[t]=h(e,i)}):void 0!==a._width&&void 0!==a._height&&(r.width=a._width,r.height=a._height,s)&&void 0!==a._bpp&&(r.isMono=1===a._bpp);return r}}d.getWarningMessage=function(e){var t={type:"debugger",subtype:"warning",breakpointIds:[],message:e};let r=d.runtime.currFrame;for(;null!=r;)t.breakpointIds.push(r.lastBrkId),r=r.parent;return t},d.BreakpointMap=class{constructor(e){for(var t in this.fileMap={},this.idMap={},e.forEach(e=>{var[t,r]=e;this.fileMap[r.source.path]||(this.fileMap[r.source.path]=[]),this.fileMap[r.source.path].push(e),this.idMap[t]=r}),this.fileMap){var r=this.fileMap[t];this.fileMap[t]=r.sort(([,e],[,t])=>e.line===t.line?t.endLine===e.endLine?e.column-t.column:t.endLine-e.endLine:e.line-t.line)}}getById(e){return this.idMap[e]}verifyBreakpoint(e,t){e=this.fileMap[e];let r;if(e)for(var[i,n]of e)n.line<=t.line&&n.endLine>=t.line&&(r=[i,n]);return r?(r[1].verified=!0,r):[-1,{verified:!1}]}},d.dumpHeap=a,d.injectEnvironmentGlobals=function(e,r){var i=d.runtime.environmentGlobals;if(Object.keys(i).length){let t=e.environmentGlobals={};Object.keys(i).forEach(e=>t[e]=h(d.runtime.environmentGlobals[e],r))}},d.getBreakpointMsg=function(e,t,r){for(var i={},n={type:"debugger",subtype:"breakpoint",breakpointId:t,globals:a(d.runtime.globals,i,void 0,r),stackframes:[]};null!=e;){var s=((r,i)=>{var e,t,n=r.fn?r.fn.info:null;if(n)return e={thisParam:h(r.argL,i),params:[]},n.argumentNames&&(t=n.argumentNames,e.params=t.map((e,t)=>({name:e,value:h(r["arg"+t],i)}))),{locals:a(r,i),funcInfo:n,breakpointId:r.lastBrkId,callLocationId:r.callLocIdx,arguments:e}})(e,i);s&&n.stackframes.push(s),e=e.parent}return{msg:n,heap:i}};class t extends d.protocol.DebugSession{constructor(e){super(),this.driver=new d.SimulatorDriver(e,{onDebuggerBreakpoint:e=>this.onDebuggerBreakpoint(e),onDebuggerWarning:e=>this.onDebuggerWarning(e),onDebuggerResume:()=>this.onDebuggerResume(),onStateChanged:e=>this.onStateChanged(e)})}runCode(e,t,r,i,n){this.breakpoints=i,this.projectDir&&this.fixBreakpoints(),this.sendEvent(new d.protocol.InitializedEvent),this.driver.run(e,{parts:t,fnArgs:r,boardDefinition:n})}stopSimulator(e=!1){this.driver.stop(e)}initializeRequest(e,t){e.body.supportsConditionalBreakpoints=!1,e.body.supportsHitConditionalBreakpoints=!1,e.body.supportsFunctionBreakpoints=!1,e.body.supportsEvaluateForHovers=!1,e.body.supportsStepBack=!1,e.body.supportsSetVariable=!1,e.body.supportsRestartFrame=!1,e.body.supportsStepInTargetsRequest=!1,e.body.supportsGotoTargetsRequest=!1,e.body.supportsCompletionsRequest=!1,e.body.supportsConfigurationDoneRequest=!0,this.sendResponse(e)}disconnectRequest(e,t){this.sendResponse(e),this.shutdown()}launchRequest(e,t){this.projectDir||(this.projectDir=d.util.normalizePath(t.projectDir),this.breakpoints&&this.fixBreakpoints()),this.sendResponse(e)}setBreakPointsRequest(r,i){r.body={breakpoints:[]};let n=[];i.breakpoints.forEach(e=>{var t;this.breakpoints?([e,t]=this.breakpoints.verifyBreakpoint(d.util.relativePath(this.projectDir,i.source.path),e),r.body.breakpoints.push(t),t.verified&&n.push(e)):r.body.breakpoints.push({verified:!1})}),this.driver.setBreakpoints(n),this.sendResponse(r)}continueRequest(e,t){this.driver.resume(d.SimulatorDebuggerCommand.Resume),this.sendResponse(e)}nextRequest(e,t){this.driver.resume(d.SimulatorDebuggerCommand.StepOver),this.sendResponse(e)}stepInRequest(e,t){this.driver.resume(d.SimulatorDebuggerCommand.StepInto),this.sendResponse(e)}stepOutRequest(e,t){this.driver.resume(d.SimulatorDebuggerCommand.StepOut),this.sendResponse(e)}pauseRequest(e,t){this.driver.resume(d.SimulatorDebuggerCommand.Pause),this.sendResponse(e)}threadsRequest(e){e.body={threads:[{id:t.THREAD_ID,name:"main"}]},this.sendResponse(e)}stackTraceRequest(e,t){var r;this.lastBreak&&(r=this.state.getFrames(),e.body={stackFrames:r}),this.sendResponse(e)}scopesRequest(e,t){this.state&&(e.body={scopes:this.state.getScopes(t.frameId)}),this.sendResponse(e)}variablesRequest(e,t){this.state&&(e.body={variables:this.state.getVariables(t.variablesReference)}),this.sendResponse(e)}onDebuggerBreakpoint(e){this.lastBreak=e,this.state=new r(this.lastBreak,this.breakpoints,this.projectDir),e.exceptionMessage?(e=e.exceptionMessage.replace(/___\d+/g,""),this.sendEvent(new d.protocol.StoppedEvent("exception",t.THREAD_ID,e))):this.sendEvent(new d.protocol.StoppedEvent("breakpoint",t.THREAD_ID))}onDebuggerWarning(e){}onDebuggerResume(){this.sendEvent(new d.protocol.ContinuedEvent(t.THREAD_ID,!0))}onStateChanged(e){switch(e){case d.SimulatorState.Paused:break;case d.SimulatorState.Running:this.sendEvent(new d.protocol.ContinuedEvent(t.THREAD_ID,!0));break;case d.SimulatorState.Stopped:this.sendEvent(new d.protocol.TerminatedEvent)}}fixBreakpoints(){for(var e in this.breakpoints.idMap){e=this.breakpoints.idMap[e];e.source.path=d.util.pathJoin(this.projectDir,e.source.path),e.line=this.convertDebuggerLineToClient(e.line),e.endLine=this.convertDebuggerLineToClient(e.endLine),e.column=this.convertDebuggerColumnToClient(e.column),e.endColumn=this.convertDebuggerColumnToClient(e.endColumn)}}}t.THREAD_ID=1,d.SimDebugSession=t;class r{constructor(e,t,r){this._message=e,this._map=t,this._dir=r,this._currentId=1,this._frames={},this._vars={};e=this.nextId();this._vars[e]=this.getVariableValues(this._message.globals),this._globalScope={name:"Globals",variablesReference:e,expensive:!1}}getFrames(){return this._message.stackframes.map((e,t)=>{var r=this._map.getById(e.breakpointId);if(r)return{id:(this._frames[e.breakpointId]=e).breakpointId,name:e.funcInfo?e.funcInfo.functionName:0===t?"main":"anonymous",line:r.line,column:r.column,endLine:r.endLine,endColumn:r.endLine,source:r.source}}).filter(e=>!!e)}getScopes(e){var t,e=this._frames[e];return e?(t=this.nextId(),this._vars[t]=this.getVariableValues(e.locals),[{name:"Locals",variablesReference:t,expensive:!1},this._globalScope]):[this._globalScope]}getVariables(e){e=this._vars[e];return e&&e.value||[]}getVariableValues(s){return new d.util.Lazy(()=>{var r,i=[];for(r in s){var n=s[r];let e,t=0;null===n?e="null":void 0===n?e="undefined":"object"==typeof n?(e="(object)",t=this.nextId(),this._vars[t]=this.getVariableValues(n)):e=n.toString();n=r.substr(0,r.lastIndexOf("___"));i.push({name:n,value:e,variablesReference:t})}return i})}nextId(){return this._currentId++}}})(pxsim=pxsim||{}),(a=>{var e;function o(e=0){function t(){try{window.print()}catch(e){}}e?setTimeout(t,e):t()}(e=(e=a.multiplayer||(a.multiplayer={})).IconType||(e.IconType={}))[e.Player=0]="Player",e[e.Reaction=1]="Reaction",a.print=o;{var t=a.Embed||(a.Embed={});function r(e){e.origin;var t,r=e.data||{},e=r.type;if(e)switch(e){case"run":c(r);break;case"instructions":a.instructions.renderInstructions(r);break;case"stop":l();break;case"mute":u(r.mute);break;case"stopsound":a.AudioContextManager.stopAll();break;case"print":o();break;case"recorder":var i=r;if(s)switch(i.action){case"start":s.startRecording(i.width);break;case"stop":s.stopRecording()}break;case"screenshot":a.Runtime.postScreenshotAsync(r);break;case"custom":a.handleCustomMessage&&a.handleCustomMessage(r);break;case"pxteditor":break;case"debugger":s&&s.handleDebuggerMsg(r);break;case"simulator":var n=r;switch(n.command){case"focus":d("simulator.focus",{timestamp:n.timestamp});break;case"blur":d("simulator.blur",{timestamp:n.timestamp})}default:t=r,s&&!s.dead&&s.board.receiveMessage(t)}}t.start=function(){if(window.addEventListener("message",r,!1),t.frameid=window.location.hash.slice(1),"serviceWorker"in navigator&&-1!==window.location.href.indexOf("---simulator")&&!a.U.isLocalHost()){var e=window.location.pathname;let t=e.substring(1,e.indexOf("---"));navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("message",e=>{e=e.data;e&&"serviceworker"===e.type&&"activated"===e.state&&e.ref===t&&n()});e=window.location.href.replace(/---simulator.*$/,"---simserviceworker");navigator.serviceWorker.register(e).then(function(e){a.log("Simulator ServiceWorker registration successful with scope: ",e.scope)},function(e){a.log("Simulator ServiceWorker registration failed: ",e)})}a.Runtime.postMessage({type:"ready",frameid:t.frameid})};let s;function l(){s&&(s.kill(),s.board)&&s.board.kill()}function c(e){l(),e.mute&&u(e.mute),e.localizedStrings&&a.localization.setLocalizedStrings(e.localizedStrings);let t=new a.Runtime(e);(s=t).board.initAsync(e).then(()=>{t===s&&t.run(e=>{a.dumpLivePointers(),a.Runtime.postMessage({type:"toplevelcodefinished"})})})}function u(e){a.AudioContextManager.mute(e)}t.stop=l,t.run=c}function d(e,t){i({type:"pxtsim",action:"event",tick:e,data:t})}function i(e){"undefined"!=typeof window&&window.parent&&window.parent!==window&&window.parent.postMessage(e,"*")}function n(){setInterval(()=>{a.Runtime.postMessage({type:"simulator",command:"reload"})},3e3)}a.tickEvent=d,a.reportError=function(e,t,r){i({type:"pxtsim",action:"event",tick:"error",category:e,message:t,data:r})},a.reload=n})(pxsim=pxsim||{}),pxsim.util.injectPolyphils(),"undefined"!=typeof window&&window.addEventListener("load",function(e){pxsim.Embed.start()}),(x=>{{var e=x.instructions||(x.instructions={});let d=10,r=30,s=e=>e+"x",a=20,w=3,A=5,k=5,h=40,p=50,f=1.5;var[i,n]=[816*.95,1056*.95],[b,v]=[1,1];let m=465,o=(v=((i=(i-86.4)/v-48*v)-m)/2+24,400),E=1.7,t=.17,l=.25,c=.3,u=.23,g=`
            .instr-panel {
                margin: 20px;
                padding: 24px;
                border-width: 4px;
                border-color: gray;
                border-style: solid;
                border-radius: 20px;
                display: inline-block;
                width: ${i}px;
                height: ${(n-86.4)/b-48*b}px;
                position: relative;
                overflow: hidden;
                page-break-inside: avoid;
            }
            .board-svg {
                margin: 0 auto;
                display: block;
                position: absolute;
                bottom: 24px;
                left: ${v}px;
            }
            .panel-num-outer {
                position: absolute;
                left: -4px;
                top: -4px;
                width: 120px;
                height: 120px;
                border-width: 4px;
                border-style: solid;
                border-color: gray;
                border-radius: 20px 0 20px 0;
            }
            .panel-num {
                margin: 10px 0;
                text-align: center;
                font-size: 80px;
            }
            .cmp-div {
                display: inline-block;
            }
            .reqs-div {
                margin-left: 144px;
                margin-top: 5px;
            }
            .partslist-wire,
            .partslist-cmp {
                margin: 10px;
            }
            .partslist-wire {
                display: inline-block;
            }
            `;function y(e,t){var r=document.createElementNS("http://www.w3.org/2000/svg","svg");let i={l:0,t:0,w:0,h:0};var n=document.createElementNS("http://www.w3.org/2000/svg","svg");r.appendChild(n),n.appendChild(e.el);let s={viewBox:e.x+` ${e.y} ${e.w} `+e.h,preserveAspectRatio:"xMidYMid"};i.w=e.w,i.h=e.h;e=e=>{i.h*=e,i.w*=e,s.width=i.w,s.height=i.h};t.cmpScale&&e(t.cmpScale),t.cmpWidth&&t.cmpWidth<i.w?e(t.cmpWidth/i.w):t.cmpHeight&&t.cmpHeight<i.h&&e(t.cmpHeight/i.h),x.svg.hydrate(n,s);let a=i.l,o=i.t,l=i.w,c=i.h;var u,d,h,p,e=e=>{var t;e<i.l&&(t=i.l-e,i.l=e,i.w+=t)},n=e=>{var t=i.l+i.w;t<e&&(e=e-t,i.w+=e)},f=e=>{var t;e<i.t&&(t=i.t-e,i.t=e,i.h+=t)},m=e=>{var t=i.t+i.h;t<e&&(e=e-t,i.h+=e)},[g,b]=[-.3,.3],v=[1.4,1],v=(t&&t.top&&(h=(p=t.topSize)/v[0],d=p/v[1],[u,y]=[a+l/2,o-w-d/2],p=x.visuals.mkTxt(u,y,p,0,t.top,g,b),x.U.addClass(p,"cmp-lbl"),r.appendChild(p),p=h*t.top.length,f(y-d/2),e(u-p/2),n(u+p/2)),t&&t.bot&&(y=(h=t.botSize)/v[0],d=h/v[1],[u,p]=[a+l/2,o+c+w+d/2],h=x.visuals.mkTxt(u,p,h,0,t.bot,g,b),x.U.addClass(h,"cmp-lbl"),r.appendChild(h),h=y*t.bot.length,m(p+d/2),e(u-h/2),n(u+h/2)),t&&t.right&&(p=(y=t.rightSize)/v[1],d=y/v[0]*t.right.length,[u,h]=[a+l+A+d/2,o+c/2],y=x.visuals.mkTxt(u,h,y,0,t.right,g,b),x.U.addClass(y,"cmp-lbl"),r.appendChild(y),f(h-p/2),n(u+d/2),m(h+p/2)),t&&t.left&&(n=(y=t.leftSize)/v[1],u=y/v[0]*t.left.length,[d,h]=[a-k-u/2,o+c/2],p=x.visuals.mkTxt(d,h,y,0,t.left,g,b),x.U.addClass(p,"cmp-lbl"),r.appendChild(p),f(h-n/2),e(d-u/2),m(h+n/2)),{viewBox:`${i.l} ${i.t} ${i.w} `+i.h,width:i.w*E,height:i.h*E,preserveAspectRatio:"xMidYMid"}),y=(x.svg.hydrate(r,v),document.createElement("div"));return y.appendChild(r),y}function T(e,t){var r=x.runtime.board;let i;return y(i="wire"==e?x.visuals.mkWirePart([0,0],t.wireClr||"red",t.crocClips):"string"==typeof(e=e).builtIn?(0,r.builtinPartVisuals[e.builtIn])([0,0]):x.visuals.mkGenericPartSVG(e),t)}function S(e,t,r=!1){t={state:x.runtime.board,boardDef:e.boardDef,forceBreadboardLayout:!0,forceBreadboardRender:e.allAlloc.requiresBreadboard,partDefs:e.cmpDefs,maxWidth:t+"px",fnArgs:e.fnArgs,wireframe:r,partsList:[]},e=new x.visuals.BoardHost(x.visuals.mkBoardView({visual:t.boardDef.visual,boardDef:t.boardDef,wireframe:t.wireframe}),t),r=e.getView();return x.U.addClass(r,"board-svg"),e}function C(){var e=document.createElement("div");return x.U.addClass(e,"instr-panel"),e}function I(i){let n=C();e=i.boardDef;var e=y(x.visuals.mkBoardView({visual:e.visual,boardDef:e}).getView(),{left:s(1),leftSize:r,cmpScale:t}),e=(n.appendChild(e),new x.visuals.Breadboard({}).getSVGAndSize()),e=y(e,{left:s(1),leftSize:r,cmpScale:l});return n.appendChild(e),i.allCmps.forEach(e=>{let t=1;"buttonpair"===e.visual.builtIn&&(t=2);e=T(e.visual,{left:s(t),leftSize:r,cmpScale:c});x.U.addClass(e,"partslist-cmp"),n.appendChild(e)}),i.allWireColors.forEach(e=>{var t=i.colorToWires[e].length,r=i.boardDef.pinStyles[e]||"female",t=T("wire",{left:s(t),leftSize:a,wireClr:e,cmpScale:u,crocClips:"croc"==r});x.U.addClass(t,"partslist-wire"),n.appendChild(t)}),n}function _(e,r){var t=C(),i=S(r,m,!0),n=i,s=e,a=r,o=n.getView();0<s&&x.U.addClass(o,"grayed");for(let r=0;r<=s;r++){var l=a.stepToCmps[r],l=(l&&l.forEach(e=>{var t=n.addPart(e);r===s&&(e.breadboardConnections.forEach(e=>n.highlightBreadboardPin(e)),x.U.addClass(t.element,"notgrayed"))}),a.stepToWires[r]);l&&l.forEach(e=>{var t=n.addWire(e);t&&r===s&&("breadboard"==e.start.type?n.highlightBreadboardPin(e.start):n.highlightBoardPin(e.start.pin),"breadboard"==e.end.type?n.highlightBreadboardPin(e.end):n.highlightBoardPin(e.end.pin),n.highlightWire(t))})}t.appendChild(i.getView());o=document.createElement("div"),x.U.addClass(o,"panel-num-outer"),x.U.addClass(o,"noselect"),t.appendChild(o),i=document.createElement("div");x.U.addClass(i,"panel-num"),i.textContent=e+1+"",o.appendChild(i);let c=document.createElement("div");x.U.addClass(c,"reqs-div"),t.appendChild(c);o=r.stepToWires[e]||[];let u=e=>{var t,r;return"breadboard"===e.type?({row:t,col:r}=e,`(${t},${r})`):e.pin};return o.forEach(e=>{let t=!1;"dalboard"==e.end.type&&(t="croc"==r.boardDef.pinStyles[e.end.pin]);e=T("wire",{top:u(e.end),topSize:d,bot:u(e.start),botSize:d,wireClr:e.color,cmpHeight:h,crocClips:t});x.U.addClass(e,"cmp-div"),c.appendChild(e)}),(r.stepToCmps[e]||[]).forEach(s=>{let e;(e="buttonpair"===s.visual.builtIn?[s.breadboardConnections[0],s.breadboardConnections[2]]:[s.breadboardConnections[0]]).forEach((e,t)=>{let r;var i;r=e?({row:e,col:i}=e,`(${e},${i})`):"";let n=f;"buttonpair"===s.visual.builtIn&&(n*=.5);e=T(s.visual,{top:r,topSize:d,cmpHeight:p,cmpScale:n});x.U.addClass(e,"cmp-div"),c.appendChild(e)})}),t}function U(t,e){e.boardDef.pinStyles||(e.boardDef.pinStyles={}),e.configData&&x.setConfigData(e.configData.cfg,e.configData.cfgKey);var r,i={type:"run",code:"",boardDefinition:e.boardDef,partDefinitions:e.partDefinitions},i=(x.runtime=new x.Runtime(i),x.runtime.board=null,x.initCurrentRuntime(i),document.createElement("style")),i=(i.textContent+=g,document.head.appendChild(i),e.partDefinitions),n=new x.visuals.Breadboard({}),s=(e=>{var t=x.allocateDefinitions(e);let n=[],s=[],a=1;t.partsAndWires.forEach(e=>{let r=e.part,i=e.wires;e.assembly.forEach((e,t)=>{e.part&&r&&(s[a+t]=[r]),e.wireIndices&&0<e.wireIndices.length&&i&&(n[a+t]=e.wireIndices.map(e=>i[e]))}),a+=e.assembly.length});var r=a-1,i=t.partsAndWires.map(e=>e.part).filter(e=>!!e),o=t.partsAndWires.map(e=>e.wires||[]).reduce((e,t)=>e.concat(t),[]);let l={},c=[];return o.forEach(e=>{l[e.color]||(l[e.color]=[],c.push(e.color)),l[e.color].push(e)}),{boardDef:e.boardDef,cmpDefs:e.partDefs,fnArgs:e.fnArgs,allAlloc:t,stepToWires:n,stepToCmps:s,allWires:o,allCmps:i,lastStep:r,colorToWires:l,allWireColors:c}})({boardDef:e.boardDef,partDefs:i,partsList:e.parts,fnArgs:e.fnArgs,getBBCoord:n.getCoord.bind(n)}),i=(s.allAlloc.requiresBreadboard=!0,i=s,n=document.getElementById("front-panel"),(r=S(i,o,!1)).addAll(i.allAlloc),n.appendChild(r.getView()),I(s));t.appendChild(i);for(let e=0;e<=s.lastStep;e++){var a=_(e,s);t.appendChild(a)}e.print&&x.print(2e3)}e.renderParts=U,e.renderInstructions=function(e){document.getElementById("proj-title").innerText=e.options.name||"",U(document.body,e.options)}}})(pxsim=pxsim||{}),(u=>{function i(e,t="sim: check failed"){if(!e)throw new Error(t)}u.quiet=!1,u.check=i,u.title="";let r={},n={};u.getConfig=function(e){return n.hasOwnProperty(e+"")?n[e+""]:null},u.getConfigKey=function(e){return r.hasOwnProperty(e)?r[e]:null},u.getAllConfigKeys=function(){return Object.keys(r)},u.setConfigKey=function(e,t){r[e]=t},u.setConfig=function(e,t){n[e]=t},u.setConfigData=function(e,t){n=e,r=t},u.getConfigData=function(){return{cfg:n,cfgKey:r}},u.setTitle=function(e){u.title=e};class s{constructor(){u.runtime?this.id=u.runtime.registerLiveObject(this):this.id=0}destroy(){}scan(e){throw u.U.userError("scan not implemented")}gcKey(){throw u.U.userError("gcKey not implemented")}gcSize(){throw u.U.userError("gcSize not implemented")}gcIsStatic(){return!1}print(){u.runtime&&u.runtime.refCountingDebug&&u.log("RefObject id:"+this.id)}toDebugString(){return"(object)"}static toAny(e){return e&&e.toAny?e.toAny():e}static fromAny(e){return e&&(e instanceof s?e:Array.isArray(e)?u.RefCollection.fromAny(e):"object"==typeof e?o.fromAny(e):e)}static toDebugString(e){return null===e?"null":void 0===e?"undefined;":e.vtable&&e.vtable.name?"_Map"===e.vtable.name&&e instanceof h?"(object)":e.vtable.name:e.toDebugString?e.toDebugString():e.vtable&&e.vtable.name?e.vtable.name:"string"==typeof e?JSON.stringify(e):e.toString()}}u.RefObject=s;class a{constructor(e,t,r){this.func=e,this.caps=t,this.args=r}}u.FnWrapper=a;class o extends s{constructor(){super(...arguments),this.fields={}}scan(e){for(var t of Object.keys(this.fields))e(t,this.fields[t])}gcKey(){return this.vtable.name}gcSize(){return this.vtable.numFields+1}destroy(){this.fields=null,this.vtable=null}print(){u.runtime&&u.runtime.refCountingDebug&&u.log(`RefRecord id:${this.id} (${this.vtable.name})`)}toDebugString(){let t="RefRecord: {";var r=Object.keys(this.fields);for(let e=0;e<r.length;++e)0<e&&(t+=", "),t+=r[e]+": "+s.toDebugString(this.fields[r[e]]);return t+"}"}toAny(){var e,t={};for(e of Object.keys(this.fields))t[e]=s.toAny(this.fields[e]);return t}static fromAny(e){var t,r=new o;for(t of Object.keys(e))r.fields[t]=s.fromAny(e[t]);return r}}u.RefRecord=o;class l extends s{constructor(){super(...arguments),this.fields=[]}scan(t){for(let e=0;e<this.fields.length;++e)t("_cap"+e,this.fields[e])}gcKey(){return u.functionName(this.func)}gcSize(){return this.fields.length+3}isRef(e){return i(0<=e&&e<this.fields.length),e<this.len}ldclo(e){return i(0<=(e>>=2)&&e<this.fields.length),this.fields[e]}destroy(){this.fields=null,this.func=null}print(){u.runtime&&u.runtime.refCountingDebug&&u.log(`RefAction id:${this.id} len:`+this.fields.length)}}var c;u.RefAction=l;{var e=u.pxtcore||(u.pxtcore={});e.seedAddRandom=function(e){},e.mkAction=function(t,e){var r=new l;r.len=t,r.func=e;for(let e=0;e<t;++e)r.fields.push(null);return r},e.runAction=function(e,t){var r=u.getResume();e instanceof l?r(new a(e.func,e.fields,t)):r(new a(e,null,t))};let c={};function d(e){let r="",i=(e,t)=>{r+=e.length>=t?e:("              "+e).slice(-t)};let n=e=>i(""+Math.round(e),6);var t,s=(e,t)=>{i(Math.round(t)+"",8),r+=" /",n(e),r+=" =",n(t/e)};for(t of e.split(/\n/))if(t&&/^\d/.test(t)){var a=t.split(/,/);let e=c[a[2]];e||(c[a[2]]=e={stops:0,us:0,meds:[]}),o=a[2],l=25,r+=o.length>=l?o:(o+"                         ").slice(0,l);var o=parseInt(a[0]),l=parseInt(a[1]),a=(s(o,l),r+=" |",s(o-e.stops,l-e.us),r+=" ~",parseInt(a[3])),a=(n(a),10<e.meds.length&&e.meds.shift(),e.meds.push(a),e.meds.slice()),a=(a.sort((e,t)=>e-t),a[a.length>>1]);r+=" ~~",n(a),e.stops=o,e.us=l,r+="\n"}u.log(r)}e.dumpPerfCounters=function(){if(u.runtime&&u.runtime.perfCounters){let e="calls,us,name\n";for(var t of u.runtime.perfCounters){t.lastFew.sort();var r=t.lastFew[t.lastFew.length>>1];e+=`${t.numstops},${t.value},${t.name},${r}\n`}d(e)}}}class t extends s{constructor(){super(...arguments),this.v=void 0}scan(e){e("*",this.v)}gcKey(){return"LOC"}gcSize(){return 2}destroy(){}print(){u.runtime&&u.runtime.refCountingDebug&&u.log(`RefRefLocal id:${this.id} v:`+this.v)}}u.RefRefLocal=t;class h extends s{constructor(){super(...arguments),this.vtable=u.mkMapVTable(),this.data=[]}scan(e){for(var t of this.data)e(t.key,t.val)}gcKey(){return"{...}"}gcSize(){return 2*this.data.length+4}findIdx(t){t+="";for(let e=0;e<this.data.length;++e)if(this.data[e].key==t)return e;return-1}destroy(){super.destroy();for(let e=0;e<this.data.length;++e)this.data[e].val=0;this.data=[]}print(){u.runtime&&u.runtime.refCountingDebug&&u.log(`RefMap id:${this.id} size:`+this.data.length)}toDebugString(){let t="RefMap: {";for(let e=0;e<this.data.length;++e)0<e&&(t+=", "),t+=this.data[e].key+": "+s.toDebugString(this.data[e].val);return t+"}"}toAny(){let t={};return this.data.forEach(e=>{t[e.key]=s.toAny(e.val)}),t}static fromAny(e){var t,r=new h;for(t of Object.keys(e))r.data.push({key:t,val:s.fromAny(e[t])});return r}}function p(){u.runtime&&u.runtime.dumpLivePointers()}u.RefMap=h,u.dumpLivePointers=p,(e=u.numops||(u.numops={})).toString=function(e){return null===e?"null":void 0===e?"undefined":e.toString()},e.toBoolDecr=function(e){return!!e},e.toBool=function(e){return!!e},(e=u.langsupp||(u.langsupp={})).toInt=function(e){return 0|e},e.toFloat=function(e){return e},e.ignore=function(e){return e},(e=u.pxtcore||(u.pxtcore={})).ptrOfLiteral=function(e){return e},e.debugMemLeaks=function(){p()},e.templateHash=function(){return 0},e.programHash=function(){return 0},e.programName=function(){return u.title},e.programSize=function(){return 0},e.afterProgramPage=function(){return 0},e.getConfig=function(e,t){return null==(e=u.getConfig(e))?t:e},e.toInt=function(e){return e>>0},e.toUInt=function(e){return e>>>0},e.toDouble=function(e){return e},e.toFloat=function(e){return e},e.fromInt=function(e){return e},e.fromUInt=function(e){return e},e.fromDouble=function(e){return e},e.fromFloat=function(e){return e},e.fromBool=function(e){return!!e};let f;function m(e,t){return e||u.throwFailedPropertyAccessError(e,t),t+="",e instanceof o?e.fields[t]:(t=e.findIdx(t))<0?void 0:e.data[t].val}function g(e,t,r){var i;e||u.throwFailedPropertyAccessError(e,t),t+="",e instanceof o?e.fields[t]=r:(i=e.findIdx(t))<0?e.data.push({key:t,val:r}):e.data[i].val=r}function b(e){e&&(e instanceof l||e.info)||u.throwFailedCastError(e,"function")}(c=f=u.pxtrt||(u.pxtrt={})).toInt8=function(e){return(255&e)<<24>>24},c.toInt16=function(e){return(65535&e)<<16>>16},c.toInt32=function(e){return 0|e},c.toUInt32=function(e){return e>>>0},c.toUInt8=function(e){return 255&e},c.toUInt16=function(e){return 65535&e},c.nullFix=function(e){return null==e||!1===e?0:!0===e?1:e},c.nullCheck=function(e){null==e&&u.U.userError("Dereferencing null/undefined value.")},c.panic=function(e){u.U.userError("PANIC! Code "+e)},c.stringToBool=function(e){return e?1:0},c.ptrToBool=function(e){return e?1:0},c.emptyToNull=function(e){return""==e?0:e},c.ldlocRef=function(e){return e.v},c.stlocRef=function(e,t){e.v=t},c.mklocRef=function(){return new t},c.stclo=function(e,t,r){return i(0<=t&&t<e.fields.length),i(null===e.fields[t]),e.fields[t]=r,e},c.runtimeWarning=function(e){u.Runtime.postMessage(u.getWarningMessage(e))},c.mkMap=function(){return new h},c.mapGet=function(e,t){return m(e,c.mapKeyNames[t])},c.mapSet=function(e,t,r){return g(e,c.mapKeyNames[t],r)},c.mapGetByString=m,c.mapDeleteByString=function(e,t){return null==e&&u.throwNullUndefinedAsObjectError(),e instanceof h||u.throwFailedCastError(e,"object"),0<=(t=e.findIdx(t))&&e.data.splice(t,1),!0},c.mapSetGeneric=g,c.mapGetGeneric=m,c.mapSetByString=g,c.keysOf=function(e){null==e&&u.throwNullUndefinedAsObjectError();var t=new u.RefCollection;if(e instanceof h)for(var r of e.data)t.push(r.key);return t},(e=u.pxtcore||(u.pxtcore={})).mkClassInstance=function(e){i(!!e.methods);var t=new o;return t.vtable=e,t},e.switch_eq=function(e,t){return e==t},e.typeOf=function(e){return typeof e},(e=u.thread||(u.thread={})).panic=f.panic,e.pause=function(e){let t=u.getResume();u.runtime.schedule(()=>{t()},e)},e.runInBackground=function(e){b(e),u.runtime.runFiberAsync(e)},e.forever=function(t){b(t),function e(){u.runtime.runFiberAsync(t).then(()=>u.U.delay(20)).then(e)}()},e.typeCheck=b})(pxsim=pxsim||{}),(s=>{class i extends s.RefObject{constructor(){super(),this.data=[]}scan(t){for(let e=0;e<this.data.length;++e)t("["+e+"]",this.data[e])}gcKey(){return"[...]"}gcSize(){return this.data.length+2}toArray(){return this.data.slice(0)}toAny(){return this.data.map(e=>s.RefObject.toAny(e))}static fromAny(e,t=!0){var r=new i;return r.data=t?e.map(e=>s.RefObject.fromAny(e)):e.slice(0),r}toDebugString(){let t="[";for(let e=0;e<this.data.length;++e){0<e&&(t+=",");var r=s.RefObject.toDebugString(this.data[e]);if(100<t.length+r.length){0==e&&(t+=r.substr(0,100)),t+="...";break}t+=r}return t+="]"}destroy(){var t=this.data;for(let e=0;e<t.length;++e)t[e]=0;this.data=[]}isValidIndex(e){return 0<=e&&e<this.data.length}push(e){this.data.push(e)}pop(){return this.data.pop()}getLength(){return this.data.length}setLength(e){this.data.length=e}getAt(e){return this.data[e]}setAt(e,t){this.data[e]=t}insertAt(e,t){this.data.splice(e,0,t)}removeAt(e){return this.data.splice(e,1)[0]}indexOf(e,t){return this.data.indexOf(e,t)}print(){}}var e;function r(e,t){if(a(e),e.isValidIndex(t))return e.removeAt(t)}function n(e,t,r){return a(e),e.indexOf(t,r)}function a(e){e instanceof i||s.throwFailedCastError(e,"Array")}s.RefCollection=i,(p=s.Array_||(s.Array_={})).mk=function(){return new i},p.isArray=function(e){return e instanceof i},p.length=function(e){return a(e),e.getLength()},p.setLength=function(e,t){a(e),e.setLength(t)},p.push=function(e,t){a(e),e.push(t)},p.pop=function(e,t){return a(e),e.pop()},p.getAt=function(e,t){return a(e),e.getAt(t)},p.removeAt=r,p.insertAt=function(e,t,r){a(e),e.insertAt(t,r)},p.setAt=function(e,t,r){a(e),e.setAt(t,r)},p.indexOf=n,p.removeElement=function(e,t){return a(e),0<=(t=n(e,t,0))?(r(e,t),1):0},p.typeCheck=a;let o;function l(e,t){return s.pxtrt.nullFix(e)==s.pxtrt.nullFix(t)}function c(e){return e<<16>>16}(p=o=s.Math_||(s.Math_={})).imul=Math.imul||function(e,t){var r=65535&e,i=65535&t;return r*i+((e>>>16&65535)*i+r*(t>>>16&65535)<<16>>>0)|0},p.idiv=function(e,t){return(0|e)/(0|t)|0},p.round=function(e){return Math.round(e)},p.roundWithPrecision=function(e,t){if((t|=0)<=0)return Math.round(e);if(0==e)return 0;let r=0;for(;0==r&&t<21;){var i=Math.pow(10,t++);r=Math.round(e*i+Number.EPSILON)/i}return r},p.ceil=function(e){return Math.ceil(e)},p.floor=function(e){return Math.floor(e)},p.sqrt=function(e){return Math.sqrt(e)},p.pow=function(e,t){return Math.pow(e,t)},p.clz32=function(e){return Math.clz32(e)},p.log=function(e){return Math.log(e)},p.log10=function(e){return Math.log10(e)},p.log2=function(e){return Math.log2(e)},p.exp=function(e){return Math.exp(e)},p.sin=function(e){return Math.sin(e)},p.sinh=function(e){return Math.sinh(e)},p.cos=function(e){return Math.cos(e)},p.cosh=function(e){return Math.cosh(e)},p.tan=function(e){return Math.tan(e)},p.tanh=function(e){return Math.tanh(e)},p.asin=function(e){return Math.asin(e)},p.asinh=function(e){return Math.asinh(e)},p.acos=function(e){return Math.acos(e)},p.acosh=function(e){return Math.acosh(e)},p.atan=function(e){return Math.atan(e)},p.atanh=function(e){return Math.atanh(e)},p.atan2=function(e,t){return Math.atan2(e,t)},p.trunc=function(e){return 0<e?Math.floor(e):Math.ceil(e)},p.random=function(){return Math.random()},p.randomRange=function(e,t){var r;return e==t?e:(t<e&&(r=e,e=t,t=r),Math.floor(e)==e&&Math.floor(t)==t?e+Math.floor(Math.random()*(t-e+1)):e+Math.random()*(t-e))},(p=s.Number_||(s.Number_={})).lt=function(e,t){return e<t},p.le=function(e,t){return e<=t},p.neq=function(e,t){return!l(e,t)},p.eq=l,p.eqDecr=function(e,t){return s.pxtrt.nullFix(e)==s.pxtrt.nullFix(t)},p.gt=function(e,t){return t<e},p.ge=function(e,t){return t<=e},p.div=function(e,t){return 0|Math.floor(e/t)},p.mod=function(e,t){return e%t},p.bnot=function(e){return~e},p.toString=function(e){return e+""},(p=s.thumb||(s.thumb={})).adds=function(e,t){return e+t|0},p.subs=function(e,t){return e-t|0},p.divs=function(e,t){return 0|Math.floor(e/t)},p.muls=function(e,t){return o.imul(e,t)},p.ands=function(e,t){return e&t},p.orrs=function(e,t){return e|t},p.eors=function(e,t){return e^t},p.lsls=function(e,t){return e<<t},p.lsrs=function(e,t){return e>>>t},p.asrs=function(e,t){return e>>t},p.bnot=function(e){return~e},p.ignore=function(e){return e},(p=s.avr||(s.avr={})).adds=function(e,t){return c(e+t)},p.subs=function(e,t){return c(e-t)},p.divs=function(e,t){return c(Math.floor(e/t))},p.muls=function(e,t){return c(o.imul(e,t))},p.ands=function(e,t){return c(e&t)},p.orrs=function(e,t){return c(e|t)},p.eors=function(e,t){return c(e^t)},p.lsls=function(e,t){return c(e<<t)},p.lsrs=function(e,t){return(65535&e)>>>t},p.asrs=function(e,t){return c(e>>t)},p.bnot=function(e){return~e},p.ignore=function(e){return e};let d;function u(e){"string"!=typeof e&&s.throwFailedCastError(e,"string")}(p=d=s.String_||(s.String_={})).stringConv=function(e){let t=s.getResume();e instanceof s.RefRecord&&e.vtable.toStringMethod?s.runtime.runFiberAsync(e.vtable.toStringMethod,e).then(()=>{t(s.runtime.currFrame.retval+"")}):t(e+"")},p.mkEmpty=function(){return""},p.fromCharCode=function(e){return String.fromCharCode(e)},p.toNumber=function(e){return u(e),parseFloat(e)},p.concat=function(e,t){return u(e),e+t},p.substring=function(e,t,r){return u(e),e.slice(t,t+r)},p.equals=function(e,t){return u(e),e==t},p.compare=function(e,t){return u(e),e==t?0:e<t?-1:1},p.compareDecr=function(e,t){return u(e),e==t?0:e<t?-1:1},p.length=function(e){return u(e),e.length},p.substr=function(e,t,r){return u(e),e.substr(t,r)},p.charAt=function(e,t){return u(e),e.charAt(t)},p.charCodeAt=function(e,t){return u(e),i=t,u(r=e),0<=i&&i<r.length?e.charCodeAt(t):0;var r,i},p.indexOf=function(e,t,r){return u(e),null==t?-1:e.indexOf(t,r)},p.lastIndexOf=function(e,t,r){return u(e),null==t?-1:e.lastIndexOf(t,r)},p.includes=function(e,t,r){return u(e),null!=t&&e.includes(t,r)},p.typeCheck=u,(p=s.Boolean_||(s.Boolean_={})).toString=function(e){return e?"true":"false"},p.bang=function(e){return!e};class h extends s.RefObject{constructor(e){super(),this.data=e,this.isStatic=!1}scan(e){}gcKey(){return"Buffer"}gcSize(){return 2+(this.data.length+3>>2)}gcIsStatic(){return this.isStatic}print(){}toDebugString(){return t.toHex(this)}}s.RefBuffer=h;let t;{var p=t=s.BufferMethods||(s.BufferMethods={});let n;function f(e){let t=(e=>{switch(e){case n.Int8LE:return-1;case n.UInt8LE:return 1;case n.Int16LE:return-2;case n.UInt16LE:return 2;case n.Int32LE:return-4;case n.UInt32LE:return 4;case n.Int8BE:return-10;case n.UInt8BE:return 10;case n.Int16BE:return-20;case n.UInt16BE:return 20;case n.Int32BE:return-40;case n.UInt32BE:return 40;case n.Float32LE:return 4;case n.Float32BE:return 40;case n.Float64LE:return 8;case n.Float64BE:return 80;default:throw s.U.userError("bad format")}})(e),r=!1,i=(t<0&&(r=!0,t=-t),!1);10<=t&&(i=!0,t/=10);e=e>=n.Float32LE;return{size:t,signed:r,swap:i,isFloat:e}}function m(e){return new h(new Uint8Array(e))}function g(e,t){return 0<=t&&t<e.data.length}function b(e,t){return k(e),g(e,t)?e.data[t]:0}function v(e){e.isStatic&&s.U.userError("Writing to read only buffer.")}function y(e,t,r){k(e),g(e,t)&&(v(e),e.data[t]=r)}function w(e,t,r=0,i=-1){k(e),r<0||r>e.data.length||(i<0&&(i=e.data.length),i=Math.min(i,e.data.length-r),v(e),e.data.fill(t,r,r+i))}function A(t,r,i,n,s){if(i.buffer===t.buffer)A(t,r,i.slice(n,n+s),0,s);else for(let e=0;e<s;++e)t[r+e]=i[n+e]}(e=n=p.NumberFormat||(p.NumberFormat={}))[e.Int8LE=1]="Int8LE",e[e.UInt8LE=2]="UInt8LE",e[e.Int16LE=3]="Int16LE",e[e.UInt16LE=4]="UInt16LE",e[e.Int32LE=5]="Int32LE",e[e.Int8BE=6]="Int8BE",e[e.UInt8BE=7]="UInt8BE",e[e.Int16BE=8]="Int16BE",e[e.UInt16BE=9]="UInt16BE",e[e.Int32BE=10]="Int32BE",e[e.UInt32LE=11]="UInt32LE",e[e.UInt32BE=12]="UInt32BE",e[e.Float32LE=13]="Float32LE",e[e.Float64LE=14]="Float64LE",e[e.Float32BE=15]="Float32BE",e[e.Float64BE=16]="Float64BE",p.fmtInfo=f,p.getNumber=function(t,e,r){k(t);var i=f(e);if(i.isFloat)return e=t.data.buffer.slice(r,r+i.size),i.swap&&new Uint8Array(e).reverse(),new(4==i.size?Float32Array:Float64Array)(e)[0];let n=0;for(let e=0;e<i.size;++e){n<<=8;var s=i.swap?r+e:r+i.size-e-1;n|=t.data[s]}return i.signed?(e=32-8*i.size,n=n<<e>>e):n>>>=0,n},p.setNumber=function(t,e,r,i){k(t);var n=f(e);if(n.isFloat){var s=new Uint8Array(n.size);4==n.size?new Float32Array(s.buffer)[0]=i:new Float64Array(s.buffer)[0]=i,n.swap&&s.reverse();for(let e=0;e<n.size;++e)t.data[r+e]=s[e]}else for(let e=0;e<n.size;++e){var a=n.swap?r+n.size-e-1:r+e;t.data[a]=255&i,i>>=8}},p.createBuffer=m,p.createBufferFromHex=function(t){d.typeCheck(t);var r=m(t.length>>1);for(let e=0;e<t.length;e+=2)r.data[e>>1]=parseInt(t.slice(e,e+2),16);return r.isStatic=!0,r},p.isReadOnly=function(e){return k(e),e.isStatic},p.getBytes=function(e){return k(e),e.data},p.getUint8=function(e,t){return k(e),b(e,t)},p.getByte=b,p.setUint8=function(e,t,r){k(e),y(e,t,r)},p.setByte=y,p.length=function(e){return k(e),e.data.length},p.fill=w,p.slice=function(e,t,r){return k(e),t=Math.min(e.data.length,t),r<0&&(r=e.data.length),r=Math.min(r,e.data.length-t),new h(e.data.slice(t,t+r))},p.toHex=function(t){k(t);var r="0123456789abcdef";let i="";for(let e=0;e<t.data.length;++e)i=(i+=r[t.data[e]>>4])+r[15&t.data[e]];return i},p.toString=function(e){return k(e),s.U.fromUTF8Array(e.data)};let u=-2147483648;function k(e){e instanceof h||s.throwFailedCastError(e,"Buffer")}p.shift=function(e,t,r,i){k(e),i<0&&(i=e.data.length-r),r<0||r+i>e.data.length||r+i<r||0==i||0==t||t==u||0!=i&&0!=t&&t!=u&&(t<=-i||i<=t?w(e,0):(v(e),t<0?(A(e.data,r+(t=-t),e.data,r,i-t),e.data.fill(0,r,r+t)):(A(e.data,r,e.data,r+t,i-=t),e.data.fill(0,r+i,r+i+t))))},p.rotate=function(i,n,s,a){if(k(i),a<0&&(a=i.data.length-s),!(s<0||s+a>i.data.length||s+a<s||0==a||0==n||n==u)){v(i),n<0&&(n+=a<<8),(n%=a)<0&&(n+=a);var o=i.data;let e=n,t=0,r=e;for(var l=a;t!=r;){var c=o[t+s];o[t+++s]=o[r+s],o[r+++s]=c,r==l?r=e:t==e&&(e=r)}}},p.write=function(e,t,r,i=0,n=-1){k(e),k(r),n<0&&(n=r.data.length),i<0||t<0||t>e.data.length||(n=Math.min(r.data.length-i,e.data.length-t))<0||(v(e),A(e.data,t,r.data,i,n))},p.typeCheck=k}})(pxsim=pxsim||{}),(t=>{(t.control||(t.control={})).createBufferFromUTF8=function(e){return t.String_.typeCheck(e),new t.RefBuffer(t.U.toUTF8Array(e))}})(pxsim=pxsim||{}),(e=>{{e=e.localization||(e.localization={});let i={};function n(e,o){return 0==o.length?e:e.replace(/\{([0-9]+)(\:[^\}]+)?\}/g,function(e,r,t){r=o[parseInt(r)];let i="";var n=/^:f(\d*)\.(\d+)/.exec(t);if(n){var s=parseInt(n[2]);let e=parseInt(n[1])||0;var a=/^0/.test(n[1])?"0":" ";let t=r.toFixed(s);if(0<e&&0<s&&(e+=s+1),0<e)for(;t.length<e;)t=a+t;i=t}else i=":x"==t?"0x"+r.toString(16):void 0===r?"(undef)":null===r?"(null)":r.toString?r.toString():r+"";return":a"==t?/^\s*[euioah]/.test(i.toLowerCase())?i="an "+i:/^\s*[bcdfgjklmnpqrstvwxz]/.test(i.toLowerCase())&&(i="a "+i):":s"==t?i=1==r?"":"s":":q"==t?i=l(i):":jq"==t?i=c(i):":uri"==t?i=encodeURIComponent(i).replace(/'/g,"%27").replace(/"/g,"%22"):":url"==t?i=encodeURI(i).replace(/'/g,"%27").replace(/"/g,"%22"):":%"==t&&(i=(100*r).toFixed(1).toString()+"%"),i})}function l(e){return e&&e.replace(/([^\w .!?\-$])/g,e=>"&#"+e.charCodeAt(0)+";")}function c(e){return e.replace(/[^\w .!?\-$]/g,e=>{e=e.charCodeAt(0).toString(16);return"\\u"+"0000".substr(0,4-e.length)+e})}e.setLocalizedStrings=function(e){i=e||{}},e.lf=function(e,...t){let r=i[e]||e;return n(r=r.replace(/^\{(id|loc):[^\}]+\}/g,""),t)},e.fmt_va=n,e.htmlEscape=l,e.jsStringQuote=c}})(pxsim=pxsim||{}),(e=>{let t;var r;(r=t=e.LogLevel||(e.LogLevel={}))[r.Debug=0]="Debug",r[r.Info=1]="Info",r[r.Log=1]="Log",r[r.Warning=2]="Warning",r[r.Error=3]="Error",e.ConsoleLogger=class{constructor(){this.setLogLevel(t.Info)}setLogLevel(e){this.logLevel=e}getLogLevel(){return this.logLevel}info(...e){this.shouldLog(t.Info)&&null!=console&&console.info&&console.info.call(null,...e)}log(...e){this.shouldLog(t.Log)&&null!=console&&console.log&&console.log.call(null,...e)}debug(...e){this.shouldLog(t.Debug)&&null!=console&&console.debug&&console.debug.call(null,...e)}error(...e){this.shouldLog(t.Error)&&null!=console&&console.error&&console.error.call(null,...e)}warn(...e){this.shouldLog(t.Warning)&&null!=console&&console.warn&&console.warn.call(null,...e)}shouldLog(e){return e>=this.logLevel}};let i=new e.ConsoleLogger;e.info=function(...e){i.info(...e)},e.log=function(...e){i.log(...e)},e.debug=function(...e){i.debug(...e)},e.error=function(...e){i.error(...e)},e.warn=function(...e){i.warn(...e)},e.setLogger=function(e){var t=null==i?void 0:i.getLogLevel();i=e,void 0!==t&&i.setLogLevel(t)},e.setLogLevel=function(e){i.setLogLevel(e)}})(pxsim=pxsim||{}),!function(pxsim){let MIN_MESSAGE_WAIT_MS=200,tracePauseMs=0,MessageListenerFlags;(e=>{e[e.MESSAGE_BUS_LISTENER_REENTRANT=8]="MESSAGE_BUS_LISTENER_REENTRANT",e[e.MESSAGE_BUS_LISTENER_QUEUE_IF_BUSY=16]="MESSAGE_BUS_LISTENER_QUEUE_IF_BUSY",e[e.MESSAGE_BUS_LISTENER_DROP_IF_BUSY=32]="MESSAGE_BUS_LISTENER_DROP_IF_BUSY",e[e.MESSAGE_BUS_LISTENER_IMMEDIATE=192]="MESSAGE_BUS_LISTENER_IMMEDIATE"})(MessageListenerFlags=MessageListenerFlags||{});let U;(e=>{function t(e){return e.split(/\s+/).filter(e=>!!e)}function r(e){for(;e.firstChild;)e.removeChild(e.firstChild)}e.containsClass=function(r,e){return t(e).every(e=>{return e=e,(t=r).classList?t.classList.contains(e):!((t.className+"").split(/\s+/).indexOf(e)<0);var t})},e.addClass=function(r,e){t(e).forEach(e=>{var t;e=e,(t=r).classList?t.classList.add(e):(t.className+"").split(/\s+/).indexOf(e)<0&&(t.className.baseVal+=" "+e)})},e.removeClass=function(r,e){t(e).forEach(e=>{var t;t=e,(e=r).classList?e.classList.remove(t):e.className.baseVal=(e.className+"").split(/\s+/).filter(e=>e!=t).join(" ")})},e.remove=function(e){e.parentElement.removeChild(e)},e.removeChildren=r,e.clear=function(e){r(e)},e.assert=function(e,t="Assertion failed"){if(!e)throw new Error(t)},e.repeatMap=function(t,r){t=t||0;var i=[];for(let e=0;e<t;++e)i.push(r(e));return i},e.userError=function(e){throw(e=new Error(e)).isUserError=!0,e},e.now=function(){return Date.now()};let i,n=(e.perfNowUs=function(){return 1e3*(i=i||("undefined"!=typeof performance?performance.now.bind(performance)||performance.moznow.bind(performance)||performance.msNow.bind(performance)||performance.webkitNow.bind(performance)||performance.oNow.bind(performance):Date.now))()},Promise.resolve());async function s(t,r,i){let n=0;var s=[];let a=[];for(let e=0;e<t;e++){var o=(async()=>{for(;n<r.length;){var e=n++,t=r[e];a[e]=await i(t)}})();s.push(o)}try{await Promise.all(s)}catch(e){throw n=r.length,e}return a}function a(){return"undefined"!=typeof window&&!!window.pxtElectron}function o(){return"undefined"!=typeof window&&!!window.ipcRenderer}function l(){return a()||o()}function c(e){return/^http:\/\/(?:localhost|127\.0\.0\.1|192\.168\.\d{1,3}\.\d{1,3}|[a-zA-Z0-9.-]+\.local):\d+\/?/.test(e)&&!/nolocalhost=1/.test(e)}function u(){try{return"undefined"!=typeof window&&c(window.location.href)}catch(e){return!1}}e.nextTick=function(e){n.then(e)},e.delay=async function(t,e){return e=await e,await new Promise(e=>setTimeout(()=>e(),t)),e},e.throttle=function(i,n,s){let a;return function(){let e=this,t=arguments;var r=s&&!a;a=a||setTimeout(function(){a=null,s||i.apply(e,t)},n),r&&i.apply(e,t)}},e.promiseMapAll=function(e,t){return Promise.all(e.map(e=>t(e)))},e.promiseMapAllSeries=function(e,t){return s(1,e,t)},e.promisePoolAsync=s,e.promiseTimeout=async function(r,e,i){let n,s;var t=new Promise((e,t)=>{s=e,n=setTimeout(()=>{s=void 0,clearTimeout(n),t(i||`Promise timed out after ${r}ms`)},r)});return Promise.race([e,t]).then(e=>(s&&(clearTimeout(n),s()),e))},e.stringToUint8Array=function(t){var r=t.length,i=new Uint8Array(r);for(let e=0;e<r;++e)i[e]=255&t.charCodeAt(e);return i},e.uint8ArrayToString=function(t){var r=t.length;let i="";for(let e=0;e<r;++e)i+=String.fromCharCode(t[e]);return i},e.fromUTF8=function(t){if(!t)return"";let r="";for(let e=0;e<t.length;++e){var i=255&t.charCodeAt(e);r+=37==i||127<i?"%"+i.toString(16):t.charAt(e)}return decodeURIComponent(r)},e.toUTF8=function(r,i){let n="";if(r)for(let t=0;t<r.length;++t){let e=r.charCodeAt(t);var s;e<=127?n+=r.charAt(t):e<=2047?n+=String.fromCharCode(192|e>>6,128|63&e):(!i&&55296<=e&&e<=56319&&(s=r.charCodeAt(++t),isNaN(s)||(e=65536+(e-55296<<10)+(s-56320))),e<=65535?n+=String.fromCharCode(224|e>>12,128|e>>6&63,128|63&e):n+=String.fromCharCode(240|e>>18,128|e>>12&63,128|e>>6&63,128|63&e))}return n},e.toUTF8Array=function(e){return(new TextEncoder).encode(e)},e.fromUTF8Array=function(e){return(new TextDecoder).decode(e)},e.isPxtElectron=a,e.isIpcRenderer=o,e.isElectron=l,e.testLocalhost=c,e.isLocalHost=u,e.isLocalHostDev=function(){return u()&&!l()},e.unique=function(e,r){let i=[],n={};return e.forEach(e=>{var t=r(e);n.hasOwnProperty(t)||(n[t]=null,i.push(e))}),i},e.sanitizeCssName=function(e){let t=e.replace(/[^a-zA-Z0-9-_]/g,"_");return t=/^[a-zA-Z_]/.test(t)?t:"cls_"+t}})(U=pxsim.U||(pxsim.U={}));class BreakLoopException{}pxsim.BreakLoopException=BreakLoopException;let pxtcore;function getResume(){return pxsim.runtime.getResume()}(e=>{function t(e){var t=pxsim.runtime.currTryFrame(),r=(t||U.userError("unhandled exception: "+e),t.handlerFrame);throw(pxsim.runtime.currFrame=r).pc=t.handlerPC,r.tryFrame=t.parent,r.thrownValue=e,r.hasThrownValue=!0,new BreakLoopException}e.beginTry=function(e){pxsim.runtime.currFrame.tryFrame={parent:pxsim.runtime.currTryFrame(),handlerPC:e,handlerFrame:pxsim.runtime.currFrame}},e.endTry=function(){var e=pxsim.runtime.currFrame;e.tryFrame=e.tryFrame.parent},e.throwValue=t,e.getThrownValue=function(){var e=pxsim.runtime.currFrame;return U.assert(e.hasThrownValue),e.hasThrownValue=!1,e.thrownValue},e.endFinally=function(){var e=pxsim.runtime.currFrame;e.hasThrownValue&&(e.hasThrownValue=!1,t(e.thrownValue))}})(pxtcore=pxsim.pxtcore||(pxsim.pxtcore={})),pxsim.getResume=getResume;let SERIAL_BUFFER_LENGTH=16;class BaseBoard{constructor(){this.messageListeners=[],this.serialOutBuffer="",this.messages=[],this.lastSerialTime=0,this.debouncedPostAll=()=>{var e=Date.now();e-this.lastSerialTime>MIN_MESSAGE_WAIT_MS?(clearTimeout(this.serialTimeout),this.messages.length&&(Runtime.postMessage({type:"bulkserial",data:this.messages,id:pxsim.runtime.id,sim:!0}),this.messages=[],this.lastSerialTime=e)):this.serialTimeout=setTimeout(this.debouncedPostAll,50)},this.id=pxsim.Embed.frameid||"b"+Math.round(2147483647*Math.random()),this.bus=new pxsim.EventBus(pxsim.runtime,this)}updateView(){}receiveMessage(e){pxsim.runtime&&!pxsim.runtime.dead&&this.dispatchMessage(e)}dispatchMessage(e){for(var t of this.messageListeners)t(e)}addMessageListener(e){this.messageListeners.push(e)}get storedState(){return this.runOptions?(this.runOptions.storedState||(this.runOptions.storedState={}),this.runOptions.storedState):{}}initAsync(e){return this.runOptions=e,Promise.resolve()}setStoredState(e,t){null==t?delete this.storedState[e]:this.storedState[e]=t,Runtime.postMessage({type:"simulator",command:"setstate",stateKey:e,stateValue:t})}onDebuggerResume(){}screenshotAsync(e){return Promise.resolve(void 0)}kill(){}writeSerial(e){this.serialOutBuffer+=e,(/\n/.test(this.serialOutBuffer)||this.serialOutBuffer.length>SERIAL_BUFFER_LENGTH)&&(this.messages.push({time:Date.now(),data:this.serialOutBuffer}),this.debouncedPostAll(),this.serialOutBuffer="")}}pxsim.BaseBoard=BaseBoard;class CoreBoard extends BaseBoard{constructor(){super(),this.updateSubscribers=[],this.updateView=()=>{this.updateSubscribers.forEach(e=>e())},this.builtinParts={},this.builtinVisuals={},this.builtinPartVisuals={}}kill(){super.kill(),pxsim.codal.music.__stopSoundExpressions(),pxsim.AudioContextManager.stopAll()}}pxsim.CoreBoard=CoreBoard;class BareBoard extends BaseBoard{}function initBareRuntime(){pxsim.runtime.board=new BareBoard;var e=pxsim;e.basic={pause:pxsim.thread.pause,showNumber:e=>{var t=getResume();pxsim.log("SHOW NUMBER:",e),U.nextTick(t)}},e.serial={writeString:e=>pxsim.runtime.board.writeSerial(e)},e.pins={createBuffer:pxsim.BufferMethods.createBuffer},e.control={inBackground:pxsim.thread.runInBackground,createBuffer:pxsim.BufferMethods.createBuffer,dmesg:e=>pxsim.log("DMESG: "+e),deviceDalVersion:()=>"sim",__log:(e,t)=>pxsim.log("LOG: "+t.trim())}}pxsim.initBareRuntime=initBareRuntime;let LogType;(e=>{e[e.UserSet=0]="UserSet",e[e.BackAdd=1]="BackAdd",e[e.BackRemove=2]="BackRemove"})(LogType=LogType||{});class EventHandler{constructor(e,t){this.handler=e,this.flags=t,this.busy=0}async runAsync(e,t,r){var i=this.flags||MessageListenerFlags.MESSAGE_BUS_LISTENER_QUEUE_IF_BUSY;if(i!==MessageListenerFlags.MESSAGE_BUS_LISTENER_IMMEDIATE)return i===MessageListenerFlags.MESSAGE_BUS_LISTENER_QUEUE_IF_BUSY?this.runFiberAsync(e,t,r):void(i===MessageListenerFlags.MESSAGE_BUS_LISTENER_DROP_IF_BUSY&&this.busy||this.runFiberAsync(e,t,r));U.userError("MESSAGE_BUS_LISTENER_IMMEDIATE is not supported!")}async runFiberAsync(e,t,r){this.busy++,await t.runFiberAsync(this.handler,...r?r(e):[e]),this.busy--}}class EventQueue{constructor(e,t){this.runtime=e,this.valueToArgs=t,this.max=5,this.events=[],this.awaiters=[],this._handlers=[],this._addRemoveLog=[]}push(e,t){return 0<this.awaiters.length&&(t?(t=this.awaiters.shift())&&t():(t=this.awaiters.slice(),this.awaiters=[],t.forEach(e=>e()))),0==this.handlers.length||this.events.length>this.max||(this.events.push(e),this.lock)?Promise.resolve():this.poke()}async poke(){this.lock=!0;var e,t,r=this.events;this.events=[];for(e of r)for(var i of this.handlers)await i.runAsync(e,this.runtime,this.valueToArgs);if(0<this.events.length)return this.poke();this.lock=!1;for(t of this._addRemoveLog)t.log===LogType.BackAdd?this.addHandler(t.act,t.flags):t.log===LogType.BackRemove?this.removeHandler(t.act):this.setHandler(t.act,t.flags);this._addRemoveLog=[]}get handlers(){return this._handlers}setHandler(e,t=0){this.lock?this._addRemoveLog.push({act:e,log:LogType.UserSet,flags:t}):this._handlers=[new EventHandler(e,t)]}addHandler(t,e=0){this.lock?this._addRemoveLog.push({act:t,log:LogType.BackAdd,flags:e}):this._handlers.some(e=>e.handler===t)||this._handlers.push(new EventHandler(t,e))}removeHandler(t){var e;this.lock?this._addRemoveLog.push({act:t,log:LogType.BackRemove,flags:0}):-1!=(e=this._handlers.findIndex(e=>e.handler===t))&&this._handlers.splice(e,1)}addAwaiter(e){this.awaiters.push(e)}}function bind(e){let i=e.arg0,n=e.fn;return e=>{let t=0;for(;e.hasOwnProperty("arg"+t);)t++;var r=e;for(let e=t;0<e;e--)r["arg"+e]=r["arg"+(e-1)];return e.arg0=i,n(e)}}function _leave(e,t){return e.parent.retval=t,e.parent}function syntheticRefAction(t){return pxtcore.mkAction(0,e=>_leave(e,t(e)))}pxsim.EventQueue=EventQueue,pxsim.initCurrentRuntime=void 0,pxsim.handleCustomMessage=void 0,pxsim.syntheticRefAction=syntheticRefAction;class TimeoutScheduled{constructor(e,t,r,i){this.id=e,this.fn=t,this.totalRuntime=r,this.timestampCall=i}}pxsim.TimeoutScheduled=TimeoutScheduled;class PausedTimeout{constructor(e,t){this.fn=e,this.timeRemaining=t}}function mkVTable(e){return{name:e.name,numFields:e.numFields,classNo:e.classNo,methods:e.methods,iface:e.iface,lastSubtypeNo:e.lastSubtypeNo,toStringMethod:e.toStringMethod,maxBgInstances:e.maxBgInstances}}pxsim.PausedTimeout=PausedTimeout,pxsim.mkVTable=mkVTable;let mapVTable=null;function mkMapVTable(){return mapVTable=mapVTable||mkVTable({name:"_Map",numFields:0,classNo:0,lastSubtypeNo:0,methods:null})}function functionName(e){e=e.info;return e?`${e.functionName} (${e.fileName}:${e.line+1}:${e.column+1})`:"()"}pxsim.mkMapVTable=mkMapVTable,pxsim.functionName=functionName;class Runtime{constructor(msg){this.numGlobals=1e3,this.dead=!1,this.running=!1,this.idleTimer=void 0,this.recording=!1,this.recordingTimer=0,this.recordingLastImageData=void 0,this.recordingWidth=void 0,this.startTime=0,this.startTimeUs=0,this.pausedTime=0,this.lastPauseTimestamp=0,this.globals={},this.environmentGlobals={},this.otherFrames=[],this.loopLock=null,this.loopLockWaitList=[],this.heapSnapshots=[],this.timeoutsScheduled=[],this.timeoutsPausedOnBreakpoint=[],this.pausedOnBreakpoint=!1,this.traceDisabled=!1,this.perfOffset=0,this.perfElapsed=0,this.perfStack=0,this.refCountingDebug=!1,this.refObjId=1,this.numDisplayUpdates=0,U.assert(!!pxsim.initCurrentRuntime),this.id=msg.id,this.refCountingDebug=!!msg.refCountingDebug;let threadId=0,breakpoints=null,currResume,dbgHeap,dbgResume,breakFrame=null,lastYield=Date.now(),userGlobals,__this=this,yieldDelay=(this.traceDisabled=!!msg.traceDisabled,void 0!==msg.yieldDelay?msg.yieldDelay:5),evalIface={runtime:this,oops:oops,doNothing:doNothing,pxsim:pxsim,globals:this.globals,setupYield:setupYield,maybeYield:maybeYield,setupDebugger:setupDebugger,isBreakFrame:isBreakFrame,breakpoint:breakpoint,trace:trace,checkStack:checkStack,leave:_leave,checkResumeConsumed:checkResumeConsumed,setupResume:setupResume,setupLambda:setupLambda,checkSubtype:checkSubtype,failedCast:failedCast,buildResume:buildResume,mkVTable:mkVTable,bind:bind,leaveAccessor:leaveAccessor};function oops(e){throw new Error("sim error: "+e)}function doNothing(e){return e.pc=-1,_leave(e,e.parent.retval)}function flushLoopLock(){for(;0<__this.loopLockWaitList.length&&!__this.loopLock;)__this.loopLockWaitList.shift()()}let yieldReset=()=>{};function setupYield(e){yieldReset=e}function loopForSchedule(e){let t=new Object,r=e.pc;return __this.loopLock=t,__this.otherFrames.push(e),()=>{__this.dead||(U.assert(e.pc==r),U.assert(__this.loopLock===t),__this.loopLock=null,loop(e),flushLoopLock())}}function maybeYield(e,t,r){if(__this.pausedOnBreakpoint)return!1;__this.cleanScheduledExpired(),yieldReset();var i=Date.now();return 20<=i-lastYield&&(lastYield=i,e.pc=t,e.r0=r,setTimeout(loopForSchedule(e),yieldDelay),!0)}function setupDebugger(e,t){return(breakpoints=new Uint8Array(e))[0]=msg.breakOnStart?1:0,userGlobals=t,breakpoints}function isBreakFrame(t){if(!breakFrame)return!0;for(let e=breakFrame;e;e=e.parent)if(e==t)return!0;return!1}function breakpoint(t,r,e,i){let n={};__this.loopLock=n,U.assert(!dbgResume),U.assert(!dbgHeap),t.pc=r,t.r0=i;var{msg:i,heap:e}=pxsim.getBreakpointMsg(t,e,userGlobals);return dbgHeap=e,pxsim.injectEnvironmentGlobals(i,e),Runtime.postMessage(i),breakpoints[0]=0,breakFrame=null,__this.pauseScheduled(),dbgResume=e=>{if(dbgResume=null,dbgHeap=null,__this.dead)return null;switch(__this.resumeAllPausedScheduled(),__this.board.onDebuggerResume(),pxsim.runtime=__this,U.assert(t.pc==r),breakpoints[0]=0,breakFrame=null,e.subtype){case"resume":break;case"stepover":breakpoints[0]=1,breakFrame=t;break;case"stepinto":breakpoints[0]=1;break;case"stepout":breakpoints[0]=1,breakFrame=t.parent||t}U.assert(__this.loopLock==n),__this.loopLock=null,__this.otherFrames.push(t),loop(t),flushLoopLock()},null}function trace(e,t,r,i){setupResume(t,r),"<main>"===i.functionName||"main.ts"===i.fileName?(pxsim.runtime.traceDisabled||(r=pxsim.getBreakpointMsg(t,e,userGlobals).msg,r.subtype="trace",Runtime.postMessage(r)),pxsim.thread.pause(tracePauseMs||1)):pxsim.thread.pause(0),checkResumeConsumed()}function handleDebuggerMsg(t){switch(t.subtype){case"config":var r=t;if(r.setBreakpoints&&breakpoints){breakpoints.fill(0);for(var i of r.setBreakpoints)breakpoints[i]=1}break;case"traceConfig":r=t;tracePauseMs=r.interval;break;case"pause":breakpoints[0]=1,breakFrame=null;break;case"resume":case"stepover":case"stepinto":case"stepout":dbgResume&&dbgResume(t);break;case"variables":var n,r=t;let e=void 0;dbgHeap&&void 0!==(n=dbgHeap[r.variablesReference])&&(e=pxsim.dumpHeap(n,dbgHeap,r.fields,void 0,r.includeAll)),Runtime.postMessage({type:"debugger",subtype:"variables",req_seq:t.seq,variables:e})}}function removeFrame(t){var r=__this.otherFrames;for(let e=r.length-1;0<=e;--e)if(r[e]===t)return void r.splice(e,1);U.userError("frame cannot be removed!")}function loop(t){if(__this.dead)pxsim.log("Runtime terminated");else{U.assert(!__this.loopLock),__this.perfStartRuntime(),removeFrame(t);try{for(pxsim.runtime=__this;t;)__this.currFrame=t,__this.currFrame.overwrittenPC=!1,t=t.fn(t),__this.maybeUpdateDisplay(),__this.currFrame.overwrittenPC&&(t=__this.currFrame);__this.perfStopRuntime()}catch(e){var r,i;e instanceof BreakLoopException?U.nextTick(loopForSchedule(__this.currFrame)):(__this.perfStopRuntime(),__this.errorHandler?__this.errorHandler(e):(pxsim.error("Simulator crashed, no error handler",e.stack),{msg:r,heap:i}=pxsim.getBreakpointMsg(t,t.lastBrkId,userGlobals),pxsim.injectEnvironmentGlobals(r,i),r.exceptionMessage=e.message,r.exceptionStack=e.stack,Runtime.postMessage(r),__this.postError&&__this.postError(e)))}}}function checkStack(e){100<e&&U.userError("Stack overflow")}function actionCall(e){return e.depth=e.parent.depth+1,checkStack(e.depth),e.pc=0,e}function setupTop(e){e=setupTopCore(e);return setupResume(e,0),e}function setupTopCore(e){let t={parent:null,pc:0,depth:0,threadId:++threadId,fn:()=>(e&&e(t.retval),null)};return t}function topCall(e,t){U.assert(!!__this.board),U.assert(!__this.running),__this.setRunning(!0);t={parent:setupTopCore(t),fn:e,depth:0,pc:0};__this.otherFrames=[t],loop(actionCall(t))}function checkResumeConsumed(){currResume&&oops("getResume() not called")}function setupResume(e,t){currResume=buildResume(e,t)}function leaveAccessor(t,r){if(t.stage2Call){var i={pc:0,fn:null,depth:t.depth,parent:t.parent};let e=1;for(;t.hasOwnProperty("arg"+e);)i["arg"+(e-1)]=t["arg"+e],e++;return setupLambda(i,r),i}return t.parent.retval=r,t.parent}function setupLambda(e,t,r){if(r){var i=e;for(let e=1;e<r;++e)i["arg"+(e-1)]=i["arg"+e];delete i["arg"+(r-1)]}t instanceof pxsim.RefAction?(e.fn=t.func,e.caps=t.fields):"function"==typeof t?e.fn=t:oops("calling non-function")}function checkSubtype(e,t){return!!e&&(t===(e=e.vtable)||e&&t.classNo<=e.classNo&&e.classNo<=t.lastSubtypeNo)}function failedCast(e,t){pxsim.control&&pxsim.control.dmesgValue&&pxsim.control.dmesgValue(e),throwFailedCastError(e,null==t?void 0:t.name)}function buildResume(i,t){currResume&&oops("already has resume"),i.pc=t;let n=Date.now(),s=(__this.otherFrames.push(i),r=>{if(!__this.dead){if(!__this.loopLock){pxsim.runtime=__this;var e=Date.now();if(3<e-n&&(lastYield=e),U.assert(i.pc==t),r instanceof pxsim.FnWrapper){let e={parent:i,fn:r.func,lambdaArgs:r.args,pc:0,caps:r.caps,depth:i.depth+1},t={};return __this.loopLock=t,removeFrame(i),__this.otherFrames.push(e),U.nextTick(()=>{U.assert(__this.loopLock===t),__this.loopLock=null,loop(actionCall(e)),flushLoopLock()})}return i.retval=r,loop(i)}__this.loopLockWaitList.push(()=>s(r))}});return s}let entryPoint=msg.code&&eval(msg.code)(evalIface);this.run=e=>topCall(entryPoint,e),this.getResume=()=>{currResume||oops("noresume");var e=currResume;return currResume=null,e},this.setupTop=setupTop,this.handleDebuggerMsg=handleDebuggerMsg,this.entry=entryPoint,this.overwriteResume=e=>{currResume=null,0<=e&&(this.currFrame.pc=e),this.currFrame.overwrittenPC=!0},pxsim.runtime=this,pxsim.initCurrentRuntime(msg)}registerLiveObject(e){return this.refObjId++}runningTime(){return U.now()-this.startTime-this.pausedTime}runningTimeUs(){return 4294967295&U.perfNowUs()-this.startTimeUs>>0}runFiberAsync(r,i,n,s){return new Promise((e,t)=>U.nextTick(()=>{(pxsim.runtime=this).setupTop(e),pxtcore.runAction(r,[i,n,s])}))}currTryFrame(){for(let e=this.currFrame;e;e=e.parent)if(e.tryFrame)return e.tryFrame;return null}traceObjects(){let n={};for(;2<this.heapSnapshots.length;)this.heapSnapshots.shift();var e,t={count:0,size:0,name:"TOTAL"};let i={TOTAL:t};function s(e,t,i=null){if(t instanceof pxsim.RefObject)if(!t.gcIsStatic()){var r=n[t.id];if(r)i&&r.pointers.push([i,e]);else{let r={obj:t,path:null,pointers:[[i,e]]};n[t.id]=r,t.scan((e,t)=>{t instanceof pxsim.RefObject&&!n[t.id]&&s(e,t,r)})}}}this.heapSnapshots.push({visited:n,statsByType:i});for(e of Object.keys(this.globals))s(e.replace(/___\d+$/,""),this.globals[e]);var r,a=this.otherFrames.slice();this.currFrame&&a.indexOf(this.currFrame)<0&&a.unshift(this.currFrame);for(r of this.getThreads()){var o="Thread-"+this.rootFrame(r).threadId;for(let e=r;e;e=e.parent){var l,c,u=o+"."+functionName(e.fn);for(l of Object.keys(e))/^(r0|arg\d+|.*___\d+)/.test(l)&&(c=e[l])instanceof pxsim.RefObject&&s(u+"."+(l=l.replace(/___.*/,"")),c);if(e.caps)for(var d of e.caps)s(u+".cap",d)}}a=Object.keys(n).map(e=>n[e]);a.sort((e,t)=>t.obj.gcSize()-e.obj.gcSize());let h=t=>{if(null==t.path){let e="";t.path="(cycle)";for(var[r,i]of t.pointers){if(null==r)return void(t.path=i);h(r);r=r.path+"."+i;(!e||e.length>r.length)&&(e=r)}t.path=e}};a.forEach(h);var p,f,m=[t];for(p of a){var g=p.obj.gcSize(),b=p.obj.gcKey(),b=(i.hasOwnProperty(b)||m.push(i[b]={count:0,size:0,name:b}),i[b]);b.size+=g,b.count++,t.size+=g,t.count++}m.sort((e,t)=>e.size-t.size);let v="",y=e=>("        "+e.toString()).slice(-7);for(f of m)v+=y(4*f.size)+y(f.count)+" "+f.name+"\n";var w=e=>y(4*e.obj.gcSize())+" "+e.obj.gcKey()+" "+e.path,A=a.slice(0,20).map(w).join("\n");let k="";if(3<=this.heapSnapshots.length){let t=this.heapSnapshots[this.heapSnapshots.length-3].visited,r=this.heapSnapshots[this.heapSnapshots.length-2].visited;a=a.filter(e=>!t[e.obj.id]&&r[e.obj.id]).filter(e=>!((e=e.obj)instanceof pxsim.RefRecord&&!!(e.vtable&&e.vtable.maxBgInstances&&i[e.gcKey()].count<=e.vtable.maxBgInstances)));k=a.map(w).join("\n")}return"Threads:\n"+this.threadInfo()+"\n\nSummary:\n"+v+"\n\nLarge Objects:\n"+A+"\n\nNew Objects:\n"+k}getThreads(){var e=this.otherFrames.slice();return this.currFrame&&e.indexOf(this.currFrame)<0&&e.unshift(this.currFrame),e}rootFrame(e){let t=e;for(;t.parent;)t=t.parent;return t}threadInfo(){var e;let t="";for(e of this.getThreads()){t+=`Thread ${this.rootFrame(e).threadId}:
`;for(var r of pxsim.getBreakpointMsg(e,e.lastBrkId).msg.stackframes){r=r.funcInfo;t+=`   at ${r.functionName} (${r.fileName}:${r.line+1}:${r.column+1})
`}t+="\n"}return t}static postMessage(e){e&&("undefined"!=typeof window&&window.parent&&window.parent.postMessage&&window.parent.postMessage(e,"*"),Runtime.messagePosted)&&Runtime.messagePosted(e)}static async postScreenshotAsync(e){var t=pxsim.runtime&&pxsim.runtime.board;t&&(t=await t.screenshotAsync(),Runtime.postMessage({type:"screenshot",data:t,delay:e&&e.delay}))}static requestToggleRecording(){var e=pxsim.runtime;e&&Runtime.postMessage({type:"recorder",action:e.recording?"stop":"start"})}restart(){this.kill(),setTimeout(()=>pxsim.Runtime.postMessage({type:"simulator",command:"restart"}),500)}kill(){this.dead=!0,this.stopRecording(),this.stopIdle(),this.setRunning(!1)}updateDisplay(){this.board.updateView(),this.postFrame()}startRecording(e){!this.recording&&this.running&&(this.recording=!0,this.recordingTimer=setInterval(()=>this.postFrame(),66),this.recordingLastImageData=void 0,this.recordingWidth=e)}stopRecording(){this.recording&&(this.recordingTimer&&clearInterval(this.recordingTimer),this.recording=!1,this.recordingTimer=0,this.recordingLastImageData=void 0,this.recordingWidth=void 0)}postFrame(){if(this.recording&&this.running){let t=pxsim.U.now();this.board.screenshotAsync(this.recordingWidth).then(e=>{this.recordingLastImageData&&isImageDataEqual(this.recordingLastImageData,e)||(this.recordingLastImageData=e,Runtime.postMessage({type:"screenshot",data:e,time:t}))})}}queueDisplayUpdate(){this.numDisplayUpdates++}maybeUpdateDisplay(){this.numDisplayUpdates&&(this.numDisplayUpdates=0,this.updateDisplay())}setRunning(e){this.running!=e&&(this.running=e,this.running?(this.startTime=U.now(),this.startTimeUs=U.perfNowUs(),Runtime.postMessage({type:"status",frameid:pxsim.Embed.frameid,runtimeid:this.id,state:"running"})):(this.stopRecording(),this.stopIdle(),Runtime.postMessage({type:"status",frameid:pxsim.Embed.frameid,runtimeid:this.id,state:"killed"})),this.stateChanged)&&this.stateChanged()}dumpLivePointers(){}setupPerfCounters(e){e&&e.length&&(this.perfCounters=e.map(e=>new PerfCounter(e)))}perfStartRuntime(){0!==this.perfOffset?this.perfStack++:this.perfOffset=U.perfNowUs()-this.perfElapsed}perfStopRuntime(){this.perfStack?this.perfStack--:(this.perfElapsed=this.perfNow(),this.perfOffset=0)}perfNow(){return 0===this.perfOffset&&U.userError("bad time now"),U.perfNowUs()-this.perfOffset|0}startPerfCounter(e){this.perfCounters&&((e=this.perfCounters[e]).start&&U.userError("startPerf"),e.start=this.perfNow())}stopPerfCounter(t){if(this.perfCounters){var t=this.perfCounters[t],r=(t.start||U.userError("stopPerf"),this.perfNow()-t.start);t.start=0,t.value+=r,t.numstops++;let e=t.lastFewPtr++;e>=t.lastFew.length&&(e=0,t.lastFewPtr=1),t.lastFew[e]=r}}startIdle(){void 0===this.idleTimer&&(this.idleTimer=setInterval(()=>{var e;this.running&&!this.pausedOnBreakpoint&&(e=this.board.bus)&&e.queueIdle()},20))}stopIdle(){void 0!==this.idleTimer&&(clearInterval(this.idleTimer),this.idleTimer=void 0)}schedule(t,e){if(e<=0&&(e=0),this.pausedOnBreakpoint)return this.timeoutsPausedOnBreakpoint.push(new PausedTimeout(t,e)),-1;var r=U.now();let i=new TimeoutScheduled(-1,t,e,r);return i.id=setTimeout(()=>{var e=this.timeoutsScheduled.indexOf(i);0<=e&&this.timeoutsScheduled.splice(e,1),t()},e),this.timeoutsScheduled.push(i),i.id}pauseScheduled(){this.pausedOnBreakpoint=!0,this.timeoutsScheduled.forEach(e=>{clearTimeout(e.id);var t=U.now()-e.timestampCall;let r=e.totalRuntime-t;r<=0&&(r=1),this.timeoutsPausedOnBreakpoint.push(new PausedTimeout(e.fn,r))}),this.lastPauseTimestamp=U.now(),this.timeoutsScheduled=[]}resumeAllPausedScheduled(){this.pausedOnBreakpoint=!1,this.timeoutsPausedOnBreakpoint.forEach(e=>{this.schedule(e.fn,e.timeRemaining)}),this.lastPauseTimestamp&&(this.pausedTime+=U.now()-this.lastPauseTimestamp,this.lastPauseTimestamp=0),this.timeoutsPausedOnBreakpoint=[]}cleanScheduledExpired(){let t=U.now();this.timeoutsScheduled=this.timeoutsScheduled.filter(e=>t-e.timestampCall<e.totalRuntime)}registerUserInteraction(){this.lastInteractionTime=Date.now(),this.thumbnailRecordingIntervalRef||this.lastThumbnailTime&&this.lastInteractionTime-this.lastThumbnailTime<1e3||(this.thumbnailFrames=[],this.thumbnailRecordingIntervalRef=setInterval(async()=>{var e=await this.board.screenshotAsync();this.thumbnailFrames.length&&isImageDataEqual(e,this.thumbnailFrames[this.thumbnailFrames.length-1])||(this.thumbnailFrames.push(e),(1e4<Date.now()-this.lastInteractionTime||30<this.thumbnailFrames.length)&&(clearInterval(this.thumbnailRecordingIntervalRef),this.thumbnailRecordingIntervalRef=void 0,this.lastThumbnailTime=Date.now(),Runtime.postMessage({type:"thumbnail",frames:this.thumbnailFrames})))},66))}}function throwUserException(e){throw new Error(e)}function throwTypeError(e){throwUserException(pxsim.localization.lf("TypeError: {0}",e))}function throwFailedCastError(e,t){var r=getType(e);throwTypeError(t?null==e?pxsim.localization.lf("Expected type {0} but received type {1}. Did you forget to assign a variable?",t,r):pxsim.localization.lf("Expected type {0} but received type {1}",t,r):pxsim.localization.lf("Cannot read properties of {0}",r))}function throwFailedPropertyAccessError(e,t){e=getType(e);throwTypeError(t?pxsim.localization.lf("Cannot read properties of {0} (reading '{1}')",e,t):pxsim.localization.lf("Cannot read properties of {0}",e))}function throwNullUndefinedAsObjectError(){throwTypeError(pxsim.localization.lf("Cannot convert undefined or null to object"))}function getType(e){let t;var r=null==e?void 0:e.vtable;return t=r?r.name:null===e?"null":void 0===e?"undefined":e instanceof pxsim.RefCollection?"Array":e instanceof pxsim.RefBuffer?"Buffer":e instanceof pxsim.RefAction?"function":typeof e}function setParentMuteState(e){Runtime.postMessage({type:"setmutebuttonstate",state:e})}pxsim.Runtime=Runtime,pxsim.throwUserException=throwUserException,pxsim.throwTypeError=throwTypeError,pxsim.throwFailedCastError=throwFailedCastError,pxsim.throwFailedPropertyAccessError=throwFailedPropertyAccessError,pxsim.throwNullUndefinedAsObjectError=throwNullUndefinedAsObjectError,pxsim.setParentMuteState=setParentMuteState;class PerfCounter{constructor(e){this.name=e,this.start=0,this.numstops=0,this.value=0,this.lastFew=new Uint32Array(32),this.lastFewPtr=0}}function isImageDataEqual(t,r){if(t.data.byteLength===r.data.byteLength){var i=t.data.byteLength;let e=0;for(e=0;e<i&&t.data[e]==r.data[e];++e);return e===i}}pxsim.PerfCounter=PerfCounter}(pxsim=pxsim||{}),(u=>{let a;var e;(e=a=u.SimulatorState||(u.SimulatorState={}))[e.Unloaded=0]="Unloaded",e[e.Stopped=1]="Stopped",e[e.Pending=2]="Pending",e[e.Starting=3]="Starting",e[e.Running=4]="Running",e[e.Paused=5]="Paused",e[e.Suspended=6]="Suspended";let o,d=((e=o=u.SimulatorDebuggerCommand||(u.SimulatorDebuggerCommand={}))[e.StepInto=0]="StepInto",e[e.StepOver=1]="StepOver",e[e.StepOut=2]="StepOut",e[e.Resume=3]="Resume",e[e.Pause=4]="Pause","messagechannel"),h="aspectratio",n="pxtdriver";u.SimulatorDriver=class{constructor(e,t={}){this.container=e,this.options=t,this.themes=["blue","red","green","yellow"],this.runId="",this.nextFrameId=0,this.frameCounter=0,this.singleSimulator=!1,this.traceInterval=0,this.breakpointsSet=!1,this._runOptions={},this.state=a.Unloaded,this._allowedOrigins=[],this.newJacdacSimulator=!1,this.frameCleanupTimeout=void 0,this.debuggerSeq=1,this.debuggerResolvers={},this._allowedOrigins.push(window.location.origin),t.parentOrigin&&this._allowedOrigins.push(t.parentOrigin),this._allowedOrigins.push(this.getSimUrl().origin);let r=(null==t?void 0:t.messageSimulators)||{},i=(Object.keys(r).map(e=>r[e]).forEach(e=>{this._allowedOrigins.push(new URL(e.url).origin),e.localHostUrl&&this._allowedOrigins.push(new URL(e.localHostUrl).origin)}),u.U.isLocalHost()&&/[?&]simxdev(?:[=&#]|$)/i.test(window.location.href));Object.entries((null==t?void 0:t.simulatorExtensions)||{}).forEach(([e,t])=>{var r;t&&t.index&&t.aspectRatio&&void 0!==t.permanent&&(i&&t.devUrl?t.url=new URL(t.index,t.devUrl).toString():(e=[(r=this.getSimUrl()).pathname.replace(/---?.*/,""),"simx",e,"-",t.index].join("/"),t.url=new URL(e.replace(/^\/+/,""),r.origin).toString()),this._allowedOrigins.push(new URL(t.url).origin))}),this._allowedOrigins=u.U.unique(this._allowedOrigins,e=>e)}isDebug(){return this._runOptions&&!!this._runOptions.debug}isTracing(){return this._runOptions&&!!this._runOptions.trace}hasParts(){return this._runOptions&&this._runOptions.parts&&!!this._runOptions.parts.length}setDirty(){this.state==u.SimulatorState.Running&&this.suspend()}setPending(){this.setState(a.Pending)}focus(){var e=this.simFrames()[0];e&&e.focus()}registerDependentEditor(e){e&&(this._dependentEditors||(this._dependentEditors=[]),this._dependentEditors.push(e))}dependentEditors(){return this._dependentEditors&&(this._dependentEditors=this._dependentEditors.filter(e=>!!e.parent),this._dependentEditors.length||(this._dependentEditors=void 0)),this._dependentEditors}setStarting(){this.setState(a.Starting)}setHwDebugger(e){e?(this.hwdbg=e,this.setState(a.Running),this.container.style.opacity="0.3"):(delete this.container.style.opacity,this.hwdbg=null,this.setState(a.Running),this.stop())}handleHwDebuggerMsg(e){this.hwdbg&&this.handleMessage(e)}setThemes(e){u.U.assert(e&&0<e.length),this.themes=e}startRecording(e){this.simFrames()[0]&&this.postMessage({type:"recorder",action:"start",source:n,width:e})}stopRecording(){this.postMessage({type:"recorder",source:n,action:"stop"})}setFrameState(e){var t=e.nextElementSibling,r=t.nextElementSibling;switch(this.state){case a.Pending:case a.Starting:t.style.display="",t.className="",r.style.display="";break;case a.Stopped:case a.Suspended:u.U.addClass(e,this.state==a.Stopped||this._runOptions&&this._runOptions.autoRun?this.stoppedClass:this.invalidatedClass),this._runOptions&&this._runOptions.autoRun?t.style.display="none":(t.style.display="",t.className="videoplay xicon icon"),r.style.display="none",this.scheduleFrameCleanup();break;default:u.U.removeClass(e,this.stoppedClass),u.U.removeClass(e,this.invalidatedClass),t.style.display="none",r.style.display="none"}}setState(e){this.state!=e&&(this.state=e,this.freeze(this.state==a.Paused),this.simFrames().forEach(e=>this.setFrameState(e)),this.options.onStateChanged)&&this.options.onStateChanged(this.state)}freeze(e){let r="pause-overlay";e?u.util.toArray(this.container.querySelectorAll("div.simframe")).forEach(e=>{var t;e.querySelector("div."+r)||((t=document.createElement("div")).className=r,t.onclick=e=>(e.preventDefault(),!1),e.appendChild(t))}):u.util.toArray(this.container.querySelectorAll("div.simframe div."+r)).forEach(e=>e.parentElement.removeChild(e))}simFrames(e=!1){var t=u.util.toArray(this.container.getElementsByTagName("iframe")),r=this.loanedIFrame();return r&&!e&&t.unshift(r),t}getSimUrl(){var t=this.options.simUrl||(null==(t=window.pxtConfig)?void 0:t.simUrl)||(null==(t=pxt.webConfig)?void 0:t.simUrl)||location.origin+"/sim/simulator.html";try{return new URL(t)}catch(e){return new URL(t,location.origin)}}setSingleSimulator(){this.singleSimulator=!0}postMessage(r,i,n){if(this.hwdbg)this.hwdbg.postMessage(r);else{var e=this.dependentEditors();let s=this.simFrames(),t=(n&&(s=s.filter(e=>e.id===n)),!1);var a=r;if(i&&null!=a&&a.broadcast){a.srcFrameIndex=this.simFrames().findIndex(e=>e.contentWindow===i);var o=!(null==(o=this._currentRuntime)||!o.single),l=window.parent&&window.parent!==window.window?window.parent:window.opener;if(l&&i!==l&&l.postMessage(r,"*"),!(this.options.nestedEditorSim||null!=a&&a.toParentIFrameOnly))if(e)e.forEach(e=>{i!==e&&e.postMessage(r,window.location.origin)});else if(!o){let n="messagepacket"===r.type&&r.channel;var l=n&&this.options.messageSimulators&&this.options.messageSimulators[n],a=n&&this.options.simulatorExtensions&&this.options.simulatorExtensions[n],e=(e,t,r)=>{r=r||(null==(i=this._runOptions)?void 0:i.aspectRatio)||1.22;var i=this.createFrame(e),e=(this.container.appendChild(i),i.firstElementChild);e.dataset[d]=n,e.dataset[h]=r+"",u.U.addClass(i,"simmsg"),u.U.addClass(i,"simmsg"+u.U.sanitizeCssName(n)),t&&(e.dataset.permanent="true"),this.startFrame(e),s=this.simFrames()};a?(o=s.find(e=>e.dataset[d]===n),"jacdac/pxt-jacdac"===n&&(this.newJacdacSimulator=!0),o?o.dataset.runid!=this.runId&&this.startFrame(o):(o=new URL(a.url),this.options.parentOrigin&&o.searchParams.set("parentOrigin",encodeURIComponent(this.options.parentOrigin)),this.options.userLanguage&&o.searchParams.set("language",encodeURIComponent(this.options.userLanguage)),e(o.toString(),a.permanent,a.aspectRatio))):l?(o=s.find(e=>e.dataset[d]===n))?o.dataset.runid!=this.runId&&this.startFrame(o):"jacdac"===n&&this.newJacdacSimulator||e((u.U.isLocalHost()&&/localhostmessagesims=1/i.test(window.location.href)&&l.localHostUrl||l.url).replace("$PARENT_ORIGIN$",encodeURIComponent(this.options.parentOrigin||"")).replace("$LANGUAGE$",encodeURIComponent(this.options.userLanguage)),l.permanent,l.aspectRatio):(t=!0,a=s.filter(e=>!e.dataset[d]),n||0!=a.length&&(1!=a.length||this.singleSimulator)?2==a.length&&a[1].dataset.runid!=this.runId&&this.startFrame(a[1]):(this.container.appendChild(this.createFrame()),s=this.simFrames()))}}for(let e=0;e<s.length;++e){var c=s[e];if((!i||c.contentWindow!=i)&&(c.contentWindow&&(t?this.postDeferrableMessage(c,r):this.postMessageCore(c,r),"recorder"==r.type)&&"start"==r.action))break}}}postDeferrableMessage(e,t){!e.dataset.loading?this.postMessageCore(e,t):(this.deferredMessages||(this.deferredMessages=[]),this.deferredMessages.push([e,t]))}postMessageCore(e,t){var r=u.U.isLocalHostDev()?"*":e.dataset.origin;e.contentWindow.postMessage(t,r)}setRunOptionQueryParams(e){var t,r=new URL(e);if(null!=(e=this._runOptions)&&e.hideSimButtons&&r.searchParams.set("hideSimButtons","1"),null!=(e=this._runOptions)&&e.queryParameters)for(t of this._runOptions.queryParameters.split("&")){var[i,n]=t.split(/[:=]/);i&&n&&r.searchParams.set(i,n)}return r.toString()}createFrame(e){var t=document.createElement("div");t.className="simframe ui embed";let r=document.createElement("iframe");r.id="sim-frame-"+this.nextId(),r.title=u.localization.lf("Simulator"),r.allowFullscreen=!0,r.setAttribute("allow","autoplay;microphone"),r.setAttribute("sandbox","allow-same-origin allow-scripts"),r.className="no-select";var e=this.setRunOptionQueryParams(e||this.getSimUrl().toString()),e=(e+="#"+r.id,r.src=e,r.frameBorder="0",r.dataset.runid=this.runId,r.dataset.origin=new URL(e).origin||"*",r.dataset.loading="true",null!=(e=this._runOptions)&&e.autofocus&&r.setAttribute("autofocus","true"),t.appendChild(r),document.createElement("i")),i=(e.className="videoplay xicon icon",e.style.display="none",e.onclick=e=>(e.preventDefault(),this.state!=a.Running&&this.state!=a.Starting&&(this.options.restart?this.options.restart():this.start()),r.focus(),!1),t.appendChild(e),document.createElement("div"));return i.className="ui active loader",e.style.display="none",t.appendChild(i),this._runOptions&&this.applyAspectRatioToFrame(r),t}preload(e,t){this.addEventListeners(),t&&(this._currentRuntime=void 0,this.container.textContent=""),this.simFrames().length||(this.container.appendChild(this.createFrame()),this.applyAspectRatio(e),this.setStarting())}stop(e=!1,t=!1){this.state!==a.Stopped&&this.state!==a.Unloaded&&(this.clearDebugger(),this.stopSound(),this.postMessage({type:"stop",source:n}),this.setState(t?a.Starting:a.Stopped)),e&&this.unload()}suspend(){this.stopSound(),this.postMessage({type:"stop",source:n}),this.setState(a.Suspended)}unload(){this.cancelFrameCleanup(),u.U.removeChildren(this.container),this.setState(a.Unloaded),this._runOptions=void 0,this._currentRuntime=void 0,this.runId=void 0,this.deferredMessages=void 0}mute(e){this._currentRuntime&&(this._currentRuntime.mute=e),this.postMessage({type:"mute",source:n,mute:e})}stopSound(){this.postMessage({type:"stopsound",source:n})}isLoanedSimulator(e){return!!this.loanedSimulator&&this.loanedIFrame()==e}loanSimulator(){return this.loanedSimulator||(this.loanedSimulator=this.container.firstElementChild||this.createFrame(),this.loanedSimulator.parentNode&&this.container.removeChild(this.loanedSimulator)),this.loanedSimulator}unloanSimulator(){this.loanedSimulator&&(this.loanedSimulator.parentNode&&this.loanedSimulator.parentNode.removeChild(this.loanedSimulator),this.container.insertBefore(this.loanedSimulator,this.container.firstElementChild),delete this.loanedSimulator)}loanedIFrame(){return this.loanedSimulator&&this.loanedSimulator.parentNode&&this.loanedSimulator.querySelector("iframe")}cancelFrameCleanup(){this.frameCleanupTimeout&&(clearTimeout(this.frameCleanupTimeout),this.frameCleanupTimeout=void 0)}scheduleFrameCleanup(){this.cancelFrameCleanup(),this.frameCleanupTimeout=setTimeout(()=>{this.frameCleanupTimeout=void 0,this.cleanupFrames()},5e3)}applyAspectRatio(t){(t||this._runOptions)&&this.simFrames().forEach(e=>this.applyAspectRatioToFrame(e,t))}applyAspectRatioToFrame(e,t){let r,i,n,s,a=t;void 0===a&&(t=parseFloat(e.dataset[h]),isNaN(t)||(a=t)),void 0===(a=void 0===a&&(t=e.dataset[d])&&(t=null==(n=null==(i=null==(r=this.options)?void 0:r.messageSimulators)?void 0:i[t])?void 0:n.aspectRatio)?t:a)&&(a=(null==(s=this._runOptions)?void 0:s.aspectRatio)||1.22),e.parentElement.style.paddingBottom=100/a+"%"}cleanupFrames(){var e=this.simFrames(!0);e.shift(),e.filter(e=>!e.dataset.permanent).forEach(e=>{this.state!=a.Stopped&&e.dataset.runid==this.runId||(this.options.removeElement?this.options.removeElement(e.parentElement):e.parentElement.remove())})}hide(t){var e;this.suspend(),this.options.removeElement&&((e=this.simFrames()).forEach(e=>{this.options.removeElement(e.parentElement,t)}),0==e.length)&&t&&t()}unhide(){this.options.unhideElement&&this.simFrames().forEach(e=>{this.options.unhideElement(e.parentElement)})}setRunOptions(e={}){this._runOptions=e}run(e,t={}){this.setRunOptions(t),this.runId=this.nextId(),this._currentRuntime={type:"run",source:n,boardDefinition:t.boardDefinition,parts:t.parts,builtinParts:t.builtinParts,fnArgs:t.fnArgs,code:e,partDefinitions:t.partDefinitions,mute:t.mute,highContrast:t.highContrast,light:t.light,cdnUrl:t.cdnUrl,localizedStrings:t.localizedStrings,refCountingDebug:t.refCountingDebug,version:t.version,clickTrigger:t.clickTrigger,breakOnStart:t.breakOnStart,storedState:t.storedState,ipc:t.ipc,single:t.single,dependencies:t.dependencies,activePlayer:t.activePlayer,theme:t.theme},this.stopSound(),this.start()}restart(){this.stop(),this.cleanupFrames(),this.start()}areBreakpointsSet(){return this.breakpointsSet}start(){if(this.clearDebugger(),this.addEventListeners(),this.applyAspectRatio(),this.scheduleFrameCleanup(),this._currentRuntime){this.singleSimulator=!1,this.breakpointsSet=!1;let e=this.simFrames()[0];var t;e||(t=this.createFrame(),this.container.appendChild(t),e=t.firstElementChild),this.startFrame(e),this.debuggingFrame=e.id,this.setState(a.Running),this.setTraceInterval(this.traceInterval)}}startFrame(e){var t,r;return!(!this._currentRuntime||!e.contentWindow||((t=JSON.parse(JSON.stringify(this._currentRuntime))).frameCounter=++this.frameCounter,r=(null==(r=this._runOptions)?void 0:r.mpRole)||(null==(r=null==(r=/[\&\?]mp=(server|client)/i.exec(window.location.href))?void 0:r[1])?void 0:r.toLowerCase()),t.options={theme:this.themes[this.nextFrameId++%this.themes.length],mpRole:r},t.id=t.options.theme+"-"+this.nextId(),e.dataset.runid=this.runId,e.dataset.runtimeid=t.id,e.id!==this.debuggingFrame&&(t.traceDisabled=!0,t.breakOnStart=!1),this.postMessageCore(e,t),this.traceInterval&&this.setTraceInterval(this.traceInterval),this.applyAspectRatioToFrame(e),this.setFrameState(e),0))}handleDeferredMessages(t){var e;t.dataset.loading&&(delete t.dataset.loading,null!=(e=null==(e=this.deferredMessages)?void 0:e.filter(e=>e[0]===t))&&e.forEach(e=>{var[,e]=e;this.postMessageCore(t,e)}),this.deferredMessages=null==(e=this.deferredMessages)?void 0:e.filter(e=>e[0]!==t))}handleMessage(e,t){switch(e.type||""){case"ready":var r=e.frameid,r=document.getElementById(r);r&&(null!=(i=this._runOptions)&&i.autofocus&&r.focus(),this.startFrame(r),this.options.revealElement&&this.options.revealElement(r),this.handleDeferredMessages(r)),this.options.onSimulatorReady&&this.options.onSimulatorReady();break;case"status":var i=e.frameid,n=document.getElementById(i);if(n)if(e.runtimeid==n.dataset.runtimeid)switch(e.state){case"running":this.setState(a.Running),this.handleDeferredMessages(n);break;case"killed":this.setState(a.Stopped)}break;case"simulator":this.handleSimulatorCommand(e);break;case"serial":case"pxteditor":case"screenshot":case"custom":case"recorder":case"addextensions":break;case"aspectratio":var r=e,i=r.frameid,i=document.getElementById(i);i&&(i.dataset[h]=r.value+"",this.applyAspectRatioToFrame(i));break;case"debugger":this.handleDebuggerMessage(e);break;case"toplevelcodefinished":this.options.onTopLevelCodeEnd&&this.options.onTopLevelCodeEnd();break;case"setmutebuttonstate":null!=(i=(r=this.options).onMuteButtonStateChange)&&i.call(r,e.state);break;default:this.postMessage(e,t)}}addEventListeners(){this.listener||(this.listener=e=>{this.hwdbg||!u.U.isLocalHost()&&this._allowedOrigins.indexOf(e.origin)<0||this.handleMessage(e.data,e.source)},window.addEventListener("message",this.listener,!1))}removeEventListeners(){this.listener&&(window.removeEventListener("message",this.listener,!1),this.listener=void 0)}resume(e){let t;switch(e){case o.Resume:t="resume",this.setState(a.Running);break;case o.StepInto:t="stepinto",this.setState(a.Running);break;case o.StepOut:t="stepout",this.setState(a.Running);break;case o.StepOver:t="stepover",this.setState(a.Running);break;case o.Pause:t="pause";break;default:return void u.debug("unknown command")}this.postMessage({type:"debugger",subtype:t,source:n})}setBreakpoints(e){this.breakpointsSet=!0,this.postDebuggerMessage("config",{setBreakpoints:e},void 0,this.debuggingFrame)}setTraceInterval(e){this.traceInterval=e,this.postDebuggerMessage("traceConfig",{interval:e})}variablesAsync(e,t,r=!1){return this.postDebuggerMessageAsync("variables",{variablesReference:e,fields:t,includeAll:r},this.debuggingFrame).then(e=>e,e=>{})}handleSimulatorCommand(e){this.options.onSimulatorCommand&&this.options.onSimulatorCommand(e)}clearDebugger(){let t=new Error("Debugging cancelled");Object.keys(this.debuggerResolvers).forEach(e=>{e=this.debuggerResolvers[e].reject;e(t)}),this.debuggerResolvers={},this.debuggerSeq++}handleDebuggerMessage(e){var t;switch("trace"!==e.subtype&&u.log("DBG-MSG",e.subtype,e),e.seq&&(t=this.debuggerResolvers[e.seq].resolve,t)&&t(e),e.subtype){case"warning":this.options.onDebuggerWarning&&this.options.onDebuggerWarning(e);break;case"breakpoint":var r,i=e;if(this.state==a.Running){i.exceptionMessage?this.suspend():(this.setState(a.Paused),1<this.simFrames(!0).length&&this.resume(o.Pause)),this.options.onDebuggerBreakpoint&&this.options.onDebuggerBreakpoint(i);let e=i.exceptionMessage+"\n";for(r of i.stackframes){var n=r.funcInfo;e+=`   at ${n.functionName} (${n.fileName}:${n.line+1}:${n.column+1})
`}i.exceptionMessage&&u.error(e)}else u.error("debugger: trying to pause from "+this.state);break;case"trace":i=e;this.state==a.Running&&this.options.onTraceMessage&&this.options.onTraceMessage(i);break;default:var s,i=e.req_seq;i&&(s=this.debuggerResolvers[i].resolve,s)&&(delete this.debuggerResolvers[i],s(e))}}postDebuggerMessageAsync(i,n={},s){return new Promise((e,t)=>{var r=this.debuggerSeq++;this.debuggerResolvers[r.toString()]={resolve:e,reject:t},this.postDebuggerMessage(i,n,r,s)})}postDebuggerMessage(e,t={},r,i){t=JSON.parse(JSON.stringify(t));t.type="debugger",t.subtype=e,t.source=n,r&&(t.seq=r),this.postMessage(t,void 0,i)}nextId(){return this.nextFrameId+++(Math.random()+""+Math.random()).replace(/[^\d]/,"")}get stoppedClass(){return this.options&&this.options.stoppedClass||"grayscale"}get invalidatedClass(){return this.options&&this.options.invalidatedClass||"sepia"}}})(pxsim=pxsim||{}),(T=>{T.mkRange=function(e,t){for(var r=[];e<t;e++)r.push(e);return r},T.EventBus=class{constructor(e,t,r){this.runtime=e,this.board=t,this.valueToArgs=r,this.queues={},this.backgroundHandlerFlag=!1,this.nextNotifyEvent=1024,this.schedulerID=15,this.idleEventID=2,this.board.addMessageListener(this.handleMessage.bind(this))}handleMessage(e){"eventbus"===e.type&&this.queue(e.id,e.eventid,e.value)}setBackgroundHandlerFlag(){this.backgroundHandlerFlag=!0}setNotify(e,t){this.notifyID=e,this.notifyOneID=t}setIdle(e,t){this.schedulerID=e,this.idleEventID=t}start(e,t,r,i=!1){r=(r?"back":"fore")+":"+e+":"+t;return!this.queues[r]&&i&&(this.queues[r]=new T.EventQueue(this.runtime,this.valueToArgs)),this.queues[r]}listen(e,t,r,i=0){e==this.schedulerID&&t==this.idleEventID&&this.runtime.startIdle();e=this.start(e,t,this.backgroundHandlerFlag,!0);this.backgroundHandlerFlag?e.addHandler(r,i):e.setHandler(r,i),this.backgroundHandlerFlag=!1}removeBackgroundHandler(t){Object.keys(this.queues).forEach(e=>{e.startsWith("back:")&&this.queues[e].removeHandler(t)})}getQueues(e,t,r){var i=[this.start(0,0,r)];return 0==e&&0==t||(t&&i.push(this.start(0,t,r)),e&&i.push(this.start(e,0,r)),e&&t&&i.push(this.start(e,t,r))),i}queue(e,r,i=null){if(!T.runtime.pausedOnBreakpoint){let t=this.notifyID&&this.notifyOneID&&e==this.notifyOneID;t&&(e=this.notifyID);e=this.getQueues(e,r,!0).concat(this.getQueues(e,r,!1));this.lastEventValue=r,this.lastEventTimestampUs=T.U.perfNowUs(),T.U.promiseMapAllSeries(e,e=>e?e.push(i,t):Promise.resolve())}}queueIdle(){this.schedulerID&&this.idleEventID&&this.queue(this.schedulerID,this.idleEventID)}wait(e,t,r){this.start(e,t,!1,!0).addAwaiter(r)}getLastEventValue(){return this.lastEventValue}getLastEventTime(){return 4294967295&this.lastEventTimestampUs-T.runtime.startTimeUs}},T.AnimationQueue=class{constructor(r){this.runtime=r,this.queue=[],this.process=()=>{var e,t=this.queue[0];t&&!this.runtime.dead&&(r=this.runtime,e=t.frame(),r.queueDisplayUpdate(),r.maybeUpdateDisplay(),!1===e?(this.queue.shift(),this.queue[0]&&(this.queue[0].setTimeoutHandle=setTimeout(this.process,this.queue[0].interval)),t.whenDone(!1)):t.setTimeoutHandle=setTimeout(this.process,t.interval))}}cancelAll(){var e,t=this.queue;this.queue=[];for(e of t)e.whenDone(!0),e.setTimeoutHandle&&clearTimeout(e.setTimeoutHandle)}cancelCurrent(){var e=this.queue[0];e&&(this.queue.shift(),e.whenDone(!0),e.setTimeoutHandle)&&clearTimeout(e.setTimeoutHandle)}enqueue(e){e.whenDone||(e.whenDone=()=>{}),this.queue.push(e),1==this.queue.length&&this.process()}executeAsync(r){return T.U.assert(!r.whenDone),new Promise((e,t)=>{r.whenDone=e,this.enqueue(r)})}};{var e=T.AudioContextManager||(T.AudioContextManager={});let i=0,t,n,s,a=!1,o,r=[],l=[],c;function S(){return t||(t=(()=>{if(window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext)try{return new window.AudioContext}catch(e){}})())&&((c=t.createGain()).connect(t.destination),c.gain.setValueAtTime(1,0)),t}function g(){w(0),i=0,o&&o.pause()}function b(e,t){e.gain.value&&e.gain.setTargetAtTime(0,S().currentTime,.015),setTimeout(()=>{e.disconnect(),t&&t.disconnect()},450)}e.isAudioElementActive=function(){return!!s},e.mute=function(e){a=e;var t=S();e?c.gain.setTargetAtTime(0,t.currentTime,.015):c.gain.setTargetAtTime(1,t.currentTime,.015),!e&&t&&"suspended"===t.state&&t.resume()},e.isMuted=function(){return a},e.stopAll=function(){g(),v();for(var e of l)e()},e.stop=function(){if(g(),s){try{b(s,n)}catch(e){}s=void 0,n=void 0}},e.onStopAll=function(e){l.push(e)},e.frequency=function(){return i};let u=[null,"triangle","sawtooth","sine"],d,h,p=[],f=[];function C(e,t){var r=u[e];if(r)return(n=S().createOscillator()).type=r,n.frequency.value=t,n;let i;if(4==e)i=(()=>{if(!h){var r=(h=S().createBuffer(1,131072,S().sampleRate)).getChannelData(0);let t=251771520;for(let e=0;e<131072;e+=4)32768&(t=(t=(t^=t<<13)^t>>17)^t<<5)?(r[e]=1,r[e+1]=1,r[e+2]=-1,r[e+3]=-1):(r[e]=0,r[e+1]=0,r[e+2]=0,r[e+3]=0)}return h})();else if(5==e)i=(()=>{if(!d){var r=(d=S().createBuffer(1,1e5,S().sampleRate)).getChannelData(0);let t=251771520;for(let e=0;e<1e5;e++)t=(t=(t^=t<<13)^t>>17)^t<<5,r[e]=(1023&t)/512-1}return d})();else if(11<=e&&e<=15)i=(t=>{if(!f[t]){var e=S().createBuffer(1,1024,S().sampleRate),r=e.getChannelData(0);for(let e=0;e<1024;e++)r[e]=e<t/100*1024?1:-1;f[t]=e}return f[t]})(10*(e-10));else{if(!(16<=e&&e<=18))return null;i=(t=>{if(!p[t]){var e=S().createBuffer(1,1024,S().sampleRate),r=e.getChannelData(0),i=[770763591,3356908179],n=[15,31,63];for(let e=0;e<1024;e+=4){var s=e/4;0!=(i[(s&=n[t-4])>>5]&1<<(31&s))?(r[e]=1,r[e+1]=1,r[e+2]=-1,r[e+3]=-1):(r[e]=0,r[e+1]=0,r[e+2]=0,r[e+3]=0)}p[t]=e}return p[t]})(e-16+4)}var r=S().createBufferSource(),n=(r.buffer=i,r.loop=!0,4==e||16<=e&&e<=18);return n?r.playbackRate.value=t/(S().sampleRate/4):5!=e&&(r.playbackRate.value=t/(S().sampleRate/1024)),r}class k{constructor(){this.gain=S().createGain(),this.gain.connect(c),this.gain.gain.value=0}disconnectNodes(){this.gain?b(this.gain,this.generator):this.generator&&(this.generator.stop&&this.generator.stop(),this.generator.disconnect()),this.gain=null,this.generator=null}remove(){var e=r.indexOf(this);0<=e&&r.splice(e,1),this.disconnectNodes()}}let m=1;function v(){for(null!=e.soundEventCallback&&e.soundEventCallback("muteallchannels"),m++;r.length;)r[0].remove()}function y(e,t){if(!(e<0)){i=e;var r=S();if(r){t=Math.max(0,Math.min(1,t));try{n||(n=r.createOscillator(),(s=r.createGain()).gain.value=0,n.type="triangle",n.connect(s),s.connect(c),n.start(0)),w(t)}catch(e){return n=void 0,void(s=void 0)}n.frequency.value=e,w(t)}}}function w(e){null!=s&&s.gain&&s.gain.setTargetAtTime(e,t.currentTime,.015)}function A(k,E,x){return new Promise(async t=>{null!=e.soundEventCallback&&e.soundEventCallback("playinstructions",k);let r=!1,i=S(),n=_(),s=(n.gain.gain.value=1,{}),a={},o=i.currentTime,l=o,c=0,u=0;var d=(e,t)=>e/1024/4*(t?.5:1);let h=()=>{if(!r){r=!0,n.disconnectNodes();for(var e of Object.keys(s))s[e].stop(),s[e].disconnect(),a[e].disconnect();t()}};for(let e=0;e<k.length;e+=12){var p,f,m,g=k[e],b=I(k,e+2),v=I(k,e+4)/1e3,y=I(k,e+6),w=I(k,e+8),A=I(k,e+10);u+=v,0===g?l+=v:(p=11<=g&&g<=15,f=(s[g]||(s[g]=C(g,b),a[g]=i.createGain(),a[g].gain.value=0,a[g].connect(n.gain),s[g].connect(a[g]),s[g].start()),c&&g!==c&&a[c].gain.setTargetAtTime(0,l,.015),s[g]),m=a[g],f instanceof OscillatorNode?(f.frequency.setValueAtTime(b,l),f.frequency.linearRampToValueAtTime(A,l+v)):4==g||16<=g&&g<=18?f.playbackRate.linearRampToValueAtTime(A/(i.sampleRate/4),l+v):5!=g&&f.playbackRate.linearRampToValueAtTime(A/(i.sampleRate/1024),l+v),m.gain.setValueAtTime(d(y,p),l),m.gain.linearRampToValueAtTime(d(w,p),l+v),c=g,l+=v)}if(n.gain.gain.setTargetAtTime(0,l,.015),E||x){let r=()=>{var e,t=i.currentTime;t>o+u||(E&&E()?h():({frequency:t,volume:e}=((t,r)=>{let i=0;for(let e=0;e<r.length;e+=12){var n,s=I(r,e+2),a=I(r,e+4),o=I(r,e+6),l=I(r,e+8),c=I(r,e+10);if(!(i+a<t))return n=(t-i)/a,{frequency:s+(c-s)*n,volume:o+(l-o)*n};i+=a}return{frequency:-1,volume:-1}})(1e3*(t-o),k),x&&x(t,e/1024),requestAnimationFrame(r)))};requestAnimationFrame(r)}await T.U.delay(1e3*u),h()})}function I(e,t){var r=new Uint8Array(2);return r[0]=e[t],r[1]=e[t+1],new Uint16Array(r.buffer)[0]}function _(){20<r.length&&r[0].remove();var e=new k;return r.push(e),e}e.muteAllChannels=v,e.queuePlayInstructions=function(e,t){let r=m;T.U.delay(e).then(()=>r!=m?Promise.resolve():A(t.data))},e.tone=y,e.setCurrentToneGain=w,e.playBufferAsync=function(i){return i?new Promise(e=>{function t(){e&&e(),e=void 0}var r="data:audio/wav;base64,"+window.btoa((t=>{var r=t.length;let i="";for(let e=0;e<r;++e)i+=String.fromCharCode(t[e]);return i})(i.data));o=new Audio(r),a&&(o.volume=0),o.onended=()=>t(),o.onpause=()=>t(),o.onerror=()=>t(),o.play()}):Promise.resolve()},e.playPCMBufferStreamAsync=function(h,p,e=.3,t){return new Promise(s=>{let a=[],o=S().currentTime,l=!1,c=_(),u=(c.gain.gain.setValueAtTime(e,S().currentTime),()=>!!(t&&t()||!c.gain)&&(s&&s(),s=void 0,c.remove(),!0));function d(){for(;!l&&a.length<3&&!u();){var e=h();if(!e||!e.length){l=!0;break}i=n=r=t=void 0;var t=e;if(!u()){var r=S().createBuffer(1,t.length,p);if(r.copyToChannel)r.copyToChannel(t,0);else{var i=r.getChannelData(0);for(let e=0;e<t.length;e++)i[e]=t[e]}var n=S().createBufferSource();a.push(n),n.connect(c.gain),n.buffer=r,n.addEventListener("ended",()=>{a.shift().disconnect(),d()}),n.start(o),o+=r.duration}}l&&0===a.length&&(c.remove(),s&&s(),s=void 0)}d()})},e.playInstructionsAsync=A,e.sendMidiMessage=function(e){var t,r,i;(e=e.data).length&&(t=e[0]>>4,r=15&e[0],i=440*Math.pow(2,((e[1]||0)-69)/12),8==t||9==t&&0==(e[2]||0)?g():9==t&&(y(i,1),9==r)&&setTimeout(()=>g(),500))},e.startSamplePlayback=function(a,o,l,c,u){let d,h;return{promise:new Promise(e=>{h=e;let t=1;c<3e3?(t=c/3e3,c=3e3):768e3<c&&(t=c/768e3,c=768e3);var r=T.BufferMethods.fmtInfo(o).size,i=S().createBuffer(1,a.data.length/r,c),n=i.getChannelData(0);for(let e=0;e<i.length;e++)n[e]=T.BufferMethods.getNumber(a,o,e*r)/l*2-1;d=_();var s=S().createBufferSource();s.playbackRate.value=t,d.gain.gain.value=u,d.generator=s,d.generator.buffer=i,d.generator.connect(d.gain),d.generator.start(0),d.generator.addEventListener("ended",()=>{d.remove(),d=void 0,e()})}),cancel:()=>{d&&(d.remove(),d=void 0,h())}}},e.createAudioSourceNode=function(e,t,r){var e=new Audio(e),i=S().createMediaElementSource(e),n=S().createWaveShaper();return n.curve=(e=>{var t=new Float32Array(44100),r=1/(e=Math.max(.01,Math.min(1,e)));for(let e=0;e<44100;e++){var i=(2*e/44100-1)*r;t[e]=Math.max(-1,Math.min(1,i))}return t})(t),n.oversample="4x",(t=_()).generator=n,t.generator.connect(t.gain),i.connect(n),t.gain.gain.value=.1*r,e}}function t(){return"undefined"!=typeof window&&("ontouchstart"in window||navigator&&0<navigator.maxTouchPoints)}function r(){return"undefined"!=typeof window&&!!window.PointerEvent}T.isTouchEnabled=t,T.hasPointerEvents=r,T.pointerEvents=r()?{up:"pointerup",down:["pointerdown"],move:"pointermove",enter:"pointerenter",leave:"pointerleave"}:t()?{up:"mouseup",down:["mousedown","touchstart"],move:"touchmove",enter:"touchenter",leave:"touchend"}:{up:"mouseup",down:["mousedown"],move:"mousemove",enter:"mouseenter",leave:"mouseleave"}})(pxsim=pxsim||{}),(w=>{var t;function n(t,r){return e=>e*(r/t)}function r(e,t){var r=e[0]-t[0],e=e[1]-t[1];return r*r+e*e}(t=w.visuals||(w.visuals={})).translateEl=function(e,t){w.svg.hydrate(e,{transform:`translate(${t[0]} ${t[1]})`})},t.composeSVG=function(e){var[t,r]=[e.el1,e.el2],i=(w.U.assert(0==t.x&&0==t.y&&0==r.x&&0==r.y,"el1 and el2 x,y offsets not supported"),(e,t,r)=>w.svg.hydrate(e,{x:t,y:r})),n=(e,t,r)=>w.svg.hydrate(e,{width:t+"px",height:r+"px"}),s=e.scaleUnit2;let a=e.scaleUnit2/e.scaleUnit1;var o=t.w*a,l=t.h*a,c=(n(t.el,o,l),+r.w),u=+r.h,[n,d,h,p]=(n(r.el,c,u),e.margin),f=e.middleMargin,m=Math.max(o,c);let g=d+(m-o)/2,b=n,v=(i(t.el,g,b),d+(m-c)/2),y=b+l+f;return i(r.el,v,y),o=[b,b+l,y,y+u],c=w.svg.elt("svg",{version:"1.0",viewBox:`0 0 ${d+m+p} `+(n+l+f+u+h),class:"sim-bb"}),d=c,m=e.maxWidth,p=e.maxHeight,m&&w.svg.hydrate(d,{width:m}),p&&w.svg.hydrate(d,{height:p}),i(c,0,0),n=w.svg.child(c,"g"),c.appendChild(t.el),c.appendChild(r.el),l=w.svg.child(c,"g"),{under:n,over:l,host:c,edges:o,scaleUnit:s,toHostCoord1:e=>{var[e,t]=e;return[e*a+g,t*a+b]},toHostCoord2:e=>{var[e,t]=e;return[+e+v,+t+y]}}},t.mkScaleFn=n,t.mkImageSVG=function(e){var t=(r=n(e.imageUnitDist,e.targetUnitDist))(e.width),r=r(e.height),i=w.svg.elt("image",{width:t,height:r});return i.setAttributeNS("http://www.w3.org/1999/xlink","href",""+e.image),{el:i,w:t,h:r,x:0,y:0}},t.findDistSqrd=r,t.findClosestCoordIdx=function(t,e){return e.map(e=>r(t,e)).reduce((e,t,r,i)=>t<i[e]?r:e,0)},t.mkTxt=function(e,t,r,i,n,s,a){var o=w.svg.elt("text"),s=(s=s||-.33333)*r*n.length;return w.svg.hydrate(o,{style:`font-size:${r}px;`,transform:`translate(${e} ${t}) rotate(${i}) translate(${s} ${(a=a||.3)*r})`}),w.U.addClass(o,"noselect"),o.textContent=n,o},t.GPIO_WIRE_COLORS=["pink","orange","yellow","green","purple"],t.WIRE_COLOR_MAP={black:"#514f4d",white:"#fcfdfc",gray:"#acabab",purple:"#a772a1",blue:"#01a6e8",green:"#3cce73",yellow:"#ece600",orange:"#fdb262",red:"#f44f43",brown:"#c89764",pink:"#ff80fa"},t.mapWireColor=function(e){return t.WIRE_COLOR_MAP[e]||e},t.PIN_DIST=15,t.rgbToHsl=function(e){var[e,t,r]=e,[e,t,r]=[e/255,t/255,r/255],i=Math.min(e,t,r),n=Math.max(e,t,r),s=n-i;let a,o,l;return i=n+i,l=i/2*100,o=0==s?a=0:(n===e?a=(t-r)/s%6*60:n===t?a=60*((r-e)/s+2):n===r&&(a=60*((e-t)/s+4)),50<l?s/(2-i)*100:s/i*100),[Math.floor(a),Math.floor(o),Math.floor(l)]}})(pxsim=pxsim||{}),(o=>{var i,e;function n(e,t,r){e={class:e,d:t},r&&(e.title=r),t=i.elt("path");return i.hydrate(t,e),t}function s(e,t=!1){var r=i.elt("linearGradient");i.hydrate(r,{id:e,x1:"0%",y1:"0%",x2:t?"100%":"0%",y2:t?"0%":"100%"}),i.child(r,"stop",{offset:"0%"}),i.child(r,"stop",{offset:"100%"}),i.child(r,"stop",{offset:"100%"}),i.child(r,"stop",{offset:"100%"});return r}function r(e){var t=i.elt("title");return t.textContent=e,t}(e=i=o.svg||(o.svg={})).parseString=function(e){return(new DOMParser).parseFromString(e,"image/svg+xml").getElementsByTagName("svg").item(0)},e.toDataUri=function(e){return"data:image/svg+xml,"+encodeURI(e)},e.cursorPoint=function(e,t,r){return e.x=null!=r.clientX?r.clientX:r.pageX,e.y=null!=r.clientY?r.clientY:r.pageY,e.matrixTransform(t.getScreenCTM().inverse())},e.rotateElement=function(e,t,r,i){e.setAttribute("transform",`translate(${t},${r}) rotate(${i+90}) translate(${-t},${-r})`)},e.hydrate=function(e,t){for(var r in t)"title"==r?i.title(e,t[r]):e.setAttributeNS(null,r,t[r])},e.elt=function(e,t){return e=document.createElementNS("http://www.w3.org/2000/svg",e),t&&i.hydrate(e,t),e},e.child=function(e,t,r){return t=i.elt(t,r),e.appendChild(t),t},e.mkPath=n,e.path=function(e,t,r,i){return t=n(t,r,i),e.appendChild(t),t},e.fill=function(e,t){e.style.fill=t},e.filter=function(e,t){e.style.filter=t},e.fills=function(e,t){e.forEach(e=>e.style.fill=t)},e.isTouchEnabled=function(){return"undefined"!=typeof window&&("ontouchstart"in window||0<navigator.maxTouchPoints)},e.onClick=function(t,r){let i=!1;o.pointerEvents.down.forEach(e=>t.addEventListener(e,e=>i=!0,!1)),t.addEventListener(o.pointerEvents.up,e=>!i||(i=!1,r(e),e.preventDefault(),!1),!1)},e.buttonEvents=function(t,r,i,n,s){let a=!1;o.pointerEvents.down.forEach(e=>t.addEventListener(e,e=>(a=!0,i&&i(e),!0),!1)),t.addEventListener(o.pointerEvents.move,e=>!a||(r&&r(e),e.preventDefault(),!1),!1),t.addEventListener(o.pointerEvents.up,e=>{a=!1,n&&n(e)},!1),t.addEventListener(o.pointerEvents.leave,e=>{a=!1,n&&n(e)},!1),t.addEventListener("keydown",e=>{a=!1,s&&s(e)})},e.mkLinearGradient=s,e.linearGradient=function(e,t,r=!1){return t=s(t,r),e.appendChild(t),t},e.setGradientColors=function(e,t,r){e&&(e.childNodes[0].style.stopColor=t,e.childNodes[1].style.stopColor=t,e.childNodes[2].style.stopColor=r,e.childNodes[3].style.stopColor=r)},e.setGradientValue=function(e,t){e.childNodes[1].getAttribute("offset")!=t&&(e.childNodes[1].setAttribute("offset",t),e.childNodes[2].setAttribute("offset",t))},e.animate=function(e,t){o.U.addClass(e,t),(t=e.parentElement)&&(t.removeChild(e),t.appendChild(e))},e.mkTitle=r,e.title=function(e,t){return t=r(t),e.appendChild(t),t},e.toHtmlColor=function(e){return`rgba(${e>>16&255}, ${e>>8&255}, ${255&e}, ${e>>24&1})`}})(pxsim=pxsim||{}),(t=>{{(t.music||(t.music={})).Metronome=class{constructor(){this.tickListeners=[],this.onTick=()=>{for(var e of this.tickListeners)e()}}initAsync(){if(!this.metronomeLoadPromise){if(this.metronomeWorker)return this.metronomeWorker;this.metronomeLoadPromise=new Promise(t=>{this.metronomeWorker=new Worker("data:application/javascript,"+encodeURIComponent(e));let r=e=>{"ready"===e.data&&(t(this.metronomeWorker),this.metronomeWorker.removeEventListener("message",r),this.metronomeWorker.addEventListener("message",this.onTick))};this.metronomeWorker.addEventListener("message",r)})}return this.metronomeLoadPromise}stop(){this.postMessage({type:"stop"})}setInterval(e){this.currentInterval=e,this.postMessage({type:"set-interval",interval:e})}start(e){this.currentInterval=e,this.postMessage({type:"start",interval:e})}addTickListener(e){this.tickListeners.push(e)}removeTickListener(t){this.tickListeners=this.tickListeners.filter(e=>e!==t)}interval(){return this.currentInterval}dispose(){this.metronomeWorker?(this.metronomeWorker.terminate(),this.metronomeWorker=void 0,this.metronomeLoadPromise=void 0,this.tickListeners=[],this.interval=void 0):this.metronomeLoadPromise&&this.metronomeLoadPromise.then(()=>this.dispose())}postMessage(e){if(!this.metronomeWorker)throw new Error("initAsync not called on metronome");this.metronomeWorker.postMessage(e)}};let e=`
/**
 * Adpated from https://github.com/cwilso/metronome/
 */

let timerRef;
let interval;

addEventListener("message", ev => {
    const message = ev.data;

    if (message.type === "start") {
        updateInterval(message.interval, true);
    }
    else if (message.type === "stop") {
        clearInterval(timerRef);
        timerRef = undefined;
    }
    else if (message.type === "set-interval") {
        updateInterval(message.interval, false);
    }
})

postMessage("ready");

function updateInterval(interval, startIfStopped) {
    if (timerRef) {
        clearInterval(timerRef);
        startIfStopped = true;
    }
    interval = interval;

    if (startIfStopped) {
        timerRef = setInterval(() => postMessage("tick"), interval);
    }
}
`}})(pxsim=pxsim||{}),(e=>{(e=(e=(e=e.codal||(e.codal={})).music||(e.music={})).MusicalIntervals||(e.MusicalIntervals={})).chromaticInterval=[1,1.0417,1.125,1.2,1.25,1.3333,1.4063,1.5,1.6,1.6667,1.8,1.875],e.majorScaleInterval=[e.chromaticInterval[0],e.chromaticInterval[2],e.chromaticInterval[4],e.chromaticInterval[5],e.chromaticInterval[7],e.chromaticInterval[9],e.chromaticInterval[11]],e.minorScaleInterval=[e.chromaticInterval[0],e.chromaticInterval[2],e.chromaticInterval[3],e.chromaticInterval[5],e.chromaticInterval[7],e.chromaticInterval[8],e.chromaticInterval[10]],e.pentatonicScaleInterval=[e.chromaticInterval[0],e.chromaticInterval[2],e.chromaticInterval[4],e.chromaticInterval[7],e.chromaticInterval[9]],e.majorTriadInterval=[e.chromaticInterval[0],e.chromaticInterval[4],e.chromaticInterval[7]],e.minorTriadInterval=[e.chromaticInterval[0],e.chromaticInterval[3],e.chromaticInterval[7]],e.diminishedInterval=[e.chromaticInterval[0],e.chromaticInterval[3],e.chromaticInterval[6],e.chromaticInterval[9]],e.wholeToneInterval=[e.chromaticInterval[0],e.chromaticInterval[2],e.chromaticInterval[4],e.chromaticInterval[6],e.chromaticInterval[8],e.chromaticInterval[10]]})(pxsim=pxsim||{}),(e=>{var t;e=(e=e.codal||(e.codal={})).music||(e.music={}),(t=e.MusicalProgressions||(e.MusicalProgressions={})).chromatic={interval:e.MusicalIntervals.chromaticInterval,length:12},t.majorScale={interval:e.MusicalIntervals.majorScaleInterval,length:7},t.minorScale={interval:e.MusicalIntervals.minorScaleInterval,length:7},t.pentatonicScale={interval:e.MusicalIntervals.pentatonicScaleInterval,length:5},t.majorTriad={interval:e.MusicalIntervals.majorTriadInterval,length:3},t.minorTriad={interval:e.MusicalIntervals.minorTriadInterval,length:3},t.diminished={interval:e.MusicalIntervals.diminishedInterval,length:4},t.wholeTone={interval:e.MusicalIntervals.wholeToneInterval,length:6},t.calculateFrequencyFromProgression=function(e,t,r){var i=Math.floor(r/t.length),r=r%t.length;return e*Math.pow(2,i)*t.interval[r]}})(pxsim=pxsim||{}),(a=>{{var e=a.music||(a.music={});let s=[31,33,35,37,39,41,44,46,49,52,55,58,62,65,69,73,78,82,87,92,98,104,110,117,123,131,139,147,156,165,175,185,196,208,220,233,247,262,277,294,311,330,349,370,392,415,440,466,494,523,554,587,622,659,698,740,784,831,880,932,988,1047,1109,1175,1245,1319,1397,1480,1568,1661,1760,1865,1976,2093,2217,2349,2489,2637,2794,2960,3136,3322,3520,3729,3951,4186,4435,4699,4978,5274,5588,5920,6272,6645,7040,7459,7902];async function o(e,t,r,i,n=100){await a.AudioContextManager.playInstructionsAsync(a.music.renderInstrument(t,s[e],r,n),i)}async function l(e,t,r=100){await a.AudioContextManager.playInstructionsAsync(a.music.renderDrumInstrument(e,r),t)}function c(e,t,r){return 6e4/e/t*r}e.Sequencer=class{constructor(){this._currentTick=0,this._state="stop",this.listeners={},this.globalVolume=1024,this.trackVolumes=[],this.drumTrackVolumes=[],this.currentCancelToken={cancelled:!1},this.onTick=()=>{let t=this.currentCancelToken;for(let e=0;e<this.currentlyPlaying.tracks.length;e++){var r,i=this.currentlyPlaying.tracks[e];for(r of i.notes)if(r.startTick===this._currentTick)for(var n of r.notes)i.drums?l(i.drums[n.note],()=>t.cancelled,this.getDrumTrackVolume(e,n.note)):o(n.note,i.instrument,c(this.currentlyPlaying.beatsPerMinute,this.currentlyPlaying.ticksPerBeat,r.endTick-r.startTick),()=>t.cancelled,this.getMelodicTrackVolume(e));else if(r.startTick>this._currentTick)break}this.fireEvent("tick"),this._currentTick++,this._currentTick>=this.maxTick()&&("loop"===this._state?(this._currentTick=0,this.fireEvent("looped")):this.stop(!0))}}async initAsync(){this.metronome?await this.metronome.initAsync():(this.metronome=new e.Metronome,await this.metronome.initAsync(),this.metronome.addTickListener(this.onTick))}dispose(){this.metronome&&this.metronome.dispose(),this.metronome=void 0,this.stop(),this.currentlyPlaying=void 0,this.listeners={}}state(){return this._state}currentTick(){return this._currentTick}currentTime(){return 6e4/this.currentlyPlaying.beatsPerMinute/this.currentlyPlaying.ticksPerBeat*this.currentTick()}maxTick(){return this.currentlyPlaying?this.currentlyPlaying.measures*this.currentlyPlaying.beatsPerMeasure*this.currentlyPlaying.ticksPerBeat:0}duration(){return 6e4/this.currentlyPlaying.beatsPerMinute/this.currentlyPlaying.ticksPerBeat*this.maxTick()}start(e,t){this.startFrom(e,t,0)}startFrom(e,t,r){"stop"!==this._state&&this.stop(),void 0!==t&&(this.shouldLoop=t),this._currentTick=null!=r?r:0,this.currentlyPlaying=e,this.metronome.start(6e4/e.beatsPerMinute/e.ticksPerBeat*1),this._state=this.shouldLoop?"loop":"play",this.fireStateChange()}stop(e=!1){"stop"!==this._state&&(this._state="stop",this.metronome&&this.metronome.stop(),this.fireStateChange(),e||(this.currentCancelToken.cancelled=!0),this.currentCancelToken={cancelled:!1})}updateSong(e){this.currentlyPlaying=e,"stop"!==this._state&&this.metronome.setInterval(6e4/e.beatsPerMinute/e.ticksPerBeat*1)}setLooping(e){e&&"play"===this._state?(this._state="loop",this.fireStateChange()):e||"loop"!==this._state||(this._state="play",this.fireStateChange()),this.shouldLoop=e}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(e=>e!==t))}setVolume(e){this.globalVolume=Math.min(Math.max(e,0),1024)}setTrackVolume(e,t){for(t=Math.min(Math.max(t,0),1024);this.trackVolumes.length<e;)this.trackVolumes.push(1024);this.trackVolumes[e]=t}setDrumTrackVolume(e,t,r){for(r=Math.min(Math.max(r,0),1024);this.drumTrackVolumes.length<e;)this.drumTrackVolumes.push([]);for(;this.drumTrackVolumes[e].length<t;)this.drumTrackVolumes[e].push(1024);this.drumTrackVolumes[e][t]=r}getMelodicTrackVolume(e){let t=1024;return e<this.trackVolumes.length&&(t=this.trackVolumes[e]),this.globalVolume*(t/1024)}getDrumTrackVolume(e,t){let r=1024;return this.getMelodicTrackVolume(e)*((r=e<this.drumTrackVolumes.length&&t<this.drumTrackVolumes[e].length?this.drumTrackVolumes[e][t]:r)/1024)}fireStateChange(){this.fireEvent(this._state),this.fireEvent("state-change")}fireEvent(e){if(this.listeners[e])for(var t of this.listeners[e])t()}},e.playNoteAsync=o,e.playDrumAsync=l,e.tickToMs=c}})(pxsim=pxsim||{}),(e=>{{e=e.music||(e.music={});let w=12;function A(e,t,r,i){let n,s,a=0;return null!=(n=e.pitchEnvelope)&&n.amplitude&&(a+=o(e.pitchEnvelope,i,r)),null!=(s=e.pitchLFO)&&s.amplitude&&(a+=l(e.pitchLFO,i)),Math.max(t+a,0)}function k(e,t,r,i){let n,s=0;return e.ampEnvelope.amplitude&&(s+=o(e.ampEnvelope,r,t)),null!=(n=e.ampLFO)&&n.amplitude&&(s+=l(e.ampLFO,r)),Math.max(Math.min(s,e.ampEnvelope.amplitude),0)/1024*i|0}function o(e,t,r){var i,n=e.sustain/1024*e.amplitude;return r<t?t-r>e.release?0:t<e.attack?(i=e.amplitude/e.attack*r)-i/e.release*(t-r):t<e.attack+e.decay?(i=e.amplitude-(e.amplitude-n)/e.decay*(r-e.attack))-i/e.release*(t-r):n-n/e.release*(t-r):t<e.attack?e.amplitude/e.attack*t:t<e.attack+e.decay?e.amplitude-(e.amplitude-n)/e.decay*(t-e.attack):n}function l(e,t){return Math.cos(t/1e3*e.frequency*2*Math.PI)*e.amplitude}function E(e,t,r,i,n,s,a,o){0<r&&(e[t]=s,e[t+1]=0,c(e,t+2,a),c(e,t+4,r),c(e,t+6,255*i>>6),c(e,t+8,255*n>>6),c(e,t+10,o),t+=w),e[t]=0}function c(e,t,r){var i=new Uint8Array(2);new Uint16Array(i.buffer)[0]=0|r,e[t]=i[0],e[t+1]=i[1]}function u(e,t){var r=new Uint8Array(2);return r[0]=e[t],r[1]=e[t+1],new Uint16Array(r.buffer)[0]}function d(t,r,i,n){var s={startTick:u(t,r),endTick:u(t,r+2),notes:[]};for(let e=0;e<t[r+4];e++)s.notes.push(((e,t,r)=>{var i=e>>6,r={note:r?e:(63&e)+12*(t-2),enharmonicSpelling:"normal"};return 1==i?r.enharmonicSpelling="flat":2==i&&(r.enharmonicSpelling="sharp"),r})(t[r+5+e],i,n));return s}e.renderInstrument=function(t,r,i,n){var e,s,a,o=i+t.ampEnvelope.release,l=null!=(e=t.ampLFO)&&e.amplitude?Math.max(500/t.ampLFO.frequency,50):50,c=null!=(e=t.pitchLFO)&&e.amplitude?Math.max(500/t.pitchLFO.frequency,50):50,u=[0];let d=t.ampEnvelope.attack,h=null!=(e=t.pitchEnvelope)&&e.amplitude?t.pitchEnvelope.attack:o,p=null!=(e=t.pitchLFO)&&e.amplitude?c:o,f=null!=(e=t.ampLFO)&&e.amplitude?l:o,m=0;for(;m<o&&(d<=h&&d<=p&&d<=f?(m=d,u.push(d),d=m<t.ampEnvelope.attack+t.ampEnvelope.decay&&t.ampEnvelope.attack+t.ampEnvelope.decay<i?t.ampEnvelope.attack+t.ampEnvelope.decay:m<i?i:o):h<=p&&h<=f&&h<o?(m=h,u.push(h),h=m<t.pitchEnvelope.attack+t.pitchEnvelope.decay&&t.pitchEnvelope.attack+t.pitchEnvelope.decay<i?t.pitchEnvelope.attack+t.pitchEnvelope.decay:m<i?i:m<i+t.pitchEnvelope.release?Math.min(o,i+t.pitchEnvelope.release):o):p<=f&&p<o?(m=p,u.push(p),p+=c):f<o&&(m=f,u.push(f),f+=l),!(m>=o));){for(d<=m&&(d=m<t.ampEnvelope.attack+t.ampEnvelope.decay&&t.ampEnvelope.attack+t.ampEnvelope.decay<i?t.ampEnvelope.attack+t.ampEnvelope.decay:m<i?i:o),h<=m&&(h=m<t.pitchEnvelope.attack+t.pitchEnvelope.decay&&t.pitchEnvelope.attack+t.pitchEnvelope.decay<i?t.pitchEnvelope.attack+t.pitchEnvelope.decay:m<i?i:m<i+t.pitchEnvelope.release?Math.min(o,i+t.pitchEnvelope.release):o);f<=m;)f+=l;for(;p<=m;)p+=c}let g=0|k(t,i,0,n),b=0|A(t,r,i,0),v=0;var y=new Uint8Array(w*(u.length+1));for(let e=1;e<u.length;e++)v=(u[e]-v<5||(s=0|k(t,i,u[e],n),a=0|A(t,r,i,u[e]),E(y,12*(e-1),u[e]-v|0,g,s,t.waveform,b,a),g=s,b=a),u[e]);return E(y,12*u.length,10,g,0,t.waveform,b,b),y},e.renderDrumInstrument=function(t,r){let i=t.startVolume,n=t.startFrequency;var s=e=>e/1024*r,a=new Uint8Array((t.steps.length+1)*w);for(let e=0;e<t.steps.length;e++)E(a,e*w,t.steps[e].duration,s(i),s(t.steps[e].volume),t.steps[e].waveform,n,t.steps[e].frequency),i=t.steps[e].volume,n=t.steps[e].frequency;return E(a,t.steps.length*w,10,s(i),0,t.steps[t.steps.length-1].waveform,n,n),a},e.decodeSong=function(e){var t={beatsPerMinute:u(e,1),beatsPerMeasure:e[3],ticksPerBeat:e[4],measures:e[5],tracks:[]};let r=7;for(;r<e.length;){var[i,n]=((n,s)=>{if(n[s+1]){var i=n,a=s;let e={id:i[a],instrument:{ampEnvelope:{attack:0,decay:0,sustain:0,release:0,amplitude:0},waveform:0},notes:[],drums:[]},t=u(i,a+2),r=a+4;for(;r<a+4+t;)e.drums.push(((t,r)=>{var i={startFrequency:u(t,r+1),startVolume:u(t,r+3),steps:[]};for(let e=0;e<t[r];e++){var n=r+5+7*e;i.steps.push({waveform:t[n],frequency:u(t,n+1),volume:u(t,n+3),duration:u(t,n+5)})}return i})(i,r)),r+=5+7*e.drums[e.drums.length-1].steps.length;var o=u(i,r);for(r+=2;r<a+4+t+o;)e.notes.push(d(i,r,0,!0)),r+=5+e.notes[e.notes.length-1].notes.length;return[e,r]}{var l=n,n=s;let e={id:l[n],instrument:((e,t)=>({waveform:e[t],ampEnvelope:{attack:u(e,t+1),decay:u(e,t+3),sustain:u(e,t+5),release:u(e,t+7),amplitude:u(e,t+9)},pitchEnvelope:{attack:u(e,t+11),decay:u(e,t+13),sustain:u(e,t+15),release:u(e,t+17),amplitude:u(e,t+19)},ampLFO:{frequency:e[t+21],amplitude:u(e,22)},pitchLFO:{frequency:e[t+24],amplitude:u(e,25)},octave:e[t+27]}))(l,n+4),notes:[]},t=n+4+u(l,n+2),r=u(l,t),i=t+2;for(;i<t+2+r;)e.notes.push(d(l,i,e.instrument.octave,!1)),i+=5+e.notes[e.notes.length-1].notes.length;return[e,i]}})(e,r);r=n,t.tracks.push(i)}return t}}})(pxsim=pxsim||{}),(e=>{var u;e=e.codal||(e.codal={}),(u=e.music||(e.music={})).EMOJI_SYNTHESIZER_SAMPLE_RATE=44100,u.EMOJI_SYNTHESIZER_TONE_WIDTH_F=1024,u.EMOJI_SYNTHESIZER_TONE_WIDTH=1024,u.EMOJI_SYNTHESIZER_BUFFER_SIZE=512,u.EMOJI_SYNTHESIZER_TONE_EFFECT_PARAMETERS=2,u.EMOJI_SYNTHESIZER_TONE_EFFECTS=3,u.EMOJI_SYNTHESIZER_STATUS_ACTIVE=1,u.EMOJI_SYNTHESIZER_STATUS_OUTPUT_SILENCE_AS_EMPTY=2,u.EMOJI_SYNTHESIZER_STATUS_STOPPING=4,u.SoundEmojiSynthesizer=class{constructor(e,t=u.EMOJI_SYNTHESIZER_SAMPLE_RATE){this.samplesPerStep=[],this.status=0,this.effectPointer=0,this.position=0,this.bufferSize=u.EMOJI_SYNTHESIZER_BUFFER_SIZE,this.sampleRate=t,this.samplesToWrite=0,this.samplesWritten=0,this.sampleRange=1023,this.orMask=0,this.effectPointer=-1,this.volume=1}get effect(){return this.effectBuffer[this.effectPointer]}play(e){this.effectBuffer=e,this.effectPointer=-1,this.nextSoundEffect()}nextSoundEffect(){var e=null!=this.effect;if(this.status&u.EMOJI_SYNTHESIZER_STATUS_STOPPING&&(this.effectPointer=null,this.effectBuffer=[]),this.effect?this.effectPointer++:this.effectPointer=0,this.effectPointer>=this.effectBuffer.length&&(this.effectPointer=0)<=this.effect.duration)return this.effectPointer=-1,this.effectBuffer=[],this.samplesWritten=0,this.samplesToWrite=0,this.position=0,e;this.samplesToWrite=this.determineSampleCount(this.effect.duration),this.frequency=this.effect.frequency,this.volume=this.effect.volume;for(let e=this.samplesWritten=0;e<u.EMOJI_SYNTHESIZER_TONE_EFFECTS;e++)this.effect.effects[e].step=0,this.effect.effects[e].steps=Math.max(this.effect.effects[e].steps,1),this.samplesPerStep[e]=Math.floor(this.samplesToWrite/this.effect.effects[e].steps);return!1}pull(){let e=!1,r,i;for(;!e;){var t;for((this.samplesWritten==this.samplesToWrite||this.status&u.EMOJI_SYNTHESIZER_STATUS_STOPPING)&&(t=this.nextSoundEffect(),0==this.samplesToWrite||this.status&u.EMOJI_SYNTHESIZER_STATUS_STOPPING)&&(e=!0,t||this.status&u.EMOJI_SYNTHESIZER_STATUS_STOPPING)&&(this.status&=~u.EMOJI_SYNTHESIZER_STATUS_STOPPING),!(this.samplesWritten<this.samplesToWrite)&&this.status&u.EMOJI_SYNTHESIZER_STATUS_OUTPUT_SILENCE_AS_EMPTY||null!=r||(this.buffer=new Array(this.bufferSize),r=0,i=this.buffer.length);this.samplesWritten<this.samplesToWrite;){var n=u.EMOJI_SYNTHESIZER_TONE_WIDTH_F*this.frequency/this.sampleRate,s=this.sampleRange*this.volume/1024,a=512-512*s,o=[];for(let e=0;e<u.EMOJI_SYNTHESIZER_TONE_EFFECTS;e++)o[e]=this.samplesPerStep[e]*this.effect.effects[e].step,this.effect.effects[e].step==this.effect.effects[e].steps-1&&(o[e]=this.samplesToWrite);let t=o[0];for(let e=1;e<u.EMOJI_SYNTHESIZER_TONE_EFFECTS;e++)t=Math.min(t,o[e]);for(;this.samplesWritten<t;){if(r==i)return this.buffer;var l=this.effect.tone.tonePrint(this.effect.tone.parameter,Math.max(this.position,0));for(this.buffer[r]=l*s+a,r++,this.samplesWritten++,this.position+=n;this.position>u.EMOJI_SYNTHESIZER_TONE_WIDTH_F;)this.position-=u.EMOJI_SYNTHESIZER_TONE_WIDTH_F}for(let e=0;e<u.EMOJI_SYNTHESIZER_TONE_EFFECTS;e++)this.samplesWritten==o[e]&&this.effect.effects[e].step<this.effect.effects[e].steps&&(this.effect.effects[e].effect&&this.effect.effects[e].effect(this,this.effect.effects[e]),this.effect.effects[e].step++)}}if(null==r)this.buffer=[];else for(var c=.5*this.sampleRange;r<i;)this.buffer[r]=c,r++;return this.buffer}determineSampleCount(e){return e<0&&(e=-e),Math.floor(this.sampleRate*(e/1e3))}totalDuration(){let e=0;for(var t of this.effectBuffer)e+=t.duration;return e}}})(pxsim=pxsim||{}),(e=>{e=(e=e.codal||(e.codal={})).music||(e.music={});{e=e.Synthesizer||(e.Synthesizer={});let i=[0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,3,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,11,11,12,13,13,14,15,16,16,17,18,19,20,21,22,22,23,24,25,26,27,28,29,30,32,33,34,35,36,37,38,40,41,42,43,45,46,47,49,50,51,53,54,56,57,58,60,61,63,64,66,68,69,71,72,74,76,77,79,81,82,84,86,87,89,91,93,95,96,98,100,102,104,106,108,110,112,114,116,118,120,122,124,126,128,130,132,134,136,138,141,143,145,147,149,152,154,156,158,161,163,165,167,170,172,175,177,179,182,184,187,189,191,194,196,199,201,204,206,209,211,214,216,219,222,224,227,229,232,235,237,240,243,245,248,251,253,256,259,262,264,267,270,273,275,278,281,284,287,289,292,295,298,301,304,307,309,312,315,318,321,324,327,330,333,336,339,342,345,348,351,354,357,360,363,366,369,372,375,378,381,384,387,390,393,396,399,402,405,408,411,414,417,420,424,427,430,433,436,439,442,445,448,452,455,458,461,464,467,470,473,477,480,483,486,489,492,495,498,502,505,508,511,514,517,520,524,527,530,533,536,539,542,545,549,552,555,558,561,564,567,570,574,577,580,583,586,589,592,595,598,602,605,608,611,614,617,620,623,626,629,632,635,638,641,644,647,650,653,656,659,662,665,668,671,674,677,680,683,686,689,692,695,698,701,704,707,710,713,715,718,721,724,727,730,733,735,738,741,744,747,749,752,755,758,760,763,766,769,771,774,777,779,782,785,787,790,793,795,798,800,803,806,808,811,813,816,818,821,823,826,828,831,833,835,838,840,843,845,847,850,852,855,857,859,861,864,866,868,870,873,875,877,879,881,884,886,888,890,892,894,896,898,900,902,904,906,908,910,912,914,916,918,920,922,924,926,927,929,931,933,935,936,938,940,941,943,945,946,948,950,951,953,954,956,958,959,961,962,964,965,966,968,969,971,972,973,975,976,977,979,980,981,982,984,985,986,987,988,989,990,992,993,994,995,996,997,998,999,1e3,1e3,1001,1002,1003,1004,1005,1006,1006,1007,1008,1009,1009,1010,1011,1011,1012,1013,1013,1014,1014,1015,1015,1016,1016,1017,1017,1018,1018,1019,1019,1019,1020,1020,1020,1021,1021,1021,1021,1022,1022,1022,1022,1022,1022,1022,1022,1022,1022,1023,1022];e.SineTone=function(e,t){var r=1024-(t|=0);return r<512&&(t=r),i[t]},e.SawtoothTone=function(e,t){return t},e.TriangleTone=function(e,t){return t<512?2*t:2*(1023-t)},e.NoiseTone=function(e,t){let r=e[0];return t*(r=0==r?7919:r)&1023},e.SquareWaveTone=function(e,t){return t<512?1023:0}}})(pxsim=pxsim||{}),(e=>{var r;e=e.codal||(e.codal={}),(e=(r=e.music||(e.music={})).SoundSynthesizerEffects||(r.SoundSynthesizerEffects={})).noInterpolation=function(e,t){},e.linearInterpolation=function(e,t){var r=(t.parameter[0]-e.effect.frequency)/t.steps;e.frequency=e.effect.frequency+r*t.step},e.logarithmicInterpolation=function(e,t){e.frequency=e.effect.frequency+Math.log10(Math.max(t.step,.1))*(t.parameter[0]-e.effect.frequency)/1.95},e.curveInterpolation=function(e,t){e.frequency=Math.sin(3.12159*t.step/180)*(t.parameter[0]-e.effect.frequency)+e.effect.frequency},e.slowVibratoInterpolation=function(e,t){e.frequency=Math.sin(t.step/10)*t.parameter[0]+e.effect.frequency},e.warbleInterpolation=function(e,t){e.frequency=Math.sin(t.step)*(t.parameter[0]-e.effect.frequency)+e.effect.frequency},e.vibratoInterpolation=function(e,t){e.frequency=e.effect.frequency+Math.sin(t.step)*t.parameter[0]},e.exponentialRisingInterpolation=function(e,t){e.frequency=e.effect.frequency+Math.sin(.01745329*t.step)*t.parameter[0]},e.exponentialFallingInterpolation=function(e,t){e.frequency=e.effect.frequency+Math.cos(.01745329*t.step)*t.parameter[0]},e.appregrioAscending=function(e,t){e.frequency=r.MusicalProgressions.calculateFrequencyFromProgression(e.effect.frequency,t.parameter_p[0],t.step)},e.appregrioDescending=function(e,t){e.frequency=r.MusicalProgressions.calculateFrequencyFromProgression(e.effect.frequency,t.parameter_p[0],t.steps-t.step-1)},e.frequencyVibratoEffect=function(e,t){0!=t.step&&(t.step%2==0?e.frequency/=t.parameter[0]:e.frequency*=t.parameter[0])},e.volumeVibratoEffect=function(e,t){0!=t.step&&(t.step%2==0?e.volume/=t.parameter[0]:e.volume*=t.parameter[0])},e.adsrVolumeEffect=function(e,t){var r,i=.5*t.steps;t.step<=i?(r=(t.parameter[0]-e.effect.volume)/i,e.volume=e.effect.volume+t.step*r):(r=(t.parameter[1]-t.parameter[0])/i,e.volume=t.parameter[0]+(t.step-i)*r)},e.volumeRampEffect=function(e,t){var r=(t.parameter[0]-e.effect.volume)/t.steps;e.volume=e.effect.volume+t.step*r}})(pxsim=pxsim||{}),(c=>{var e=c.codal||(c.codal={});{var f=e.music||(e.music={});(e=f.WaveShape||(f.WaveShape={}))[e.Sine=0]="Sine",e[e.Sawtooth=1]="Sawtooth",e[e.Triangle=2]="Triangle",e[e.Square=3]="Square",e[e.Noise=4]="Noise",(e=f.InterpolationEffect||(f.InterpolationEffect={}))[e.None=0]="None",e[e.Linear=1]="Linear",e[e.Curve=2]="Curve",e[e.ExponentialRising=5]="ExponentialRising",e[e.ExponentialFalling=6]="ExponentialFalling",e[e.ArpeggioRisingMajor=8]="ArpeggioRisingMajor",e[e.ArpeggioRisingMinor=10]="ArpeggioRisingMinor",e[e.ArpeggioRisingDiminished=12]="ArpeggioRisingDiminished",e[e.ArpeggioRisingChromatic=14]="ArpeggioRisingChromatic",e[e.ArpeggioRisingWholeTone=16]="ArpeggioRisingWholeTone",e[e.ArpeggioFallingMajor=9]="ArpeggioFallingMajor",e[e.ArpeggioFallingMinor=11]="ArpeggioFallingMinor",e[e.ArpeggioFallingDiminished=13]="ArpeggioFallingDiminished",e[e.ArpeggioFallingChromatic=15]="ArpeggioFallingChromatic",e[e.ArpeggioFallingWholeTone=17]="ArpeggioFallingWholeTone",e[e.Logarithmic=18]="Logarithmic",(e=f.Effect||(f.Effect={}))[e.None=0]="None",e[e.Vibrato=1]="Vibrato",e[e.Tremolo=2]="Tremolo",e[e.Warble=3]="Warble";class r{constructor(){this.src="000000000000000000000000000000000000000000000000000000000000000000000000"}get wave(){return this.getValue(0,1)}set wave(e){this.setValue(0,i(e,0,4),1)}get volume(){return this.getValue(1,4)}set volume(e){this.setValue(1,i(e,0,1023),4)}get frequency(){return this.getValue(5,4)}set frequency(e){this.setValue(5,e,4)}get duration(){return this.getValue(9,4)}set duration(e){this.setValue(9,e,4)}get shape(){return this.getValue(13,2)}set shape(e){this.setValue(13,e,2)}get endFrequency(){return this.getValue(18,4)}set endFrequency(e){this.setValue(18,e,4)}get endVolume(){return this.getValue(26,4)}set endVolume(e){this.setValue(26,i(e,0,1023),4)}get steps(){return this.getValue(30,4)}set steps(e){this.setValue(30,e,4)}get fx(){return this.getValue(34,2)}set fx(e){this.setValue(34,i(e,0,3),2)}get fxParam(){return this.getValue(36,4)}set fxParam(e){this.setValue(36,e,4)}get fxnSteps(){return this.getValue(40,4)}set fxnSteps(e){this.setValue(40,e,4)}get frequencyRandomness(){return this.getValue(44,4)}set frequencyRandomness(e){this.setValue(44,e,4)}get endFrequencyRandomness(){return this.getValue(48,4)}set endFrequencyRandomness(e){this.setValue(48,e,4)}get volumeRandomness(){return this.getValue(52,4)}set volumeRandomness(e){this.setValue(52,e,4)}get endVolumeRandomness(){return this.getValue(56,4)}set endVolumeRandomness(e){this.setValue(56,e,4)}get durationRandomness(){return this.getValue(60,4)}set durationRandomness(e){this.setValue(60,e,4)}get fxParamRandomness(){return this.getValue(64,4)}set fxParamRandomness(e){this.setValue(64,e,4)}get fxnStepsRandomness(){return this.getValue(68,4)}set fxnStepsRandomness(e){this.setValue(68,e,4)}copy(){var e=new r;return e.src=this.src.slice(0),e}setValue(e,t,r){t=i(0|t,0,Math.pow(10,r)-1),this.src=this.src.substr(0,e)+((e,t)=>{let r=e+"";for(;r.length<t;)r="0"+r;return r})(t,r)+this.src.substr(e+r)}getValue(e,t){return parseInt(this.src.substr(e,t))}}f.Sound=r;let a=!1,o,l={cancelled:!1};function t(){o=[],l.cancelled=!0,l={cancelled:!1}}function u(e,t,i,r=.03){let n=new f.SoundEmojiSynthesizer(0);var s,e=(t=>{var r=Math.floor((t.length+1)/73),e=73*r-1;if(t.length!=e)return[];var i=[];for(let e=0;e<r;++e){var n=72*e+e;if(0<n&&","!=t[n-1])return[];var s=(()=>{var t={frequency:0,volume:1,duration:0,tone:{tonePrint:void 0,parameter:[0]},effects:[]};for(let e=0;e<f.EMOJI_SYNTHESIZER_TONE_EFFECTS;e++)t.effects.push({effect:void 0,step:0,steps:0,parameter:[],parameter_p:[]});return t})();if(!d(t.substr(n),s))return[];i.push(s)}return i})(e);n.play(e);let a=!1;return Promise.race([(s=n.totalDuration(),new Promise(e=>setTimeout(e,s)).then(()=>{a=!0})),c.AudioContextManager.playPCMBufferStreamAsync(()=>{if(n.effect){var t=n.pull(),r=(i&&i(n.frequency,n.volume),new Float32Array(t.length));for(let e=0;e<t.length;e++)r[e]=(t[e]-512)/512;return r}},n.sampleRate,r,()=>a||t&&t())])}function d(e,t){var r=parseInt(e.substr(0,1)),i=parseInt(e.substr(1,4)),n=parseInt(e.substr(5,4)),s=parseInt(e.substr(9,4)),a=parseInt(e.substr(13,2)),o=parseInt(e.substr(18,4)),l=parseInt(e.substr(26,4)),c=parseInt(e.substr(30,4)),u=parseInt(e.substr(34,2)),d=parseInt(e.substr(36,4)),h=parseInt(e.substr(40,4)),n=g(n,parseInt(e.substr(44,4))),o=g(o,parseInt(e.substr(48,4))),i=g(i,parseInt(e.substr(52,4))),l=g(l,parseInt(e.substr(56,4))),s=g(s,parseInt(e.substr(60,4))),d=g(d,parseInt(e.substr(64,4))),h=g(h,parseInt(e.substr(68,4)));if(-1==n||-1==o||-1==i||-1==l||-1==s||-1==d||-1==h)return!1;switch(r){case 0:t.tone.tonePrint=f.Synthesizer.SineTone;break;case 1:t.tone.tonePrint=f.Synthesizer.SawtoothTone;break;case 2:t.tone.tonePrint=f.Synthesizer.TriangleTone;break;case 3:t.tone.tonePrint=f.Synthesizer.SquareWaveTone;break;case 4:t.tone.tonePrint=f.Synthesizer.NoiseTone}switch(t.frequency=n,t.duration=s,t.effects[0].steps=c,a){case 0:t.effects[0].effect=f.SoundSynthesizerEffects.noInterpolation;break;case 1:t.effects[0].effect=f.SoundSynthesizerEffects.linearInterpolation,t.effects[0].parameter[0]=o;break;case 2:t.effects[0].effect=f.SoundSynthesizerEffects.curveInterpolation,t.effects[0].parameter[0]=o;break;case 5:t.effects[0].effect=f.SoundSynthesizerEffects.exponentialRisingInterpolation,t.effects[0].parameter[0]=o;break;case 6:t.effects[0].effect=f.SoundSynthesizerEffects.exponentialFallingInterpolation,t.effects[0].parameter[0]=o;break;case 8:case 10:case 12:case 14:case 16:t.effects[0].effect=f.SoundSynthesizerEffects.appregrioAscending;break;case 9:case 11:case 13:case 15:case 17:t.effects[0].effect=f.SoundSynthesizerEffects.appregrioDescending;break;case 18:t.effects[0].effect=f.SoundSynthesizerEffects.logarithmicInterpolation,t.effects[0].parameter[0]=o}switch(a){case 8:case 9:t.effects[0].parameter_p[0]=f.MusicalProgressions.majorScale;break;case 10:case 11:t.effects[0].parameter_p[0]=f.MusicalProgressions.minorScale;break;case 12:case 13:t.effects[0].parameter_p[0]=f.MusicalProgressions.diminished;break;case 14:case 15:t.effects[0].parameter_p[0]=f.MusicalProgressions.chromatic;break;case 16:case 17:t.effects[0].parameter_p[0]=f.MusicalProgressions.wholeTone}var e=m(0,i,1023)/1023,r=m(0,l,1023)/1023,p=(t.volume=e,t.effects[1].effect=f.SoundSynthesizerEffects.volumeRampEffect,t.effects[1].steps=36,t.effects[1].parameter[0]=r,Math.round(t.duration/1e4*h));switch(u){case 1:t.effects[2].steps=p,t.effects[2].effect=f.SoundSynthesizerEffects.frequencyVibratoEffect,t.effects[2].parameter[0]=d;break;case 2:t.effects[2].steps=p,t.effects[2].effect=f.SoundSynthesizerEffects.volumeVibratoEffect,t.effects[2].parameter[0]=d;break;case 3:t.effects[2].steps=p,t.effects[2].effect=f.SoundSynthesizerEffects.warbleInterpolation,t.effects[2].parameter[0]=d}return!0}function m(e,t,r){return Math.min(r,Math.max(e,t))}function g(e,t){var r;return e<0||t<0?-1:(r=2*t+1,r=Math.floor(Math.random()*r)-t,Math.abs(e+r))}function i(e,t,r){return Math.min(Math.max(e,t),r)}f.isSoundExpPlaying=function(){return a},f.__playSoundExpression=function(r,i,n=.03){o=o||[];let s=c.getResume();var e=new Promise((e,t)=>{o.push({notes:r,volume:n,onStarted:()=>{i||s()},onFinished:e,onCancelled:e})});a||!async function r(){if(o.length){a=!0;let t=o.shift(),e=l;try{t.onStarted(),await u(t.notes,()=>e.cancelled,void 0,t.volume),e.cancelled?t.onCancelled():t.onFinished()}catch(e){t.onCancelled()}r()}else a=!1}(),i&&e.then(s)},f.clearSoundQueue=t,f.playSoundExpressionAsync=u,f.__stopSoundExpressions=function(){t(),c.AudioContextManager.stopAll()},f.parseSoundExpression=d}})(pxsim=pxsim||{}),(e=>{class t{constructor(e){this.id=e}}e.Button=t,e.ButtonPairState=class{constructor(e){this.props=e,this.usesButtonAB=!1,this.aBtn=new t(this.props.ID_BUTTON_A),this.bBtn=new t(this.props.ID_BUTTON_B),this.abBtn=new t(this.props.ID_BUTTON_AB),this.abBtn.virtual=!0}}})(pxsim=pxsim||{}),(pxsim||(pxsim={})).CompassState=class{constructor(){this.usesHeading=!1,this.heading=90}},(pxsim||(pxsim={})).FileSystemState=class{constructor(){this.files={}}append(e,t){this.files[e]=(this.files[e]||"")+t}remove(e){delete this.files[e]}},(pxsim||(pxsim={})).LightSensorState=class{constructor(){this.usesLightLevel=!1,this.lightLevel=128}},(o=>{var l=o.visuals||(o.visuals={});l.mkBoardView=e=>{var t=e.visual;return new l.GenericBoardSvg({visualDef:t,boardDef:e.boardDef,wireframe:e.wireframe})},l.BoardHost=class{constructor(e,t){this.parts=[],this.boardView=e,(this.opts=t).boardDef.pinStyles||(t.boardDef.pinStyles={}),this.state=t.state;var r,i,n,s,e=t.partsList;let a=0<e.length||t.forceBreadboardLayout;a&&(this.breadboard=new l.Breadboard({wireframe:t.wireframe}),n=t.boardDef.marginWhenBreadboarding||[0,0,40,0],s=(n=l.composeSVG({el1:this.boardView.getView(),scaleUnit1:this.boardView.getPinDist(),el2:this.breadboard.getSVGAndSize(),scaleUnit2:this.breadboard.getPinDist(),margin:[n[0],n[1],20,n[3]],middleMargin:n[2],maxWidth:t.maxWidth,maxHeight:t.maxHeight})).under,r=n.over,this.view=n.host,i=n.edges,this.fromMBCoord=n.toHostCoord1,this.fromBBCoord=n.toHostCoord2,this.partGroup=r,this.partOverGroup=o.svg.child(this.view,"g"),this.style=o.svg.child(this.view,"style",{}),this.defs=o.svg.child(this.view,"defs",{}),this.wireFactory=new l.WireFactory(s,r,i,this.style,this.getLocCoord.bind(this),this.getPinStyle.bind(this)),((n=o.allocateDefinitions({boardDef:t.boardDef,partDefs:t.partDefs,fnArgs:t.fnArgs,getBBCoord:this.breadboard.getCoord.bind(this.breadboard),partsList:e})).partsAndWires.length||t.forceBreadboardLayout)&&(this.addAll(n),n.requiresBreadboard||t.forceBreadboardRender)?n.hideBreadboard&&this.breadboard&&this.breadboard.hide():a=!1),a||(delete this.breadboard,delete this.wireFactory,delete this.partOverGroup,delete this.partGroup,delete this.style,delete this.defs,delete this.fromBBCoord,delete this.fromMBCoord,s=this.boardView.getView().el,this.view=s,this.partGroup=o.svg.child(this.view,"g"),this.partOverGroup=o.svg.child(this.view,"g"),t.maxWidth&&o.svg.hydrate(this.view,{width:t.maxWidth}),t.maxHeight&&o.svg.hydrate(this.view,{height:t.maxHeight})),this.state.updateSubscribers.push(()=>this.updateState())}highlightBoardPin(e){this.boardView.highlightPin(e)}removeEventListeners(){this.boardView.removeEventListeners&&this.boardView.removeEventListeners()}highlightBreadboardPin(e){this.breadboard.highlightLoc(e)}highlightWire(e){e.wires.forEach(e=>{o.U.addClass(e,"highlight"),e.style.visibility="visible"}),o.U.addClass(e.endG,"highlight")}getView(){return this.view}screenshotAsync(n){var e=this.view.classList.contains("sim")?this.view:this.view.querySelector(".sim"),e=(e||this.view).cloneNode(!0),e=(e.setAttribute("width",e.viewBox.baseVal.width+""),e.setAttribute("height",e.viewBox.baseVal.height+""),(new XMLSerializer).serializeToString(e));let t="data:image/svg+xml,"+encodeURIComponent(e.replace(/\s+/g," ").replace(/"/g,"'"));return new Promise((r,e)=>{let i=document.createElement("img");i.onload=()=>{var e=document.createElement("canvas"),t=(e.width=i.width,e.height=i.height,0<n?(e.width=n,e.height=i.height*n/i.width|0):e.width<200?(e.width*=2,e.height*=2):480<e.width&&(e.width/=2,e.height/=2),e.getContext("2d"));t.drawImage(i,0,0,e.width,e.height),r(t.getImageData(0,0,e.width,e.height))},i.onerror=e=>{o.log(e),r(void 0)},i.src=t})}updateState(){this.parts.forEach(e=>e.updateState())}getBBCoord(e){e=this.breadboard.getCoord(e);return this.fromBBCoord(e)}getPinCoord(e){var t=this.boardView.getCoord(e);if(t)return this.fromMBCoord(t);o.error("Unable to find coord for pin: "+e)}getLocCoord(e){let t;return(t="breadboard"===e.type?this.getBBCoord(e):(e=e.pin,this.getPinCoord(e)))||o.debug("Unknown location: "+name),t}getPinStyle(e){return"breadboard"!=e.type&&this.opts.boardDef.pinStyles[e.pin]||"female"}addPart(e){let t=null;e.simulationBehavior?(r=e.simulationBehavior,i=this.state.builtinVisuals[r],r=this.state.builtinParts[r],(t=i()).init(this.state.bus,r,this.view,e.params)):(i=e.visual,t=new l.GenericPart(i)),this.parts.push(t),this.partGroup.appendChild(t.element),t.overElement&&this.partOverGroup.appendChild(t.overElement),t.defs&&t.defs.forEach(e=>this.defs.appendChild(e)),this.style.textContent+=t.style||"";var r=e.startColumnIdx,i=l.getRowName(e.startRowIdx),r=l.getColumnName(r),n=e.bbFit.xOffset/e.visual.pinDistance,s=e.bbFit.yOffset/e.visual.pinDistance,i=this.getBBCoord({type:"breadboard",row:i,col:r,xOffset:n,yOffset:s}),r=(t.moveToCoord(i),`sim-${e.name}-cmp`);return o.U.addClass(t.element,r),o.U.addClass(t.element,"sim-cmp"),t.updateTheme(),t.updateState(),t}addWire(e){return this.wireFactory.addWire(e.start,e.end,e.color)}addAll(i){i.partsAndWires.forEach(e=>{var t=e.wires,r=t&&t.every(e=>this.wireFactory.checkWire(e.start,e.end)),e=(r&&t.forEach(e=>i.wires.push(this.addWire(e))),e.part);!e||t&&!r||i.parts.push(this.addPart(e))}),i.requiresBreadboard=!!i.wires.length||!!i.parts.length}}})(pxsim=pxsim||{}),(D=>{{var F=D.visuals||(D.visuals={});F.BREADBOARD_MID_ROWS=10,F.BREADBOARD_MID_COLS=30;let E=[4,4];var e=F.BREADBOARD_MID_ROWS+E.length;let x=[4,9,14,19];var t=25+x.length;let T=15*(F.BREADBOARD_MID_COLS+3),S=15*(e+4+5.5),C=S*(2/3),I=S*(.5*(1-2/3)),_=(T-15*(F.BREADBOARD_MID_COLS-1))/2,U=I+(C-15*(e-1))/2,P=15*(t-1),N=(T-P)/2,O=(I-15)/2,R=N,L=O+I+C,M="abcdefghij".split("").reverse();function B(e){return""+(e+1)}function j(e){return M[e]}function $(n){var s=n.xOffset||0,t=n.yOffset||0,a=[];let o=D.svg.elt("g");var l=n.colStartIdx||0,c=n.rowStartIdx||0,u=e=>e?e.slice(0,e.length):[],d=(e,t)=>{let r=0;for(var i;0<=(i=e.indexOf(t));)e.splice(i,1),r+=1;return r};let h=0;var p=u(n.rowIdxsWithGap);for(let e=0;e<n.rowCount;e++){let r=0;var f=u(n.colIdxsWithGap);let i=t+e*n.pinDist+h*n.pinDist;var m=e+c;for(let e=0;e<n.colCount;e++){let t=s+e*n.pinDist+r*n.pinDist;var g=e+l,b=e=>(D.svg.hydrate(e.el,"circle"==e.el.tagName?{cx:t,cy:i}:{x:t-.5*e.w,y:i-.5*e.h}),o.appendChild(e.el),e.el),v=b(n.mkPin()),b=b(n.mkHoverPin()),y=n.getRowName(m),w=n.getColName(g),A=n.getGroupName?n.getGroupName(m,g):null,v={el:v,hoverEl:b,cx:t,cy:i,row:y,col:w,group:A};a.push(v),r+=d(f,g)}h+=d(p,m)}return{g:o,allPins:a}}function V(){var e=D.svg.elt("rect");return D.svg.hydrate(e,{class:"sim-bb-pin",rx:2,ry:2,width:6,height:6}),{el:e,w:6,h:6,x:0,y:0}}function q(){var e=D.svg.elt("rect");return D.svg.hydrate(e,{class:"sim-bb-pin-hover",rx:2,ry:2,width:6*1.3,height:6*1.3}),{el:e,w:6*1.3,h:6*1.3,x:0,y:0}}function H(e,t,r,i,n,s,a){let o=F.mkTxt(e,t,r,i,n),l=(D.U.addClass(o,"sim-bb-label"),a&&a.forEach(e=>D.U.addClass(o,e)),F.mkTxt(e,t,1.3*r,i,n));return D.U.addClass(l,"sim-bb-label-hover"),a&&a.forEach(e=>D.U.addClass(l,e)),{el:o,hoverEl:l,txt:n,group:s}}F.getColumnName=B,F.getRowName=j,F.mkGrid=$,F.Breadboard=class{constructor(e){this.allPins=[],this.allLabels=[],this.allPowerBars=[],this.rowColToPin={},this.rowColToLbls={},this.buildDom(),e.wireframe&&D.U.addClass(this.bb,"sim-bb-outline")}hide(){this.bb.style.display="none"}updateLocation(e,t){D.svg.hydrate(this.bb,{x:e+"px",y:t+"px"})}getPin(e,t){e=this.rowColToPin[e];return e&&e[t]||null}getCoord(e){var{row:e,col:t,xOffset:r,yOffset:i}=e,e=this.getPin(e,t);return e?[e.cx+15*(r||0),e.cy+15*(i||0)]:null}getPinDist(){return 15}buildDom(){this.bb=D.svg.elt("svg",{version:"1.0",viewBox:`0 0 ${T} `+S,class:"sim-bb",width:T+"px",height:S+"px"}),this.styleEl=D.svg.child(this.bb,"style",{}),this.styleEl.textContent+='\n        /* bread board */\n        .sim-bb-background {\n            fill:#E0E0E0;\n        }\n        .sim-bb-pin {\n            fill:#999;\n        }\n        .sim-bb-pin-hover {\n            visibility: hidden;\n            pointer-events: all;\n            stroke-width: 7.5px;\n            stroke: transparent;\n            fill: #777;\n        }\n        .sim-bb-pin-hover:hover {\n            visibility: visible;\n            fill:#444;\n        }\n        .sim-bb-group-wire {\n            stroke: #999;\n            stroke-width: 3.75px;\n            visibility: hidden;\n        }\n        .sim-bb-pin-group {\n            pointer-events: all;\n        }\n        .sim-bb-label,\n        .sim-bb-label-hover {\n            font-family:"Lucida Console", Monaco, monospace;\n            fill:#555;\n            pointer-events: all;\n            stroke-width: 0;\n            cursor: default;\n        }\n        .sim-bb-label-hover {\n            visibility: hidden;\n            fill:#000;\n            font-weight: bold;\n        }\n        .sim-bb-bar {\n            stroke-width: 0;\n        }\n        .sim-bb-blue {\n            fill:#1AA5D7;\n            stroke:#1AA5D7\n        }\n        .sim-bb-red {\n            fill:#DD4BA0;\n            stroke:#DD4BA0;\n        }\n        .sim-bb-pin-group:hover .sim-bb-pin-hover,\n        .sim-bb-pin-group:hover .sim-bb-group-wire,\n        .sim-bb-pin-group:hover .sim-bb-label-hover {\n            visibility: visible;\n        }\n        .sim-bb-pin-group:hover .sim-bb-label {\n            visibility: hidden;\n        }\n        /* outline mode */\n        .sim-bb-outline .sim-bb-background {\n            stroke-width: 2.142857142857143px;\n            fill: #FFF;\n            stroke: #000;\n        }\n        .sim-bb-outline .sim-bb-mid-channel {\n            fill: #FFF;\n            stroke: #888;\n            stroke-width: 2px;\n        }\n        /* grayed out */\n        .grayed .sim-bb-background {\n            stroke-width: 3px;\n        }\n        .grayed .sim-bb-red,\n        .grayed .sim-bb-blue {\n            fill: #BBB;\n        }\n        .grayed .sim-bb-bar {\n            fill: #FFF;\n        }\n        .grayed .sim-bb-pin {\n            fill: #000;\n            stroke: #FFF;\n            stroke-width: 3px;\n        }\n        .grayed .sim-bb-label {\n            fill: none;\n        }\n        .grayed .sim-bb-background {\n            stroke-width: 7.5px;\n            stroke: #555;\n        }\n        .grayed .sim-bb-group-wire {\n            stroke: #DDD;\n        }\n        .grayed .sim-bb-channel {\n            visibility: hidden;\n        }\n        /* highlighted */\n        .sim-bb-label.highlight {\n            visibility: hidden;\n        }\n        .sim-bb-label-hover.highlight {\n            visibility: visible;\n        }\n        .sim-bb-blue.highlight {\n            fill:#1AA5D7;\n        }\n        .sim-bb-red.highlight {\n            fill:#DD4BA0;\n        }\n        .sim-bb-bar.highlight {\n            stroke-width: 0px;\n        }\n        ',this.defs=D.svg.child(this.bb,"defs",{}),D.svg.child(this.bb,"rect",{class:"sim-bb-background",width:T,height:S,rx:4.5,ry:4.5});let i="sim-bb-channel-grad";var e=D.svg.elt("linearGradient"),e=(D.svg.hydrate(e,{id:i,x1:"0%",y1:"0%",x2:"0%",y2:"100%"}),this.defs.appendChild(e),D.svg.child(e,"stop",{offset:"0%",style:"stop-color: #AAA;"}),D.svg.child(e,"stop",{offset:"20%",style:"stop-color: #CCC;"}),D.svg.child(e,"stop",{offset:"80%",style:"stop-color: #CCC;"}),D.svg.child(e,"stop",{offset:"100%",style:"stop-color: #AAA;"}),(e,t,r)=>{r=D.svg.child(this.bb,"rect",{class:"sim-bb-channel "+(r||""),y:e-t/2,width:T,height:t});return r.setAttribute("fill",`url(#${i})`),r});e(I+C/2,15,"sim-bb-mid-channel"),e(I,.75,"sim-bb-sml-channel"),e(I+C,.75,"sim-bb-sml-channel");let r=e=>e<F.BREADBOARD_MID_ROWS/2?"b":"t",n=e=>e<25?"b":"t";var t=(e,t)=>""+r(e)+B(t);let s=e=>0===e?"-":"+";var e=(e,t)=>{t=n(t);return""+s(e)+t},a=$({xOffset:_,yOffset:U,rowCount:F.BREADBOARD_MID_ROWS,colCount:F.BREADBOARD_MID_COLS,pinDist:15,mkPin:V,mkHoverPin:q,getRowName:j,getColName:B,getGroupName:t,rowIdxsWithGap:E}),a=(a.g,this.allPins=this.allPins.concat(a.allPins),$({xOffset:R,yOffset:L,rowCount:2,colCount:25,pinDist:15,mkPin:V,mkHoverPin:q,getRowName:s,getColName:B,getGroupName:e,colIdxsWithGap:x})),a=(a.g,this.allPins=this.allPins.concat(a.allPins),$({xOffset:N,yOffset:O,rowCount:2,colCount:25,colStartIdx:25,pinDist:15,mkPin:V,mkHoverPin:q,getRowName:s,getColName:B,getGroupName:e,colIdxsWithGap:x.map(e=>e+25)})),o=(a.g,this.allPins=this.allPins.concat(a.allPins),this.allPins.forEach(e=>{var{el:e,row:t,col:r,hoverEl:i}=e,t=`(${t},${r})`;D.svg.hydrate(e,{title:t}),D.svg.hydrate(i,{title:t})}),this.allPins.forEach(e=>{let t=this.rowColToPin[e.row];(t=t||(this.rowColToPin[e.row]={}))[e.col]=e}),(e,t,r,i,n,s)=>{var[e,t]=this.getCoord({type:"breadboard",row:e,col:t});return H(e+r,t+i,10.5,-90,n,s)});for(let e=0;e<F.BREADBOARD_MID_COLS;e++){var l=B(e),c=o(M[0],l,0,-15,l,t(0,e)),c=(this.allLabels.push(c),F.BREADBOARD_MID_ROWS-1),l=o(j(c),l,0,15,l,t(c,e));this.allLabels.push(l)}for(let e=0;e<F.BREADBOARD_MID_ROWS;e++){var u=j(e),d=o(u,"1",-15,0,u),d=(this.allLabels.push(d),F.BREADBOARD_MID_COLS-1),d=o(u,B(d),15,0,u);this.allLabels.push(d)}let h=[H(13.05,I+C+12,30,-90,"-",e(0,0),["sim-bb-blue"]),H(12,I+C+I-12,25.5,-90,"+",e(1,0),["sim-bb-red"]),H(T-12+1.05,I+C+12,30,-90,"-",e(0,24),["sim-bb-blue"]),H(T-12,I+C+I-12,25.5,-90,"+",e(1,24),["sim-bb-red"])],p=(this.allLabels=this.allLabels.concat(h),[H(13.05,12,30,-90,"-",e(0,25),["sim-bb-blue"]),H(12,I-12,25.5,-90,"+",e(1,25),["sim-bb-red"]),H(T-12+1.05,12,30,-90,"-",e(0,49),["sim-bb-blue"]),H(T-12,I-12,25.5,-90,"+",e(1,49),["sim-bb-red"])]),f=(this.allLabels=this.allLabels.concat(p),{}),m=(this.allLabels.forEach(e=>{var t=e.txt;(f[t]=f[t]||[]).push(e)}),this.allPins.forEach(t=>{var{row:e,col:r}=t,i=this.rowColToLbls[e]||(this.rowColToLbls[e]={});let n=i[r]||(i[r]=[]);"-"===(i=t).row||"+"===i.row?Number(r)<=25?h.filter(e=>e.group==t.group).forEach(e=>n.push(e)):p.filter(e=>e.group==t.group).forEach(e=>n.push(e)):(f[e].forEach(e=>n.push(e)),f[r].forEach(e=>n.push(e)))}),22.5+P),g=3;var a=(m-P)/2,b=(e,t,r,i)=>{var n=D.svg.elt("rect"),i=(D.svg.hydrate(n,{class:"sim-bb-bar "+i,x:e,y:t-g/2,width:m,height:g}),{el:n,group:r});return i},b=[b(R-a,L-9,e(0,49),"sim-bb-blue"),b(R-a,15+L+9,e(1,49),"sim-bb-red"),b(N-a,O-9,e(0,0),"sim-bb-blue"),b(N-a,15+O+9,e(1,0),"sim-bb-red")];this.allPowerBars=this.allPowerBars.concat(b),this.allPowerBars.forEach(e=>this.bb.appendChild(e.el));let v=this.allPins.map(e=>e.group).filter((e,t,r)=>r.indexOf(e)==t),y=v.map(e=>D.svg.elt("g")),w=(y.forEach(e=>D.U.addClass(e,"sim-bb-pin-group")),y.forEach((e,t)=>D.U.addClass(e,"group-"+v[t])),{}),A=(v.forEach((e,t)=>w[e]=y[t]),{}),k=(this.allPins.forEach((e,t)=>{var r=e.group;(A[r]||(A[r]=[])).push(e)}),v.forEach(e=>{var t=A[e],[t,r]=[t.map(e=>e.cx),t.map(e=>e.cy)],i=e=>e.reduce((e,t)=>e<t?e:t),n=e=>e.reduce((e,t)=>t<e?e:t),[t,i,n,r]=[i(t),n(t),i(r),n(r)],s=D.svg.elt("rect"),i=Math.max(i-t,1e-4),r=Math.max(r-n,1e-4);D.svg.hydrate(s,{x:t,y:n,width:i,height:r}),D.U.addClass(s,"sim-bb-group-wire"),w[e].appendChild(s)}),this.allPins.forEach(e=>{var t=w[e.group];t.appendChild(e.el),t.appendChild(e.hoverEl)}),D.svg.elt("g"));D.svg.hydrate(k,{class:"sim-bb-group-misc"}),y.push(k),this.allLabels.forEach(e=>{var t;(e.group?((t=w[e.group]).appendChild(e.el),t):(k.appendChild(e.el),k)).appendChild(e.hoverEl)}),y.forEach(e=>this.bb.appendChild(e))}getSVGAndSize(){return{el:this.bb,y:0,x:0,w:T,h:S}}highlightLoc(e){var{row:e,col:t}=e,{}=this.rowColToPin[e][t];this.rowColToLbls[e][t].forEach(e=>{D.U.addClass(e.el,"highlight"),D.U.addClass(e.hoverEl,"highlight")})}}}})(pxsim=pxsim||{}),(m=>{{var g=m.visuals||(m.visuals={});g.BOARD_SYTLE=`
        .noselect {
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none;   /* Chrome/Safari/Opera */
            -khtml-user-select: none;    /* Konqueror */
            -moz-user-select: none;      /* Firefox */
            -ms-user-select: none;       /* Internet Explorer/Microsoft Edge */
            user-select: none;           /* Non-prefixed version, currently
                                            not supported by any browser */
        }

        .sim-board-pin {
            fill:#999;
            stroke:#000;
            stroke-width:${g.PIN_DIST/3}px;
        }
        .sim-board-pin-lbl {
            fill: #333;
        }
        .gray-cover {
            fill:#FFF;
            opacity: 0.3;
            stroke-width:0;
            visibility: hidden;
        }
        .sim-board-pin-hover {
            visibility: hidden;
            pointer-events: all;
            stroke-width:${g.PIN_DIST/6}px;
        }
        .sim-board-pin-hover:hover {
            visibility: visible;
        }
        .sim-board-pin-lbl {
            visibility: hidden;
        }
        .sim-board-outline .sim-board-pin-lbl {
            visibility: visible;
        }
        .sim-board-pin-lbl {
            fill: #555;
        }
        .sim-board-pin-lbl-hover {
            fill: red;
        }
        .sim-board-outline .sim-board-pin-lbl-hover {
            fill: black;
        }
        .sim-board-pin-lbl,
        .sim-board-pin-lbl-hover {
            font-family:"Lucida Console", Monaco, monospace;
            pointer-events: all;
            stroke-width: 0;
        }
        .sim-board-pin-lbl-hover {
            visibility: hidden;
        }
        .sim-board-outline .sim-board-pin-hover:hover + .sim-board-pin-lbl,
        .sim-board-pin-lbl.highlight {
            visibility: hidden;
        }
        .sim-board-outline .sim-board-pin-hover:hover + * + .sim-board-pin-lbl-hover,
        .sim-board-pin-lbl-hover.highlight {
            visibility: visible;
        }
        /* Graying out */
        .grayed .sim-board-pin-lbl:not(.highlight) {
            fill: #AAA;
        }
        .grayed .sim-board-pin:not(.highlight) {
            fill:#BBB;
            stroke:#777;
        }
        .grayed .gray-cover {
            visibility: inherit;
        }
        .grayed .sim-cmp:not(.notgrayed) {
            opacity: 0.3;
        }
        /* Highlighting */
        .sim-board-pin-lbl.highlight {
            fill: #000;
            font-weight: bold;
        }
        .sim-board-pin.highlight {
            fill:#999;
            stroke:#000;
        }
        `;let p=.7*g.PIN_DIST,f=1.5*p,r=.66666*g.PIN_DIST,i=.66666*g.PIN_DIST+g.PIN_DIST/3,n=0;class e{constructor(e){this.props=e,this.allPins=[],this.allLabels=[],this.pinNmToLbl={},this.pinNmToPin={},this.id=n++;let s=e.visualDef;var t=e.wireframe&&s.outlineImage?s.outlineImage:s.image,t=g.mkImageSVG({image:t,width:s.width,height:s.height,imageUnitDist:s.pinDist,targetUnitDist:g.PIN_DIST});let a=g.mkScaleFn(s.pinDist,g.PIN_DIST);this.width=t.w,this.height=t.h;t=t.el;this.element=m.svg.elt("svg"),m.svg.hydrate(this.element,{version:"1.0",viewBox:`0 0 ${this.width} `+this.height,class:"sim sim-board-id-"+this.id,x:"0px",y:"0px"}),e.wireframe&&m.U.addClass(this.element,"sim-board-outline"),this.style=m.svg.child(this.element,"style",{}),this.style.textContent+=g.BOARD_SYTLE,this.defs=m.svg.child(this.element,"defs",{}),this.g=m.svg.elt("g"),this.element.appendChild(this.g),this.g.appendChild(t),this.background=t,m.svg.hydrate(t,{class:"sim-board"});let o=()=>{var e=m.svg.elt("circle"),t=r;return m.svg.hydrate(e,{class:"sim-board-pin",r:t/2}),{el:e,w:t,h:t,x:0,y:0}},l=()=>{var e=m.svg.elt("circle"),t=i;return m.svg.hydrate(e,{class:"sim-board-pin-hover",r:t/2}),{el:e,w:t,h:t,x:0,y:0}},c=()=>{var e=m.svg.elt("rect"),t=r;return m.svg.hydrate(e,{class:"sim-board-pin",width:t,height:t}),{el:e,w:t,h:t,x:0,y:0}},u=()=>{var e=m.svg.elt("rect"),t=i;return m.svg.hydrate(e,{class:"sim-board-pin-hover",width:t,height:t}),{el:e,w:t,h:t,x:0,y:0}};e=s.pinBlocks.map((t,e)=>{var r=a(t.x)+g.PIN_DIST/2,i=a(t.y)+g.PIN_DIST/2,n=t.labels.length,r=g.mkGrid({xOffset:r,yOffset:i,rowCount:1,colCount:n,pinDist:g.PIN_DIST,mkPin:s.useCrocClips?o:c,mkHoverPin:s.useCrocClips?l:u,getRowName:()=>""+(e+1),getColName:e=>t.labels[e],getGroupName:()=>t.labels.join(" ")});r.allPins;return m.U.addClass(r.g,"sim-board-pin-group"),r});let d=[],h=(e.forEach((e,r)=>e.allPins.forEach((e,t)=>{this.allPins.push(e),d.push(s.pinBlocks[r])})),this.allPins.forEach(e=>{var t=e.col;m.svg.hydrate(e.el,{title:t}),m.svg.hydrate(e.hoverEl,{title:t})}),this.allPins.forEach(e=>{this.pinNmToPin[e.col]=e}),(e,t,r,i,n)=>{let s,a;s="below"===n?(n=.25*r*i.length,a=e,t+12+n):(n=.32*r*i.length,a=e,t-11-n);e=g.mkTxt(a,s,r,-90,i);return e});this.allLabels=this.allPins.map((e,t)=>{var r,i,n,t=d[t];return r=e.cx,i=e.cy,e=e.col,t=t.labelPosition||"above",n=h(r,i,p,e,t),m.U.addClass(n,"sim-board-pin-lbl"),r=h(r,i,f,e,t),m.U.addClass(r,"sim-board-pin-lbl-hover"),i={el:n,hoverEl:r,txt:e}}),this.allPins.forEach((e,t)=>{t=this.allLabels[t];this.pinNmToLbl[e.col]=t}),this.allPins.forEach((e,t)=>{t=this.allLabels[t];this.g.appendChild(e.el),this.g.appendChild(e.hoverEl),this.g.appendChild(t.el),this.g.appendChild(t.hoverEl)})}findPin(e){let t=this.pinNmToPin[e];return t=!t&&this.props.boardDef.gpioPinMap&&(e=this.props.boardDef.gpioPinMap[e])?this.pinNmToPin[e]:t}findPinLabel(e){let t=this.pinNmToLbl[e];return t=!t&&this.props.boardDef.gpioPinMap&&(e=this.props.boardDef.gpioPinMap[e])?this.pinNmToLbl[e]:t}getCoord(e){e=this.findPin(e);return e?[e.cx,e.cy]:null}mkGrayCover(e,t,r,i){var n=m.svg.elt("rect");return m.svg.hydrate(n,{x:e,y:t,width:r,height:i,class:"gray-cover"}),n}getView(){return{el:this.element,w:this.width,h:this.height,x:0,y:0}}getPinDist(){return g.PIN_DIST}highlightPin(e){var t=this.findPinLabel(e),e=this.findPin(e);t&&e&&(m.U.addClass(t.el,"highlight"),m.U.addClass(t.hoverEl,"highlight"),m.U.addClass(e.el,"highlight"),m.U.addClass(e.hoverEl,"highlight"))}}g.GenericBoardSvg=e}})(pxsim=pxsim||{}),(t=>{var r=t.visuals||(t.visuals={});function i(e){return r.mkImageSVG({image:e.image,width:e.width,height:e.height,imageUnitDist:e.pinDistance,targetUnitDist:r.PIN_DIST})}r.mkGenericPartSVG=i,r.GenericPart=class{constructor(e){this.style="",this.defs=[];e=i(e).el;this.element=t.svg.elt("g"),this.element.appendChild(e)}moveToCoord(e){r.translateEl(this.element,e)}init(e,t,r){}updateState(){}updateTheme(){}}})(pxsim=pxsim||{}),(m=>{var e;{var g=m.visuals||(m.visuals={});let a=g.PIN_DIST/2.5;function b(e){return e.replace(/\#/g,"-").replace(/\(/g,"-").replace(/\)/g,"-").replace(/\,/g,"-").replace(/\./g,"-").replace(/\s/g,"")}function v(e,t,r,i){var n=e=>e[0]+", "+e[1],[s,a]=e,[o,l]=t,c=l-a,e=m.svg.mkPath("sim-bb-wire",`M${n(e)} C${n([s,a+c*r])} ${n([o,l-c*r])} `+n(t));return m.U.addClass(e,"wire-stroke-"+i),e}function y(e,t,r){var i=e=>e[0]+", "+e[1],e=m.svg.mkPath("sim-bb-wire",`M${i(e)} L`+i(t));return m.U.addClass(e,"wire-stroke-"+r),e}function w(e,t){var r=g.PIN_DIST/4,i=m.svg.elt("circle"),n=e[0],e=e[1],s=a/2+r/2;return m.svg.hydrate(i,{cx:n,cy:e,r:s,class:"sim-bb-wire-end"}),m.U.addClass(i,"wire-fill-"+t),i.style["stroke-width"]=r+"px",i}function o(e,t){var r=.24*g.PIN_DIST,i=10*r,n=2*r,s=6*r,a=g.PIN_DIST/4,[e,o]=e,t=t?-1:1,l=m.svg.elt("g"),c=m.svg.elt("rect"),u=e-n/2,d=o-i/2,h=(m.svg.hydrate(c,{x:u,y:d,width:n,height:i,rx:.5,ry:.5,class:"sim-bb-wire-end"}),c.style["stroke-width"]=a+"px",m.svg.elt("rect")),o=o+t*(i/2+s/2)-s/2;return m.svg.hydrate(h,{x:e-r/2,y:o,width:r,height:s,class:"sim-bb-wire-bare-end"}),h.style.fill="#bbb",l.appendChild(h),l.appendChild(c),{el:l,x:u-a,y:Math.min(d,o),w:n+2*a,h:i+s}}function A(e,t){var r=.24*g.PIN_DIST,i=4*r,n=10*r,s=3.5*r,r=3.5*r,a=g.PIN_DIST/4,[e,o]=e,l=t?-1:1,c=m.svg.elt("g"),u=m.svg.elt("polygon"),d=e-i/2,h=o-n/2;var p=t?.15:.3,f=t?.7:1-.7,t=t?.3:.15,p=(m.svg.hydrate(u,{points:[[d+i*p,h],[d+i*(1-p),h],[d+i,h+n*f],[d+i*(1-t),h+n],[d+i*t,h+n],[d,h+n*f]].map(e=>e[0]+","+e[1]).join(" ")}),m.svg.hydrate(u,{rx:.5,ry:.5,class:"sim-bb-wire-end"}),u.style["stroke-width"]=a+"px",m.svg.elt("rect")),t=s,f=o+l*(n/2+t/2)-t/2;return m.svg.hydrate(p,{x:e-r/2,y:f,width:r,height:t,class:"sim-bb-wire-bare-end"}),c.appendChild(p),c.appendChild(u),{el:c,x:d-a,y:Math.min(h,f),w:i+2*a,h:n+t}}g.WIRES_CSS=`
        .sim-bb-wire {
            fill:none;
            stroke-linecap: round;
            stroke-width:${a}px;
            pointer-events: none;
        }
        .sim-bb-wire-end {
            stroke:#333;
            fill:#333;
        }
        .sim-bb-wire-bare-end {
            fill: #ccc;
        }
        .sim-bb-wire-hover {
            stroke-width: ${a}px;
            visibility: hidden;
            stroke-dasharray: ${g.PIN_DIST/10},${g.PIN_DIST/1.5};
            /*stroke-opacity: 0.4;*/
        }
        .grayed .sim-bb-wire-ends-g:not(.highlight) .sim-bb-wire-end {
            stroke: #777;
            fill: #777;
        }
        .grayed .sim-bb-wire:not(.highlight) {
            stroke: #CCC;
        }
        .sim-bb-wire-ends-g:hover .sim-bb-wire-end {
            stroke: red;
            fill: red;
        }
        .sim-bb-wire-ends-g:hover .sim-bb-wire-bare-end {
            stroke: #FFF;
            fill: #FFF;
        }
        `,(e=g.WireEndStyle||(g.WireEndStyle={}))[e.BBJumper=0]="BBJumper",e[e.OpenJumper=1]="OpenJumper",e[e.Croc=2]="Croc",g.mkWirePart=function(e,t,r=!1){var i=m.svg.elt("g"),[e,n]=e,s=[e-15,n-50],e=[e+15,n+50];t=g.mapWireColor(t);let a;return a=(r?A:o)(s,!0,t),n=((e,t,r)=>{let i=e=>e[0]+", "+e[1],[n,s]=e,[a,o]=t,l=o-s,c=[n,s+.8*l],u=[a,o-.8*l],d=m.svg.mkPath("sim-bb-wire",`M${i(e)} C${i(c)} ${i(u)} `+i(t));return d.style.stroke=r,{el:d,x:Math.min(n,a),y:Math.min(s,o),w:Math.abs(n-a),h:Math.abs(s-o)}})(s,e,t),r=o(e,!1),i.appendChild(n.el),i.appendChild(a.el),i.appendChild(r.el),s=Math.min(a.x,r.x),e=Math.max(a.x+a.w,r.x+r.w),t=Math.min(a.y,r.y),{el:i,x:s,y:t,w:e-s,h:Math.max(a.y+a.h,r.y+r.h)-t}};class t{constructor(e,t,r,i,n,s){this.nextWireId=0,this.styleEl=i,this.styleEl.textContent+=g.WIRES_CSS,this.underboard=e,this.overboard=t,this.boardEdges=r,this.getLocCoord=n,this.getPinStyle=s}indexOfMin(t){let r=0,i=t[0];for(let e=1;e<t.length;e++)t[e]<i&&(i=t[e],r=e);return r}closestEdgeIdx(t){var e=this.boardEdges.map(e=>Math.abs(t[1]-e));return this.indexOfMin(e)}closestEdge(e){return this.boardEdges[this.closestEdgeIdx(e)]}drawWire(i,n,e){var s=[],a=m.svg.child(this.overboard,"g",{class:"sim-bb-wire-group"}),o=e=>{var t=g.PIN_DIST/2,r=this.closestEdge(e);let i;return i=r-e[1]<0?r-t:r+t,[e[0],i]},l=this.nextWireId++,c=b(e),t=w(i,c),r=w(n,c),u=m.svg.child(a,"g",{class:"sim-bb-wire-ends-g"}),d=(u.appendChild(t),u.appendChild(r),this.closestEdgeIdx(i)),h=this.closestEdgeIdx(n);if(d==h){var p=y(i,n,c);a.appendChild(p),s.push(p)}else{p=o(i),o=o(n),i=y(i,p,c),n=y(n,o,c);let e,t,r=(t=!(1!=d&&2!=d||1!=h&&2!=h)?(e=v(p,o,.7,c),v(p,o,.7,c)):(e=y(p,o,c),y(p,o,c)),m.U.addClass(t,"sim-bb-wire-hover"),a.appendChild(i),s.push(i),a.appendChild(n),s.push(n),this.underboard.appendChild(e),s.push(e),a.appendChild(t),s.push(t),"sim-bb-wire-id-"+l);d=e=>m.U.addClass(e,r);d(u),d(t),this.styleEl.textContent+=`
                    .${r}:hover ~ .${r}.sim-bb-wire-hover {
                        visibility: visible;
                    }`}h=`
                .wire-stroke-${c} {
                    stroke: ${g.mapWireColor(e)};
                }
                .wire-fill-${c} {
                    fill: ${g.mapWireColor(e)};
                }
                `;return this.styleEl.textContent+=h,{endG:u,end1:t,end2:r,wires:s}}drawWireWithCrocs(i,n,e,s=!1){var a=[],o=m.svg.child(this.overboard,"g",{class:"sim-bb-wire-group"}),l=e=>{var t=g.PIN_DIST/2,r=this.closestEdge(e);let i;return i=r-e[1]<0?r-t:r+t,[e[0],i]},c=this.nextWireId++,u=b(e),t=w(i,u),d=n,[h,r]=n,h=([h,r]=n=[h,r+40],[h,r+-17]);let p;r=(p=(s?(e,t)=>{var r=.24*g.PIN_DIST,i=4*r,n=1.2*r,s=10*r,a=g.PIN_DIST/4,[e,o]=e,t=t?-1:1,l=m.svg.elt("g"),c=m.svg.elt("rect"),u=e-n/2,d=o+10-i/2,h=(m.svg.hydrate(c,{x:u,y:d,width:n,height:i,rx:.5,ry:.5,class:"sim-bb-wire-end"}),c.style["stroke-width"]=a+"px",m.svg.elt("rect")),o=o+10+t*(i/2+s/2)-s/2;return m.svg.hydrate(h,{x:e-r/2,y:o,width:r,height:s,class:"sim-bb-wire-bare-end"}),h.style.fill="#bbb",l.appendChild(h),l.appendChild(c),{el:l,x:u-a,y:Math.min(d,o),w:n+2*a,h:i+s}}:A)(h,!0)).el,s=m.svg.child(o,"g",{class:"sim-bb-wire-ends-g"}),s.appendChild(t),h=this.closestEdgeIdx(i),d=this.closestEdgeIdx(d);if(h==d){var f=y(i,n,u);o.appendChild(f),a.push(f)}else{f=l(i),l=y(i,f,u);let e,t,r=(t=!(1!=h&&2!=h||1!=d&&2!=d)?(e=v(f,n,.7,u),v(f,n,.7,u)):(e=y(f,n,u),y(f,n,u)),m.U.addClass(t,"sim-bb-wire-hover"),o.appendChild(l),a.push(l),this.underboard.appendChild(e),a.push(e),"sim-bb-wire-id-"+c);i=e=>m.U.addClass(e,r);i(s),i(t),this.styleEl.textContent+=`
                    .${r}:hover ~ .${r}.sim-bb-wire-hover {
                        visibility: visible;
                    }`}s.appendChild(r);h=`
                .wire-stroke-${u} {
                    stroke: ${g.mapWireColor(e)};
                }
                .wire-fill-${u} {
                    fill: ${g.mapWireColor(e)};
                }
                `;return this.styleEl.textContent+=h,{endG:s,end1:t,end2:r,wires:a}}checkWire(e,t){e=this.getLocCoord(e),t=this.getLocCoord(t);return!!e&&!!t}addWire(e,t,r){var i=this.getLocCoord(e),n=this.getLocCoord(t);if(i&&n){var s=this.getPinStyle(t);let e;return e="dalboard"==t.type&&"croc"==s?this.drawWireWithCrocs(i,n,r):this.drawWire(i,n,r)}m.debug(`unable to allocate wire for ${e} or `+t)}}g.WireFactory=t}})(pxsim=pxsim||{});