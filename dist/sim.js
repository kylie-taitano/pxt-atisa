var pxsim;(d=>{d.pinByName=function(e){let t=d.pinIds[e];null==t&&(t=d.getConfig(d.getConfigKey("PIN_"+e)));var i=d.pxtcore.getPin(t);return i||console.error("missing pin: "+e+"("+t+")"),i};class t extends d.CoreBoard{constructor(e){super(),this.boardDefinition=e;var t,i,s,n,o=[],a={};d.pinIds={};for(t of e.visual.pinBlocks)for(var r of t.labels)for(var l of r.split(/[\/,]/)){l=l.replace(/[~\s]+/g,"");h=l,i=void 0;var h=null!=(i=d.getConfigKey("PIN_"+h))?d.getConfig(i):(i=/^P(\d+)$/.exec(h))?parseInt(i[1]):null;null!=h&&(o.indexOf(h)<0&&(o.push(h),2<=h&&h<=11||32<=h&&h<=41)&&(a[l]=h),d.pinIds[r]=h,d.pinIds[l]=h)}for(s of d.getAllConfigKeys())/^PIN_/.test(s)&&null!=(n=d.getConfig(d.getConfigKey(s)))&&(o.indexOf(n)<0&&o.push(n),d.pinIds[s.replace(/^PIN_/,"")]=n);this.lightState={},this.microphoneState=new d.MicrophoneState(3001,52,120,75,96),this.storageState=new d.StorageState,this.lightSensorState=new d.AnalogSensorState(17,0,255,32,224),this.thermometerState=new d.AnalogSensorState(8,-20,50,10,30),this.thermometerUnitState=d.TemperatureUnit.Celsius,this.irState=new d.InfraredState(this),this.lcdState=new d.LCDState,this.controlMessageState=new d.ControlMessageState(this),this.bus.setNotify(1023,1022),this.builtinParts.radio=this.radioState=new d.RadioState(d.runtime,this,{ID_RADIO:9,RADIO_EVT_DATAGRAM:1}),this.builtinParts.pinbuttons=this.builtinParts.buttons=this.buttonState=new d.CommonButtonState,this.builtinParts.touch=this.touchButtonState=new d.TouchButtonState(o),this.builtinParts.audio=this.audioState=new d.AudioState,this.builtinParts.edgeconnector=this.edgeConnectorState=new d.EdgeConnectorState({pins:o,servos:a}),this.builtinParts.microservo=this.edgeConnectorState,this.builtinParts.accelerometer=this.accelerometerState=new d.AccelerometerState(d.runtime),this.builtinParts.screen=this.screenState=new d.ScreenState([],d.getConfig(37)||160,d.getConfig(38)||128),this.builtinVisuals.buttons=()=>new d.visuals.ButtonView,this.builtinVisuals.microservo=()=>new d.visuals.MicroServoView,this.builtinParts.neopixel=e=>this.neopixelState(e.id),this.builtinVisuals.neopixel=()=>new d.visuals.NeoPixelView(u),this.builtinPartVisuals.neopixel=e=>d.visuals.mkNeoPixelPart(e),this.builtinParts.dotstar=e=>this.neopixelState(e.id),this.builtinVisuals.dotstar=()=>new d.visuals.NeoPixelView(u),this.builtinPartVisuals.dotstar=e=>d.visuals.mkNeoPixelPart(e),this.builtinParts.lcd=this.lcdState,this.builtinVisuals.lcd=()=>new d.visuals.LCDView,this.builtinPartVisuals.lcd=e=>d.visuals.mkLCDPart(e),this.builtinPartVisuals.buttons=e=>d.visuals.mkBtnSvg(e),this.builtinPartVisuals.microservo=e=>d.visuals.mkMicroServoPart(e),this.builtinParts.slideswitch=e=>new d.ToggleState(e),this.builtinVisuals.slideswitch=()=>new d.visuals.ToggleComponentVisual(u),this.builtinPartVisuals.slideswitch=e=>d.visuals.mkSideSwitchPart(e),this.builtinParts.led=e=>new d.ToggleState(e),this.builtinVisuals.led=()=>new d.visuals.LedView(u),this.builtinPartVisuals.led=e=>d.visuals.mkLedPart(e),this.builtinVisuals.photocell=()=>new d.visuals.PhotoCellView(u),this.builtinPartVisuals.photocell=e=>d.visuals.mkPhotoCellPart(e),this.builtinVisuals.screen=()=>new d.visuals.ScreenView,this.builtinPartVisuals.screen=e=>d.visuals.mkScreenPart(e),this.neopixelPin=this.edgeConnectorState.getPin(d.getConfig(220))||this.edgeConnectorState.getPin(d.getConfig(222))||this.edgeConnectorState.getPin(d.getConfig(8))||this.edgeConnectorState.getPin(d.getConfig(20)),!this.neopixelPin&&null!=(e=null==(e=e.visual)?void 0:e.leds)&&e.some(e=>"neopixel"==e.color)&&(this.neopixelPin=this.edgeConnectorState.getPin(d.getConfig(54))),this.builtinParts.pixels=e=>this.neopixelState(!!this.neopixelPin&&this.neopixelPin.id),this.builtinVisuals.pixels=()=>new d.visuals.NeoPixelView(u),this.builtinPartVisuals.pixels=e=>d.visuals.mkNeoPixelPart(e)}kill(){super.kill(),d.AudioContextManager.stop()}initAsync(e){super.initAsync(e);e.options;var t=e.boardDefinition,i=e.parts,s=(i.sort(),e.partDefinitions||{}),i={state:this,boardDef:t,partsList:i,partDefs:s,fnArgs:e.fnArgs,maxWidth:"100%",maxHeight:"100%"};return this.viewHost=new d.visuals.BoardHost(d.visuals.mkBoardView({visual:t.visual,boardDef:t}),i),document.body.innerHTML="",document.body.appendChild(this.view=this.viewHost.getView()),this.accelerometerState.attachEvents(this.view),Promise.resolve()}screenshotAsync(e){return this.viewHost.screenshotAsync(e)}accelerometer(){return this.accelerometerState.accelerometer}getDefaultPitchPin(){return d.pxtcore.getPin(2)}tryGetNeopixelState(e){return this.lightState[e]}neopixelState(e){void 0===e&&(e=d.pxtcore.getConfig(19,-1));let t=this.lightState[e];return t=t||(this.lightState[e]=new d.CommonNeoPixelState)}}function e(e){d.U.assert(!d.runtime.board);e=new t(e.boardDefinition);d.runtime.board=e,d.runtime.postError=e=>{d.runtime.updateDisplay()}}function u(e){e=e&&d.readPin(e);return e&&d.pxtcore.getPin(d.pinIds[e])}d.DalBoard=t,d.initRuntimeWithDalBoard=e,d.initCurrentRuntime||(d.initCurrentRuntime=e),d.parsePinString=u,(d.jacdac||(d.jacdac={}))._setLedChannel=function(e,t){var i=d.board();i.neopixelPin&&((i=i.neopixelState(i.neopixelPin.id)).mode=d.NeoPixelMode.RGB_RGB,i.buffer||(i.buffer=new Uint8Array(3)),i.buffer[e]=(t=(t=65535<t?65535:t)<0?0:t)>>8,d.runtime.updateDisplay())}})(pxsim=pxsim||{}),(h=>{{var n=h.visuals||(h.visuals={});let a=h.svg;n.VIEW_WIDTH=372.3404255319149,n.VIEW_HEIGHT=361.70212765957444,n.PIN_DIST,n.themes=["#3ADCFE"].map(e=>({accent:e,pin:"#D4AF37",pinTouched:"#FFA500",pinActive:"#FF5500",ledOn:"#ff7777",ledOff:"#fff",buttonOuter:"#979797",buttonUps:["#000","#000","#000"],buttonDown:"#FFA500",virtualButtonDown:"#FFA500",virtualButtonOuter:"#333",virtualButtonUp:"#fff",lightLevelOn:"yellow",lightLevelOff:"#555",soundLevelOn:"#7f8c8d",soundLevelOff:"#555"})),n.randomTheme=function(){return n.themes[Math.floor(Math.random()*n.themes.length)]},n.getBoardDimensions=function(t){var e=e=>e*(n.PIN_DIST/t.pinDist),i=e(t.width);return{scaleFn:e,height:e(t.height),width:i,xOff:(n.VIEW_WIDTH-i)/2,yOff:20}};class e extends n.GenericBoardSvg{constructor(e){super(e),this.props=e;var t,i,s,n,o=this.getView().el;this.addDefs(o),this.onBoardLeds=[],this.onBoardNeopixels=[],this.onBoardTouchPads=[],this.onBoardButtons=[];for(t of e.visualDef.leds||[])"neopixel"==t.color?(i=new p(t.label,t.x,t.y,t.w||0),this.onBoardNeopixels.push(i),o.appendChild(i.element)):h.pinByName(t.label)&&(i=new u(t.x,t.y,t.color,h.pinByName(t.label),t.w||9,t.h||8),this.onBoardLeds.push(i),o.appendChild(i.element));this.onBoardNeopixels.sort((e,t)=>{e=parseInt(e.name.replace(/^[^\d]*/,""))||0,t=parseInt(t.name.replace(/^[^\d]*/,""))||0;return e<t?-1:t<e?1:0}),e.visualDef.reset&&(this.onBoardReset=new d(e.visualDef.reset),o.appendChild(this.onBoardReset.element));for(s of e.visualDef.touchPads||[]){var a,r=h.pinIds[s.label];r?(a=new m(s,r),this.onBoardTouchPads.push(a),o.appendChild(a.element)):console.error(`touch pin ${r} not found`)}for(n of e.visualDef.buttons||[]){var l=new c(n);this.onBoardButtons.push(l),o.appendChild(l.element)}e&&e.theme&&this.updateTheme(),e&&e.runtime&&(this.board=this.props.runtime.board,this.board.updateSubscribers.push(()=>this.updateState()),this.updateState())}updateTheme(){}updateState(){if(this.onBoardLeds.forEach(e=>e.updateState()),this.board.neopixelPin){var t=this.board.neopixelState(this.board.neopixelPin.id);if(t.buffer)for(let e=0;e<this.onBoardNeopixels.length;++e){var i=t.pixelColor(e);null!==i&&this.onBoardNeopixels[e].setColor(i)}}}addDefs(e){var t=a.child(e,"defs",{}),t=a.child(t,"filter",{id:"neopixelglow",x:"-200%",y:"-200%",width:"400%",height:"400%"}),t=(a.child(t,"feGaussianBlur",{stdDeviation:"4.3",result:"coloredBlur"}),a.child(t,"feMerge",{}));a.child(t,"feMergeNode",{in:"coloredBlur"}),a.child(t,"feMergeNode",{in:"SourceGraphic"}),a.child(e,"style",{}).textContent=`
.sim-board-pin {
    stroke: #404040;
    fill: #000000;
}
.sim-board-button {
    stroke: #aaa;
    stroke-width: 3px;
    fill: #666;
}
.sim-board-button.pressed {
    fill: #ee0;
}
.sim-board-button:hover {
    stroke-width: 4px;
    stroke: #ee0;
    cursor: pointer;
}
    `}}n.MetroBoardSvg=e;class d{constructor(e){e.w=e.w||15,e.h=e.h||15,this.element=a.elt("circle",{cx:e.x+e.w/2,cy:e.y+e.h/2,r:Math.max(e.w,e.h)/2,class:"sim-board-button"}),a.title(this.element,"RESET"),h.pointerEvents.down.forEach(e=>this.element.addEventListener(e,e=>{h.U.addClass(this.element,"pressed"),h.Runtime.postMessage({type:"simulator",command:"restart"})})),this.element.addEventListener(h.pointerEvents.leave,e=>{h.U.removeClass(this.element,"pressed")}),this.element.addEventListener(h.pointerEvents.up,e=>{h.U.removeClass(this.element,"pressed")})}}class u{constructor(e,t,i,s,n,o){this.colorOn=i,this.pin=s,this.colorOff="#aaa",this.backElement=a.elt("rect",{x:e,y:t,width:n,height:o,fill:this.colorOff}),this.ledElement=a.elt("rect",{x:e,y:t,width:n,height:o,fill:this.colorOn,opacity:0}),a.filter(this.ledElement,"url(#neopixelglow)"),this.element=a.elt("g",{class:"sim-led"}),this.element.appendChild(this.backElement),this.element.appendChild(this.ledElement)}updateTheme(e,t){e&&(this.colorOff=e),t&&(this.colorOn=t)}updateState(){var e=this.pin.mode&h.PinFlags.Digital?0<this.pin.value?1:0:.1+Math.max(0,Math.min(1023,this.pin.value))/1023*.8;this.ledElement.setAttribute("opacity",e.toString())}}class p{constructor(e,t,i,s){this.name=e,this.element=a.elt("circle",{cx:t+s/2,cy:i+s/2,r:10}),a.title(this.element,e)}setColor(e){var[e,t,i]=n.rgbToHsl(e),s=Math.max(1.3*i,85),i=90*i/100+10;this.element.style.stroke=`hsl(${e}, ${t}%, ${Math.min(3*i,75)}%)`,this.element.style.strokeWidth="1.5",a.fill(this.element,`hsl(${e}, ${t}%, ${s}%)`),a.filter(this.element,"url(#neopixelglow)")}}class c{constructor(e){(this.def=e).w=e.w||15,e.h=e.h||15,this.element=a.elt("circle",{cx:e.x+e.w/2,cy:e.y+e.h/2,r:Math.max(e.w,e.h)/2,class:"sim-board-button"}),a.title(this.element,e.label),this.button=void 0!==e.index?h.pxtcore.getButton(e.index):h.pxtcore.getButtonByPin(h.pinIds[e.label]),h.pointerEvents.down.forEach(e=>this.element.addEventListener(e,e=>{this.button.setPressed(!0),h.U.addClass(this.element,"pressed")})),this.element.addEventListener(h.pointerEvents.leave,e=>{h.U.removeClass(this.element,"pressed"),this.button.setPressed(!1)}),this.element.addEventListener(h.pointerEvents.up,e=>{h.U.removeClass(this.element,"pressed"),this.button.setPressed(!1)})}}class m{constructor(e,t){(this.def=e).w=e.w||15,e.h=e.h||15,this.element=a.elt("circle",{cx:e.x+e.w/2,cy:e.y+e.h/2,r:Math.max(e.w,e.h)/2,class:"sim-board-button"}),a.title(this.element,e.label),this.button=h.pxtcore.getTouchButton(t),h.pointerEvents.down.forEach(e=>this.element.addEventListener(e,e=>{this.button.setPressed(!0),h.U.addClass(this.element,"pressed")})),this.element.addEventListener(h.pointerEvents.leave,e=>{h.U.removeClass(this.element,"pressed"),this.button.setPressed(!1)}),this.element.addEventListener(h.pointerEvents.up,e=>{h.U.removeClass(this.element,"pressed"),this.button.setPressed(!1)})}}}})(pxsim=pxsim||{}),(t=>{var i;(i=t.visuals||(t.visuals={})).mkBoardView=e=>new i.MetroBoardSvg({runtime:t.runtime,theme:i.randomTheme(),visualDef:e.visual,boardDef:e.boardDef,disableTilt:!1,wireframe:e.wireframe})})(pxsim=pxsim||{}),(n=>{var i;(i=n.visuals||(n.visuals={})).ButtonView=class{constructor(){this.style=i.BUTTON_PAIR_STYLE}init(e,t,i,s){this.state=t,this.bus=e,this.defs=[],this.element=this.mkBtn();t=n.readPin(s.button);this.pinId=n.pinIds[t],this.button=new n.CommonButton(this.pinId),this.state.buttonsByPin[this.pinId]=this.button,this.updateState(),this.attachEvents()}moveToCoord(e){i.PIN_DIST;var[e,t]=e;i.translateEl(this.btn,[e,t])}updateState(){}updateTheme(){}mkBtn(){this.btn=i.mkBtnSvg([0,0]).el;var e=n.svg.elt("g");return n.U.addClass(e,"sim-buttonpair"),e.appendChild(this.btn),e}attachEvents(){[this.btn].forEach((t,e)=>{n.pointerEvents.down.forEach(e=>t.addEventListener(e,e=>{this.button.setPressed(!0)})),t.addEventListener(n.pointerEvents.leave,e=>{this.button.setPressed(!1)}),t.addEventListener(n.pointerEvents.up,e=>{this.button.setPressed(!1)})})}}})(pxsim=pxsim||{});