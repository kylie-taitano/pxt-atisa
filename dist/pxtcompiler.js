var pxt,pxt,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts,pxt,pxt,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts,ts;(i=>{let a,n=!1;class t{constructor(e){this.db=e}loadAsync(t,r,e,n){if(!/^v\d+\.\d+\.\d+$/.test(r))return n(t,r);let s=`gh-${e}-${t}#`+r;return a.cacheGet(s).then(e=>{if(e){e=i.Util.jsonTryParse(e);if(e)return i.debug("cache hit "+s),Promise.resolve(e)}return n(t,r).then(e=>e&&(i.debug("cached "+s),a.cacheSet(s,JSON.stringify(e)).then(()=>e)))})}latestVersionAsync(e,t){return this.db.latestVersionAsync(e,t)}loadConfigAsync(e,t){return this.loadAsync(e,t,"pxt",(e,t)=>this.db.loadConfigAsync(e,t))}loadPackageAsync(e,t){return this.loadAsync(e,t,"pkg",(e,t)=>this.db.loadPackageAsync(e,t))}loadTutorialMarkdown(e,t){return this.loadAsync(e,t,"tutorial",(e,t)=>this.db.loadTutorialMarkdown(e,t))}cacheReposAsync(e){return this.db.cacheReposAsync(e)}}class s{constructor(e){this.packageFiles=e}resolve(e,t){return""}readFile(e,t){var r="this"==e.id?t:"pxt_modules/"+e.id+"/"+t;return void 0!==this.packageFiles[r]?this.packageFiles[r]:i.appTarget.bundledpkgs[e.id]?i.appTarget.bundledpkgs[e.id][t]:null}writeFile(e,t,r){e="this"==e.id?"":"pxt_modules/"+e.id+"/";i.debug("write file "+e+t),this.packageFiles[e+t]=r}getHexInfoAsync(e){return Promise.resolve({hex:["SKIP"]})}cacheStoreAsync(e,t){return null!=a&&a.cacheSet?a.cacheSet(e,t):Promise.resolve()}cacheGetAsync(e){return null!=a&&a.cacheGet?a.cacheGet(e):Promise.resolve("")}downloadPackageAsync(r){var t,e;return n?(t=r,((e=null==a?void 0:a.pkgOverrideAsync)?e(t.id):Promise.resolve(void 0)).then(e=>e||t.commonDownloadAsync()).then(e=>{e&&i.U.iterMap(e,(e,t)=>{this.writeFile(r,e,t)})})):Promise.resolve()}resolveVersionAsync(e){return Promise.resolve("*")}}function o(e){if(e.target.preferredEditor==i.PYTHON_PROJECT_NAME){var t,r=i.U.clone(e);r.ast=!0,r.target.preferredEditor=i.JAVASCRIPT_PROJECT_NAME;for(t of r.sourceFiles)i.U.endsWith(t,".py")&&(r.fileSystem[t.slice(0,-3)+".ts"]=" ");var n=pxtc.compile(r);e.apisInfo=pxtc.getApiInfo(n.ast,r.jres)}}function r(e,t){e=new s(e);let r=new i.MainPackage(e);return r.loadAsync().then(()=>{var e=r.getTargetOptions();return e.hasHex&&(e.isNative=t.native),r.getCompileOptionsAsync(e)}).then(e=>(l(r.targetVersion(),e),r.getPreferredEditor()===i.PYTHON_PROJECT_NAME&&c(r.targetVersion(),e),o(e),e))}function l(e,t){if(e){i.debug("applying TS patches relative to "+e);for(var r of Object.keys(t.fileSystem)){var n;-1==r.indexOf("/")&&i.U.endsWith(r,".ts")&&(n=t.fileSystem[r])!=(n=i.patching.patchJavaScript(e,n))&&(i.debug("applying TS patch to "+r),t.fileSystem[r]=n)}}}function c(e,t){if(e){i.debug("applying PY patches relative to "+e);for(var r of Object.keys(t.fileSystem)){var n;-1==r.indexOf("/")&&i.U.endsWith(r,".py")&&(n=t.fileSystem[r])!=(n=i.patching.patchPython(e,n))&&(i.debug("applying PY patch to "+r),t.fileSystem[r]=n)}}}i.SimpleHost=s,i.prepPythonOptions=o,i.simpleInstallPackagesAsync=function(e){return e=new s(e),new i.MainPackage(e).loadAsync(!0)},i.simpleGetCompileOptionsAsync=r,i.simpleCompileAsync=function(e,t){return r(e,"boolean"==typeof t?{native:t}:t||{}).then(e=>pxtc.compile(e)).then(e=>(e.success||(e.errors=e.diagnostics.map(ts.pxtc.getDiagnosticString).join("")||"Unknown error."),e))},i.patchTS=l,i.patchPY=c,i.setupSimpleCompile=function(e){"undefined"==typeof global||global.btoa||(global.btoa=function(e){return Buffer.from(e,"binary").toString("base64")},global.atob=function(e){return Buffer.from(e,"base64").toString("binary")}),"undefined"!=typeof pxtTargetBundle&&(i.debug("setup app bundle"),i.setAppTarget(pxtTargetBundle)),e&&(a=e,n=!0,e.httpRequestAsync&&(i.Util.httpRequestCoreAsync=e.httpRequestAsync),i.github.forceProxy=!0,i.github.db=new t(new i.github.MemoryGithubDb)),i.debug("simple setup done")}})(pxt=pxt||{}),(x=>{x.simshim=function(e,t){let p=ts.SyntaxKind,d=e.getTypeChecker(),m=x.cpp.nsWriter("declare namespace"),f="",r;for(var n of e.getSourceFiles()){if(t){var s=t(n.fileName);if(x.debug("SimShim[1]: "+s.dir),!x.U.endsWith(s.dir,"/sim")&&!x.U.startsWith(n.fileName,"sim/"))continue}else if(!x.U.startsWith(n.fileName,"sim/"))continue;x.debug("SimShim[2]: "+n.fileName);for(var i of n.statements){var a=i;i.kind==p.ModuleDeclaration&&"pxsim"==a.name.text&&l((r=a).body)}}return(e={})[x.appTarget.corepkg]=m.finish(),e;function h(e){let t;return t=(t=ts.isExpression(e)?d.getContextualType(e):t)||d.getTypeAtLocation(e)}function g(e){let t=d.typeToString(e,r,ts.TypeFormatFlags.UseFullyQualifiedType);switch(t=t.replace(/^pxsim\./,"")){case"RefAction":return"() => void";case"RefBuffer":return"Buffer";default:return t}}function o(r){var t=b(r);if(t){m.setNs(f),m.write(t);var n,s,i,t=f,a=(f&&(f+="."),f+=r.name.text,t?"":"declare");let e="";if(r.heritageClauses)for(var o of r.heritageClauses)o.token==p.ExtendsKeyword&&(e=" extends "+g(h(o.types[0])));m.write(a+` class ${r.name.text}${e} {`),m.incrIndent();for(let t of r.members)switch(t.kind){case p.MethodDeclaration:c(t);break;case p.PropertyDeclaration:n=t,i=l=s=void 0,(s=b(n))&&(l=n.name.getText(),i="//% shim=."+l,n=d.getTypeAtLocation(n),m.write(s),m.write(i),m.write(`public ${l}: ${g(n)};`),m.write(""));break;case p.Constructor:s=t,i=void 0,(i=b(s))&&(d.getTypeAtLocation(s),s=s.parameters.map(e=>e.name.getText()+": "+g(h(e))),m.write(i),m.write(`//% shim="new ${f}"`),m.write(`constructor(${s.join(", ")});`),m.write(""));break;case p.GetAccessor:var l=r.members.some(e=>e.kind==p.SetAccessor&&e.name.getText()==t.name.getText());c(t,l)}f=t,m.decrIndent(),m.write("}")}}function b(e){e=pxtc.getComments(e);return/^\s*\/\/%/m.test(e)?e:null}function c(s,i=!1){var a=b(s);if(a){var o=s.name.getText(),l=s.kind==p.MethodDeclaration||s.kind==p.GetAccessor||s.kind==p.SetAccessor;let e="//% shim="+(l?"."+o:f+"::"+o);var c=d.getSignatureFromDeclaration(s);let t=d.getReturnTypeOfSignature(c);var c=/Async$/.test(o),u=(u=t,pxtc.isObjectType(u)&&u.objectFlags&ts.ObjectFlags.Reference&&"Promise"==u.symbol.name?u.typeArguments[0]:null),u=(u?(e+=" promise",t=u,c||x.U.userError(f+`::${o} should be called ${o}Async`)):c&&x.U.userError(f+`::${o} doesn't return a promise`),x.debug("emitFun: "+o),s.parameters.map(e=>`${e.name.getText()}${e.questionToken?"?":""}: `+g(h(e)))),c=o.replace(/Async$/,"");let r=l?"public":"function",n=`(${u.join(", ")})`;s.kind==p.GetAccessor&&(r=i?"public":"readonly",n="",e+=" property"),l||m.setNs(f),m.write(a),m.write(e),m.write(`${r} ${c}${n}: ${g(t)};`),m.write("")}}function l(e){switch(e.kind){case p.ModuleDeclaration:return t=e,(r=f)&&(f+="."),f+=t.name.text,l(t.body),void(f=r);case p.ModuleBlock:return e.statements.forEach(l);case p.FunctionDeclaration:return c(e);case p.ClassDeclaration:return o(e)}var t,r}}})(pxt=pxt||{}),(c=>{var u;(u=c.pxtc||(c.pxtc={})).annotate=function(e,t,r){var n=u.target,r=(u.target=r,e.getSourceFiles().filter(e=>e.fileName===t)[0]);let i=e.getTypeChecker();function s(e){var t=e.left,r=e.right,n=l(e.left),s=l(e.right);switch(e.operatorToken.kind!=u.SK.PlusToken&&e.operatorToken.kind!=u.SK.PlusEqualsToken||(u.isStringType(n)||u.isStringType(s)&&e.operatorToken.kind==u.SK.PlusToken)&&(u.pxtInfo(e).exprInfo={leftType:i.typeToString(n),rightType:i.typeToString(s)}),e.operatorToken.kind){case c.SyntaxKind.EqualsToken:case c.SyntaxKind.PlusEqualsToken:case c.SyntaxKind.MinusEqualsToken:if(t.kind==u.SK.PropertyAccessExpression){let e=o(t);e&&e.kind==u.SK.GetAccessor?a(t,[r],!1,e=c.getDeclarationOfKind(e.symbol,u.SK.SetAccessor)):e&&(e.kind==u.SK.PropertySignature||e.kind==u.SK.PropertyAssignment||u.target&&u.target.switches.slowFields)&&a(t,[r])}}}function a(t,r,e=!1,n=null){var e=e||!(l(t).flags&c.TypeFlags.Void),s=n||o(t);if(t.expression&&s){let e=!1;switch(s.kind){case u.SK.PropertySignature:case u.SK.PropertyAssignment:case u.SK.PropertyDeclaration:u.isStatic(s)||(e=!0);break;case u.SK.Parameter:u.isCtorField(s)&&(e=!0);break;case u.SK.GetAccessor:case u.SK.SetAccessor:case u.SK.MethodDeclaration:case u.SK.MethodSignature:u.isStatic(s)||(e=!0)}e&&((n=t.expression).kind===u.SK.PropertyAccessExpression?r.unshift(n.expression):r.unshift(t.expression))}n={decl:s,qName:s?u.getNodeFullName(i,s):"?",args:r,isExpression:e};u.pxtInfo(t).callInfo=n}function o(e){if(!e)return null;var t,r=i.getSymbolAtLocation(e);let n;return(n=r&&!(n=r.valueDeclaration)&&r.declarations&&(t=r.declarations[0])&&t.kind==c.SyntaxKind.ImportEqualsDeclaration&&(r=i.getSymbolAtLocation(t.moduleReference))?r.valueDeclaration:n)||e.kind!=u.SK.PropertyAccessExpression||(t=e,n={kind:u.SK.PropertySignature,symbol:{isBogusSymbol:!0,name:t.name.getText()},name:t.name},u.pxtInfo(n).flags|=2),n}function l(e){let t;var r=u.pxtInfo(e);return r.typeCache||(t=(t=c.isExpression(e)?i.getContextualType(e):t)||i.getTypeAtLocation(e))&&(c.isStringLiteral(e)?t:u.checkType(t))}!function e(t){c.forEachChild(t,r=>{switch(r.kind){case c.SyntaxKind.CallExpression:a(r,r.arguments.slice(0),null,o(r.expression));break;case c.SyntaxKind.PropertyAccessExpression:a(r,[]);break;case c.SyntaxKind.TaggedTemplateExpression:a(r,[r.template],!0,o(r.tag));break;case c.SyntaxKind.BinaryExpression:s(r);break;case c.SyntaxKind.Identifier:let t=o(r);if(t&&t.getSourceFile().fileName!==pxt.MAIN_TS&&t.kind==c.SyntaxKind.VariableDeclaration){let e=u.pxtInfo(r);e.flags|=4,e.commentAttrs||(e.commentAttrs=u.parseComments(t))}}e(r)})}(r),u.target=n}})(ts=ts||{}),(e=>{var y=e.pxtc||(e.pxtc={});function a(t){let r='"';for(let e=0;e<t.length;++e){var n=255&t.charCodeAt(e),s=String.fromCharCode(n);r+="\\"==s||'"'==s?"\\"+s:"\n"==s?"\\n":n<=15?"\\x0"+n.toString(16):n<32||127<n?"\\x"+n.toString(16):s}return r+'"'}function r(r){let e="pxt::string_inline_ascii_vt";var n=y.target.utf8?y.U.toUTF8(r,!0):r;let s="";if(n!==r)if(16<r.length){e="pxt::string_skiplist16_packed_vt";var i=[];let t=0;for(let e=0;e+16<=r.length;e+=16)t+=y.U.toUTF8(r.slice(e,e+16),!0).length,i.push(t);s=`
    .short ${n.length}, ${r.length}
    .short ${i.map(e=>e.toString()).join(", ")}
    .string ${a(n)}
`}else e="pxt::string_inline_utf8_vt";return s=s||`
    .short ${n.length}
    .string ${a(n)}
`,{vt:e,asm:s}}function n(e,t=""){return`
                .word ${e.length>>1}${t}
                .hex ${e}${e.length%4==0?"":"00"}
        `}y.asmStringLiteral=a,y.AssemblerSnippets=class{nop(){return"TBD(nop)"}reg_gets_imm(e,t){return"TBD(reg_gets_imm)"}proc_setup(e,t){return"TBD(proc_setup)"}push_fixed(e){return"TBD(push_fixed)"}push_local(e){return"TBD(push_local)"}push_locals(e){return"TBD(push_locals)"}pop_fixed(e){return"TBD(pop_fixed)"}pop_locals(e){return"TBD(pop_locals)"}proc_return(){return"TBD(proc_return)"}debugger_stmt(e){return""}debugger_bkpt(e){return""}debugger_proc(e){return""}unconditional_branch(e){return"TBD(unconditional_branch)"}beq(e){return"TBD(beq)"}bne(e){return"TBD(bne)"}cmp(e,t){return"TBD(cmp)"}cmp_zero(e){return"TBD(cmp_zero)"}arithmetic(){return""}load_reg_src_off(e,t,r,n,s,i){return"TBD(load_reg_src_off)"}rt_call(e,t,r){return"TBD(rt_call)"}call_lbl(e,t){return"TBD(call_lbl)"}call_reg(e){return"TBD(call_reg)"}helper_prologue(){return"TBD(lambda_prologue)"}helper_epilogue(){return"TBD(lambda_epilogue)"}pop_clean(e){return"TBD"}load_ptr_full(e,t){return"TBD(load_ptr_full)"}emit_int(e,t){return"TBD(emit_int)"}obj_header(e){return".word "+e}string_literal(e,t){t=r(t);return`
            .balign 4
            .object ${e}
            ${e}: ${this.obj_header(t.vt)}
            ${t.asm}
`}hex_literal(e,t){return`
.balign ${/f{16}/i.test(t)?8:4}
.object ${e}
${e}: ${this.obj_header("pxt::buffer_vt")}
${n(t)}
`}},y.utf8AsmStringLiteral=r,y.hexLiteralAsm=n,y.numBytes=function(t){let r=0;for(let e=t;0<e;e>>>=8)r++;return r||1},y.ProctoAssembler=class{constructor(e,t,r){this.resText="",this.exprStack=[],this.calls=[],this.proc=null,this.baseStackSize=0,this.labelledHelpers={},this.write=e=>{this.resText+=y.asmline(e)},this.t=e,this.bin=t,this.proc=r,this.proc&&this.work()}emitHelpers(){this.emitLambdaTrampoline(),this.emitArrayMethods(),this.emitFieldMethods(),this.emitBindHelper()}redirectOutput(e){var t=this.write;let r="";this.write=e=>r+=y.asmline(e);try{e()}finally{this.write=t}return r}stackSize(){return this.baseStackSize+this.exprStack.length}stackAlignmentNeeded(e=0){return!y.target.stackAlign||(e=y.target.stackAlign-(this.stackSize()+e&y.target.stackAlign-1))==y.target.stackAlign?0:e}getAssembly(){return this.resText}work(){this.write(`
;
; Function ${this.proc.getFullName()}
;
`);var e=this.proc.label();this.write(`.object ${e} `+JSON.stringify(this.proc.getFullName()));let i=e+"_pre",a=e+"_bkpt",o=e+"_locals",l=e+"_end";this.write(i+":"),this.emitLambdaWrapper(this.proc.isRoot),this.write(".section code"),this.write(e+":"),this.proc.classInfo&&this.proc.info.thisParameter&&!y.target.switches.skipClassCheck&&!y.target.switches.noThisCheckOpt&&(this.write("mov r7, lr"),this.write("ldr r0, [sp, #0]"),this.emitInstanceOf(this.proc.classInfo,"validate"),this.write("mov lr, r7")),this.write(`
${e}_nochk:
    @stackmark func
    @stackmark args
`),this.proc.fillDebugInfo=t=>{var e,r=t.getLabels();this.proc.debugInfo={locals:(1==this.proc.seqNo?this.bin.globals:this.proc.locals).map(e=>e.getDebugInfo()),args:this.proc.args.map(e=>e.getDebugInfo()),name:this.proc.getName(),codeStartLoc:y.U.lookup(r,o),codeEndLoc:y.U.lookup(r,l),bkptLoc:y.U.lookup(r,a),localsMark:y.U.lookup(t.stackAtLabel,o),idx:this.proc.seqNo,calls:this.calls,size:y.U.lookup(r,l)+2-y.U.lookup(r,i)};for(e of this.calls)e.addr=y.U.lookup(r,e.callLabel),e.stack=y.U.lookup(t.stackAtLabel,e.callLabel),e.callLabel=void 0;for(let e=0;e<this.proc.body.length;++e){var n,s=this.proc.body[e].breakpointInfo;s&&(n=y.U.lookup(t.stackAtLabel,"__brkp_"+s.id))!==this.proc.debugInfo.localsMark&&(pxt.log(s),pxt.log(t.stackAtLabel),y.U.oops(`offset doesn't match: ${n} != `+this.proc.debugInfo.localsMark))}},this.bin.breakpoints&&this.write(this.t.debugger_proc(a)),this.baseStackSize=1;e=this.proc.locals.length;this.write("push {lr}"),this.write(".locals:\n"),this.proc.perfCounterNo&&(this.write(this.t.emit_int(this.proc.perfCounterNo,"r0")),this.write("bl pxt::startPerfCounter")),this.write(this.t.proc_setup(e)),this.baseStackSize+=e,this.write("@stackmark locals"),this.write(o+":");for(let e=0;e<this.proc.body.length;++e){var t,r=this.proc.body[e];switch(r.stmtKind){case y.ir.SK.Expr:this.emitExpr(r.expr);break;case y.ir.SK.StackEmpty:if(0<this.exprStack.length){for(var n of this.proc.body.slice(e-4,e+1))pxt.log("PREVSTMT "+n.toString().trim());for(var s of this.exprStack)pxt.log(`EXPRSTACK ${s.currUses}/${s.totalUses} E: `+s.toString());y.oops("stack should be empty")}this.write("@stackempty locals");break;case y.ir.SK.Jmp:this.emitJmp(r);break;case y.ir.SK.Label:this.write(r.lblName+":"),this.validateJmpStack(r);break;case y.ir.SK.Comment:this.write("; "+r.expr.data);break;case y.ir.SK.Breakpoint:this.bin.breakpoints&&(t="__brkp_"+r.breakpointInfo.id,r.breakpointInfo.isDebuggerStmt?this.write(this.t.debugger_stmt(t)):this.write(this.t.debugger_bkpt(t)));break;default:y.oops()}}y.assert(0<=e&&e<127),0<e&&this.write(this.t.pop_locals(e)),this.proc.perfCounterNo&&(this.write("mov r4, r0"),this.write(this.t.emit_int(this.proc.perfCounterNo,"r0")),this.write("bl pxt::stopPerfCounter"),this.write("mov r0, r4")),this.write(l+":"),this.write(this.t.proc_return()),this.write("@stackempty func"),this.write("@stackempty args"),this.write("; endfun")}mkLbl(e){let t=e+this.bin.lblNo++;return t="_"!=t[0]?"."+t:t}dumpStack(){let e="[";for(var t of this.exprStack)e+=t.sharingInfo()+": "+t.toString()+"; ";return e+="]"}terminate(e){y.assert(e.exprKind==y.ir.EK.SharedRef);e=e.args[0];y.U.assert(e.currUses!=e.totalUses),y.U.assert(this.exprStack[0]===e,"term at top");let t=1;for(;t<this.exprStack.length;){var r=this.exprStack[t];if(r.currUses!=r.totalUses)break;t++}return this.write("@dummystack "+t),this.write(this.t.pop_locals(t)),t}validateJmpStack(e,t=0){t=this.exprStack.length-t;null==e.lblStackSize?e.lblStackSize=t:e.lblStackSize!=t&&(pxt.log(e.lblStackSize,t),pxt.log(this.dumpStack()),y.U.oops("stack misaligned at: "+e.lblName))}emitJmp(e){let t=0;var r;e.jmpMode==y.ir.JmpMode.Always?(e.expr&&this.emitExpr(e.expr),e.terminateExpr&&(t=this.terminate(e.terminateExpr)),this.write(this.t.unconditional_branch(e.lblName)+" ; with expression")):(r=this.mkLbl("jmpz"),this.emitExpr(e.expr),e.expr.exprKind==y.ir.EK.RuntimeCall&&("thumb::subs"===e.expr.data||y.U.startsWith(e.expr.data,"_cmp_"))||this.write(this.t.cmp_zero("r0")),e.jmpMode==y.ir.JmpMode.IfNotZero?this.write(this.t.beq(r)):this.write(this.t.bne(r)),e.terminateExpr&&(t=this.terminate(e.terminateExpr)),this.write(this.t.unconditional_branch(e.lblName)),this.write(r+":")),this.validateJmpStack(e.lbl,t)}clearStack(e=!1){let t=0;for(;0<this.exprStack.length&&this.exprStack[0].currUses==this.exprStack[0].totalUses;)t++,this.exprStack.shift();if(t&&this.write(this.t.pop_locals(t)),!e){e=this.exprStack.filter(e=>e.currUses==e.totalUses&&-1!=e.irCurrUses);if(0<e.length){this.write(this.t.reg_gets_imm("r7",0));for(var r of e)r.irCurrUses=-1,this.write(this.loadFromExprStack("r7",r,0,!0))}}}emitExprInto(e,t){switch(e.exprKind){case y.ir.EK.NumberLiteral:"number"==typeof e.data?this.write(this.t.emit_int(e.data,t)):y.oops();break;case y.ir.EK.PointerLiteral:this.write(this.t.load_ptr_full(e.data,t));break;case y.ir.EK.SharedRef:var r=e.args[0],n=(y.U.assert(!!r.currUses),y.U.assert(r.currUses<r.totalUses),r.currUses++,this.exprStack.indexOf(r));y.U.assert(0<=n),0==n&&r.totalUses==r.currUses?(this.write(this.t.pop_fixed([t])+(" ; tmpref @"+this.exprStack.length)),this.exprStack.shift(),this.clearStack()):(r=n.toString()+":"+this.exprStack.length,this.write(this.t.load_reg_src_off(t,"sp",r,!0)+(" ; tmpref @"+(this.exprStack.length-n))));break;case y.ir.EK.CellRef:r=e.data;if(r.isGlobal()){n=this.bitSizeInfo(r.bitSize);let e="#"+r.index;(n.needsSignExt||r.index>=n.immLimit)&&(this.write(this.t.emit_int(r.index,t)),e=t),this.write(this.t.load_reg_src_off("r7","r6","#0")),this.write(this.t.load_reg_src_off(t,"r7",e,!1,!1,n))}else{var[n,r,s]=this.cellref(r);this.write(this.t.load_reg_src_off(t,n,r,s))}break;default:y.oops()}}bitSizeInfo(e){var t={size:y.sizeOfBitSize(e),immLimit:128};return 1==t.size?t.immLimit=32:2==t.size&&(t.immLimit=64),1!=e&&3!=e||(t.needsSignExt=!0),t}emitExpr(e){switch(e.exprKind){case y.ir.EK.JmpValue:this.write("; jmp value (already in r0)");break;case y.ir.EK.Nop:this.write(this.t.nop());break;case y.ir.EK.FieldAccess:return this.emitExpr(e.args[0]),this.emitFieldAccess(e);case y.ir.EK.Store:return this.emitStore(e.args[0],e.args[1]);case y.ir.EK.RuntimeCall:return this.emitRtCall(e);case y.ir.EK.ProcCall:return this.emitProcCall(e);case y.ir.EK.SharedDef:return this.emitSharedDef(e);case y.ir.EK.Sequence:return e.args.forEach(e=>this.emitExpr(e)),this.clearStack();case y.ir.EK.InstanceOf:return this.emitExpr(e.args[0]),this.emitInstanceOf(e.data,e.jsInfo);default:return this.emitExprInto(e,"r0")}}emitFieldAccess(e,t=!1){e=e.data,e.classInfo.id,e.needsCheck&&!y.target.switches.skipClassCheck&&this.emitInstanceOf(e.classInfo,"validate"),e=4*e.idx+4;let r="#"+e;124<e&&(this.write(this.t.emit_int(e,"r3")),r="r3"),t?this.write(`str r1, [r0, ${r}]`):this.write(`ldr r0, [r0, ${r}]`)}writeFailBranch(){this.write(".fail:"),this.write("mov r1, lr"),this.write(this.t.callCPP("pxt::failedCast"))}emitClassCall(e){var t=e.virtualIndex+y.firstMethodOffset();this.write(this.t.emit_int(4*t,"r1"));let r=e.classInfo,n="";e.isThis&&(n+="_this"),this.emitLabelledHelper("classCall_"+r.id+n,()=>{this.write("ldr r0, [sp, #0] ; ld-this"),this.loadVTable(),y.target.switches.skipClassCheck||e.isThis||this.checkSubtype(r),this.write("ldr r1, [r3, r1] ; ld-method"),this.write("bx r1 ; keep lr from caller"),this.writeFailBranch()})}helperObject(e){return`.object _pxt_helper_${e.replace(/[^\w]+/g,"_")} "helper: ${e}"`}emitBindHelper(){this.write(`
                ${this.helperObject("bind")}
                .section code
                _pxt_bind_helper:
                    push {r0, r2}
                    movs r0, #2
                    ldlit r1, _pxt_bind_lit
                    ${this.t.callCPP("pxt::mkAction")}
                    pop {r1, r2}
                    str r1, [r0, #12]
                    str r2, [r0, #16]
                    bx r4 ; return

                _pxt_bind_lit:
                    ${this.t.obj_header("pxt::RefAction_vtable")}
                    .short 0, 0 ; no captured vars
                    .word .bindCode@fn
                .bindCode:
                    ; r0-bind object, r4-#args
                    cmp r4, #12
                    bge .fail
                    lsls r3, r4, #2
                    ldlit r2, _pxt_copy_list
                    ldr r1, [r2, r3]

                    ldr r3, [r0, #12]
                    ldr r2, [r0, #16]
                    adds r4, r4, #1
                    bx r1
            `),this.writeFailBranch(),this.write("_pxt_copy_list:"),this.write(y.U.range(12).map(e=>`.word _pxt_bind_${e}@fn`).join("\n"));for(let t=0;t<12;t++){this.write(`
                _pxt_bind_${t}:
                    sub sp, #4
                `);for(let e=0;e<t;++e)this.write(`ldr r1, [sp, #4*${e+1}]`),this.write(`str r1, [sp, #4*${e}]`);this.write(`
                    push {r3} ; this-ptr
                    mov r1, lr
                    str r1, [sp, #4*${t+1}] ; store LR
                    blx r2
                    ldr r1, [sp, #4*${t+1}]
                    add sp, #8
                    bx r1
                `)}}ifaceCallCore(t,e,r=!1){this.write(`
                ldr r2, [r3, #12] ; load mult
                movs r7, r2
                beq .objlit ; built-in types have mult=0
                muls r7, r1
                lsrs r7, r2
                lsls r7, r7, #1 ; r7 - hash offset
                ldr r3, [r3, #4] ; iface table
                adds r3, r3, r7
                ; r0-this, r1-method idx, r2-free, r3-hash entry, r4-num args, r7-free
                `);for(let e=0;e<y.vtLookups;++e)0<e&&this.write("    adds r3, #2"),this.write(`
                ldrh r2, [r3, #0] ; r2-offset of descriptor
                ldrh r7, [r2, r3] ; r7-method idx
                cmp r7, r1
                beq .hit
                `);"get"==e?(this.write("movs r0, #0 ; undefined"),this.write("bx lr")):this.write("b .fail2"),this.write(`
            .hit:
                adds r3, r3, r2 ; r3-descriptor
                ldr r2, [r3, #4]
                lsls r7, r2, #31
                beq .field
            `);var n=this.t.emit_int(t,"r4")+"\n     bx r2";if("set"==e?this.write(`
                    ; check for next descriptor
                    ldrh r7, [r3, #8]
                    cmp r7, r1
                    bne .fail2 ; no setter!
                    ldr r2, [r3, #12]
                    ${n}
                `):(this.write(`
                    ; check if it's getter
                    ldrh r7, [r3, #2]
                    cmp r7, #1
                `),"get"==e?this.write(`
                        bne .bind
                        ${n}
                    .bind:
                        mov r4, lr
                        bl _pxt_bind_helper
                    `):this.write(`
                        beq .doublecall
                        ${n}
                    .doublecall:
                        ; call getter
                        movs r4, #1
                        push {r0, lr}
                        blx r2
                        pop {r1, r2}
                        mov lr, r2
                        b .moveArgs
                    `)),r||(this.write(`
                .objlit:
                    ldrh r2, [r3, #8]
                    cmp r2, #${pxt.BuiltInType.RefMap}
                    bne .fail
                    mov r4, lr
                `),"set"==e&&this.write("ldr r2, [sp, #4] ; ld-val"),this.write(this.t.callCPP("set"==e?"pxtrt::mapSet":"pxtrt::mapGet")),e?this.write("bx r4"):(this.write("mov lr, r4"),this.write("b .moveArgs"))),this.write(".field:"),"set"==e?this.write(`
                        ldr r3, [sp, #4] ; ld-val
                        str r3, [r0, r2] ; store field
                        bx lr
                    `):"get"==e?this.write(`
                        ldr r0, [r0, r2] ; load field
                        bx lr
                    `):this.write(`
                        ldr r0, [r0, r2] ; load field
                    `),!e){this.write(".moveArgs:");for(let e=0;e<t;++e)e==t-1?this.write("movs r1, r0"):this.write(`ldr r1, [sp, #4*${e+1}]`),this.write(`str r1, [sp, #4*${e}]`);this.lambdaCall(t-1)}r&&this.write(".objlit:"),this.writeFailBranch(),this.write(`
            .fail2:
                ${this.t.callCPP("pxt::missingProperty")}
            `)}emitIfaceCall(e,t,r=""){y.U.assert(0<e.ifaceIndex),this.write(this.t.emit_int(e.ifaceIndex,"r1")),this.emitLabelledHelper("ifacecall"+t+"_"+r,()=>{this.write("ldr r0, [sp, #0] ; ld-this"),this.loadVTable(),this.ifaceCallCore(t,r)})}checkSubtype(e,t=".fail",r="r2"){e.classNo?(this.write(`ldrh ${r}, [r3, #8]`),this.write(`cmp ${r}, #`+e.classNo),e.classNo==e.lastSubtypeNo?this.write("bne "+t):(this.write("blt "+t),this.write(`cmp ${r}, #`+e.lastSubtypeNo),this.write("bgt "+t))):this.write(`b ${t} ; always fails; class never instantiated`)}loadVTable(e="r2",t=".fail",r=".fail"){this.write(`lsls ${e}, r0, #30`),this.write("bne "+t),this.write("cmp r0, #0"),this.write("beq "+r),this.write("ldr r3, [r0, #0]"),this.write("; vtable in R3")}emitInstanceOf(e,t){var r="inst_"+e.id+"_"+t;this.emitLabelledHelper(r,()=>{"validateNullable"==t?this.loadVTable("r2",".tagged",".undefined"):this.loadVTable("r2",".fail",".fail"),this.checkSubtype(e),"bool"==t?(this.write("movs r0, #"+y.taggedTrue),this.write("bx lr"),this.write(".fail:"),this.write("movs r0, #"+y.taggedFalse),this.write("bx lr")):"validate"==t?(this.write("bx lr"),this.writeFailBranch()):"validateNullable"==t?(this.write(".undefined:"),this.write("bx lr"),this.write(".tagged:"),this.write(`cmp r0, #${y.taggedNull} ; check for null`),this.write("bne .fail"),this.write("movs r0, #0"),this.write("bx lr"),this.writeFailBranch()):y.U.oops()})}emitSharedDef(e){e=e.args[0];if(y.U.assert(1<=e.totalUses),y.U.assert(0===e.currUses),(e.currUses=1)==e.totalUses)return this.emitExpr(e);this.emitExpr(e),this.exprStack.unshift(e),this.write(this.t.push_local("r0")+"; tmpstore @"+this.exprStack.length)}clearArgs(e,t){e.length,t.length;var r,n=e.concat(t);for(r of n)0==r.currUses&&1==r.totalUses||(pxt.log(r.toString()),pxt.log(n.map(e=>e.toString())),y.U.oops(`wrong uses: ${r.currUses} `+r.totalUses)),r.currUses=1;this.clearStack()}builtInClassNo(e){return{id:"builtin"+e,classNo:e,lastSubtypeNo:e}}emitBeginTry(e){this.emitExprInto(e.args[0],"r0"),this.write("bl _pxt_save_exception_state")}emitRtCall(e,t=null){var r=e.data;if("pxt::beginTry"==r)return this.emitBeginTry(e);let n=e.mask||{refMask:0},s=n.conversions||[];var i,a,e=e.args.map((e,t)=>({idx:t,expr:e,isSimple:e.isLiteral(),isRef:0!=(n.refMask&1<<t),conv:s.find(e=>e.argIdx==t)}));y.U.assert(e.length<=4);let o=!1;for(i of y.U.reversed(e))i.expr.isPure()?i.isSimple||i.isRef||o&&!i.expr.isStateless()||(i.isSimple=!0):o=!0;for(a of e)a.conv&&(a.isSimple=!1);let l=e.filter(e=>!e.isSimple);if(l.every(e=>e.expr.isPure()&&!e.isRef&&!e.conv)){for(var c of l)c.isSimple=!0;l=[]}var u,p=l[0];let d=!0;if(1!=l.length||p.conv||p.isRef){for(var m of l)this.pushArg(m.expr);this.alignExprStack(0);let i=l.filter(e=>!!e.conv);if(i.length){var f=this.redirectOutput(()=>{let e=0;y.target.switches.inlineConversions||(this.t.stackAligned()?e+=2:e+=1);for(var t of i){var r;y.isThumb()&&"pxt::toInt"==t.conv.method?(this.write(this.loadFromExprStack("r0",t.expr,e)),this.write("asrs r0, r0, #1"),r=y.target.switches.inlineConversions?t.expr.getId():e,this.write("bcs .isint"+r),this.write("lsls r0, r0, #1"),this.alignedCall(t.conv.method,"",e),this.write(".isint"+r+":")):(this.write(this.loadFromExprStack("r0",t.expr,e)),t.conv.refTag?y.target.switches.skipClassCheck||this.emitInstanceOf(this.builtInClassNo(t.conv.refTag),t.conv.refTagNullable?"validateNullable":"validate"):(this.alignedCall(t.conv.method,"",e),t.conv.returnsRef&&this.write(this.loadFromExprStack("r0",t.expr,e,!0)))),this.write(this.t.push_fixed(["r0"])),e++}for(var n of y.U.reversed(i))e--,this.write(this.t.pop_fixed(["r"+n.idx]));for(var s of l)s.conv||this.write(this.loadFromExprStack("r"+s.idx,s.expr,e))});y.target.switches.inlineConversions?this.write(f):this.emitHelper(this.t.helper_prologue()+f+this.t.helper_epilogue(),"conv")}else for(var h of l)this.write(this.loadFromExprStack("r"+h.idx,h.expr))}else this.emitExpr(p.expr),0!=p.idx&&this.write(this.t.mov("r"+p.idx,"r0")),d=!1;for(u of e)u.isSimple&&this.emitExprInto(u.expr,"r"+u.idx);t?t():"langsupp::ignore"!=r&&this.alignedCall(r,"",0,!0),d&&this.clearArgs(l.filter(e=>!e.isRef).map(e=>e.expr),l.filter(e=>e.isRef).map(e=>e.expr))}alignedCall(e,t="",r=0,n=!1){(y.U.startsWith(e,"_cmp_")||y.U.startsWith(e,"_pxt_"))&&(n=!1),this.write(this.t.call_lbl(e,n,this.stackAlignmentNeeded(r))+t)}emitLabelledHelper(e,t){this.labelledHelpers[e]?this.write(this.t.call_lbl(this.labelledHelpers[e])):(t=this.redirectOutput(t),this.emitHelper(t,e),this.labelledHelpers[e]=this.bin.codeHelpers[t])}emitHelper(e,t="hlp"){var r;this.bin.codeHelpers[e]||(r=Object.keys(this.bin.codeHelpers).length,this.bin.codeHelpers[e]=`_${t}_`+r),this.write(this.t.call_lbl(this.bin.codeHelpers[e]))}pushToExprStack(e){e.totalUses=1,e.currUses=0,this.exprStack.unshift(e)}pushArg(e){this.clearStack(!0);this.exprStack.length;this.emitExpr(e),this.clearStack(!0),this.write(this.t.push_local("r0")+" ; proc-arg"),this.pushToExprStack(e)}loadFromExprStack(e,t,r=0,n=!1){t=this.exprStack.indexOf(t);return y.assert(0<=t),this.t.load_reg_src_off(e,"sp",(t+r).toString(),!0,n)+` ; estack
`}pushDummy(){var e=y.ir.numlit(0);e.totalUses=1,e.currUses=1,this.exprStack.unshift(e)}alignExprStack(e){var t=this.stackAlignmentNeeded(e);if(t)for(let e=0;e<t;++e)this.write("push {r5} ; align"),this.pushDummy()}emitFieldMethods(){for(var t of["get","set"]){this.write(`
                ${this.helperObject(t)}
                .section code
                _pxt_map_${t}:
                `),this.loadVTable("r4"),this.checkSubtype(this.builtInClassNo(pxt.BuiltInType.RefMap),".notmap","r4"),this.write(this.t.callCPPPush("set"==t?"pxtrt::mapSetByString":"pxtrt::mapGetByString")),this.write(".notmap:");var r="set"==t?2:1;let e=!1;this.write("mov r4, r3 ; save VT"),"set"==t?(y.target.stackAlign&&(e=!0,this.write("push {lr} ; align")),this.write(`
                            push {r0, r2, lr}
                            mov r0, r1
                        `)):this.write(`
                            push {r0, lr}
                            mov r0, r1
                        `),this.write(`
                    bl pxtrt::lookupMapKey
                    mov r1, r0 ; put key index in r1
                    ldr r0, [sp, #0] ; restore obj pointer
                    mov r3, r4 ; restore vt
                    bl .dowork
                `),this.write(this.t.pop_locals(r+(e?1:0))),this.write("pop {pc}"),this.write(".dowork:"),this.ifaceCallCore(r,t,!0)}}emitArrayMethod(e,t){this.write(`
            ${this.helperObject(e+" "+(t?"buffer":"array"))}
            .section code
            _pxt_${t?"buffer":"array"}_${e}:
            `),this.loadVTable("r4");var r=this.builtInClassNo(t?pxt.BuiltInType.BoxedBuffer:pxt.BuiltInType.RefCollection),r=(y.target.switches.skipClassCheck||this.checkSubtype(r,".fail","r4"),y.isStackMachine()||y.target.runtimeIsARM||t?"ldr":"ldrh");this.write(`
                asrs r1, r1, #1
                bcc .notint
                ${r} r4, [r0, #${t?4:8}]
                cmp r1, r4
                bhs .oob
            `);let n="r1";t?(n="#8",this.write(`
                    adds r4, r0, r1
                `)):this.write(`
                    lsls r1, r1, #2
                    ldr r4, [r0, #4]
                `);var r=t?"b":"",s=t&&"get"==e?"lsls r0, r0, #1\nadds r0, #1":"";"set"==e?this.write(`
                        str${r} r2, [r4, ${n}]
                        bx lr
                    `):this.write(`
                        ldr${r} r0, [r4, ${n}]
                        ${s}
                        bx lr
                    `),this.write(`
            .notint:
                lsls r1, r1, #1
                ${this.t.pushLR()}
                push {r0, r2}
                mov r0, r1
                ${this.t.callCPP("pxt::toInt")}
                mov r1, r0
                pop {r0, r2}
            .doop:
                ${this.t.callCPP(`Array_::${e}At`)}
                ${s}
                ${this.t.popPC()}
            `),this.writeFailBranch(),"get"==e?this.write(`
                    .oob:
                        movs r0, #${t?1:0} ; 0 or undefined
                        bx lr
                `):this.write(`
                    .oob:
                        ${this.t.pushLR()}
                        b .doop
                `)}emitArrayMethods(){for(var e of["get","set"])this.emitArrayMethod(e,!0),this.emitArrayMethod(e,!1)}emitLambdaTrampoline(){var e=y.target.stackAlign?"r3,":"";this.write(`
            ${this.helperObject("trampoline")}
            .section code
            _pxt_lambda_trampoline:
                push {${e} r4, r5, r6, r7, lr}
                mov r4, r8
                mov r5, r9
                mov r6, r10
                mov r7, r11
                push {r4, r5, r6, r7} ; save high registers
                mov r4, r1
                mov r5, r2
                mov r6, r3
                mov r7, r0
                `),this.emitInstanceOf(this.builtInClassNo(pxt.BuiltInType.RefAction),"validate"),this.write(`
                mov r0, sp
                push {r4, r5, r6, r7} ; push args and the lambda
                mov r1, sp
                bl pxt::pushThreadContext
                mov r6, r0          ; save ctx or globals
                mov r5, r7          ; save lambda for closure
                mov r0, r5          ; also save lambda pointer in r0 - needed by pxt::bindMethod
                ldr r1, [r5, #8]    ; ld fnptr
                movs r4, #3         ; 3 args
                blx r1              ; execute the actual lambda
                mov r7, r0          ; save result
                @dummystack 4
                add sp, #4*4        ; remove arguments and lambda
                mov r0, r6   ; or pop the thread context
                bl pxt::popThreadContext
                mov r0, r7 ; restore result
                pop {r4, r5, r6, r7} ; restore high registers
                mov r8, r4
                mov r9, r5
                mov r10, r6
                mov r11, r7
                pop {${e} r4, r5, r6, r7, pc}`),this.write(`
            ${this.helperObject("exn")}
            .section code
            ; r0 - try frame
            ; r1 - handler PC
            _pxt_save_exception_state:
                push {r0, lr}
                ${this.t.callCPP("pxt::beginTry")}
                pop {r1, r4}
                str r1, [r0, #1*4] ; PC
                mov r1, sp
                str r1, [r0, #2*4] ; SP
                str r5, [r0, #3*4] ; lambda ptr
                bx r4
                `),this.write(`
            .section code
            ; r0 - try frame
            ; r1 - thread context
            _pxt_restore_exception_state:
                mov r6, r1
                ldr r1, [r0, #2*4] ; SP
                mov sp, r1
                ldr r5, [r0, #3*4] ; lambda ptr
                ldr r1, [r0, #1*4] ; PC
                movs r0, #1
                orrs r1, r0
                bx r1
                `),this.write(`
            ${this.helperObject("stringconv")}
            .section code
            _pxt_stringConv:
            `),this.loadVTable(),this.checkSubtype(this.builtInClassNo(pxt.BuiltInType.BoxedString),".notstring"),this.write(`
                bx lr

            .notstring: ; no string, but vtable in r3
                ldr r7, [r3, #4*${y.firstMethodOffset()-1}]
                cmp r7, #0
                beq .fail
                push {r0, lr}
                movs r4, #1
                blx r7
                str r0, [sp, #0]
                b .numops

            .fail: ; not an object or no toString
                push {r0, lr}
            .numops:
                ${this.t.callCPP("numops::toString")}
                pop {r1}
                pop {pc}
            `)}emitProcCall(t){let r=[],e=null,n="";var s=t.data;if(s.proc&&s.proc.inlineBody)return this.emitExpr(s.proc.inlineSelf(t.args));var i,a=-1==s.virtualIndex;let o=!1;for(i of y.U.reversed(t.args)){if(i.isPure()){if(!o||i.isStateless())continue}else o=!0;r.push(i)}if(r.reverse(),r.length<=1){var l=r[0];l&&(e=l,this.clearStack(!0),this.emitExpr(l),l==t.args[t.args.length-1]?n="r0":(n="r3",this.write(this.t.mov("r3","r0")))),r=[]}else for(var c of r)this.pushArg(c);this.alignExprStack(t.args.length);let u=["r1","r2","r3","r4"],p=[];if(r.length){let t=-1;for(var d of r)t=Math.max(this.exprStack.indexOf(d),t);if(++t<=u.length){u=u.slice(0,t),this.write(this.t.pop_fixed(u)),p=this.exprStack.splice(0,t);var m=[];for(let e=t-1;0<=e;--e)r.indexOf(p[e])<0&&(m.push(u[e]),this.exprStack.unshift(p[e]));m.length&&this.write(this.t.push_fixed(m))}else u=null,this.write(this.t.reg_gets_imm("r7",0))}var f,h,g,l=y.U.reversed(t.args);a&&l.unshift(l.pop());for(f of l)0<=r.indexOf(f)?(u?this.write(this.t.push_fixed([u[p.indexOf(f)]])):(this.write(this.loadFromExprStack("r0",f)),this.write(this.t.push_local("r0")+" ; re-push"),this.write(this.loadFromExprStack("r7",f,1,!0)),h=this.exprStack.indexOf(f),(g=y.ir.numlit(0)).currUses=1,g.totalUses=1,this.exprStack[h]=g),this.exprStack.unshift(f)):f===e?(this.write(this.t.push_local(n)+" ; the one arg"),this.pushToExprStack(f)):this.pushArg(f);var b,l=this.mkLbl("_proccall");let x=-1;if(a){let e=t.args.length-1;this.write(this.loadFromExprStack("r0",t.args[0])),this.emitLabelledHelper("lambda_call"+e,()=>{this.lambdaCall(e),this.writeFailBranch()})}else null!=s.virtualIndex||null!=s.ifaceIndex?null!=s.ifaceIndex?s.isSet?(y.assert(2==t.args.length),this.emitIfaceCall(s,t.args.length,"set")):this.emitIfaceCall(s,t.args.length,s.noArgs?"get":""):this.emitClassCall(s):(b=s.proc,x=b.seqNo,this.write(this.t.call_lbl(b.label()+(s.isThis?"_nochk":"")))),this.write(l+":");this.calls.push({procIndex:x,stack:0,addr:0,callLabel:l}),a&&t.args[0].isStateless()?this.clearArgs([t.args[0]],t.args.slice(1)):this.clearArgs([],t.args)}lambdaCall(t){this.write("; lambda call"),this.loadVTable(),y.target.switches.skipClassCheck||this.checkSubtype(this.builtInClassNo(pxt.BuiltInType.RefAction)),this.write(`
                movs r4, #${t}
                ldrh r1, [r0, #4]
                cmp r1, #0
                bne .pushR5
                ldr r1, [r0, #8]
                bx r1 ; keep lr from the caller
            .pushR5:
                sub sp, #8
            `);for(let e=0;e<t;++e)this.write(`ldr r1, [sp, #4*${e+2}]`),this.write(`str r1, [sp, #4*${e}]`);this.write(`
                str r5, [sp, #4*${t}]
                mov r1, lr
                str r1, [sp, #4*${t+1}]
                mov r5, r0
                ldr r7, [r5, #8]
                blx r7 ; exec actual lambda
                ldr r4, [sp, #4*${t+1}] ; restore what was in LR
                ldr r5, [sp, #4*${t}] ; restore lambda ctx
            `);for(let e=0;e<t;++e)this.write(`ldr r1, [sp, #4*${e}]`),this.write(`str r1, [sp, #4*${e+2}]`);this.write(`
                add sp, #8
                bx r4
            `),this.write("; end lambda call")}emitStore(e,t){switch(e.exprKind){case y.ir.EK.CellRef:var r=e.data;if(this.emitExpr(t),r.isGlobal()){var n=this.bitSizeInfo(r.bitSize);let e="#"+r.index;r.index>=n.immLimit&&(this.write(this.t.emit_int(r.index,"r1")),e="r1"),this.write(this.t.load_reg_src_off("r7","r6","#0")),this.write(this.t.load_reg_src_off("r0","r7",e,!1,!0,n))}else{var[n,r,s]=this.cellref(r);this.write(this.t.load_reg_src_off("r0",n,r,s,!0))}break;case y.ir.EK.FieldAccess:this.emitRtCall(y.ir.rtcall("dummy",[e.args[0],t]),()=>this.emitFieldAccess(e,!0));break;default:y.oops()}}cellref(e){var t;if(e.isGlobal())throw y.oops();return e.iscap?(t=e.index+3,y.assert(0<=t&&t<32),["r5",t.toString(),!0]):e.isarg?["sp","args@"+e.index.toString()+":"+this.baseStackSize,!1]:["sp","locals@"+e.index,!1]}emitLambdaWrapper(n){if(this.write(""),this.write(".section code"),this.write(".balign 4"),n&&(this.proc.info.usedAsValue=!0),this.proc.info.usedAsValue||this.proc.info.usedAsIface){this.proc.info.usedAsValue&&(this.write(this.proc.label()+"_Lit:"),this.write(this.t.obj_header("pxt::RefAction_vtable")),this.write(".short 0, 0 ; no captured vars"),this.write(`.word ${this.proc.label()}_args@fn`)),this.write(this.proc.label()+"_args:");let r=this.proc.args.length;if(0!=r){this.write("cmp r4, #"+r),this.write(`bge ${this.proc.label()}_nochk`);let e=this.stackAlignmentNeeded(r+1),t=e?r+2:r+1;this.write("push {lr}"),this.emitLabelledHelper("expand_args_"+r,()=>{this.write("movs r0, #0"),this.write("movs r1, #0"),e&&this.write("push {r0}");for(let e=r;0<e;e--)e!=r&&(this.write("cmp r4, #"+e),this.write("blt .zero"+e),this.write(`ldr r0, [sp, #${t-1}*4]`),this.write(`str r1, [sp, #${t-1}*4] ; clear existing`),this.write(`.zero${e}:`)),this.write("push {r0}");this.write("bx lr")}),this.write(`bl ${this.proc.label()}_nochk`);n=r+(e?1:0);this.write("@dummystack "+n),this.write("add sp, #4*"+n),this.write("pop {pc}")}}}emitCallRaw(e){var t=y.hexfile.lookupFunc(e);y.assert(!!t,"unimplemented raw function: "+e),this.alignedCall(e)}}})(ts=ts||{}),(e=>{{var K=e.pxtc||(e.pxtc={});let _={"numops::adds":"+","numops::subs":"-","numops::div":"/","numops::mod":"%","numops::muls":"*","numops::ands":"&","numops::orrs":"|","numops::eors":"^","numops::bnot":"~","numops::lsls":"<<","numops::asrs":">>","numops::lsrs":">>>","numops::le":"<=","numops::lt":"<","numops::lt_bool":"<","numops::ge":">=","numops::gt":">","numops::eq":"==","pxt::eq_bool":"==","pxt::eqq_bool":"===","numops::eqq":"===","numops::neqq":"!==","numops::neq":"!="},p={"pxsim.Boolean_":"","pxsim.pxtcore":"","pxsim.String_":"","pxsim.ImageMethods":"","pxsim.Array_":"","pxsim.pxtrt":"","pxsim.numops":""},d={"pxsim.Array_.getAt":"","pxsim.Array_.length":"","pxsim.Array_.mk":"","pxsim.Array_.push":"","pxsim.Boolean_.bang":"","pxsim.String_.concat":"","pxsim.String_.stringConv":"","pxsim.numops.toBool":"","pxsim.numops.toBoolDecr":"","pxsim.pxtcore.mkAction":"","pxsim.pxtcore.mkClassInstance":"","pxsim.pxtrt.ldlocRef":"","pxsim.pxtrt.mapGetByString":"","pxsim.pxtrt.stclo":"","pxsim.pxtrt.stlocRef":""};function f(e){let t="";for(var r of Object.keys(e)){var n=r.replace(/\./g,"_");e[r]=n,t+=`const ${n} = ${r};
`}return t}function $(e){e="pxsim."+(e="pxt."==(e=e.replace(/::/g,".")).slice(0,4)?"pxtcore."+e.slice(4):e);if(d.hasOwnProperty(e))return d[e];var t=e.lastIndexOf(".");if(0<t){var r=e.slice(0,t);if(p.hasOwnProperty(r))return p[r]+e.slice(t)}return e}K.isBuiltinSimOp=function(e){return!!K.U.lookup(_,e.replace(/\./g,"::"))},K.shimToJs=$;let m=["runtime","oops","doNothing","pxsim","globals","maybeYield","setupDebugger","isBreakFrame","breakpoint","trace","checkStack","leave","checkResumeConsumed","setupResume","setupLambda","checkSubtype","failedCast","buildResume","mkVTable","bind","leaveAccessor"];K.jsEmit=function(r,e){let n="(function (ectx) {\n'use strict';\n";for(var t of m)n+=`const ${t} = ectx.${t};
`;n=(n=(n=n+`const __this = runtime;
`+`const pxtrt = pxsim.pxtrt;
`)+`let yieldSteps = 1;
`+`ectx.setupYield(function() { yieldSteps = 100; })
`)+"pxsim.setTitle("+JSON.stringify(r.getTitle())+");\n";var s,i={},a={};for(s of e.configData||[])i[s.key+""]=s.value,a[s.name]=s.key;n=(n+="pxsim.setConfigData("+JSON.stringify(i,null,1)+", "+JSON.stringify(a,null,1)+");\n")+"pxtrt.mapKeyNames = "+JSON.stringify(r.ifaceMembers,null,1)+";\n";var o=r.setPerfCounters(["SysScreen"]);n=(n=(n+="__this.setupPerfCounters("+JSON.stringify(o,null,1)+");\n")+f(d))+f(p);let l=0,c=0,u=(r.procs.forEach(e=>{let t;e.cachedJS?(t=e.cachedJS,l+=t.length):(t=((h,g)=>{if(g.cachedJS)return g.cachedJS;let t="",b=e=>{t+=e+"\n"},x=e=>{t+="    "+e+"\n"},y=K.ir.EK,k=[],r=0,n={},s="",S=(b(`
function ${g.label()}(s) {
let r0 = s.r0, step = s.pc;
s.pc = -1;
`),g.perfCounterNo&&b(`if (step == 0) __this.startPerfCounter(${g.perfCounterNo});
`),b(`
while (true) {
if (yieldSteps-- < 0 && maybeYield(s, step, r0) || runtime !== pxsim.runtime) return null;
switch (step) {
  case 0:
`),g.locals.forEach(e=>{x(I(e)+" = undefined;")}),g.args.length&&(x("if (s.lambdaArgs) {"),g.args.forEach((e,t)=>{x(`  ${I(e)} = (s.lambdaArgs[${t}]);`)}),x("  s.lambdaArgs = null;"),x("}")),g.classInfo&&g.info.thisParameter&&(x("r0 = s.arg0;"),A(g.classInfo,"validate")),0),v=[];for(var e of g.body)e.stmtKind==K.ir.SK.Label&&0<e.lblNumUses&&(e.lblId=++S);let i=0;for(var a of g.body){switch(a.stmtKind){case K.ir.SK.Expr:N(a.expr);break;case K.ir.SK.StackEmpty:u();break;case K.ir.SK.Jmp:let t=!1;for(let e=i+1;e<g.body.length&&g.body[e].stmtKind==K.ir.SK.Label;++e)if(a.lbl==g.body[e]){t=!0;break}((e,t)=>{e.lbl.lblNumUses==K.ir.lblNumUsesJmpNext||t?(K.assert(e.jmpMode==K.ir.JmpMode.Always),e.expr&&N(e.expr)):(K.assert(0<e.lbl.lblNumUses),t=`{ step = ${e.lbl.lblId}; continue; }`,e.jmpMode==K.ir.JmpMode.Always?(e.expr&&N(e.expr),x(t)):(N(e.expr),e.jmpMode==K.ir.JmpMode.IfNotZero?x("if (r0) "+t):x("if (!r0) "+t)))})(a,t);break;case K.ir.SK.Label:0<a.lblNumUses&&b(`  case ${a.lblId}:`);break;case K.ir.SK.Comment:b("// "+a.expr.data);break;case K.ir.SK.Breakpoint:(e=>{let t=e.breakpointInfo.id,r;if(x(`s.lastBrkId = ${t};`),h.breakpoints){var n=`return breakpoint(s, ${r=++S}, ${t}, r0);`;e.breakpointInfo.isDebuggerStmt?x(n):(x(`if ((breakpoints[0] && isBreakFrame(s)) || breakpoints[${t}]) `+n),h.trace&&x(`else return trace(${t}, s, ${r}, ${g.label()}.info);`))}else{if(!h.trace)return;r=++S,x(`return trace(${t}, s, ${r}, ${g.label()}.info);`)}b(`  case ${r}:`)})(a);break;default:K.oops()}i++}u(),g.perfCounterNo&&b(`__this.stopPerfCounter(${g.perfCounterNo});
`),g.isGetter()?x("return leaveAccessor(s, r0)"):x("return leave(s, r0)"),b("  default: oops()"),b("} } }");var o=K.nodeLocationInfo(g.action);return o.functionName=g.getName(),o.argumentNames=g.args&&g.args.map(e=>e.getName()),b(g.label()+".info = "+JSON.stringify(o)),g.isGetter()&&b(g.label()+".isGetter = true;"),g.isRoot&&b(`${g.label()}.continuations = [ ${v.join(",")} ]`),b(T(g.label()+"_mk",g.label(),r,Object.keys(n))),b(s),g.cachedJS=t;function T(e,t,r,n){let s="";s+=`
function ${e}(s) {
    checkStack(s.depth);
    return {
        parent: s, fn: ${t}, depth: s.depth + 1,
        pc: 0, retval: undefined, r0: undefined, overwrittenPC: false, lambdaArgs: null,
`;for(let e=0;e<r;++e)s+=`  tmp_${e}: undefined,
`;for(var i of n)s+=`  ${i}: undefined,
`;return s+=`} }
`}function I(e){return e.isGlobal()?"globals."+e.uniqueName():e.iscap?`s.caps[${e.index}]`:(e=e.uniqueName(),n[e]=!0,"s."+e)}function w(e){return(e=>{switch(e.exprKind){case y.NumberLiteral:case y.PointerLiteral:case y.SharedRef:case y.CellRef:return 1;default:return}})(e)?E(e):(N(e),"r0")}function E(e){switch(e.exprKind){case y.NumberLiteral:if(!0===e.data)return"true";if(!1===e.data)return"false";if(null===e.data)return"null";if(void 0===e.data)return"undefined";if("number"==typeof e.data)return e.data+"";if("string"==typeof e.data)return`"${e.data}"`;throw K.oops("invalid data: "+typeof e.data);case y.PointerLiteral:if(e.ptrlabel())return e.ptrlabel().lblId+"";if(null!=e.hexlit())return s+=`const ${e.data} = pxsim.BufferMethods.createBufferFromHex("${e.hexlit()}")
`,e.data;if("string"==typeof e.jsInfo)return e.jsInfo;K.U.oops();case y.SharedRef:var t=e.args[0],t=(K.U.assert(!!t.currUses),K.U.assert(t.currUses<t.totalUses),t.currUses++,k.indexOf(t));return K.U.assert(0<=t),"s.tmp_"+t;case y.CellRef:return I(e.data);default:throw K.oops()}}function N(a){switch(a.exprKind){case y.JmpValue:x("// jmp value (already in r0)");break;case y.Nop:x("// nop");break;case y.FieldAccess:var t=a.data,r=t.shimName,n=w(a.args[0]);return r?void x(`r0 = ${n}${r};`):void x(`r0 = ${n}.fields["${t.name}"];`);case y.Store:var s=a.args[0],i=a.args[1];switch(s.exprKind){case y.CellRef:var o=s.data,l=w(i);x(`${I(o)} = ${(e=>{switch(e){case 0:return"";case 1:return"pxtrt.toInt8";case 3:return"pxtrt.toInt16";case 5:return"pxtrt.toInt32";case 2:return"pxtrt.toUInt8";case 4:return"pxtrt.toUInt16";case 6:return"pxtrt.toUInt32";default:throw K.oops()}})(o.bitSize)}(${l});`);break;case y.FieldAccess:o=s.data;let e=o.shimName;e=e||`.fields["${o.name}"]`,N(K.ir.rtcall("="+e,[s.args[0],i]));break;default:K.oops()}return;case y.RuntimeCall:r=a;(n=K.ir.flattenArgs(r.args)).precomp.forEach(N);t=r.data,n=n.flattened.map(E);if("langsupp::ignore"!=t){let e="";e="."==t[0]?""+n[0]+t+`(${n.slice(1).join(", ")})`:"="==t[0]?`(${n[0]})${t.slice(1)} = (${n[1]})`:K.U.startsWith(t,"new ")?`new ${$(t.slice(4))}(${n.join(", ")})`:K.U.lookup(_,t)?2==n.length?`(${n[0]} ${K.U.lookup(_,t)} ${n[1]})`:`(${K.U.lookup(_,t)} ${n[0]})`:`${$(t)}(${n.join(", ")})`,0==r.callingConvention?x(`r0 = ${e};`):(c=++S,v.push(c),"String_::stringConv"==t&&x(`if ((${n[0]}) && (${n[0]}).vtable) {`),2==r.callingConvention?x(`(function(cb) { ${e}.then(cb) })(buildResume(s, ${c}));`):(x(`setupResume(s, ${c});`),x(e+";")),x("checkResumeConsumed();"),x("return;"),"String_::stringConv"==t&&x(`} else { s.retval = (${n[0]}) + ""; }`),b(`  case ${c}:`),x("r0 = s.retval;"))}return;case y.ProcCall:{var c=a;var u,p=c.data,d=p.proc;if(d&&d.inlineBody)return N(d.inlineSelf(c.args));let e=K.ir.rtcall("<frame>",[]),t=(e.totalUses=1,e.currUses=0,k.length),n=(k.push(e),"s.tmp_"+t),r=++S,s=-1==p.virtualIndex;if(d)x(n+` = ${d.label()}_mk(s);`);else{let t="generic",r=(null!=p.ifaceIndex?t="if_"+h.ifaceMembers[p.ifaceIndex]:s?t="lambda":null!=p.virtualIndex?t=p.classInfo.id+"_v"+p.virtualIndex:K.U.oops(),c.args.length);t+="_"+r+"_mk",h.recordHelper(g.usingCtx,t,()=>{var e=K.U.range(r).map(e=>"arg"+e);return T(t,"null",5,e)}),x(n+` = ${t}(s);`)}c.args.forEach((e,t)=>{let r="arg"+t;s&&(r=0==t?"argL":"arg"+(t-1)),x(n+`.${r} = ${w(e)};`)});let i=`s.pc = ${r}; return ${n};`;null!=p.callLocationIndex&&(i=`s.callLocIdx = ${p.callLocationIndex}; `+i),null!=p.ifaceIndex?(K.U.assert(null==d),m=h.ifaceMembers[p.ifaceIndex],K.U.assert(!!m,"no name for "+p.ifaceIndex),x(`if (!${n}.arg0.vtable.iface) {`),(u=c.args.map((e,t)=>n+".arg"+t)).splice(1,0,JSON.stringify(m)),f=`pxsim_pxtrt.map${p.isSet?"Set":"Get"}ByString`,p.noArgs?x(`  s.retval = ${f}(${u.join(", ")});`):(K.U.assert(!p.isSet),x(`  setupLambda(${n}, ${f}(${u.slice(0,2).join(", ")}), ${c.args.length});`),x("  "+i)),x("} else {"),x(`  ${n}.fn = ${n}.arg0.vtable.iface["${p.isSet?"set/":""}${m}"];`),f=n+`.arg0.fields["${m}"]`,p.isSet?(x(`  if (${n}.fn === null) { ${f} = ${n}.arg1; }`),x(`  else if (${n}.fn === undefined) { failedCast(${n}.arg0) } `)):p.noArgs?(x(`  if (${n}.fn == null) { s.retval = ${f}; }`),x(`  else if (!${n}.fn.isGetter) { s.retval = bind(${n}); }`)):(x(`  if (${n}.fn == null) { setupLambda(${n}, ${f}, ${c.args.length}); ${i} }`),x(`  else if (${n}.fn.isGetter) { ${n}.stage2Call = true; ${i}; }`)),x(` else { ${i} }`),x("}"),i=""):-1==p.virtualIndex?(K.U.assert(null==d),x(`setupLambda(${n}, ${n}.argL);`)):null!=p.virtualIndex?(K.U.assert(null==d),K.assert(0<=p.virtualIndex),A(p.classInfo,"validate",n+".arg0"),u=p.classInfo.vtable[p.virtualIndex],x(n+`.fn = ${n}.arg0.vtable.methods.${u.getName()};`)):K.U.assert(null!=d),i&&x(i),b(`  case ${r}:`),x("r0 = s.retval;"),e.currUses=1;return}case y.SharedDef:var m=a;if(m=m.args[0],K.U.assert(1<=m.totalUses),K.U.assert(0===m.currUses),(m.currUses=1)==m.totalUses)return N(m);{var f=k.length;k.push(m);let e=w(m);"r0"!=e&&(e="r0 = "+e),x(`s.tmp_${f} = ${e};`)}return;case y.Sequence:return a.args.forEach(N);case y.InstanceOf:return N(a.args[0]),void A(a.data,a.jsInfo);default:x(`r0 = ${E(a)};`)}}function l(e){return e.id+"_VT"}function c(e,t="r0"){return`checkSubtype(${t}, ${l(e)})`}function A(e,t,r="r0"){"bool"==t?x(`r0 = ${c(e)};`):"validate"==t?x(`if (!${c(e,r)}) failedCast(${r}, ${l(e)});`):K.U.oops()}function u(){for(var e of k)e.totalUses!==e.currUses&&K.oops();r=Math.max(k.length,r),k=[]}})(r,e),c+=t.length),n+="\n"+t+"\n"}),n+=K.U.values(r.codeHelpers).join("\n")+"\n",r.usedClassInfos.forEach(e=>{n+=(e=>{K.U.assert(void 0!==e.classNo),K.U.assert(void 0!==e.lastSubtypeNo);let t=parseInt(e.attrs.maxBgInstances),r=(t=t||null,`const ${e.id}_VT = mkVTable({
`+`  name: ${JSON.stringify(K.getName(e.decl))},
`+`  numFields: ${e.allfields.length},
`+`  classNo: ${e.classNo},
`+`  lastSubtypeNo: ${e.lastSubtypeNo},
`+`  maxBgInstances: ${t},
`+`  methods: {
`);for(var n of e.vtable)r+=`    "${n.getName()}": ${n.label()},
`;r+="  },\n  iface: {\n";for(var s of e.itable)r+=`    "${s.name}": ${s.proc?s.proc.label():"null"},
`,s.setProc?r+=`    "set/${s.name}": ${s.setProc.label()},
`:s.proc||(r+=`    "set/${s.name}": null,
`);return r+="  },\n",e.toStringMethod&&(r+="  toStringMethod: "+e.toStringMethod.label()+",\n"),r+="});\n"})(e)}),e.breakpoints&&(n+=`
const breakpoints = setupDebugger(${e.breakpoints.length}, [${r.globals.filter(e=>e.isUserVariable).map(e=>`"${e.uniqueName()}"`).join(",")}])
`),(n+=`
return ${r.procs[0]?r.procs[0].label():"null"}
})
`).length);o=e=>(100*e/u).toFixed(2)+"%",e=`// total=${n.length} new=${o(c)} cached=${o(l)} other=${o(u-c-l)}
`,r.writeFile(K.BINARY_JS,e+n)}}})(ts=ts||{}),(e=>{{var c=e.pxtc||(e.pxtc={});c.thumbCmpMap={"numops::lt":"_cmp_lt","numops::gt":"_cmp_gt","numops::le":"_cmp_le","numops::ge":"_cmp_ge","numops::eq":"_cmp_eq","numops::eqq":"_cmp_eqq","numops::neq":"_cmp_neq","numops::neqq":"_cmp_neqq"};let s={"numops::adds":"_numops_adds","numops::subs":"_numops_subs","numops::orrs":"_numops_orrs","numops::eors":"_numops_eors","numops::ands":"_numops_ands","numops::lsls":"_numops_lsls","numops::asrs":"_numops_asrs","numops::lsrs":"_numops_lsrs","pxt::toInt":"_numops_toInt","pxt::fromInt":"_numops_fromInt"};class t extends c.AssemblerSnippets{stackAligned(){return c.target.stackAlign&&1<c.target.stackAlign}pushLR(){return this.stackAligned()?"push {lr, r5}  ; r5 for align":"push {lr}"}popPC(){return this.stackAligned()?"pop {pc, r5}  ; r5 for align":"pop {pc}"}nop(){return"nop"}mov(e,t){return`mov ${e}, `+t}helper_ret(){return"bx r4"}reg_gets_imm(e,t){return`movs ${e}, #`+t}push_fixed(e){return"push {"+e.join(", ")+"}"}pop_fixed(e){return"pop {"+e.join(", ")+"}"}proc_setup(t,e){let r="";if(0<t){r+="    movs r0, #0\n";for(let e=0;e<t;++e)r+="    push {r0} ;loc\n"}return r}proc_return(){return"pop {pc}"}debugger_stmt(e){return c.oops(),`
    @stackempty locals
    ldr r0, [r6, #0] ; debugger
    subs r0, r0, #4  ; debugger
${e}:
    ldr r0, [r0, #0] ; debugger
`}debugger_bkpt(e){return c.oops(),`
    @stackempty locals
    ldr r0, [r6, #0] ; brk
${e}:
    ldr r0, [r0, #0] ; brk
`}debugger_proc(e){return c.oops(),`
    ldr r0, [r6, #0]  ; brk-entry
    ldr r0, [r0, #4]  ; brk-entry
${e}:`}push_local(e){return`push {${e}}`}push_locals(e){return`sub sp, #4*${e} ; push locals ${e} (align)`}pop_locals(e){return`add sp, #4*${e} ; pop locals `+e}unconditional_branch(e){return"bb "+e}beq(e){return"beq "+e}bne(e){return"bne "+e}cmp(e,t){return"cmp "+e+", "+t}cmp_zero(e){return"cmp "+e+", #0"}load_reg_src_off(e,t,r,n,s,i){r=r.replace(/:\d+$/,""),n&&(r="#4*"+r);let a="str",o="ldr";return i&&(32==i.immLimit?a="strb":64==i.immLimit&&(a="strh"),o=i.needsSignExt?a.replace("str","ldrs"):a.replace("str","ldr")),s?a+` ${e}, [${t}, ${r}]`:o+` ${e}, [${t}, ${r}]`}rt_call(e,t,r){return e+" "+t+", "+r}alignedCall(e,t){return t?this.push_locals(t)+`
bl ${e}
`+this.pop_locals(t):"bl "+e}call_lbl(e,t,r){var n=c.U.lookup(s,e);return n&&(e=n,t=!1),(t=!t&&0<e.indexOf("::")?!0:t)?this.callCPP(e,r):this.alignedCall(e,r)}call_reg(e){return"blx "+e}helper_prologue(){return`
    @stackmark args
    ${this.pushLR()}
`}helper_epilogue(){return`
    ${this.popPC()}
    @stackempty args
`}load_ptr_full(e,t){return c.assert(!!e),`
    ldlit ${t}, ${e}
`}load_vtable(e,t){return`ldr ${e}, [${t}, #0]`}lambda_init(){return`
    mov r5, r0
    mov r4, lr
    bl pxtrt::getGlobalsPtr
    mov r6, r0
    bx r4
`}saveThreadStack(){return"mov r7, sp\n    str r7, [r6, #4]\n"}restoreThreadStack(){return c.target.switches.gcDebug?"movs r7, #0\n    str r7, [r6, #4]\n":""}callCPPPush(e){return this.pushLR()+"\n"+this.callCPP(e)+"\n"+this.popPC()+"\n"}callCPP(e,t){return this.saveThreadStack()+this.alignedCall(e,t)+"\n"+this.restoreThreadStack()}inline_decr(e){return`
    lsls r1, r0, #30
    bne .tag${e}
    bl _pxt_decr
.tag${e}:
`}arithmetic(){let t="",r=e=>{var t=".boxed:\n";return t+=`
                    ${this.pushLR()}
                    push {r0, r1}
                    ${this.saveThreadStack()}
                    ${e}
                    ${this.restoreThreadStack()}
                    add sp, #8
                    ${this.popPC()}
                `};var e,n,s,i,a=e=>{t+=`
_numops_${e}:
    @scope _numops_${e}
    lsls r2, r0, #31
    beq .boxed
    lsls r2, r1, #31
    beq .boxed
`},o=e=>{t=(t+=`    blx lr
`)+r("bl numops::"+e)};for(e of["adds","subs"])a(e),t+=`
    subs r2, r1, #1
    ${e} r2, r0, r2
    bvs .boxed
    movs r0, r2
`,o(e);for(n of["ands","orrs","eors"])a(n),t+=`    ${n} r0, r1
`,"eors"==n&&(t+=`    adds r0, r0, #1
`),o(n);for(s of["lsls","lsrs","asrs"])a(s),t+=`
    ; r3 := (r1 >> 1) & 0x1f
    lsls r3, r1, #26
    lsrs r3, r3, #27
`,"asrs"==s?t+=`
    asrs r0, r3
    movs r2, #1
    orrs r0, r2
`:("lsrs"==s?t+=`
    asrs r2, r0, #1
    lsrs r2, r3
    lsrs r3, r2, #30
    bne .boxed
`:t+=`
    asrs r2, r0, #1
    lsls r2, r3
    lsrs r3, r2, #30
    beq .ok
    cmp r3, #3
    bne .boxed
.ok:
`,t+=`
    lsls r0, r2, #1
    adds r0, r0, #1
`),o(s);t+=`
@scope _numops_toInt
_numops_toInt:
    asrs r0, r0, #1
    bcc .over
    blx lr
.over:
    lsls r0, r0, #1
    ${this.callCPPPush("pxt::toInt")}

_numops_fromInt:
    lsls r2, r0, #1
    asrs r1, r2, #1
    cmp r0, r1
    bne .over2
    adds r0, r2, #1
    blx lr
.over2:
    ${this.callCPPPush("pxt::fromInt")}
`;for(i of Object.keys(c.thumbCmpMap))i=i.replace(/.*::/,""),t=(t+=`
.section code
.object _pxt_helper_cmp_${i}
_cmp_${i}:
    lsls r2, r0, #31
    beq .boxed
    lsls r2, r1, #31
    beq .boxed
    subs r0, r1
    b${i.replace("qq","q").replace("neq","ne")} .true
.false:
    movs r0, #0
    bx lr
.true:
    movs r0, #1
    bx lr
`)+r(`
                        bl numops::${i}
                        bl numops::toBoolDecr
                        cmp r0, #0`);return t}emit_int(e,r){let n=!1;function t(e){c.assert(0<=e&&e<=255);let t="";return n?e&&(t=`adds ${r}, #${e}
`):t=`movs ${r}, #${e}
`,n=!0,t}function s(e=8){return`lsls ${r}, ${r}, #${e}
`}c.assert(null!=e);let i=Math.floor(e),a=!1,o=(i<0&&(a=!0,i=-i),0);if(255<i){let e=i;for(;0==(1&e);)e>>>=1,o++;c.numBytes(e)<c.numBytes(i)?i=e:o=0}let l="";switch(c.numBytes(i)){case 4:l=(l+=t(i>>>24&255))+s();case 3:l=(l+=t(i>>>16&255))+s();case 2:l=(l+=t(i>>>8&255))+s();case 1:l+=t(255&i);break;default:c.oops()}return o&&(l+=s(o)),a&&(l+=`negs ${r}, ${r}
`),4<l.split("\n").length?`ldlit ${r}, ${Math.floor(e)}
`:l}}c.ThumbSnippets=t}})(ts=ts||{}),(I=>{var e;{var N=I.pxtc||(I.pxtc={});let w={"pxtrt::mapSetGeneric":"mapset","pxtrt::mapGetGeneric":"mapget"},E={};function A(e,t,r){for(var n=N.computeHashMultiplier(e.itable.map(e=>e.idx)),s=N.U.toArray(n.mapping);3&s.length;)s.push(0);let i=`
${K(e)}_start:
        .short ${8*e.allfields.length+8}  ; size in bytes
        .byte ${pxt.ValTypeObject}, ${pxt.VTABLE_MAGIC} ; magic
        .short ${s.length} ; entries in iface hashmap
        .short ${e.lastSubtypeNo||e.classNo} ; last sub class-id
        .short ${e.classNo} ; class-id
        .short 0 ; reserved
        .word ${n.mult} ; hash-mult
`;$()?i+=`
            .word pxt::RefRecord_destroy
            .word pxt::RefRecord_print
            .word pxt::RefRecord_scan
            .word pxt::RefRecord_gcsize
            .word 0,0,0,0 ; keep in sync with VM_NUM_CPP_METHODS
`:i+=`
            .word 0,0, 0,0, 0,0, 0,0 ; space for 4 (VM_NUM_CPP_METHODS) native methods
`,i+=`
        .balign 4
${e.id}_IfaceVT:
`;var a;let o=s.length>>2,l="",c=o,u={};for(a of e.itable){u[a.idx+""]=c;var p=a.proc?a.proc.isGetter()?1:2:0;l=(l+=`  .short ${a.idx}, ${p} ; ${a.name}
`)+`  .word ${a.proc?a.proc.vtLabel()+"@fn":a.info}
`,c+=1,a.setProc&&(l=(l+=`  .short ${a.idx}, 2 ; set ${a.name}
`)+`  .word ${a.setProc.vtLabel()}@fn
`,c+=1)}l+="  .word 0, 0, 0, 0 ; the end\n",c+=1;for(let e=0;e<s.length;++e)r.itEntries++,s[e]&&r.itFullEntries++;return i=(i+="  .short "+N.U.toArray(s).map((e,t)=>u[e+""]||o).join(", ")+"\n")+l+"\n"}let v;function _(e){e=e.getTime()/1e3;return`${e>>>0}, `+(e/4294967296|0)}(e=v=v||{})[e.Invalid=0]="Invalid",e[e.InfoHeader=1]="InfoHeader",e[e.OpCodeMap=2]="OpCodeMap",e[e.NumberLiterals=3]="NumberLiterals",e[e.ConfigData=4]="ConfigData",e[e.IfaceMemberNames=5]="IfaceMemberNames",e[e.NumberBoxes=6]="NumberBoxes",e[e.Function=32]="Function",e[e.Literal=33]="Literal",e[e.VTable=34]="VTable";let T={};function K(e){return e.classNo||(T[e.id]=e),e.id+"_VT"}function $(){return N.target.useESP}function C(e){return $()?"0xffffffff, "+e:"0xffffffff, 0xffffffff ; -> "+e}N.vmEmit=function(l,t,r){let a=`; VM start
_img_start:
${N.hexfile.hexPrelude()}
`,c=(T={},{dblText:[],dblBoxText:[],dbls:{},opcodeMap:{},opcodes:N.vm.opcodes.map(e=>"pxt::op_"+e.replace(/ .*/,""))});for(c.opcodes.unshift(null);c.opcodes.length<128;)c.opcodes.push(null);let o=0;function s(e,t,r,n,s=0){if(a+=`
; --- ${e}
.section code
    .set ${e} = ${o}
`,n)for(var i of n)a+=`    .set ${i} = ${o}
`;a=(a+=`
_start_${e}:
    .byte ${t}, 0x00
    .short ${s}
    .word _end_${e}-_start_${e}
`)+r()+`
.balign 8
_end_${e}:
`,o++}let e=new Date(0),n=N.U.toUTF8(t.name,!0),i=(n=100<n.length?n.slice(0,100):n).length+1,u=(1&i&&i++,128-i),p=(s("_info",v.InfoHeader,()=>`
                ; magic - \\0 added by assembler
                .string "\\nPXT64\\n"
                .hex 5471fe2b5e213768 ; magic
                .hex ${N.hexfile.hexTemplateHash()} ; hex template hash
                .hex 0000000000000000 ; @SRCHASH@
                .word ${l.globalsWords}   ; num. globals
                .word ${l.nonPtrGlobals} ; non-ptr globals
                .word 0, 0 ; last usage time
                .word ${_(e)} ; installation time
                .word ${_(e)} ; publication time - TODO
                .word _img_end-_img_start ; total image size
                .space 60 ; reserved
                .string ${JSON.stringify(n)}
                .space ${u} ; pad to 128 bytes
`),l.procs.forEach(n=>{s(n.label(),v.Function,()=>{{var x=c,y=l,a=n,e;let t="",s=e=>{t+=e+"\n"},d=e=>{t+="    "+e+"\n"},m=N.ir.EK,f=[],h=[],g=!1,i=0,b=0,o=8388607;pxt.options.debug&&pxt.log("EMIT",a.toString()),r(),t="";for(e of f)e.reset();return g=!0,N.U.assert(0==b),r(),t;function r(){s(`;
; ${a.getFullName()}
;`),d(".section code"),y.procs[0]==a&&s("; main"),d(".word "+C("pxt::RefAction_vtable")),d(`.short 0, ${a.args.length} ; #args`),d(`.short ${a.captured.length}, 0 ; #cap`),d(".word .fnstart-_img_start, 0  ; func+possible padding"),i=a.locals.length+h.length,d(".fnstart:"),d(`pushmany ${i} ; incl. ${h.length} tmps`);for(var e of a.body)switch(e.stmtKind){case N.ir.SK.Expr:v(e.expr);break;case N.ir.SK.StackEmpty:I();for(var t of h)t&&N.oops(`uses: ${t.currUses}/${t.totalUses} `+t.toString());break;case N.ir.SK.Jmp:r=e,n=void 0,n=r.lbl.lblName,r.jmpMode==N.ir.JmpMode.Always?(r.expr&&v(r.expr),d("jmp "+n)):(v(r.expr),r.jmpMode==N.ir.JmpMode.IfNotZero?d("jmpnz "+n):r.jmpMode==N.ir.JmpMode.IfZero?d("jmpz "+n):N.oops());break;case N.ir.SK.Label:s(e.lblName+":");break;case N.ir.SK.Comment:s("; "+e.expr.data);break;case N.ir.SK.Breakpoint:break;default:N.oops()}var r,n;d(`ret ${a.args.length}, `+i)}function k(e){var t;return e.isGlobal()?(N.U.assert(0==(3&e.index)),"glb "+(e.index>>2)+" ; "+e.getName()):e.iscap?"cap "+e.index+" ; "+e.getName():e.isarg?(t=a.args.length-e.index-1,N.assert(0<=t,"arg#"+t),`loc ${b+i+2+t} ; `+e.getName()):(t=e.index+h.length,N.assert(!g||t<i,"cell#"+t),N.assert(0<=t,"cell#"+t),"loc "+(b+t))}function S(n){switch(n.exprKind){case m.NumberLiteral:var s=N.taggedSpecial(n.data);if(null!=s)d(`ldspecial ${s} ; `+n.data);else{s=n.data;let e=0,t=0;var i=s<<1>>1!=s;if((0|s)==s){if(Math.abs(s)<=o)return void(s<0?d("ldintneg "+-s):d("ldint "+s));e=(s<<1|1)>>>0,t=s<0?1:0}else{var a=new Float64Array(1),a=(a[0]=s,new Uint32Array(a.buffer));a[1]+=65536,e=a[0],t=a[1]}a=e+","+t;let r=N.U.lookup(x.dbls,a);null==r&&(r=x.dblText.length,x.dblText.push(`.word ${e}, ${t}  ; ${r}: `+n.data),i&&(i="pxt::number_vt",x.dblBoxText.push(`.word ${$()?i:"0xffffffff ; "+i}
`),(i=new Float64Array(1))[0]=s,i=new Uint32Array(i.buffer),x.dblBoxText.push(`.word ${i[0]}, ${i[1]} ; ${s}
`)),x.dbls[a]=r),d(`ldnumber ${r} ; `+n.data)}return;case m.PointerLiteral:return void d("ldlit "+n.data);case m.SharedRef:i=n.args[0],s=((!i.currUses||i.currUses>=i.totalUses)&&(pxt.log(i.sharingInfo()),N.U.assert(!1)),i.currUses++,h.indexOf(i));return s<0&&(pxt.log(h,i),N.assert(!1)),d("ldloc "+(s+b)+(i.currUses==i.totalUses?" ; LAST":"")),void I();case m.CellRef:return void d("ld"+k(n.data));case m.InstanceOf:v(n.args[0]),a=n.data,"bool"==n.jsInfo?d("checkinst "+K(a)):N.U.oops();break;default:throw N.oops("kind: "+n.exprKind)}}function v(n){switch(n.exprKind){case m.JmpValue:d("; jmp value (already in r0)");break;case m.Nop:d("; nop");break;case m.FieldAccess:var e=n.data;v(n.args[0]),d(`ldfld ${e.idx}, `+K(e.classInfo));break;case m.Store:var t=n.args[0],r=n.args[1];switch(t.exprKind){case m.CellRef:v(r);var s=t.data,i="st"+k(s);s.isGlobal()&&0!=s.bitSize&&(s=N.sizeOfBitSize(s.bitSize)|(N.isBitSizeSigned(s.bitSize)?16:0),d("bitconv "+s)),d(i);break;case m.FieldAccess:s=t.data;v(t.args[0]),T(),v(r),d(`stfld ${s.idx}, `+K(s.classInfo)),b--;break;default:N.oops()}return;case m.RuntimeCall:var e=n,a=e.data;if("pxt::beginTry"==a)d("try "+e.args[0].data);else{a=N.U.lookup(E,a)||a,I();var o=N.U.lookup(w,a),l=e.args;let t=0;if("pxt::mkClassInstance"==a)d("newobj "+l[0].data);else{for(let e=0;e<l.length;++e)v(l[e]),e<l.length-1&&(T(),t++);"langsupp::ignore"==a?t&&d(`popmany ${t} ; ignore`):o?d(o):(e=>{var t=N.hexfile.lookupFunc(e),r=(t||N.U.oops("missing function: "+e),x.opcodeMap[t.name]);null==r&&(r=x.opcodes.length,x.opcodes.push(t.name),x.opcodeMap[t.name]=r,t.value=r),d("callrt "+e)})(a),b-=t}}return;case m.ProcCall:{o=n;var c,a=o.data,u=a.proc;if(u&&u.inlineBody)return p=u.inlineSelf(o.args),pxt.options.debug&&pxt.log("INLINE",o.toString(),"->",p.toString()),v(p);let e=0,t=o.args.slice(),r=-1==a.virtualIndex?t.shift():null;for(c of t)v(c),T(),e++;var p=t.length;r?(v(r),d("callind "+p)):null!=a.ifaceIndex?(o=a.ifaceIndex+" ; ."+y.ifaceMembers[a.ifaceIndex],a.isSet?(d("callset "+o),N.U.assert(2==p)):a.noArgs?(d("callget "+o),N.U.assert(1==p)):d(`calliface ${p}, `+o)):null!=a.virtualIndex?N.U.oops():d("callproc "+u.label()),b-=e;return}case m.SharedDef:u=n;if(u=u.args[0],N.U.assert(1<=u.totalUses),N.U.assert(0===u.currUses),u.currUses=1,f.push(u),1==u.totalUses)return v(u);{v(u);let t=-1;for(let e=0;e<h.length;++e)if(null==h[e]){t=e;break}t<0?(g&&(pxt.log(u,h),N.assert(!1,"missed tmp")),t=h.length,h.push(u)):h[t]=u,d("stloc "+(t+b))}return;case m.Sequence:return n.args.forEach(v);default:return S(n)}}function T(){d("push"),b++}function I(){for(let e=0;e<h.length;++e){var t=h[e];t&&t.currUses==t.totalUses&&(g||f.push(t),h[e]=null)}}}},[n.label()+"_Lit"])}),a=a+"_code_end:\n\n"+"_helpers_end:\n\n",l.usedClassInfos.forEach(e=>{s(K(e),v.VTable,()=>A(e,0,l))}),N.U.values(T).forEach(e=>{e.itable=[],e.classNo=65520,s(K(e),v.VTable,()=>A(e,0,l))}),T={},0),d=(s("ifaceMemberNames",v.IfaceMemberNames,()=>`    .word ${l.ifaceMembers.length} ; num. entries
`+l.ifaceMembers.map(e=>`    .word ${l.emitString(e)}  ; ${p++} .`+e).join("\n")),a+="_vtables_end:\n\n",N.U.iterMap(l.hexlits,(e,t)=>{s(t,v.Literal,()=>`.word ${C("pxt::buffer_vt")}
`+N.hexLiteralAsm(e),[],pxt.BuiltInType.BoxedBuffer)}),N.U.unique(l.ifaceMembers.concat(Object.keys(l.strings)),e=>e).forEach(e=>{var t=N.utf8AsmStringLiteral(e);let r=pxt.BuiltInType.BoxedString,n=("pxt::string_inline_ascii_vt"==t.vt?r=pxt.BuiltInType.BoxedString_ASCII:"pxt::string_skiplist16_packed_vt"==t.vt?r=pxt.BuiltInType.BoxedString_SkipList:"pxt::string_inline_utf8_vt"==t.vt?r=pxt.BuiltInType.BoxedString:N.oops("invalid vt"),`.word ${C(t.vt)}
`+t.asm);s(l.strings[e],v.Literal,()=>n,[],r)}),s("numberBoxes",v.NumberBoxes,()=>c.dblBoxText.join("\n")+"\n.word 0, 0, 0 ; dummy entry to make sure not empty"),s("numberLiterals",v.NumberLiterals,()=>c.dblText.join("\n")+"\n.word 0, 0 ; dummy entry to make sure not empty"),r.configData||[]),m=(s("configData",v.ConfigData,()=>d.map(e=>`    .word ${e.key}, ${e.value}  ; ${e.name}=`+e.value).join("\n")+"\n    .word 0, 0"),c.opcodes.map(e=>null==e?"":e).join("\0")+"\0"),f="";for(;m;){let e=m.slice(0,64);m=m.slice(64),1&e.length&&(e+="\0"),f+=".hex "+N.U.toHex(N.U.stringToUint8Array(e))+"\n"}s("opcodeMap",v.OpCodeMap,()=>f),a=(a+="_literals_end:\n")+"_img_end:\n\n; The end.\n",l.writeFile(N.BINARY_ASM,a);var h=N.assemble(t.target,l,a,r),g=(e=>{let s=[83,82,67,77,136,21,78,45,170,134,153,113,0,0,0,0];for(var n of Object.keys(e)){for(var i of N.U.stringToUint8Array(n))s.push(i);s.push(0);var a=e[n];let t=0,r=0;for(let e=0;e<a.length;e+=3)o(a[e]-t),o(a[e+1]-r>>1),o(a[e+2]>>1),t=a[e],r=a[e+1];s.push(255)}s.push(0),1&s.length&&s.push(0);var t=[];for(let e=0;e<s.length;e+=2)t.push(s[e]|s[e+1]<<8);return t;function o(r){if(0<=r&&r<240)s.push(r);else{let e=240;r<0&&(r=-r,e|=8);var n=s.length;s.push(null);let t=0;for(;0!=r;)s.push(255&r),r>>>=8,t++;s[n]=e|t}}})(r=h.thumbFile.getSourceMap());h.src&&l.writeFile(N.BINARY_ASM,`; srcmap size: ${g.length<<1} bytes
`+h.src);{let e="";for(var b of h.buf)e+=String.fromCharCode(255&b,b>>8);var x=N.U.sha256(e);for(let e=0;e<4;++e)h.buf[16+e]=parseInt(x.slice(4*e,4*e+4),16);r.__meta={name:t.name,programHash:h.buf[16]|h.buf[17]<<16}}if(l.writeFile(N.BINARY_SRCMAP,JSON.stringify(r)),pxt.options.debug){let r=h.thumbFile.peepCounts;var y,t=Object.keys(r);t.sort((e,t)=>r[t]-r[e]);for(y of t.slice(0,50))pxt.log(y+"  "+r[y])}if(h.buf){let e="";for(var k,S=h.buf;15&S.length;)S.push(0);N.U.pushRange(S,g);for(k of S)e+=String.fromCharCode(255&k,k>>8);e=I.pxtc.encodeBase64(e),$()?(l.writeFile(N.BINARY_PXT64,e),r=N.hexfile.patchHex(l,S,!1,!!N.target.useUF2)[0],l.writeFile(pxt.outputName(N.target),I.pxtc.encodeBase64(r))):l.writeFile(pxt.outputName(N.target),e)}}}})(ts=ts||{}),(Te=>{var e,Ie=Te.pxtc||(Te.pxtc={});{var we=Ie.decompiler||(Ie.decompiler={});let de;(e=de=we.DecompileParamKeys||(we.DecompileParamKeys={})).DecompileLiterals="decompileLiterals",e.TaggedTemplate="taggedTemplate",e.DecompileIndirectFixedInstances="decompileIndirectFixedInstances",e.DecompileArgumentAsString="decompileArgumentAsString";let me,fe=((e=me=we.CommentKind||(we.CommentKind={}))[e.SingleLine=0]="SingleLine",e[e.MultiLine=1]="MultiLine",we.DECOMPILER_ERROR=9267,Te.SyntaxKind),o=97,l=122,c=/^[^\f\n\r\t\v\u00a0\u1680\u180e\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]*$/,r=/^(?:Array<(.+)>)|(?:(.+)\[\])$/,he="math_number",ge="math_number_minmax",be="math_integer",xe="math_whole_number",ye="text",ke="logic_boolean",Se={"+":{type:"math_arithmetic",op:"ADD"},"-":{type:"math_arithmetic",op:"MINUS"},"/":{type:"math_arithmetic",op:"DIVIDE"},"*":{type:"math_arithmetic",op:"MULTIPLY"},"**":{type:"math_arithmetic",op:"POWER"},"%":{type:"math_modulo",leftName:"DIVIDEND",rightName:"DIVISOR"},"<":{type:"logic_compare",op:"LT"},"<=":{type:"logic_compare",op:"LTE"},">":{type:"logic_compare",op:"GT"},">=":{type:"logic_compare",op:"GTE"},"==":{type:"logic_compare",op:"EQ"},"===":{type:"logic_compare",op:"EQ"},"!=":{type:"logic_compare",op:"NEQ"},"!==":{type:"logic_compare",op:"NEQ"},"&&":{type:"logic_operation",op:"AND"},"||":{type:"logic_operation",op:"OR"}},u=/^\s*\/\/\s*(.*)$/,p=/^\s*(?:(?:(?:\/\*\*?)|(?:\*))(?!\/))?\s*(.*?)(?:\*?\*\/)?$/;class t{constructor(e){this.renames=e,this.renames.sort((e,t)=>e.span.start-t.span.start)}getRenamesInSpan(e,t){var r,n=[];for(r of this.renames){if(r.span.start>t)break;r.span.start>=e&&n.push(r)}return n}getRenameForPosition(e){for(var t of this.renames){if(t.span.start>e)return;if(t.span.start===e)return t}}}function d(t,r,n=!0){if(1===t.length&&"x"!==t&&"y"!==t&&"z"!==t){var e=t.charCodeAt(0);if(e>=o&&e<=l){var s=e-o;for(let e=1;e<26;e++){var i=String.fromCharCode(o+(s+e)%26);if("x"!==i&&"y"!==i&&"z"!==i&&!r[i])return n&&(r[i]=!0),i}}}for(let e=2;;e++){var a=t+e;if(!r[a])return n&&(r[a]=!0),a}}we.RenameMap=t,we.buildRenameMap=function(e,s,{declarations:r,takenNames:i}={declarations:"variables",takenNames:{}}){let a=Te.createLanguageService(new Ie.LSHost(e)),o=[];return function t(e){Te.forEachChild(e,e=>{if(Te.isDeclarationName(e)&&("all"===r||Te.isVariableDeclaration(e.parent))){let r=e.getText();if(i[r]){let t=d(r,i);var n=a.findRenameLocations(s.fileName,e.pos+1,!1,!1);n&&n.forEach(e=>{o.push({name:t,diff:t.length-r.length,span:e.textSpan})})}else i[r]=!0}t(e)})}(s),e=i,[new t(o),e]},we.getNewName=d;let ve;function Ee(r,s,t=!1,i=!1){switch(r.kind){case fe.WhileStatement:case fe.IfStatement:case fe.Block:return;case fe.ExpressionStatement:return Ee(r.expression,s,t,i);case fe.VariableStatement:var e,n=s;for(e of r.declarationList.declarations){e=v(e,n);if(e)return e}return;case fe.CallExpression:{var[a,c,o=!1,u=!1]=[r,s,t,i];let n=Ie.pxtInfo(a).callInfo;if(!n)return Ie.Util.lf("Function call not supported in the blocks");let l=c.attrs(n),e;if(Te.isIdentifier(a.expression)&&(e=c.declaredFunctions[a.expression.text]),o){if(l.forceStatement||l.handlerStatement)return Ie.Util.lf("Function with forceStatement cannot be used as an expression.")}else if(Re(a,c)&&!e)if(c.aliasBlocks[n.qName])n.decompilerBlockAlias=c.aliasBlocks[n.qName];else if(!c.opts.snippetMode)return Ie.Util.lf("No output expressions as statements");if("Math.pow"!=n.qName){if(pxt.Util.startsWith(n.qName,"Math."))if(je(n.qName.substring(5)))return;if(l.blockId===Ie.PAUSE_UNTIL_TYPE)return o=a.arguments[0],1===a.arguments.length&&(e=>{if(e.kind===fe.FunctionExpression||e.kind===fe.ArrowFunction){if(Re(e.body,c))return 1;e=e.body;if(1===e.statements.length)if(Ue(e.statements[0]).kind===fe.ReturnStatement)return 1}})(o)?void 0:Ie.Util.lf("Predicates must be inline expressions that return a value");o=Fe(n,l);if(o&&!l.handlerStatement&&!l.forceStatement&&!u)return Ie.Util.lf("Events must be top level");if(!l.blockId||!l.block){u=pxt.blocks.builtinFunctionInfo[n.qName];if(!u)return e?e.parameters.length!==n.args.length?Ie.Util.lf("Function calls in blocks must have the same number of arguments as the function definition"):void 0:Ie.Util.lf("Call statements must have a valid declared function");l.blockId=u.blockId}var u=De(n,c),p=c.blocks.apis.byQName[n.qName],d=c.compInfo(n),m=d.parameters.length+(d.thisParameter?1:0);if(l.imageLiteral||l.gridLiteral){if(1<n.args.length-m)return Ie.Util.lf("Function call has more arguments than are supported by its block");a=a.arguments[0];if(a.kind!=fe.StringLiteral&&a.kind!=fe.NoSubstitutionTemplateLiteral)return Ie.Util.lf("Only string literals supported for image literals");var a=(a.text||"").replace(/\s+/g,""),f=l.imageLiteralRows||5,h=(l.imageLiteralColumns||5)*(l.imageLiteral||l.gridLiteral);if(h*f!=a.length)return Ie.Util.lf("Invalid image pattern ({0} expected vs {1} actual)",h*f,a.length)}else{let r=n.args.length-m;if(0<r&&!(()=>{if(l.mutatePropertyEnum&&2==r&&2<=n.args.length){var e=n.args[n.args.length-2],t=n.args[n.args.length-1];if(e.kind===fe.ArrayLiteralExpression&&Me(t)){let r=[];if(!e.elements.some(e=>e.kind!==fe.PropertyAccessExpression||e.expression.kind!==fe.Identifier||(r.push(e.name.text),e.expression.text!==l.mutatePropertyEnum))){e=Ke(t);if(e){let t=e[0];return t.length===r.length&&!r.some(e=>-1===t.indexOf(e))}}}}})()){let e=r;if(o&&e--,l.defaultInstance&&e--,0<e)return Ie.Util.lf("Function call has more arguments than are supported by its block")}if(d.parameters.length||o){let r,n=l.defaultInstance||!!d.thisParameter;if(u.forEach((e,t)=>{r||n&&0===t||(n&&t--,r=(t=>{let r=Ue(t.value),n=t.info,s=t.param;if(n.isEnum){if(o(r))return;if(r.kind===fe.CallExpression){var i=Ie.pxtInfo(r).callInfo;let e=c.attrs(i);if(i&&"TD_ID"===e.shim&&i.args&&1===i.args.length){let e=Ue(i.args[0]);if(o(e))return}}else if(r.kind===fe.Identifier){let e=Ie.pxtInfo(r).commentAttrs;if(e&&e.enumIdentity)return}return Ie.Util.lf("Enum arguments may only be literal property access expressions")}if(Oe(r)&&(s.fieldEditor||s.shadowBlockId)){let e=!(!s.fieldOptions||!s.fieldOptions[de.DecompileLiterals]);if(!e&&s.shadowBlockId&&(t=c.blocks.blocksById[s.shadowBlockId],e=!(t&&t.parameters&&t.parameters.length&&(i=t.parameters[0].name,t.attributes.paramFieldEditorOptions)&&t.attributes.paramFieldEditorOptions[i]&&!t.attributes.paramFieldEditorOptions[i][de.DecompileLiterals])),!e)return Ie.Util.lf("Field editor does not support literal arguments")}else if(r.kind===fe.TaggedTemplateExpression&&s.fieldEditor){t=s.fieldOptions&&s.fieldOptions[de.TaggedTemplate];if(!t)return Ie.Util.lf("Tagged templates only supported in custom fields with param.fieldOptions.taggedTemplate set");var a=Ue(r.tag).getText(),t=t.split(";").map(e=>e.trim());if(-1===t.indexOf(a))return Ie.Util.lf("Function only supports template literals with tag '{0}'",t.join(", "));if(r.template.kind!==fe.NoSubstitutionTemplateLiteral)return Ie.Util.lf("Tagged template literals cannot have substitutions")}else if(r.kind===fe.ArrowFunction){a=r;if(a.parameters.length)if("objectdestructuring"===l.mutate){let e=Ue(a.parameters[0]);if(e.kind===fe.Parameter&&e.name.kind!==fe.ObjectBindingPattern)return Ie.Util.lf("Object destructuring mutation callbacks can only have destructuring patters as arguments")}else for(let e of a.parameters)if(e.name.kind!==fe.Identifier)return Ie.Util.lf("Only identifiers allowed as function arguments")}else if(c.blocks.apis.byQName[n.type])if(c.blocks.apis.byQName[n.type].attributes.fixedInstances){if(T(s))return;if(s.shadowBlockId){t=c.blocks.blocksById[s.shadowBlockId];if(t){t=pxt.blocks.compileInfo(t);if(t.parameters&&T(t.parameters[0]))return}}t=Ie.pxtInfo(r).callInfo;return t&&c.attrs(t).fixedInstance?void 0:Ie.Util.lf("Arguments of a fixed instance type must be a reference to a fixed instance declaration")}function o(e){for(var t=n.type.split("."),r=[];e.kind===fe.PropertyAccessExpression;)r.unshift(e.name.text),e=e.expression;if(e.kind===fe.Identifier){r.unshift(e.text);for(let e=0;e<t.length;e++)if(t[e]!==r[e])return;return 1}}})(e))}),r)return r}if(p){h=c.blocks.apis.byQName[p.namespace];if(h&&h.attributes.fixedInstances&&!h.attributes.decompileIndirectFixedInstances&&n.args.length){f=Ie.pxtInfo(n.args[0]).callInfo;if(!f||!c.attrs(f).fixedInstance)return Ie.Util.lf("Fixed instance APIs can only be called directly from the fixed instance")}}}}return}case fe.VariableDeclaration:return v(r,s);case fe.PostfixUnaryExpression:case fe.PrefixUnaryExpression:a=r;return a.operand.kind!=fe.Identifier?Ie.Util.lf("-- and ++ may only be used on an identifier"):a.operator!==fe.PlusPlusToken&&a.operator!==fe.MinusMinusToken?Ie.Util.lf("Only ++ and -- supported as prefix or postfix unary operators in a statement"):void 0;case fe.FunctionExpression:case fe.ArrowFunction:{m=r;o=s;let e=!1;if(m.parameters.length&&(d=Ce(m)[0])&&Ie.pxtInfo(d).callInfo&&(d=Ie.pxtInfo(d).callInfo,e="objectdestructuring"===o.attrs(d).mutate?m.parameters[0].name.kind!==fe.ObjectBindingPattern:m.parameters.some(e=>e.name.kind!==fe.Identifier)),e)return Ie.Util.lf("Unsupported parameters in error function");return}case fe.BinaryExpression:var l=r,g=s;if(l.left.kind===fe.ElementAccessExpression){if(l.operatorToken.kind!==fe.EqualsToken)return Ie.Util.lf("Element access expressions may only be assigned to using the equals operator")}else{if(l.left.kind===fe.PropertyAccessExpression)return l.operatorToken.kind!==fe.EqualsToken&&l.operatorToken.kind!==fe.PlusEqualsToken?Ie.Util.lf("Property access expressions may only be assigned to using the = and += operators"):$e(l.left,g);if(l.left.kind!==fe.Identifier)return Ie.Util.lf("This expression cannot be assigned to");switch(l.operatorToken.kind){case fe.EqualsToken:return $e(l.right,g);case fe.PlusEqualsToken:case fe.MinusEqualsToken:return;default:return Ie.Util.lf("Unsupported operator token in statement {0}",fe[l.operatorToken.kind])}}return;case fe.ForStatement:var b=r;return b.initializer&&b.incrementor&&b.condition?b.initializer.kind!==fe.VariableDeclarationList?Ie.Util.lf("only variable declarations are permitted in for loop initializers"):(u=b.initializer).declarations?1!=u.declarations.length?Ie.Util.lf("for loop with multiple variables not supported"):(u=u.declarations[0]).initializer.kind!==fe.NumericLiteral||"0"!==u.initializer.text?Ie.Util.lf("for loop initializers must be initialized to 0"):(e=>{if(b.incrementor.kind===fe.PostfixUnaryExpression||b.incrementor.kind===fe.PrefixUnaryExpression){var t=b.incrementor;if(t.operator===fe.PlusPlusToken&&t.operand.kind===fe.Identifier)return t.operand.text===e}})(u=u.name.text)?b.condition.kind!==fe.BinaryExpression?Ie.Util.lf("for loop conditionals must be binary comparison operations"):(p=b.condition).left.kind!==fe.Identifier||p.left.text!==u?Ie.Util.lf("left side of for loop conditional must be the variable declared in the initializer"):p.operatorToken.kind!==fe.LessThanToken&&p.operatorToken.kind!==fe.LessThanEqualsToken?Ie.Util.lf("for loop conditional operator must be either < or <="):void 0:Ie.Util.lf("for loop incrementors may only increment the variable declared in the initializer"):Ie.Util.lf("for loop with out-of-scope variables not supported"):Ie.Util.lf("for loops must have an initializer, incrementor, and condition");case fe.ForOfStatement:return r.initializer.kind!==fe.VariableDeclarationList?Ie.Util.lf("only variable declarations are permitted in for of loop initializers"):void 0;case fe.FunctionDeclaration:var x=r;if(!i)return Ie.Util.lf("Function declarations must be top level");if(0<x.parameters.length&&s.opts.allowedArgumentTypes)for(var y of x.parameters){if(y.initializer||y.questionToken)return Ie.Util.lf("Function parameters cannot be optional");y=y.type?y.type.getText():void 0;if(!y)return Ie.Util.lf("Function parameters must declare a type");y=Ge(y);if(-1===s.opts.allowedArgumentTypes.indexOf(y)&&!Ie.U.endsWith(y,"[]"))return Ie.Util.lf("Only types that can be added in blocks can be used for function arguments")}return;case fe.EnumDeclaration:{x=r;var k=i;if(!k)return Ie.Util.lf("Enum declarations must be top level");if(k=x.name.text,!(k=s.blocks.enumsByName[k]))return Ie.Util.lf("Enum declarations in user code must have a block");let t=!1;return x.members.forEach(e=>{if(!(t=e.name.kind!==fe.Identifier||t)&&e.initializer&&e.initializer.kind!==fe.NumericLiteral){if(e.initializer.kind===fe.BinaryExpression){e=e.initializer;if(e.operatorToken.kind===fe.LessThanLessThanToken&&e.left.kind===fe.NumericLiteral&&e.right.kind===fe.NumericLiteral&&"1"==e.left.text)return}t=!0}}),t?Ie.Util.lf("Invalid initializer for enum member"):void 0;return}case fe.ModuleDeclaration:var k=r,S=Ne(k,s);return S&&(k=Ae(k))?S:void 0;case fe.ReturnStatement:return function e(t){let r=Te.getEnclosingBlockScopeContainer(t);if(r)switch(r.kind){case fe.SourceFile:case fe.ArrowFunction:case fe.FunctionExpression:return!1;case fe.FunctionDeclaration:return r.parent&&r.parent.kind===fe.SourceFile&&!Ee(r,s,!1,!0);default:return e(r)}return!1}(r)?void 0:Ie.Util.lf("Return statements can only be used within top-level function declarations");case fe.BreakStatement:case fe.ContinueStatement:case fe.DebuggerStatement:case fe.EmptyStatement:return}return Ie.Util.lf("Unsupported statement in block: {0}",fe[r.kind]);function v(e,t){let r;return e.name.kind!==fe.Identifier?r=Ie.Util.lf("Variable declarations may not use binding patterns"):e.initializer?_e(e)||(r=$e(e.initializer,t)):r=Ie.Util.lf("Variable declarations must have an initializer"),r}}function Ne(e,t){if(!Te.isModuleBlock(e.body))return Ie.Util.lf("Namespaces cannot be nested.");var r=t.blocks.kindsByName[e.name.text];if(!r)return Ie.Util.lf("Only namespaces with 'kind' blocks can be decompiled");var n,s=Ie.Util.lf("Namespaces may only contain valid 'kind' exports");for(n of e.body.statements){if((e=>(e=Te.getLeadingCommentRangesOfNode(e,e.getSourceFile()))&&e.length)(n))return s;if(!Te.isVariableStatement(n)||!n.declarationList.declarations)return s;var i=1===n.declarationList.declarations.length,a=n.modifiers&&1===n.modifiers.length&&n.modifiers[0].kind===fe.ExportKeyword,o=n.declarationList.flags&Te.NodeFlags.Const;if(!(i&&a&&o))return s;i=n.declarationList.declarations[0];if(!i.initializer||!Te.isCallExpression(i.initializer)||!Te.isIdentifier(i.name))return s;a=i.initializer;if(a.arguments.length)return s;if(Te.isPropertyAccessExpression(a.expression)&&Te.isIdentifier(a.expression.expression)){if(a.expression.expression.text!==r.name||a.expression.name.text!==r.createFunctionName)return s}else{if(!Te.isIdentifier(a.expression))return s;if(a.expression.text!==r.createFunctionName)return s}}}function Ae(e){if(!Te.isModuleBlock(e.body))return Ie.Util.lf("Namespaces cannot be nested.");if(e.name.text!==pxt.sprite.TILE_NAMESPACE)return Ie.Util.lf("Tileset namespace must be named myTiles");var r=Ie.Util.lf("The myTiles namespace can only export tile variables with image literal initializers and no duplicate ids"),n=Ie.Util.lf("Tileset members must have a blockIdentity comment and no other annotations"),s=new RegExp(pxt.sprite.TILE_PREFIX+"(\\d+)"),i=[],a=/^\s*\/\/%\s*blockIdentity=[^\s]+\s*$/;for(let t of e.body.statements){var o=Te.getLeadingCommentRangesOfNode(t,t.getSourceFile());if(!o||!o.length)return n;o=o.map(e=>t.getSourceFile().text.substr(e.pos,e.end-e.pos)).filter(e=>!!e);if(1!==o.length||!a.test(o[0]))return n;if(!Te.isVariableStatement(t)||!t.declarationList.declarations)return r;var o=1===t.declarationList.declarations.length,l=t.modifiers&&1===t.modifiers.length&&t.modifiers[0].kind===fe.ExportKeyword,c=t.declarationList.flags&Te.NodeFlags.Const;if(!(o&&l&&c))return r;o=t.declarationList.declarations[0];if(!o.initializer||!Te.isTaggedTemplateExpression(o.initializer)||!Te.isIdentifier(o.name))return r;l=o.initializer;if(!Te.isIdentifier(l.tag)||"img"!==l.tag.text)return r;c=s.exec(o.name.text);if(!c||-1!==i.indexOf(c[1]))return r;i.push(c[1])}}function _e(e){if(e.initializer){if(e.initializer.kind===Te.SyntaxKind.NullKeyword||e.initializer.kind===Te.SyntaxKind.FalseKeyword||(t=e.initializer).kind===fe.ArrayLiteralExpression&&0===t.elements.length)return 1;if(Te.isStringOrNumericLiteral(e.initializer))return"0"===(t=e.initializer.getText())||Pe(t);e=Ie.pxtInfo(e.initializer).callInfo;if(e&&e.isAutoCreate)return 1}var t}function Ke(e){if(1===e.parameters.length&&e.parameters[0].name.kind===fe.ObjectBindingPattern){e=e.parameters[0].name.elements;let r={};return[e.map(e=>{var t;return n(e.propertyName)&&n(e.name)?(t=e.name.text,e.propertyName?(e=e.propertyName.text,r[e]=t,e):t):""}),r]}function n(e){return!e||e.kind===fe.Identifier}}function $e(e,t){switch(e.kind){case fe.NumericLiteral:case fe.TrueKeyword:case fe.FalseKeyword:case fe.ExpressionStatement:case fe.ArrayLiteralExpression:case fe.ElementAccessExpression:return;case fe.ParenthesizedExpression:return $e(e.expression,t);case fe.StringLiteral:case fe.FirstTemplateToken:case fe.NoSubstitutionTemplateLiteral:var r=e;return r=e.text,c.test(r)?void 0:Ie.Util.lf("Only whitespace character allowed in string literals is space");case fe.Identifier:r=Ie.pxtInfo(e);return(l=e)&&l.kind===fe.Identifier&&"undefined"===l.text?Ie.Util.lf("Undefined is not supported in blocks"):!Le(e)||r.commentAttrs&&r.commentAttrs.blockIdentity&&r.commentAttrs.enumIdentity&&t.blocks.apis.byQName[r.commentAttrs.blockIdentity]?void 0:Ie.Util.lf("Variable is declared in another file");case fe.BinaryExpression:l=e.operatorToken.getText();return Se[l]?void 0:Ie.Util.lf("Could not find operator {0}",l);case fe.PrefixUnaryExpression:var n=e.operator;return n===fe.MinusToken||n===fe.PlusToken||n===fe.ExclamationToken?void 0:Ie.Util.lf("Unsupported prefix unary operator{0}",n);case fe.PropertyAccessExpression:var n=e,a=t,o=Ie.pxtInfo(n).callInfo;if(o){var s=a.attrs(o),i=a.compInfo(o);if(s.blockIdentity&&a.blocks.apis.byQName[s.blockIdentity]||"lists_length"===s.blockId||"text_length"===s.blockId)return;if(o.decl.kind===fe.EnumMember){if(n.expression.kind===fe.Identifier){o=n.expression.text;if(a.declaredEnums[o])return}let[e,s]=Ce(n),i=!0;if(e){o=Ie.pxtInfo(e).callInfo;if(o&&o.args){let r=a.blocks.apis.byQName[o.qName],n=1==r.kind||2==r.kind;r&&o.args.forEach((e,t)=>{e===s&&r.parameters[n?t-1:t].isEnum&&(i=!1)})}}return i?Ie.Util.lf("Enum value without a corresponding block"):void 0}if(s.fixedInstance&&n.parent){if(n.parent.parent&&n.parent.kind===fe.PropertyAccessExpression&&n.parent.parent.kind===fe.CallExpression){if(n.parent.parent.expression===n.parent)return}else if(n.parent.kind===fe.CallExpression&&n.parent.expression!==n)return}else{if(s.blockCombine||s.blockId&&i&&i.thisParameter)return $e(n.expression,a);if(Te.isIdentifier(n.expression)&&a.declaredKinds[n.expression.text]){o=n.name.text,s=a.declaredKinds[n.expression.text];if(s&&(-1!==s.kindInfo.initialMembers.indexOf(o)||-1!==s.declaredNames.indexOf(o)))return}}}return Ie.Util.lf("No call info found");case fe.CallExpression:return Ee(e,t,!0,void 0);case fe.TaggedTemplateExpression:i=e,a=t;return(i=Ie.pxtInfo(i).callInfo)?(i=a.attrs(i)).blockIdentity&&a.blocks.apis.byQName[i.blockIdentity]?(a=a.blocks.apis.byQName[i.blockIdentity])?1!==(i=pxt.blocks.compileInfo(a)).parameters.length?Ie.Util.lf("Tagged template functions must have 1 argument"):void 0:Ie.Util.lf("Could not find blockIdentity for tagged template"):Ie.Util.lf("Tagged template does not have blockIdentity set"):Ie.Util.lf("Invalid tagged template");case fe.AsExpression:if("any"===(s=e).type.getText().trim()&&(Te.isStringOrNumericLiteral(s.expression)||s.expression.kind===fe.TrueKeyword||s.expression.kind===fe.FalseKeyword)){var[s]=Ce(s);if(s.kind===fe.BinaryExpression)switch(s.operatorToken.kind){case fe.EqualsEqualsToken:case fe.EqualsEqualsEqualsToken:case fe.ExclamationEqualsToken:case fe.ExclamationEqualsEqualsToken:case fe.LessThanToken:case fe.LessThanEqualsToken:case fe.GreaterThanToken:case fe.GreaterThanEqualsToken:return}}return Ie.Util.lf("Casting not supported in blocks")}var l;return Ie.Util.lf("Unsupported syntax kind for output expression block: {0}",fe[e.kind])}function Ce(e){return e.parent?e.parent.kind===fe.ParenthesizedExpression?Ce(e.parent):[e.parent,e]:[void 0,e]}function Ue(e){for(;e.kind===fe.ParenthesizedExpression;)e=e.expression;return e}function Pe(e){return'""'===e||"''"===e||"``"===e}function Le(e){return 4&Ie.pxtInfo(e).flags}function Fe(e,t){return t.blockId!==Ie.PAUSE_UNTIL_TYPE&&(e.decl.parameters,e.args.some((e,t)=>e&&Me(e)))}function Oe(e){if(!e)return!1;switch(e.kind){case fe.ParenthesizedExpression:return Oe(e.expression);case fe.ArrayLiteralExpression:var t;for(t of e.elements)if(!Oe(t)&&t.kind!==fe.TaggedTemplateExpression)return!1;return!0;case fe.NumericLiteral:case fe.StringLiteral:case fe.NoSubstitutionTemplateLiteral:case fe.TrueKeyword:case fe.FalseKeyword:return!0;case fe.PrefixUnaryExpression:var r=e;return(r.operator===fe.PlusToken||r.operator===fe.MinusToken)&&Oe(r.operand);default:return!1}}function Me(e){return e.kind===fe.ArrowFunction||e.kind===fe.FunctionExpression}function De(r,e){var n=[],s=e.blocks.apis.byQName[r.qName];if(s){var i=e.blocks.apis.byQName[r.qName].attributes,a=e.compInfo(r);let t=i.imageLiteral?1:0;a.thisParameter?n.push({value:Ue(r.args[0]),info:null,param:a.thisParameter}):i.defaultInstance&&n.push({value:Ue(r.args[0]),info:s.parameters[0],param:{definitionName:"__instance__",actualName:"this"}});var o=!(!a.thisParameter&&!i.defaultInstance);o&&t++;for(let e=t;e<r.args.length;e++)n.push({value:Ue(r.args[e]),info:s.parameters[o?e-1:e],param:a.parameters[e-t]})}return n}function Be(e){return e.body.statements.map(e=>{e=e.declarationList.declarations[0];return{name:e.name.text,initializer:e.initializer.getText()}})}function Re(e,t){switch(e.kind){case fe.BinaryExpression:var r=e.operatorToken.kind;return r!=fe.PlusEqualsToken&&r!=fe.MinusEqualsToken&&r!=fe.EqualsToken;case fe.PrefixUnaryExpression:r=e.operator;return r!=fe.PlusPlusToken&&r!=fe.MinusMinusToken;case fe.PostfixUnaryExpression:r=e.operator;return r!=fe.PlusPlusToken&&r!=fe.MinusMinusToken;case fe.CallExpression:var r=Ie.pxtInfo(e).callInfo,n=(Ie.assert(!!r),t.attrs(r));return r.isExpression&&!n.forceStatement&&!n.handlerStatement;case fe.Identifier:case fe.ParenthesizedExpression:case fe.NumericLiteral:case fe.StringLiteral:case fe.NoSubstitutionTemplateLiteral:case fe.TrueKeyword:case fe.FalseKeyword:case fe.NullKeyword:case fe.TaggedTemplateExpression:return 1;default:return}}function T(e){return e&&e.fieldOptions&&e.fieldOptions[de.DecompileIndirectFixedInstances]}function je(e){return qe(e)||ze(e)||Ve(e)||-1!==pxt.blocks.MATH_FUNCTIONS.binary.indexOf(e)}function qe(e){return-1!==pxt.blocks.MATH_FUNCTIONS.unary.indexOf(e)}function ze(e){return-1!==pxt.blocks.MATH_FUNCTIONS.infix.indexOf(e)}function Ve(e){return-1!==pxt.blocks.ROUNDING_FUNCTIONS.indexOf(e)}function Ge(e){var t=r.exec(e);return t?`${t[1]||t[2]}[]`:e}function m(t,e,r=!1){var n=[],s=t.getFullText();if(e&&e.length)for(var i of e){var a=Te.getLineOfLocalPosition(t,i.end),o=Te.getStartPositionOfLine(a+1,t)||s.length,a=Te.getStartPositionOfLine(a+2,t)||s.length,a=!r&&!s.substr(o,a-o).trim();let e=s.substr(i.pos,i.end-i.pos);e=e&&e.replace(/\r\n/g,"\n"),i.kind===Te.SyntaxKind.SingleLineCommentTrivia?(o=u.exec(e),n.push(o?{kind:me.SingleLine,text:o[1],start:i.pos,end:i.end,hasTrailingNewline:!!i.hasTrailingNewLine,followedByEmptyLine:a,isTrailingComment:r}:{kind:me.SingleLine,text:"",start:i.pos,end:i.end,hasTrailingNewline:!!i.hasTrailingNewLine,followedByEmptyLine:a,isTrailingComment:r})):(o=e.split("\n").map(e=>{e=p.exec(e);return e?e[1]:""}),n.push({kind:me.MultiLine,lines:o,start:i.pos,end:i.end,hasTrailingNewline:!!i.hasTrailingNewLine,followedByEmptyLine:a,isTrailingComment:r}))}return n}function He(e){let t="";for(var r of e)if(r.kind===me.SingleLine)r.text!==Ie.ON_START_COMMENT&&r.text!==Ie.HANDLER_COMMENT&&(t+=r.text.trim()+"\n");else for(var n of r.lines)t+=n.trim()+"\n";return t.trim()}function Je(e){var t=e.getFullText(),r=Te.createScanner(e.languageVersion,!1,e.languageVariant,t,void 0,e.getFullStart()),n=[];let s,i;for(;r.getTextPos()<e.end;){var a=r.scan();if(a===fe.SingleLineCommentTrivia||a===fe.MultiLineCommentTrivia){s=Te.getLeadingCommentRanges(t,r.getTokenPos())||[],i=(i=Te.getTrailingCommentRanges(t,r.getTokenPos())||[]).filter(t=>!s.some(e=>e.pos===t.pos)),n.push(...m(e,s,!1)),n.push(...m(e,i,!0));for(var o of n)o.end>r.getTextPos()&&r.setTextPos(o.end)}}return n.sort((e,t)=>e.start-t.start),n}function Qe(t,r){var n;for(let e=0;e<r.length;e++)!(n=r[e]).owner&&n.start>=t.pos&&n.end<=t.end&&(n.owner=t)}function We(e){if(void 0!==e.emitShadowOnly)return e.emitShadowOnly;let t=!1;if("expr"===e.value.kind){var r=e.value;if(r.type===he&&e.shadowType===ge&&(r.type=ge,r.fields[0].name="SLIDER",r.mutation=e.shadowMutation),!(t=r.type===e.shadowType))switch(r.type){case"math_number":case"math_number_minmax":case"math_integer":case"math_whole_number":case"logic_boolean":case"text":t=!e.shadowType}if(t&&r.inputs)for(var n of r.inputs)if(!We(n)){t=!1;break}}return e.emitShadowOnly=t}(e=ve=ve||{})[e.None=0]="None",e[e.InBlocksOnly=1]="InBlocksOnly",e[e.InTextBlocks=2]="InTextBlocks",we.decompileToBlocks=function(k,o,c,r){var e=o.statements;let n={blocksInfo:k,outfiles:{},diagnostics:[],success:!0,times:{}},S=(c.generateSourceMap&&(n.blockSourceMap=[]),{blocks:k,declaredFunctions:{},declaredEnums:{},declaredKinds:{},functionParamIds:{},attrs:v,compInfo:T,localReporters:[],tileset:[],opts:c||{},aliasBlocks:{}}),F=(o.getFullText(),""),s=[],d={},l=[],O=[],M=(()=>{let e=0;return()=>""+e++})(),t=k.apis.byQName,m=(Object.keys(t).forEach(e=>{e=t[e];e.attributes.blockAliasFor&&t[e.attributes.blockAliasFor]&&(S.aliasBlocks[e.attributes.blockAliasFor]=e.qName)}),Je(o)),D=e=>{if(e.kind!==fe.FunctionDeclaration||Ee(e,S,!1,!0))if(e.kind!==fe.EnumDeclaration||Ee(e,S,!1,!0)){var t,r;Te.isModuleDeclaration(e)?Ne(e,S)?Ae(e)||(S.tileset=Be(e).map(({name:e,initializer:t})=>({projectId:parseInt(e.substr(pxt.sprite.TILE_PREFIX.length)),data:pxt.sprite.imageLiteralToBitmap(t).data()}))):(t=e.name.text,r=Be(e),S.declaredKinds[t]&&S.declaredKinds[t].declaredNames.push(...r.map(({name:e})=>e))):e.kind===fe.Block&&Te.forEachChild(e,D)}else{let r=e.name.text;S.declaredEnums[r]=!0,(e=>{let n=[];return e.members.forEach(e=>{Ie.U.assert(e.name.kind===fe.Identifier);var t=e.name.text;let r;r=e.initializer?e.initializer.kind===fe.NumericLiteral?parseInt(e.initializer.text):(e=e.initializer,Ie.U.assert(e.left.kind===fe.NumericLiteral),Ie.U.assert("1"===e.left.text),Ie.U.assert(e.operatorToken.kind===fe.LessThanLessThanToken),Ie.U.assert(e.right.kind===fe.NumericLiteral),1<<parseInt(e.right.text)):0===n.length?0:n[n.length-1][1]+1,n.push([t,r])}),n})(e).forEach(([e,t])=>{s.push({name:t+e,type:r})})}else S.declaredFunctions[L(e.name)]=e},B=(Object.keys(k.kindsByName).forEach(e=>{var t=k.kindsByName[e];S.declaredKinds[e]={kindInfo:t,declaredNames:[]}}),Te.forEachChild(o,D),()=>(Math.PI*Math.random()).toString(36).slice(2));Object.keys(S.declaredFunctions).forEach(t=>{S.functionParamIds[t]={},S.declaredFunctions[t].parameters.forEach(e=>{S.functionParamIds[t][e.name.getText()]=B()+B()})}),Object.keys(S.declaredKinds).forEach(e=>{let t="KIND_"+e;S.declaredKinds[e].declaredNames.forEach(e=>s.push({name:e,type:t}))}),(s.length||S.tileset.length)&&(a("<variables>"),s.forEach(e=>{a(`<variable type="${Ie.U.htmlEscape(e.type)}">${Ie.U.htmlEscape(e.name)}</variable>`)}),S.tileset.forEach(e=>{a(`<variable type="${pxt.sprite.BLOCKLY_TILESET_TYPE}">${pxt.sprite.legacy.tileToBlocklyVariable(e)}</variable>`)}),a("</variables>"));let i;try{i=ce(e,void 0,!0,void 0,!c.snippetMode);for(var R of m)R.owner||l.push({refId:M(),comment:[R]})}catch(e){return pxt.reportException(e),n.success=!1,n.diagnostics=Ie.patchUpDiagnostics([{file:o,start:o.getFullStart(),length:o.getFullWidth(),messageText:e.message,category:Te.DiagnosticCategory.Error,code:we.DECOMPILER_ERROR}]),n}return i?g(i):c.snippetMode||e.length||(u(Te.pxtc.ON_START_TYPE,I(Te.pxtc.ON_START_TYPE,e[0])),p()),l.forEach(r=>{{let t=0,e=He(r.comment);var n,s;e.trim()&&((n=e.split("\n")).forEach(e=>t=Math.max(t,e.length)),s=Math.max(Math.min(10*t,480),160),a(`<comment h="${Math.max(Math.min(40*n.length,360),120)}" w="${s}" data="${Ie.U.htmlEscape(r.refId)}">`),a(Ie.U.htmlEscape(e)),a("</comment>"))}}),n.outfiles[o.fileName.replace(/(\.blocks)?\.\w*$/i,"")+".blocks"]=`<xml xmlns="http://www.w3.org/1999/xhtml">
${F}</xml>`,n;function a(e,t="\n"){F+=e+t}function f(e,t){t=t||`Language feature "${e.getFullText().trim()}"" not supported in blocks`,e=Ie.patchUpDiagnostics([{file:o,start:e.getFullStart(),length:e.getFullWidth(),messageText:t,category:Te.DiagnosticCategory.Error,code:1001}]);pxt.debug("decompilation error: "+t),Ie.U.pushRange(n.diagnostics,e),n.success=!1}function v(e){var t=k.apis.byQName[e.decompilerBlockAlias||e.qName];if(t){var r=t.attributes;if(!r.blockId||k.blocksById[r.blockId]||r.blockId===Ie.PAUSE_UNTIL_TYPE)return t.attributes}else if(e.decl){r=Ie.parseComments(e.decl);if(r)return r}return{paramDefl:{},callingConvention:0}}function T(e){e=k.apis.byQName[e.decompilerBlockAlias||e.qName];if(e)return pxt.blocks.compileInfo(e)}function h(e){if(!e)return"";switch(e.kind){case fe.ParenthesizedExpression:case fe.AsExpression:return h(e.expression);case fe.Identifier:return e.text;case fe.StringLiteral:case fe.FirstTemplateToken:case fe.NoSubstitutionTemplateLiteral:return`"${e.text}"`;case fe.NumericLiteral:return e.text;case fe.TrueKeyword:return"true";case fe.FalseKeyword:return"false";case fe.BinaryExpression:return`{${h(e.left)}${e.operatorToken.getText()}${h(e.right)}}`;case fe.PrefixUnaryExpression:return e.operator+h(e.operand);case fe.PropertyAccessExpression:return h(e.expression)+"."+h(e.name);case fe.ArrayLiteralExpression:return`[${e.elements.map(e=>h(e))}]`;case fe.ElementAccessExpression:return e.expression+`[${e.argumentExpression}]`;case fe.TaggedTemplateExpression:return`${h(e.tag)}\`${e.template.getText()}\``;case fe.CallExpression:return`${h(e.expression)}(${e.arguments.map(h).join(",")})`;default:return e.getText()}}function j(e,t){var r;return e==Te.pxtc.ON_START_TYPE?"xRRgvHNlG#rZ^u`HECiY":(e=(()=>{var t="!#$%()*+,-./:;=?@[]^_`{|}~ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=t.length,n=[];for(let e=0;e<20;e++)n[e]=t.charAt(Math.random()*r);return n.join("")})(),t&&(r=t.getFullStart(),n.blockSourceMap.push({id:e,startPos:r,endPos:r+t.getFullWidth()})),e)}function I(e,t){var r={kind:"statement",type:e};return n.blockSourceMap&&(r.id=j(e,t)),r}function w(e){return{kind:"expr",type:e}}function E(e,t,r,n){return{kind:"value",name:e,value:t,shadowType:r=(!r||r===he)&&n&&n.min&&n.max?ge:r,shadowMutation:n}}function g(e){e&&(u(e.type,e),z(e),void 0!==e.data&&a(`<data>${Ie.U.htmlEscape(e.data)}</data>`),e.handlers&&e.handlers.forEach(H),e.next&&(a("<next>"),g(e.next),a("</next>")),void 0!==e.comment&&a(`<comment pinned="false">${Ie.U.htmlEscape(He(e.comment))}</comment>`),p())}function q(t,e){a("<mutation ",""),Object.keys(t).forEach(e=>{void 0!==t[e]&&a(`${e}="${t[e]}" `,"")}),e?(a(">"),e.forEach(t=>{a(`<${t.nodeName} `,""),Object.keys(t.attributes).forEach(e=>{a(`${e}="${t.attributes[e]}" `,"")}),a("/>")}),a("</mutation>")):a("/>")}function z(e){e.mutation&&q(e.mutation,e.mutationChildren),e.fields&&e.fields.forEach(G),e.inputs&&e.inputs.forEach(V)}function V(e){if(a(`<value name="${e.name}">`),We(e))J(e.value,!0);else{if(void 0!==e.shadowType)switch(e.shadowType){case he:case be:case xe:a(`<shadow type="${e.shadowType}"><field name="NUM">0</field></shadow>`);break;case ge:a(`<shadow type="${ge}">`),e.shadowMutation&&q(e.shadowMutation),a('<field name="SLIDER">0</field></shadow>');break;case ke:a(`<shadow type="${ke}"><field name="BOOL">TRUE</field></shadow>`);break;case ye:a(`<shadow type="${ye}"><field name="TEXT"></field></shadow>`);break;default:a(`<shadow type="${e.shadowType}"/>`)}J(e.value)}a("</value>")}function G(e){a(`<field name="${Ie.U.htmlEscape(e.name)}">${Ie.U.htmlEscape(e.value.toString())}</field>`)}function H(e){a(`<statement name="${Ie.U.htmlEscape(e.name)}">`),g(e.statement),a("</statement>")}function J(e,t=!1){"text"===e.kind?a(e.value):(e=e,a(`<${t=t||e.isShadow?"shadow":"block"} ${e.id?`id="${e.id}" `:""}type="${Ie.U.htmlEscape(e.type)}">`),z(e),a(`</${t}>`))}function u(e,t){a(`<block ${t&&t.id?`id="${t.id}" `:""}type="${Ie.U.htmlEscape(e)}">`)}function p(){a("</block>")}function N(o){if($e(o,S))return W(o);switch(o.kind){case fe.ExpressionStatement:case fe.ParenthesizedExpression:return N(o.expression);case fe.Identifier:{var s=o;if(Le(s))return i=Ie.pxtInfo(s),ne(k.apis.byQName[i.commentAttrs.blockIdentity],i.commentAttrs.enumIdentity);let e=L(s),r=s.text,n=null;return S.localReporters.some(t=>{for(let e=0;e<t.length;++e)if(t[e].name===r)return n=t[e],!0;return!1}),n?ee(e,n.type,!1):(P(e,ve.InBlocksOnly),K("variables_get","VAR",e));return}case fe.StringLiteral:case fe.FirstTemplateToken:case fe.NoSubstitutionTemplateLiteral:return Z(o.text);case fe.NumericLiteral:return _(o.text);case fe.TrueKeyword:return x(!0);case fe.FalseKeyword:return x(!1);case fe.BinaryExpression:{var i=o;var s=i.operatorToken.getText(),a=Se[s];if(b(i))return Y(i);let e=a.leftName||"A",t=a.rightName||"B",r,n;return n="&&"===s||"||"===s?(r=y(e,i.left),y(t,i.right)):(r=A(e,i.left,he),A(t,i.right,he)),(s=w(a.type)).fields=[],a.op&&s.fields.push($("OP",a.op)),s.inputs=[r,n],s;return}case fe.PrefixUnaryExpression:var e=o;switch(e.operator){case fe.ExclamationToken:var t=w("logic_negate");return t.inputs=[y("BOOL",e.operand)],t;case fe.PlusToken:return N(e.operand);case fe.MinusToken:return e.operand.kind==fe.NumericLiteral?_("-"+e.operand.text):te(e.operand);default:f(e)}return;case fe.PropertyAccessExpression:return re(o);case fe.ArrayLiteralExpression:return a=o,(r=w("lists_create_with")).inputs=a.elements.map((e,t)=>A("ADD"+t,e)),r.mutation={items:a.elements.length.toString()},r;case fe.ElementAccessExpression:return r=o,(c=w("lists_index_get")).inputs=[A("LIST",r.expression),A("INDEX",r.argumentExpression,he)],c;case fe.TaggedTemplateExpression:{c=o;let e=Ie.pxtInfo(c).callInfo,t,r=(e=>{if(e.parent&&e.parent.kind===fe.CallExpression){var t=e.parent,r=Ie.pxtInfo(t).callInfo,t=t.arguments.indexOf(e);if(r&&-1!==t)return(e=T(r))&&e.parameters[t]}})(c);var l;t=(t=r&&r.shadowBlockId&&(l=S.blocks.blocksById[r.shadowBlockId])&&"TD_ID"===l.attributes.shim?l:t)||S.blocks.apis.byQName[v(e).blockIdentity];let n=pxt.blocks.compileInfo(t),s=w(t.attributes.blockId),i,a=n.parameters[0];return i=a.fieldOptions&&a.fieldOptions[de.DecompileArgumentAsString]?c.getText():c.template.text,s.fields=[$(a.actualName,i)],s;return}case fe.CallExpression:return C(o,void 0,void 0,!0);case fe.AsExpression:return N(o.expression);default:f(o,Ie.Util.lf("Unsupported syntax kind for output expression block: {0}",fe[o.kind]))}var c,r}function Q(s,i,e){if(r){e=r.getRenamesInSpan(i,e);if(e.length){let n=0;e.forEach(e=>{var t=e.span.start+n-i,r=t+e.span.length;n+=e.diff,s=s.slice(0,t)+e.name+s.slice(r)})}}return s}function W(e){var t=Q(e.getFullText(),e.getFullStart(),e.getEnd()).trim();return pe(e),Qe(e,m),K(Ie.TS_OUTPUT_TYPE,"EXPRESSION",t)}function b(e){if(e.kind===fe.BinaryExpression){var t=e;if("+"===t.operatorToken.getText()||t.operatorToken.kind==fe.PlusEqualsToken)return Ie.pxtInfo(e).exprInfo}}function Y(e){var t=[],r=(!function e(t,r){b(t)?(e(t.left,r),e(t.right,r)):r.push(t)}(e,t),[]);for(let e=0;e<t.length;e++)(0<e||!Pe(t[e].getText()))&&r.push(A("ADD"+r.length,t[e],ye));e=w("text_join");return e.inputs=r,e.mutation={items:r.length.toString()},e}function A(e,t,r,n){let s;return"expr"==(s="number"==typeof t?_(t.toString()):("boolean"==typeof t?x:"string"==typeof t?Z:N)(t)).kind&&"math_number"==s.type&&(t=s.fields[0].value,"math_integer"==r&&t%1==0&&(s.type="math_integer"),"math_whole_number"==r)&&t%1==0&&0<t&&(s.type="math_whole_number"),E(e,s,r,n)}function _(e){return K("math_number","NUM",e)}function Z(e){return K("text","TEXT",e)}function x(e){return K("logic_boolean","BOOL",e?"TRUE":"FALSE")}function K(e,t,r,n){e=w(e);return e.fields=[$(t,r)],e.isShadow=n,e}function X(e,t){t=K("variables_get_reporter","VAR",t);return t.mutation={duplicateondrag:"true"},E(e,t,void 0,t.mutation)}function ee(e,t,r){var n=pxt.blocks.reporterTypeForArgType(t),e=K(n,"VALUE",e);return"argument_reporter_custom"===n&&(e.mutation={typename:t}),r&&(e.mutation||(e.mutation={}),e.mutation.duplicateondrag="true"),e}function $(e,t){return{kind:"field",name:e,value:t}}function te(e){var t=w("math_arithmetic");return t.inputs=[A("A",0,he),A("B",e,he)],t.fields=[$("OP","MINUS")],t}function re(n,s=!1,i){var a=Ie.pxtInfo(n).callInfo;if(a){if(n.expression.kind===fe.Identifier){var o=n.expression.text;if(S.declaredEnums[o]){var l=k.enumsByName[o];if(l&&l.blockId)return K(l.blockId,"MEMBER",n.name.text)}else if(S.declaredKinds[o]){let e=S.declaredKinds[o];return K(e.kindInfo.blockId,"MEMBER",n.name.text)}}l=v(a);if(i=l.blockId||i,l.blockCombine)return oe(n,n,null,"@get@");if("lists_length"===l.blockId||"text_length"===l.blockId)return(o=w(Ie.U.htmlEscape(l.blockId))).inputs=[A("VALUE",n.expression)],o;let e=Ie.U.htmlEscape(l.blockId)||a.qName;var[o]=Ce(n),o=o&&Ie.pxtInfo(o).callInfo;if(s||!i&&!l.blockIdentity||o&&o.qName===l.blockIdentity)return{kind:"text",value:e};l.enumval&&o&&l.useEnumVal&&(e=l.enumval);let t=S.compInfo(a);if(i&&t&&t.thisParameter)return(s=w(i)).inputs=[A(Ie.U.htmlEscape(t.thisParameter.definitionName),n.expression,t.thisParameter.shadowBlockId)],s;let r=l.blockIdentity?k.apis.byQName[l.blockIdentity]:k.blocksById[i];return ne(r=i&&r.attributes.blockId!==i&&r.attributes.decompilerShadowAlias===i?k.blocksById[i]:r,e)}f(n)}function ne(e,t){var r=/(?:%|\$)([a-zA-Z0-9_]+)/.exec(e.attributes.block),e=w(Ie.U.htmlEscape(e.attributes.blockId));return e.fields=[{kind:"field",name:Ie.U.htmlEscape(r[1]),value:t}],e}function se(t,n){let i=[],r;for(let e=0;e<m.length&&(!(r=m[e]).owner&&r.start>=t.pos&&r.end<=t.end&&(r.owner=t,r.ownerStatement=n,i.push(r)),!(r.start>t.end));e++);if(r&&r.isTrailingComment){var e=Te.getLineAndCharacterOfPosition(o,t.end),s=Te.getLineAndCharacterOfPosition(o,r.start);if(e.line===s.line){if(r.ownerStatement){r.ownerStatement.comment.splice(r.ownerStatement.comment.indexOf(r),1);for(var a of l)a.comment.splice(a.comment.indexOf(r),1)}r.owner=t,r.ownerStatement=n,i.push(r)}}if(i.length){let r=[];if(function e(t){let[r]=Ce(t);if(!r||r.kind==fe.SourceFile)return!0;if(r.kind==fe.ExpressionStatement)return e(r);if(r.kind==fe.VariableDeclarationList)return e(r.parent);return!1}(t)){let n=[],s=[];i.forEach((e,t)=>{var r=e.owner&&e.start<e.owner.getStart();e.kind===me.MultiLine&&r&&(n.length&&(s.push(n),n=[]),t!=i.length-1)?s.push([e]):(n.push(e),e.followedByEmptyLine&&r&&(s.push(n),n=[]))}),i=n,s.forEach(e=>{var t=M();r.push(t),l.push({comment:e,refId:t})})}n&&(r.length&&(n.data?n.data+=";"+r.join(";"):n.data=r.join(";")),i)&&i.length&&(n.comment?n.comment=n.comment.concat(i):n.comment=i)}}function C(e,t,r,n=!1,s=!1){var i=e;let a,o=!1;var l,c,u,e=Ee(i,S,n,s);if(e)a=ie(i,void 0,e);else switch(i.kind){case fe.Block:return ce(i.statements,t,s);case fe.ExpressionStatement:return C(i.expression,t,r||i,n,s);case fe.VariableStatement:if(!(a=ce(i.declarationList.declarations,void 0,!1,r||i)))return d();o=!0;break;case fe.FunctionExpression:case fe.ArrowFunction:return C(i.body,t);case fe.BinaryExpression:a=(e=>{switch(e.left.text,e.operatorToken.kind){case fe.EqualsToken:return e.left.kind===fe.Identifier?U(e,e.left,e.right):e.left.kind==fe.PropertyAccessExpression?ae(e,e.left,e.right,"@set@"):((e,t,r)=>((e=I("lists_index_set",e)).inputs=[A("LIST",t.expression),A("INDEX",t.argumentExpression,he),A("VALUE",r)],e))(e,e.left,e.right);case fe.PlusEqualsToken:var t;return b(e)?(t=I("variables_set",e),P(r=L(e.left),ve.InBlocksOnly),t.inputs=[E("VALUE",Y(e),he)],t.fields=[$("VAR",r)],t):e.left.kind==fe.PropertyAccessExpression?ae(e,e.left,e.right,"@change@"):U(e,e.left,e.right,!0);case fe.MinusEqualsToken:var r=I("variables_change",e);return r.inputs=[E("VALUE",te(e.right),he)],r.fields=[$("VAR",L(e.left))],r;default:return void f(e,Ie.Util.lf("Unsupported operator token in statement {0}",fe[e.operatorToken.kind]))}})(i);break;case fe.PostfixUnaryExpression:case fe.PrefixUnaryExpression:a=(e=>{var t=e.operator===fe.PlusPlusToken;if(t||e.operator===fe.MinusMinusToken)return U(e,e.operand,t?1:-1,!0);f(e)})(i);break;case fe.VariableDeclaration:var p=i;if(_e(p))return p=p,O.push([L(p.name),p]),d();a=(e=>{if((e=>{if(e.name.kind!==fe.Identifier)f(e,Ie.Util.lf("Variable declarations may not use binding patterns"));else{if(e.initializer)return 1;f(e,Ie.Util.lf("Variable declarations must have an initializer"))}})(e))return U(e,e.name,e.initializer)})(i);break;case fe.WhileStatement:a=((u=I("device_while",p=i)).inputs=[y("COND",p.expression)],u.handlers=[{name:"DO",statement:C(p.statement)}],u);break;case fe.IfStatement:a=(e=>{let t=function t(r){let n={ifStatements:[{expression:r.expression,thenStatement:r.thenStatement}],elseStatement:r.elseStatement};if(r.elseStatement&&r.elseStatement.kind==fe.IfStatement){let e=t(r.elseStatement);n.ifStatements=n.ifStatements.concat(e.ifStatements),n.elseStatement=e.elseStatement}return n}(e),n=I("controls_if",e);return n.mutation={elseif:(t.ifStatements.length-1).toString(),else:t.elseStatement?"1":"0"},n.inputs=[],n.handlers=[],t.ifStatements.forEach((e,t)=>{var r=C(e.thenStatement);n.inputs.push(y("IF"+t,e.expression)),n.handlers.push({name:"DO"+t,statement:r})}),t.elseStatement&&(e=C(t.elseStatement),n.handlers.push({name:"ELSE",statement:e})),n})(i);break;case fe.ForStatement:a=(e=>{let t=e.initializer,r=(t.declarations[0].name.text,e.condition),n=L(t.declarations[0].name),s;r.operatorToken.kind!==fe.LessThanToken||function e(t){if(t.kind===fe.Identifier&&L(t)===n)return!0;return Te.forEachChild(t,e)}(e.statement)?((s=I("pxt_controls_for",e)).fields=[],s.inputs=[],s.handlers=[],s.inputs=[X("VAR",n)],r.operatorToken.kind===fe.LessThanToken?(a=Ue(r.right)).kind===fe.NumericLiteral?(i=_(parseFloat(a.text)-1+""),s.inputs.push(E("TO",i,xe))):((i=w("math_arithmetic")).fields=[$("OP","MINUS")],i.inputs=[A("A",a,he),A("B",1,he)],s.inputs.push(E("TO",i,xe))):r.operatorToken.kind===fe.LessThanEqualsToken&&s.inputs.push(A("TO",r.right,xe))):((s=I("controls_repeat_ext",e)).fields=[],s.inputs=[A("TIMES",r.right,xe)],s.handlers=[]);var i,a=C(e.statement);return s.handlers=[{name:"DO",statement:a}],s})(i);break;case fe.ForOfStatement:a=(l=L((l=(u=i).initializer).declarations[0].name),(c=I("pxt_controls_for_of",u)).inputs=[A("LIST",u.expression),X("VAR",l)],l=C(u.statement),c.handlers=[{name:"DO",statement:l}],c);break;case fe.FunctionDeclaration:a=(e=>{let n=L(e.name),t=(S.localReporters.push(e.parameters.map(e=>({name:e.name.getText(),type:e.type.getText()}))),C(e.body));S.localReporters.pop();let s;return(s=I("function_definition",e)).mutation={name:n},e.parameters&&(s.mutationChildren=[],e.parameters.forEach(e=>{var t=e.name.getText();let r=Ge(e.type.getText());pxt.U.endsWith(r,"[]")&&(r="Array"),s.mutationChildren.push({nodeName:"arg",attributes:{name:t,type:r,id:S.functionParamIds[n][t]}})})),s.handlers=[{name:"STACK",statement:t}],s})(i);break;case fe.CallExpression:a=((n,e)=>{let x=Ie.pxtInfo(n).callInfo,y=v(x);if("Math.pow"==x.qName){let e=w("math_arithmetic");return e.inputs=[E("A",N(n.arguments[0]),he),E("B",N(n.arguments[1]),he)],e.fields=[$("OP","POWER")],e}if(pxt.Util.startsWith(x.qName,"Math.")){var r=x.qName.substring(5);if(je(r)){let t;if(Ve(r))t=w("math_js_round");else{t=w("math_js_op");let e;e=qe(r)?"unary":ze(r)?"infix":"binary",t.mutation={"op-type":e}}return t.inputs=x.args.map((e,t)=>E("ARG"+t,N(e),"math_number")),t.fields=[$("OP",r)],t}}if(y.blockId===Ie.PAUSE_UNTIL_TYPE){let e=I(Ie.PAUSE_UNTIL_TYPE,n);r=n.arguments[0];let t;return t=r.body.kind===fe.Block?r.body.statements[0].expression:r.body,e.inputs=[E("PREDICATE",N(t),"logic_boolean")],e}if(!y.blockId||!y.block){var t=pxt.blocks.builtinFunctionInfo[x.qName];if(!t){let a=L(n.expression);if(S.declaredFunctions[a]){let i,e=!0;return Re(n,S)&&([o]=Ce(n),e=o&&o.kind===fe.ExpressionStatement),i=I(e?"function_call":"function_call_output",n),x.args.length&&(i.mutationChildren=[],i.inputs=[],S.declaredFunctions[a].parameters.forEach((e,t)=>{var r=e.name.getText(),n=S.functionParamIds[a][r];let s=Ge(e.type.getText());pxt.U.endsWith(s,"[]")&&(s="Array"),i.mutationChildren.push({nodeName:"arg",attributes:{name:r,type:s,id:n}});e=E(n,N(x.args[t]));i.inputs.push(e)})),i.mutation={name:a},i}return ie(n)}y.blockId=t.blockId}if(!y.imageLiteral&&!y.gridLiteral){Te.isFunctionLike(x.decl);let t=De(x,S),f=T(x),h=e?w(y.blockId):I(y.blockId,n),g=e=>(h.inputs||(h.inputs=[])).push(e),b=e=>(h.fields||(h.fields=[])).push(e),r=("Math.max"==x.qName&&b({kind:"field",name:"op",value:"max"}),0);if(t.forEach((e,s)=>{let i=e.value,a;var t,o=e.param,l=e.info,e=f.parameters[f.thisParameter?s-1:s],e=e&&e.range;if(e&&(t=e.min,e=e.max,a={min:t.toString(),max:e.toString()}),0===s&&y.defaultInstance){if(i.getText()===y.defaultInstance)return;h.mutation={showing:"true"}}if(!y.mutatePropertyEnum||s!==x.args.length-2){o&&o.isOptional&&++r;let n;if(o&&o.shadowBlockId&&(n=k.blocksById[o.shadowBlockId]),i.kind===fe.CallExpression&&(e=(t=Ie.pxtInfo(i).callInfo)&&v(t))&&"TD_ID"===e.shim&&l.isEnum&&(i=Ue(t.args[0])),o&&l&&l.isEnum&&i.kind===fe.Identifier)b($(Ie.U.htmlEscape(o.definitionName),Ie.pxtInfo(i).commentAttrs.enumIdentity));else if(o&&o.fieldOptions&&o.fieldOptions[de.DecompileArgumentAsString])b($(Ie.U.htmlEscape(o.definitionName),Ie.Util.htmlEscape(i.getText())));else switch(i.kind){case fe.FunctionExpression:case fe.ArrowFunction:var c=(e=>{if(e=Ke(e))return{callbackproperties:e[0].join(","),renamemap:Ie.Util.htmlEscape(JSON.stringify(e[1]))}})(i);let e=!1;if(c)h.mutation=c;else{c=i;let r=k.blocksById[y.blockId].parameters[f.thisParameter?s-1:s],n=(e,t)=>{"reporter"===y.draggableParameters?g(E("HANDLER_DRAG_PARAM_"+e.name,ee(t,e.type,!0),void 0)):g(X("HANDLER_DRAG_PARAM_"+e.name,t))};if(c.parameters.length&&(y.optionalVariableArgs?(h.mutation={numargs:c.parameters.length.toString()},"reporter"===y.draggableParameters?c.parameters.forEach((e,t)=>{t=r.handlerParameters[t];n(t,e.name.text)}):c.parameters.forEach((e,t)=>{h.mutation["arg"+t]=e.name.text})):c.parameters.forEach((e,t)=>{t=r.handlerParameters[t];y.draggableParameters?n(t,e.name.text):b($("HANDLER_"+t.name,e.name.text))})),y.draggableParameters){if(c.parameters.length<r.handlerParameters.length&&!y.optionalVariableArgs)for(let t=c.parameters.length;t<r.handlerParameters.length;t++){let e=r.handlerParameters[t];n(e,e.name)}"reporter"===y.draggableParameters&&(S.localReporters.push(r.handlerParameters),e=!0)}}c=C(i);(h.handlers||(h.handlers=[])).push({name:"HANDLER",statement:c}),e&&S.localReporters.pop();break;case fe.PropertyAccessExpression:var c=Ie.pxtInfo(i).callInfo,u=Ie.U.htmlEscape(o.definitionName),p=v(c);n&&"TD_ID"===n.attributes.shim?g(E(u,re(i,!1,o.shadowBlockId),o.shadowBlockId,a)):l&&l.isEnum||c&&(p.fixedInstance||p.blockIdentity===x.qName)?b($(u,re(i,!0).value)):g(A(u,i,o.shadowBlockId,a));break;case fe.BinaryExpression:if(o&&o.shadowOptions&&o.shadowOptions.toString){c=i;if(c.operatorToken.kind===fe.PlusToken&&((p=c.left).kind===fe.StringLiteral||p.kind===fe.NoSubstitutionTemplateLiteral)&&""===p.text){g(A(Ie.U.htmlEscape(o.definitionName),c.right,o.shadowBlockId||"text"));break}}g(A(Ie.U.htmlEscape(o.definitionName),i,o.shadowBlockId,a));break;default:let t;u=Ie.U.htmlEscape(o.definitionName);let r=!0;if("Math.random"==x.qName)t=E(u,(e=>{switch(e.kind){case fe.NumericLiteral:return _((parseInt(e.text)-1).toString());case fe.BinaryExpression:var t=e;if(t.operatorToken.kind==fe.PlusToken&&"1"==t.right.text)return N(t.left);default:return N(e)}})(i),he,a),r=!1;else if(Oe(i)){var d="text"==o.fieldEditor?i.text:i.getText(),m=o.shadowBlockId&&!(e=>{switch(e){case he:case ge:case be:case xe:case ye:case ke:return 1;default:return}})(o.shadowBlockId);if(le(o)&&o.fieldOptions.onParentBlock)return void b($(u,d));m&&(m=(e=>{if(k.blocksById[e]){e=pxt.blocks.compileInfo(k.blocksById[e]);if(!e.thisParameter&&1===e.parameters.length)return e.parameters[0]}})(o.shadowBlockId))&&le(m)&&(m=K(o.shadowBlockId,m.definitionName,d,!0),o.shadowOptions&&(m.mutation={customfield:Ie.Util.htmlEscape(JSON.stringify(o.shadowOptions))}),t=E(u,m,o.shadowBlockId,a),r=!1)}else if(i.kind===fe.TaggedTemplateExpression&&o.fieldOptions&&o.fieldOptions[de.TaggedTemplate])return void b($(u,Ie.Util.htmlEscape(i.getText())));r&&(t=A(u,i,o.shadowBlockId,a)),g(t)}}}),r)if(h.mutation||(h.mutation={}),y.compileHiddenArguments){let e=0,r=0;for(var s of t){let t=Ie.U.htmlEscape(s.param.definitionName);var i=h.inputs.find(e=>e.name===t);s.param.isOptional?i&&!We(i)&&(r=Math.max(s.param.definitionIndex-e+1,r)):e++}h.mutation._expanded=r.toString()}else h.mutation._expanded=r.toString();return h}var o=n,t=x;if((e=o.arguments[0]).kind!=fe.StringLiteral&&e.kind!=fe.NoSubstitutionTemplateLiteral)f(o);else{var n=I((t=v(t)).blockId,o),a=(n.fields=[],(e.text||"").replace(/\s+/g,"")),l=(t.imageLiteralColumns||5)*(t.imageLiteral||t.gridLiteral),c=t.imageLiteralRows||5;if((e=l*c)==a.length){let r="";for(let t=0;t<c;++t){for(let e=0;e<l;++e)r+=/[#*1]/.test(a[t*l+e])?"#":".";r+="\n"}return n.fields.push($("LEDS",`\`${r}\``)),n}f(o,Ie.Util.lf("Invalid image pattern ({0} expected vs {1} actual)",e,a.length))}})(i,n);break;case fe.DebuggerStatement:a=(e=>e=I(Ie.TS_DEBUGGER_TYPE,e))(i);break;case fe.BreakStatement:a=(e=>e=I(Ie.TS_BREAK_TYPE,e))(i);break;case fe.ContinueStatement:a=(e=>e=I(Ie.TS_CONTINUE_TYPE,e))(i);break;case fe.EmptyStatement:a=void 0;break;case fe.EnumDeclaration:case fe.ModuleDeclaration:return Qe(i,m),d();case fe.ReturnStatement:a=(e=>{var t=I(Ie.TS_RETURN_STATEMENT_TYPE,e);return e.expression?t.inputs=[E("RETURN_VALUE",N(e.expression),he)]:t.mutation={no_return_value:"true"},t})(i);break;default:return void f(i,t?Ie.Util.lf("Unsupported statement in block: {0}",fe[i.kind]):Ie.Util.lf("Statement kind unsupported in blocks: {0}",fe[i.kind]))}if(a){let e=a;for(;e.next;)e=e.next;e.next=d(),e.next&&(e.next.prev=e)}return o||se(r||i,a),a;function d(){if(t&&t.length)return C(t.shift(),t,void 0,!1,s)}}function ie(e,t,r){c.errorOnGreyBlocks&&f(e);let n=I(Ie.TS_STATEMENT_TYPE,e),s=(n.mutation={},pe(e),e.getText());var i=e.getStart(),a=e.getEnd(),o=(s=Q(s,i,a),Qe(e,m),t&&(s=t+s),[]);if(e.kind===fe.VariableStatement)for(var l of e.declarationList.declarations)o.push(L(l.name));else e.kind===fe.VariableDeclaration&&o.push(L(e.name));o.length&&(n.mutation.declaredvars=o.join(","));i=s.split("\n");return n.mutation.numlines=i.length.toString(),r&&c.includeGreyBlockMessages&&(n.mutation.error=Ie.U.htmlEscape(r)),i.forEach((e,t)=>{n.mutation["line"+t]=Ie.U.htmlEscape(e)}),n}function y(e,t){return(e=>{var t=Ue(e);switch(t.kind){case fe.TrueKeyword:case fe.FalseKeyword:case fe.Identifier:case fe.ElementAccessExpression:return;case fe.BinaryExpression:return(e=>{switch(e.operatorToken.kind){case fe.EqualsEqualsToken:case fe.EqualsEqualsEqualsToken:case fe.ExclamationEqualsToken:case fe.ExclamationEqualsEqualsToken:case fe.LessThanToken:case fe.LessThanEqualsToken:case fe.GreaterThanToken:case fe.GreaterThanEqualsToken:case fe.AmpersandAmpersandToken:case fe.BarBarToken:return;default:return Ie.Util.lf("Binary expressions in conditionals must evaluate to booleans")}})(t);case fe.CallExpression:return(e=>{var t=Ie.pxtInfo(e).callInfo;if(t){t=S.blocks.apis.byQName[t.qName];if(t&&"boolean"==t.retType)return;if(Te.isIdentifier(e.expression)&&S.declaredFunctions[e.expression.text])return}return Ie.Util.lf("Only functions that return booleans are allowed as conditions")})(t);case fe.PrefixUnaryExpression:if(t.operator===fe.ExclamationToken)return;default:return Ie.Util.lf("Conditions must evaluate to booleans or identifiers")}})(t)?E(e,W(t),ke):A(e,t,ke)}function U(e,t,r,n=!1){t=L(t),P(t,ve.InBlocksOnly),n=I(n?"variables_change":"variables_set",e.parent||e);return n.inputs=[A("VALUE",r,he)],n.fields=[$("VAR",t)],n}function ae(e,t,r,n){return oe(e,t,r,n)}function oe(e,n,s,i){let a=Ie.pxtInfo(n).callInfo;var o=S.blocks.apis.byQName[a?a.qName:""];if(o&&o.attributes.blockCombine){let t=o.namespace+`.${o.retType}.`+i;o=S.blocks.blocks.find(e=>e.qName==t),i=s?I(o.attributes.blockId,e):w(o.attributes.blockId),e=o.attributes._def.parameters;let r=a.qName;return o.combinedProperties&&o.combinedProperties.forEach(e=>{0===e.indexOf(a.qName)&&"@"===e.charAt(a.qName.length)&&(r=e)}),i.inputs=[A(e[0].name,n.expression)],i.fields=[$(e[1].name,r)],s&&i.inputs.push(A(e[2].name,s)),i}f(n)}function le(e){return e&&e.fieldOptions&&e.fieldOptions[de.DecompileLiterals]}function ce(t,e,r=!1,a,n=!1){var s=[],o=e||[];for(let e=t.length-1;0<=e;e--){var i=t[e];((i.kind===fe.FunctionDeclaration||i.kind==fe.ExpressionStatement&&(t=>{if(t.expression.kind==fe.CallExpression){var r=t.expression,r=Ie.pxtInfo(r).callInfo;if(!r)return f(t),0;let e=v(r);return e.block||S.aliasBlocks[r.qName]&&(r.decompilerBlockAlias=S.aliasBlocks[r.qName],e=v(r)),e.blockId&&!e.handlerStatement&&!e.forceStatement&&!r.isExpression&&Fe(r,e)}})(i))&&!Ee(i,S,!1,r)?s:o).unshift(i)}var l,c=[],u={};for(l of s){var p=l.kind===fe.FunctionDeclaration?void 0:(e=>{var e=e.expression,t=v(e=Ie.pxtInfo(e).callInfo);if(!t.blockAllowMultiple)return t.blockHandlerKey||(e=e.args.filter(e=>!Te.isArrowFunction(e)&&!Me(e)).map(e=>h(e)).join("$$"),t.blockId+"-"+e)})(l);p&&u[p]?c.push(C(l,void 0,void 0,!1,!1)):(u[p]=!0,c.push(C(l,void 0,void 0,!1,r)))}if(c.forEach(g),o.length){let i=o.shift();e=C(i,o,a,!1,r);if(n){let n=e,s=i;if(O.forEach(([t,r])=>{if(d[t]!==ve.InBlocksOnly){r.initializer;let e;(e=d[t]===ve.InTextBlocks?ie(r,"let "):U(i,r.name,r.initializer,!1)).next=n,n=e,se((s=r).parent,n)}}),n)return(a=I(Te.pxtc.ON_START_TYPE,s)).handlers=[{name:"HANDLER",statement:n}],a;ue(e)}return e}n&&ue(void 0)}function ue(e){c.alwaysEmitOnStart&&(u(Te.pxtc.ON_START_TYPE,e),p())}function P(e,t){d[e]!==ve.InTextBlocks&&(d[e]=t)}function pe(e){Te.forEachChild(e,e=>{e.kind===fe.Identifier&&P(L(e),ve.InTextBlocks),pe(e)})}function L(e){if(r){var t=r.getRenameForPosition(e.getStart());if(t)return t.name}return e.text}},we.getLeadingComments=function(e,t,r){return m(t,r||Te.getLeadingCommentRangesOfNode(e,t))},we.getTrailingComments=function(e,t){return m(t,Te.getTrailingCommentRanges(t.getFullText(),e.end))},we.getCommentsForStatement=function(t,r){var n,s=[];for(let e=0;e<r.length&&(!(n=r[e]).owner&&n.start>=t.pos&&n.end<=t.end&&(n.owner=t,s.push(n)),!(n.start>t.end));e++);return s},we.buildCommentMap=Je}})(ts=ts||{}),(e=>{function d(e,t){var r;switch(e){case"void":return"None";case"boolean":return"bool";case"string":return"str"}return null!=(r=t.byQName[e])&&r.pyQName?t.byQName[e].pyQName:(r=/^(?:Array<(.+)>)|(?:(.+)\[\])|(?:\[.+\])$/.exec(e))?`List[${d(r[1]||r[2],t)}]`:e}function m(e,t){return`\`\`\`${t?"python":"ts"}
${e}
\`\`\``}(e=(e=e.pxtc||(e.pxtc={})).service||(e.service={})).displayStringForSymbol=function(n,s,i){if(n){switch(n.kind){case 3:case 1:{var a=n;var o=s;var l=i;let e="",t=(3===a.kind?e+=o?"def ":"function ":e+="(method) ",e+=o?a.pyQName:a.qName,""),r=(a.parameters&&a.parameters.length&&(t=a.parameters.map(e=>e.name+": "+(o?e.pyTypeString:e.type)).join(", ")),a.retType||"void");return o&&(r=d(r,l)),m(`${e}(${t}): `+r,o);return}case 6:case 7:{a=n;l=s;var t=l?a.pyQName:a.qName;if(6===a.kind)return m("enum "+t,l);let e="(enum member) "+t;return a.attributes.enumval&&(e+=" = "+a.attributes.enumval),m(e,!1);return}case 5:return t=n,m("namespace "+(s?t.pyQName:t.qName),!1);case 9:return e=n,m("interface "+(s?e.pyQName:e.qName),!1);case 8:return e=n,m("class "+(s?e.pyQName:e.qName),s);case 4:var r=n,c=s,u=i,p=c?r.pyQName:"let "+r.qName;if(r.retType){let e=r.retType;return c&&(e=d(e,u)),m(p+": "+e,c)}return m(p,c);case 2:r=n,u=s,p=i,c="(property) "+(u?r.pyQName:r.qName);if(r.retType){let e=r.retType;return u&&(e=d(e,p)),m(c+": "+e,!1)}return m(c,!1)}var e;return`**${n.qName}**`}},e.displayStringForKeyword=function(e,t){return`\`\`\`${t?"py":"ts"}
(keyword) ${e}
\`\`\``}})(ts=ts||{}),(e=>{var b=e.pxtc||(e.pxtc={});{e=b.thumb||(b.thumb={});let t={r0:0,r1:1,r2:2,r3:3,r4:4,r5:5,r6:6,r7:7,r8:8,r9:9,r10:10,r11:10,r12:12,sp:13,r13:13,lr:14,r14:14,pc:15,r15:15};class r extends b.assembler.AbstractProcessor{constructor(){super(),this.addEnc("$r0","R0-7",e=>this.inrange(7,e,e)),this.addEnc("$r1","R0-7",e=>this.inrange(7,e,e<<3)),this.addEnc("$r2","R0-15",e=>this.inrange(15,e,7&e|(8&e)<<4)),this.addEnc("$r3","R0-15",e=>this.inrange(15,e,e<<3)),this.addEnc("$r4","R0-7",e=>this.inrange(7,e,e<<6)),this.addEnc("$r5","R0-7",e=>this.inrange(7,e,e<<8)),this.addEnc("$r01","R0-7",e=>this.inrange(7,e,e|e<<3)),this.addEnc("$i0","#0-255",e=>this.inrange(255,e,e)),this.addEnc("$i1","#0-1020",e=>this.inrange(255,e/4,e>>2)),this.addEnc("$i2","#0-510",e=>this.inrange(127,e/4,e>>2)),this.addEnc("$i3","#0-7",e=>this.inrange(7,e,e<<6)),this.addEnc("$i4","#0-31",e=>this.inrange(31,e,e<<6)),this.addEnc("$i5","#0-124",e=>this.inrange(31,e/4,e>>2<<6)),this.addEnc("$i6","#1-32",e=>0==e?null:32==e?0:this.inrange(31,e,e<<6)),this.addEnc("$i7","#0-62",e=>this.inrange(31,e/2,e>>1<<6)),this.addEnc("$i32","#0-2^32",e=>1),this.addEnc("$rl0","{R0-7,...}",e=>this.inrange(255,e,e)),this.addEnc("$rl1","{LR,R0-7,...}",e=>16384&e?this.inrange(255,-16385&e,256|255&e):this.inrange(255,e,e)),this.addEnc("$rl2","{PC,R0-7,...}",e=>32768&e?this.inrange(255,-32769&e,256|255&e):this.inrange(255,e,e)),this.addEnc("$la","LABEL",e=>this.inrange(255,e/4,e>>2)).isWordAligned=!0,this.addEnc("$lb","LABEL",e=>this.inrangeSigned(127,e/2,e>>1)),this.addEnc("$lb11","LABEL",e=>this.inrangeSigned(1023,e/2,e>>1)),this.addInst("adcs  $r0, $r1",16704,65472),this.addInst("add   $r2, $r3",17408,65280),this.addInst("add   $r5, pc, $i1",40960,63488),this.addInst("add   $r5, sp, $i1",43008,63488),this.addInst("add   sp, $i2",45056,65408).canBeShared=!0,this.addInst("adds  $r0, $r1, $i3",7168,65024),this.addInst("adds  $r0, $r1, $r4",6144,65024),this.addInst("adds  $r01, $r4",6144,65024),this.addInst("adds  $r5, $i0",12288,63488),this.addInst("adr   $r5, $la",40960,63488),this.addInst("ands  $r0, $r1",16384,65472),this.addInst("asrs  $r0, $r1",16640,65472),this.addInst("asrs  $r0, $r1, $i6",4096,63488),this.addInst("bics  $r0, $r1",17280,65472),this.addInst("bkpt  $i0",48640,65280),this.addInst("blx   $r3",18304,65415),this.addInst("bx    $r3",18176,65408),this.addInst("cmn   $r0, $r1",17088,65472),this.addInst("cmp   $r0, $r1",17024,65472),this.addInst("cmp   $r2, $r3",17664,65280),this.addInst("cmp   $r5, $i0",10240,63488),this.addInst("eors  $r0, $r1",16448,65472),this.addInst("ldmia $r5!, $rl0",51200,63488),this.addInst("ldmia $r5, $rl0",51200,63488),this.addInst("ldr   $r0, [$r1, $i5]",26624,63488),this.addInst("ldr   $r0, [$r1, $r4]",22528,65024),this.addInst("ldr   $r5, [pc, $i1]",18432,63488),this.addInst("ldr   $r5, $la",18432,63488),this.addInst("ldr   $r5, [sp, $i1]",38912,63488).canBeShared=!0,this.addInst("ldr   $r5, [sp]",38912,63488).canBeShared=!0,this.addInst("ldrb  $r0, [$r1, $i4]",30720,63488),this.addInst("ldrb  $r0, [$r1, $r4]",23552,65024),this.addInst("ldrh  $r0, [$r1, $i7]",34816,63488),this.addInst("ldrh  $r0, [$r1, $r4]",23040,65024),this.addInst("ldrsb $r0, [$r1, $r4]",22016,65024),this.addInst("ldrsh $r0, [$r1, $r4]",24064,65024),this.addInst("lsls  $r0, $r1",16512,65472),this.addInst("lsls  $r0, $r1, $i4",0,63488),this.addInst("lsrs  $r0, $r1",16576,65472),this.addInst("lsrs  $r0, $r1, $i6",2048,63488),this.addInst("mov   $r2, $r3",17920,65280),this.addInst("movs  $r0, $r1",0,65472),this.addInst("movs  $r5, $i0",8192,63488),this.addInst("muls  $r0, $r1",17216,65472),this.addInst("mvns  $r0, $r1",17344,65472),this.addInst("negs  $r0, $r1",16960,65472),this.addInst("nop",18112,65535),this.addInst("orrs  $r0, $r1",17152,65472),this.addInst("pop   $rl2",48128,65024),this.addInst("push  $rl1",46080,65024),this.addInst("rev   $r0, $r1",47616,65472),this.addInst("rev16 $r0, $r1",47680,65472),this.addInst("revsh $r0, $r1",47808,65472),this.addInst("rors  $r0, $r1",16832,65472),this.addInst("sbcs  $r0, $r1",16768,65472),this.addInst("sev",48960,65535),this.addInst("stm   $r5!, $rl0",49152,63488),this.addInst("stmia $r5!, $rl0",49152,63488),this.addInst("stmea $r5!, $rl0",49152,63488),this.addInst("str   $r0, [$r1, $i5]",24576,63488).canBeShared=!0,this.addInst("str   $r0, [$r1]",24576,63488).canBeShared=!0,this.addInst("str   $r0, [$r1, $r4]",20480,65024),this.addInst("str   $r5, [sp, $i1]",36864,63488).canBeShared=!0,this.addInst("str   $r5, [sp]",36864,63488).canBeShared=!0,this.addInst("strb  $r0, [$r1, $i4]",28672,63488),this.addInst("strb  $r0, [$r1, $r4]",21504,65024),this.addInst("strh  $r0, [$r1, $i7]",32768,63488),this.addInst("strh  $r0, [$r1, $r4]",20992,65024),this.addInst("sub   sp, $i2",45184,65408),this.addInst("subs  $r0, $r1, $i3",7680,65024),this.addInst("subs  $r0, $r1, $r4",6656,65024),this.addInst("subs  $r01, $r4",6656,65024),this.addInst("subs  $r5, $i0",14336,63488),this.addInst("svc   $i0",57088,65280),this.addInst("sxtb  $r0, $r1",45632,65472),this.addInst("sxth  $r0, $r1",45568,65472),this.addInst("tst   $r0, $r1",16896,65472),this.addInst("udf   $i0",56832,65280),this.addInst("uxtb  $r0, $r1",45760,65472),this.addInst("uxth  $r0, $r1",45696,65472),this.addInst("wfe",48928,65535),this.addInst("wfi",48944,65535),this.addInst("yield",48912,65535),this.addInst("cpsid i",46706,65535),this.addInst("cpsie i",46690,65535),this.addInst("beq   $lb",53248,65280),this.addInst("bne   $lb",53504,65280),this.addInst("bcs   $lb",53760,65280),this.addInst("bcc   $lb",54016,65280),this.addInst("bmi   $lb",54272,65280),this.addInst("bpl   $lb",54528,65280),this.addInst("bvs   $lb",54784,65280),this.addInst("bvc   $lb",55040,65280),this.addInst("bhi   $lb",55296,65280),this.addInst("bls   $lb",55552,65280),this.addInst("bge   $lb",55808,65280),this.addInst("blt   $lb",56064,65280),this.addInst("bgt   $lb",56320,65280),this.addInst("ble   $lb",56576,65280),this.addInst("bhs   $lb",53760,65280),this.addInst("blo   $lb",54016,65280),this.addInst("b     $lb11",57344,63488),this.addInst("bal   $lb11",57344,63488),this.addInst("bl    $lb",61440,63488,!0),this.addInst("bb    $lb",57344,63488,!0),this.addInst("ldlit   $r5, $i32",18432,63488)}toFnPtr(e,t,r){return b.target.runtimeIsARM&&/::/.test(r)?e+t&-2:e+t|1}wordSize(){return 4}is32bit(e){return"bl"==e.name||"bb"==e.name}postProcessAbsAddress(e,t){return t=(t^1)-e.baseOffset}emit32(e,t,r){var n,s,i=!!(t%2),a=(t=i?t+1&-4:t)>>1;return b.assert(null!=a),(0|a)==a&&-2097152<a&&a<2097152?(n=2047&a,s=a>>11&1023,{opcode:4026531840&a?62464|s:61440|s,opcode2:i?59392|n:63488|n,stack:0,numArgs:[t],labelName:r}):b.assembler.emitErr("jump out of range",r)}expandLdlit(r){let n,s=!1;var e=[];let i={},a=1;for(let t=0;t<r.lines.length;++t){var o=r.lines[t];if(e.push(o),"instruction"==o.type&&o.instruction&&"ldlit"==o.instruction.name){if(!n){var l=o.location+900;let e=t+1;for(;e<r.lines.length&&!(r.lines[e].location>l);++e){var c=r.lines[e].getOp();("b"==c||"bb"==c||"pop"==c&&"pc"==r.lines[e].words[2])&&(n=r.lines[e])}if(n)s=!1;else for(s=!0;--e>t;)if("instruction"==r.lines[e].type){n=r.lines[e];break}}var u=o.words[1],p="#"+o.words[3];let e=b.U.lookup(i,p);e||(e="_ldlit_"+ ++a,i[p]=e),o.ldlitLabel=o.words[3],o.update(`ldr ${u}, ${e} ; `+o.ldlitLabel)}if(o===n){n=null;var d,m,f=[],p="_jmpwords_"+ ++a;s&&f.push("bb "+p),f.push(".object PUSH"),f.push(".balign 4");for(d of Object.keys(i)){var h=i[d];f.push(h+": .word "+d.slice(1))}s&&f.push(p+":"),f.push(".object POP");for(m of f){r.buildLine(m,e);var g=e[e.length-1];g.scope=o.scope,g.lineNo=o.lineNo}i={}}}r.lines=e}getAddressFromLabel(e,t,r,n=!1){r=e.lookupLabel(r);if(null==r)return null;let s=e.location()+4;return n&&(s&=4294967292),r-s}isPop(e){return 48128==e}isPush(e){return 46080==e}isAddSP(e){return 45056==e}isSubSP(e){return 45184==e}peephole(e,t,r){var n=this.encoders.$lb11,s=this.encoders.$lb;function i(e,t){return null!=e.encode(t.numArgs[0]+8)&&null!=e.encode(t.numArgs[0]-8)&&null!=e.encode(t.numArgs[0])}var a=e.getOp();let o=!1;"bne"!=a&&"beq"!=a||("b"==t.getOp()&&0==e.numArgs[0]&&(o=!0),"bb"==t.getOp()&&2==e.numArgs[0]&&(o=!0)),"bb"==a&&i(n,e)?e.update("b "+e.words[1]):"b"==a&&-2==e.numArgs[0]?e.update(""):"bne"==a&&o&&i(s,t)?(e.update("beq "+t.words[1]),t.update("")):"beq"==a&&o&&i(s,t)?(e.update("bne "+t.words[1]),t.update("")):"push"!=a||16384!=e.numArgs[0]||"push"!=t.getOp()||16384&t.numArgs[0]?"pop"==a&&"pop"==t.getOp()&&32768==t.numArgs[0]?(e.update(e.text.replace("}",", pc}")),t.update("")):"push"==a&&"pop"==t.getOp()&&e.numArgs[0]==t.numArgs[0]?(b.assert(0<e.numArgs[0]),e.update(""),t.update("")):"push"==a&&"pop"==t.getOp()&&4==e.words.length&&4==t.words.length?(b.assert("{"==e.words[1]),e.update("mov "+t.words[2]+", "+e.words[2]),t.update("")):r&&"movs $r5, $i0"==e.getOpExt()&&"mov $r0, $r1"==t.getOpExt()&&e.numArgs[0]==t.numArgs[1]&&(n=r,s=e.numArgs[0],!!("pop"==n.getOp()&&n.numArgs[0]&1<<s))?(e.update("movs r"+t.numArgs[0]+", #"+e.numArgs[1]),t.update("")):"pop"==a&&0<=l(e)&&"push"==t.getOp()&&l(e)==l(t)?(e.update("ldr r"+l(e)+", [sp, #0]"),t.update("")):"push"==a&&"ldr $r5, [sp, $i1]"==t.getOpExt()&&l(e)==t.numArgs[0]&&0==t.numArgs[1]?t.update(""):r&&"push"==a&&0<=l(e)&&(n=t,s=l(e),"movs $r5, $i0"==n.getOpExt())&&n.numArgs[0]!=s&&"pop"==r.getOp()&&l(e)==l(r)&&(e.update(""),r.update("")):(e.update(t.text.replace("{","{lr, ")),t.update(""))}registerNo(e){if(!e)return null;e=e.toLowerCase();e=t[e];return void 0===e?null:e}testAssembler(){b.assembler.expectError(this,"lsl r0, r0, #8"),b.assembler.expectError(this,"push {pc,lr}"),b.assembler.expectError(this,"push {r17}"),b.assembler.expectError(this,"mov r0, r1 foo"),b.assembler.expectError(this,"movs r14, #100"),b.assembler.expectError(this,"push {r0"),b.assembler.expectError(this,"push lr,r0}"),b.assembler.expectError(this,"pop {lr,r0}"),b.assembler.expectError(this,"b #+11"),b.assembler.expectError(this,"b #+102400"),b.assembler.expectError(this,"bne undefined_label"),b.assembler.expectError(this,".foobar"),b.assembler.expect(this,"0200      lsls    r0, r0, #8\nb500      push    {lr}\n2064      movs    r0, #100        ; 0x64\nb401      push    {r0}\nbc08      pop     {r3}\nb501      push    {r0, lr}\nbd20      pop {r5, pc}\nbc01      pop {r0}\n4770      bx      lr\n0000      .balign 4\ne6c0      .word   -72000\nfffe\n"),b.assembler.expect(this,"4291      cmp     r1, r2\nd100      bne     l6\ne000      b       l8\n1840  l6: adds    r0, r0, r1\n4718  l8: bx      r3\n"),b.assembler.expect(this,"          @stackmark base\nb403      push    {r0, r1}\n          @stackmark locals\n9801      ldr     r0, [sp, locals@1]\nb401      push    {r0}\n9802      ldr     r0, [sp, locals@1]\nbc01      pop     {r0}\n          @stackempty locals\n9901      ldr     r1, [sp, locals@1]\n9102      str     r1, [sp, base@0]\n          @stackempty locals\nb002      add     sp, #8\n          @stackempty base\n"),b.assembler.expect(this,"b090      sub sp, #4*16\nb010      add sp, #4*16\n"),b.assembler.expect(this,'6261      .string "abc"\n0063      \n'),b.assembler.expect(this,'6261      .string "abcde"\n6463      \n0065      \n'),b.assembler.expect(this,"3042      adds r0, 0x42\n1c0d      adds r5, r1, #0\nd100      bne #0\n2800      cmp r0, #0\n6b28      ldr r0, [r5, #48]\n0200      lsls r0, r0, #8\n2063      movs r0, 0x63\n4240      negs r0, r0\n46c0      nop\nb500      push {lr}\nb401      push {r0}\nb402      push {r1}\nb404      push {r2}\nb408      push {r3}\nb520      push {r5, lr}\nbd00      pop {pc}\nbc01      pop {r0}\nbc02      pop {r1}\nbc04      pop {r2}\nbc08      pop {r3}\nbd20      pop {r5, pc}\n9003      str r0, [sp, #4*3]\n")}}function l(e){b.assert("push"==e.getOp()||"pop"==e.getOp());let t=0,r=-1,n=e.numArgs[0];for(;0<n;)1&n&&(r=-1==r?t:-2),n>>=1,t++;return 0<=r?r:-1}e.ThumbProcessor=r}})(ts=ts||{}),(r=>{var t,m=r.pxtc||(r.pxtc={});{var f=m.ir||(m.ir={});let p=m.Util;p.assert;let d,e=((t=d=f.EK||(f.EK={}))[t.None=0]="None",t[t.NumberLiteral=1]="NumberLiteral",t[t.PointerLiteral=2]="PointerLiteral",t[t.RuntimeCall=3]="RuntimeCall",t[t.ProcCall=4]="ProcCall",t[t.SharedRef=5]="SharedRef",t[t.SharedDef=6]="SharedDef",t[t.FieldAccess=7]="FieldAccess",t[t.Store=8]="Store",t[t.CellRef=9]="CellRef",t[t.Sequence=10]="Sequence",t[t.JmpValue=11]="JmpValue",t[t.Nop=12]="Nop",t[t.InstanceOf=13]="InstanceOf",0);class h{isExpr(){return!1}isStmt(){return!1}getId(){return this._id||(this._id=++e),this._id}}f.Node=h;class g extends h{constructor(e,t,r){super(),this.exprKind=e,this.args=t,this.data=r,this.callingConvention=0}static clone(e){var t=new g(e.exprKind,e.args?e.args.slice(0):null,e.data);return e.jsInfo&&(t.jsInfo=e.jsInfo),e.totalUses&&(t.totalUses=e.totalUses,t.currUses=e.currUses),t.callingConvention=e.callingConvention,t.mask=e.mask,t.isStringLiteral=e.isStringLiteral,t}reset(){this.currUses=0,this.prevTotalUses&&(this.totalUses=this.prevTotalUses)}ptrlabel(){return this.jsInfo instanceof b?this.jsInfo:null}hexlit(){var e=this.jsInfo;return null!=e.hexlit?e.hexlit:null}isExpr(){return!0}isPure(){return this.isStateless()||this.exprKind==d.CellRef}isLiteral(){switch(this.exprKind){case d.NumberLiteral:case d.PointerLiteral:return!0;default:return!1}}isStateless(){switch(this.exprKind){case d.NumberLiteral:case d.PointerLiteral:case d.SharedRef:return!0;default:return!1}}sharingInfo(){let e=this,t=this.getId();return this.exprKind!=d.SharedRef&&this.exprKind!=d.SharedDef||((e=this.args[0])?t=e.getId():e={currUses:"",totalUses:""}),`${e.currUses}/${e.totalUses} #`+t}toString(){return n(this)}canUpdateCells(){switch(this.exprKind){case d.NumberLiteral:case d.PointerLiteral:case d.CellRef:case d.JmpValue:case d.SharedRef:case d.Nop:return!1;case d.SharedDef:case d.FieldAccess:case d.InstanceOf:return this.args[0].canUpdateCells();case d.RuntimeCall:case d.ProcCall:case d.Sequence:case d.Store:return!0;default:throw m.oops()}}}f.Expr=g;let s;(t=s=f.SK||(f.SK={}))[t.None=0]="None",t[t.Expr=1]="Expr",t[t.Label=2]="Label",t[t.Jmp=3]="Jmp",t[t.StackEmpty=4]="StackEmpty",t[t.Breakpoint=5]="Breakpoint",t[t.Comment=6]="Comment";let i;(t=i=f.JmpMode||(f.JmpMode={}))[t.Always=1]="Always",t[t.IfZero=2]="IfZero",t[t.IfNotZero=3]="IfNotZero",f.lblNumUsesJmpNext=-101;class b extends h{constructor(e,t){super(),this.stmtKind=e,this.expr=t}isStmt(){return!0}toString(){return n(this)}}function n(e){return function s(e){if(e.isExpr()){let r=e,n=r.args?r.args[0]:null;switch(r.exprKind){case d.NumberLiteral:case d.PointerLiteral:return r.data+"";case d.CellRef:return r.data.toString();case d.JmpValue:return"JMPVALUE";case d.Nop:return"NOP";case d.SharedRef:return`SHARED_REF(#${n.getId()})`;case d.SharedDef:return`SHARED_DEF(#${n.getId()} u(${n.totalUses}): ${s(n)})`;case d.FieldAccess:return s(n)+"."+r.data.name;case d.RuntimeCall:return r.data+"("+r.args.map(s).join(", ")+")";case d.ProcCall:let e=r.data,t="";return(t=null!=e.ifaceIndex?"IFACE@"+e.ifaceIndex:null!=e.virtualIndex?"VTABLE@"+e.virtualIndex:m.getDeclName(e.proc.action))+"("+r.args.map(s).join(", ")+")";case d.Sequence:return"("+r.args.map(s).join("; ")+")";case d.InstanceOf:return"("+s(r.args[0])+" instanceof "+r.data.id+")";case d.Store:return`{ ${s(r.args[0])} := ${s(r.args[1])} }`;default:throw m.oops()}}else{let t=e,r=t.expr?s(t.expr):"{null}";switch(t.stmtKind){case f.SK.Expr:return"    "+r+"\n";case f.SK.Jmp:let e=`goto ${t.lblName}
`;switch(t.jmpMode){case i.Always:return t.expr?`    { JMPVALUE := ${r} } `+e:"    "+e;case i.IfZero:return`    if (! ${r}) `+e;case i.IfNotZero:return`    if (${r}) `+e;default:throw m.oops()}case f.SK.StackEmpty:return"    ;\n";case f.SK.Breakpoint:return"    // brk "+t.breakpointInfo.id+"\n";case f.SK.Comment:return"    // "+t.expr.data+"\n";case f.SK.Label:return t.lblName+":\n";default:throw m.oops()}}}(e)}f.Stmt=b;class x{constructor(e,t,r){this.index=e,this.def=t,this.info=r,this.isarg=!1,this.iscap=!1,this._isLocal=!1,this._isGlobal=!1,this._debugType="?",this.isUserVariable=!1,this.bitSize=0,t&&(m.isInPxtModules(t)||(this.isUserVariable=!0),r)&&m.setCellProps(this)}getName(){return m.getDeclName(this.def)}getDebugInfo(){return{name:this.getName(),type:this._debugType,index:this.index}}toString(){let e="";return this.def&&(e+=this.getName()||"?"),"["+(e=this.isarg?"ARG "+e:e)+"]"}uniqueName(){return this.isarg?"arg"+this.index:this.getName().replace(/[^\w]/g,"_")+"___"+m.getNodeId(this.def)}isLocal(){return this._isLocal}isGlobal(){return this._isGlobal}loadCore(){return o(d.CellRef,null,this)}load(){var e=this.loadCore();return m.target.isNative&&!m.isStackMachine()&&0!=this.bitSize?6==this.bitSize?c("pxt::fromUInt",[e]):c("pxt::fromInt",[e]):this.isByRefLocal()?c("pxtrt::ldlocRef",[e]):e}isByRefLocal(){return this.isLocal()&&this.info.captured&&this.info.written}storeDirect(e){return o(d.Store,[this.loadCore(),e])}storeByRef(e){var t;return this.isByRefLocal()?c("pxtrt::stlocRef",[this.loadCore(),e]):m.target.isNative&&!m.isStackMachine()&&0!=this.bitSize?(t=6==this.bitSize?"pxt::toUInt":"pxt::toInt",this.storeDirect(c(t,[e],1))):this.storeDirect(e)}get isTemporary(){return!1}}f.Cell=x;class y extends x{constructor(e,t){super(e,null,null),this.index=e,this.owningProc=t,this.uid=y.unnamedCellCounter++}getName(){return"unnamed"+this.uid}uniqueName(){return this.getName()+"___U"+this.index}isByRefLocal(){return!1}get isTemporary(){return!0}}y.unnamedCellCounter=0,f.UnnamedCell=y;class k extends h{constructor(){super(...arguments),this.numArgs=0,this.info=null,this.seqNo=-1,this.isRoot=!1,this.locals=[],this.captured=[],this.args=[],this.parent=null,this.debugInfo=null,this.fillDebugInfo=null,this.classInfo=null,this.perfCounterName=null,this.perfCounterNo=0,this.body=[],this.lblNo=0,this.action=null,this.cachedJS=null,this.usingCtx=null}reset(){this.body=[],this.lblNo=0,this.locals=[],this.captured=[],this.args=[]}isGetter(){return this.action&&this.action.kind==r.SyntaxKind.GetAccessor}vtLabel(){return this.label()+(m.isStackMachine()?"":"_args")}label(){return m.getFunctionLabel(this.action)}toString(){return`
PROC ${m.getDeclName(this.action)}
${this.body.map(e=>e.toString()).join("")}
`}emit(e){this.body.push(e)}emitExpr(e){this.emit(a(s.Expr,e))}mkLabel(e){var t=a(s.Label,null);return t.lblName="."+e+"_"+this.lblNo+++"_"+this.seqNo,t.lbl=t}emitLbl(e){this.emit(e)}emitLblDirect(e){var t=a(s.Label,null);t.lblName=e,this.emit(t.lbl=t)}getFullName(){let e=m.getDeclName(this.action);var t;return this.action&&(t=r.pxtc.nodeLocationInfo(this.action),e=t.fileName.replace("pxt_modules/","")+"("+(t.line+1)+","+(t.column+1)+"): "+e),e}getName(){return(this.action&&this.action.name?this.action.name.text:null)||"inline"}mkLocal(e,t){e=new x(this.locals.length,e,t);return this.locals.push(e),e}mkLocalUnnamed(){var e=new y(this.locals.length,this);return this.locals.push(e),e}localIndex(t,e=!1){return this.captured.filter(e=>e.def==t)[0]||this.locals.filter(e=>e.def==t)[0]||(e?null:this.args.filter(e=>e.def==t)[0])}stackEmpty(){this.emit(a(s.StackEmpty,null))}emitJmpZ(e,t){this.emitJmp(e,t,i.IfZero)}emitJmp(e,t,r=i.Always,n=null){t=a(s.Jmp,t);t.jmpMode=r,n&&n.exprKind==d.NumberLiteral&&(n=null),t.terminateExpr=n,"string"==typeof e?t.lblName=e:(t.lbl=e,t.lblName=t.lbl.lblName),this.emit(t)}inlineSelf(e){let{precomp:t,flattened:r}=u(e,!1,!0);p.assert(r.length==this.args.length),this.args.map((e,t)=>{e.repl=r[t],e.replUses=0});e=function t(r,e){switch((r=g.clone(r)).exprKind){case d.PointerLiteral:case d.NumberLiteral:return r;case d.RuntimeCall:for(let e=0;e<r.args.length;++e)r.args[e]=t(r.args[e],!0);return r;case d.CellRef:var n=r.data;return n.repl?n.repl.exprKind===d.CellRef&&e?g.clone(n.repl):(n.replUses++,n.repl):r;case d.FieldAccess:return r.args[0]=t(r.args[0]),r;default:throw p.oops()}}(this.inlineBody);return this.args.forEach((e,t)=>{e.repl.exprKind==d.SharedRef&&(e.repl.args[0].prevTotalUses||(e.repl.args[0].prevTotalUses=e.repl.args[0].totalUses),e.repl.args[0].totalUses+=e.replUses-1),e.repl=null,e.replUses=0}),t.length?(t.push(e),o(d.Sequence,t)):e}resolve(){let n=(t,r)=>{if(t.args)for(let e=0;e<t.args.length;++e)t.args[e]=r(t.args[e])},r=e=>{switch(e.exprKind){case d.SharedDef:throw p.oops();case d.SharedRef:var t=e.args[0];return t.totalUses?(t.totalUses--,e):(t.totalUses=-1,t.currUses=0,t.irCurrUses=0,(t=g.clone(e)).exprKind=d.SharedDef,t.args[0]=r(t.args[0]),t)}return n(e,r),e},t=r=>(r.exprKind!=d.SharedRef&&(n(r,t),r.exprKind===d.Sequence)&&(r.args=r.args.filter((e,t)=>t==r.args.length-1||!e.isPure()||(e.exprKind==d.SharedRef&&0<e.args[0].totalUses&&e.args[0].totalUses--,!1))),r),s=e=>{switch(e.exprKind){case d.SharedDef:var t=e.args[0];if(p.assert(t.totalUses<0,"arg.totalUses < 0"),p.assert(0===t.currUses,"arg.currUses === 0"),-1==t.totalUses)return s(t);t.totalUses=1;break;case d.SharedRef:return p.assert(0<e.args[0].totalUses,"e.args[0].totalUses > 0"),e.args[0].totalUses++,e;case d.PointerLiteral:t=e.ptrlabel();t&&(t.lblNumUses||(t.lblNumUses=0),t.lblNumUses++)}return n(e,s),e},i=e=>{switch(e.exprKind){case d.SharedDef:n(e,i);case d.SharedRef:var t=e.args[0];return(p.assert(0<t.totalUses,"arg.totalUses > 0"),1==t.totalUses)?(p.assert(e.exprKind==d.SharedDef),t):(t.irCurrUses++,e);default:return n(e,i),e}};this.body=this.body.filter(e=>!e.expr||(e.expr=t(r(e.expr)),e.stmtKind!=f.SK.Expr)||!e.expr.isPure());var e,a=p.toDictionary(this.body.filter(e=>e.stmtKind==f.SK.Label),e=>e.lblName);for(let e=0;e<this.body.length;++e)this.body[e].stmtNo=e;for(e of this.body)switch(e.expr&&(e.expr=s(e.expr)),e.stmtKind){case f.SK.Expr:break;case f.SK.Jmp:e.lbl=p.lookup(a,e.lblName),e.lbl||m.oops("missing label: "+e.lblName),e.lbl.lblNumUses?e.lbl.lblNumUses++:e.lbl.lblNumUses=1;break;case f.SK.StackEmpty:case f.SK.Label:case f.SK.Breakpoint:case f.SK.Comment:break;default:m.oops()}var o;let l=null,c=!m.target.debugMode,u=null;for(o of this.body)o.expr&&(o.expr=t(i(o.expr))),l&&l.lbl==o&&l.stmtKind==f.SK.Jmp&&o.stmtKind==f.SK.Label&&l.jmpMode==f.JmpMode.Always&&1==o.lblNumUses&&(o.lblNumUses=f.lblNumUsesJmpNext),(l=o).stmtKind==f.SK.Breakpoint?(o.breakpointInfo.id,o.breakpointInfo):c&&(o.stmtKind==f.SK.Jmp?o.expr&&(u?c=!1:u=o.expr):o.stmtKind==f.SK.StackEmpty||o.stmtKind==f.SK.Label&&o.lblNumUses==f.lblNumUsesJmpNext||(c=!1));c&&u&&function r(n){var e=()=>{if(!n.args)return 0;let e=0;for(var t of n.args)e+=r(t);return n.mask&&n.mask.conversions&&(e+=4*n.mask.conversions.length),e};switch(n.exprKind){case d.NumberLiteral:return 2;case d.PointerLiteral:return 6;case d.RuntimeCall:return e()+2+2+4;case d.CellRef:return 2;case d.FieldAccess:return e()+(n.data.needsCheck?4:0)+2;case d.ProcCall:case d.SharedRef:case d.SharedDef:case d.Store:case d.Sequence:case d.JmpValue:case d.Nop:case d.InstanceOf:return 1e6;default:throw p.oops()}}(u)<=4*this.args.length+4+2+(m.target.isNative?4:30)&&(this.inlineBody=u),pxt.options.debug&&pxt.debug(this.toString())}}function a(e,t){return new b(e,t)}function o(e,t,r){return new g(e,t,r)}function l(e,t){e=o(d.PointerLiteral,null,e);return e.jsInfo=t,e}function c(e,t,r=0){t=o(d.RuntimeCall,t,e);return r&&(t.mask={refMask:r}),t}function u(e,t=!1,r=!1){let n=!!t&&e.some(e=>e.canUpdateCells()),s=[];for(var i of p.reversed(e))i.isStateless()||i.exprKind==d.CellRef&&!n||(i.canUpdateCells()&&(n=!0),s.push(i));s.reverse(),m.isStackMachine()&&!r&&(s=[]);let a=[];t=e.map(r=>{if(0<=s.indexOf(r)){let e=r,t=r;return r.exprKind==d.SharedDef?(r.args[0].totalUses++,e=f.op(d.SharedRef,[r.args[0]])):(e=f.op(d.SharedRef,[r]),t=f.op(d.SharedDef,[r]),r.totalUses=2,r.currUses=0),a.push(t),e}return r});return{precomp:a,flattened:t}}f.Procedure=k,f.iterExpr=function e(t,r){if(r(t),t.args)for(var n of t.args)e(n,r)},f.stmt=a,f.comment=function(e){return a(s.Comment,l(e,e))},f.op=o,f.numlit=function(e){return o(d.NumberLiteral,null,e)},f.shared=function(e){switch(e.exprKind){case d.SharedRef:e=e.args[0];break;case d.NumberLiteral:return e}return o(d.SharedRef,[e])},f.ptrlit=l,f.rtcall=c,f.rtcallMask=function(e,t,r,n){return p.startsWith(e,"@nomask@")&&(e=e.slice(8),t=0),(e=c(e,n,t)).callingConvention=r,e},f.flattenArgs=u}})(ts=ts||{}),(Mt=>{var e;{var Dt=Mt.pxtc||(Mt.pxtc={});class i{constructor(e,t){this.wave=e,this.id=t,this.flags=0,this.resetAll()}refresh(){this.flags&=-9,this.proc&&!this.usedActions&&!Xt(this.proc.action)||this.proc&&!this.proc.cachedJS?this.resetEmit():this.usedNodes&&(this.flags|=32),this.classInfo&&this.classInfo.reset()}resetEmit(){this.flags&=-41,this.proc&&this.proc.classInfo&&this.proc.classInfo.ctor==this.proc&&(this.proc.classInfo.ctor=null),this.functionInfo=null,this.variableInfo=null,this.classInfo=null,this.callInfo=null,this.proc=null,this.cell=null,this.exprInfo=null,this.usedNodes=null,this.usedActions=null}resetTSC(){this.flags&=16,this.typeCache=null,this.symbolCache=null,this.commentAttrs=null,this.valueOverride=null,this.declCache=void 0,this.fullName=null,this.constantFolded=void 0}resetAll(){this.resetTSC(),this.resetEmit()}}Dt.PxtNode=i;let n,_t=((e=n=n||{})[e.Enum=0]="Enum",e[e.Number=1]="Number",e[e.String=2]="String",e[e.Boolean=3]="Boolean",e[e.Unsupported=4]="Unsupported",Dt.taggedUndefined=0,Dt.taggedNull=6,Dt.taggedFalse=10,Dt.taggedNaN=14,Dt.taggedTrue=66,Dt.thumbArithmeticInstr={adds:!0,subs:!0,muls:!0,ands:!0,orrs:!0,eors:!0,lsls:!0,asrs:!0,lsrs:!0},Dt.numberArithmeticInstr={div:!0,mod:!0,le:!0,lt:!0,ge:!0,gt:!0,eq:!0,neq:!0},{"Array_::getAt":{name:"_pxt_array_get",argsFmt:["T","T","T"],value:0},"Array_::setAt":{name:"_pxt_array_set",argsFmt:["T","T","T","T"],value:0},"BufferMethods::getByte":{name:"_pxt_buffer_get",argsFmt:["T","T","T"],value:0},"BufferMethods::setByte":{name:"_pxt_buffer_set",argsFmt:["T","T","T","I"],value:0},"pxtrt::mapGetGeneric":{name:"_pxt_map_get",argsFmt:["T","T","S"],value:0},"pxtrt::mapSetGeneric":{name:"_pxt_map_set",argsFmt:["T","T","S","T"],value:0}}),Kt=Dt.ir.EK,r=(Dt.SK=Mt.SyntaxKind,0),$t=Dt.numReservedGlobals=1;function Bt(e){return e.pxt?!!(16&e.pxt.flags):!!(e=Mt.getSourceFileOfNode(e))&&Dt.isPxtModulesFilename(e.fileName)}function Rt(e){var t;return e.pxt?((t=e.pxt).wave!=$t&&(t.wave=$t,Dt.compileOptions&&Dt.compileOptions.skipPxtModulesTSC&&16&t.flags?Dt.compileOptions.skipPxtModulesEmit?t.refresh():t.resetEmit():t.resetAll()),t):(t=new i($t,++r),Bt(e)&&(t.flags|=16),e.pxt=t)}function jt(e){return Rt(e).id}function qt(e){return e?Mt.SyntaxKind[e.kind]:"<null>"}function zt(e,t,r=!1){var n=new Error(t);if(n.ksEmitterUserError=!0,n.ksErrorCode=e,r&&Ot)return Lt||(Lt=t,Ft=e),n;throw n}function Vt(){return Dt.target.isNative&&Dt.target.nativeType==Dt.NATIVE_TYPE_VM}function Gt(){return Dt.target.isNative&&Dt.target.nativeType!=Dt.NATIVE_TYPE_VM}function Ht(){return Dt.target.isNative&&Dt.target.nativeType==Dt.NATIVE_TYPE_THUMB}function gr(e){return Gt()?Dt.ir.rtcall("pxt::fromInt",[e]):e}function br(e){return Gt()?Dt.ir.rtcall("pxt::fromBool",[e]):e}function Jt(e){switch(e){case 0:return Dt.target.shortPointers?2:4;case 1:return 1;case 3:return 2;case 5:return 4;case 2:return 1;case 4:return 2;case 6:return 4;default:throw Dt.oops()}}function a(e){switch(e){case 1:case 3:case 5:return!0;case 2:case 4:case 6:return!1;default:throw Dt.oops()}}function Qt(e){switch(e.kind){case Dt.SK.TemplateHead:case Dt.SK.TemplateMiddle:case Dt.SK.TemplateTail:case Dt.SK.StringLiteral:case Dt.SK.NoSubstitutionTemplateLiteral:return!0;default:return!1}}function Wt(e){return e&&e.modifiers&&e.modifiers.some(e=>e.kind==Dt.SK.StaticKeyword)}function xr(e){return e.modifiers&&e.modifiers.some(e=>e.kind==Dt.SK.ReadonlyKeyword)}function yr(e,t){return!e.explicitDefaults||e.explicitDefaults.indexOf(t)<0?null:e.paramDefl[t]}function o(e){if(!e)return null;switch(e.kind){case Dt.SK.MethodDeclaration:return"";case Dt.SK.Constructor:return"new/";case Dt.SK.GetAccessor:return"get/";case Dt.SK.SetAccessor:return"set/";default:return null}}function Yt(e){return o(e)+ir(e)}function Zt(e){return null!=o(e)}function Xt(e){let t=e,r=!1;for(;;)switch((t=t.parent)||zt(9229,Ct("cannot determine parent of {0}",qt(e))),t.kind){case Dt.SK.MethodDeclaration:case Dt.SK.Constructor:case Dt.SK.GetAccessor:case Dt.SK.SetAccessor:case Dt.SK.FunctionDeclaration:case Dt.SK.ArrowFunction:case Dt.SK.FunctionExpression:return t;case Dt.SK.WhileStatement:case Dt.SK.DoStatement:case Dt.SK.ForInStatement:case Dt.SK.ForOfStatement:case Dt.SK.ForStatement:r=!0;break;case Dt.SK.SourceFile:return r?Pt:null}}function t(e){return"objectFlags"in e}function er(e){return!!e&&(e.kind==Dt.SK.VariableDeclaration||e.kind==Dt.SK.BindingElement&&er(e.parent.parent))}function tr(e){return!!e&&(er(e)&&!Xt(e)||e.kind==Dt.SK.PropertyDeclaration&&Wt(e))}function rr(e){return!!e&&(e.kind==Dt.SK.Parameter||e.kind==Dt.SK.BindingElement&&rr(e.parent.parent))}Dt.isInPxtModules=Bt,Dt.pxtInfo=Rt,Dt.getNodeId=jt,Dt.stringKind=qt,Dt.isStackMachine=Vt,Dt.needsNumberConversions=Gt,Dt.isThumb=Ht,Dt.sizeOfBitSize=Jt,Dt.isBitSizeSigned=a,Dt.setCellProps=function(e){var t;e._isLocal=er(t=e.def)&&!tr(t)||rr(e.def),e._isGlobal=tr(e.def),e.def.isThisParameter||((t=cr(e.def)).flags&Mt.TypeFlags.Void&&Dt.oops("void-typed variable, "+e.toString()),e.bitSize=(e=>{if(!e||!e.type)return 0;if(!Er(cr(e)))return 0;if(e.type.kind!=Dt.SK.TypeReference)return 0;switch(e.type.typeName.getText()){case"int8":return 1;case"int16":return 3;case"int32":return 5;case"uint8":return 2;case"uint16":return 4;case"uint32":return 6;default:return 0}})(e.def),0!=e.bitSize?e._debugType=(a(e.bitSize)?"int":"uint")+8*Jt(e.bitSize):dr(t)?e._debugType="string":t.flags&Mt.TypeFlags.NumberLike&&(e._debugType="number")),e.isLocal()&&0!=e.bitSize&&(e.bitSize=0,zt(9256,Ct("bit sizes are not supported for locals and parameters")))},Dt.isStatic=Wt,Dt.isReadOnly=xr,Dt.getExplicitDefault=yr,Dt.isObjectType=t;class Nr{constructor(e,t){this.id=e,this.decl=t,this.baseClassInfo=null,this.allfields=[],this.methods={},this.attrs=sr(t),this.reset()}reset(){this.vtable=null,this.itable=null}get isUsed(){return!!(8&Rt(this.decl).flags)}allMethods(){var e,t=[];for(e of Object.keys(this.methods))for(var r of this.methods[e])t.push(r);return t}usedMethods(){var e,t=[];for(e of Object.keys(this.methods))for(var r of this.methods[e])8&Rt(r).flags&&t.push(r);return t}}Dt.ClassInfo=Nr;let Ct=Dt.assembler.lf,Ut,Pt,Lt,Ft=0,Ot=0;function nr(e,t){var r=Rt(t);return null==r.fullName&&(r.fullName=Dt.getFullName(e,t.symbol)),r.fullName}function s(e){var t=e=>{let t=Mt.getSourceFileOfNode(e);return t&&(e=Mt.getLeadingCommentRangesOfNode(e,t))?e.map(e=>t.text.slice(e.pos,e.end)).join("\n"):""};return(e=e.kind==Dt.SK.VariableDeclaration?e.parent.parent:e).symbol&&e.symbol.declarations&&1<e.symbol.declarations.length?e.symbol.declarations.map(t).join("\n"):t(e)}function kr(e){let t="";for(var r of e.declarations)t+=s(r);return Dt.parseCommentString(t)}function sr(e){var t,r=e?Rt(e):null;return!r||2&r.flags?Dt.parseCommentString(""):r.commentAttrs||((t=Dt.parseCommentString(s(e)))._name=ir(e),r.commentAttrs=t)}function ir(e){return e.name&&e.name.kind==Dt.SK.Identifier?e.name.text:"???"}function l(e){if(t(e)&&e.objectFlags&Mt.ObjectFlags.Reference&&(e.typeArguments&&e.typeArguments.length))return e.target;return null}function ar(e){return t(e)&&e.objectFlags&Mt.ObjectFlags.Reference&&e.symbol&&"Array"==e.symbol.name}function Sr(e){return!!(t(e)&&(e.objectFlags&Mt.ObjectFlags.Interface||e.objectFlags&Mt.ObjectFlags.Anonymous))}function or(e){return!!e.isThisType||!!t(e)&&!!(e.objectFlags&Mt.ObjectFlags.Class||e.symbol&&e.symbol.flags&Mt.SymbolFlags.Class)}function lr(e){var t=l(e);return or(t||e)}function vr(e){return ar(e)?e.typeArguments[0]:Ut.getIndexTypeOfType(e,Mt.IndexKind.Number)}function c(e){return e}function Tr(e){return null===e?Dt.taggedNull:void 0===e?Dt.taggedUndefined:!1===e?Dt.taggedFalse:!0===e?Dt.taggedTrue:isNaN(e)?Dt.taggedNaN:null}function cr(e){let t;var r=Rt(e);if(r.typeCache)return r.typeCache;if(!(t=Mt.isExpression(e)?Ut.getContextualType(e):t))try{t=Ut.getTypeAtLocation(e)}catch(e){zt(9203,Ct("Unknown type for expression"))}return t&&(r.typeCache=t),t}function u(e){if(!(e.flags&Mt.TypeFlags.Union))return n.Unsupported;let t=!0,r;return e.types.forEach(e=>{if(void 0===r)e.flags&Mt.TypeFlags.NumberLike?r=n.Number:e.flags&Mt.TypeFlags.BooleanLike?r=n.Boolean:e.flags&Mt.TypeFlags.StringLike?r=n.String:e.flags&Mt.TypeFlags.EnumLike&&(r=n.Enum);else switch(r){case n.Number:t=t&&!!(e.flags&Mt.TypeFlags.NumberLike);break;case n.Boolean:t=t&&!!(e.flags&Mt.TypeFlags.BooleanLike);break;case n.String:t=t&&!!(e.flags&Mt.TypeFlags.StringLike);break;case n.Enum:t=t&&!!(e.flags&Mt.TypeFlags.EnumLike)}}),t?r:n.Unsupported}function ur(e){e=Ut.getSignatureFromDeclaration(e);return!(Ut.getReturnTypeOfSignature(e).flags&Mt.TypeFlags.Void)}function p(e){return e&&e.name}function pr(t){let e=p(t)?t.name.text:null;if(!e){if(t.kind!=Dt.SK.Constructor){for(let e=t.parent;e;e=e.parent)if(p(e))return pr(e)+".inline";return"inline"}e="constructor"}return function e(t){if(!t)return"";switch(t.kind){case Dt.SK.ModuleBlock:return e(t.parent);case Dt.SK.ClassDeclaration:case Dt.SK.ModuleDeclaration:return e(t.parent)+t.name.text+".";default:return""}}(t.parent)+e}function Ir(e){return pr(e).replace(/[^\w]+/g,"_")}function wr(e){return Ir(e)+"__P"+jt(e)}Dt.getNodeFullName=nr,Dt.getComments=s,Dt.parseCommentsOnSymbol=kr,Dt.parseComments=sr,Dt.getName=ir,Dt.checkType=c,Dt.taggedSpecial=Tr,Dt.getDeclName=pr,Dt.getFunctionLabel=wr;class Ar{constructor(e){this.decl=e,this.capturedVars=[]}get isUsed(){return!!(8&Rt(this.decl).flags)}}function d(e,t,r){return!!(e.flags&t)||u(e)===r}function dr(e){return d(e,Mt.TypeFlags.String|Mt.TypeFlags.StringLiteral,n.String)}function Er(e){return d(e,Mt.TypeFlags.Number|Mt.TypeFlags.NumberLiteral,n.Number)}Dt.FunctionAddInfo=Ar,Dt.compileBinary=function(r,d,x,t){Dt.compilerHooks.preBinary&&Dt.compilerHooks.preBinary(r,d,x),Dt.target=d.target,Dt.compileOptions=d,Dt.target.debugMode=!!d.breakpoints;let o=Mt.createDiagnosticCollection();Ut=r.getTypeChecker();var c,u=Dt.U.cpuUs();let b=[],n=[],R={},a={},j=null,y=null,k=!1,p=[];if($t++,d.target.isNative){if(!d.extinfo||!d.extinfo.hexinfo)return{diagnostics:[{file:r.getSourceFiles()[0],start:0,length:0,category:Dt.DiagnosticCategory.Error,code:9043,messageText:Ct("The hex file is not available, please connect to internet and try again.")}],emittedFiles:[],emitSkipped:!0};let e=d.extinfo,t=d.target;e&&e.disabledDeps&&(s=(d.otherMultiVariants||[]).find(e=>e.extinfo&&!e.extinfo.disabledDeps))&&(pxt.debug(`using alternative extinfo (due to ${e.disabledDeps})`),e=s.extinfo,t=s.target),Dt.hexfile.setupFor(t,e||Dt.emptyExtInfo(),x),Dt.hexfile.setupInlineAssembly(d)}let S=new _r,v;function q(){S.reset(),v=null,x.breakpoints=[{id:0,isDebuggerStmt:!1,fileName:"bogus",start:0,length:0,line:0,column:0}],x.procCallLocations=[]}S.trace=d.trace,S.breakpoints=d.breakpoints,S.name=d.name,S.target=d.target,d.computeUsedSymbols&&(x.usedSymbols={},x.usedArguments={}),d.computeUsedParts&&(x.usedParts=[]);let z=[];if(!d.forceEmit||0==x.diagnostics.length){let e=r.getSourceFiles().slice();var s=e.find(e=>e.fileName===pxt.MAIN_TS),s=(s&&(e=e.filter(e=>e.fileName!==pxt.MAIN_TS)).push(s),e.find(e=>e.fileName===pxt.TUTORIAL_CODE_STOP));s&&(e=e.filter(e=>e.fileName!==pxt.TUTORIAL_CODE_STOP)).push(s),e.forEach(e=>{e.statements.forEach(e=>{z.push(e)})})}s=r.getSourceFiles().filter(e=>Dt.Util.endsWith(e.fileName,t))[0];let e={kind:Dt.SK.FunctionDeclaration,parameters:[],name:{text:"<main>",pos:0,end:0},body:{kind:Dt.SK.Block,statements:z},parent:s,pos:0,end:0},V=Rt(Pt=e);for(V.flags|=3,l(e),b=[],q(),k=!0,Et(e);;){for(v=$(e);0<b.length;)Et(b.pop());if((()=>{k=!1;var e,t=S.usedClassInfos.length;for(e of S.usedClassInfos){for(var r of e.allMethods()){var n=Rt(r),s=I(r);8&n.flags?s.virtualParent&&_(s.virtualParent.decl):(s.virtualParent&&s.virtualParent.isUsed||ue(r)||(e=>null!=Dt.U.lookup(S.explicitlyUsedIfaceMembers,e))(ir(r)))&&_(r)}e=Ue(e.decl);e&&_(e)}return k=!0,0==b.length&&t==S.usedClassInfos.length})())break}{(s=S.globals.slice(0)).forEach((e,t)=>e.index=t);let r=e=>0==e?10:Jt(e),e=(s.sort((e,t)=>r(e.bitSize)-r(t.bitSize)||e.index-t.index),4*Dt.numReservedGlobals),t=0;for(c of s){for(var G=Vt()?0:c.bitSize,H=Jt(G);e&H-1;)e++;t||0!=G||(t=e),c.index=e,e+=H}S.globalsWords=e+3>>2,S.nonPtrGlobals=t?t>>2:S.globalsWords}k=!1;{for(var J of S.usedClassInfos)!function e(i){Dt.assert(i.isUsed,"inf.isUsed");if(i.vtable)return i.vtable;let a=i.baseClassInfo?e(i.baseClassInfo).slice(0):[];i.derivedClasses=[];i.baseClassInfo&&i.baseClassInfo.derivedClasses.push(i);for(var o of i.usedMethods()){S.numMethods++;let s=I(o),e=sr(o);if(ue(o)&&!e.shim&&(i.toStringMethod=$(o),i.toStringMethod.info.usedAsIface=!0),s.virtualParent){S.numVirtMethods++;let t=Yt(o),r=!1,n=$(o);Dt.U.assert(!!n);for(let e=0;e<a.length;++e)Yt(a[e].action)==t&&(a[e]=n,s.virtualIndex=e,r=!0);r||(s.virtualIndex=a.length,a.push(n))}}i.vtable=a;i.itable=[];let r={};for(var n of i.allfields){let e=ir(n),t=Je(i,n,!1);r[e]=!0,i.itable.push({name:e,info:(t.idx+1)*(Vt()?1:4),idx:E(e),proc:null})}for(let e=i;e;e=e.baseClassInfo)for(var l of e.usedMethods()){let s=ir(l),e=sr(l);if(!e.shim){let e=$(l),t=i.itable.find(e=>e.name==s),r=l.kind==Dt.SK.SetAccessor,n=l.kind==Dt.SK.GetAccessor;t?(r&&!t.setProc?t.setProc=e:n&&!t.proc&&(t.proc=e),t.info=0):i.itable.push({name:s,info:0,idx:E(s),proc:r?null:e,setProc:r?e:null}),e.info.usedAsIface=!0}}return i.vtable}(J);let e=Object.keys(S.ifaceMemberMap),t=(e.sort(Dt.U.strcmp),e.unshift(""),S.emitString(""),S.ifaceMembers=e,S.ifaceMemberMap={},0);for(var Q of e)S.ifaceMemberMap[Q]=t++;for(var W of S.usedClassInfos)for(var Y of W.itable)Y.idx=E(Y.name);for(var Z of S.usedClassInfos)Z.lastSubtypeNo=void 0,Z.classNo=void 0;let r=pxt.BuiltInType.User0,n=e=>{Dt.U.assert(!e.classNo),e.classNo=r++;for(var t of e.derivedClasses)t.isUsed&&n(t);e.lastSubtypeNo=r-1};for(var X of S.usedClassInfos){let e=X;for(;e.baseClassInfo;)e=e.baseClassInfo;e.classNo||n(e)}}var ee,te=Dt.U.cpuUs();x.times.pass0=te-u;let re=o.getDiagnostics();q(),k=!1,S.finalPass=!0,B(e),Dt.U.assert(0==b.length),x.configData=[];for(ee of Object.keys(a))a["!"+ee]||x.configData.push({name:ee.replace(/^\!/,""),key:a[ee].key,value:a[ee].value});return x.configData.sort((e,t)=>e.key-t.key),u=Dt.U.cpuUs(),x.times.pass1=u-te,It(e,function(){if(!d.noEmit){S.writeFile=(e,t)=>{x.outfiles[e]=t};for(var e of S.procs)e.cachedJS&&!e.inlineBody||e.resolve();Dt.target.isNative&&(S.procs=S.procs.filter(e=>!(e.inlineBody&&!e.info.usedAsIface&&!e.info.usedAsValue))),d.target.isNative?([...d.otherMultiVariants||[],d].forEach(({extinfo:e})=>{e.yotta&&S.writeFile("yotta.json",JSON.stringify(e.yotta,null,2)),e.codal&&S.writeFile("codal.json",JSON.stringify(e.codal,null,2)),e.platformio&&S.writeFile("platformio.json",JSON.stringify(e.platformio,null,2))}),d.target.nativeType==Dt.NATIVE_TYPE_VM?Dt.vmEmit(S,d,x):Dt.processorEmit(S,d,x)):Dt.jsEmit(S,x),S.writeFile=void 0}}),x.times.passFinal=Dt.U.cpuUs()-u,d.ast&&(te=Dt.U.cpuUs(),Dt.annotate(r,t,Dt.target),x.times.passAnnotate=Dt.U.cpuUs()-te),Dt.compileOptions=null,0==re.length&&(re=o.getDiagnostics()),Dt.compilerHooks.postBinary&&Dt.compilerHooks.postBinary(r,d,x),{diagnostics:re,emittedFiles:void 0,emitSkipped:!!d.noEmit};function ne(e,t,r,n,s,i,a){o.add(Mt.createDiagnosticForNode(t,{code:r,message:n,key:n.replace(/^[a-zA-Z]+/g,"_"),category:e},s,i,a))}function se(e,t,r,n,s,i){ne(Dt.DiagnosticCategory.Error,e,t,r,n,s,i)}function T(e,t,r=9202){if(t)return zt(r,t);e||zt(r,Ct("Sorry, this language feature is not supported"));let n=qt(e),s=!1,i=null;switch(e.kind){case Mt.SyntaxKind.ForInStatement:n=Ct("for in loops");break;case Mt.SyntaxKind.ForOfStatement:n=Ct("for of loops"),s=!0;break;case Mt.SyntaxKind.PropertyAccessExpression:n=Ct("property access");break;case Mt.SyntaxKind.DeleteExpression:n=Ct("delete");break;case Mt.SyntaxKind.GetAccessor:n=Ct("get accessor method"),s=!0;break;case Mt.SyntaxKind.SetAccessor:n=Ct("set accessor method"),s=!0;break;case Mt.SyntaxKind.TaggedTemplateExpression:n=Ct("tagged templates");break;case Mt.SyntaxKind.SpreadElement:n=Ct("spread");break;case Mt.SyntaxKind.TryStatement:case Mt.SyntaxKind.CatchClause:case Mt.SyntaxKind.FinallyKeyword:case Mt.SyntaxKind.ThrowStatement:n=Ct("throwing and catching exceptions");break;case Mt.SyntaxKind.ClassExpression:n=Ct("class expressions"),i=Ct("declare a class as class C {} not let C = class {}")}let a="";return a=s?Ct("{0} not currently supported",n):Ct("{0} not supported",Mt.SyntaxKind[e.kind]),i&&(a+=" - "+i),zt(r,a)}function ie(e){return jt(e)+""}function I(e){var t=Rt(e);return t.functionInfo||(t.functionInfo=new Ar(e)),t.functionInfo}function w(e){e=Rt(e);return e.variableInfo||(e.variableInfo={}),e.variableInfo}function ae(t,e=!1){var r=w(t),n=(e&&(r.written=!0),Xt(t));if(null!=n&&n!=v.action){let e=v.action;for(;e&&e!=n;){var s=I(e);s.capturedVars.indexOf(t)<0&&s.capturedVars.push(t),e=Xt(e)}r.captured=!0}}function E(e,t=!1){return r=S,n=e,s=t,e=k,t=y,hr(r,e,t,e=>{s&&!Dt.U.lookup(e.explicitlyUsedIfaceMembers,n)&&(Dt.U.assert(!e.finalPass),e.explicitlyUsedIfaceMembers[n]=!0);var t=Dt.U.lookup(e.ifaceMemberMap,n);return null!=t?t:(Dt.U.assert(!e.finalPass),e.ifaceMemberMap[n]=-1,e.emitString(n),-1)});var r,n,s}function oe(e){e.flags&Mt.TypeFlags.Void&&zt(9203,Ct("void-typed variables not supported"))}function le(e){var t=Rt(e);oe(cr(e)),t.cell||(t.cell=new Dt.ir.Cell(null,e,w(e))),S.globals.indexOf(t.cell)<0&&S.globals.push(t.cell)}function ce(t){var e;if(tr(t))return l(t),(e=Rt(t)).cell||le(t),e.cell;{let e=v.localIndex(t);return e||(S.finalPass?zt(9204,Ct("cannot locate identifer")):e=v.mkLocal(t,w(t))),e}}function ue(e){return e.kind==Dt.SK.MethodDeclaration&&0==e.parameters.length&&"toString"==ir(e)}function pe(e){if(32&e.flags||16&e.flags&&Dt.compileOptions.skipPxtModulesEmit)throw x.needsFullRecompile=!0,zt(9200,Ct("full recompile required"))}function N(e,t=null){e=Rt(t=t||e.symbol.valueDeclaration);if(!e.classInfo){var s=Ir(t)+"__C"+jt(t);let r=new Nr(s,t);(e.classInfo=r).attrs.autoCreate&&(R[r.attrs.autoCreate]=!0),r.baseClassInfo=(e=>{if(e.heritageClauses)for(var t of e.heritageClauses)switch(t.token){case Dt.SK.ExtendsKeyword:if(!t.types||1!=t.types.length)throw zt(9228,Ct("invalid extends clause"));var r=cr(t.types[0]);if(r&&or(r))return Ut.getTypeAtLocation(e),N(r);throw zt(9228,Ct("cannot inherit from this type"));case Dt.SK.ImplementsKeyword:break;default:throw zt(9228,Ct("invalid heritage clause"))}return null})(t);var i,a,o=r.baseClassInfo?Dt.U.toDictionary(r.baseClassInfo.allfields,e=>ir(e)):{};let n=(e,t=r.baseClassInfo)=>t?t.methods[e]||n(e,t.baseClassInfo):null;for(i of t.members)if(i.kind==Dt.SK.PropertyDeclaration){var l=i,c=(Wt(l)||r.allfields.push(l),ir(l));(n(c)||Dt.U.lookup(o,c))&&se(l,9279,Ct("redefinition of '{0}' as field",c))}else if(i.kind==Dt.SK.Constructor)for(var u of i.parameters)mr(u)&&r.allfields.push(u);else Zt(i)&&((l=I(i)).parentClassInfo=r,l.isUsed&&C(r),c=ir(i),r.methods.hasOwnProperty(c)||(r.methods[c]=[]),r.methods[c].push(i),!(a=Dt.U.lookup(o,c))||64&(a=Rt(a)).flags||(a.flags|=64,8&a.flags&&E(c,!0),pe(a)));if(r.baseClassInfo){r.allfields=r.baseClassInfo.allfields.concat(r.allfields);var p,d=r;for(p of d.allMethods()){let t=null;var m,f,h=Yt(p),g=ir(p);for(let e=d.baseClassInfo;e;e=e.baseClassInfo)if(e.methods.hasOwnProperty(g))for(var b of e.methods[g])Yt(b)==h&&(t=b);t&&(m=I(p),f=I(t),t.parameters.length!=p.parameters.length&&se(p,9255,Ct("the overriding method is currently required to have the same number of arguments as the base one")),(m.virtualParent=f).virtualParent||(pe(Rt(t)),f.virtualParent=f),Dt.assert(f.virtualParent==f,"pinf.virtualParent == pinf"))}}}return e.classInfo}function de(e){return!!e&&!Qt(e)&&(e.kind!==Dt.SK.ArrayLiteralExpression?null==g(e):e.elements.some(de))}function A(e){var t=et(e);if(t)return P(t.val);if(tr(e)&&sr(e).shim)return Ae(e,e,[]);t=ce(e),ae(e),e=t.load();return e}function me(e){sr(e).shim&&zt(9207,Ct("built-in functions cannot be yet used as values; did you forget ()?"));var t=I(e);return fe(t),t.location?t.location.load():(Dt.assert(!S.finalPass||0==t.capturedVars.length,"!bin.finalPass || info.capturedVars.length == 0"),t.usedAsValue=!0,_(e),Fe(e))}function fe(e){void 0===e.usedBeforeDecl?e.usedBeforeDecl=!0:S.finalPass&&e.usedBeforeDecl&&e.capturedVars.length&&Xt(e.decl)&&!e.alreadyEmitted&&zt(9278,Ct("function referenced before all variables it uses are defined"))}function he(e){var t=K(e),r=et(t);if(r)return P(r.val);if(t&&(er(t)||rr(t)))return A(t);if(t&&t.kind==Dt.SK.FunctionDeclaration)return me(t);if("undefined"==e.text)return P(void 0);throw T(e,Ct("Unknown or undeclared identifier"),9235)}function ge(e){e=function e(t){return t?Zt(t)?t:e(t.parent):null}(e),e||zt(9208,Ct("'this' used outside of a method")),e=I(e);return e.thisParameter||Dt.oops("no this"),A(e.thisParameter)}function be(e){let t;var r;return(t=""==e?Dt.ir.rtcall("String_::mkEmpty",[]):(r=e,r=((e,t,r,n)=>hr(e,r,n,e=>e.emitString(t)))(S,r,k,y),Dt.ir.ptrlit(r,JSON.stringify(e)))).isStringLiteral=!0,t}function f(e){var t=Ee(e),r=D(e);return Dt.target.isNative||Qt(e)?h(r,t):h(Dt.ir.rtcallMask("String_::stringConv",1,1,[r]),!0)}function xe(e){let n=0;var t,r=(e,t)=>{var r;return Qt(r=t)&&""==r.text?e:(n++,F("String_::concat",[h(e,!0),f(t)],null))};let s=Rt(f(e.head)).valueOverride;for(t of e.templateSpans)s=r(s=r(s,t.expression),t.literal);return 0==n?F("String_::concat",[h(s,!0),h(Dt.ir.rtcall("String_::mkEmpty",[]),!1)],null):s}function ye(e){e=Mt.getDeclarationOfKind(e.symbol,Dt.SK.GetAccessor);if(null==e)throw zt(9281,Ct("setter currently requires a corresponding getter"));return e}function ke(e){if(e.kind==Dt.SK.Parameter||e.kind==Dt.SK.PropertyDeclaration)return e=Rt(e),Dt.target.switches.slowFields||64&e.flags}function Se(e,t=null){var r=cr(e.expression);let n={callingConvention:0,paramDefl:{}},s=null,i=!1;if(!t&&dr(r)?s="String_::charAt":ar(r)?s=t?"Array_::setAt":"Array_::getAt":Sr(r)&&(n=kr(r.symbol),s=t?n.indexerSet:n.indexerGet),!s&&r.flags&(Mt.TypeFlags.Any|Mt.TypeFlags.StructuredOrTypeVariable)&&(s=t?"pxtrt::mapSetGeneric":"pxtrt::mapGetGeneric",i=!0),s){if(i||it(e.argumentExpression))return r=[e.expression,e.argumentExpression],F(s,r,n,t?[t]:[]);throw T(e,Ct("non-numeric indexer on {0}",s),9238)}throw T(e,Ct("unsupported indexer"),9239)}function ve(e){var t=!(!tr(t=e)||de(t.initializer)&&!sr(t).whenUsed)||(t=e).kind==Dt.SK.FunctionDeclaration&&!Xt(t)||Zt(t)||Mt.isClassDeclaration(e);return!Dt.target.switches.noTreeShake&&(!d.testMode||!t||Bt(e))&&t}function Te(e){return!ve(e)||(e=Rt(e),S.finalPass?8&e.flags:e==y)}function l(e){var t;if(e){var r,n=Rt(e);if(n.classInfo)C(n.classInfo);else{if(d.computeUsedSymbols&&e.symbol&&(x.usedSymbols[nr(Ut,e)]=null),d.computeUsedParts&&null!=(t=n.commentAttrs)&&t.parts)for(r of n.commentAttrs.parts.split(/[ ,]+/g))-1===x.usedParts.indexOf(r)&&x.usedParts.push(r);Vt()&&Zt(e)&&E(ir(e),!0),Ie(e),8&n.flags||(n.flags|=8,ve(e)&&b.push(e))}}}function _(e){l(e)}function Ie(e){k&&(y?y.usedNodes[ie(e)]=e:Dt.U.oops("no using ctx for: "+ir(e)))}function we(e){if(!e)return null;var t=Rt(e);if(void 0!==t.declCache)return t.declCache;t=Ut.getSymbolAtLocation(e);let r;return r=t&&!(r=t.valueDeclaration)&&t.declarations&&(e=t.declarations[0])&&e.kind==Mt.SyntaxKind.ImportEqualsDeclaration&&(t=Ut.getSymbolAtLocation(e.moduleReference))?t.valueDeclaration:r}function K(e){let t=we(e);return l(t),!t&&e&&e.kind==Dt.SK.PropertyAccessExpression&&(e=e,Rt(t={kind:Dt.SK.PropertySignature,symbol:{isBogusSymbol:!0,name:e.name.getText()},name:e.name}).flags|=2),V.declCache=t||null,t}function Ee(e){return e.kind==Dt.SK.NullKeyword||e.kind==Dt.SK.NumericLiteral?!!e.isRefOverride:!Qt(e)}function Ne(e){Dt.assert(e.length<=8,"args.length <= 8");let r=0;return e.forEach((e,t)=>{Ee(e)&&(r|=1<<t)}),r}function Ae(e,t,r,n=null){var s=sr(e),i=!(cr(t).flags&Mt.TypeFlags.Void);let a=n||s.shim;if(0<=a.indexOf("(")){n=/(.*)\((.*)\)$/.exec(a);if(n){r.length&&Dt.U.userError("no arguments expected");var o=[];if(n[2].replace(/\s/g,"")){for(var l of n[2].split(/,/)){let e=parseInt(l);isNaN(e)&&null==(e=null==(e=nt(t,l))?((e,t)=>{let r=rt(e,t,"userconfig");return r=null==r?rt(e,t,"config"):r})(t,l):e)&&Dt.U.userError("invalid argument: "+l+" in "+a),o.push(Dt.ir.numlit(e))}4<o.length&&Dt.U.userError("too many args")}return a=n[1],d.target.isNative&&Dt.hexfile.validateShim(pr(e),a,s,!0,o.map(e=>!0)),Dt.ir.rtcallMask(a,0,s.callingConvention,o)}}return"TD_NOOP"==a?(Dt.assert(!i,"!hasRet"),Dt.target.switches.profile&&"perfCounter"==s.shimArgument&&(r[0]&&r[0].kind==Dt.SK.StringLiteral&&(v.perfCounterName=r[0].text),v.perfCounterName||(v.perfCounterName=v.getFullName())),P(void 0)):"TD_ID"==a||"ENUM_GET"===a?(Dt.assert(1==r.length,"args.length == 1"),D(r[0])):(d.target.shimRenames&&Dt.U.lookup(d.target.shimRenames,a)&&(a=d.target.shimRenames[a]),d.target.isNative&&Dt.hexfile.validateShim(pr(e),a,s,i,r.map(it)),F(a,r,s))}function _e(e,r,n){if(e){var t=e.getParameters(),s=r.length;t.length>r.length&&t.slice(r.length).forEach(t=>{if(t.valueDeclaration&&t.valueDeclaration.kind==Dt.SK.Parameter){t=t.valueDeclaration;if(t.initializer)d.unfetteredInitializers||(e=>{switch(e.kind){case Dt.SK.UndefinedKeyword:case Dt.SK.NullKeyword:case Dt.SK.TrueKeyword:case Dt.SK.FalseKeyword:case Dt.SK.NumericLiteral:return 1;case Dt.SK.PropertyAccessExpression:return D(e).exprKind==Kt.NumberLiteral;default:return}})(t.initializer)||zt(9212,Ct("only numbers, null, true and false supported as default arguments")),r.push(t.initializer);else{t=yr(n,ir(t));let e=t?P(parseInt(t)):null;null==e&&(e=P(void 0)),r.push(h(e))}}else zt(9213,Ct("unsupported default argument (shouldn't happen)"))});for(let e=0;e<s;e++){var i=t[e];i&&i.valueDeclaration&&i.valueDeclaration.kind==Dt.SK.Parameter&&(r[e],i.valueDeclaration)}n.imageLiteral&&(Qt(r[0])||zt(9214,Ct("Only image literals (string literals) supported here; {0}",qt(r[0]))),r[0]=(t=>{t=t||"0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n0 0 0 0 0\n";let r=0,n=0,s=0,i="",a=0;t+="\n";for(let e=0;e<t.length;++e)switch(t[e]){case".":case"_":case"0":i+="0,",r++,a++;break;case"#":case"*":case"1":i+="255,",r++,a++;break;case"\t":case"\r":case" ":break;case"\n":r&&(0==n?n=r:r!=n&&zt(9205,Ct("lines in image literal have to have the same width (got {0} and then {1} pixels)",n,r)),r=0,s++);break;default:zt(9206,Ct("Only 0 . _ (off) and 1 # * (on) are allowed in image literals"))}var e="_img"+S.lblNo++,o=(a%2!=0&&(i+="0"),S.otherLiterals.push(`
.balign 4
${e}: .short 0xffff
        .short ${n}, ${s}
        .byte ${i}
`),"new pxsim.Image("+n+", ["+i+"])");return{kind:Dt.SK.NumericLiteral,imageLiteral:e,jsLit:o}})(r[0].text))}}function i(r,e,n,t,s=null,i=null){var a;s=s||K(e);let o=!1,l=!1,c=!1;var u=r===e;if(s)switch(s.kind){case Dt.SK.PropertySignature:case Dt.SK.PropertyAssignment:case Dt.SK.PropertyDeclaration:case Dt.SK.MethodSignature:o=!0;break;case Dt.SK.Parameter:mr(s)&&(o=!0);break;case Dt.SK.GetAccessor:case Dt.SK.SetAccessor:case Dt.SK.MethodDeclaration:o=!0,l=!0,c=Wt(s);break;case Dt.SK.FunctionDeclaration:c=!0;break;case Dt.SK.ModuleDeclaration:break;default:s=null}else e.kind==Dt.SK.PropertyAccessExpression&&(o=!0);Dt.target.switches.slowMethods&&(l=!1);var p=sr(s);let d=n.slice(0);if((o=o&&Wt(s)?!1:o)&&!i&&e.kind==Dt.SK.PropertyAccessExpression&&(i=e.expression),x.usedArguments&&p.trackArgs){let t=i?[i].concat(d):d;var n=p.trackArgs.map(e=>t[e]).map(e=>{var t=K(e);return!t||t.kind!=Dt.SK.EnumMember&&t.kind!=Dt.SK.VariableDeclaration?e&&e.kind==Dt.SK.StringLiteral?e.text:"*":nr(Ut,t)}).join(","),m=nr(Ut,s);let e=x.usedArguments[m];(e=e||(x.usedArguments[m]=[])).indexOf(n)<0&&e.push(n)}function f(){var e=Ce(s,r,d.map(e=>D(e))),t=e.data;return d[0]&&t.proc&&t.proc.classInfo&&(t.isThis=d[0].kind==Dt.SK.ThisKeyword),e}if((_e(t,d,p),c)&&!I(s).location)return p.shim&&!je(s)?Ae(s,r,d):(_(s),f());if(e.kind==Dt.SK.SuperKeyword){let t=v.classInfo.baseClassInfo.ctor;for(let e=v.classInfo.baseClassInfo;e&&!t;e=e.baseClassInfo)t=e.ctor;if(!t&&S.finalPass)throw zt(9280,Ct("super() call requires an explicit constructor in base class"));m=d.map(e=>D(e));return m.unshift(ge(e)),Ke(t,r,m)}if(o){if(Dt.U.assert(!Wt(s)),i?d.unshift(i):T(r,Ct("strange method call"),9241),!s)return Dt.U.assert(e.kind==Dt.SK.PropertyAccessExpression),n=e.name.text,$e(d.map(e=>D(e)),{ifaceIndex:E(n,!0),callLocationIndex:At(r),noArgs:u});t=I(s);if(t.parentClassInfo&&C(t.parentClassInfo),_(s),i.kind==Dt.SK.SuperKeyword)return f();var h,m=!!t.virtualParent,n=!!Vt()||!!Dt.target.switches.slowMethods;if(m&&!n)return s.kind==Dt.SK.MethodDeclaration?Dt.U.assert(!u):s.kind==Dt.SK.GetAccessor||s.kind==Dt.SK.SetAccessor?Dt.U.assert(u):Dt.U.assert(!1),Dt.U.assert(!S.finalPass||null!=t.virtualIndex,"!bin.finalPass || info.virtualIndex != null"),$e(d.map(e=>D(e)),{classInfo:t.parentClassInfo,virtualIndex:t.virtualIndex,noArgs:u,isThis:d[0].kind==Dt.SK.ThisKeyword});if(p.shim&&!je(s)){let e=void 0;return r.kind===Dt.SK.PropertyAccessExpression&&1<d.length&&(e=p.shim+"_set"),Ae(s,r,d,e)}if(p.helper){let e;for(h of Ut.getSymbolsInScope(r,Mt.SymbolFlags.Module))if("helpers"==h.name)for(var g of h.declarations||[h.valueDeclaration])if(g.kind==Dt.SK.ModuleDeclaration)for(var b of g.body.statements)(null==(a=b.symbol)?void 0:a.name)==p.helper&&(e=b);return e||zt(9215,Ct("helpers.{0} not found",p.helper)),e.kind!=Dt.SK.FunctionDeclaration&&zt(9216,Ct("helpers.{0} isn't a function",p.helper)),_(s=e),f()}return m||Dt.target.switches.slowMethods||!l?$e(d.map(e=>D(e)),{ifaceIndex:E(ir(s),!0),isSet:u&&2==d.length,callLocationIndex:At(r),noArgs:u}):(Dt.U.assert(s.kind!=Dt.SK.MethodSignature),f())}return s&&s.kind==Dt.SK.ModuleDeclaration&&("String"==ir(s)?zt(9219,Ct('to convert X to string use: X + ""')):zt(9220,Ct("namespaces cannot be called directly"))),d.unshift(e),Dt.U.assert(!u),$e(d.map(e=>D(e)),{virtualIndex:-1,callLocationIndex:At(r),noArgs:u})}function Ke(e,t,r){Dt.U.assert(!S.finalPass||!!e);e={proc:e,callLocationIndex:At(t),virtualIndex:null,ifaceIndex:null};return Dt.ir.op(Kt.ProcCall,r,e)}function $e(e,t){return Dt.ir.op(Kt.ProcCall,e,t)}function $(e){return Rt(e).proc}function Ce(e,t,r){var n=$(e);return e.kind==Dt.SK.FunctionDeclaration&&fe(I(e)),Dt.assert(!!n||!S.finalPass,"!!proc || !bin.finalPass"),Ke(n,t,r)}function Ue(e){return e.members.filter(e=>e.kind==Dt.SK.Constructor)[0]}function C(e){Ie(e.decl),e.isUsed||(Rt(e.decl).flags|=8,e.baseClassInfo&&C(e.baseClassInfo),S.usedClassInfos.push(e))}function Pe(o){function u(e){return/^[0-9a-f]$/i.test(e)}var e=K(o.tag);if(!e)throw T(o,Ct("invalid tagged template"),9265);let l=sr(e),t;e={decl:e,qName:e?nr(Ut,e):"?",args:[o.template],isExpression:!0};function r(e){t=((t,n)=>{let e=j;if("_"==n[0]&&"_"==n[1]&&d.jres[n]&&(e=d.jres[n],n=""),""==n&&e){var s=/font\/x-mkcd-b(\d+)/.exec(e.mimeType);if(s)if(S.finalPass){var i=parseInt(s[1]),a=atob(e.data),o=S.usedChars;let t="",r="";if(d.target.isNative)for(let e=0;e<a.length;e+=i){var l=a.charCodeAt(e)+(a.charCodeAt(e+1)<<8);(l<128||o[l>>5]&1<<(31&l))&&(t+=a.slice(e,e+i),r+=l+", ")}else t=a;n=Dt.U.toHex(Dt.U.stringToUint8Array(t))}else n="aabbccdd";else e.dataEncoding&&"base64"!=e.dataEncoding?"hex"==e.dataEncoding?n=e.data:zt(9271,Ct("invalid jres encoding '{0}' on '{1}'",e.dataEncoding,e.id)):n=Dt.U.toHex(Dt.U.stringToUint8Array(Mt.pxtc.decodeBase64(e.data)))}/^e[14]/i.test(n)&&t.parent&&t.parent.kind==Dt.SK.CallExpression&&"image.ofBuffer"==t.parent.expression.getText()&&(n=`870${(s=/^e([14])(..)(..)..(.*)/i.exec(n))[1]}${s[2]}00${s[3]}000000`+s[4]);let r="";for(let e=0;e<n.length;++e){var c=n[e];if(u(c))u(n[e+1])&&(r+=c+n[e+1],e++);else if(!/^[\s\.]$/.test(c))throw T(t,Ct("invalid character in hex literal '{0}'",c),9265)}return Dt.target.isNative?(s=S.emitHexLiteral(r.toLowerCase()),Dt.ir.ptrlit(s,s)):(s="_hex"+ie(t),Dt.ir.ptrlit(s,{hexlit:r.toLowerCase()}))})(o,e(o.template.text))}if(Rt(o).callInfo=e,o.template.kind!=Dt.SK.NoSubstitutionTemplateLiteral)throw T(o,Ct("substitution not supported in hex literal",l.shim),9265);switch(l.shim){case"@hex":r(e=>e);break;case"@f4":r(function(t){if(!Array.isArray(l.groups))throw T(o,Ct("missing groups in @f4 literal"),9272);let r=[],n=[],s={},i=0;l.groups.forEach((e,t)=>{for(var r of e)s[r]=t}),t+="\n";for(let e=0;e<t.length;++e){var a=t[e];switch(a){case" ":case"\t":break;case"\n":0<n.length&&(r.push(n),i=Math.max(n.length,i),n=[]);break;default:let e=Dt.U.lookup(s,a);if(null==e){if(2!=l.groups.length)throw T(o,Ct("invalid character in image literal: '{0}'",e),9273);e=1}n.push(e)}}let e=8;return l.groups.length<=2?e=1:l.groups.length<=16&&(e=4),Dt.f4EncodeImg(i,r.length,e,(e,t)=>r[t][e]||0)});break;default:if(void 0===l.shim&&l.helper){var n=o.template;var s=l;let e,t=Ut.getSymbolsInScope(n,Mt.SymbolFlags.Module),r;for(var i of t)if("helpers"==i.name)for(var a of i.declarations||[i.valueDeclaration])if(a.kind==Dt.SK.ModuleDeclaration)for(var c of a.body.statements)(null==(e=c.symbol)?void 0:e.name)==s.helper&&(r=c);r||zt(9215,Ct("helpers.{0} not found",s.helper)),r.kind!=Dt.SK.FunctionDeclaration&&zt(9216,Ct("helpers.{0} isn't a function",s.helper));var p=r;return _(p),p=Ce(p,n,[be(n.text)]);return}throw T(o,Ct("invalid shim '{0}' on tagged template",l.shim),9265)}return t=l.helper?Dt.ir.rtcall(l.helper,[t]):t}function Le(e){var t,r=e.parameters.slice(0);return!Wt(e)&&Zt(e)&&((t=I(e)).thisParameter||(t.thisParameter={kind:Dt.SK.Parameter,name:{text:"this"},isThisParameter:!0,parent:e}),r.unshift(t.thisParameter)),r}function Fe(e){e=wr(e);return Dt.ir.ptrlit(e+"_Lit",e)}function Oe(){var e=p;if(0<e.length){p=[];for(var t of e){var r=v;try{De(t)}finally{v=r}}}}function Me(e){S.finalPass&&e.functionsToDefine&&Dt.U.pushRange(p,e.functionsToDefine)}function De(r){var e=I(r);let n=null;if(S.finalPass){if(e.alreadyEmitted)return Dt.U.assert(e.usedBeforeDecl),null;e.alreadyEmitted=!0}var t,s,i,a,o=r.kind==Dt.SK.ArrowFunction||r.kind==Dt.SK.FunctionExpression,l=e.capturedVars.slice(0),c=l.map((e,t)=>{t=new Dt.ir.Cell(t,e,w(e));return t.iscap=!0,t}),l=(void 0===e.usedBeforeDecl&&(e.usedBeforeDecl=!1),0<l.length?(Dt.assert(null!=Xt(r),"getEnclosingFunction(node) != null)"),n=Dt.ir.shared(Dt.ir.rtcall("pxt::mkAction",[Dt.ir.numlit(l.length),Fe(r)])),e.usedAsValue=!0,l.forEach((e,t)=>{var r=v.localIndex(e),e=(r||zt(9223,Ct("cannot find captured value: {0}",Ut.symbolToString(e.symbol))),r.loadCore());v.emitExpr(Dt.ir.rtcall("pxtrt::stclo",[n,Dt.ir.numlit(t),e]))}),r.kind==Dt.SK.FunctionDeclaration&&(e.location=v.mkLocal(r,w(r)),v.emitExpr(e.location.storeDirect(n)),n=null)):o&&(n=Fe(r),e.usedAsValue=!0),Dt.assert(!!n==o,"!!lit == isExpression"),$(r)),u=(l?(v=l).reset():(Dt.assert(!S.finalPass,"!bin.finalPass"),o=Rt(r),(l=new Dt.ir.Procedure).isRoot=!!(1&o.flags),l.action=r,l.info=e,(o.proc=l).usingCtx=y,v=l,o=S,t=l,l=k,a=y,hr(o,l,a,e=>e.addProc(t))),v.captured=c,[]);if(r.parent.kind==Dt.SK.ClassDeclaration){o=N(null,r.parent);if(v.classInfo?Dt.assert(v.classInfo==o,"proc.classInfo == classInfo"):v.classInfo=o,r.kind==Dt.SK.Constructor){if(o.baseClassInfo)for(var p of o.baseClassInfo.decl.members)p.kind==Dt.SK.Constructor&&_(p);o.ctor?Dt.assert(o.ctor==v,"classInfo.ctor == proc"):o.ctor=v;for(var d of o.allfields)d.kind!=Dt.SK.PropertyDeclaration||Wt(d)||(d=d).initializer&&u.push(d)}}let m=[],f=[];v.args=Le(r).map((e,t)=>{e.name.kind===Dt.SK.ObjectBindingPattern&&m.push(e),r.kind==Dt.SK.Constructor&&mr(e)&&f.push(e);t=new Dt.ir.Cell(t,e,w(e));return Me(t.info),t.isarg=!0,t}),v.args.forEach(e=>{var t;e.isByRefLocal()&&(t=Dt.ir.shared(Dt.ir.rtcall("pxtrt::mklocRef",[])),v.emitExpr(Dt.ir.rtcall("pxtrt::stlocRef",[t,e.loadCore()],1)),v.emitExpr(e.storeDirect(t)))}),m.forEach(e=>St(e));for(s of f){var h=Je(v.classInfo,U(v.classInfo,ir(s)),!1),h=Dt.ir.op(Kt.FieldAccess,[A(e.thisParameter)],h);v.emitExpr(Dt.ir.op(Kt.Store,[h,A(s)]))}for(i of u){var g=Je(v.classInfo,U(v.classInfo,ir(i)),!1),g=Dt.ir.op(Kt.FieldAccess,[A(e.thisParameter)],g);v.emitExpr(Dt.ir.op(Kt.Store,[g,D(i.initializer)]))}Oe(),r.body.kind==Dt.SK.Block?(B(r.body),!ur(v.action)||(l=v.body[v.body.length-1])&&l.stmtKind==Dt.ir.SK.Jmp&&l.jmpMode==Dt.ir.JmpMode.Always||v.emitJmp(M(r).ret,P(void 0),Dt.ir.JmpMode.Always)):(a=D(r.body),v.emitJmp(M(r).ret,a,Dt.ir.JmpMode.Always)),v.emitLblDirect(M(r).ret),v.stackEmpty();c=v.mkLabel("final");return ur(v.action)?v.emitJmp(c):v.emitJmp(c,P(void 0)),v.emitLbl(c),e.capturedVars.length&&e.usedBeforeDecl&&r.kind==Dt.SK.FunctionDeclaration&&!S.finalPass&&(e.capturedVars.sort((e,t)=>t.pos-e.pos),(o=w(e.capturedVars[0])).functionsToDefine||(o.functionsToDefine=[]),o.functionsToDefine.push(r)),Dt.assert(!S.finalPass||0==b.length,"!bin.finalPass || usedWorkList.length == 0"),n}function Be(e){e=Dt.ir.shared(e);return v.emitExpr(e),e}function Re(){return Be(Dt.ir.op(Kt.JmpValue,[]))}function je(e){return!d.target.isNative&&e.body&&(e.body.kind!=Dt.SK.Block||0<e.body.statements.length)}function qe(t){if(Te(t)&&!(32&Rt(t).flags)){var r=sr(t);if(null!=r.shim){if("@"==r.shim[0])return;if(d.target.isNative&&Dt.hexfile.validateShim(pr(t),r.shim,r,ur(t),Le(t).map(e=>fr(cr(e)))),!je(t))return}if(!Mt.isInAmbientContext(t)&&t.body){let e=null;r=v;try{e=De(t)}finally{v=r}return e}}}function ze(){}function Ve(e){e.needsIRCache=!0,n.push(e)}function Ge(e,t=null){let r=n.length;return e.kind!=Dt.SK.PropertyAccessExpression&&e.kind!=Dt.SK.ElementAccessExpression||Ve(e.expression),t&&Ve(t),n.length==r?ze:()=>{for(let e=r;e<n.length;++e)n[e].cachedIR=null,n[e].needsIRCache=!1;n.splice(r,n.length-r)}}function h(e,t=!1){t={kind:Dt.SK.NullKeyword,isRefOverride:t};return Rt(t).valueOverride=e,t}function He(e,t,r,n=null){var s=Ge(e),n=n?D(n):P(1),i=Dt.ir.shared(D(e)),t=Dt.ir.shared(Ze(t,i,n));return We(e,h(t,!0)),s(),r?i:t}function Je(e,t,r=!0){Wt(t)&&Dt.U.oops("fieldIndex on static field: "+ir(t));var n=sr(t),s=e.allfields.indexOf(t);return s<0&&S.finalPass&&Dt.U.oops("missing field"),{idx:s,name:ir(t),isRef:!0,shimName:n.shim,classInfo:e,needsCheck:r}}function Qe(t){var r=cr(t.expression);if(lr(r)){r=N(r);let e=t.expression.kind==Dt.SK.ThisKeyword;return Dt.target.switches.noThisCheckOpt&&(e=!1),Je(r,U(r,t.name.text),!e)}throw T(t,Ct("bad field access"),9247)}function U(e,t){e=e.allfields.filter(e=>e.name.text==t)[0];return e||zt(9224,Ct("field {0} not found",t)),e}function We(t,n){var e=K(t),r=tr(e);if(t.kind==Dt.SK.Identifier||r)e&&(r||er(e)||rr(e))?(r=ce(e),ae(e,!0),v.emitExpr(r.storeByRef(D(n)))):T(t,Ct("bad target identifier"),9248);else if(t.kind==Dt.SK.PropertyAccessExpression){let e=K(t);if(!e||e.kind!=Dt.SK.GetAccessor&&e.kind!=Dt.SK.SetAccessor)if(e&&(e.kind==Dt.SK.PropertySignature||e.kind==Dt.SK.PropertyAssignment||ke(e)))v.emitExpr(i(t,t,[n],null,e));else for(;;){if(t.kind===Dt.SK.PropertyAccessExpression){var s=Qe(t);if(sr(U(s.classInfo,s.name)).shim){v.emitExpr(i(t,t,[n],null,e));break}}s=D(t);v.emitExpr(Dt.ir.op(Kt.Store,[s,D(n)]));break}else ye(e),(e=Mt.getDeclarationOfKind(e.symbol,Dt.SK.SetAccessor))||T(t,Ct("setter not available"),9253),v.emitExpr(i(t,t,[n],null,e))}else if(t.kind==Dt.SK.ElementAccessExpression)v.emitExpr(Se(t,n));else if(t.kind==Dt.SK.ArrayLiteralExpression)if(n.kind==Dt.SK.ArrayLiteralExpression){let r=n.elements.map(e=>{e=Dt.ir.shared(D(e));return v.emitExpr(e),e});t.elements.forEach((e,t)=>{We(e,h(r[t]))})}else{let r=Dt.ir.shared(D(n));t.elements.forEach((e,t)=>{We(e,h(L("Array_::getAt",[r,Dt.ir.numlit(t)])))})}else T(t,Ct("bad assignment target"),9249)}function Ye(e){if(Ht())switch(e){case"numops::adds":case"numops::subs":case"numops::eors":case"numops::ands":case"numops::orrs":return"@nomask@"+e}return Vt()&&"pxt::switch_eq"===e?"numops::eq":e}function Ze(e,t,r){return L(Ye(e),[t,r])}function Xe(e,t){if(t){var r=t.val;switch(function e(t){if(t.kind==Dt.SK.Identifier)return t.text;if(t.kind==Dt.SK.PropertyAccessExpression){var r=e(t.expression);if(r)return r+"."+t.name.text}return null}(e)){case"Math.floor":return{val:Math.floor(r)};case"Math.ceil":return{val:Math.ceil(r)};case"Math.round":return{val:Math.round(r)}}}return null}function et(e){var t,r,n;return e?(void 0===(t=Rt(e)).constantFolded&&(er(e)&&e.parent.flags&Mt.NodeFlags.Const?e.initializer&&(t.constantFolded=g(e.initializer)):e.kind==Dt.SK.EnumMember?null==(r=(e=>{let t=sr(e).enumval;if(!t){e=Ut.getConstantValue(e);if(null==e)return null;t=e+""}return/^[+-]?\d+$/.test(t)||/^0x[A-Fa-f\d]{2,8}$/.test(t)||d.unfetteredInitializers?t:(Dt.U.userError("enumval only support number literals"),"0")})(n=e))?t.constantFolded=g(n.initializer):d.unfetteredInitializers?t.constantFolded={val:r}:(n=parseInt(r),isNaN(n)||(t.constantFolded={val:n})):e.kind==Dt.SK.PropertyDeclaration&&Wt(e)&&xr(e)&&(t.constantFolded=g(e.initializer))),t.constantFolded):null}function g(e){var t;return e?(void 0===(t=Rt(e)).constantFolded&&(t.constantFolded=null,e=(e=>{if(!e)return null;switch(e.kind){case Dt.SK.PrefixUnaryExpression:var t=e,r=g(t.operand);return((e,t)=>{if(!t)return null;var r=t.val;switch(e){case Dt.SK.PlusToken:return{val:+r};case Dt.SK.MinusToken:return{val:-r};case Dt.SK.TildeToken:return{val:~r};case Dt.SK.ExclamationToken:return{val:!r};default:return null}})(t.operator,r);case Dt.SK.BinaryExpression:t=e,r=g(t.left);return r?(n=g(t.right))?((e,t,r)=>{if(!t||!r)return null;var n=t.val,s=r.val;switch(e){case Dt.SK.PlusToken:return{val:n+s};case Dt.SK.MinusToken:return{val:n-s};case Dt.SK.SlashToken:return{val:n/s};case Dt.SK.PercentToken:return{val:n%s};case Dt.SK.AsteriskToken:return{val:n*s};case Dt.SK.AsteriskAsteriskToken:return{val:n**s};case Dt.SK.AmpersandToken:return{val:n&s};case Dt.SK.BarToken:return{val:n|s};case Dt.SK.CaretToken:return{val:n^s};case Dt.SK.LessThanLessThanToken:return{val:n<<s};case Dt.SK.GreaterThanGreaterThanToken:return{val:n>>s};case Dt.SK.GreaterThanGreaterThanGreaterThanToken:return{val:n>>>s};case Dt.SK.LessThanEqualsToken:return{val:n<=s};case Dt.SK.LessThanToken:return{val:n<s};case Dt.SK.GreaterThanEqualsToken:return{val:s<=n};case Dt.SK.GreaterThanToken:return{val:s<n};case Dt.SK.EqualsEqualsToken:return{val:n==s};case Dt.SK.EqualsEqualsEqualsToken:return{val:n===s};case Dt.SK.ExclamationEqualsEqualsToken:return{val:n!==s};case Dt.SK.ExclamationEqualsToken:return{val:n!=s};case Dt.SK.BarBarToken:return{val:n||s};case Dt.SK.AmpersandAmpersandToken:return{val:n&&s};default:return null}})(t.operatorToken.kind,r,n):null:null;case Dt.SK.NumericLiteral:var n=parseFloat(e.text);return isNaN(n)?null:{val:n};case Dt.SK.NullKeyword:return{val:null};case Dt.SK.TrueKeyword:return{val:!0};case Dt.SK.FalseKeyword:return{val:!1};case Dt.SK.UndefinedKeyword:return{val:void 0};case Dt.SK.CallExpression:return 1==e.arguments.length?Xe(e.expression,g(e.arguments[0])):null;case Dt.SK.PropertyAccessExpression:case Dt.SK.Identifier:return et(we(e));case Dt.SK.AsExpression:return g(e.expression);default:return null}})(e),t.constantFolded=e),t.constantFolded):null}function tt(e){var t=Dt.target.switches.boxDebug;let r=null;if(t)try{Dt.target.switches.boxDebug=!1,r=D(e)}finally{Dt.target.switches.boxDebug=t}else r=D(e);t=st(r);if(void 0===t)throw zt(9267,Ct("a constant number-like expression is required here"));return t}function rt(e,t,r){var n,e=Ut.getSymbolsInScope(e,Mt.SymbolFlags.Module).filter(e=>e.name==r&&!!e.valueDeclaration)[0];if(e)for(var s of e.valueDeclaration.body.statements)if(s.kind==Dt.SK.VariableStatement)for(n of s.declarationList.declarations)if(n.symbol.name==t)return tt(n.initializer);return null}function nt(e,t){var e=Ut.getSymbolsInScope(e,Mt.SymbolFlags.Enum).filter(e=>"DAL"==e.name&&!!e.valueDeclaration)[0];return(e=e&&e.valueDeclaration.members.filter(e=>e.symbol.name==t)[0])?Ut.getConstantValue(e):null}function st(e){if(e.exprKind==Dt.ir.EK.NumberLiteral){var t=e.data;if(d.target.isNative&&!Vt()){if(t==Dt.taggedNull||t==Dt.taggedUndefined||t==Dt.taggedFalse)return 0;if(t==Dt.taggedTrue)return 1;if("number"==typeof t)return t>>1}else if("number"==typeof t)return t}else if(e.exprKind==Dt.ir.EK.RuntimeCall&&2==e.args.length){var r=st(e.args[0]),n=st(e.args[1]);if(void 0===r||void 0===n)return;switch(e.data){case"numops::orrs":return r|n;case"numops::adds":return r+n;default:return void pxt.log(e)}}}function P(e){if(!d.target.isNative||Vt())return Dt.ir.numlit(e);var t=Tr(e);if(null!=t)return Dt.ir.numlit(t);if("number"==typeof e)return t=e,!Dt.target.switches.boxDebug&&(0|t)==t&&-1073741824<=t&&t<=1073741823?Dt.ir.numlit(e<<1|1):(t=S.emitDouble(e),Dt.ir.ptrlit(t,JSON.stringify(e)));throw Dt.U.oops("bad literal: "+e)}function it(e){if(e.kind==Dt.SK.NullKeyword){var t=Rt(e).valueOverride;if(null!=t)return t.exprKind==Kt.NumberLiteral?!d.target.isNative||!!(1&t.data):t.exprKind==Kt.RuntimeCall&&"pxt::ptrOfLiteral"==t.data?t.args[0].exprKind==Kt.PointerLiteral&&!isNaN(parseFloat(t.args[0].jsInfo)):t.exprKind==Kt.PointerLiteral&&!isNaN(parseFloat(t.jsInfo))}return e.kind==Dt.SK.NumericLiteral||fr(cr(e))}function L(e,t){return Dt.ir.rtcallMask(e,(1<<t.length)-1,0,t)}function F(a,e,o,t=null){let l=[],r=Dt.hexfile.lookupFunc(a);Ht()&&(n=Dt.U.lookup(_t,a))&&(r=n,a=n.name),r&&(l=r.argsFmt);let c=Ne(e=t?e.concat(t):e),u=[];var n=e.map((e,t)=>{var r=D(e);if(!Gt())return r;let n=l[t+1];var s,i=it(e);if(n=!n&&a.indexOf("::")<0?i?"I":"_":n){if("_"==n[0]||"T"==n||"N"==n)return(s=(e=>{switch(e){case"_Buffer":return pxt.BuiltInType.BoxedBuffer;case"_Image":return Dt.target.imageRefTag||pxt.BuiltInType.RefImage;case"_Action":return pxt.BuiltInType.RefAction;case"_RefCollection":return pxt.BuiltInType.RefCollection;default:return null}})(n))&&u.push({argIdx:t,method:"_validate",refTag:s,refTagNullable:!!o.argsNullable}),r;if("I"==n)return r.exprKind==Kt.NumberLiteral&&"number"==typeof r.data?Dt.ir.numlit(r.data>>1):(u.push({argIdx:t,method:"pxt::toInt"}),r);if("B"==n)return c&=~(1<<t),O(e,r);if("S"==n)return r.isStringLiteral||(u.push({argIdx:t,method:"_pxt_stringConv",returnsRef:!0}),c|=1<<t),r;if("F"==n||"D"==n)return"D"==n&&Dt.U.oops("double arguments not yet supported"),i||Dt.U.userError("argsFmt=...F/D... but argument not a number in "+a),u.push({argIdx:t,method:"D"==n?"pxt::toDouble":"pxt::toFloat"}),r;throw Dt.U.oops("invalid format specifier: "+n)}throw Dt.U.userError("not enough args for "+a)});let s=Dt.ir.rtcallMask(a,c,o?o.callingConvention:0,n);return s.mask||(s.mask={refMask:0}),s.mask.conversions=u,d.target.isNative&&("I"==(t=l[0])?s=gr(s):"B"==t?s=br(s):"F"==t?s=(e=s,Gt()?Dt.ir.rtcall("pxt::fromFloat",[e]):e):"D"==t&&(Dt.U.oops("double returns not yet supported"),s=(n=s,Gt()?Dt.ir.rtcall("pxt::fromDouble",[n]):n))),s}function m(r){S.numStmts++;var n=Dt.assembler.debug||Dt.target.switches.size||Dt.target.sourceMap;let e=!!d.breakpoints;if(n||e){var s=Mt.getSourceFileOfNode(r);if(d.justMyCode&&Bt(s)&&(e=!1),n||e){let t=r.pos;for(;/^\s$/.exec(s.text[t]);)t++;for(;"/"==s.text[t]&&"/"==s.text[t+1];){for(;s.text[t]&&"\n"!=s.text[t];)t++;t++}var i=Mt.getLineAndCharacterOfPosition(s,t);if(n){let e=r.end;80<e-t&&(e=t+80);var n=s.text.slice(t,e).trim().replace(/\n[^]*/,"...");v.emit(Dt.ir.comment(`${s.fileName.replace(/pxt_modules\//,"")}(${i.line+1},${i.character+1}): `+n))}e&&(n=Mt.getLineAndCharacterOfPosition(s,r.end),r={id:x.breakpoints.length,isDebuggerStmt:r.kind==Dt.SK.DebuggerStatement,fileName:s.fileName,start:t,length:r.end-t,line:i.line,endLine:n.line,column:i.character,endColumn:n.character},x.breakpoints.push(r),(i=Dt.ir.stmt(Dt.ir.SK.Breakpoint,null)).breakpointInfo=r,v.emit(i))}}}function at(e,t){switch(t){case Dt.SK.PlusToken:return"numops::adds";case Dt.SK.MinusToken:return"numops::subs";case Dt.SK.SlashToken:return"numops::div";case Dt.SK.PercentToken:return"numops::mod";case Dt.SK.AsteriskToken:return"numops::muls";case Dt.SK.AsteriskAsteriskToken:return"Math_::pow";case Dt.SK.AmpersandToken:return"numops::ands";case Dt.SK.BarToken:return"numops::orrs";case Dt.SK.CaretToken:return"numops::eors";case Dt.SK.LessThanLessThanToken:return"numops::lsls";case Dt.SK.GreaterThanGreaterThanToken:return"numops::asrs";case Dt.SK.GreaterThanGreaterThanGreaterThanToken:return"numops::lsrs";case Dt.SK.LessThanEqualsToken:return"numops::le";case Dt.SK.LessThanToken:return"numops::lt";case Dt.SK.GreaterThanEqualsToken:return"numops::ge";case Dt.SK.GreaterThanToken:return"numops::gt";case Dt.SK.EqualsEqualsToken:return"numops::eq";case Dt.SK.EqualsEqualsEqualsToken:return"numops::eqq";case Dt.SK.ExclamationEqualsEqualsToken:return"numops::neqq";case Dt.SK.ExclamationEqualsToken:return"numops::neq";default:return null}}function ot(r){if(r.operatorToken.kind==Dt.SK.EqualsToken){var n=r;let e=n.right;n.parent.kind==Dt.SK.ExpressionStatement&&(e=null);var s=Ge(n.left,e),n=(We(n.left,n.right),e?D(e):P(void 0));return s(),n}{s=g(r);if(s)return P(s.val);let e=null,t=null;(r.operatorToken.kind==Dt.SK.PlusToken||r.operatorToken.kind==Dt.SK.PlusEqualsToken)&&(e=cr(r.left),t=cr(r.right),dr(e)||dr(t)&&r.operatorToken.kind==Dt.SK.PlusToken)&&(Rt(r).exprInfo={leftType:Ut.typeToString(e),rightType:Ut.typeToString(t)});var i,a,o,l,c,u,p,d,m;if(r.operatorToken.kind==Dt.SK.CommaToken)return pt(r.left)?D(r.right):(n=dt(r.left),Dt.ir.op(Kt.Sequence,[n,D(r.right)]));switch(r.operatorToken.kind){case Dt.SK.BarBarToken:case Dt.SK.AmpersandAmpersandToken:return a=D((i=r).left),dr(cr(i.left)),o=v.mkLabel("lazy"),a=Dt.ir.shared(a),l=Dt.ir.rtcall("numops::toBool",[a]),c=v.mkLabel("lazySkip"),u=i.operatorToken.kind==Dt.SK.BarBarToken?Dt.ir.JmpMode.IfZero:i.operatorToken.kind==Dt.SK.AmpersandAmpersandToken?Dt.ir.JmpMode.IfNotZero:Dt.U.oops(),v.emitJmp(c,l,u),v.emitJmp(o,a,Dt.ir.JmpMode.Always,a),v.emitLbl(c),v.emitExpr(L("langsupp::ignore",[a])),v.emitJmp(o,D(i.right),Dt.ir.JmpMode.Always),v.emitLbl(o),Re();case Dt.SK.InstanceOfKeyword:return u=cr((l=r).right),(c=lr(u)?K(l.right):null)&&c.kind==Dt.SK.ClassDeclaration||zt(9275,Ct("unsupported instanceof expression")),C(u=N(u,c)),(c=Dt.ir.op(Dt.ir.EK.InstanceOf,[D(l.left)],u)).jsInfo="bool",c}return r.operatorToken.kind==Dt.SK.PlusToken&&(dr(e)||dr(t))?F("String_::concat",[f(r.left),f(r.right)],null):r.operatorToken.kind==Dt.SK.PlusEqualsToken&&dr(e)?(d=Ge(r.left),p=Dt.ir.shared(F("String_::concat",[f(r.left),f(r.right)],null)),We(r.left,h(p)),d(),p):(d=(e=>{switch(e){case Dt.SK.PlusEqualsToken:return Dt.SK.PlusToken;case Dt.SK.MinusEqualsToken:return Dt.SK.MinusToken;case Dt.SK.AsteriskEqualsToken:return Dt.SK.AsteriskToken;case Dt.SK.AsteriskAsteriskEqualsToken:return Dt.SK.AsteriskAsteriskToken;case Dt.SK.SlashEqualsToken:return Dt.SK.SlashToken;case Dt.SK.PercentEqualsToken:return Dt.SK.PercentToken;case Dt.SK.LessThanLessThanEqualsToken:return Dt.SK.LessThanLessThanToken;case Dt.SK.GreaterThanGreaterThanEqualsToken:return Dt.SK.GreaterThanGreaterThanToken;case Dt.SK.GreaterThanGreaterThanGreaterThanEqualsToken:return Dt.SK.GreaterThanGreaterThanGreaterThanToken;case Dt.SK.AmpersandEqualsToken:return Dt.SK.AmpersandToken;case Dt.SK.BarEqualsToken:return Dt.SK.BarToken;case Dt.SK.CaretEqualsToken:return Dt.SK.CaretToken;default:return Dt.SK.Unknown}})(r.operatorToken.kind),(p=at(0,d||r.operatorToken.kind))||T(r.operatorToken,Ct("unsupported operator"),9250),d?He(r.left,p,!1,r.right):(d=Ye(d=p),m=[r.left,r.right],Dt.ir.rtcallMask(d,Ne(m),0,m.map(e=>D(e)))))}}function lt(e){e.statements.forEach(B)}function ct(e){if(!(e.flags&Mt.NodeFlags.Let||e.flags&Mt.NodeFlags.Const))throw zt(9260,Ct("variable needs to be defined using 'let' instead of 'var'"))}function ut(e){if(e.declarationList.flags&Mt.NodeFlags.Const){var r=e.parent&&e.parent.kind==Dt.SK.ModuleBlock?ir(e.parent.parent):"?";if("config"==r||"userconfig"==r)for(var n of e.declarationList.declarations){let t=pr(n);if(n.initializer){var n=tt(n.initializer),s=nt(e,"CFG_"+t);if(null==s||0==s)throw zt(9268,Ct("can't find DAL.CFG_{0}",t));"userconfig"==r&&(t="!"+t);{i=void 0;var i={name:t,key:s,value:n};let e=Dt.U.lookup(a,i.name);if(e||(e=i,a[i.name]=e),e.value!=i.value)throw zt(9269,Ct("conflicting values for config.{0}",i.name))}}}}Mt.isInAmbientContext(e)||(ct(e.declarationList),e.declarationList.declarations.forEach(B))}function O(e,t=null){if(!t&&Ht()&&e.kind==Dt.SK.BinaryExpression){var r=e,n=Dt.U.lookup(Dt.thumbCmpMap,at(0,r.operatorToken.kind));if(n)return Dt.ir.rtcall(n,[D(r.left),D(r.right)])}return t=t||D(e),Vt()?t:Dt.ir.rtcall("numops::toBoolDecr",[t])}function M(e){e=jt(e);return{fortop:".fortop."+e,cont:".cont."+e,brk:".brk."+e,ret:".ret."+e}}function pt(e){if(!e)return 1;switch(e.kind){case Dt.SK.Identifier:case Dt.SK.StringLiteral:case Dt.SK.NumericLiteral:case Dt.SK.NullKeyword:return 1}}function dt(e){return D(e)}function mt(e){pt(e)||(m(e),e=dt(e),v.emitExpr(e),v.stackEmpty())}function ft(r){if(r.initializer&&r.initializer.kind==Dt.SK.VariableDeclarationList){var n=r.initializer;if(1!=n.declarations.length)T(r,"only a single variable may be used to iterate a collection");else{ct(n);var s=cr(r.expression);let e="",t="";if(dr(s))e="String_::charAt",t="String_::length";else{if(!ar(s))return void T(r.expression,"cannot use for...of with this expression");e="Array_::getAt",t="Array_::length"}l(n.declarations[0]);var s=St(n.declarations[0]),n=(Dt.U.assert(!!s||!S.finalPass),v.stackEmpty(),v.mkLocalUnnamed()),i=(v.emitExpr(n.storeByRef(D(r.expression))),v.mkLocalUnnamed()),a=(v.emitExpr(i.storeByRef(P(0))),v.stackEmpty(),m(r),M(r)),o=(v.emitLblDirect(a.fortop),Dt.ir.rtcall(t,[n.loadCore()])),o=Ze("numops::lt_bool",i.load(),gr(o));v.emitJmpZ(a.brk,o);s&&(v.emitExpr(s.storeByRef(Dt.ir.rtcall(e,[n.loadCore(),(o=i.loadCore(),Gt()?Dt.ir.rtcall("pxt::toInt",[o]):o)]))),m(r.initializer)),Oe(),B(r.statement),v.emitLblDirect(a.cont),v.emitExpr(i.storeByRef(Ze("numops::adds",i.load(),P(1)))),v.emitJmp(a.fortop),v.emitLblDirect(a.brk),v.emitExpr(n.storeByRef(P(void 0)))}}else T(r,"only a single variable may be used to iterate a collection")}function ht(e){m(e);let r=e.label?e.label.text:null,n=e.kind==Dt.SK.BreakStatement,s=0;var t,i=function e(t){return t?r&&t.kind==Dt.SK.LabeledStatement&&t.label.text==r?t.statement:t.kind==Dt.SK.SwitchStatement&&!r&&n||!r&&Mt.isIterationStatement(t,!1)?t:(s+=xt(t),e(t.parent)):null}(e);i?(t=M(i),gt(s),e.kind==Dt.SK.ContinueStatement?Mt.isIterationStatement(i,!1)?v.emitJmp(t.cont):se(e,9231,Ct("continue on non-loop")):e.kind==Dt.SK.BreakStatement?v.emitJmp(t.brk):Dt.oops()):se(e,9230,Ct("cannot find outer loop"))}function gt(e=1){for(;e--;)v.emitExpr(L("pxt::endTry",[]))}function bt(){zt(9282,Ct("jumps (return, break, continue) through finally blocks not supported yet"))}function xt(e){let t=0;var r;return e.kind==Mt.SyntaxKind.Block&&e.parent&&(e.parent.kind==Mt.SyntaxKind.CatchClause?e.parent.parent.finallyBlock&&(t++,bt()):e.parent.kind==Mt.SyntaxKind.TryStatement&&(r=e.parent).tryBlock==e&&(r.catchClause&&t++,r.finallyBlock)&&(t++,bt())),t}function yt(e){for(;e;){if((e=>{switch(e.kind){case Dt.SK.WhileStatement:case Dt.SK.ForInStatement:case Dt.SK.ForOfStatement:case Dt.SK.ForStatement:case Dt.SK.DoStatement:return 1;default:return}})(e))return 1;e=e.parent}}function kt(t,r,n){if(t.name.kind===Dt.SK.ObjectBindingPattern||t.name.kind==Dt.SK.ArrayBindingPattern)return r||(r=t.initializer?Dt.ir.shared(D(t.initializer)):A(t),n=cr(t.initializer||t)),t.name.elements.forEach(e=>kt(e,r,n)),v.stackEmpty(),null;if(!Te(t))return null;if(et(t))return null;let e;if(Me((e=tr(t)?(le(t),ce(t)):v.mkLocal(t,w(t))).info),e.isByRefLocal()&&v.emitExpr(e.storeDirect(Dt.ir.rtcall("pxtrt::mklocRef",[]))),oe(cr(t)),t.kind===Dt.SK.BindingElement){m(t);var[s,,]=function t(r,n,s){let i=r.parent.parent;if(i.kind===Dt.SK.BindingElement){let e=t(i,n,s);n=e[0],s=e[1]}{if(r.parent.kind==Dt.SK.ArrayBindingPattern){let e=r.parent.elements.indexOf(r),t=(r.dotDotDotToken&&zt(9203,Ct("spread operator not supported yet")),vr(s,e));return[L("Array_::getAt",[n,Dt.ir.numlit(e)]),t]}{let e=r.propertyName||r.name;return vt(r,n,s,e.text)}}}(t,r,n);v.emitExpr(e.storeByRef(s))}else if(t.initializer){if(m(t),tr(t)){let e=sr(t).jres;e&&("true"==e&&(e=nr(Ut,t)),(s=Dt.U.lookup(d.jres||{},e))?j=s:zt(9270,Ct("resource '{0}' not found in any .jres file",e)))}t.initializer,v.emitExpr(e.storeByRef(D(t.initializer))),j=null,v.stackEmpty()}else yt(t)&&(m(t),v.emitExpr(e.storeByRef(P(void 0))),v.stackEmpty());return e}function St(e){return kt(e,null,null)}function vt(e,t,r,n){var s=Ut.getPropertyOfType(r,n),s=(Dt.U.assert(!!s,"field sym"),Ut.getTypeOfSymbolAtLocation(s,e));let i;return[i=lr(r)?(r=N(r),Dt.ir.op(Kt.FieldAccess,[t],Je(r,U(r,n)))):$e([t],{ifaceIndex:E(n,!0),callLocationIndex:At(e),noArgs:!0}),s]}function Tt(e){S;var t=e,r=e=>{e&&e.kind==Dt.SK.ClassDeclaration&&zt(9261,Ct("Interface with same name as a class not supported"))};if(r(t.symbol.valueDeclaration),t.symbol.declarations&&t.symbol.declarations.forEach(r),t.heritageClauses)for(var n of t.heritageClauses)n.token===Dt.SK.ExtendsKeyword&&or(cr(n.types[0]))&&zt(9262,Ct("Extending a class by an interface not supported."));r=sr(e);r.autoCreate&&(R[r.autoCreate]=!0)}function It(t,e){var r=Lt;Ot++;try{Lt=null;var n=e(t);return Lt&&zt(Ft,Lt),Lt=r,Ot--,n}catch(e){return Ot--,Lt=null,se(t,e.ksErrorCode||9200,e.message),pxt.debug(e.stack),null}}function D(e,t=!0){var r;return t&&e.cachedIR?e.cachedIR:(r=It(e,wt)||P(void 0),t&&e.needsIRCache?(e.cachedIR=Dt.ir.shared(r),e.cachedIR):r)}function wt(e){e=(e=>{switch(e.kind){case Dt.SK.NullKeyword:var t=Rt(e).valueOverride;return t?t:P(null);case Dt.SK.TrueKeyword:return P(!0);case Dt.SK.FalseKeyword:return P(!1);case Dt.SK.TemplateHead:case Dt.SK.TemplateMiddle:case Dt.SK.TemplateTail:case Dt.SK.NumericLiteral:case Dt.SK.StringLiteral:case Dt.SK.NoSubstitutionTemplateLiteral:return(e=>{if(e.kind==Dt.SK.NumericLiteral)return e.imageLiteral?Dt.ir.ptrlit(e.imageLiteral,e.jsLit):P(parseFloat(e.text));if(Qt(e))return be(e.text);throw Dt.oops()})(e);case Dt.SK.TaggedTemplateExpression:return Pe(e);case Dt.SK.PropertyAccessExpression:return(e=>{let t=K(e);var r,n=et(t);if(n)return P(n.val);if((t=t.kind==Dt.SK.SetAccessor?ye(t):t).kind==Dt.SK.GetAccessor)return i(e,e,[],null,t);if(t.kind==Dt.SK.EnumMember)throw zt(9210,Ct("Cannot compute enum value"));if(t.kind==Dt.SK.PropertySignature||t.kind==Dt.SK.PropertyAssignment)return i(e,e,[],null,t,e.expression);if(t.kind==Dt.SK.PropertyDeclaration||t.kind==Dt.SK.Parameter)return Wt(t)?A(t):ke(t)?i(e,e,[],null,t,e.expression):sr(r=U((n=Qe(e)).classInfo,n.name)).shim?Ae(r,t,[e.expression]):Dt.ir.op(Kt.FieldAccess,[D(e.expression)],n);if(Zt(t)||t.kind==Dt.SK.MethodSignature)throw zt(9211,Ct("cannot use method as lambda; did you forget '()' ?"));if(t.kind==Dt.SK.FunctionDeclaration)return me(t);if(er(t))return A(t);throw T(e,Ct("Unknown property access for {0}",qt(t)),9237)})(e);case Dt.SK.BinaryExpression:return ot(e);case Dt.SK.PrefixUnaryExpression:return(e=>{var t=g(e);if(t)return P(t.val);switch(e.operator){case Dt.SK.ExclamationToken:return br(Dt.ir.rtcall("Boolean_::bang",[O(e.operand)]));case Dt.SK.PlusPlusToken:return He(e.operand,"numops::adds",!1);case Dt.SK.MinusMinusToken:return He(e.operand,"numops::subs",!1);case Dt.SK.PlusToken:case Dt.SK.MinusToken:var r=D(e.operand),n=st(r);return null!=n?P(-n):e.operator==Dt.SK.MinusToken?Ze("numops::subs",P(0),r):Ze("numops::subs",r,P(0));case Dt.SK.TildeToken:n=D(e.operand),r=st(n);return null!=r?P(~r):L(Ye("numops::bnot"),[n]);default:throw T(e,Ct("unsupported prefix unary operation"),9245)}})(e);case Dt.SK.PostfixUnaryExpression:return(e=>{if(Er(cr(e.operand)))switch(e.operator){case Dt.SK.PlusPlusToken:return He(e.operand,"numops::adds",!0);case Dt.SK.MinusMinusToken:return He(e.operand,"numops::subs",!0)}throw T(e,Ct("unsupported postfix unary operation"),9246)})(e);case Dt.SK.ElementAccessExpression:return Se(e);case Dt.SK.ParenthesizedExpression:return(e=>D(e.expression))(e);case Dt.SK.TypeAssertionExpression:return(e=>(e.expression,D(e.expression)))(e);case Dt.SK.ArrayLiteralExpression:return(e=>{vr(cr(e));var t,r=Dt.ir.shared(Dt.ir.rtcall("Array_::mk",[]));for(t of e.elements){var n=Ee(t)?2:0;v.emitExpr(Dt.ir.rtcall("Array_::push",[r,D(t)],n))}return r})(e);case Dt.SK.NewExpression:return(r=>{if((s=Ut.getTypeAtLocation(r))&&ar(s))throw Dt.oops();if(s&&lr(s)){s=K(r.expression);s.kind!=Dt.SK.ClassDeclaration&&zt(9221,Ct("new expression only supported on class types"));let t;s=N(cr(r),s);for(let e=s;e&&!(t=Ue(e.decl));e=e.baseClassInfo);C(s);var n,s=s.id+"_VT";let e=Dt.ir.rtcall("pxt::mkClassInstance",[Dt.ir.ptrlit(s,s)]);return t?(e=Be(e),l(t),s=(r.arguments||[]).slice(0),n=sr(t),_e(Ut.getResolvedSignature(r),s,n),s=s.map(e=>D(e)),n.shim?Dt.ir.rtcall(n.shim,s):(s.unshift(e),v.emitExpr(Ce(t,r,s)),e)):(r.arguments&&r.arguments.length&&zt(9222,Ct("constructor with arguments not found")),e)}throw T(r,Ct("unknown type for new"),9243)})(e);case Dt.SK.SuperKeyword:case Dt.SK.ThisKeyword:return ge(e);case Dt.SK.CallExpression:return(e=>{var t=Ut.getResolvedSignature(e);return i(e,e.expression,e.arguments,t)})(e);case Dt.SK.FunctionExpression:case Dt.SK.ArrowFunction:return qe(e);case Dt.SK.Identifier:return he(e);case Dt.SK.ConditionalExpression:return(e=>{var t=v.mkLabel("condexprz"),r=v.mkLabel("condexprfin");return v.emitJmp(t,O(e.condition),Dt.ir.JmpMode.IfZero),v.emitJmp(r,D(e.whenTrue),Dt.ir.JmpMode.Always),v.emitLbl(t),v.emitJmp(r,D(e.whenFalse),Dt.ir.JmpMode.Always),v.emitLbl(r),Re()})(e);case Dt.SK.AsExpression:return(e=>(e.expression,D(e.expression)))(e);case Dt.SK.TemplateExpression:return xe(e);case Dt.SK.ObjectLiteralExpression:return(e=>{let s=Dt.ir.shared(Dt.ir.rtcall("pxtrt::mkMap",[]));return e.properties.forEach(e=>{Dt.assert(!e.questionToken);let t,r;if(e.kind==Dt.SK.ShorthandPropertyAssignment){Dt.assert(!e.equalsToken&&!e.objectAssignmentInitializer),t=e.name.text;var n=Ut.getShorthandAssignmentValueSymbol(e),n=n&&n.valueDeclaration&&n.valueDeclaration.name;if(!n||n.kind!=Dt.SK.Identifier)throw T(e);r=he(n)}else{if(e.name.kind==Dt.SK.ComputedPropertyName)return n=e.name.expression,void v.emitExpr(F("pxtrt::mapSetByString",[h(s,!0),n,e.initializer],null));t=e.name.kind==Dt.SK.StringLiteral?e.name.text:e.name.getText(),r=D(e.initializer)}n=Dt.target.isNative?Dt.ir.numlit(E(t)):Dt.ir.ptrlit(null,JSON.stringify(t)),e=[s,n,r];v.emitExpr(Dt.ir.rtcall(Dt.target.isNative?"pxtrt::mapSet":"pxtrt::mapSetByString",e))}),s})(e);case Dt.SK.TypeOfExpression:return(e=>F("pxt::typeOf",[e.expression],null))(e);case Mt.SyntaxKind.DeleteExpression:return(e=>{let t,r;if(e.expression.kind==Dt.SK.PropertyAccessExpression){var n=e.expression;t=n.expression,r=h(be(n.name.text))}else{if(e.expression.kind!=Dt.SK.ElementAccessExpression)throw zt(9276,Ct("expression not supported as argument to 'delete'"));n=e.expression;t=n.expression,r=n.argumentExpression}if(or(e=cr(t)))throw zt(9277,Ct("'delete' not supported on class types"));if(ar(e))throw zt(9277,Ct("'delete' not supported on array"));return F("pxtrt::mapDeleteByString",[t,r],null)})(e);default:return T(e),null}})(e);if(e.isExpr())return e;throw new Error("expecting expression")}function Et(e){var t=Rt(e);if(t.usedNodes){k=!1;for(var r of Dt.U.values(t.usedNodes))l(r);for(var n of t.usedActions)n(S);k=!0}else tr(e)||Mt.isClassDeclaration(e)?(k=!1,(y=t).usedNodes=null,y.usedActions=null,tr(e)&&!et(e)&&le(e),B(e),k=!0):((y=t).usedNodes={},y.usedActions=[],B(e),y=null)}function B(e){It(e,Nt)}function Nt(n){switch(n.kind){case Dt.SK.SourceFile:return void n.statements.forEach(B);case Dt.SK.InterfaceDeclaration:return Tt(n);case Dt.SK.VariableStatement:return ut(n);case Dt.SK.ModuleDeclaration:return void B(n.body);case Dt.SK.EnumDeclaration:return;case Dt.SK.FunctionDeclaration:case Dt.SK.Constructor:case Dt.SK.MethodDeclaration:return void qe(n);case Dt.SK.ExpressionStatement:return void mt(n.expression);case Dt.SK.Block:case Dt.SK.ModuleBlock:return lt(n);case Dt.SK.VariableDeclaration:return St(n),void Oe();case Dt.SK.IfStatement:return m(u=n),p=v.mkLabel("else"),v.emitJmpZ(p,O(u.expression)),B(u.thenStatement),d=v.mkLabel("afterif"),v.emitJmp(d),v.emitLbl(p),u.elseStatement&&B(u.elseStatement),void v.emitLbl(d);case Dt.SK.WhileStatement:return m(p=n),u=M(p),v.emitLblDirect(u.cont),m(p.expression),v.emitJmpZ(u.brk,O(p.expression)),B(p.statement),v.emitJmp(u.cont),void v.emitLblDirect(u.brk);case Dt.SK.DoStatement:return m(d=n),c=M(d),v.emitLblDirect(c.cont),B(d.statement),m(d.expression),v.emitJmpZ(c.brk,O(d.expression)),v.emitJmp(c.cont),void v.emitLblDirect(c.brk);case Dt.SK.ForStatement:return(c=n).initializer&&c.initializer.kind==Dt.SK.VariableDeclarationList?(ct(c.initializer),c.initializer.declarations.forEach(B)):mt(c.initializer),m(c),l=M(c),v.emitLblDirect(l.fortop),c.condition&&(m(c.condition),v.emitJmpZ(l.brk,O(c.condition))),B(c.statement),v.emitLblDirect(l.cont),mt(c.incrementor),v.emitJmp(l.fortop),void v.emitLblDirect(l.brk);case Dt.SK.ForOfStatement:return ft(n);case Dt.SK.ContinueStatement:case Dt.SK.BreakStatement:return ht(n);case Dt.SK.LabeledStatement:return o=M((l=n).statement),B(l.statement),void v.emitLblDirect(o.brk);case Dt.SK.ReturnStatement:{o=n;m(o);let e=null,t=(o.expression?e=D(o.expression):ur(v.action)&&(e=P(void 0)),0);for(let e=o;e&&e!=v.action;e=e.parent)t+=xt(e);gt(t),v.emitJmp(M(v.action).ret,e,Dt.ir.JmpMode.Always);return}case Dt.SK.ClassDeclaration:return(i=N(null,a=n)).isUsed&&S.usedClassInfos.indexOf(i)<0&&S.usedClassInfos.push(i),void a.members.forEach(B);case Dt.SK.PropertyDeclaration:case Dt.SK.PropertyAssignment:return void(Wt(i=n)?St(i):i.initializer&&(i=N(cr(i.parent)),S.finalPass)&&i.isUsed&&!i.ctor&&zt(9209,Ct("class field initializers currently require an explicit constructor")));case Dt.SK.SwitchStatement:{a=n;m(a);var e=M(a);let s,i=Dt.ir.shared(D(a.expression)),r=a.caseBlock.clauses.map(e=>{var t,r,n=v.mkLabel("switch");return e.kind==Dt.SK.CaseClause?(t=D((r=e).expression),r=Ee(r.expression)?1:0,r=Dt.ir.rtcallMask(Ye("pxt::switch_eq"),r,0,[t,i]),v.emitJmp(n,r,Dt.ir.JmpMode.IfNotZero,i)):e.kind==Dt.SK.DefaultClause?(Dt.assert(!s,"!defaultLabel"),s=n):Dt.oops(),n});s?v.emitJmp(s,i):v.emitJmp(e.brk,i),a.caseBlock.clauses.forEach((e,t)=>{v.emitLbl(r[t]),e.statements.forEach(B)}),v.emitLblDirect(e.brk);return}case Dt.SK.TypeAliasDeclaration:return;case Mt.SyntaxKind.TryStatement:return e=e=>L("pxt::beginTry",[Dt.ir.ptrlit(e.lblName,e)]),m(t=n),(r=v.mkLabel("catch")).lblName="_catch_"+jt(t),(s=v.mkLabel("finally")).lblName="_finally_"+jt(t),t.finallyBlock&&v.emitExpr(e(s)),t.catchClause&&v.emitExpr(e(r)),v.stackEmpty(),lt(t.tryBlock),v.stackEmpty(),t.catchClause&&(e=v.mkLabel("catchend"),gt(),v.emitJmp(e),v.emitLbl(r),(r=t.catchClause.variableDeclaration)&&(St(r),r=ce(r),v.emitExpr(r.storeByRef(L("pxt::getThrownValue",[])))),Oe(),lt(t.catchClause.block),v.emitLbl(e)),void(t.finallyBlock&&(gt(),v.emitLbl(s),lt(t.finallyBlock),v.emitExpr(L("pxt::endFinally",[]))));case Mt.SyntaxKind.ThrowStatement:return m(r=n),void v.emitExpr(L("pxt::throwValue",[D(r.expression)]));case Dt.SK.DebuggerStatement:return void m(n);case Dt.SK.GetAccessor:case Dt.SK.SetAccessor:return void qe(n);case Dt.SK.ImportEqualsDeclaration:case Dt.SK.EmptyStatement:case Dt.SK.SemicolonClassElement:return;default:T(n)}var t,r,s,a,i,o,l,c,u,p,d}function At(e){return x.procCallLocations.push(Dt.nodeLocationInfo(e))-1}},Dt.isStringType=dr;class _r{constructor(){this.procs=[],this.globals=[],this.finalPass=!1,this.writeFile=(e,t)=>{},this.usedClassInfos=[],this.numStmts=1,this.commSize=0,this.itEntries=0,this.itFullEntries=0,this.numMethods=0,this.numVirtMethods=0,this.usedChars=new Uint32Array(2048),this.explicitlyUsedIfaceMembers={},this.ifaceMemberMap={},this.strings={},this.hexlits={},this.doubles={},this.otherLiterals=[],this.codeHelpers={},this.lblNo=0}reset(){this.lblNo=0,this.otherLiterals=[],this.strings={},this.hexlits={},this.doubles={},this.numStmts=0}getTitle(){var e=this.name||Dt.U.lf("Untitled");return 90<=e.length?e.slice(0,87)+"...":e}addProc(e){Dt.assert(!this.finalPass,"!this.finalPass"),this.procs.push(e),e.seqNo=this.procs.length}recordHelper(e,t,r){var n=e=>{e.codeHelpers[t]||(e.codeHelpers[t]=r(e))};n(this),this.recordAction(e,n)}recordAction(e,t){e?e.usedActions&&e.usedActions.push(t):Dt.U.oops("no using ctx!")}emitLabelled(e,t,r){var n=Dt.U.lookup(t,e);return null!=n?n:(n=r+this.lblNo++,t[e]=n)}emitDouble(e){return this.emitLabelled(Dt.target.switches.numFloat?(t=e,(r=new Float32Array(1))[0]=t,Dt.U.toHex(new Uint8Array(r.buffer))):(t=e,(r=new Float64Array(1))[0]=t,Dt.U.toHex(new Uint8Array(r.buffer))),this.doubles,"_dbl");var t,r}emitString(t){if(!this.finalPass)for(let e=0;e<t.length;++e){var r=t.charCodeAt(e);128<=r&&(this.usedChars[r>>5]|=1<<(31&r))}return this.emitLabelled(t,this.strings,"_str")}emitHexLiteral(e){return this.emitLabelled(e,this.hexlits,"_hexlit")}setPerfCounters(e){if(!Dt.target.switches.profile)return[];let t=e.slice();return this.procs.forEach(e=>{e.perfCounterName&&(Dt.U.assert(Dt.target.switches.profile),e.perfCounterNo=t.length,t.push(e.perfCounterName))}),t}}function mr(e){if(e.modifiers&&e.parent.kind==Dt.SK.Constructor)for(var t of e.modifiers)if(t.kind==Dt.SK.PrivateKeyword||t.kind==Dt.SK.PublicKeyword||t.kind==Dt.SK.ProtectedKeyword)return!0;return!1}function fr(e){return e.flags&Mt.TypeFlags.Union?e.types.every(e=>fr(e)):!!(e.flags&(Mt.TypeFlags.NumberLike|Mt.TypeFlags.EnumLike|Mt.TypeFlags.BooleanLike))}function hr(e,t,r,n){var s=n(e);return t&&e.recordAction(r,n),s}Dt.Binary=_r,Dt.isCtorField=mr}})(ts=ts||{}),!function(ts){var pxtc;!function(pxtc){function getTsCompilerOptions(e){var t=ts.getDefaultCompilerOptions();return t.target=ts.ScriptTarget.ES5,t.module=ts.ModuleKind.None,t.noImplicitAny=!0,t.noImplicitReturns=!0,t.allowUnreachableCode=!0,Object.assign(Object.assign({},t),null==e?void 0:e.tsCompileOptions)}function nodeLocationInfo(e){var t=ts.getSourceFileOfNode(e),r=e.getStart?e.getStart():e.pos,{line:n,character:s}=ts.getLineAndCharacterOfPosition(t,r),{line:i,character:a}=ts.getLineAndCharacterOfPosition(t,e.end);return{start:r,length:e.end-r,line:n,column:s,endLine:i,endColumn:a,fileName:t.fileName}}function patchUpDiagnostics(e,t=!1){t=(e=t?e.filter(e=>5012!==e.code):e).filter(e=>1148==e.code);return(e=0<t.length?t:e).map(e=>{var t;return e.file?(t=ts.getLineAndCharacterOfPosition(e.file,e.start),1148==(t={code:e.code,start:e.start,length:e.length,line:t.line,column:t.character,messageText:ts.flattenDiagnosticMessageText(e.messageText,"\n"),category:e.category,fileName:e.file.fileName}).code&&(t.messageText=pxtc.Util.lf("all symbols in top-level scope are always exported; please use a namespace if you want to export only some")),t):{code:e.code,start:e.start,length:e.length,line:0,column:0,messageText:ts.flattenDiagnosticMessageText(e.messageText,"\n"),category:e.category,fileName:"?"}})}function py2tsIfNecessary(e){if(e.target.preferredEditor==pxt.PYTHON_PROJECT_NAME)return pxtc.transpile.pyToTs(e)}function mkCompileResult(){return{outfiles:{},diagnostics:[],success:!1,times:{}}}function storeGeneratedFiles(e,t){for(var r of e.generatedFiles||[])t.outfiles[r]=e.fileSystem[r]}function runConversionsAndStoreResults(e,t){var r=pxtc.U.cpuUs(),n=(t=t||mkCompileResult(),py2tsIfNecessary(e)),n=(storeGeneratedFiles(e,t=n?Object.assign(Object.assign({},t),{diagnostics:n.diagnostics,sourceMap:n.sourceMap,globalNames:n.globalNames}):t),e.sourceFiles||(e.sourceFiles=Object.keys(e.fileSystem)),e.sourceFiles.indexOf(pxt.MAIN_TS)),n=(0<=n&&(e.sourceFiles.splice(n,1),e.sourceFiles.push(pxt.MAIN_TS)),e.sourceFiles.indexOf(pxt.TUTORIAL_CODE_STOP));return 0<=n&&(e.sourceFiles.splice(n,1),e.sourceFiles.push(pxt.TUTORIAL_CODE_STOP)),t.times.conversions=pxtc.U.cpuUs()-r,t}function timesToMs(e){for(var t of Object.keys(e.times))e.times[t]=Math.round(e.times[t])/1e3}function buildProgram(e,s){let i={};for(var t in e.fileSystem)i[normalizePath(t)]=e.fileSystem[t];var r=getTsCompilerOptions(e),n={getSourceFile:(e,t,r)=>{e=normalizePath(e);let n="";return i.hasOwnProperty(e)?n=i[e]:r&&r("File not found: "+e),null==n&&(r("File not found: "+e),n=""),ts.createSourceFile(e,n,t,!0)},fileExists:e=>(e=normalizePath(e),i.hasOwnProperty(e)),getCanonicalFileName:e=>e,getDefaultLibFileName:()=>"no-default-lib.d.ts",writeFile:(e,t,r,n)=>{s.outfiles[e]=t},getCurrentDirectory:()=>".",useCaseSensitiveFileNames:()=>!0,getNewLine:()=>"\n",readFile:e=>(e=normalizePath(e),i[e]||""),directoryExists:e=>!0,getDirectories:()=>[]},a=e.sourceFiles.filter(e=>pxtc.U.endsWith(e,".ts"));return ts.createProgram(a,r,n)}function isPxtModulesFilename(e){return pxtc.U.startsWith(e,"pxt_modules/")}function compile(opts,service){pxtc.compilerHooks||(pxtc.compilerHooks={},opts.target.compilerExtension&&eval(opts.target.compilerExtension)),pxtc.compilerHooks.init&&pxtc.compilerHooks.init(opts,service);let startTime=pxtc.U.cpuUs(),res=mkCompileResult(),program;if(service)storeGeneratedFiles(opts,res),program=service.getProgram();else{if(runConversionsAndStoreResults(opts,res),0<res.diagnostics.length)return res;program=buildProgram(opts,res)}let entryPoint=opts.sourceFiles.filter(e=>pxtc.U.endsWith(e,".ts")).pop().replace(/.*\//,"");if(res.diagnostics=patchUpDiagnostics(program.getSyntacticDiagnostics(),opts.ignoreFileResolutionErrors),0<res.diagnostics.length)opts.forceEmit&&(pxt.debug("syntactic errors, forcing emit"),pxtc.compileBinary(program,opts,res,entryPoint));else{res.diagnostics=patchUpDiagnostics(program.getOptionsDiagnostics().concat(pxtc.Util.toArray(program.getGlobalDiagnostics())),opts.ignoreFileResolutionErrors);let semStart=pxtc.U.cpuUs(),emitStart=(0==res.diagnostics.length&&(res.diagnostics=patchUpDiagnostics(program.getSemanticDiagnostics(),opts.ignoreFileResolutionErrors)),pxtc.U.cpuUs());if(res.times["typescript-syn"]=semStart-startTime,res.times["typescript-sem"]=emitStart-semStart,res.times.typescript=emitStart-startTime,opts.ast&&(res.ast=program),opts.ast||opts.forceEmit||0==res.diagnostics.length){let binOutput=pxtc.compileBinary(program,opts,res,entryPoint);res.times.compilebinary=pxtc.U.cpuUs()-emitStart,res.diagnostics=res.diagnostics.concat(patchUpDiagnostics(binOutput.diagnostics))}0==res.diagnostics.length&&(res.success=!0);for(var f of opts.sourceFiles)pxtc.Util.startsWith(f,"built/")&&(res.outfiles[f.slice(6)]=opts.fileSystem[f]);res.times.all=pxtc.U.cpuUs()-startTime,pxt.tickEvent("compile",res.times)}return res}function decompile(e,t,r,n=!1){var s=e.getSourceFile(r),r=(pxtc.annotate(e,r,pxtc.target||pxt.appTarget&&pxt.appTarget.compile),pxtc.getApiInfo(e,t.jres)),r=pxtc.getBlocksInfo(r,t.bannedCategories),n={snippetMode:t.snippetMode||!1,alwaysEmitOnStart:t.alwaysDecompileOnStart,includeGreyBlockMessages:n,generateSourceMap:void 0!==t.generateSourceMap?t.generateSourceMap:!!t.ast,allowedArgumentTypes:t.allowedArgumentTypes||["number","boolean","string"],errorOnGreyBlocks:!!t.errorOnGreyBlocks},[t,,]=pxtc.decompiler.buildRenameMap(e,s,{declarations:"variables",takenNames:{}});return pxtc.decompiler.decompileToBlocks(r,s,n,t)}function decompileSnippets(e,t,r=!1){var e=pxtc.getApiInfo(e,t.jres),n=pxtc.getBlocksInfo(e,t.bannedCategories),s=new pxtc.decompiler.RenameMap([]),i={snippetMode:t.snippetMode||!1,alwaysEmitOnStart:t.alwaysDecompileOnStart,includeGreyBlockMessages:r,generateSourceMap:void 0!==t.generateSourceMap?t.generateSourceMap:!!t.ast,allowedArgumentTypes:t.allowedArgumentTypes||["number","boolean","string"],errorOnGreyBlocks:!!t.errorOnGreyBlocks};let a;var o=[];if(t.sourceTexts)for(let e=0;e<t.sourceTexts.length;e++){t.fileSystem[pxt.MAIN_TS]=t.sourceTexts[e],t.fileSystem[pxt.MAIN_BLOCKS]="";var l=getTSProgram(t,a),c=l.getSourceFile(pxt.MAIN_TS),c=pxtc.decompiler.decompileToBlocks(n,c,i,s);o.push(c.outfiles[pxt.MAIN_BLOCKS]),a=l}return o}function getTSProgram(e,t){let s={},i={};for(var r in e.fileSystem)i[normalizePath(r)]=e.fileSystem[r];let a=getTsCompilerOptions(e);var n={getSourceFile:(e,t,r)=>{e=normalizePath(e);let n="";return i.hasOwnProperty(e)?n=i[e]:r&&r("File not found: "+e),null==n&&(r("File not found: "+e),n=""),ts.createSourceFile(e,n,t,!0,void 0,a)},fileExists:e=>(e=normalizePath(e),i.hasOwnProperty(e)),getCanonicalFileName:e=>e,getDefaultLibFileName:()=>"no-default-lib.d.ts",writeFile:(e,t,r,n)=>{s[e]=t},getCurrentDirectory:()=>".",useCaseSensitiveFileNames:()=>!0,getNewLine:()=>"\n",readFile:e=>(e=normalizePath(e),i[e]||""),directoryExists:e=>!0,getDirectories:()=>[]};e.sourceFiles||(e.sourceFiles=Object.keys(e.fileSystem));let o=e.sourceFiles.filter(e=>pxtc.U.endsWith(e,".ts"));var l=o.filter(e=>e!=pxt.MAIN_TS),l=(o.length>l.length&&(o=l).push(pxt.MAIN_TS),o.indexOf(pxt.TUTORIAL_CODE_STOP)),l=(0<=l&&(o.splice(l,1),o.push(pxt.TUTORIAL_CODE_STOP)),ts.createProgram(o,a,n,t));return pxtc.annotate(l,pxt.MAIN_TS,pxtc.target||pxt.appTarget&&pxt.appTarget.compile),l}function normalizePath(e){e=e.replace(/\\/g,"/");let t=[];return e.split("/").forEach(e=>{".."===e&&t.length?t.pop():"."!==e&&t.push(e)}),t.join("/")}pxtc.getTsCompilerOptions=getTsCompilerOptions,pxtc.nodeLocationInfo=nodeLocationInfo,pxtc.patchUpDiagnostics=patchUpDiagnostics,pxtc.py2tsIfNecessary=py2tsIfNecessary,pxtc.storeGeneratedFiles=storeGeneratedFiles,pxtc.runConversionsAndStoreResults=runConversionsAndStoreResults,pxtc.timesToMs=timesToMs,pxtc.isPxtModulesFilename=isPxtModulesFilename,pxtc.compile=compile,pxtc.decompile=decompile,pxtc.decompileSnippets=decompileSnippets,pxtc.getTSProgram=getTSProgram}(pxtc=ts.pxtc||(ts.pxtc={}))}(ts=ts||{}),(m=>{{var e=m.elf||(m.elf={});let u=["type","offset","vaddr","paddr","filesz","memsz","flags","align"],p=m.HF2.read32,d=m.HF2.read16;e.parse=function(i){1179403647!=p(i,0)&&m.U.userError("no magic"),1!=i[4]&&m.U.userError("not 32 bit"),1!=i[5]&&m.U.userError("not little endian"),1!=i[6]&&m.U.userError("bad version"),2!=d(i,16)&&m.U.userError("wrong object type"),40!=d(i,18)&&m.U.userError("not ARM");let a=p(i,28),o=(p(i,32),0==a&&m.U.userError("expecting program headers"),d(i,42));var e,t=d(i,44),t=m.U.range(t).map(e=>{var t,r=a+e*o,n={},e=r;for(t of u)n[t]=p(i,r),r+=4;var s=n;return s._filepos=e,s});let r=i.length+1;for(;15&r;)r++;let n=0;for(e of t)1==e.type&&(n=Math.max(n,e.vaddr+e.memsz));var s,l=(n+4096-1&-4096)+(4095&r);let c=-1;for(s of t)4==s.type&&(c=s._filepos);return{imageMemStart:l,imageFileStart:r,phOffset:c,template:i}},e.patch=function(t,e){var r=new Uint8Array(t.imageFileStart+e.length),t=(r.fill(0),m.U.memcpy(r,0,t.template),m.U.memcpy(r,t.imageFileStart,e),{_filepos:t.phOffset,type:1,offset:t.imageFileStart,vaddr:t.imageMemStart,paddr:t.imageMemStart,filesz:e.length,memsz:e.length,flags:5,align:4096});{var n,s=r,i=t;let e=i._filepos;for(n of u)m.HF2.write32(s,e,i[n]||0),e+=4}return r}}})(pxt=pxt||{}),(m=>{{var e=m.esp||(m.esp={});let c=m.HF2.read32,u=m.HF2.read16,p=[{name:"esp32",chipId:0,memmap:[{from:0,to:65536,id:"PADDING"},{from:1061158912,to:1065353216,id:"DROM"},{from:1065353216,to:1069547520,id:"EXTRAM_DATA"},{from:1073217536,to:1073225728,id:"RTC_DRAM"},{from:1073283072,to:1073741824,id:"BYTE_ACCESSIBLE"},{from:1073405952,to:1073741824,id:"DRAM"},{from:1073610752,to:1073741820,id:"DIRAM_DRAM"},{from:1073741824,to:1074200576,id:"IROM"},{from:1074200576,to:1074233344,id:"CACHE_PRO"},{from:1074233344,to:1074266112,id:"CACHE_APP"},{from:1074266112,to:1074397184,id:"IRAM"},{from:1074397184,to:1074528252,id:"DIRAM_IRAM"},{from:1074528256,to:1074536448,id:"RTC_IRAM"},{from:1074593792,to:1077936128,id:"IROM"},{from:1342177280,to:1342185472,id:"RTC_DATA"}]},{name:"esp32-s2",chipId:2,memmap:[{from:0,to:65536,id:"PADDING"},{from:1056964608,to:1073217536,id:"DROM"},{from:1062207488,to:1073217536,id:"EXTRAM_DATA"},{from:1073340416,to:1073348608,id:"RTC_DRAM"},{from:1073340416,to:1073741824,id:"BYTE_ACCESSIBLE"},{from:1073340416,to:1074208768,id:"MEM_INTERNAL"},{from:1073414144,to:1073741824,id:"DRAM"},{from:1073741824,to:1073848576,id:"IROM_MASK"},{from:1073872896,to:1074200576,id:"IRAM"},{from:1074200576,to:1074208768,id:"RTC_IRAM"},{from:1074266112,to:1082130432,id:"IROM"},{from:1342177280,to:1342185472,id:"RTC_DATA"}]},{name:"esp32-s3",chipId:4,memmap:[{from:0,to:65536,id:"PADDING"},{from:1006632960,to:1023410176,id:"DROM"},{from:1023410176,to:1040187392,id:"EXTRAM_DATA"},{from:1611653120,to:1611661312,id:"RTC_DRAM"},{from:1070104576,to:1070596096,id:"BYTE_ACCESSIBLE"},{from:1070104576,to:1077813248,id:"MEM_INTERNAL"},{from:1070104576,to:1070596096,id:"DRAM"},{from:1073741824,to:1073848576,id:"IROM_MASK"},{from:1077346304,to:1077805056,id:"IRAM"},{from:1611653120,to:1611661312,id:"RTC_IRAM"},{from:1107296256,to:1115684864,id:"IROM"},{from:1342177280,to:1342185472,id:"RTC_DATA"}]},{name:"esp32-c3",chipId:5,memmap:[{from:0,to:65536,id:"PADDING"},{from:1006632960,to:1015021568,id:"DROM"},{from:1070071808,to:1070465024,id:"DRAM"},{from:1070104576,to:1070596096,id:"BYTE_ACCESSIBLE"},{from:1072693248,to:1072824320,id:"DROM_MASK"},{from:1073741824,to:1074135040,id:"IROM_MASK"},{from:1107296256,to:1115684864,id:"IROM"},{from:1077395456,to:1077805056,id:"IRAM"},{from:1342177280,to:1342185472,id:"RTC_IRAM"},{from:1342177280,to:1342185472,id:"RTC_DRAM"},{from:1611653120,to:1611661312,id:"MEM_INTERNAL2"}]}],d=8;function o(e){return`0x${e.addr.toString(16)} 0x${e.data.length.toString(16)} bytes; `+(e.isDROM?"drom ":"")+(e.isMapped?"mapped ":"")+m.U.toHex(e.data.slice(0,20))+"..."}function l(t){(t=f(t)).segments.sort((e,t)=>e.addr-t.addr),m.debug("esp padding:\n"+t.segments.map(o).join("\n")+"\n");var e,r=t.segments.filter(e=>e.isMapped);let n=t.segments.filter(e=>!e.isMapped),s=(t.segments=[],t.header.length);for(e of r){var i=e.addr+e.data.length&65535;i<36&&(i=new Uint8Array(36-i),e.data=m.U.uint8ArrayConcat([e.data,i]))}for(;0<r.length;){let e=r[0];var a=(e=>{let t=e.addr-d&65535,r=t-s&65535;return 0==r?0:((r-=d)<0&&(r+=65536),r)})(e);if(0<a)e=(e=>{var t,r;return!n.length||e<=d?{addr:0,isMapped:!1,isDROM:!1,data:new Uint8Array(e)}:(t=n[0],r={addr:t.addr,isMapped:t.isMapped,isDROM:t.isDROM,data:t.data.slice(0,e)},t.data=t.data.slice(e),t.addr+=r.data.length,0==t.data.length&&n.shift(),r)})(a);else{if((s+d&65535)!=(65535&e.addr))throw new Error(`pad oops 0 ${s}+${d} != ${e.addr} (mod mask)`);r.shift()}if(t.segments.push(e),3&(s+=d+e.data.length))throw new Error("pad oops 1")}return t.segments=t.segments.concat(n),m.debug("esp padded:\n"+t.segments.map(o).join("\n")+"\n"),t}function t(r){if(233!=r[0])throw new Error("ESP: invalid magic: "+r[0]);let n=24,t=u(r,12),e=p.find(e=>e.chipId==t);if(!e)throw new Error("ESP: unknown chipid: "+t);var s={header:r.slice(0,n),chipName:e.name,segments:[]},i=r[1];for(let e=0;e<i;++e){let t=c(r,n);var a=c(r,n+4),o=(n+=d,r.slice(n,n+a));if(o.length!=a)throw new Error("too short file");n+=a,l(t,"PADDING")||((a=s.segments.filter(e=>e.addr+e.data.length==t)[0])?a.data=m.U.uint8ArrayConcat([a.data,o]):s.segments.push({addr:t,isMapped:l(t,"DROM")||l(t,"IROM"),isDROM:l(t,"DROM"),data:o}))}return s;function l(t,r){return e.memmap.some(e=>e.id==r&&e.from<=t&&t<=e.to)}}function f(e){e=m.U.flatClone(e);return e.segments=e.segments.map(m.U.flatClone),e}e.toBuffer=function(e,t=!0){let r=(e=l(e)).header.length;for(var n of e.segments)r+=d+n.data.length;r=r+16&-16;let s=new Uint8Array(r),i=(s.set(e.header),s[1]=e.segments.length,e.header.length),a=239;for(var o of e.segments){m.HF2.write32(s,i,o.addr),m.HF2.write32(s,i+4,o.data.length),s.set(o.data,i+d),i+=d+o.data.length;for(let e=0;e<o.data.length;++e)a^=o.data[e]}if(s[s.length-1]=a,t){s[23]=1;let e=ts.pxtc.BrowserImpl.sha256buffer(s);s=m.U.uint8ArrayConcat([s,m.U.fromHex(e)])}else s[23]=0;return s},e.parseBuffer=t,e.parseB64=function(e){return t(m.U.stringToUint8Array(atob(e.join(""))))},e.cloneStruct=f}})(pxt=pxt||{}),(l=>{var e;{var x=l.pxtc||(l.pxtc={});let g,a=((e=g=g||{})[e.None=0]="None",e[e.Whitespace=1]="Whitespace",e[e.Identifier=2]="Identifier",e[e.Keyword=3]="Keyword",e[e.Operator=4]="Operator",e[e.CommentLine=5]="CommentLine",e[e.CommentBlock=6]="CommentBlock",e[e.NewLine=7]="NewLine",e[e.Literal=8]="Literal",e[e.Tree=9]="Tree",e[e.Block=10]="Block",e[e.EOF=11]="EOF",""),b=l.SyntaxKind;function y(e){switch(e){case b.CommaToken:return 1;case b.EqualsToken:case b.PlusEqualsToken:case b.MinusEqualsToken:case b.AsteriskEqualsToken:case b.AsteriskAsteriskEqualsToken:case b.SlashEqualsToken:case b.PercentEqualsToken:case b.LessThanLessThanEqualsToken:case b.GreaterThanGreaterThanEqualsToken:case b.GreaterThanGreaterThanGreaterThanEqualsToken:case b.AmpersandEqualsToken:case b.BarEqualsToken:case b.CaretEqualsToken:return 1;case b.QuestionToken:case b.ColonToken:case b.BarBarToken:case b.AmpersandAmpersandToken:case b.BarToken:case b.CaretToken:case b.AmpersandToken:return 1;case b.EqualsEqualsToken:case b.ExclamationEqualsToken:case b.EqualsEqualsEqualsToken:case b.ExclamationEqualsEqualsToken:return 1;case b.LessThanToken:case b.GreaterThanToken:case b.LessThanEqualsToken:case b.GreaterThanEqualsToken:case b.InstanceOfKeyword:case b.InKeyword:case b.AsKeyword:return 1;case b.LessThanLessThanToken:case b.GreaterThanGreaterThanToken:case b.GreaterThanGreaterThanGreaterThanToken:return 1;case b.PlusToken:case b.MinusToken:return 1;case b.AsteriskToken:case b.SlashToken:case b.PercentToken:case b.AsteriskAsteriskToken:case b.DotToken:return 1;default:return}}let o=!1;function i(e){a=e;let r=l.createScanner(l.ScriptTarget.Latest,!1,l.LanguageVariant.Standard,e,e=>{var t=r.getTextPos();pxt.log("scanner error",t,e.message)});var t=[];let n=0,s=-1;for(;;){let e=r.scan();e==b.CloseBraceToken&&n==s&&(s=-1,e=r.reScanTemplateToken());var i={kind:(e=>{switch(e){case b.EndOfFileToken:return g.EOF;case b.SingleLineCommentTrivia:return g.CommentLine;case b.MultiLineCommentTrivia:return g.CommentBlock;case b.NewLineTrivia:return g.NewLine;case b.WhitespaceTrivia:return g.Whitespace;case b.ShebangTrivia:case b.ConflictMarkerTrivia:return g.CommentBlock;case b.NumericLiteral:case b.StringLiteral:case b.RegularExpressionLiteral:case b.NoSubstitutionTemplateLiteral:case b.TemplateHead:case b.TemplateMiddle:case b.TemplateTail:return g.Literal;case b.Identifier:return g.Identifier;default:return e<b.Identifier?g.Operator:g.Keyword}})(e=(e=(o&&e==b.SlashToken||e==b.SlashEqualsToken)&&(i=r.reScanSlashToken())==b.RegularExpressionLiteral?i:e)==b.GreaterThanToken?r.reScanGreaterToken():e),synKind:e,lineNo:0,pos:r.getTokenPos(),text:r.getTokenText()};if(e==b.OpenBraceToken&&n++,e==b.CloseBraceToken&&--n<0&&(n=-1e7),t.push(i),e!=b.TemplateHead&&e!=b.TemplateMiddle||(s=n),i.kind==g.EOF)break}return{tokens:t,braceBalance:n}}function p(e,t){for(;e[t]&&e[t].kind==g.Whitespace;)t++;return t}function d(r){let n=[];var s,i;n.push({synKind:b.EndOfFileToken,token:{children:[]}});for(let t=0;t<r.length;++t){var a=r[t];let e=n[n.length-1];if(e.token.children.push(a),a.kind===g.Operator)switch(a.synKind){case b.OpenBraceToken:case b.OpenParenToken:case b.OpenBracketToken:i=(s=a).synKind+1,s.children=[],s.kind=g.Tree,n.push({synKind:i,token:s});break;case b.CloseBraceToken:case b.CloseParenToken:case b.CloseBracketToken:for(e.token.children.pop();;){if((e=n.pop()).synKind==a.synKind){e.token.endToken=a;break}if(0==n.length||e.synKind==b.CloseBraceToken){n.push(e);break}}}}return n[0].token.children}function k(){return{kind:g.EOF,synKind:b.EndOfFileToken,pos:0,lineNo:0,text:""}}function S(e,t){return{kind:g.Whitespace,synKind:b.WhitespaceTrivia,pos:e.pos-t.length,lineNo:e.lineNo,text:t}}function v(e){return{kind:g.Block,synKind:b.OpenBraceToken,pos:e[0].pos,lineNo:e[0].lineNo,stmts:[{tokens:e}],text:"{",endToken:null}}function T(e){return{kind:g.Tree,synKind:b.WhitespaceTrivia,pos:e[0].pos,lineNo:e[0].lineNo,children:e,endToken:null,text:""}}function I(n,s,i=null){let a=[],o=0,l,c=!1;for(n=n.concat([k()]);n[o].kind!=g.EOF;){var e=o;h(),x.Util.assert(o>e,"Error at "+n[o].text),(e=>{if(0!=(e=s?w(e):e).length){e.forEach(u),e=function r(n){let s=[];let i=0;for(;i<n.length;)if(n[i].blockSpanLength){let e=n.slice(i,i+n[i].blockSpanLength),t=!!e[0].blockSpanIsVirtual;delete e[0].blockSpanLength,delete e[0].blockSpanIsVirtual,i+=e.length,e=r(e),t?s.push(T(e)):(s.push(S(e[0]," ")),s.push(v(w(e))))}else s.push(n[i++]);return s}(e);if(s&&0<a.length){var t=a[a.length-1].tokens[0].synKind,r=e[0].synKind;if(t==b.IfKeyword&&r==b.ElseKeyword||t==b.TryKeyword&&r==b.CatchKeyword||t==b.TryKeyword&&r==b.FinallyKeyword||t==b.CatchKeyword&&r==b.FinallyKeyword)return e.unshift(S(e[0]," ")),x.Util.pushRange(a[a.length-1].tokens,e)}a.push({tokens:e})}})(n.slice(e,o))}return a;function u(e){e.kind==g.Tree&&(e.children=x.Util.concat(I(e.children,!1,e).map(e=>e.tokens)))}function p(){for(;;)switch(o++,n[o].kind){case g.Whitespace:case g.CommentBlock:case g.CommentLine:case g.NewLine:break;default:return}}function d(){for(;n[o].kind==g.Whitespace;)o++;n[o].kind==g.NewLine&&o++}function m(){x.Util.assert(n[o].synKind==b.OpenBraceToken);var e=n[o],t=(x.Util.assert(e.kind==g.Tree),n[o]);t.stmts=I(e.children,!0,l),delete e.children,t.kind=g.Block,o++,c=!0}function f(){var e=o+1;p(),n[o].synKind==b.OpenBraceToken?(m(),d()):(h(),n[e].blockSpanLength=o-e)}function h(){for(;;){let e=n[o];var t=o;if(l=e,c=!1,e.kind==g.EOF)return;if(s&&e.synKind==b.SemicolonToken)return o++,void d();if(e.synKind==b.EqualsGreaterThanToken){if(p(),n[o].synKind==b.OpenBraceToken){m();continue}{var r=o;h();let e=o;for(;n[e].kind==g.NewLine;)e--;return n[r].blockSpanLength=e-r,void(n[r].blockSpanIsVirtual=!0)}}if(s&&y(e.synKind)){r=o;if(p(),!(e=>{if(e)switch(e.synKind){case b.IfKeyword:case b.ElseKeyword:case b.LetKeyword:case b.ConstKeyword:case b.VarKeyword:case b.DoKeyword:case b.WhileKeyword:case b.SwitchKeyword:case b.CaseKeyword:case b.DefaultKeyword:case b.ForKeyword:case b.ReturnKeyword:case b.BreakKeyword:case b.ContinueKeyword:case b.TryKeyword:case b.CatchKeyword:case b.FinallyKeyword:case b.DeleteKeyword:case b.FunctionKeyword:case b.ClassKeyword:case b.YieldKeyword:case b.DebuggerKeyword:return 1;default:return}})(n[o]))continue;o=r}if(s&&e.kind==g.NewLine){if(p(),y((e=n[o]).synKind)&&e.synKind!=b.PlusToken&&e.synKind!=b.MinusToken)continue;return void(o=t+1)}if(e.synKind==b.OpenBraceToken&&i&&i.synKind==b.ClassKeyword){let e=o-1;for(;0<=e&&n[e].kind==g.Whitespace;)e--;if(e<0||n[e].synKind!=b.EqualsToken)return o--,void f()}switch(x.Util.assert(t==o),e.synKind){case b.ForKeyword:case b.WhileKeyword:case b.IfKeyword:case b.CatchKeyword:if(p(),n[o].synKind!=b.OpenParenToken)continue;return void f();case b.DoKeyword:if(f(),o--,p(),n[o].synKind!=b.WhileKeyword)return;o++;continue;case b.ElseKeyword:if(p(),n[o].synKind==b.IfKeyword)continue;return o=t,void f();case b.TryKeyword:case b.FinallyKeyword:return void f();case b.ClassKeyword:case b.NamespaceKeyword:case b.ModuleKeyword:case b.InterfaceKeyword:case b.FunctionKeyword:for(;;)switch(o++,n[o].kind){case g.EOF:return;case g.Tree:if(n[o].synKind==b.OpenBraceToken)return void(o--,f())}return}x.Util.assert(!c,"forgot continue/return after expectBlock"),o++}}}function t(e){return e&&(e.kind==g.Whitespace||e.kind==g.NewLine)}function m(t){var r=[];let n=!1;for(let e=0;e<t.length;++e)t[e=n?p(t,e):e]&&(r.push(t[e]),n=t[e].kind==g.NewLine);return r}function w(e){for(e=e.slice(0);t(e[0]);)e.shift();for(;t(e[e.length-1]);)e.pop();return e}function f(e){var t=[];let r=0,n=k();for(e=e.concat([k()]);r<e.length;){var s=e[r=p(e,r)];if(s.kind==g.EOF)break;var i=p(e,r+1);if(s.kind==g.NewLine&&e[i].synKind==b.OpenBraceToken)r=i;else{let e=!0;var a=0==t.length?(i=s,{kind:g.NewLine,synKind:b.NewLineTrivia,pos:i.pos,lineNo:i.lineNo,text:"\n"}):t[t.length-1];switch(a.synKind){case b.ExclamationToken:case b.TildeToken:case b.DotToken:e=!1;break;case b.PlusToken:case b.MinusToken:case b.PlusPlusToken:case b.MinusMinusToken:a.isPrefix&&(e=!1)}switch(s.synKind){case b.DotToken:case b.CommaToken:case b.NewLineTrivia:case b.ColonToken:case b.SemicolonToken:case b.OpenBracketToken:e=!1;break;case b.PlusPlusToken:case b.MinusMinusToken:a.kind!=g.Tree&&a.kind!=g.Identifier&&a.kind!=g.Keyword||(e=!1);case b.PlusToken:case b.MinusToken:n.kind!=g.EOF&&!y(n.synKind)&&n.synKind!=b.SemicolonToken||(s.isPrefix=!0);break;case b.OpenParenToken:if(a.kind==g.Identifier&&(e=!1),a.kind==g.Keyword)switch(a.synKind){case b.IfKeyword:case b.ForKeyword:case b.WhileKeyword:case b.SwitchKeyword:case b.ReturnKeyword:case b.ThrowKeyword:case b.CatchKeyword:break;default:e=!1}}(e=a.kind==g.NewLine?!1:e)&&t.push(S(s," ")),t.push(s),s.kind!=g.NewLine&&(n=s),r++}}return t}function h(s,e){if(e.synKind==b.NoSubstitutionTemplateLiteral&&/^`[\s\.#01]*`$/.test(e.text)){var i=e.text.slice(1,e.text.length-1).split("\n").map(e=>e.replace(/\s/g,"")).filter(e=>!!e);if(!(i.length<4||5<i.length)){let r=Math.floor((Math.max(...i.map(e=>e.length))+2)/5),n=(r<=0&&(r=1),"`\n");for(let t=0;t<5;++t){let e=i[t]||"";for(;e.length<5*r;)e+=".";e=(e=(e=e.replace(/0/g,".")).replace(/1/g,"#")).replace(/...../g,e=>"/"+e),n+=s+e.replace(/./g,e=>" "+e).replace(/\//g," ").slice(3)+"\n"}n+=s+"`",e.text=n}}}x.toStr=function e(t){return Array.isArray(t)?"[[ "+t.map(e).join("  ")+" ]]":"string"==typeof t.text?JSON.stringify(t.text):t+""},x.format=function(e,t){e=I(d(((r,n)=>{var s=[];let e=!0,i=1;for(let t=0;t<r.length;++t){if(e){var a=t;if(r[t=p(r,t)].kind==g.NewLine){let e=!1;0<=n&&r[t].pos>=n&&(n=-1,e=!0),s.push({text:"",kind:g.CommentLine,pos:r[t].pos,lineNo:i,synKind:b.SingleLineCommentTrivia,isCursor:e})}else t=a}s.push(r[t]),r[t].lineNo=i,r[t].kind==g.NewLine?(e=!0,i++):e=!1,0<=n&&r[t].pos>=n&&(n=-1)}return s})(i(e).tokens,t)),!0);let a="",o="",r=-1,n=0;return e.forEach(c),e.forEach(e=>e.tokens.forEach(s)),-1==r&&(r=o.length),{formatted:o,pos:r};function s(e){var t;e.kind==g.Tree?((t=e).synKind,b.OpenBraceToken,t.children.forEach(s)):e.kind==g.Block&&e.stmts.forEach(e=>e.tokens.forEach(s))}function l(e,t){n==e.lineNo?t():(n=e.lineNo,e=a,a+="    ",t(),a=e)}function c(e){let t=m(e.tokens);(1!=t.length||t[0].isCursor||""!=t[0].text)&&(o+=a,l(t[0],()=>{!function s(i){i=f(i);for(let n=0;n<i.length;++n){let r=i[n];switch(h(a,r),u(r),r.kind){case g.Tree:let e=r;l(r,()=>{s(m(e.children))}),e.endToken&&u(e.endToken);break;case g.Block:let t=r;0==t.stmts.length?o+=" ":(o+="\n",t.stmts.forEach(c),o+=a.slice(4)),t.endToken?u(t.endToken):o+="}";break;case g.NewLine:i[n+1]&&i[n+1].kind==g.CommentLine&&""==i[n+1].text&&!i[n+1].isCursor||(n==i.length-1?o+=a.slice(4):o+=a);break;case g.Whitespace:}}}(t)}),"\n"==o[o.length-1])||(o+="\n")}function u(e){-1==r&&e.pos+e.text.length>=t&&(r=o.length+(t-e.pos)),o+=e.text}}}})(ts=ts||{}),(S=>{{var I=S.pxtc||(S.pxtc={});let k;{var a=k=I.hexfile||(I.hexfile={});a.asmTotalSource="";let o={},t=[];function w(){return{commBase:0,funcInfo:{},codeStartIdx:-1,codePaddingSize:0,sha:null,codeStartAddrPadded:void 0,hexlines:void 0,jmpStartAddr:void 0,jmpStartIdx:void 0,codeStartAddr:void 0,elfInfo:void 0,espInfo:void 0,topFlashAddr:0}}let v=w();function E(e){let t="",r=0;for(;r<e.length;r+=2)t=e[r]+e[r+1]+t;return I.assert(r==e.length),t}function N(e){if(!(e=e.replace(/^[\s:]/,"")))return[];let t=[];if(e.replace(/([a-f0-9][a-f0-9])/gi,e=>(t.push(parseInt(e,16)),"")))throw I.oops("bad bytes "+e);return t}function A(e){return e.flashCodeAlign||1024}a.getCommBase=function(){return v.commBase},a.getStartAddress=function(){return v.codeStartAddrPadded},a.getTopFlashAddress=function(){return v.topFlashAddr},a.setupInlineAssembly=function(e){o={};var t,r=e.sourceFiles.filter(e=>I.U.endsWith(e,".asm"));a.asmTotalSource="";let n=0;for(t of r){var s=e.fileSystem[t],s=(s.replace(/^\s*(\w+):/gm,(e,t)=>(o[t]=!0,"")),".object inlineasm\n.section code\n@stackmark func\n@scope user"+n+++"\n"+s+"\n@stackempty func\n@scope\n");a.asmTotalSource+=s}},a.parseHexBytes=N,a.parseHexRecord=function(e){return{len:(e=N(e))[0],addr:e[1]<<8|e[2],type:e[3],data:e.slice(4,e.length-1),checksum:e[e.length-1]}},a.flashCodeAlign=A;let T="0108010842424242010801083ed8e98d";function l(e){return v.funcInfo[e]}function _(){let e=v.sha?v.sha.slice(0,16):"";for(;e.length<16;)e+="0";return e.toUpperCase()}function K(e){let t=0,r=":";return e.forEach(e=>t+=e),e.push(255&-t),e.forEach(e=>r+=("0"+e.toString(16)).slice(-2)),r.toUpperCase()}a.setupFor=function(l,r,n){if(!(v=t.find(e=>e.sha==r.sha))){v=w(),(t=10<t.length?[]:t).push(v);let a=r.functions,o=(v.commBase=r.commBase||0,v.sha=r.sha,r.hexinfo.hex);if(v.hexlines=o,I.target.nativeType==I.NATIVE_TYPE_VM){v.codeStartAddr=0,v.codeStartAddrPadded=0,v.jmpStartAddr=-1,v.jmpStartIdx=-1;for(var e of a)(v.funcInfo[e.name]=e).value=16777215;if(I.target.useESP){var s=pxt.esp.parseB64(o);let n=I.U.fromHex(T);var i=s.segments.filter(e=>e.isDROM);I.U.assert(1==i.length);let t=!1;var c=i[0];v.codeStartAddr=c.addr+c.data.length,v.codeStartAddrPadded=v.codeStartAddr+255&-256,v.codePaddingSize=v.codeStartAddrPadded-v.codeStartAddr,pxt.debug(`user code start: 0x${v.codeStartAddrPadded.toString(16)}; dromlen=${c.data.length} pad=`+v.codePaddingSize);for(let e=0;e<c.data.length;e+=32)if(((t,r)=>{for(let e=0;e<n.length;++e)if(t[r+e]!=n[e])return!1;return!0})(c.data,e)){t=!0,e+=n.length,v.topFlashAddr=pxt.HF2.read32(c.data,e);var u,p=e+=4;for(u of r.vmPointers||[])"0"!=u&&(u=u.replace(/^&/,""),v.funcInfo[u]={name:u,argsFmt:[],value:pxt.HF2.read32(c.data,e)},e+=4);pxt.HF2.write32(c.data,p,v.codeStartAddrPadded);break}I.U.assert(t||0==(r.vmPointers||[]).length),v.espInfo=s,v.codeStartAddrPadded=0}}else{if(o.length<=2)(i=I.U.fromHex(o[0]))[2]<=2&&96==i[3]?(s=i.length+4096-1&-4096,v.elfInfo={template:i,imageMemStart:1610612736+s,imageFileStart:s,phOffset:-1e3}):v.elfInfo=pxt.elf.parse(i),v.codeStartAddr=v.elfInfo.imageMemStart,v.codeStartAddrPadded=v.elfInfo.imageMemStart,(s=o[0].indexOf(T))<0&&I.oops("no jmp table in elf"),v.jmpStartAddr=s/2,v.jmpStartIdx=-1,i=o[0].slice(s+32,s+40),v.topFlashAddr=parseInt(E(i),16),k(o[0].slice(s+40,s+40+8*a.length+16));else{var d,m=o;for(let e=0;e<m.length;++e)"2"==m[e][8]&&(d=/^:02....02(....)..$/.exec(m[e]),I.U.assert(!!d),d=16*parseInt(d[1],16),I.U.assert(0==(65535&d)),m[e]=K([2,0,0,4,0,d>>16]));let e=0,t="0000",s=0,i=0;v.codeStartAddr=0;for(var f=()=>{if(!v.codeStartAddr){var e=N(o[i]),t=16-(s+e[0]&15)&15;if(t)if(15&e[2]){var r=s+e[0],n=[t,r>>8,255&r,0];for(let e=0;e<t;++e)n.push(0);i++,o.splice(i,0,K(n)),v.codeStartAddr=r+t}else{if(16!=e[0]){for(e.pop(),e[0]=16;e.length<20;)e.push(0);o[i]=K(e)}v.codeStartAddr=s+16}else v.codeStartAddr=s+e[0];v.codeStartIdx=i+1;r=A(l),r=(v.codeStartAddrPadded=(v.codeStartAddr&~(r-1))+r,v.codeStartAddrPadded-v.codeStartAddr);I.assert(0==(15&r)),v.codePaddingSize=r}};e<o.length;++e){var h,g,b=/:02000004(....)/.exec(o[e]);b&&(t=b[1]),(b=/^:..(....)00/.exec(o[e]))&&(0<=v.jmpStartIdx&&v.jmpStartIdx+1==e&&(h=/^:..(....)00(.{4,})/.exec(o[e]))&&(g=l.shortPointers?4:8,h=E(h[2].slice(0,g)),v.topFlashAddr=parseInt(h,16)),g=parseInt(t+b[1],16),!l.flashUsableEnd&&s&&65536<g-s&&f(),l.flashUsableEnd&&C(l,n)<=g&&f(),i=e,s=g),/^:00000001/.test(o[e])&&f(),/^:10....000108010842424242010801083ED8E98D/.exec(o[e])&&(v.jmpStartAddr=s,v.jmpStartIdx=e)}pxt.debug(`code start: ${v.codeStartAddrPadded}, jmptbl: `+v.jmpStartAddr),v.jmpStartAddr||I.oops("No hex start"),v.codeStartAddr||I.oops("No hex end"),v.funcInfo={};for(let e=v.jmpStartIdx+1;e<o.length;++e){var x,y=/^:..(....)00(.{4,})/.exec(o[e]);if(y)if(e===v.jmpStartIdx+1?(x=l.shortPointers?4:8,k(y[2].slice(x))):k(y[2]),0==a.length)break}function k(t){for(var r=l.shortPointers?4:8;t.length>=r;){var n=t.slice(0,r);let e=parseInt(E(n),16);t=t.slice(r);var s=a.shift();if(!s)break;v.funcInfo[s.name]=s,e||I.U.oops("No value for "+s.name+" / "+n),0==s.argsFmt.length?e^=1:l.runtimeIsARM||l.nativeType!=I.NATIVE_TYPE_THUMB||1&e||I.U.oops("Non-thumb addr for "+s.name+" / "+n),s.value=e}}function S(){a.length&&I.oops("premature EOF in hex file; missing: "+a.map(e=>e.name).join(", "))}}S()}}},a.validateShim=function(e,t,r,n,s){if("TD_ID"!=t&&"TD_NOOP"!=t&&"ENUM_GET"!=t&&!I.U.lookup(o,t)){var i=e+`(...) (shim=${t})`,a=l(t);if(a){n?"V"==a.argsFmt[0]&&I.U.userError("expecting function for "+i):"V"!=a.argsFmt[0]&&I.U.userError("expecting procedure for "+i);for(let e=0;e<s.length;++e)a.argsFmt[e+1]||I.U.userError("excessive parameters passed to "+i);s.length!=a.argsFmt.length-1&&I.U.userError(`not enough arguments for ${i} (got ${s.length}; fmt=${a.argsFmt.join(",")})`)}else I.U.userError("function not found: "+i)}},a.lookupFunc=l,a.lookupFunctionAddr=function(e){return"_pxt_comm_base"==e?v.commBase:(e=l(e))?e.value:null},a.hexTemplateHash=_,a.hexPrelude=function(){return`    .startaddr 0x${v.codeStartAddrPadded.toString(16)}
`},a.hexBytes=K,a.patchHex=function(r,n,e,s){let i=v.hexlines.slice(0,v.codeStartIdx);r.target.useESP||(m=2*n.length+7>>3,I.assert(m<64e3,"program too large, bytes: "+2*n.length),n[17]=m,n[20]=r.commSize);var t=[];for(let e=0;e<v.codePaddingSize>>1;++e)t.push(0);n=t.concat(n);let a=0;function o(t,e){var r=[16,e>>8&255,255&e,0];for(let e=0;e<8;++e)r.push(255&(t[a]||0)),r.push((t[a]||0)>>>8),a++;return r}var l=[16912,0,65535&v.codeStartAddrPadded,v.codeStartAddrPadded>>>16],c=_();for(let e=0;e<4;++e)l.push(parseInt(E(c.slice(4*e,4*e+4)),16));var u=s?I.UF2.newBlockFile(I.target.uf2Family):null;if(v.elfInfo){var p=new Uint8Array(2*n.length);for(let e=0;e<n.length;++e)pxt.HF2.write16(p,2*e,n[e]);var d=pxt.elf.patch(v.elfInfo,p);for(let e=0;e<l.length;++e)pxt.HF2.write16(d,2*e+v.jmpStartAddr,l[e]);if(!u||r.target.switches.rawELF)return[I.U.uint8ArrayToString(d)];{let e=r.name||"pxt";return e=e.replace(/[^a-zA-Z0-9\-\.]+/g,"_"),u.filename="Projects/"+e+".elf",I.UF2.writeBytes(u,0,d),[I.UF2.serializeFile(u)]}}if(v.espInfo){var m=pxt.esp.cloneStruct(v.espInfo),s=m.segments.find(e=>e.isDROM);let t=s.data.length;var f=new Uint8Array(t+2*n.length+255&-256);f.set(s.data);for(let e=0;e<n.length;++e)pxt.HF2.write16(f,t,n[e]),t+=2;s.data=f;s=pxt.esp.toBuffer(m);return u?(I.UF2.writeBytes(u,0,s),$(u,r),[I.UF2.serializeFile(u)]):[I.U.uint8ArrayToString(s)]}if(u){if(I.UF2.writeHex(u,i),I.UF2.writeBytes(u,v.jmpStartAddr,o(l,v.jmpStartIdx).slice(4)),r.checksumBlock){var h,g=[];for(h of r.checksumBlock)g.push(255&h,h>>8);I.UF2.writeBytes(u,r.target.flashChecksumAddr,g)}}else i[v.jmpStartIdx]=K(o(l,v.jmpStartAddr)),r.checksumBlock&&I.U.oops("checksum block in HEX not implemented yet");a=0,e&&(i=[]);let b=v.codeStartAddr,x=b-16>>16;for(;a<n.length;)u?I.UF2.writeBytes(u,b,o(n,b).slice(4)):(b>>16!=x&&(x=b>>16,i.push(K([2,0,0,4,x>>8,255&x]))),i.push(K(o(n,b)))),b+=16;if(e||(m=v.hexlines.slice(v.codeStartIdx),u?I.UF2.writeHex(u,m):I.Util.pushRange(i,m)),!u&&r.target.moveHexEof){for(;!i[i.length-1];)i.pop();":00000001FF"==i[i.length-1]&&i.pop()}if(r.packedSource)if(u)$(u,r);else{let e=0;for(let t=0;t<r.packedSource.length;t+=16){var y=[16,e>>8&255,255&e,14];for(let e=0;e<16;++e)y.push(255&(r.packedSource.charCodeAt(t+e)||0));i.push(K(y)),e+=16}}return!u&&r.target.moveHexEof&&i.push(":00000001FF"),u?[I.UF2.serializeFile(u)]:i}}function $(r,n){if(n.packedSource){let e=r.currPtr+4096&-256;var s=new Uint8Array(256);for(let t=0;t<n.packedSource.length;t+=256){for(let e=0;e<256;++e)s[e]=n.packedSource.charCodeAt(t+e);I.UF2.writeBytes(r,e,s,I.UF2.UF2_FLAG_NOFLASH),e+=256}}}I.hexDump=function(n,e=0){function s(e,t=8){let r=e.toString(16);for(;r.length<t;)r="0"+r;return r}let i="";for(let r=0;r<n.length;r+=16){i+=s(e+r)+": ";let t="";for(let e=0;e<16;e++){0==(3&e)&&(i+=" ");var a=n[r+e];null==a?i+="   ":(i+=s(a,2)+" ",t+=32<=a&&a<127?String.fromCharCode(a):".")}i+=" "+t+"\n"}return i},I.asmline=function(e){return 0<=e.indexOf("\n")?(e=e.replace(/^\s*/gm,"").replace(/^(.*)$/gm,(e,t)=>";"==t[0]&&" "==t[1]||/:\*$/.test(t)?t:"    "+t))+"\n":(e=/(^[\s;])|(:$)/.test(e)?e:"    "+e)+"\n"},I.firstMethodOffset=function(){return 9};let r=[21078089,22513679,15655169,18636881,19658081,21486649,21919277,20041213,20548751,16180187,18361627,19338023,19772677,16506547,23530697,22998697,21225203,19815283,23679599,19822889,21136133,19540043,21837031,18095489,23924267,23434627,22582379,21584111,22615171,23403001,19640683,19998031,18460439,20105387,17595791,16482043,23199959,18881641,21578371,22765747,20170273,16547639,16434589,21435019,20226751,19506731,21454393,23224541,23431973,23745511];function b(i){let a=32;I.U.assert(I.U.unique(i,e=>""+e).length==i.length,"non unique");for(let s=2;;s<<=1)if(a--,!(s<i.length)){let e=-1,t=-1,n;for(var o of r){var l=o<<8|a,c=new Uint16Array(s+I.vtLookups+1);I.U.assert(0==(1&c.length));let r=0;var u,p=[];for(u of i){I.U.assert(0<u);var d=Math.imul(u,l)>>>a;p.push(d);let t=!1;for(let e=0;e<I.vtLookups;e++){if(!c[d+e]){t=!0,c[d+e]=u;break}r++}if(!t){r=-1;break}}(-1==e||e>r)&&(e=r,t=l,n=c)}if(0<=e)return{mult:t,mapping:n,size:s}}}function v(e,t,r,n){var s=b(e.itable.map(e=>e.idx));let i=I.target.shortPointers?".short":".word",a=`
        .object ${e.id}_VT
        .balign 4
${e.id}_VT:
        .short ${4*e.allfields.length+4}  ; size in bytes
        .byte ${pxt.ValTypeObject}, ${pxt.VTABLE_MAGIC} ; magic
        ${i} ${e.id}_IfaceVT
        .short ${e.classNo} ; class-id
        .short 0 ; reserved
        .word ${s.mult} ; hash-mult
`;var o,l=e=>{"0"!=e&&(e+="@fn"),a+=`        ${i} ${e}
`},c=(l("pxt::RefRecord_destroy"),l("pxt::RefRecord_print"),l("pxt::RefRecord_scan"),l("pxt::RefRecord_gcsize"),e.toStringMethod);l(c?c.vtLabel():"0");for(o of e.vtable)l(o.label()+"_nochk");a+=`
        .balign ${I.target.shortPointers?2:4}
${e.id}_IfaceVT:
`;var u;let p=2*s.mapping.length,d="",m=p,f={};for(u of e.itable){f[u.idx+""]=m;var h=u.proc?u.proc.isGetter()?1:2:0;d=(d+=`  .short ${u.idx}, ${h} ; ${u.name}
`)+`  .word ${u.proc?u.proc.vtLabel()+"@fn":u.info}
`,m+=8,u.setProc&&(d=(d+=`  .short ${u.idx}, 0 ; set ${u.name}
`)+`  .word ${u.setProc.vtLabel()}@fn
`,m+=8)}d+="  .word 0, 0 ; the end\n",m+=8;var g=s.mapping;for(let e=0;e<g.length;++e)r.itEntries++,g[e]&&r.itFullEntries++;return a=(a+="  .short "+I.U.toArray(g).map((e,t)=>(f[e+""]||p)-2*t).join(", ")+"\n")+d+"\n"}I.vtLookups=3,I.computeHashMultiplier=b,I.vtableToAsm=v;let y=["GC"];function c(t,e,r){let n=`
    .short ${t.globalsWords}   ; num. globals
    .short 0 ; patched with number of 64 bit words resulting from assembly
    .word _pxt_config_data
    .short 0 ; patched with comm section size
    .short ${t.nonPtrGlobals} ; number of globals that are not pointers (they come first)
    .word _pxt_iface_member_names
    .word _pxt_lambda_trampoline@fn
    .word _pxt_perf_counters
    .word _pxt_restore_exception_state@fn
    .word ${t.emitString(t.getTitle())} ; name
`,s=null;s=new I.ThumbSnippets;var i,a,o,l,c,u=t.setPerfCounters(y),p=(t.procs.forEach(e=>{e=new I.ProctoAssembler(s,t,e);n+="\n"+e.getAssembly()+"\n"}),new I.ProctoAssembler(s,t,null));p.emitHelpers(),n=(n+="\n"+p.getAssembly()+"\n")+k.asmTotalSource+"_code_end:\n\n",I.U.iterMap(t.codeHelpers,(e,t)=>{n+=`    .section code
`+`    .object _code_helper_${t}
`+t+`:
`+e+`
`}),n=n+s.arithmetic()+"_helpers_end:\n\n",t.usedClassInfos.forEach(e=>{n+=v(e,0,t)}),n=(n+=`
.balign 4
.object _pxt_iface_member_names
_pxt_iface_member_names:
`)+`    .word ${t.ifaceMembers.length}
`;let d=0;for(i of t.ifaceMembers){var m=t.emitString(i);n+=`    .word ${m}  ; ${d++} .${i}
`}n=(n+=`    .word 0
`)+"_vtables_end:\n\n"+`
.balign 4
.object _pxt_config_data
_pxt_config_data:
`;for(a of r.configData||[])n+=`    .word ${a.key}, ${a.value}  ; ${a.name}=${a.value}
`;n+=`    .word 0

`;var f=s,h=t;for(o of I.U.unique(h.ifaceMembers.concat(Object.keys(h.strings)),e=>e))h.otherLiterals.push(f.string_literal(h.strings[o],o));for(l of Object.keys(h.doubles)){var g=h.doubles[l];h.otherLiterals.push(`
.object ${g}
.balign 4
${g}: ${f.obj_header("pxt::number_vt")}
        .hex ${l}
`)}for(c of Object.keys(h.hexlits))h.otherLiterals.push(f.hex_literal(h.hexlits[c],c)),h.otherLiterals.push();n=(n=n+t.otherLiterals.join("")+`
.balign 4
.section code
.object _perf_counters
_pxt_perf_counters:
`)+`    .word ${u.length}
`;let b="";for(let e=0;e<u.length;++e){var x=".perf"+e;n+=`    .word ${x}
`,b+=x+`: .string ${JSON.stringify(u[e])}
`}return n=n+b+"_literals_end:\n"}function o(e){let t;return(t=e.nativeType==I.NATIVE_TYPE_VM?new I.assembler.VMFile(new I.vm.VmProcessor(e)):new I.assembler.File(new I.thumb.ThumbProcessor)).ei.testAssembler(),e.switches.noPeepHole&&(t.disablePeepHole=!0),e.switches.size&&(t.codeSizeStats=!0),t.lookupExternalLabel=k.lookupFunctionAddr,t.normalizeExternalLabel=e=>{var t=k.lookupFunc(e);return t?t.name:e},t}function u(e){if(0<e.errors.length){let r="";throw e.errors.forEach(e=>{var t=/^user(\d+)/.exec(e.scope);t&&(parseInt(t[1]),r=(r+=I.U.lf("At inline assembly:\n"))+e.message)}),r&&(pxt.log(I.U.lf("errors in inline assembly")),pxt.log(r)),new Error(e.errors[0].message)}}function C(e,t){let r=0;t.configData&&(n=t.configData.find(e=>"SETTINGS_SIZE_DEFL"===e.name),t=t.configData.find(e=>"SETTINGS_SIZE"===e.name),r=t?t.value:n?n.value:0);var n,t=k.getTopFlashAddress();return(0<t?t:e.flashUsableEnd||e.flashEnd)-r}let i=!(I.processorInlineAssemble=function(e,t){var r=o(e),n=(r.disablePeepHole=!0,r.emit(t),u(r),[]);for(let e=0;e<r.buf.length;e+=2)n.push(((r.buf[e+1]||0)<<16|r.buf[e])>>>0);return n});function T(e,t,r,n){var s=o(e);return s.emit(r),r=`; Interface tables: ${t.itFullEntries}/${t.itEntries} (${Math.round(100*t.itFullEntries/t.itEntries)}%)
`+`; Virtual methods: ${t.numVirtMethods} / ${t.numMethods}
`+s.getSource(!i,t.numStmts,C(e,n)),u(s),{src:r,buf:s.buf,thumbFile:s}}function p(n,s,i,e){var a=i.extinfo.disabledDeps,o=(n=a?k.hexPrelude()+`
`+`; compilation disabled on this variant due to ${i.extinfo.disabledDeps}
`+`.hex 718E3B92C615A841C49866C975EE5197
`+`.string "${i.extinfo.disabledDeps}"`:`; start
${k.hexPrelude()}
    .hex 708E3B92C615A841C49866C975EE5197 ; magic number
    .hex ${k.hexTemplateHash()} ; hex template hash
    .hex 873266330af9dbdb ; replaced in binary by program hash
`+n,i.embedBlob&&(s.packedSource=((e,t)=>{(e=I.Util.toUTF8(e)).length,t.length;let r="A//";return(r=(r+=I.U.uint8ArrayToString([255&e.length,e.length>>8,255&t.length,t.length>>8,0,0,0,0]))+e+t).length%2&&(r+="\0"),r})(i.embedMeta,S.pxtc.decodeBase64(i.embedBlob)),!s.target.noSourceInFlash)&&s.packedSource.length<4e4&&(n+=(t=>{let r="";for(let e=0;e<t.length;++e){var n=255&t.charCodeAt(e);r+=n<=15?"0"+n.toString(16):n.toString(16)}return`
    .balign 16
    .object _stored_program
_stored_program: .hex ${r}
`})(s.packedSource),s.packedSource=null),k.flashCodeAlign(i.target));if(!a&&i.target.flashChecksumAddr){let e=0;for(;o>1<<e;)e++;var l=parseInt(k.hexTemplateHash().slice(8,16),16),c=k.getStartAddress()/o,l=4294967040&l|e;let t=0,r=c;i.target.flashChecksumAddr<k.getStartAddress()&&(t=Math.ceil((i.target.flashChecksumAddr+32)/o),r-=t),n+=`
    .balign 4
__end_marker:
    .word ${l}

; ------- this will get removed from the final binary ------
__flash_checksums:
    .word 0x87eeb07c ; magic
    .word __end_marker ; end marker position
    .word ${l} ; end marker
    ; template region
    .short ${t}, ${r}
    .word 0x${k.hexTemplateHash().slice(0,8)}
    ; user region
    .short ${c}, 0xffff
    .hex 87326633 ; replaced later
    .word 0x0 ; terminator
`}let t=i.extinfo.outputPrefix||"",u=(s.writeFile(t+I.BINARY_ASM,n),T(i.target,s,n,e));if(u.thumbFile.commPtr&&(s.commSize=u.thumbFile.commPtr-k.getCommBase()),u.src&&s.writeFile(t+I.BINARY_ASM,u.src),a)y();else{l=e.configData||[];if(l.some(e=>"BOOTLOADER_BOARD_ID"==e.name)){let e=`const uint32_t configData[] = {
`;e=(e+=`    0x1e9e10f1, 0x20227a79, // magic
`)+`    ${l.length}, 0, // num. entries; reserved
`;for(var r of l)e+=`    ${r.key}, 0x${r.value.toString(16)}, // ${r.name}
`;e+="    0, 0\n};\n",s.writeFile(t+"config.c",e)}if(u.buf){var p=u.buf;let t="";for(let e=0;e<p.length;++e)t+=String.fromCharCode(255&p[e],p[e]>>8);let r=I.U.sha256(t).slice(0,16);var d=I.U.range(4).map(e=>parseInt(r.slice(2*e,2*e+2),16));I.U.assert(12935==p[12]);for(let e=0;e<d.length;++e)p[12+e]=d[e];i.target.flashChecksumAddr&&(c=u.thumbFile.lookupLabel("__flash_checksums")/2,I.U.assert(c==p.length-16),n=p.slice(p.length-16),p.splice(p.length-16,16),a=Math.ceil(2*p.length/o),I.U.assert(12935==n[n.length-4]),n[n.length-4]=d[0],n[n.length-3]=d[1],n[n.length-5]=a,s.checksumBlock=n),y()}if(!e.procDebugInfo){for(var m of e.breakpoints){var f=I.U.lookup(u.thumbFile.getLabels(),"__brkp_"+m.id);null!=f&&(m.binAddr=f)}for(var h of s.procs)h.fillDebugInfo(u.thumbFile);if(e.procDebugInfo=s.procs.map(e=>e.debugInfo),s.target.switches.size){var g,b=[];for(g of s.procs){var x=S.pxtc.nodeLocationInfo(g.action),x=[x.fileName.replace("pxt_modules/",""),I.getDeclName(g.action),g.debugInfo.size,"function",x.line+1];b.push(x.map(e=>`"${e}"`).join(","))}b.sort(),b.unshift("filename,name,size,type,line"),s.writeFile(t+"size.csv",b.join("\n"))}}}function y(){var e;pxt.isOutputText(I.target)?(e=k.patchHex(s,u.buf,!1,!1).join("\r\n")+"\r\n",s.writeFile(t+pxt.outputName(I.target),e)):(e=S.pxtc.encodeBase64(k.patchHex(s,u.buf,!1,!!I.target.useUF2)[0]),s.writeFile(t+pxt.outputName(I.target),e))}}I.assemble=T,I.processorEmit=function(e,t,r){var n,s=c(e,0,r),i=I.U.flatClone(t);if(k.setupFor(t.target,t.extinfo||I.emptyExtInfo(),r),p(s,e,t,r),r.builtVariants||(r.builtVariants=[]),r.builtVariants.push(null==(t=t.extinfo)?void 0:t.appVariant),(t=i.otherMultiVariants||[]).length)try{for(var a of t){var o=I.U.flatClone(i);o.extinfo=a.extinfo,a.target.isNative=!0,o.target=a.target,k.setupFor(o.target,o.extinfo,r),p(s,e,o,r),r.builtVariants.push(null==(n=a.extinfo)?void 0:n.appVariant)}}finally{k.setupFor(i.target,i.extinfo,r)}},I.validateShim=k.validateShim}})(ts=ts||{}),(e=>{(e.pxtc||(e.pxtc={})).getHelpForKeyword=function(e,t){var r={abstract:null,any:null,as:null,break:null,case:null,catch:null,class:null,continue:null,const:null,constructor:null,debugger:null,declare:null,delete:null,do:null,else:null,enum:null,export:null,extends:null,false:lf("Represents the negative outcome of a logical expression"),finally:null,for:null,from:null,function:null,get:null,if:null,implements:null,in:null,instanceof:null,interface:null,is:null,let:null,namespace:null,new:null,null:null,private:null,protected:null,public:null,return:null,set:null,static:null,super:null,switch:null,this:null,throw:null,true:lf("Represents the positive outcome of a logical expression"),try:null,type:null,typeof:null,undefined:null,void:null,while:null,with:null,of:null};return(t?{True:r.true,False:r.false,None:null,abs:null,all:null,any:null,ascii:null,bin:null,bool:null,bytearray:null,bytes:null,callable:null,chr:null,classmethod:null,compile:null,complex:null,copyright:null,credits:null,delattr:null,dict:null,dir:null,divmod:null,enumerate:null,eval:null,exec:null,exit:null,filter:null,float:null,format:null,frozenset:null,getattr:null,globals:null,hasattr:null,hash:null,help:null,hex:null,id:null,input:null,int:null,isinstance:null,issubclass:null,iter:null,len:null,license:null,list:null,locals:null,map:null,max:null,memoryview:null,min:null,next:null,object:null,oct:null,open:null,ord:null,pow:null,print:null,property:null,quit:null,range:null,repr:null,reversed:null,round:null,set:null,setattr:null,slice:null,sorted:null,staticmethod:null,str:null,sum:null,super:null,tuple:null,type:null,vars:null}:r)[e]}})(ts=ts||{}),(e=>{(e.pxtc||(e.pxtc={})).LSHost=class{constructor(e){this.p=e}getCompilationSettings(){var e=this.p.getCompilerOptions();return e.noLib=!0,e}getNewLine(){return"\n"}getScriptFileNames(){return this.p.getSourceFiles().map(e=>e.fileName)}getScriptVersion(e){return"0"}getScriptSnapshot(e){let t=this.p.getSourceFile(e);return{getLength:()=>t.getFullText().length,getText:()=>t.getFullText(),getChangeRange:()=>{}}}getCurrentDirectory(){return"."}getDefaultLibFileName(e){return""}useCaseSensitiveFileNames(){return!0}}})(ts=ts||{}),(w=>{var E,N;function A(e){e=null==(e=null==(e=null==e?void 0:e.pxt)?void 0:e.callInfo)?void 0:e.qName;return N.lastApiInfo.apis.byQName[e]}function _(t,r,n){if(t&&!(r<0)){let e=t.parameters[r];return e=t.attributes._def&&(t=t.attributes._def.parameters[r].shadowBlockId)&&(r=n.blocksById[t],"TD_ID"===(n=N.lastApiInfo.apis.byQName[r.qName]).attributes.shim)&&1===n.parameters.length?n.parameters[0]:e}}function K(e,t,r,n,i=!1){let a={};n.forEach(e=>{let t,r,n=e.symbol.retType;var s;i&&(7==e.symbol.kind?n=e.symbol.namespace:4==e.symbol.kind&&1<(null==(s=null==(r=null==(t=e.symbol.attributes)?void 0:t.enumIdentity)?void 0:r.split("."))?void 0:s.length)&&(n=s[0])),a[n]=[...a[n]||[],e]});var s,n=a[e]||[];let o=[];for(s of n){var l=c(s.symbol,t,w.SymbolFlags.Enum);if(l){l=r.getTypeOfSymbolAtLocation(l,t);let e=E.getEnumMembers(r,l).map(e=>E.enumMemberToQName(r,e)).map(e=>N.lastApiInfo.apis.byQName[e]);o=[...o,...e]}}return[...n,...F(o,1)]}function i(e){return e.flags&w.SymbolFlags.Variable?4:e.flags&w.SymbolFlags.Class?8:e.flags&w.SymbolFlags.Enum?6:e.flags&w.SymbolFlags.EnumMember?7:e.flags&w.SymbolFlags.Method?1:e.flags&w.SymbolFlags.Module?5:e.flags&w.SymbolFlags.Property?2:0}function $(e){return{kind:0,name:e,pyName:e,qName:e,pyQName:e,namespace:"",attributes:{callingConvention:0,paramDefl:{}},fileName:pxt.MAIN_TS,parameters:[],retType:"any"}}function C(e,t){var r=e.getName(),n=/(.*)\.(.*)/.exec(r),s=n?n[2]:r,n=n?n[1]:"",t=null!=(t=null==(t=t.getSymbol())?void 0:t.getName())?t:"any";return{kind:i(e),name:s,pyName:s,qName:r,pyQName:r,namespace:n,attributes:{callingConvention:0,paramDefl:{}},fileName:pxt.MAIN_TS,parameters:[],retType:t}}function U(e,t,r){if(e)return t.byQName[r.getFullyQualifiedName(e)]}function P(e,t){return e.weight!==t.weight?t.weight-e.weight:E.compareSymbols(e.symbol,t.symbol)}function L(e,t){return{symbol:e,weight:t}}function F(e,t){return e.map(e=>L(e,t))}function O(e,t){return e.flags&w.TypeFlags.NumberLiteral?"Number":e.flags&w.TypeFlags.StringLiteral?"String":e.flags&w.TypeFlags.BooleanLiteral?"Boolean":null!=(e={number:"Number",string:"String",boolean:"Boolean"}[t=t.typeToString(e)])?e:t}function n(e,t){return"."===t.charAt(0)&&(t=t.substr(1)),e.substr(0,e.lastIndexOf(".")+1)+t}function c(e,t,r){var n,s=N.service&&N.service.getProgram().getTypeChecker();if(s)for(n of s.getSymbolsInScope(t,r))if(n.escapedName.toString()===e.qName)return n;return null}function M({symbol:e}){return!(/^__/.test(e.name)||/^__/.test(e.namespace)||e.attributes.hidden||e.attributes.deprecated||"TD_ID"==e.attributes.shim||e.attributes.blockAliasFor)}E=w.pxtc||(w.pxtc={}),(N=E.service||(E.service={})).getCallSymbol=A,N.getParameter=_,N.getApisForTsType=K,N.getBasicKindDefault=function(e,t){switch(e){case E.SK.StringKeyword:return'""';case E.SK.NumberKeyword:return"0";case E.SK.BooleanKeyword:return t?"False":"false";case E.SK.ArrayType:return"[]";case E.SK.NullKeyword:return t?"None":"null";default:return}},N.tsSymbolToPxtSymbolKind=i,N.makePxtSymbolFromKeyword=$,N.makePxtSymbolFromTsSymbol=C,N.getPxtSymbolFromTsSymbol=U,N.compareCompletionSymbols=P,N.completionSymbol=L,N.completionSymbols=F,N.getNodeAndSymbolAtLocation=function(e,t,r,n){if(t=e.getSourceFile(t),e=e.getTypeChecker(),t=E.findInnerMostNodeAtPosition(t,r)){r=e.getSymbolAtLocation(t);if(r)return[t,U(r,n,e)]}return null},N.tsTypeToPxtTypeString=O,N.filenameWithExtension=n,N.getWordAtPosition=function(t,e){let r=e,n=e;for(;0<r&&s(r);)--r;for(;n<t.length-1&&s(n);)++n;return r!=n?{text:t.substring(r+1,n),start:r+1,end:n}:null;function s(e){e=t.charCodeAt(e);return 65<=e&&e<=90||97<=e&&e<=122}},N.getTsSymbolFromPxtSymbol=c,N.getDefaultEnumValue=function(e,t){var r,n,s,i=N.service&&N.service.getProgram().getTypeChecker();for(r of E.getEnumMembers(i,e))if(r.name.kind===E.SK.Identifier)return n=E.enumMemberToQName(i,r),(s=N.lastApiInfo.apis.byQName[n])?s.attributes.alias?t&&s.attributes.pyAlias||s.attributes.alias:t?s.pyQName:s.qName:n;return"0"},N.getCompletions=function(d){let m,f,{fileName:e,fileContent:t,position:r,wordStartPos:h,wordEndPos:i,runtime:g}=d,b=t,x=(t&&N.host.setFile(e,t),n(e,"ts"));var y={startPos:h,endPos:i};let k=/\.py$/.test(e);var S={entries:[],isMemberCompletion:!1,isNewIdentifierLocation:!0,isTypeLocation:!1,namespace:[]},v=b.lastIndexOf("\n",r-1),v=Math.max(0,v),v=b.substring(v+1,r),T=k?"#":"//";if(!v.trim().startsWith(T)){let n=-1,t=-1;for(let e=r-1;0<=e;--e){if("."==b[e]){n=e;break}if(!/\w/.test(b[e]))break;-1==t&&(t=e)}n==r-1?b=b.slice(0,r)+"_"+b.slice(r):-1==t&&(b=b.slice(0,r)+"_"+b.slice(r),t=r);let s=-1!==n,a=(S.isMemberCompletion=s)?b.slice(n+1,i):b.slice(h,i);s&&(t=n);let o={};v=N.cloneCompileOpts(N.host.opts);v.fileSystem[e]=b,N.addApiInfo(v),v.syntaxInfo={position:t,type:S.isMemberCompletion?"memberCompletion":"identifierCompletion"};let l=[],c;if(k){let t=E.transpile.pyToTs(v);t.syntaxInfo&&t.syntaxInfo.symbols&&(l=F(t.syntaxInfo.symbols,1)),t.globalNames&&(N.lastGlobalNames=t.globalNames),!l.length&&t.globalNames&&(l=F(pxt.U.values(t.globalNames),1)),Object.keys(t.outfiles).forEach(e=>{e===x&&N.host.setFile(e,t.outfiles[e])}),t.sourceMap&&(T=b,I=t.outfiles[x]||"",I=E.BuildSourceMapHelpers(t.sourceMap,I,T).py.smallestOverlap(y))&&(c=I.ts.startPos),!s&&50<l.length&&(l=l.filter(e=>0<=(k?e.symbol.pyQName:e.symbol.qName).toLowerCase().indexOf(a.toLowerCase()))),v.ast=!0,E.compile(v,N.service)}else{c=r,v.ast=!0,N.host.setOpts(v);N.runConversionsAndCompileUsingService()}T=N.service.getProgram(),y=T.getSourceFile(x);let u=T.getTypeChecker(),p=E.findInnerMostNodeAtPosition(y,c);var I=E.decompiler.buildCommentMap(y).some(e=>e.start<=r&&r<=e.end);if(!I){if(p)if([E.SK.StringLiteral,E.SK.FirstTemplateToken,E.SK.NoSubstitutionTemplateLiteral].some(e=>p.kind===e))return S;S.namespace=E.getCurrentNamespaces(p);let r=!1;if(s){v=E.findInnerMostNodeAtPosition(y,k?c:n-1);if(v){let e;T=u.getSymbolAtLocation(v);if(e=0<(null==(m=null==T?void 0:T.members)?void 0:m.size)?u.getDeclaredTypeOfSymbol(T):T?u.getTypeOfSymbolAtLocation(T,v):u.getTypeAtLocation(v)){let t=e.symbol?u.getFullyQualifiedName(e.symbol):O(e,u);t&&(I=e.getApparentProperties().map(e=>t+"."+e.getName()).map(e=>N.lastApiInfo.apis.byQName[e]).filter(e=>!!e).map(e=>L(e,1)),l=I,r=!0)}}}T=pxt.U.values(N.lastApiInfo.apis.byQName);if(0===l.length&&(v=T.filter(e=>0<=(k?e.pyQName:e.qName).toLowerCase().indexOf(a.toLowerCase())),l=F(v,1)),!k&&!r){p=(p=E.findInnerMostNodeAtPosition(y,h))||y.getSourceFile();I=w.SymbolFlags.Variable;let e=u.getSymbolsInScope(p,I),t=p.getText();T=(e="_"!==t?e.filter(e=>0<=e.name.indexOf(t)):e).map(e=>{let t=U(e,N.lastApiInfo.apis,u);var r;return t||(r=u.getTypeOfSymbolAtLocation(e,p),t=C(e,r)),t}).filter(e=>!!e).map(e=>L(e,1));T.forEach(e=>e.weight+=5),l=[...l,...T]}v=E.getParentCallExpression(p);if(v){let t=E.findCurrentCallArgIdx(v,p,c);if(0<=t){let e=N.blocksInfoOp(N.lastApiInfo.apis,g.bannedCategories);y=A(v);y&&(I=_(y,t=t>=y.parameters.length?y.parameters.length-1:t,e))&&K(I.type,v,u,l,I.isEnum).forEach(e=>e.weight=10)}}if(!s){let e;y=(e=k?(T=pxt.py.keywords,Object.keys(T)):[...ts.pxtc.reservedWords,...ts.pxtc.keywordTypes]).filter(e=>0<=e.indexOf(a)).map($).map(e=>L(e,0));l=[...l,...y]}let e={};e=k&&N.lastGlobalNames?N.lastGlobalNames:N.lastApiInfo.apis.byQName,l.map(e=>!e.symbol.attributes.alias||s&&7===e.symbol.kind?e:L(N.lastApiInfo.apis.byQName[e.symbol.attributes.alias],e.weight)).filter(M).forEach(e=>{o[e.symbol.qName]=e}),(l=pxt.Util.values(o).filter(e=>!!e&&!!e.symbol)).sort(P),d.light&&100<l.length&&(l=l.splice(0,100));var{bannedCategories:v,screenSize:I}=d.runtime;let t=N.blocksInfoOp(N.lastApiInfo.apis,v),i={takenNames:e,blocksInfo:t,screenSize:I,apis:N.lastApiInfo.apis,checker:null==(f=null==N.service?void 0:N.service.getProgram())?void 0:f.getTypeChecker()};l.forEach(e=>{var t,e=e.symbol,r=k,n=i,s=N.lastApiInfo.decls[e.qName];w.isFunctionLike(s)&&(e.snippetAddsDefinitions||r&&!e.pySnippet||!r&&!e.snippet)&&(n=N.getSnippet(n,e,s,r),s=N.snippetStringify(n),t=N.snippetStringify(n,!0),n=N.snippetAddsDefinitions(n),r?(e.pySnippet=s,e.pySnippetWithMarkers=t):(e.snippet=s,e.snippetWithMarkers=t),e.snippetAddsDefinitions=n)}),S.entries=l.map(e=>e.symbol)}}return S}})(ts=ts||{}),(o=>{{var a=o.pxtc||(o.pxtc={});let r=function(e){e=t(e);o.sys.write(e)};function l(e){for(var t of e)r(t)}function t(e){let n;var t,r,s;n=void 0!==e.file?({line:r,character:s}=o.getLineAndCharacterOfPosition((t=e).file,t.start),i=t.file.fileName,Object.assign({fileName:i,line:r,column:s},t)):Object.assign({fileName:void 0,line:void 0,column:void 0},e);{var i=n;let e="",t=(i.fileName&&(e+=i.fileName+`(${i.line+1},${i.column+1}): `),o.sys?o.sys.newLine:"\n"),r=a.DiagnosticCategory[i.category].toLowerCase();return e+=`${r} TS${i.code}: `+a.flattenDiagnosticMessageText(i.messageText,t)+t}}function n(e,t){var r=o.createCompilerHost(t),e=(r.getDefaultLibFileName=()=>"node_modules/pxt-core/pxtcompiler/ext-typescript/lib/lib.d.ts",o.createProgram(e,t,r));return e}function c(e){let t=e.getSyntacticDiagnostics();return(t=0===t.length&&0===(t=e.getOptionsDiagnostics().concat(a.Util.toArray(e.getGlobalDiagnostics()))).length?e.getSemanticDiagnostics():t).slice(0)}a.getDiagnosticString=t,a.plainTscCompileDir=function(s){let i=o.parseCommandLine([]),a=o.findConfigFile(s,o.sys.fileExists);var e=(()=>{let e=o.sys.readFile(a),t=o.parseConfigFileTextToJson(a,e),r=t.config;if(r){var n=o.parseJsonConfigFileContent(r,o.sys,s,i.options,a);if(!(0<n.errors.length))return n;l(n.errors)}else l([t.error]);o.sys.exit(o.ExitStatus.DiagnosticsPresent_OutputsSkipped)})();return c(e=n(e.fileNames,e.options)).forEach(r),e},a.plainTscCompileFiles=n,a.getProgramDiagnostics=c}})(ts=ts||{}),(h=>{{var g=h.pxtc||(h.pxtc={});function b(e){if(!e||!e.kind)return null;switch(e.kind){case h.SyntaxKind.StringKeyword:return"str";case h.SyntaxKind.NumberKeyword:return"number";case h.SyntaxKind.BooleanKeyword:return"bool";case h.SyntaxKind.VoidKeyword:return"None";case h.SyntaxKind.FunctionType:return r=b((t=e).type),`(${(t=t.parameters.map(e=>e.type).map(b)).join(", ")}) -> `+r;case h.SyntaxKind.ArrayType:return`List[${b(e.elementType)}]`;case h.SyntaxKind.TypeReference:t=e;return t.typeName&&t.typeName.getText?t.typeName.getText():"";case h.SyntaxKind.AnyKeyword:return"any";default:return pxt.tickEvent("depython.todo.tstypenodetopytype",{kind:e.kind}),""}var t,r}function x(e){if(!e||!e.flags)return null;switch(e.flags){case h.TypeFlags.String:return"str";case h.TypeFlags.Number:return"number";case h.TypeFlags.Boolean:return"bool";case h.TypeFlags.Void:return"None";case h.TypeFlags.Any:return"any";default:return pxt.tickEvent("depython.todo.tstypetopytype",{kind:e.flags}),""}}function y(d,r,n){function m(e,t,r=!1){let n=d.getTypeAtLocation(t);if(!n)return"None";r&&(n=n.getCallSignatures()[0].getReturnType());t=d.typeToString(n,void 0,h.TypeFormatFlags.UseFullyQualifiedType);return/^\d/.test(t)?"number":"this"==t?k(d,n.symbol):t}var s=(e=>{switch(e.kind){case g.SK.MethodDeclaration:case g.SK.MethodSignature:return 1;case g.SK.PropertyDeclaration:case g.SK.PropertySignature:case g.SK.GetAccessor:case g.SK.SetAccessor:return 2;case g.SK.Constructor:case g.SK.FunctionDeclaration:return 3;case g.SK.VariableDeclaration:return 4;case g.SK.ModuleDeclaration:return 5;case g.SK.EnumDeclaration:return 6;case g.SK.EnumMember:return 7;case g.SK.ClassDeclaration:return 8;case g.SK.InterfaceDeclaration:return 9;default:return 0}})(n);if(0==s)return null;{var i=n;let p=g.parseComments(i);if(p.weight<0)return null;var a=/^(.*)\.(.*)/.exec(r),o=3==s||1==s;let e=null;var l=h.getSourceFileOfNode(n);l&&(l=/^pxt_modules\/([^\/]+)/.exec(l.fileName))&&(e=l[1]);let t=void 0;if(8==s||9==s)if(t=[],n.heritageClauses)for(var c of n.heritageClauses)if(c.types)for(var u of c.types)t.push(m(0,u));6!=s&&7!==s||(t=t||[]).push("Number");var f={kind:s,qName:r,namespace:a?a[1]:"",name:a?a[2]:r,fileName:n.getSourceFile().fileName,attributes:p,pkg:e,pkgs:null,extendsTypes:t,isStatic:null==(l=i.modifiers)?void 0:l.some(e=>e.kind===h.SyntaxKind.StaticKeyword),retType:n.kind==h.SyntaxKind.Constructor?"void":5==s?"":m(i.type,i,o),parameters:o?g.Util.toArray(i.parameters).map((r,e)=>{var t=g.getName(r),n=p.paramHelp[t]||"",s=p.paramMin&&p.paramMin[t],i=p.paramMax&&p.paramMax[t];/\beg\.?:\s*(.+)/.exec(n);let a,o;if(r.type&&r.type.kind===g.SK.FunctionType){let t=d.getSignatureFromDeclaration(r.type).getParameters();"objectdestructuring"===p.mutate?(g.assert(0<t.length),a=d.getTypeAtLocation(t[0].valueDeclaration).getProperties().map(e=>({name:e.getName(),type:d.typeToString(d.getTypeOfSymbolAtLocation(e,t[0].valueDeclaration))}))):o=t.map((e,t)=>({name:e.getName(),type:d.typeToString(d.getTypeOfSymbolAtLocation(e,r),void 0,h.TypeFormatFlags.UseFullyQualifiedType)}))}var l={},c=d.getTypeAtLocation(r),u=c&&!!(c.flags&(h.TypeFlags.Enum|h.TypeFlags.EnumLiteral));if(p.block&&p.paramShadowOptions){let r=[];p.block.replace(/%(\w+)/g,(e,t)=>(r.push(t),"")),p.paramShadowOptions[r[e]]&&(l.fieldEditorOptions={value:p.paramShadowOptions[r[e]]})}s&&(l.min={value:s}),i&&(l.max={value:i});e=r.type&&b(r.type)||c&&x(c)||"unknown",s=r.initializer?r.initializer.getText():g.getExplicitDefault(p,t)||(r.questionToken?"undefined":void 0);return{name:t,description:n,type:m(0,r),pyTypeString:e,initializer:s,default:p.paramDefl[t],properties:a,handlerParameters:o,options:l,isEnum:u}}):null,snippet:h.isFunctionLike(n)?null:void 0};switch(f.kind){case 7:f.pyName=g.U.snakify(f.name).toUpperCase();break;case 4:case 1:case 2:case 3:f.pyName=g.U.snakify(f.name);break;default:f.pyName=f.name}return n.kind!==g.SK.GetAccessor&&(n.kind!==g.SK.PropertyDeclaration&&n.kind!==g.SK.PropertySignature||!g.isReadonly(n))||(f.isReadOnly=!0),f}}function i(e){return!!e.attributes.block&&!!e.attributes.blockId}g.placeholderChar="",g.ts2PyFunNameMap={"Math.trunc":{n:"int",t:h.SyntaxKind.NumberKeyword,snippet:"int(0)"},"Math.min":{n:"min",t:h.SyntaxKind.NumberKeyword,snippet:"min(0, 0)"},"Math.max":{n:"max",t:h.SyntaxKind.NumberKeyword,snippet:"max(0, 0)"},"Math.abs":{n:"abs",t:h.SyntaxKind.NumberKeyword,snippet:"abs(0)"},"console.log":{n:"print",t:h.SyntaxKind.VoidKeyword,snippet:'print(":)")'},".length":{n:"len",t:h.SyntaxKind.NumberKeyword},".toLowerCase()":{n:"string.lower",t:h.SyntaxKind.StringKeyword},".toUpperCase()":{n:"string.upper",t:h.SyntaxKind.StringKeyword},".charCodeAt(0)":{n:"ord",t:h.SyntaxKind.NumberKeyword},"pins.createBuffer":{n:"bytearray",t:h.SyntaxKind.Unknown},"pins.createBufferFromArray":{n:"bytes",t:h.SyntaxKind.Unknown},"control.createBuffer":{n:"bytearray",t:h.SyntaxKind.Unknown},"control.createBufferFromArray":{n:"bytes",t:h.SyntaxKind.Unknown},"!!":{n:"bool",t:h.SyntaxKind.BooleanKeyword},"Array.push":{n:"Array.append",t:h.SyntaxKind.Unknown},parseInt:{n:"int",t:h.SyntaxKind.NumberKeyword,snippet:'int("0")'},"_py.range":{n:"range",t:h.SyntaxKind.Unknown,snippet:"range(4)"}},g.emitPyTypeFromTypeNode=b,g.emitPyTypeFromTsType=x,g.genDocs=function(n,e,s={}){pxt.debug("generating docs for "+n),pxt.debug(JSON.stringify(Object.keys(e.byQName),null,2));let i={};var r=g.Util.values(e.byQName),e=r.filter(e=>7==e.kind).sort(c);let a={},o={},l={};var t=(r,e)=>{if(s.locs){let t={};Object.keys(r).sort().forEach(e=>t[e]=r[e]),i[n+e+"-strings.json"]=JSON.stringify(t,null,2)}};for(let t of r){if(5==t.kind){if(!r.filter(e=>e.namespace==t.name&&!!e.attributes.jsDoc)[0])continue;t.attributes.block||(t.attributes.block=t.name)}(t=>{var e;if(s.locs&&t.qName&&(!/^__/.test(t.name)&&(pxt.debug("loc: "+t.qName),7!=t.kind&&(r=h.pxtc.blocksCategory(t))&&(o["{id:category}"+r]=r),t.attributes.jsDoc&&(l[t.qName]=t.attributes.jsDoc),t.attributes.group&&(o["{id:group}"+t.attributes.group]=t.attributes.group),t.attributes.subcategory&&(o["{id:subcategory}"+t.attributes.subcategory]=t.attributes.subcategory),t.parameters&&t.parameters.filter(e=>!!e.description).forEach(e=>{l[t.qName+"|param|"+e.name]=e.description}),t.attributes.block))){o[t.qName+"|block"]=t.attributes.block;var r=pxt.blocks.compileInfo(t);if(null!=(e=r.handlerArgs)&&e.length)for(var n of r.handlerArgs)o[n.localizationKey]=n.name}})(t)}return s.locs&&e.forEach(e=>{e.attributes.block&&(o[e.qName+"|block"]=e.attributes.block),e.attributes.jsDoc&&(o[e.qName]=e.attributes.jsDoc)}),t(o,""),t(l,"-jsdoc"),s.pxtsnippet&&(s.pxtsnippet.forEach(t=>{{var r=a;let e=["label","title","hint","errorMessage"];r[t.label]=t.label,t.questions.forEach(t=>{e.forEach(e=>{t[e]&&(r[t[e]]=t[e])})})}}),t(a,"-snippet")),i},g.hasBlock=i;let s;function c(t,r){function e(e){return-e(t)+e(r)}var n=e(e=>i(e)?1:-1);return n||e(e=>e.namespace?-1:1)||(s=s||{4:100,5:101,3:99,2:98,1:97,8:89,6:81,7:80},e(e=>s[e.kind]||0)||e(e=>e.attributes.weight||50))||g.U.strcmp(t.name,r.name)}function n(e,t,r=!1){let a={byQName:{},jres:t},o={},l=e.getTypeChecker(),c=n=>{if(n.kind==g.SK.VariableStatement)n.declarationList.declarations.forEach(c);else{if(g.isExported(n)){if(!n.symbol)return void pxt.warn("no symbol",n);let e=k(l,n.symbol),r=(n.kind==g.SK.SetAccessor&&(e+="@set"),o[e]=n,y(l,e,n));if(r){let t=g.U.lookup(a.byQName,e);if(t)if(9==t.kind&&9!=r.kind)a.byQName[e+"@type"]=t;else if(9!=t.kind&&9==r.kind)a.byQName[e+"@type"]=r,r=t;else{var s=null==(s=t.attributes._source)?void 0:s.trim(),i=null==(i=r.attributes._source)?void 0:i.trim();let e=s+"\n"+i;s&&0<=(null==i?void 0:i.indexOf(s))?e=i:i&&0<=(null==s?void 0:s.indexOf(i))&&(e=s),r.attributes=g.parseCommentString(e),5===t.kind&&(r.pkgs=t.pkgs||[],t.pkg===r.pkg||r.pkgs.find(e=>e===t.pkg)||r.pkgs.push(t.pkg)),t.extendsTypes&&(r.extendsTypes=r.extendsTypes||[],t.extendsTypes.forEach(e=>{-1===r.extendsTypes.indexOf(e)&&r.extendsTypes.push(e)}))}!n.parent||n.parent.kind!=g.SK.ClassDeclaration&&n.parent.kind!=g.SK.InterfaceDeclaration||g.isStatic(n)||(r.isInstance=!0),a.byQName[e]=r}}n.kind==g.SK.ModuleDeclaration?(i=n).body.kind==g.SK.ModuleBlock?i.body.statements.forEach(c):i.body.kind==g.SK.ModuleDeclaration&&c(i.body):n.kind!=g.SK.InterfaceDeclaration&&n.kind!=g.SK.ClassDeclaration&&n.kind!=g.SK.EnumDeclaration||n.members.forEach(c)}};for(var n of e.getSourceFiles())n.statements.forEach(c);var s,i=[];for(s in a.byQName){var u,p,d=a.byQName[s];d.qName=s,d.attributes._source=null,d.extendsTypes&&d.extendsTypes.length&&i.push(d);let e=d.attributes.jres;e&&("true"==e&&(e=s),(u=g.U.lookup(t||{},e))&&u.icon&&!d.attributes.iconURL&&(d.attributes.iconURL=u.icon),u)&&u.data&&!d.attributes.jresURL&&(d.attributes.jresURL="data:"+u.mimeType+";base64,"+u.data),d.pyName&&((u=g.U.lookup(g.ts2PyFunNameMap,d.qName))&&u.n?(d.pyQName=u.n,d.pySnippet=u.snippet,d.pySnippetName=u.n,d.pySnippetWithMarkers=void 0):d.namespace?(p=a.byQName[d.namespace])?d.pyQName=p.pyQName+"."+d.pyName:(pxt.log("namespace missing: "+d.namespace),d.pyQName=d.namespace+"."+d.pyName):d.pyQName=d.pyName)}let m={},f=e=>{if(!g.U.lookup(m,e.qName)){m[e.qName]=!0;var t,r={};r[e.qName]=!0;for(t of e.extendsTypes||[]){r[t]=!0;var n=a.byQName[t];if(n){f(n);for(var s of n.extendsTypes)r[s]=!0}}e.extendsTypes=Object.keys(r)}};return i.forEach(f),r&&delete a.byQName["Array.map"],{apis:a,decls:o}}function k(e,t){return t.isBogusSymbol?t.name:e.getFullyQualifiedName(t)}g.compareSymbols=c,g.getApiInfo=function(e,t,r=!1){return n(e,t,r).apis},g.internalGetApiInfo=n,g.getFullName=k}})(ts=ts||{}),(c=>{var u=c.pxtc||(c.pxtc={});{var p=u.service||(u.service={});let e={fileSystem:{},sourceFiles:[],target:{isNative:!1,hasHex:!1,switches:{}}};class i{constructor(){this.opts=e,this.fileVersions={},this.projectVer=0,this.pxtModulesOK=null}getProjectVersion(){return this.projectVer+""}setFile(e,t){this.opts.fileSystem[e]!=t&&(this.fileVersions[e]=(this.fileVersions[e]||0)+1,this.opts.fileSystem[e]=t,this.projectVer++)}reset(){this.setOpts(e),this.pxtModulesOK=null}setOpts(e){u.Util.iterMap(e.fileSystem,(e,t)=>{this.opts.fileSystem[e]!=t&&(this.fileVersions[e]=(this.fileVersions[e]||0)+1)}),this.opts=Object.assign(Object.assign({},e),{fileSystem:Object.assign({},e.fileSystem)}),this.projectVer++}getCompilationSettings(){return u.getTsCompilerOptions(this.opts)}getScriptFileNames(){return this.opts.sourceFiles.filter(e=>u.U.endsWith(e,".ts"))}getScriptVersion(e){return(this.fileVersions[e]||0).toString()}getScriptSnapshot(e){e=this.opts.fileSystem[e];return null!=e?c.ScriptSnapshot.fromString(e):null}getNewLine(){return"\n"}getCurrentDirectory(){return"."}getDefaultLibFileName(e){return"no-default-lib.d.ts"}log(e){pxt.log("LOG",e)}trace(e){pxt.log("TRACE",e)}error(e){pxt.error("ERROR",e)}useCaseSensitiveFileNames(){return!0}}let l,n;function d(e,t){return e?(p.lastLocBlocksInfo||(p.lastLocBlocksInfo=u.getBlocksInfo(e,t)),p.lastLocBlocksInfo):(p.lastBlocksInfo||(p.lastBlocksInfo=u.getBlocksInfo(p.lastApiInfo.apis,t)),p.lastBlocksInfo)}function m(e){return p.lastApiInfo||(p.lastApiInfo=u.internalGetApiInfo(p.service.getProgram(),e.jres)),p.lastApiInfo}function f(e){var t;e.apisInfo||(t=m(e),e.apisInfo=u.U.clone(t.apis))}function h(e){e=pxt.U.flatClone(e);return e.fileSystem=pxt.U.flatClone(e.fileSystem),e}p.blocksInfoOp=d,p.getLastApiInfo=m,p.addApiInfo=f,p.cloneCompileOpts=h,p.IsOpErr=function(e){return!!e.errorMessage};let s={reset:()=>{p.service=c.createLanguageService(p.host),p.lastApiInfo=void 0,p.lastGlobalNames=void 0,p.host.reset()},setOptions:e=>{p.host.setOpts(e.options)},syntaxInfo:e=>{var r=e.fileContent,n=(e.fileContent&&p.host.setFile(e.fileName,e.fileContent),h(p.host.opts));n.fileSystem[e.fileName]=r,f(n),n.syntaxInfo={position:e.position,type:e.infoType};let s=e.fileName.endsWith(".py");var t,i,a,r="symbol"===n.syntaxInfo.type,o="signature"===n.syntaxInfo.type;if(s?(t=u.transpile.pyToTs(n)).globalNames&&(p.lastGlobalNames=t.globalNames):(n.ast=!0,p.host.setOpts(n),g(),i=(t=p.service.getProgram()).getSourceFile(e.fileName),t=t.getTypeChecker(),(r||o)&&(i=u.findInnerMostNodeAtPosition(i,e.position))&&(r?(a=t.getSymbolAtLocation(i))&&(a=p.getPxtSymbolFromTsSymbol(a,n.apisInfo,t),n.syntaxInfo.symbols=[a],n.syntaxInfo.beginPos=i.getStart(),n.syntaxInfo.endPos=i.getEnd()):o&&(a=null==(t=null==i?void 0:i.pxt)?void 0:t.callInfo)&&(o=n.apisInfo.byQName[a.qName],n.syntaxInfo.symbols=[o],n.syntaxInfo.beginPos=i.getStart(),n.syntaxInfo.endPos=i.getEnd(),t=u.getParentCallExpression(i))&&(a=u.findCurrentCallArgIdx(t,i,e.position),n.syntaxInfo.auxResult=a))),!r||null!=(o=n.syntaxInfo.symbols)&&o.length||(t=p.getWordAtPosition(e.fileContent,e.position))&&(s&&"range"===t.text?(i=m(n).apis).byQName["_py.range"]&&(n.syntaxInfo.symbols=[i.byQName["_py.range"]],n.syntaxInfo.beginPos=t.start,n.syntaxInfo.endPos=t.end):(a=u.getHelpForKeyword(t.text,s))&&(n.syntaxInfo.auxResult={documentation:a,displayString:p.displayStringForKeyword(t.text,s)},n.syntaxInfo.beginPos=t.start,n.syntaxInfo.endPos=t.end)),null!=(o=n.syntaxInfo.symbols)&&o.length){let t=m(n).apis;s&&(n.syntaxInfo.symbols=n.syntaxInfo.symbols.map(e=>t.byQName[e.qName]||e)),r&&(n.syntaxInfo.auxResult=n.syntaxInfo.symbols.map(e=>p.displayStringForSymbol(e,s,t)))}return n.syntaxInfo},getCompletions:e=>p.getCompletions(e),compile:e=>{p.host.setOpts(e.options);e=g();return u.timesToMs(e),e},decompile:e=>(p.host.setOpts(e.options),u.decompile(p.service.getProgram(),e.options,e.fileName,!1)),pydecompile:e=>(p.host.setOpts(e.options),u.transpile.tsToPy(p.service.getProgram(),e.fileName)),decompileSnippets:e=>(p.host.setOpts(e.options),u.decompileSnippets(p.service.getProgram(),e.options,!1)),assemble:e=>({words:u.processorInlineAssemble(p.host.opts.target,e.fileContent)}),py2ts:e=>(f(e.options),u.transpile.pyToTs(e.options)),fileDiags:e=>u.patchUpDiagnostics((e=>{if(!/\.ts$/.test(e))return[];let t=p.service.getSyntacticDiagnostics(e);return t=(t=t&&t.length?t:p.service.getSemanticDiagnostics(e))||[]})(e.fileName)),allDiags:()=>{var e=g();return u.timesToMs(e),p.host.opts.target.switches.time&&pxt.log("DIAG-TIME",e.times),e},format:e=>{e=e.format;return u.format(e.input,e.pos)},apiInfo:()=>{if(p.lastBlocksInfo=void 0,l=void 0,p.host.opts!==e)return p.lastApiInfo=u.internalGetApiInfo(p.service.getProgram(),p.host.opts.jres),p.lastApiInfo.apis},snippet:t=>{var r=t.snippet;if(p.lastApiInfo){var n=p.lastApiInfo.apis.byQName[r.qName],s=p.lastApiInfo.decls[r.qName];if(n&&s&&c.isFunctionLike(s)){r=!!r.python;let e={};e=r&&p.lastGlobalNames?p.lastGlobalNames:p.lastApiInfo.apis.byQName;var{bannedCategories:t,screenSize:i}=t.runtime,a=p.lastApiInfo.apis,o=d(a,t),l=p.service&&p.service.getProgram().getTypeChecker(),a={apis:a,blocksInfo:o,takenNames:e,bannedCategories:t,screenSize:i,checker:l,includeParentSnippet:!0},o=p.getSnippet(a,n,s,r);return p.snippetStringify(o)}}},blocksInfo:e=>d(e,e.blocks&&e.blocks.bannedCategories),apiSearch:n=>{var a=n.search;let c=d(a.localizedApis,n.blocks&&n.blocks.bannedCategories);a.localizedStrings&&pxt.Util.setLocalizedStrings(a.localizedStrings);var e=(t,e,r)=>{if(t)return"string"==typeof t?t:e?t[e]:Object.keys(t).map(e=>t[e]).join(" ")};let u=(t,r=!1,n)=>{var e=(null==(e=t.attributes)?void 0:e.toolboxParent)||(null==(e=t.attributes)?void 0:e.duplicateWithToolboxParent),s=(null==(s=t.attributes)?void 0:s.toolboxParentArgument)||(null==(s=t.attributes)?void 0:s.duplicateWithToolboxParentArgument);if(e&&!r){r=c.blocksById[e];if(r){let e={[s||"*"]:u(t,!0)};return u(r,!0,e)}}if(null!=(e=t.attributes)&&e._def){var i,a=[],s=t.attributes._def,o=pxt.blocks.compileInfo(t);for(i of s.parts)switch(i.kind){case"label":a.push(i.text);break;case"param":var l=o.definitionNameToParam[i.name];let e=(null==l?void 0:l.defaultValue)||i.varName||(null==l?void 0:l.actualName)||i.name;null!=n&&n["*"]?(e=n["*"],delete n["*"]):null!=n&&n[l.definitionName]&&(e=n[l.definitionName]),a.push(e)}return a.join(" ")}return t.attributes.block};if(!p.builtinItems){p.builtinItems=[],p.blockDefinitions=pxt.blocks.blockDefinitions();for(let n in p.blockDefinitions){let r=p.blockDefinitions[n];if(r.operators)for(let t in r.operators)r.operators[t].forEach(e=>p.builtinItems.push({id:n,name:r.name,jsdoc:"string"==typeof r.tooltip?r.tooltip:r.tooltip[e],block:e,field:[t,e],builtinBlock:!0}));else p.builtinItems.push({id:n,name:r.name,jsdoc:e(r.tooltip,r.tooltipSearch,r),block:e(r.block,r.blockTextSearch,r),builtinBlock:!0})}}let o;if(!l||a.subset){let s={},e=[],t=(a.subset&&(p.tbSubset=a.subset,e=p.builtinItems.filter(e=>!!p.tbSubset[e.id])),p.tbSubset?o=c.blocks.filter(e=>!!p.tbSubset[e.attributes.blockId]):(o=c.blocks,e=p.builtinItems),o.map(e=>({id:e.attributes.blockId,qName:e.qName,name:e.name,namespace:e.namespace,block:u(e),params:(e=>{let t,r=null==(t=e.attributes)?void 0:t.paramHelp;return r?Object.keys(r).map(e=>r[e]).join(" "):""})(e),jsdoc:e.attributes.jsDoc,localizedCategory:p.tbSubset&&"string"==typeof p.tbSubset[e.attributes.blockId]?p.tbSubset[e.attributes.blockId]:void 0,dropdownOptions:(t=>{let n=[];return t.parameters&&t.parameters.forEach(r=>{if(r.options&&r.options.fieldEditorOptions&&(e=r.options.fieldEditorOptions.value)&&Array.isArray(e)&&e.forEach(e=>{Array.isArray(e)&&2<=e.length&&("string"==typeof e[0]?n.push(e[0]):"object"==typeof e[0]&&e[0].alt&&n.push(e[0].alt))}),r.isEnum&&r.type){let t=c.apis.byQName[r.type];t&&6===t.kind&&Object.keys(c.apis.byQName).forEach(e=>{e=c.apis.byQName[e];7===e.kind&&e.namespace===t.name&&n.push(e.name)})}var e=c.apis.byQName[r.type];e&&e.attributes.fixedInstances&&pxt.Util.values(c.apis.byQName).filter(e=>4===e.kind&&e.attributes.fixedInstance&&e.retType===r.type).forEach(e=>{e=e.attributes.block||e.attributes.blockId||e.name;n.push(e)}),t.attributes.constantShim&&pxt.Util.values(c.apis.byQName).filter(e=>e.attributes.blockIdentity===t.qName).forEach(e=>{e=e.attributes.block||e.attributes.blockId||e.name;n.push(e)}),"@combined@"===r.type&&t.combinedProperties&&t.combinedProperties.forEach(e=>{var e=c.apis.byQName[e];e&&(e=e.attributes.block||e.attributes.blockId||e.name,n.push(e))})}),n.join(" ")})(e)}))),r={},i=(e.forEach(e=>r[e.id]=!0),t=t.filter(e=>!(e.id in r)),0);o.forEach(e=>{var t,r=s[e.qName]=(r=(e=e).attributes.weight||50,(1e3*((t=c.apis.byQName[e.namespace])&&t.attributes.weight||50)+r)*(!!t&&t.attributes.advanced||e.attributes.advanced?1:1e6));i=Math.max(i,r)}),t=t.concat(e);n={shouldSort:!0,threshold:.4,location:0,distance:1e3,maxPatternLength:16,minMatchCharLength:2,findAllMatches:!1,caseSensitive:!1,keys:[{name:"name",weight:.3},{name:"dropdownOptions",weight:.15},{name:"namespace",weight:.1},{name:"localizedCategory",weight:.1},{name:"block",weight:.4375},{name:"params",weight:.0625},{name:"jsdoc",weight:.0625}],sortFn:function(e,t){var r=e.qName?1-s[e.item.qName]/i:1,n=t.qName?1-s[t.item.qName]/i:1;return e.score*(1+r/10)-t.score*(1+n/10)}};l=new Fuse(t,n)}return l.search(a.term).slice(0,7)},projectSearch:e=>{var t,e=e.projectSearch,r=e.headers,r=(n||(t={shouldSort:!0,threshold:.6,location:0,distance:100,maxPatternLength:16,minMatchCharLength:2,findAllMatches:!1,caseSensitive:!1,keys:[{name:"name",weight:.3}]},n=new Fuse(r,t)),n.search(e.term));return r},projectSearchClear:()=>{n=void 0}};function g(){f(p.host.opts);var e=u.U.flatClone(p.host.opts.fileSystem);let t=u.runConversionsAndStoreResults(p.host.opts);null!=t&&t.globalNames&&(p.lastGlobalNames=t.globalNames);var r,n,s=p.host.opts.fileSystem;p.host.opts.fileSystem=e;for(r of Object.keys(s))p.host.setFile(r,s[r]);return t.fileSystem=u.U.flatClone(s),0==t.diagnostics.length&&(p.host.opts.skipPxtModulesEmit=!1,p.host.opts.skipPxtModulesTSC=!1,e=p.host.opts.target.isNative?"native":"js",!p.host.opts.target.switches.noIncr&&p.host.pxtModulesOK&&(p.host.opts.skipPxtModulesTSC=!0,p.host.opts.noEmit?p.host.opts.skipPxtModulesEmit=!0:p.host.opts.target.isNative?p.host.opts.skipPxtModulesEmit=!1:"js"!=p.host.pxtModulesOK||p.host.opts.breakpoints&&!p.host.opts.justMyCode||(p.host.opts.skipPxtModulesEmit=!0)),n=u.compile(p.host.opts,p.service),((t=Object.assign({sourceMap:t.sourceMap,fileSystem:t.fileSystem},n)).needsFullRecompile||(!t.success||t.diagnostics.length)&&p.host.opts.clearIncrBuildAndRetryOnError)&&(pxt.debug("triggering full recompile"),pxt.tickEvent("compile.fullrecompile"),p.host.opts.skipPxtModulesEmit=!1,n=u.compile(p.host.opts,p.service),t=Object.assign({sourceMap:t.sourceMap},n)),t.diagnostics.every(e=>!u.isPxtModulesFilename(e.fileName))&&(p.host.pxtModulesOK=e),t.ast)&&(n=u.internalGetApiInfo(t.ast))&&(p.lastApiInfo=n),t}p.runConversionsAndCompileUsingService=g,p.performOperation=function(e,t){p.service||(p.host=new i,p.service=c.createLanguageService(p.host));let r=null;if(s.hasOwnProperty(e))try{var n=s[e];r=n(t)||{}}catch(e){r={errorMessage:e.stack}}else r={errorMessage:"No such operation: "+e};return r}}})(ts=ts||{}),(q=>{var z,V;function r(e){return"object"==typeof e&&void 0!==e.default}function a(e){return"object"==typeof e&&"number"==typeof e.length}function G(e,t=!1){let s={},i=1;return function n(e){{if(r(e)){if(t){if(o(e.default))return n(e.default);let t=G(e.default,!1),r=s[t];if(r&&!e.isLiteral||(r=i,i++,s[t]=r),0<=t.indexOf(".")&&t.indexOf(" ")<0){let e=t.split(".");return e[e.length-1]="${"+r+":"+e[e.length-1]+"}",e.join(".")}return"${"+r+":"+t+"}"}return n(e.default)}return a(e)?e.map(e=>n(e)).join(""):e}}(e)}function o(e){return!!r(e)||!!a(e)&&e.map(o).reduce((e,t)=>e||t,!1)}function H(e){return e.attributes.shim&&"@"==e.attributes.shim[0]||e.attributes.pyConvertToTaggedTemplate}z=q.pxtc||(q.pxtc={}),(V=z.service||(z.service={})).snippetStringify=G,V.snippetHasReplacementPoints=o,V.snippetAddsDefinitions=function e(t){return r(t)?t.isDefinition||e(t.default):!!a(t)&&t.map(e).reduce((e,t)=>e||t,!1)},V.getSnippet=function a(o,l,e,c,u=0){let t,r,n,{apis:p,takenNames:s,blocksInfo:F,screenSize:d,checker:m,parameterOverride:i,includeParentSnippet:O}=o,f=pxt.py.INDENT,M=c?"python":"typescript",h=l.namespace,g=!1,b="",x=0;let y,k,S=(i&&(y=null==(t=Object.keys(i))?void 0:t[0])&&(k=i[y]),[]);if(H(l))return c?l.name+'(""" """)':l.name+"``";let v="",T=(v=e.kind==z.SK.Constructor?L(e.symbol)||e.parent.name.getText():L(e.symbol)||e.name.getText(),c&&(v=z.U.snakify(v)),l.attributes);if("TD_ID"===T.shim&&u&&e.parameters.length)return U(e.parameters[0]);var I=l;let w=pxt.blocks.compileInfo(I),E=F.blocksById,D=(null==(r=T._def)?void 0:r.parameters.filter(e=>!!w.definitionNameToParam[e.name]).map(e=>w.definitionNameToParam[e.name].actualName))||[],N=e.parameters?e.parameters.filter(e=>!e.initializer&&!e.questionToken||0<=D.indexOf(e.name.getText())):[];e=N.map(U).map(e=>({default:e,isLiteral:!0}));if(I.attributes.block)if(I.attributes.defaultInstance)h=I.attributes.defaultInstance,c&&(h=h&&z.U.snakify(h));else if("variables_get"===(null==(n=w.thisParameter)?void 0:n.shadowBlockId))h=w.thisParameter.defaultValue||w.thisParameter.definitionName,c&&(h=h&&z.U.snakify(h));else if(I.namespace){let n=p.byQName[I.namespace];if(n.attributes.fixedInstances){let t=z.Util.values(p.byQName);var A=t.filter(e=>4===e.kind&&e.attributes.fixedInstance);let e;var _=A.filter(e=>e.retType==n.qName).sort((e,t)=>e.name.localeCompare(t.name));e=(_.length?_:A.filter(e=>{return-1!==(r=n.qName,t.filter(e=>e.extendsTypes).filter(e=>e.extendsTypes.reduce((e,t)=>e||-1!=t.indexOf(r),!1)).reduce((e,t)=>e.concat(t.extendsTypes),[]).indexOf(e.retType));var r}).sort((e,t)=>e.name.localeCompare(t.name)))[0],(b=(e?(h=""+B(e),e):n).namespace)&&(g=!0)}else if(1==I.kind||2==I.kind){if(w.thisParameter){let e=void 0;w.thisParameter.definitionName&&(e="my"+(e=(e=w.thisParameter.definitionName)[0].toUpperCase()+e.substring(1))),h=w.thisParameter.defaultValue||e,c&&(h=h&&z.U.snakify(h))}}else if(8===n.kind)return}_=T&&(c?T.pySnippet:T.snippet);let K,$=(_?(K=[_],h=void 0):(K=[v],(null!=e&&e.length||1==I.kind||3==I.kind||8==I.kind)&&(A=e.reduce((e,t)=>[...e,e.length?", ":"",t],[]),K=K.concat(["(",...A,")"]))),h?[h,".",...K]:K);return $=g?[(_=b,(e=_.indexOf("."))<0?_:_.substring(0,e)),".",...$]:$,T&&T.blockSetVariable&&($=c?[{default:C(z.U.snakify(T.blockSetVariable)),isDefinition:!0}," = ",...$]:["let ",{default:C(T.blockSetVariable),isDefinition:!0}," = ",...$]),O&&I.attributes.toolboxParent&&0===u?(k=[S,$],i={[y=I.attributes.toolboxParentArgument]:k},A=E[l.attributes.toolboxParent],a(Object.assign(Object.assign({},o),{parameterOverride:i}),A,V.lastApiInfo.decls[A.qName],c,u+1)):[S,$];function C(e){return s[e]?q.pxtc.decompiler.getNewName(e,s,!1):e}function U(r){var n=r.type;if(n){if(k&&r.symbol.escapedName===y)return G(k);var t=r.name.kind===z.SK.Identifier?r.name.text:void 0,s=null==(s=T.paramSnippets)?void 0:s[t];if(s)if(c){if(s.python)return s.python}else if(s.ts)return s.ts;if(s=null==(s=null==T?void 0:T.paramDefl)?void 0:s[t]){let e;if(n.kind==z.SK.AnyKeyword&&(i=s.toUpperCase(),e=Number.isNaN(+i)?"FALSE"==i||"TRUE"==i?z.SK.BooleanKeyword:i.includes(".")?z.SK.EnumKeyword:z.SK.StringKeyword:z.SK.NumberKeyword),n.kind===z.SK.StringKeyword||e===z.SK.StringKeyword)return 0!=s.indexOf('"')?`"${s}"`:s;let t=null==m?void 0:m.getTypeAtLocation(r);return null!=(i=V.getPxtSymbolFromTsSymbol(null==t?void 0:t.symbol,p,m))&&i.attributes.fixedInstances&&c?pxt.Util.snakify(s):c?z.tsSnippetToPySnippet(s,i):s}if(i=(t=>{var e=pxt.blocks.compileInfo(l);if(null!=(e=null==(e=e.parameters)?void 0:e.find(e=>e.actualName===t))&&e.shadowBlockId&&(e=E[e.shadowBlockId])){var r=null==(r=e.attributes)?void 0:r.paramFieldEditor;if((r=r&&r[t])&&(e=e.attributes.paramFieldEditorOptions||{},"sprite"===r))return(e=>{var t={initColor:0,initWidth:16,initHeight:16};if(null!=e&&e.sizes){var r=e.sizes.split(";"),n=[];for(let e=0;e<r.length;e++){var s=r[e].split(",");if(2===s.length){let e=parseInt(s[0]),t=parseInt(s[1]);isNaN(e)||isNaN(t)||(e<0&&d&&(e=d.width),t<0&&d&&(t=d.height),n.push([e,t]))}}0<n.length&&(t.initWidth=n[0][0],t.initHeight=n[0][1])}return t.initColor=i(null==e?void 0:e.initColor,t.initColor),t.initWidth=i(null==e?void 0:e.initWidth,t.initWidth),t.initHeight=i(null==e?void 0:e.initHeight,t.initHeight),pxt.sprite.imageLiteralFromDimensions(t.initWidth,t.initHeight,t.initColor,M);function i(e,t){return e=parseInt(e),isNaN(e)?t:e}})(e[t])}return null})(t))return i;if(s=(e=>{let t=(T._shadowOverrides||{})[e];var r,n;if(!t)for(r of pxt.blocks.compileInfo(l).parameters)if(r.actualName===e){t=r.shadowBlockId;break}if(!t)return null;let s=E[t];return s?("TD_ID"===s.attributes.shim&&s.parameters.length&&(n=s.parameters[0].type,n=p.byQName[n],s=n||s),s):null})(t)){var i=V.getTsSymbolFromPxtSymbol(s,r,q.SymbolFlags.Enum);if(i=(i=i&&m.getTypeOfSymbolAtLocation(i,r))&&P(i))return i;if("KIND_GET"===(i=s.attributes).shim&&i.blockId){let t=i.kindNamespace||l.namespace;if(i=z.Util.values(p.byQName).find(e=>e.namespace===t&&e.attributes.isKind))return c?i.pyQName:i.qName}if(u<3&&V.lastApiInfo.decls[s.qName]&&(i=a(o,s,V.lastApiInfo.decls[s.qName],c,u+1)))return i}if(n.kind===z.SK.StringKeyword&&"leds"===t)return c?`"""
. . . . .
. . . . .
. . # . .
. . . . .
. . . . .
"""`:`\`
. . . . .
. . . . .
. . # . .
. . . . .
. . . . .
\``;if(n.kind===z.SK.FunctionType)return s=n,(i=m?m.getSignatureFromDeclaration(s):void 0)?R(i,!0):j(t);if(void 0!==(s=V.getBasicKindDefault(n.kind,c)))return s;let e=m&&m.getTypeAtLocation(r);if(e&&(i=P(e)))return i}return c?"None":"null"}function P(e){if(e.symbol&&e.symbol.flags&q.SymbolFlags.Enum)return V.getDefaultEnumValue(e,c);var t,r=V.getPxtSymbolFromTsSymbol(e.symbol,p,m);if(z.isObjectType(e)){var n=r&&r.attributes&&(c?r.attributes.pySnippet:r.attributes.snippet);if(n)return n;if(e.objectFlags&q.ObjectFlags.Anonymous)return(n=m.getSignaturesOfType(e,q.SignatureKind.Call))&&n.length?R(n[0],!1):j()}return e.flags&q.TypeFlags.NumberLike?"0":r&&r.attributes.fixedInstances&&(t=r,(n=pxt.Util.values(p.byQName).filter(e=>4===e.kind&&e.attributes.fixedInstance&&((e,t,r)=>t==r||!(!(e=e.byQName[t])||!e.extendsTypes)&&0<=e.extendsTypes.indexOf(r))(p,e.retType,t.qName))).length)?(e=n[0],c?e.pyQName:e.qName):void 0}function L(e){if(m&&(e=z.getFullName(m,e),e=p.byQName[e]))return B(e)}function B(e){return c?e.pyName:e.name}function R(r,n){let s="";var i=m.getReturnTypeOfSignature(r);if(i.flags&q.TypeFlags.NumberLike?s="return 0":i.flags&q.TypeFlags.StringLike?s='return ""':i.flags&(q.TypeFlags.Boolean|q.TypeFlags.BooleanLiteral)&&(s=c?"return False":"return false"),c){let e,t=(e=T.optionalVariableArgs?"()":`(${r.parameters.map(e=>e.name).join(", ")})`,v||"fn");return 0<x++&&(t+=x),n&&!/^on/i.test(t)&&(t="on"+pxt.Util.capitalize(t)),(i=N.filter(e=>!!((e=m&&m.getTypeAtLocation(e))&&e.symbol&&e.symbol.flags&q.SymbolFlags.Enum)).map(e=>{var t=(e=G(U(e)).toLowerCase()).lastIndexOf(".");return-1!==t?e.substr(t+1):e}).join("_"))&&(t+="_"+i),t=C(t=z.U.snakify(t)),S=[...S,S.length?"\n":"","def ",{default:t,isDefinition:!0},e,`:
`+f,{default:s||"pass"},`
`],{default:t}}{let e="()";return T.optionalVariableArgs||(n=q.mapToDisplayParts(e=>{m.getSymbolDisplayBuilder().buildSignatureDisplay(r,e,void 0,q.TypeFormatFlags.UseFullyQualifiedType)}),i=q.displayPartsToString(n),e=i.substr(0,i.lastIndexOf(":"))),["function",e,` {
`+f,{default:s},`
}`]}}function j(e){return c?(e=C(e=z.U.snakify(e=e||"fn")),S=[...S,S.length?"\n":"","def ",{default:e,isDefinition:!0},`():
`+f,{default:"pass"},`
`],{default:e}):"function () {}"}},V.isTaggedTemplate=H})(ts=ts||{}),(e=>{(e=(e=e.pxtc||(e.pxtc={})).transpile||(e.transpile={})).pyToTs=function(e,t=0){return pxt.py.py2ts(e)},e.tsToPy=function(e,t="main.ts"){return pxt.py.decompileToPython(e,t)}})(ts=ts||{}),(a=>{var e;{var o=a.pxtc||(a.pxtc={});o.getParentCallExpression=function(e){return s(e,e=>a.isCallExpression(e)?n.Found:a.isBlock(e)?n.Abort:n.Continue)},o.findCurrentCallArgIdx=function(e,t,r){let n=e.arguments.map(e=>e===t).indexOf(!0);if(!(0<=n)){var s;if(!(e.arguments.pos<=r&&r<e.end))return-1;if(0===e.arguments.length)return 0;n=0;for(s of e.arguments){if(!(s.end<=r))break;n++}e.arguments.hasTrailingComma||(n=Math.max(0,n-1))}return n};let n;function s(e,t){var r;if(e)return(r=t(e))===n.Continue?s(e.parent,t):r!==n.Abort?r===n.Found?e:r:void 0}function i(e){return s(e,e=>a.isModuleDeclaration(e)?n.Found:n.Continue)}(e=n=o.TraverseCheck||(o.TraverseCheck={}))[e.Found=0]="Found",e[e.Continue=1]="Continue",e[e.Abort=2]="Abort",o.traverseUp=s,o.enumMemberToQName=function(e,t){if(t.name.kind===o.SK.Identifier)return e.getFullyQualifiedName(e.getSymbolAtLocation(t.name))},o.findInnerMostNodeAtPosition=function e(t,r){for(var n of t.getChildren())if(!(n.kind>=a.SyntaxKind.FirstPunctuation&&n.kind<=a.SyntaxKind.LastPunctuation)){var s=n.getStart(),i=n.getEnd();if(s<=r&&r<i)return e(n,r)}return t&&t.kind===o.SK.SourceFile?null:t},o.getParentNamespace=i,o.getCurrentNamespaces=function e(t){var r;return(t=t&&i(t))?(r=t.name.getText(),[...e(t.parent),r]):[]},o.getEnumMembers=function(e,t){if(e&&t.symbol&&t.symbol.declarations&&t.symbol.declarations.length)for(let e=0;e<t.symbol.declarations.length;e++){var r=t.symbol.declarations[e];if(r.kind===o.SK.EnumDeclaration)return r.members}},o.isExported=function(e){if(e.modifiers&&e.modifiers.some(e=>e.kind==o.SK.PrivateKeyword||e.kind==o.SK.ProtectedKeyword))return!1;let t=e.symbol;if(!t)return!1;for(;;){var r=t.parent;if(!r)break;t=r}let n=t.valueDeclaration||t.declarations[0];return!(!(n=n.kind==o.SK.VariableDeclaration?n.parent.parent:n).parent||n.parent.kind!=o.SK.SourceFile)},o.isReadonly=function(e){return e.modifiers&&e.modifiers.some(e=>e.kind==o.SK.ReadonlyKeyword)}}})(ts=ts||{}),(e=>{var m=e.pxtc||(e.pxtc={});{var o=m.vm||(m.vm={});let d=m.assembler.emitErr,e=d("opcode name doesn't match","<name>");class s extends m.assembler.Instruction{constructor(e,t,r){super(e,t,r,r,!1)}emit(r){var n=r.words;if(n[0]!=this.name)return e;let s=this.opcode,i=1;var a=[];let o=null,l=null;for(let e=0;e<this.args.length;++e){var c=this.args[e];let t=n[i++];if("$"==c[0]){var u=this.ei.encoders[c];let e=null;if(u.isImmediate||u.isLabel){if(!t)return d("expecting number",t);if(t=t.replace(/^#/,""),null==(e=r.bin.parseOneInt(t)))return d("expecting number",t)}else m.oops();if(null==e)return d("didn't understand it",t);m.U.assert(0<=e),11111!=e&&"$lbl"==c&&(e=e-(r.bin.location()+2)>>1),a.push(e);var p=e;if(null==(e=u.encode(e)))return d(`argument (${p}) out of range or mis-aligned`,t);"$i3"==c?e=l|e<<6:"$i5"==c&&(e=l|e<<8),"$i2"==c||"$i4"==c?l=e:"$rt"==c?(11111!=e&&4096<e&&m.U.oops("label: "+t+" v="+e),s=32768|e,"callrt.p"==this.name&&(s|=8192)):r.isLong||e<0||255<e?(r.isLong=!0,"$lbl"==c&&--e,s=e>>9&65535|49152,o=this.opcode+(e<<7)&65535):s=this.opcode+(e<<7)&65535}else if(c!=t)return d("expecting "+c,t)}return n[i]?d("trailing tokens",n[i]):{stack:0,opcode:s,opcode2:o,numArgs:a,labelName:r.bin.normalizeExternalLabel(null)}}}o.VmInstruction=s,o.withPush={},o.opcodes=["stloc     $i1","ldloc     $i1","stfld     $i4, $i5","ldfld     $i4, $i5","newobj    $i1","ldcap     $i1","bitconv   $i1","stglb     $i1","ldglb     $i1","ldint     $i1","ldintneg  $i1","ldspecial $i1","ldnumber  $i1","ldlit     $i1","checkinst $i1","mapget","mapset","ret       $i2, $i3","popmany   $i1","pushmany  $i1","callind   $i1","callproc  $i1","calliface $i2, $i3","callget   $i1","callset   $i1","jmp       $lbl","jmpnz     $lbl","jmpz      $lbl","try       $lbl","push","pop"];class t extends m.assembler.AbstractProcessor{constructor(e){super(),this.addEnc("$i1","#0-8388607",e=>this.inrange(8388607,e,e)),this.addEnc("$i2","#0-31",e=>this.inrange(31,e,e)),this.addEnc("$i3","#0-262143",e=>this.inrange(262143,e,e)),this.addEnc("$i4","#0-255",e=>this.inrange(255,e,e)),this.addEnc("$i5","#0-32767",e=>this.inrange(32767,e,e)),this.addEnc("$lbl","LABEL",e=>this.inminmax(-4194304,4194303,e,e)).isLabel=!0;let t=1,r=this.addEnc("$rt","SHIM",e=>this.inrange(8388607,e,e)).isLabel=!0;for(var n of o.opcodes.concat(["callrt $rt"])){let e=new s(this,n,t);this.instructions[e.name]=[e],!r&&"callrt"!=e.name||(o.withPush[e.name]=!0,e=new s(this,n.replace(/\w+/,e=>e+".p"),64|t),this.instructions[e.name]=[e]),"mapset.p"==e.name&&(r=!1),t++}}testAssembler(){}postProcessRelAddress(e,t){return t}postProcessAbsAddress(e,t){return t}getAddressFromLabel(e,t,r,n=0){r=e.lookupLabel(r);return null==r?null:t.is32bit?r:r-(e.pc()+2)}toFnPtr(e,t){return e}wordSize(){return 8}peephole(e,t,r){var n,s,i=e.getOp();let a="";t&&(n=i+";"+(a=t.getOp()),(s=this.file.peepCounts)[n]=(s[n]||0)+1),"stloc"==i&&"ldloc"==a&&e.numArgs[0]==t.numArgs[0]?(/LAST/.test(t.text)&&e.update(""),t.update("")):o.withPush[i]&&"push"==a&&(e.update(e.text.replace(/\w+/,e=>e+".p")),t.update(""))}}o.VmProcessor=t}})(ts=ts||{});