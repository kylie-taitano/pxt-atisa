var DisconnectResponse;(e=>{e[e.Disconnected=0]="Disconnected",e[e.Waiting=1]="Waiting",e[e.TimedOut=2]="TimedOut"})(DisconnectResponse=DisconnectResponse||{});let ref="@relprefix@".replace("---","").replace(/^\//,""),pageUrl="@targetUrl@/"+ref,refCacheName="makecode;"+ref+";@pxtRelId@";function initWebappServiceWorker(){let t=-1===ref.indexOf("/");var e=[pageUrl,"@simUrl@","/semantic.js","/main.js","/pxtapp.js","/typescript.js","/marked/marked.min.js","/highlight.js/highlight.pack.js","/jquery.js","/pxtlib.js","/pxtcompiler.js","/pxtpy.js","/pxteditor.js","/pxtsim.js","/pxtembed.js","/pxtworker.js","/pxtweb.js","/blockly.css","/semantic.css","/rtlsemantic.css","/blockly/media/sprites.png","/blockly/media/click.mp3","/blockly/media/disconnect.wav","/blockly/media/delete.mp3","/vs/loader.js","/vs/base/worker/workerMain.js","/vs/basic-languages/bat/bat.js","/vs/basic-languages/cpp/cpp.js","/vs/basic-languages/python/python.js","/vs/basic-languages/markdown/markdown.js","/vs/editor/editor.main.css","/vs/editor/editor.main.js","/vs/editor/editor.main.nls.js","/vs/language/json/jsonMode.js","/vs/language/json/jsonWorker.js","/smoothie/smoothie_compressed.js","/images/Bars_black.gif","/gifjs/gif.js","/ai.2.min.js","/target.js","/music-editor/apple.png","/music-editor/burger.png","/music-editor/cake.png","/music-editor/car.png","/music-editor/cat.png","/music-editor/cherry.png","/music-editor/clam.png","/music-editor/computer.png","/music-editor/crab.png","/music-editor/dog.png","/music-editor/duck.png","/music-editor/egg.png","/music-editor/explosion.png","/music-editor/fish.png","/music-editor/ice-cream.png","/music-editor/lemon.png","/music-editor/snake.png","/music-editor/star.png","/music-editor/strawberry.png","/music-editor/taco.png","/music-editor/bass-clef.svg","/music-editor/treble-clef.svg","","","","@targetUrl@/monacoworker.js","@targetUrl@/worker.js"];let i=r("");var o=r("%2Fdocs%2Fstatic%2Flogo.svg;%2Fdocs%2Fstatic%2FMicrosoft-logo_rgb_c-gray-square.png;%2Fdocs%2Fstatic%2FMicrosoft-logo_rgb_c-gray.png;%2Fdocs%2Fstatic%2Fherogallery%2Fplaceholder1.png");let s=n(e.concat(o).map(e=>e.trim()).filter(e=>!!e&&0!==e.indexOf("@"))),c=!1;function n(e){var t,i=[];for(t of e)-1===i.indexOf(t)&&i.push(t);return i}function r(e){let t=String.fromCharCode(64)+"cdnUrl"+String.fromCharCode(64);return n(e.split(";").map(e=>decodeURIComponent(e).replace(t,"@cdnUrl@").trim()))}self.addEventListener("install",e=>{t?(c=!0,console.log("Installing service worker..."),e.waitUntil(caches.open(refCacheName).then(e=>(console.log("Opened cache"),console.log("Caching:\n"+s.join("\n")),e.addAll(s).then(()=>e))).then(e=>e.addAll(i).catch(e=>{console.log("Failed to cache hexfiles")})).then(()=>self.skipWaiting()))):console.log("Skipping service worker install for unnamed endpoint")}),self.addEventListener("activate",e=>{t?(console.log("Activating service worker..."),e.waitUntil(caches.keys().then(e=>{e=e.filter(e=>{var t=(e=>3!==(e=e.split(";")).length?null:e[1])(e);return null===t||t===ref&&e!==refCacheName});return Promise.all(e.map(e=>caches.delete(e)))}).then(()=>{if(c){c=!1;{let e=self;return e.clients.claim().then(()=>e.clients.matchAll()).then(e=>{e.forEach(e=>e.postMessage({type:"serviceworker",state:"activated",ref:ref}))})}}return Promise.resolve()}))):console.log("Skipping service worker activate for unnamed endpoint")}),self.addEventListener("fetch",e=>{e.respondWith((async t=>{if(t.request.url.startsWith(pageUrl)){let e=t.request.url.slice(pageUrl.length);if("?"===(e=e.startsWith("/")?e.slice(1):e).charAt(0)){let e;try{e=await fetch(t.request),(await caches.open(refCacheName)).put(t.request,e.clone())}catch(e){}if(e)return e;console.warn(`Unable to fetch ${t.request.url}, falling back to cache`)}}var e=await caches.match(t.request);return e=e||fetch(t.request),e})(e))})}function initWebUSB(){let o,s=0,c,n="idle",r,l;async function a(t){(await self.clients.matchAll()).forEach(e=>e.postMessage(t))}function b(t){return new Promise(e=>{setTimeout(e,t)})}self.addEventListener("message",async e=>{var t=e.data;if("serviceworkerclient"===(null==t?void 0:t.type))if("request-packet-io-lock"===t.action)if(o=o||await(()=>{if(o)return Promise.resolve(o);let t,e=new Promise(e=>{console.log("check for existing lock"),l=e,a({type:"serviceworker",action:"packet-io-status"})}),i=new Promise(e=>{t=setTimeout(()=>{console.log("Timed-out check for existing lock"),e(void 0)},1e3)});return Promise.race([e,i]).then(e=>(clearTimeout(t),l=void 0,e))})(),"granting"===n)await a({type:"serviceworker",action:"packet-io-lock-granted",granted:!1,lock:t.lock});else{console.log("Received lock request "+t.lock);var i,e=Date.now()-s;if(c=t.lock,e<4e3&&(n="waiting",console.log("Waiting to grant lock request "+t.lock),await b(4e3-e)),c!==t.lock)console.log("Rejecting old lock request "+t.lock),await a({type:"serviceworker",action:"packet-io-lock-granted",granted:!1,lock:t.lock});else{if(n="granting",o)for(;console.log("Sending disconnect request "+t.lock),(i=await(()=>{let t,e=new Promise(e=>{console.log("Waiting for disconnect "+o),r=e,a({type:"serviceworker",action:"packet-io-lock-disconnect",lock:o})}),i=new Promise(e=>{t=setTimeout(()=>{console.log("Timed-out disconnect request "+o),e(DisconnectResponse.TimedOut)},5e3)});return Promise.race([e,i]).then(e=>(clearTimeout(t),r=void 0,e))})())===DisconnectResponse.Waiting&&(console.log("Waiting on disconnect request "+t.lock),await b(1e3)),i===DisconnectResponse.Waiting;);console.log("Granted lock request "+t.lock),o=t.lock,await a({type:"serviceworker",action:"packet-io-lock-granted",granted:!0,lock:t.lock}),s=Date.now(),n="idle"}}else"release-packet-io-lock"===t.action?(console.log("Received disconnect for "+o),o=void 0,r&&r(DisconnectResponse.Disconnected)):"packet-io-lock-disconnect"===t.action?(console.log("Received disconnect response for "+o),t.didDisconnect&&(o=void 0),r&&r(t.didDisconnect?DisconnectResponse.Disconnected:DisconnectResponse.Waiting)):"packet-io-supported"===t.action?await a({type:"serviceworker",action:"packet-io-supported",supported:!0}):"packet-io-status"===t.action&&t.hasLock&&l&&l(t.lock)})}initWebappServiceWorker(),initWebUSB();