var pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim,pxsim;(r=>{{var s=r.accessibility||(r.accessibility={});let t,e=!1;function i(e){var t=window.navigator&&/Mac/i.test(window.navigator.platform)?e.metaKey:e.ctrlKey;return"Escape"===e.key?(e.preventDefault(),"escape"):"/"===e.key&&t?(e.preventDefault(),"togglekeyboardcontrolshelp"):"b"===e.key&&t?(e.preventDefault(),"toggleareamenu"):null}s.makeFocusable=function(e){e.setAttribute("focusable","true"),e.setAttribute("tabindex","0")},s.getGlobalAction=i,s.postKeyboardEvent=function(){e||(e=!0,document.addEventListener("keydown",e=>{e=i(e);e&&r.Runtime.postMessage({type:"action",action:e})}))},s.enableKeyboardInteraction=function(e,t,r){t&&e.addEventListener("keydown",e=>{e="number"==typeof e.which?e.which:e.keyCode;32!==e&&13!==e||t()}),r&&e.addEventListener("keyup",e=>{e="number"==typeof e.which?e.which:e.keyCode;32!==e&&13!==e||r()})},s.setAria=function(e,t,r){t&&!e.hasAttribute("role")&&e.setAttribute("role",t),r&&!e.hasAttribute("aria-label")&&e.setAttribute("aria-label",r)},s.setLiveContent=function(e){t||((t=document.createElement("div")).setAttribute("role","status"),t.setAttribute("aria-live","polite"),t.setAttribute("aria-hidden","false"),t.setAttribute("style","position: absolute !important;display: block;visibility: visible;overflow: hidden;width: 1px;height: 1px;margin: -1px;border: 0;padding: 0;clip: rect(0 0 0 0);"),document.body.appendChild(t)),t.textContent!==e&&(t.textContent=e)}}})(pxsim=pxsim||{}),(d=>{let h="blue",c="red",p="orange",t=e=>e.reduce((e,t)=>e+(t?1:0),0),i=e=>0<t(e);function n(e){var e=[e.start,e.end],t=e.map(e=>"ground"===e),r=e.map(e=>"threeVolt"===e),s=e.map(e=>"fiveVolt"===e),e=e.map(t=>{{let e=!1;return"string"!=typeof t&&"breadboard"===t.type&&(t=t.row,e=0<=["a","b","c","d","e"].indexOf(t)),e}}),t=i(t),r=i(r),s=i(s),e=i(e);return{topGround:t&&!e,topThreeVolt:r&&!e,topFiveVolt:s&&!e,bottomGround:t&&e,bottomThreeVolt:r&&e,bottomFiveVolt:s&&e,singleGround:t,singleThreeVolt:r,singleFiveVolt:s}}function m(e,t){var r,s,i={};for(r in e)i[r]=e[r];for(s in t)i[s]=t[s];return i}function u(e){d.U.assert(!!e,"Invalid pin: "+e);e=/^(\w+)\.\s*(?:[a-z]*)?([A-Z][A-Z\d_]+)$/.exec(e);return e?e[2]:void 0}function f(e){return"-Z"===e.orientation&&"male"===e.style}d.readPin=u;class r{constructor(e){this.availablePowerPins={top:{fiveVolt:d.mkRange(26,51).map(e=>({type:"breadboard",row:"+",col:""+e})),threeVolt:d.mkRange(26,51).map(e=>({type:"breadboard",row:"+",col:""+e})),ground:d.mkRange(26,51).map(e=>({type:"breadboard",row:"-",col:""+e}))},bottom:{fiveVolt:d.mkRange(1,26).map(e=>({type:"breadboard",row:"+",col:""+e})),threeVolt:d.mkRange(1,26).map(e=>({type:"breadboard",row:"+",col:""+e})),ground:d.mkRange(1,26).map(e=>({type:"breadboard",row:"-",col:""+e}))}},this.opts=e}allocPartIRs(n,a,c){let o=[],l=(r,e,s,t)=>{var i=[];for(let t=0;t<r.numberOfPins;t++){var n=r.pinDefinitions[t];let e;if("string"==typeof n.target)e=n.target;else{var a=n.target.pinInstantiationIdx;if(!s||void 0===s[a])return void d.log(`error: parts no pin found for PinInstantiationIdx: ${a}. (Is the part missing an ArgumentRole or "trackArgs=" annotations?)`);e=s[a]}var a=r.visual.pinLocations[t],o=c.yOffset+a.y,l=Math.round(o/r.visual.pinDistance),o=o-l*r.visual.pinDistance,u=c.xOffset+a.x,h=Math.round(u/r.visual.pinDistance),u=u-h*r.visual.pinDistance;i.push({def:n,loc:a,target:e,bbFit:{partRelativeRowIdx:l,partRelativeColIdx:h,xOffset:u,yOffset:o}})}return{name:e,def:r,pins:i,partParams:t||{},bbFit:c}};var e=n.instantiations||[];return n.instantiation&&e.push(n.instantiation),e.forEach(e=>{if("singleton"===e.kind)o.push(l(n,a));else if("function"===e.kind){let i=e,t=i.fullyQualifiedName.split(","),r={};t.forEach(e=>{this.opts.fnArgs[e]&&this.opts.fnArgs[e].forEach(e=>{r[e]=1})});e=Object.keys(r);e&&e.length?e.forEach(e=>{e=e.split(",");if(e.length!=i.argumentRoles.length)d.log(`error: parts mismatch between number of arguments at callsite (function name: ${t}) vs number of argument roles in part definition (part: ${a}).`);else{let r=[],s={};e.forEach((e,t)=>{var t=i.argumentRoles[t];void 0!==t.partParameter&&(s[t.partParameter]=e),void 0!==t.pinInstantiationIdx&&(t=t.pinInstantiationIdx,e=u(e),r[t]=e)}),o.push(l(n,a,r,s))}}):d.log("error: parts failed to read pin(s) from callsite for: "+t)}}),o.filter(e=>!!e)}computePartDimensions(e,t){var r=e.visual.pinLocations;let s=e.pinDefinitions;var i=e.numberOfPins;d.U.assert(r.length===i,`Mismatch between "numberOfPins" and length of "visual.pinLocations" for "${t}"`),d.U.assert(s.length===i,`Mismatch between "numberOfPins" and length of "pinDefinitions" for "${t}"`),d.U.assert(0<i,`Part "${t}" has no pins`);var n,i=r.map((e,t)=>{return r={idx:t},e=e,t=s[t],m(m(r,e),t);var r}).filter(e=>"-Z"===e.orientation),t=0<i.length,r=e.visual.pinDistance;let a,o,l,u;return t?(t=i[0],i=Math.ceil(t.x/r),n=Math.ceil(t.y/r),a=i*r-t.x,o=n*r-t.y,l=Math.ceil((a+e.visual.width)/r)+1,u=Math.ceil((o+e.visual.height)/r)+1):(l=Math.ceil(e.visual.width/r),u=Math.ceil(e.visual.height/r),a=l*r-e.visual.width,o=u*r-e.visual.height),{xOffset:a,yOffset:o,rowCount:u,colCount:l}}allocColumns(e){var t=e.length,r=d.visuals.BREADBOARD_MID_COLS-e.map(e=>e.colCount).reduce((e,t)=>e+t,0),s=(r<=0&&d.log("Not enough breadboard space!"),Math.floor(r/(t-1+2)));let i=s;s=r-i*(t-1),r=Math.floor(s/2);Math.ceil(s/2);let n=1+r;return e.map(e=>{var t=n;return n+=e.colCount+i,t})}placeParts(e){let r=d.visuals.BREADBOARD_MID_ROWS+2,s=this.allocColumns(e.map(e=>e.bbFit)),i=e.map(e=>{e=r-e.bbFit.rowCount;let t=Math.floor(e/2);return t=(t=4<t?4:t)<1?1:t});return e.map((e,t)=>{var r=i[t];return m({startColumnIdx:s[t],startRowIdx:r},e)})}nextColor(){return(!this.availableWireColors||this.availableWireColors.length<=0)&&(this.availableWireColors=d.visuals.GPIO_WIRE_COLORS.map(e=>e)),this.availableWireColors.pop()}allocWireIRs(o){let l=[];var e=o.pins.map((e,t)=>{var r=e.target;let s;var i=o.startColumnIdx+e.bbFit.partRelativeColIdx,i=d.visuals.getColumnName(i);let n=o.startRowIdx+e.bbFit.partRelativeRowIdx;7<=n&&(n-=2),s=f(e.def)?{type:"breadboard",row:n<5?"j":"a",col:i,style:e.def.style}:{type:"breadboard",row:d.visuals.getRowName(n),col:i,xOffset:e.bbFit.xOffset/o.def.visual.pinDistance,yOffset:e.bbFit.yOffset/o.def.visual.pinDistance,style:e.def.style};let a;return a="ground"===r?h:"threeVolt"===r?c:"fiveVolt"===r?p:"number"==typeof e.def.colorGroup?l[e.def.colorGroup]||(l[e.def.colorGroup]=this.nextColor()):this.nextColor(),{start:s,end:r,color:a,pinIdx:t}});return m(o,{wires:e})}allocLocation(t,r){if("ground"===t||"threeVolt"===t||"fiveVolt"==t){if("ground"===t&&this.powerUsage.singleGround)return{type:"dalboard",pin:this.getBoardGroundPin()};if("threeVolt"===t&&this.powerUsage.singleThreeVolt)return{type:"dalboard",pin:this.getBoardThreeVoltPin()};if("fiveVolt"===t&&this.powerUsage.singleFiveVolt)return{type:"dalboard",pin:this.getBoardFiveVoltPin()};d.U.assert(!!r.referenceBBPin);var r=this.opts.getBBCoord(r.referenceBBPin),s=[this.availablePowerPins.top.ground[0]||this.availablePowerPins.top.threeVolt[0],this.availablePowerPins.bottom.ground[0]||this.availablePowerPins.bottom.threeVolt[0]].map(e=>this.opts.getBBCoord(e)),s=(s[0]&&s[1]||d.debug(`No more available "${t}" locations!`),0==d.visuals.findClosestCoordIdx(r,s));let e;s?"ground"===t?e=this.availablePowerPins.top.ground:"threeVolt"===t?e=this.availablePowerPins.top.threeVolt:"fiveVolt"===t&&(e=this.availablePowerPins.top.fiveVolt):"ground"===t?e=this.availablePowerPins.bottom.ground:"threeVolt"===t?e=this.availablePowerPins.bottom.threeVolt:"fiveVolt"===t&&(e=this.availablePowerPins.bottom.fiveVolt);var i=e.map(e=>this.opts.getBBCoord(e)),r=d.visuals.findClosestCoordIdx(r,i),i=e[r];return(s?(this.availablePowerPins.top.ground.splice(r,1),this.availablePowerPins.top):(this.availablePowerPins.bottom.ground.splice(r,1),this.availablePowerPins.bottom)).threeVolt.splice(r,1),i}if("breadboard"===t.type)return t;if("MOSI"===t||"MISO"===t||"SCK"===t)return this.opts.boardDef.spiPins||d.debug("No SPI pin mappings found!"),{type:"dalboard",pin:this.opts.boardDef.spiPins[t]};if("SDA"===t||"SCL"===t)return this.opts.boardDef.i2cPins||d.debug("No I2C pin mappings found!"),{type:"dalboard",pin:this.opts.boardDef.i2cPins[t]};d.U.assert("string"==typeof t,"Unknown location type: "+t);s=this.opts.boardDef.gpioPinMap[t]||t;if(s)return{type:"dalboard",pin:s};d.debug("unknown pin location for "+t)}getBoardGroundPin(){var e=this.opts.boardDef.groundPins&&this.opts.boardDef.groundPins[0]||null;return e||d.debug("No available ground pin on board!"),e}getBoardThreeVoltPin(){var e=this.opts.boardDef.threeVoltPins&&this.opts.boardDef.threeVoltPins[0]||null;return e||d.debug("No available 3.3V pin on board!"),e}getBoardFiveVoltPin(){var e=this.opts.boardDef.fiveVoltPins&&this.opts.boardDef.fiveVoltPins[0]||null;return e||d.debug("No available 5V pin on board!"),e}allocPowerWires(e){var t=this.getBoardGroundPin(),r=this.getBoardThreeVoltPin(),s=this.getBoardFiveVoltPin();let i,n;n=this.opts.boardDef.attachPowerOnRight?(i={type:"breadboard",row:"-",col:"50"},{type:"breadboard",row:"-",col:"25"}):(i={type:"breadboard",row:"-",col:"26"},{type:"breadboard",row:"-",col:"1"});var a=[];let o=[];var l=[],t=(e.bottomGround&&e.topGround&&a.push({start:this.allocLocation("ground",{referenceBBPin:i}),end:this.allocLocation("ground",{referenceBBPin:n}),color:h}),e.topGround?a.push({start:this.allocLocation("ground",{referenceBBPin:i}),end:{type:"dalboard",pin:t},color:h}):e.bottomGround&&a.push({start:this.allocLocation("ground",{referenceBBPin:n}),end:{type:"dalboard",pin:t},color:h}),e.bottomThreeVolt&&e.bottomGround?o.push({start:this.allocLocation("threeVolt",{referenceBBPin:i}),end:this.allocLocation("threeVolt",{referenceBBPin:n}),color:c}):e.bottomFiveVolt&&e.bottomGround&&l.push({start:this.allocLocation("fiveVolt",{referenceBBPin:i}),end:this.allocLocation("fiveVolt",{referenceBBPin:n}),color:p}),e.topThreeVolt?o.push({start:this.allocLocation("threeVolt",{referenceBBPin:i}),end:{type:"dalboard",pin:r},color:c}):e.bottomThreeVolt&&o.push({start:this.allocLocation("threeVolt",{referenceBBPin:n}),end:{type:"dalboard",pin:r},color:p}),e.topFiveVolt&&!e.topThreeVolt?l.push({start:this.allocLocation("fiveVolt",{referenceBBPin:i}),end:{type:"dalboard",pin:s},color:c}):e.bottomFiveVolt&&!e.bottomThreeVolt&&l.push({start:this.allocLocation("fiveVolt",{referenceBBPin:n}),end:{type:"dalboard",pin:s},color:p}),[]);0<a.length&&t.push({wireIndices:a.map((e,t)=>t)});let u=a.length;return 0<o.length&&t.push({wireIndices:o.map((e,t)=>t+u)}),0<l.length&&t.push({wireIndices:o.map((e,t)=>t+u+o.length)}),{wires:a.concat(o).concat(l),assembly:t}}allocWire(e){let r=[e.start,e.end],s=r.map(e=>"ground"===e||"threeVolt"===e||"fiveVolt"===e),i=r.map((e,t)=>s[t]?void 0:this.allocLocation(e,{}));if((i=i.map((e,t)=>e||(e=i[1-t],this.allocLocation(r[t],{referenceBBPin:e}))))[0]&&i[1])return{start:i[0],end:i[1],color:e.color}}allocPart(s){var e=s.pins.filter(e=>f(e.def)).map(e=>{let t=s.startRowIdx+e.bbFit.partRelativeRowIdx;7<=t&&(t-=2);var r=d.visuals.getRowName(t),e=s.startColumnIdx+e.bbFit.partRelativeColIdx;return{type:"breadboard",row:r,col:d.visuals.getColumnName(e)}});return{name:s.name,visual:s.def.visual,bbFit:s.bbFit,startColumnIdx:s.startColumnIdx,startRowIdx:s.startRowIdx,breadboardConnections:e,params:s.partParams,simulationBehavior:s.def.simulationBehavior}}allocAll(){var e=this.opts.partsList.map(e=>({name:e,def:this.opts.partDefs[e]})).filter(e=>!!e.def);if(0<e.length){let r=e.map(e=>this.computePartDimensions(e.def,e.name)),s=[];e.forEach((e,t)=>{t=r[t],e=this.allocPartIRs(e.def,e.name,t);s=s.concat(e)});var e=this.placeParts(s).map(e=>this.allocWireIRs(e)),t=e.map(e=>e.wires).reduce((e,t)=>e.concat(t),[]).map(e=>n(e)),t=(this.powerUsage=((t=(t=t).reduce((e,t)=>({topGround:e.topGround||t.topGround,topThreeVolt:e.topThreeVolt||t.topThreeVolt,topFiveVolt:e.topFiveVolt||t.topFiveVolt,bottomGround:e.bottomGround||t.bottomGround,bottomThreeVolt:e.bottomThreeVolt||t.bottomThreeVolt,bottomFiveVolt:e.bottomFiveVolt||t.bottomFiveVolt,singleGround:t.singleGround?null===e.singleGround:e.singleGround,singleThreeVolt:t.singleThreeVolt?null===e.singleThreeVolt:e.singleThreeVolt,singleFiveVolt:t.singleFiveVolt?null===e.singleFiveVolt:e.singleFiveVolt}),{topGround:!1,topThreeVolt:!1,topFiveVolt:!1,bottomGround:!1,bottomThreeVolt:!1,bottomFiveVolt:!1,singleGround:null,singleThreeVolt:null,singleFiveVolt:null})).singleGround&&(t.topGround=t.bottomGround=!1),t.singleThreeVolt&&(t.topThreeVolt=t.bottomThreeVolt=!1),t.singleFiveVolt&&(t.topFiveVolt=t.bottomFiveVolt=!1),t),this.allocPowerWires(this.powerUsage)),e=e.map((e,t)=>{var s=this.allocPart(e),i=e.wires.map(e=>this.allocWire(e));if(!i.some(e=>!e)){let r=[];return e.wires.forEach((e,t)=>{r[e.pinIdx]=t}),{part:s,wires:i,assembly:e.def.assembly.map(e=>({part:e.part,wireIndices:(e.pinIndices||[]).map(e=>r[e])}))}}}).filter(e=>!!e),t=[t].concat(e).filter(e=>e.assembly&&e.assembly.length),e=!t.some(e=>e.part&&e.part.breadboardConnections&&0<e.part.breadboardConnections.length||e.wires&&e.wires.some(e=>"breadboard"==e.end.type&&"croc"!=e.end.style||"breadboard"==e.start.type&&"croc"!=e.start.style));return{partsAndWires:t,wires:[],parts:[],hideBreadboard:e}}return{partsAndWires:[],wires:[],parts:[]}}}d.allocateDefinitions=function(e){return new r(e).allocAll()}})(pxsim=pxsim||{}),(t=>{{var n=t.protocol||(t.protocol={});class e{constructor(e){this.seq=0,this.type=e}}n.Message=e;class r extends e{constructor(e,t){super("response"),this.request_seq=e.seq,this.command=e.command,t?(this.success=!1,this.message=t):this.success=!0}}n.Response=r;class s extends e{constructor(e,t){super("event"),this.event=e,t&&(this.body=t)}}n.Event=s,n.Source=class{constructor(e,t,r=0,s,i){this.name=e,this.path=t,this.sourceReference=r,s&&(this.origin=s),i&&(this.adapterData=i)}},n.Scope=class{constructor(e,t,r=!1){this.name=e,this.variablesReference=t,this.expensive=r}},n.StackFrame=class{constructor(e,t,r,s=0,i=0){this.id=e,this.source=r,this.line=s,this.column=i,this.name=t}},n.Thread=class{constructor(e,t){this.id=e,this.name=t||"Thread #"+e}},n.Variable=class{constructor(e,t,r=0,s,i){this.name=e,this.value=t,this.variablesReference=r,"number"==typeof i&&(this.namedVariables=i),"number"==typeof s&&(this.indexedVariables=s)}},n.Breakpoint=class{constructor(e,t,r,s){this.verified=e;"number"==typeof t&&(this.line=t),"number"==typeof r&&(this.column=r),s&&(this.source=s)}},n.Module=class{constructor(e,t){this.id=e,this.name=t}},n.CompletionItem=class{constructor(e,t,r=0){this.label=e,this.start=t,this.length=r}};class i extends s{constructor(e,t,r=null){super("stopped"),this.body={reason:e,threadId:t},r&&(this.body.text=r)}}n.StoppedEvent=i;class a extends s{constructor(e,t){super("continued"),this.body={threadId:e},"boolean"==typeof t&&(this.body.allThreadsContinued=t)}}n.ContinuedEvent=a;class o extends s{constructor(){super("initialized")}}n.InitializedEvent=o;class l extends s{constructor(e){super("terminated"),"boolean"==typeof e&&(this.body={restart:e})}}n.TerminatedEvent=l;class u extends s{constructor(e,t="console",r){super("output"),this.body={category:t,output:e},void 0!==r&&(this.body.data=r)}}n.OutputEvent=u;class h extends s{constructor(e,t){super("thread"),this.body={reason:e,threadId:t}}}n.ThreadEvent=h;class c extends s{constructor(e,t){super("breakpoint"),this.body={reason:e,breakpoint:t}}}n.BreakpointEvent=c;class d extends s{constructor(e,t){super("module"),this.body={reason:e,module:t}}}n.ModuleEvent=d;class p{constructor(){this._pendingRequests={}}start(e){this._sequence=1,this.host=e,this.host.onData(e=>{var t;"request"===e.type?this.dispatchRequest(e):"response"===e.type&&(t=this._pendingRequests[(e=e).seq])&&(delete this._pendingRequests[e.seq],t(e))})}stop(){this.host&&this.host.close()}sendEvent(e){this.send("event",e)}sendResponse(e){0<e.seq?t.error("attempt to send more than one response for command "+e.command):this.send("response",e)}sendRequest(e,t,r,s){let i={command:e};if(t&&0<Object.keys(t).length&&(i.arguments=t),this.send("request",i),s){this._pendingRequests[i.seq]=s;let t=setTimeout(()=>{clearTimeout(t);var e=this._pendingRequests[i.seq];e&&(delete this._pendingRequests[i.seq],e(new n.Response(i,"timeout")))},r)}}send(e,t){t.type=e,t.seq=this._sequence++,this.host&&(e=JSON.stringify(t),this.host.send(e))}dispatchRequest(e){}}n.ProtocolServer=p;class m extends p{constructor(){super(...arguments),this._debuggerLinesStartAt1=!1,this._debuggerColumnsStartAt1=!1,this._clientLinesStartAt1=!0,this._clientColumnsStartAt1=!0}shutdown(){}dispatchRequest(e){var t,r,s=new n.Response(e);try{"initialize"===e.command?("boolean"==typeof(t=e.arguments).linesStartAt1&&(this._clientLinesStartAt1=t.linesStartAt1),"boolean"==typeof t.columnsStartAt1&&(this._clientColumnsStartAt1=t.columnsStartAt1),"path"!==t.pathFormat?this.sendErrorResponse(s,2018,"debug adapter only supports native paths",null):((r=s).body={},this.initializeRequest(r,t))):"launch"===e.command?this.launchRequest(s,e.arguments):"attach"===e.command?this.attachRequest(s,e.arguments):"disconnect"===e.command?this.disconnectRequest(s,e.arguments):"setBreakpoints"===e.command?this.setBreakPointsRequest(s,e.arguments):"setFunctionBreakpoints"===e.command?this.setFunctionBreakPointsRequest(s,e.arguments):"setExceptionBreakpoints"===e.command?this.setExceptionBreakPointsRequest(s,e.arguments):"configurationDone"===e.command?this.configurationDoneRequest(s,e.arguments):"continue"===e.command?this.continueRequest(s,e.arguments):"next"===e.command?this.nextRequest(s,e.arguments):"stepIn"===e.command?this.stepInRequest(s,e.arguments):"stepOut"===e.command?this.stepOutRequest(s,e.arguments):"stepBack"===e.command?this.stepBackRequest(s,e.arguments):"restartFrame"===e.command?this.restartFrameRequest(s,e.arguments):"goto"===e.command?this.gotoRequest(s,e.arguments):"pause"===e.command?this.pauseRequest(s,e.arguments):"stackTrace"===e.command?this.stackTraceRequest(s,e.arguments):"scopes"===e.command?this.scopesRequest(s,e.arguments):"variables"===e.command?this.variablesRequest(s,e.arguments):"setVariable"===e.command?this.setVariableRequest(s,e.arguments):"source"===e.command?this.sourceRequest(s,e.arguments):"threads"===e.command?this.threadsRequest(s):"evaluate"===e.command?this.evaluateRequest(s,e.arguments):"stepInTargets"===e.command?this.stepInTargetsRequest(s,e.arguments):"gotoTargets"===e.command?this.gotoTargetsRequest(s,e.arguments):"completions"===e.command?this.completionsRequest(s,e.arguments):this.customRequest(e.command,s,e.arguments)}catch(e){this.sendErrorResponse(s,1104,"{_stack}",{_exception:e.message,_stack:e.stack})}}initializeRequest(e,t){e.body.supportsConditionalBreakpoints=!1,e.body.supportsHitConditionalBreakpoints=!1,e.body.supportsFunctionBreakpoints=!1,e.body.supportsConfigurationDoneRequest=!0,e.body.supportsEvaluateForHovers=!1,e.body.supportsStepBack=!1,e.body.supportsSetVariable=!1,e.body.supportsRestartFrame=!1,e.body.supportsStepInTargetsRequest=!1,e.body.supportsGotoTargetsRequest=!1,e.body.supportsCompletionsRequest=!1,this.sendResponse(e)}disconnectRequest(e,t){this.sendResponse(e),this.shutdown()}launchRequest(e,t){this.sendResponse(e)}attachRequest(e,t){this.sendResponse(e)}setBreakPointsRequest(e,t){this.sendResponse(e)}setFunctionBreakPointsRequest(e,t){this.sendResponse(e)}setExceptionBreakPointsRequest(e,t){this.sendResponse(e)}configurationDoneRequest(e,t){this.sendResponse(e)}continueRequest(e,t){this.sendResponse(e)}nextRequest(e,t){this.sendResponse(e)}stepInRequest(e,t){this.sendResponse(e)}stepOutRequest(e,t){this.sendResponse(e)}stepBackRequest(e,t){this.sendResponse(e)}restartFrameRequest(e,t){this.sendResponse(e)}gotoRequest(e,t){this.sendResponse(e)}pauseRequest(e,t){this.sendResponse(e)}sourceRequest(e,t){this.sendResponse(e)}threadsRequest(e){this.sendResponse(e)}stackTraceRequest(e,t){this.sendResponse(e)}scopesRequest(e,t){this.sendResponse(e)}variablesRequest(e,t){this.sendResponse(e)}setVariableRequest(e,t){this.sendResponse(e)}evaluateRequest(e,t){this.sendResponse(e)}stepInTargetsRequest(e,t){this.sendResponse(e)}gotoTargetsRequest(e,t){this.sendResponse(e)}completionsRequest(e,t){this.sendResponse(e)}customRequest(e,t,r){this.sendErrorResponse(t,1014,"unrecognized request",null)}sendErrorResponse(e,t,r,s){let i;"number"==typeof t?(i={id:t,format:r},s&&(i.variables=s),i.showUser=!0):i=t,e.success=!1,m.formatPII(i.format,!0,i.variables),e.body||(e.body={}),e.body.error=i,this.sendResponse(e)}convertClientLineToDebugger(e){return this._debuggerLinesStartAt1?this._clientLinesStartAt1?e:e+1:this._clientLinesStartAt1?e-1:e}convertDebuggerLineToClient(e){return this._debuggerLinesStartAt1?this._clientLinesStartAt1?e:e-1:this._clientLinesStartAt1?e+1:e}convertClientColumnToDebugger(e){return this._debuggerColumnsStartAt1?this._clientColumnsStartAt1?e:e+1:this._clientColumnsStartAt1?e-1:e}convertDebuggerColumnToClient(e){return this._debuggerColumnsStartAt1?this._clientColumnsStartAt1?e:e-1:this._clientColumnsStartAt1?e+1:e}convertClientPathToDebugger(e){return this._clientPathsAreURIs!=this._debuggerPathsAreURIs?this._clientPathsAreURIs?m.uri2path(e):m.path2uri(e):e}convertDebuggerPathToClient(e){return this._debuggerPathsAreURIs!=this._clientPathsAreURIs?this._debuggerPathsAreURIs?m.uri2path(e):m.path2uri(e):e}static path2uri(e){let t=e.replace(/\\/g,"/");return"/"!==t[0]&&(t="/"+t),encodeURI("file://"+t)}static uri2path(e){return e}static formatPII(e,r,s){return e.replace(m._formatPIIRegexp,function(e,t){return!(r&&0<t.length&&"_"!==t[0])&&s[t]&&s.hasOwnProperty(t)?s[t]:e})}}m._formatPIIRegexp=/{([^}]+)}/g,n.DebugSession=m}})(pxsim=pxsim||{}),(e=>{function o(e){e=e.replace(/\\/g,"/");let t=[];return e.split("/").forEach(e=>{".."===e&&t.length?t.pop():e&&"."!==e&&t.push(e)}),t}(e=e.util||(e.util={})).injectPolyphils=function(){String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{value:function(e,t){return void 0!==e&&null!=e&&this.substring(t=!t||t<0?0:+t,t+e.length)===e}}),Array.prototype.fill||Object.defineProperty(Array.prototype,"fill",{writable:!0,enumerable:!0,value:function(e){if(null==this)throw new TypeError("this is null or not defined");var t=Object(this),r=t.length>>>0,s=arguments[1]>>0;let i=s<0?Math.max(r+s,0):Math.min(s,r);for(var s=arguments[2],s=void 0===s?r:s>>0,n=s<0?Math.max(r+s,0):Math.min(s,r);i<n;)t[i]=e,i++;return t}}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{writable:!0,enumerable:!0,value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),r=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");var s=arguments[1];let i=0;for(;i<r;){var n=t[i];if(e.call(s,n,i,t))return n;i++}}}),Uint8Array.prototype.slice||Object.defineProperty(Uint8Array.prototype,"slice",{value:Array.prototype.slice,writable:!0,enumerable:!0}),Uint16Array.prototype.slice||Object.defineProperty(Uint16Array.prototype,"slice",{value:Array.prototype.slice,writable:!0,enumerable:!0}),Uint32Array.prototype.slice||Object.defineProperty(Uint32Array.prototype,"slice",{value:Array.prototype.slice,writable:!0,enumerable:!0}),Uint8Array.prototype.fill||Object.defineProperty(Uint8Array.prototype,"fill",{value:Array.prototype.fill,writable:!0,enumerable:!0}),Uint16Array.prototype.fill||Object.defineProperty(Uint16Array.prototype,"fill",{value:Array.prototype.fill,writable:!0,enumerable:!0}),Uint32Array.prototype.fill||Object.defineProperty(Uint32Array.prototype,"fill",{value:Array.prototype.fill,writable:!0,enumerable:!0}),Uint8Array.prototype.some||Object.defineProperty(Uint8Array.prototype,"some",{value:Array.prototype.some,writable:!0,enumerable:!0}),Uint16Array.prototype.some||Object.defineProperty(Uint16Array.prototype,"some",{value:Array.prototype.some,writable:!0,enumerable:!0}),Uint32Array.prototype.some||Object.defineProperty(Uint32Array.prototype,"some",{value:Array.prototype.some,writable:!0,enumerable:!0}),Uint8Array.prototype.reverse||Object.defineProperty(Uint8Array.prototype,"reverse",{value:Array.prototype.reverse,writable:!0,enumerable:!0}),Uint16Array.prototype.reverse||Object.defineProperty(Uint16Array.prototype,"reverse",{value:Array.prototype.reverse,writable:!0,enumerable:!0}),Uint32Array.prototype.reverse||Object.defineProperty(Uint32Array.prototype,"reverse",{value:Array.prototype.reverse,writable:!0,enumerable:!0}),Math.imul||(Math.imul=function(e,t){var r=65535&e,s=65535&t;return r*s+((e>>>16&65535)*s+r*(t>>>16&65535)<<16>>>0)|0}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");var r=Object(e);for(let e=1;e<arguments.length;e++){var s=arguments[e];if(null!=s)for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(r[i]=s[i])}return r},writable:!0,configurable:!0}),Promise.prototype.finally||(Promise.prototype.finally=Promise.prototype.finally||{finally(t){let r=e=>Promise.resolve(t()).then(e);return this.then(e=>r(()=>e),e=>r(()=>Promise.reject(e)))}}.finally)},e.Lazy=class{constructor(e){this._func=e,this._evaluated=!1}get value(){return this._evaluated||(this._value=this._func(),this._evaluated=!0),this._value}},e.getNormalizedParts=o,e.normalizePath=function(e){return o(e).join("/")},e.relativePath=function(e,t){var r=o(e),s=o(t);let i=0;for(;r[i]===s[i]&&++i!==r.length&&i!==s.length;);var n=r.slice(i),a=s.slice(i);for(let e=0;e<n.length;e++)a.unshift("..");return a.join("/")},e.pathJoin=function(...e){let t="";return e.forEach(e=>{e.replace(/\\/g,"/"),e.lastIndexOf("/")===e.length-1&&(e=e.slice(0,e.length-1)),t+="/"+e}),t},e.toArray=function(t){if(Array.isArray(t))return t;var r=[];for(let e=0;e<t.length;++e)r.push(t[e]);return r}})(pxsim=pxsim||{}),(c=>{function d(e,t){switch(typeof e){case"string":case"number":case"boolean":return e;case"function":return{text:"(function)",type:"function"};case"undefined":return null;case"object":var r,s;return e?e instanceof c.RefObject?(t&&(t[e.id]=e),s=(r=c.RefObject.toDebugString(e)).startsWith("[")?"array":r,{id:e.id,preview:r,hasFields:null!==e.fields||r.startsWith("["),type:s}):e._width&&e._height?{text:e._width+"x"+e._height,type:"image"}:{text:"(object)",type:"object"}:null;default:throw new Error}}function a(e,s,t,i,n=!1){{var a=e,o;e=t;let r={};for(o of Object.keys(a))/^__/.test(o)||!/___\d+$/.test(o)||i&&-1===i.indexOf(o)||(r[o]=d(a[o],s));if(a.fields&&e)for(var l of e)l=l.substring(l.lastIndexOf(".")+1),r[l]=d(((e,t)=>{let r={pc:0,arg0:t,fn:e,parent:{}};for(;r.fn;)r=r.fn(r);return r.retval})(a.vtable.iface[l],a),s);if(a.fields)for(var u of Object.keys(a.fields).filter(e=>n||!e.startsWith("_")))r[u]=d(a.fields[u],s);else if(a instanceof c.RefMap)for(var h of a.data)r[h.key]=d(h.val,s);else Array.isArray(a.data)?a.data.forEach((e,t)=>{r[t]=d(e,s)}):void 0!==a._width&&void 0!==a._height&&(r.width=a._width,r.height=a._height,n)&&void 0!==a._bpp&&(r.isMono=1===a._bpp);return r}}c.getWarningMessage=function(e){var t={type:"debugger",subtype:"warning",breakpointIds:[],message:e};let r=c.runtime.currFrame;for(;null!=r;)t.breakpointIds.push(r.lastBrkId),r=r.parent;return t},c.BreakpointMap=class{constructor(e){for(var t in this.fileMap={},this.idMap={},e.forEach(e=>{var[t,r]=e;this.fileMap[r.source.path]||(this.fileMap[r.source.path]=[]),this.fileMap[r.source.path].push(e),this.idMap[t]=r}),this.fileMap){var r=this.fileMap[t];this.fileMap[t]=r.sort(([,e],[,t])=>e.line===t.line?t.endLine===e.endLine?e.column-t.column:t.endLine-e.endLine:e.line-t.line)}}getById(e){return this.idMap[e]}verifyBreakpoint(e,t){e=this.fileMap[e];let r;if(e)for(var[s,i]of e)i.line<=t.line&&i.endLine>=t.line&&(r=[s,i]);return r?(r[1].verified=!0,r):[-1,{verified:!1}]}},c.dumpHeap=a,c.injectEnvironmentGlobals=function(e,r){var s=c.runtime.environmentGlobals;if(Object.keys(s).length){let t=e.environmentGlobals={};Object.keys(s).forEach(e=>t[e]=d(c.runtime.environmentGlobals[e],r))}},c.getBreakpointMsg=function(e,t,r){for(var s={},i={type:"debugger",subtype:"breakpoint",breakpointId:t,globals:a(c.runtime.globals,s,void 0,r),stackframes:[]};null!=e;){var n=((r,s)=>{var e,t,i=r.fn?r.fn.info:null;if(i)return e={thisParam:d(r.argL,s),params:[]},i.argumentNames&&(t=i.argumentNames,e.params=t.map((e,t)=>({name:e,value:d(r["arg"+t],s)}))),{locals:a(r,s),funcInfo:i,breakpointId:r.lastBrkId,callLocationId:r.callLocIdx,arguments:e}})(e,s);n&&i.stackframes.push(n),e=e.parent}return{msg:i,heap:s}};class t extends c.protocol.DebugSession{constructor(e){super(),this.driver=new c.SimulatorDriver(e,{onDebuggerBreakpoint:e=>this.onDebuggerBreakpoint(e),onDebuggerWarning:e=>this.onDebuggerWarning(e),onDebuggerResume:()=>this.onDebuggerResume(),onStateChanged:e=>this.onStateChanged(e)})}runCode(e,t,r,s,i){this.breakpoints=s,this.projectDir&&this.fixBreakpoints(),this.sendEvent(new c.protocol.InitializedEvent),this.driver.run(e,{parts:t,fnArgs:r,boardDefinition:i})}stopSimulator(e=!1){this.driver.stop(e)}initializeRequest(e,t){e.body.supportsConditionalBreakpoints=!1,e.body.supportsHitConditionalBreakpoints=!1,e.body.supportsFunctionBreakpoints=!1,e.body.supportsEvaluateForHovers=!1,e.body.supportsStepBack=!1,e.body.supportsSetVariable=!1,e.body.supportsRestartFrame=!1,e.body.supportsStepInTargetsRequest=!1,e.body.supportsGotoTargetsRequest=!1,e.body.supportsCompletionsRequest=!1,e.body.supportsConfigurationDoneRequest=!0,this.sendResponse(e)}disconnectRequest(e,t){this.sendResponse(e),this.shutdown()}launchRequest(e,t){this.projectDir||(this.projectDir=c.util.normalizePath(t.projectDir),this.breakpoints&&this.fixBreakpoints()),this.sendResponse(e)}setBreakPointsRequest(r,s){r.body={breakpoints:[]};let i=[];s.breakpoints.forEach(e=>{var t;this.breakpoints?([e,t]=this.breakpoints.verifyBreakpoint(c.util.relativePath(this.projectDir,s.source.path),e),r.body.breakpoints.push(t),t.verified&&i.push(e)):r.body.breakpoints.push({verified:!1})}),this.driver.setBreakpoints(i),this.sendResponse(r)}continueRequest(e,t){this.driver.resume(c.SimulatorDebuggerCommand.Resume),this.sendResponse(e)}nextRequest(e,t){this.driver.resume(c.SimulatorDebuggerCommand.StepOver),this.sendResponse(e)}stepInRequest(e,t){this.driver.resume(c.SimulatorDebuggerCommand.StepInto),this.sendResponse(e)}stepOutRequest(e,t){this.driver.resume(c.SimulatorDebuggerCommand.StepOut),this.sendResponse(e)}pauseRequest(e,t){this.driver.resume(c.SimulatorDebuggerCommand.Pause),this.sendResponse(e)}threadsRequest(e){e.body={threads:[{id:t.THREAD_ID,name:"main"}]},this.sendResponse(e)}stackTraceRequest(e,t){var r;this.lastBreak&&(r=this.state.getFrames(),e.body={stackFrames:r}),this.sendResponse(e)}scopesRequest(e,t){this.state&&(e.body={scopes:this.state.getScopes(t.frameId)}),this.sendResponse(e)}variablesRequest(e,t){this.state&&(e.body={variables:this.state.getVariables(t.variablesReference)}),this.sendResponse(e)}onDebuggerBreakpoint(e){this.lastBreak=e,this.state=new r(this.lastBreak,this.breakpoints,this.projectDir),e.exceptionMessage?(e=e.exceptionMessage.replace(/___\d+/g,""),this.sendEvent(new c.protocol.StoppedEvent("exception",t.THREAD_ID,e))):this.sendEvent(new c.protocol.StoppedEvent("breakpoint",t.THREAD_ID))}onDebuggerWarning(e){}onDebuggerResume(){this.sendEvent(new c.protocol.ContinuedEvent(t.THREAD_ID,!0))}onStateChanged(e){switch(e){case c.SimulatorState.Paused:break;case c.SimulatorState.Running:this.sendEvent(new c.protocol.ContinuedEvent(t.THREAD_ID,!0));break;case c.SimulatorState.Stopped:this.sendEvent(new c.protocol.TerminatedEvent)}}fixBreakpoints(){for(var e in this.breakpoints.idMap){e=this.breakpoints.idMap[e];e.source.path=c.util.pathJoin(this.projectDir,e.source.path),e.line=this.convertDebuggerLineToClient(e.line),e.endLine=this.convertDebuggerLineToClient(e.endLine),e.column=this.convertDebuggerColumnToClient(e.column),e.endColumn=this.convertDebuggerColumnToClient(e.endColumn)}}}t.THREAD_ID=1,c.SimDebugSession=t;class r{constructor(e,t,r){this._message=e,this._map=t,this._dir=r,this._currentId=1,this._frames={},this._vars={};e=this.nextId();this._vars[e]=this.getVariableValues(this._message.globals),this._globalScope={name:"Globals",variablesReference:e,expensive:!1}}getFrames(){return this._message.stackframes.map((e,t)=>{var r=this._map.getById(e.breakpointId);if(r)return{id:(this._frames[e.breakpointId]=e).breakpointId,name:e.funcInfo?e.funcInfo.functionName:0===t?"main":"anonymous",line:r.line,column:r.column,endLine:r.endLine,endColumn:r.endLine,source:r.source}}).filter(e=>!!e)}getScopes(e){var t,e=this._frames[e];return e?(t=this.nextId(),this._vars[t]=this.getVariableValues(e.locals),[{name:"Locals",variablesReference:t,expensive:!1},this._globalScope]):[this._globalScope]}getVariables(e){e=this._vars[e];return e&&e.value||[]}getVariableValues(n){return new c.util.Lazy(()=>{var r,s=[];for(r in n){var i=n[r];let e,t=0;null===i?e="null":void 0===i?e="undefined":"object"==typeof i?(e="(object)",t=this.nextId(),this._vars[t]=this.getVariableValues(i)):e=i.toString();i=r.substr(0,r.lastIndexOf("___"));s.push({name:i,value:e,variablesReference:t})}return s})}nextId(){return this._currentId++}}})(pxsim=pxsim||{}),(a=>{var e;function o(e=0){function t(){try{window.print()}catch(e){}}e?setTimeout(t,e):t()}(e=(e=a.multiplayer||(a.multiplayer={})).IconType||(e.IconType={}))[e.Player=0]="Player",e[e.Reaction=1]="Reaction",a.print=o;{var t=a.Embed||(a.Embed={});function r(e){e.origin;var t,r=e.data||{},e=r.type;if(e)switch(e){case"run":u(r);break;case"instructions":a.instructions.renderInstructions(r);break;case"stop":l();break;case"mute":h(r.mute);break;case"stopsound":a.AudioContextManager.stopAll();break;case"print":o();break;case"recorder":var s=r;if(n)switch(s.action){case"start":n.startRecording(s.width);break;case"stop":n.stopRecording()}break;case"screenshot":a.Runtime.postScreenshotAsync(r);break;case"custom":a.handleCustomMessage&&a.handleCustomMessage(r);break;case"pxteditor":break;case"debugger":n&&n.handleDebuggerMsg(r);break;case"simulator":var i=r;switch(i.command){case"focus":c("simulator.focus",{timestamp:i.timestamp});break;case"blur":c("simulator.blur",{timestamp:i.timestamp})}default:t=r,n&&!n.dead&&n.board.receiveMessage(t)}}t.start=function(){if(window.addEventListener("message",r,!1),t.frameid=window.location.hash.slice(1),"serviceWorker"in navigator&&-1!==window.location.href.indexOf("---simulator")&&!a.U.isLocalHost()){var e=window.location.pathname;let t=e.substring(1,e.indexOf("---"));navigator.serviceWorker.controller&&navigator.serviceWorker.addEventListener("message",e=>{e=e.data;e&&"serviceworker"===e.type&&"activated"===e.state&&e.ref===t&&i()});e=window.location.href.replace(/---simulator.*$/,"---simserviceworker");navigator.serviceWorker.register(e).then(function(e){a.log("Simulator ServiceWorker registration successful with scope: ",e.scope)},function(e){a.log("Simulator ServiceWorker registration failed: ",e)})}a.Runtime.postMessage({type:"ready",frameid:t.frameid})};let n;function l(){n&&(n.kill(),n.board)&&n.board.kill()}function u(e){l(),e.mute&&h(e.mute),e.localizedStrings&&a.localization.setLocalizedStrings(e.localizedStrings);let t=new a.Runtime(e);(n=t).board.initAsync(e).then(()=>{t===n&&t.run(e=>{a.dumpLivePointers(),a.Runtime.postMessage({type:"toplevelcodefinished"})})})}function h(e){a.AudioContextManager.mute(e)}t.stop=l,t.run=u}function c(e,t){s({type:"pxtsim",action:"event",tick:e,data:t})}function s(e){"undefined"!=typeof window&&window.parent&&window.parent!==window&&window.parent.postMessage(e,"*")}function i(){setInterval(()=>{a.Runtime.postMessage({type:"simulator",command:"reload"})},3e3)}a.tickEvent=c,a.reportError=function(e,t,r){s({type:"pxtsim",action:"event",tick:"error",category:e,message:t,data:r})},a.reload=i})(pxsim=pxsim||{}),pxsim.util.injectPolyphils(),"undefined"!=typeof window&&window.addEventListener("load",function(e){pxsim.Embed.start()}),(I=>{{var e=I.instructions||(I.instructions={});let c=10,r=30,n=e=>e+"x",a=20,w=3,S=5,E=5,d=40,p=50,m=1.5;var[s,i]=[816*.95,1056*.95],[v,b]=[1,1];let f=465,o=(b=((s=(s-86.4)/b-48*b)-f)/2+24,400),x=1.7,t=.17,l=.25,u=.3,h=.23,g=`
            .instr-panel {
                margin: 20px;
                padding: 24px;
                border-width: 4px;
                border-color: gray;
                border-style: solid;
                border-radius: 20px;
                display: inline-block;
                width: ${s}px;
                height: ${(i-86.4)/v-48*v}px;
                position: relative;
                overflow: hidden;
                page-break-inside: avoid;
            }
            .board-svg {
                margin: 0 auto;
                display: block;
                position: absolute;
                bottom: 24px;
                left: ${b}px;
            }
            .panel-num-outer {
                position: absolute;
                left: -4px;
                top: -4px;
                width: 120px;
                height: 120px;
                border-width: 4px;
                border-style: solid;
                border-color: gray;
                border-radius: 20px 0 20px 0;
            }
            .panel-num {
                margin: 10px 0;
                text-align: center;
                font-size: 80px;
            }
            .cmp-div {
                display: inline-block;
            }
            .reqs-div {
                margin-left: 144px;
                margin-top: 5px;
            }
            .partslist-wire,
            .partslist-cmp {
                margin: 10px;
            }
            .partslist-wire {
                display: inline-block;
            }
            `;function y(e,t){var r=document.createElementNS("http://www.w3.org/2000/svg","svg");let s={l:0,t:0,w:0,h:0};var i=document.createElementNS("http://www.w3.org/2000/svg","svg");r.appendChild(i),i.appendChild(e.el);let n={viewBox:e.x+` ${e.y} ${e.w} `+e.h,preserveAspectRatio:"xMidYMid"};s.w=e.w,s.h=e.h;e=e=>{s.h*=e,s.w*=e,n.width=s.w,n.height=s.h};t.cmpScale&&e(t.cmpScale),t.cmpWidth&&t.cmpWidth<s.w?e(t.cmpWidth/s.w):t.cmpHeight&&t.cmpHeight<s.h&&e(t.cmpHeight/s.h),I.svg.hydrate(i,n);let a=s.l,o=s.t,l=s.w,u=s.h;var h,c,d,p,e=e=>{var t;e<s.l&&(t=s.l-e,s.l=e,s.w+=t)},i=e=>{var t=s.l+s.w;t<e&&(e=e-t,s.w+=e)},m=e=>{var t;e<s.t&&(t=s.t-e,s.t=e,s.h+=t)},f=e=>{var t=s.t+s.h;t<e&&(e=e-t,s.h+=e)},[g,v]=[-.3,.3],b=[1.4,1],b=(t&&t.top&&(d=(p=t.topSize)/b[0],c=p/b[1],[h,y]=[a+l/2,o-w-c/2],p=I.visuals.mkTxt(h,y,p,0,t.top,g,v),I.U.addClass(p,"cmp-lbl"),r.appendChild(p),p=d*t.top.length,m(y-c/2),e(h-p/2),i(h+p/2)),t&&t.bot&&(y=(d=t.botSize)/b[0],c=d/b[1],[h,p]=[a+l/2,o+u+w+c/2],d=I.visuals.mkTxt(h,p,d,0,t.bot,g,v),I.U.addClass(d,"cmp-lbl"),r.appendChild(d),d=y*t.bot.length,f(p+c/2),e(h-d/2),i(h+d/2)),t&&t.right&&(p=(y=t.rightSize)/b[1],c=y/b[0]*t.right.length,[h,d]=[a+l+S+c/2,o+u/2],y=I.visuals.mkTxt(h,d,y,0,t.right,g,v),I.U.addClass(y,"cmp-lbl"),r.appendChild(y),m(d-p/2),i(h+c/2),f(d+p/2)),t&&t.left&&(i=(y=t.leftSize)/b[1],h=y/b[0]*t.left.length,[c,d]=[a-E-h/2,o+u/2],p=I.visuals.mkTxt(c,d,y,0,t.left,g,v),I.U.addClass(p,"cmp-lbl"),r.appendChild(p),m(d-i/2),e(c-h/2),f(d+i/2)),{viewBox:`${s.l} ${s.t} ${s.w} `+s.h,width:s.w*x,height:s.h*x,preserveAspectRatio:"xMidYMid"}),y=(I.svg.hydrate(r,b),document.createElement("div"));return y.appendChild(r),y}function C(e,t){var r=I.runtime.board;let s;return y(s="wire"==e?I.visuals.mkWirePart([0,0],t.wireClr||"red",t.crocClips):"string"==typeof(e=e).builtIn?(0,r.builtinPartVisuals[e.builtIn])([0,0]):I.visuals.mkGenericPartSVG(e),t)}function R(e,t,r=!1){t={state:I.runtime.board,boardDef:e.boardDef,forceBreadboardLayout:!0,forceBreadboardRender:e.allAlloc.requiresBreadboard,partDefs:e.cmpDefs,maxWidth:t+"px",fnArgs:e.fnArgs,wireframe:r,partsList:[]},e=new I.visuals.BoardHost(I.visuals.mkBoardView({visual:t.boardDef.visual,boardDef:t.boardDef,wireframe:t.wireframe}),t),r=e.getView();return I.U.addClass(r,"board-svg"),e}function k(){var e=document.createElement("div");return I.U.addClass(e,"instr-panel"),e}function T(s){let i=k();e=s.boardDef;var e=y(I.visuals.mkBoardView({visual:e.visual,boardDef:e}).getView(),{left:n(1),leftSize:r,cmpScale:t}),e=(i.appendChild(e),new I.visuals.Breadboard({}).getSVGAndSize()),e=y(e,{left:n(1),leftSize:r,cmpScale:l});return i.appendChild(e),s.allCmps.forEach(e=>{let t=1;"buttonpair"===e.visual.builtIn&&(t=2);e=C(e.visual,{left:n(t),leftSize:r,cmpScale:u});I.U.addClass(e,"partslist-cmp"),i.appendChild(e)}),s.allWireColors.forEach(e=>{var t=s.colorToWires[e].length,r=s.boardDef.pinStyles[e]||"female",t=C("wire",{left:n(t),leftSize:a,wireClr:e,cmpScale:h,crocClips:"croc"==r});I.U.addClass(t,"partslist-wire"),i.appendChild(t)}),i}function _(e,r){var t=k(),s=R(r,f,!0),i=s,n=e,a=r,o=i.getView();0<n&&I.U.addClass(o,"grayed");for(let r=0;r<=n;r++){var l=a.stepToCmps[r],l=(l&&l.forEach(e=>{var t=i.addPart(e);r===n&&(e.breadboardConnections.forEach(e=>i.highlightBreadboardPin(e)),I.U.addClass(t.element,"notgrayed"))}),a.stepToWires[r]);l&&l.forEach(e=>{var t=i.addWire(e);t&&r===n&&("breadboard"==e.start.type?i.highlightBreadboardPin(e.start):i.highlightBoardPin(e.start.pin),"breadboard"==e.end.type?i.highlightBreadboardPin(e.end):i.highlightBoardPin(e.end.pin),i.highlightWire(t))})}t.appendChild(s.getView());o=document.createElement("div"),I.U.addClass(o,"panel-num-outer"),I.U.addClass(o,"noselect"),t.appendChild(o),s=document.createElement("div");I.U.addClass(s,"panel-num"),s.textContent=e+1+"",o.appendChild(s);let u=document.createElement("div");I.U.addClass(u,"reqs-div"),t.appendChild(u);o=r.stepToWires[e]||[];let h=e=>{var t,r;return"breadboard"===e.type?({row:t,col:r}=e,`(${t},${r})`):e.pin};return o.forEach(e=>{let t=!1;"dalboard"==e.end.type&&(t="croc"==r.boardDef.pinStyles[e.end.pin]);e=C("wire",{top:h(e.end),topSize:c,bot:h(e.start),botSize:c,wireClr:e.color,cmpHeight:d,crocClips:t});I.U.addClass(e,"cmp-div"),u.appendChild(e)}),(r.stepToCmps[e]||[]).forEach(n=>{let e;(e="buttonpair"===n.visual.builtIn?[n.breadboardConnections[0],n.breadboardConnections[2]]:[n.breadboardConnections[0]]).forEach((e,t)=>{let r;var s;r=e?({row:e,col:s}=e,`(${e},${s})`):"";let i=m;"buttonpair"===n.visual.builtIn&&(i*=.5);e=C(n.visual,{top:r,topSize:c,cmpHeight:p,cmpScale:i});I.U.addClass(e,"cmp-div"),u.appendChild(e)})}),t}function P(t,e){e.boardDef.pinStyles||(e.boardDef.pinStyles={}),e.configData&&I.setConfigData(e.configData.cfg,e.configData.cfgKey);var r,s={type:"run",code:"",boardDefinition:e.boardDef,partDefinitions:e.partDefinitions},s=(I.runtime=new I.Runtime(s),I.runtime.board=null,I.initCurrentRuntime(s),document.createElement("style")),s=(s.textContent+=g,document.head.appendChild(s),e.partDefinitions),i=new I.visuals.Breadboard({}),n=(e=>{var t=I.allocateDefinitions(e);let i=[],n=[],a=1;t.partsAndWires.forEach(e=>{let r=e.part,s=e.wires;e.assembly.forEach((e,t)=>{e.part&&r&&(n[a+t]=[r]),e.wireIndices&&0<e.wireIndices.length&&s&&(i[a+t]=e.wireIndices.map(e=>s[e]))}),a+=e.assembly.length});var r=a-1,s=t.partsAndWires.map(e=>e.part).filter(e=>!!e),o=t.partsAndWires.map(e=>e.wires||[]).reduce((e,t)=>e.concat(t),[]);let l={},u=[];return o.forEach(e=>{l[e.color]||(l[e.color]=[],u.push(e.color)),l[e.color].push(e)}),{boardDef:e.boardDef,cmpDefs:e.partDefs,fnArgs:e.fnArgs,allAlloc:t,stepToWires:i,stepToCmps:n,allWires:o,allCmps:s,lastStep:r,colorToWires:l,allWireColors:u}})({boardDef:e.boardDef,partDefs:s,partsList:e.parts,fnArgs:e.fnArgs,getBBCoord:i.getCoord.bind(i)}),s=(n.allAlloc.requiresBreadboard=!0,s=n,i=document.getElementById("front-panel"),(r=R(s,o,!1)).addAll(s.allAlloc),i.appendChild(r.getView()),T(n));t.appendChild(s);for(let e=0;e<=n.lastStep;e++){var a=_(e,n);t.appendChild(a)}e.print&&I.print(2e3)}e.renderParts=P,e.renderInstructions=function(e){document.getElementById("proj-title").innerText=e.options.name||"",P(document.body,e.options)}}})(pxsim=pxsim||{}),(h=>{function s(e,t="sim: check failed"){if(!e)throw new Error(t)}h.quiet=!1,h.check=s,h.title="";let r={},i={};h.getConfig=function(e){return i.hasOwnProperty(e+"")?i[e+""]:null},h.getConfigKey=function(e){return r.hasOwnProperty(e)?r[e]:null},h.getAllConfigKeys=function(){return Object.keys(r)},h.setConfigKey=function(e,t){r[e]=t},h.setConfig=function(e,t){i[e]=t},h.setConfigData=function(e,t){i=e,r=t},h.getConfigData=function(){return{cfg:i,cfgKey:r}},h.setTitle=function(e){h.title=e};class n{constructor(){h.runtime?this.id=h.runtime.registerLiveObject(this):this.id=0}destroy(){}scan(e){throw h.U.userError("scan not implemented")}gcKey(){throw h.U.userError("gcKey not implemented")}gcSize(){throw h.U.userError("gcSize not implemented")}gcIsStatic(){return!1}print(){h.runtime&&h.runtime.refCountingDebug&&h.log("RefObject id:"+this.id)}toDebugString(){return"(object)"}static toAny(e){return e&&e.toAny?e.toAny():e}static fromAny(e){return e&&(e instanceof n?e:Array.isArray(e)?h.RefCollection.fromAny(e):"object"==typeof e?o.fromAny(e):e)}static toDebugString(e){return null===e?"null":void 0===e?"undefined;":e.vtable&&e.vtable.name?"_Map"===e.vtable.name&&e instanceof d?"(object)":e.vtable.name:e.toDebugString?e.toDebugString():e.vtable&&e.vtable.name?e.vtable.name:"string"==typeof e?JSON.stringify(e):e.toString()}}h.RefObject=n;class a{constructor(e,t,r){this.func=e,this.caps=t,this.args=r}}h.FnWrapper=a;class o extends n{constructor(){super(...arguments),this.fields={}}scan(e){for(var t of Object.keys(this.fields))e(t,this.fields[t])}gcKey(){return this.vtable.name}gcSize(){return this.vtable.numFields+1}destroy(){this.fields=null,this.vtable=null}print(){h.runtime&&h.runtime.refCountingDebug&&h.log(`RefRecord id:${this.id} (${this.vtable.name})`)}toDebugString(){let t="RefRecord: {";var r=Object.keys(this.fields);for(let e=0;e<r.length;++e)0<e&&(t+=", "),t+=r[e]+": "+n.toDebugString(this.fields[r[e]]);return t+"}"}toAny(){var e,t={};for(e of Object.keys(this.fields))t[e]=n.toAny(this.fields[e]);return t}static fromAny(e){var t,r=new o;for(t of Object.keys(e))r.fields[t]=n.fromAny(e[t]);return r}}h.RefRecord=o;class l extends n{constructor(){super(...arguments),this.fields=[]}scan(t){for(let e=0;e<this.fields.length;++e)t("_cap"+e,this.fields[e])}gcKey(){return h.functionName(this.func)}gcSize(){return this.fields.length+3}isRef(e){return s(0<=e&&e<this.fields.length),e<this.len}ldclo(e){return s(0<=(e>>=2)&&e<this.fields.length),this.fields[e]}destroy(){this.fields=null,this.func=null}print(){h.runtime&&h.runtime.refCountingDebug&&h.log(`RefAction id:${this.id} len:`+this.fields.length)}}var u;h.RefAction=l;{var e=h.pxtcore||(h.pxtcore={});e.seedAddRandom=function(e){},e.mkAction=function(t,e){var r=new l;r.len=t,r.func=e;for(let e=0;e<t;++e)r.fields.push(null);return r},e.runAction=function(e,t){var r=h.getResume();e instanceof l?r(new a(e.func,e.fields,t)):r(new a(e,null,t))};let u={};function c(e){let r="",s=(e,t)=>{r+=e.length>=t?e:("              "+e).slice(-t)};let i=e=>s(""+Math.round(e),6);var t,n=(e,t)=>{s(Math.round(t)+"",8),r+=" /",i(e),r+=" =",i(t/e)};for(t of e.split(/\n/))if(t&&/^\d/.test(t)){var a=t.split(/,/);let e=u[a[2]];e||(u[a[2]]=e={stops:0,us:0,meds:[]}),o=a[2],l=25,r+=o.length>=l?o:(o+"                         ").slice(0,l);var o=parseInt(a[0]),l=parseInt(a[1]),a=(n(o,l),r+=" |",n(o-e.stops,l-e.us),r+=" ~",parseInt(a[3])),a=(i(a),10<e.meds.length&&e.meds.shift(),e.meds.push(a),e.meds.slice()),a=(a.sort((e,t)=>e-t),a[a.length>>1]);r+=" ~~",i(a),e.stops=o,e.us=l,r+="\n"}h.log(r)}e.dumpPerfCounters=function(){if(h.runtime&&h.runtime.perfCounters){let e="calls,us,name\n";for(var t of h.runtime.perfCounters){t.lastFew.sort();var r=t.lastFew[t.lastFew.length>>1];e+=`${t.numstops},${t.value},${t.name},${r}\n`}c(e)}}}class t extends n{constructor(){super(...arguments),this.v=void 0}scan(e){e("*",this.v)}gcKey(){return"LOC"}gcSize(){return 2}destroy(){}print(){h.runtime&&h.runtime.refCountingDebug&&h.log(`RefRefLocal id:${this.id} v:`+this.v)}}h.RefRefLocal=t;class d extends n{constructor(){super(...arguments),this.vtable=h.mkMapVTable(),this.data=[]}scan(e){for(var t of this.data)e(t.key,t.val)}gcKey(){return"{...}"}gcSize(){return 2*this.data.length+4}findIdx(t){t+="";for(let e=0;e<this.data.length;++e)if(this.data[e].key==t)return e;return-1}destroy(){super.destroy();for(let e=0;e<this.data.length;++e)this.data[e].val=0;this.data=[]}print(){h.runtime&&h.runtime.refCountingDebug&&h.log(`RefMap id:${this.id} size:`+this.data.length)}toDebugString(){let t="RefMap: {";for(let e=0;e<this.data.length;++e)0<e&&(t+=", "),t+=this.data[e].key+": "+n.toDebugString(this.data[e].val);return t+"}"}toAny(){let t={};return this.data.forEach(e=>{t[e.key]=n.toAny(e.val)}),t}static fromAny(e){var t,r=new d;for(t of Object.keys(e))r.data.push({key:t,val:n.fromAny(e[t])});return r}}function p(){h.runtime&&h.runtime.dumpLivePointers()}h.RefMap=d,h.dumpLivePointers=p,(e=h.numops||(h.numops={})).toString=function(e){return null===e?"null":void 0===e?"undefined":e.toString()},e.toBoolDecr=function(e){return!!e},e.toBool=function(e){return!!e},(e=h.langsupp||(h.langsupp={})).toInt=function(e){return 0|e},e.toFloat=function(e){return e},e.ignore=function(e){return e},(e=h.pxtcore||(h.pxtcore={})).ptrOfLiteral=function(e){return e},e.debugMemLeaks=function(){p()},e.templateHash=function(){return 0},e.programHash=function(){return 0},e.programName=function(){return h.title},e.programSize=function(){return 0},e.afterProgramPage=function(){return 0},e.getConfig=function(e,t){return null==(e=h.getConfig(e))?t:e},e.toInt=function(e){return e>>0},e.toUInt=function(e){return e>>>0},e.toDouble=function(e){return e},e.toFloat=function(e){return e},e.fromInt=function(e){return e},e.fromUInt=function(e){return e},e.fromDouble=function(e){return e},e.fromFloat=function(e){return e},e.fromBool=function(e){return!!e};let m;function f(e,t){return e||h.throwFailedPropertyAccessError(e,t),t+="",e instanceof o?e.fields[t]:(t=e.findIdx(t))<0?void 0:e.data[t].val}function g(e,t,r){var s;e||h.throwFailedPropertyAccessError(e,t),t+="",e instanceof o?e.fields[t]=r:(s=e.findIdx(t))<0?e.data.push({key:t,val:r}):e.data[s].val=r}function v(e){e&&(e instanceof l||e.info)||h.throwFailedCastError(e,"function")}(u=m=h.pxtrt||(h.pxtrt={})).toInt8=function(e){return(255&e)<<24>>24},u.toInt16=function(e){return(65535&e)<<16>>16},u.toInt32=function(e){return 0|e},u.toUInt32=function(e){return e>>>0},u.toUInt8=function(e){return 255&e},u.toUInt16=function(e){return 65535&e},u.nullFix=function(e){return null==e||!1===e?0:!0===e?1:e},u.nullCheck=function(e){null==e&&h.U.userError("Dereferencing null/undefined value.")},u.panic=function(e){h.U.userError("PANIC! Code "+e)},u.stringToBool=function(e){return e?1:0},u.ptrToBool=function(e){return e?1:0},u.emptyToNull=function(e){return""==e?0:e},u.ldlocRef=function(e){return e.v},u.stlocRef=function(e,t){e.v=t},u.mklocRef=function(){return new t},u.stclo=function(e,t,r){return s(0<=t&&t<e.fields.length),s(null===e.fields[t]),e.fields[t]=r,e},u.runtimeWarning=function(e){h.Runtime.postMessage(h.getWarningMessage(e))},u.mkMap=function(){return new d},u.mapGet=function(e,t){return f(e,u.mapKeyNames[t])},u.mapSet=function(e,t,r){return g(e,u.mapKeyNames[t],r)},u.mapGetByString=f,u.mapDeleteByString=function(e,t){return null==e&&h.throwNullUndefinedAsObjectError(),e instanceof d||h.throwFailedCastError(e,"object"),0<=(t=e.findIdx(t))&&e.data.splice(t,1),!0},u.mapSetGeneric=g,u.mapGetGeneric=f,u.mapSetByString=g,u.keysOf=function(e){null==e&&h.throwNullUndefinedAsObjectError();var t=new h.RefCollection;if(e instanceof d)for(var r of e.data)t.push(r.key);return t},(e=h.pxtcore||(h.pxtcore={})).mkClassInstance=function(e){s(!!e.methods);var t=new o;return t.vtable=e,t},e.switch_eq=function(e,t){return e==t},e.typeOf=function(e){return typeof e},(e=h.thread||(h.thread={})).panic=m.panic,e.pause=function(e){let t=h.getResume();h.runtime.schedule(()=>{t()},e)},e.runInBackground=function(e){v(e),h.runtime.runFiberAsync(e)},e.forever=function(t){v(t),function e(){h.runtime.runFiberAsync(t).then(()=>h.U.delay(20)).then(e)}()},e.typeCheck=v})(pxsim=pxsim||{}),(n=>{class s extends n.RefObject{constructor(){super(),this.data=[]}scan(t){for(let e=0;e<this.data.length;++e)t("["+e+"]",this.data[e])}gcKey(){return"[...]"}gcSize(){return this.data.length+2}toArray(){return this.data.slice(0)}toAny(){return this.data.map(e=>n.RefObject.toAny(e))}static fromAny(e,t=!0){var r=new s;return r.data=t?e.map(e=>n.RefObject.fromAny(e)):e.slice(0),r}toDebugString(){let t="[";for(let e=0;e<this.data.length;++e){0<e&&(t+=",");var r=n.RefObject.toDebugString(this.data[e]);if(100<t.length+r.length){0==e&&(t+=r.substr(0,100)),t+="...";break}t+=r}return t+="]"}destroy(){var t=this.data;for(let e=0;e<t.length;++e)t[e]=0;this.data=[]}isValidIndex(e){return 0<=e&&e<this.data.length}push(e){this.data.push(e)}pop(){return this.data.pop()}getLength(){return this.data.length}setLength(e){this.data.length=e}getAt(e){return this.data[e]}setAt(e,t){this.data[e]=t}insertAt(e,t){this.data.splice(e,0,t)}removeAt(e){return this.data.splice(e,1)[0]}indexOf(e,t){return this.data.indexOf(e,t)}print(){}}var e;function r(e,t){if(a(e),e.isValidIndex(t))return e.removeAt(t)}function i(e,t,r){return a(e),e.indexOf(t,r)}function a(e){e instanceof s||n.throwFailedCastError(e,"Array")}n.RefCollection=s,(p=n.Array_||(n.Array_={})).mk=function(){return new s},p.isArray=function(e){return e instanceof s},p.length=function(e){return a(e),e.getLength()},p.setLength=function(e,t){a(e),e.setLength(t)},p.push=function(e,t){a(e),e.push(t)},p.pop=function(e,t){return a(e),e.pop()},p.getAt=function(e,t){return a(e),e.getAt(t)},p.removeAt=r,p.insertAt=function(e,t,r){a(e),e.insertAt(t,r)},p.setAt=function(e,t,r){a(e),e.setAt(t,r)},p.indexOf=i,p.removeElement=function(e,t){return a(e),0<=(t=i(e,t,0))?(r(e,t),1):0},p.typeCheck=a;let o;function l(e,t){return n.pxtrt.nullFix(e)==n.pxtrt.nullFix(t)}function u(e){return e<<16>>16}(p=o=n.Math_||(n.Math_={})).imul=Math.imul||function(e,t){var r=65535&e,s=65535&t;return r*s+((e>>>16&65535)*s+r*(t>>>16&65535)<<16>>>0)|0},p.idiv=function(e,t){return(0|e)/(0|t)|0},p.round=function(e){return Math.round(e)},p.roundWithPrecision=function(e,t){if((t|=0)<=0)return Math.round(e);if(0==e)return 0;let r=0;for(;0==r&&t<21;){var s=Math.pow(10,t++);r=Math.round(e*s+Number.EPSILON)/s}return r},p.ceil=function(e){return Math.ceil(e)},p.floor=function(e){return Math.floor(e)},p.sqrt=function(e){return Math.sqrt(e)},p.pow=function(e,t){return Math.pow(e,t)},p.clz32=function(e){return Math.clz32(e)},p.log=function(e){return Math.log(e)},p.log10=function(e){return Math.log10(e)},p.log2=function(e){return Math.log2(e)},p.exp=function(e){return Math.exp(e)},p.sin=function(e){return Math.sin(e)},p.sinh=function(e){return Math.sinh(e)},p.cos=function(e){return Math.cos(e)},p.cosh=function(e){return Math.cosh(e)},p.tan=function(e){return Math.tan(e)},p.tanh=function(e){return Math.tanh(e)},p.asin=function(e){return Math.asin(e)},p.asinh=function(e){return Math.asinh(e)},p.acos=function(e){return Math.acos(e)},p.acosh=function(e){return Math.acosh(e)},p.atan=function(e){return Math.atan(e)},p.atanh=function(e){return Math.atanh(e)},p.atan2=function(e,t){return Math.atan2(e,t)},p.trunc=function(e){return 0<e?Math.floor(e):Math.ceil(e)},p.random=function(){return Math.random()},p.randomRange=function(e,t){var r;return e==t?e:(t<e&&(r=e,e=t,t=r),Math.floor(e)==e&&Math.floor(t)==t?e+Math.floor(Math.random()*(t-e+1)):e+Math.random()*(t-e))},(p=n.Number_||(n.Number_={})).lt=function(e,t){return e<t},p.le=function(e,t){return e<=t},p.neq=function(e,t){return!l(e,t)},p.eq=l,p.eqDecr=function(e,t){return n.pxtrt.nullFix(e)==n.pxtrt.nullFix(t)},p.gt=function(e,t){return t<e},p.ge=function(e,t){return t<=e},p.div=function(e,t){return 0|Math.floor(e/t)},p.mod=function(e,t){return e%t},p.bnot=function(e){return~e},p.toString=function(e){return e+""},(p=n.thumb||(n.thumb={})).adds=function(e,t){return e+t|0},p.subs=function(e,t){return e-t|0},p.divs=function(e,t){return 0|Math.floor(e/t)},p.muls=function(e,t){return o.imul(e,t)},p.ands=function(e,t){return e&t},p.orrs=function(e,t){return e|t},p.eors=function(e,t){return e^t},p.lsls=function(e,t){return e<<t},p.lsrs=function(e,t){return e>>>t},p.asrs=function(e,t){return e>>t},p.bnot=function(e){return~e},p.ignore=function(e){return e},(p=n.avr||(n.avr={})).adds=function(e,t){return u(e+t)},p.subs=function(e,t){return u(e-t)},p.divs=function(e,t){return u(Math.floor(e/t))},p.muls=function(e,t){return u(o.imul(e,t))},p.ands=function(e,t){return u(e&t)},p.orrs=function(e,t){return u(e|t)},p.eors=function(e,t){return u(e^t)},p.lsls=function(e,t){return u(e<<t)},p.lsrs=function(e,t){return(65535&e)>>>t},p.asrs=function(e,t){return u(e>>t)},p.bnot=function(e){return~e},p.ignore=function(e){return e};let c;function h(e){"string"!=typeof e&&n.throwFailedCastError(e,"string")}(p=c=n.String_||(n.String_={})).stringConv=function(e){let t=n.getResume();e instanceof n.RefRecord&&e.vtable.toStringMethod?n.runtime.runFiberAsync(e.vtable.toStringMethod,e).then(()=>{t(n.runtime.currFrame.retval+"")}):t(e+"")},p.mkEmpty=function(){return""},p.fromCharCode=function(e){return String.fromCharCode(e)},p.toNumber=function(e){return h(e),parseFloat(e)},p.concat=function(e,t){return h(e),e+t},p.substring=function(e,t,r){return h(e),e.slice(t,t+r)},p.equals=function(e,t){return h(e),e==t},p.compare=function(e,t){return h(e),e==t?0:e<t?-1:1},p.compareDecr=function(e,t){return h(e),e==t?0:e<t?-1:1},p.length=function(e){return h(e),e.length},p.substr=function(e,t,r){return h(e),e.substr(t,r)},p.charAt=function(e,t){return h(e),e.charAt(t)},p.charCodeAt=function(e,t){return h(e),s=t,h(r=e),0<=s&&s<r.length?e.charCodeAt(t):0;var r,s},p.indexOf=function(e,t,r){return h(e),null==t?-1:e.indexOf(t,r)},p.lastIndexOf=function(e,t,r){return h(e),null==t?-1:e.lastIndexOf(t,r)},p.includes=function(e,t,r){return h(e),null!=t&&e.includes(t,r)},p.typeCheck=h,(p=n.Boolean_||(n.Boolean_={})).toString=function(e){return e?"true":"false"},p.bang=function(e){return!e};class d extends n.RefObject{constructor(e){super(),this.data=e,this.isStatic=!1}scan(e){}gcKey(){return"Buffer"}gcSize(){return 2+(this.data.length+3>>2)}gcIsStatic(){return this.isStatic}print(){}toDebugString(){return t.toHex(this)}}n.RefBuffer=d;let t;{var p=t=n.BufferMethods||(n.BufferMethods={});let i;function m(e){let t=(e=>{switch(e){case i.Int8LE:return-1;case i.UInt8LE:return 1;case i.Int16LE:return-2;case i.UInt16LE:return 2;case i.Int32LE:return-4;case i.UInt32LE:return 4;case i.Int8BE:return-10;case i.UInt8BE:return 10;case i.Int16BE:return-20;case i.UInt16BE:return 20;case i.Int32BE:return-40;case i.UInt32BE:return 40;case i.Float32LE:return 4;case i.Float32BE:return 40;case i.Float64LE:return 8;case i.Float64BE:return 80;default:throw n.U.userError("bad format")}})(e),r=!1,s=(t<0&&(r=!0,t=-t),!1);10<=t&&(s=!0,t/=10);e=e>=i.Float32LE;return{size:t,signed:r,swap:s,isFloat:e}}function f(e){return new d(new Uint8Array(e))}function g(e,t){return 0<=t&&t<e.data.length}function v(e,t){return E(e),g(e,t)?e.data[t]:0}function b(e){e.isStatic&&n.U.userError("Writing to read only buffer.")}function y(e,t,r){E(e),g(e,t)&&(b(e),e.data[t]=r)}function w(e,t,r=0,s=-1){E(e),r<0||r>e.data.length||(s<0&&(s=e.data.length),s=Math.min(s,e.data.length-r),b(e),e.data.fill(t,r,r+s))}function S(t,r,s,i,n){if(s.buffer===t.buffer)S(t,r,s.slice(i,i+n),0,n);else for(let e=0;e<n;++e)t[r+e]=s[i+e]}(e=i=p.NumberFormat||(p.NumberFormat={}))[e.Int8LE=1]="Int8LE",e[e.UInt8LE=2]="UInt8LE",e[e.Int16LE=3]="Int16LE",e[e.UInt16LE=4]="UInt16LE",e[e.Int32LE=5]="Int32LE",e[e.Int8BE=6]="Int8BE",e[e.UInt8BE=7]="UInt8BE",e[e.Int16BE=8]="Int16BE",e[e.UInt16BE=9]="UInt16BE",e[e.Int32BE=10]="Int32BE",e[e.UInt32LE=11]="UInt32LE",e[e.UInt32BE=12]="UInt32BE",e[e.Float32LE=13]="Float32LE",e[e.Float64LE=14]="Float64LE",e[e.Float32BE=15]="Float32BE",e[e.Float64BE=16]="Float64BE",p.fmtInfo=m,p.getNumber=function(t,e,r){E(t);var s=m(e);if(s.isFloat)return e=t.data.buffer.slice(r,r+s.size),s.swap&&new Uint8Array(e).reverse(),new(4==s.size?Float32Array:Float64Array)(e)[0];let i=0;for(let e=0;e<s.size;++e){i<<=8;var n=s.swap?r+e:r+s.size-e-1;i|=t.data[n]}return s.signed?(e=32-8*s.size,i=i<<e>>e):i>>>=0,i},p.setNumber=function(t,e,r,s){E(t);var i=m(e);if(i.isFloat){var n=new Uint8Array(i.size);4==i.size?new Float32Array(n.buffer)[0]=s:new Float64Array(n.buffer)[0]=s,i.swap&&n.reverse();for(let e=0;e<i.size;++e)t.data[r+e]=n[e]}else for(let e=0;e<i.size;++e){var a=i.swap?r+i.size-e-1:r+e;t.data[a]=255&s,s>>=8}},p.createBuffer=f,p.createBufferFromHex=function(t){c.typeCheck(t);var r=f(t.length>>1);for(let e=0;e<t.length;e+=2)r.data[e>>1]=parseInt(t.slice(e,e+2),16);return r.isStatic=!0,r},p.isReadOnly=function(e){return E(e),e.isStatic},p.getBytes=function(e){return E(e),e.data},p.getUint8=function(e,t){return E(e),v(e,t)},p.getByte=v,p.setUint8=function(e,t,r){E(e),y(e,t,r)},p.setByte=y,p.length=function(e){return E(e),e.data.length},p.fill=w,p.slice=function(e,t,r){return E(e),t=Math.min(e.data.length,t),r<0&&(r=e.data.length),r=Math.min(r,e.data.length-t),new d(e.data.slice(t,t+r))},p.toHex=function(t){E(t);var r="0123456789abcdef";let s="";for(let e=0;e<t.data.length;++e)s=(s+=r[t.data[e]>>4])+r[15&t.data[e]];return s},p.toString=function(e){return E(e),n.U.fromUTF8Array(e.data)};let h=-2147483648;function E(e){e instanceof d||n.throwFailedCastError(e,"Buffer")}p.shift=function(e,t,r,s){E(e),s<0&&(s=e.data.length-r),r<0||r+s>e.data.length||r+s<r||0==s||0==t||t==h||0!=s&&0!=t&&t!=h&&(t<=-s||s<=t?w(e,0):(b(e),t<0?(S(e.data,r+(t=-t),e.data,r,s-t),e.data.fill(0,r,r+t)):(S(e.data,r,e.data,r+t,s-=t),e.data.fill(0,r+s,r+s+t))))},p.rotate=function(s,i,n,a){if(E(s),a<0&&(a=s.data.length-n),!(n<0||n+a>s.data.length||n+a<n||0==a||0==i||i==h)){b(s),i<0&&(i+=a<<8),(i%=a)<0&&(i+=a);var o=s.data;let e=i,t=0,r=e;for(var l=a;t!=r;){var u=o[t+n];o[t+++n]=o[r+n],o[r+++n]=u,r==l?r=e:t==e&&(e=r)}}},p.write=function(e,t,r,s=0,i=-1){E(e),E(r),i<0&&(i=r.data.length),s<0||t<0||t>e.data.length||(i=Math.min(r.data.length-s,e.data.length-t))<0||(b(e),S(e.data,t,r.data,s,i))},p.typeCheck=E}})(pxsim=pxsim||{}),(t=>{(t.control||(t.control={})).createBufferFromUTF8=function(e){return t.String_.typeCheck(e),new t.RefBuffer(t.U.toUTF8Array(e))}})(pxsim=pxsim||{}),(e=>{{e=e.localization||(e.localization={});let s={};function i(e,o){return 0==o.length?e:e.replace(/\{([0-9]+)(\:[^\}]+)?\}/g,function(e,r,t){r=o[parseInt(r)];let s="";var i=/^:f(\d*)\.(\d+)/.exec(t);if(i){var n=parseInt(i[2]);let e=parseInt(i[1])||0;var a=/^0/.test(i[1])?"0":" ";let t=r.toFixed(n);if(0<e&&0<n&&(e+=n+1),0<e)for(;t.length<e;)t=a+t;s=t}else s=":x"==t?"0x"+r.toString(16):void 0===r?"(undef)":null===r?"(null)":r.toString?r.toString():r+"";return":a"==t?/^\s*[euioah]/.test(s.toLowerCase())?s="an "+s:/^\s*[bcdfgjklmnpqrstvwxz]/.test(s.toLowerCase())&&(s="a "+s):":s"==t?s=1==r?"":"s":":q"==t?s=l(s):":jq"==t?s=u(s):":uri"==t?s=encodeURIComponent(s).replace(/'/g,"%27").replace(/"/g,"%22"):":url"==t?s=encodeURI(s).replace(/'/g,"%27").replace(/"/g,"%22"):":%"==t&&(s=(100*r).toFixed(1).toString()+"%"),s})}function l(e){return e&&e.replace(/([^\w .!?\-$])/g,e=>"&#"+e.charCodeAt(0)+";")}function u(e){return e.replace(/[^\w .!?\-$]/g,e=>{e=e.charCodeAt(0).toString(16);return"\\u"+"0000".substr(0,4-e.length)+e})}e.setLocalizedStrings=function(e){s=e||{}},e.lf=function(e,...t){let r=s[e]||e;return i(r=r.replace(/^\{(id|loc):[^\}]+\}/g,""),t)},e.fmt_va=i,e.htmlEscape=l,e.jsStringQuote=u}})(pxsim=pxsim||{}),(e=>{let t;var r;(r=t=e.LogLevel||(e.LogLevel={}))[r.Debug=0]="Debug",r[r.Info=1]="Info",r[r.Log=1]="Log",r[r.Warning=2]="Warning",r[r.Error=3]="Error",e.ConsoleLogger=class{constructor(){this.setLogLevel(t.Info)}setLogLevel(e){this.logLevel=e}getLogLevel(){return this.logLevel}info(...e){this.shouldLog(t.Info)&&null!=console&&console.info&&console.info.call(null,...e)}log(...e){this.shouldLog(t.Log)&&null!=console&&console.log&&console.log.call(null,...e)}debug(...e){this.shouldLog(t.Debug)&&null!=console&&console.debug&&console.debug.call(null,...e)}error(...e){this.shouldLog(t.Error)&&null!=console&&console.error&&console.error.call(null,...e)}warn(...e){this.shouldLog(t.Warning)&&null!=console&&console.warn&&console.warn.call(null,...e)}shouldLog(e){return e>=this.logLevel}};let s=new e.ConsoleLogger;e.info=function(...e){s.info(...e)},e.log=function(...e){s.log(...e)},e.debug=function(...e){s.debug(...e)},e.error=function(...e){s.error(...e)},e.warn=function(...e){s.warn(...e)},e.setLogger=function(e){var t=null==s?void 0:s.getLogLevel();s=e,void 0!==t&&s.setLogLevel(t)},e.setLogLevel=function(e){s.setLogLevel(e)}})(pxsim=pxsim||{}),!function(pxsim){let MIN_MESSAGE_WAIT_MS=200,tracePauseMs=0,MessageListenerFlags;(e=>{e[e.MESSAGE_BUS_LISTENER_REENTRANT=8]="MESSAGE_BUS_LISTENER_REENTRANT",e[e.MESSAGE_BUS_LISTENER_QUEUE_IF_BUSY=16]="MESSAGE_BUS_LISTENER_QUEUE_IF_BUSY",e[e.MESSAGE_BUS_LISTENER_DROP_IF_BUSY=32]="MESSAGE_BUS_LISTENER_DROP_IF_BUSY",e[e.MESSAGE_BUS_LISTENER_IMMEDIATE=192]="MESSAGE_BUS_LISTENER_IMMEDIATE"})(MessageListenerFlags=MessageListenerFlags||{});let U;(e=>{function t(e){return e.split(/\s+/).filter(e=>!!e)}function r(e){for(;e.firstChild;)e.removeChild(e.firstChild)}e.containsClass=function(r,e){return t(e).every(e=>{return e=e,(t=r).classList?t.classList.contains(e):!((t.className+"").split(/\s+/).indexOf(e)<0);var t})},e.addClass=function(r,e){t(e).forEach(e=>{var t;e=e,(t=r).classList?t.classList.add(e):(t.className+"").split(/\s+/).indexOf(e)<0&&(t.className.baseVal+=" "+e)})},e.removeClass=function(r,e){t(e).forEach(e=>{var t;t=e,(e=r).classList?e.classList.remove(t):e.className.baseVal=(e.className+"").split(/\s+/).filter(e=>e!=t).join(" ")})},e.remove=function(e){e.parentElement.removeChild(e)},e.removeChildren=r,e.clear=function(e){r(e)},e.assert=function(e,t="Assertion failed"){if(!e)throw new Error(t)},e.repeatMap=function(t,r){t=t||0;var s=[];for(let e=0;e<t;++e)s.push(r(e));return s},e.userError=function(e){throw(e=new Error(e)).isUserError=!0,e},e.now=function(){return Date.now()};let s,i=(e.perfNowUs=function(){return 1e3*(s=s||("undefined"!=typeof performance?performance.now.bind(performance)||performance.moznow.bind(performance)||performance.msNow.bind(performance)||performance.webkitNow.bind(performance)||performance.oNow.bind(performance):Date.now))()},Promise.resolve());async function n(t,r,s){let i=0;var n=[];let a=[];for(let e=0;e<t;e++){var o=(async()=>{for(;i<r.length;){var e=i++,t=r[e];a[e]=await s(t)}})();n.push(o)}try{await Promise.all(n)}catch(e){throw i=r.length,e}return a}function a(){return"undefined"!=typeof window&&!!window.pxtElectron}function o(){return"undefined"!=typeof window&&!!window.ipcRenderer}function l(){return a()||o()}function u(e){return/^http:\/\/(?:localhost|127\.0\.0\.1|192\.168\.\d{1,3}\.\d{1,3}|[a-zA-Z0-9.-]+\.local):\d+\/?/.test(e)&&!/nolocalhost=1/.test(e)}function h(){try{return"undefined"!=typeof window&&u(window.location.href)}catch(e){return!1}}e.nextTick=function(e){i.then(e)},e.delay=async function(t,e){return e=await e,await new Promise(e=>setTimeout(()=>e(),t)),e},e.throttle=function(s,i,n){let a;return function(){let e=this,t=arguments;var r=n&&!a;a=a||setTimeout(function(){a=null,n||s.apply(e,t)},i),r&&s.apply(e,t)}},e.promiseMapAll=function(e,t){return Promise.all(e.map(e=>t(e)))},e.promiseMapAllSeries=function(e,t){return n(1,e,t)},e.promisePoolAsync=n,e.promiseTimeout=async function(r,e,s){let i,n;var t=new Promise((e,t)=>{n=e,i=setTimeout(()=>{n=void 0,clearTimeout(i),t(s||`Promise timed out after ${r}ms`)},r)});return Promise.race([e,t]).then(e=>(n&&(clearTimeout(i),n()),e))},e.stringToUint8Array=function(t){var r=t.length,s=new Uint8Array(r);for(let e=0;e<r;++e)s[e]=255&t.charCodeAt(e);return s},e.uint8ArrayToString=function(t){var r=t.length;let s="";for(let e=0;e<r;++e)s+=String.fromCharCode(t[e]);return s},e.fromUTF8=function(t){if(!t)return"";let r="";for(let e=0;e<t.length;++e){var s=255&t.charCodeAt(e);r+=37==s||127<s?"%"+s.toString(16):t.charAt(e)}return decodeURIComponent(r)},e.toUTF8=function(r,s){let i="";if(r)for(let t=0;t<r.length;++t){let e=r.charCodeAt(t);var n;e<=127?i+=r.charAt(t):e<=2047?i+=String.fromCharCode(192|e>>6,128|63&e):(!s&&55296<=e&&e<=56319&&(n=r.charCodeAt(++t),isNaN(n)||(e=65536+(e-55296<<10)+(n-56320))),e<=65535?i+=String.fromCharCode(224|e>>12,128|e>>6&63,128|63&e):i+=String.fromCharCode(240|e>>18,128|e>>12&63,128|e>>6&63,128|63&e))}return i},e.toUTF8Array=function(e){return(new TextEncoder).encode(e)},e.fromUTF8Array=function(e){return(new TextDecoder).decode(e)},e.isPxtElectron=a,e.isIpcRenderer=o,e.isElectron=l,e.testLocalhost=u,e.isLocalHost=h,e.isLocalHostDev=function(){return h()&&!l()},e.unique=function(e,r){let s=[],i={};return e.forEach(e=>{var t=r(e);i.hasOwnProperty(t)||(i[t]=null,s.push(e))}),s},e.sanitizeCssName=function(e){let t=e.replace(/[^a-zA-Z0-9-_]/g,"_");return t=/^[a-zA-Z_]/.test(t)?t:"cls_"+t}})(U=pxsim.U||(pxsim.U={}));class BreakLoopException{}pxsim.BreakLoopException=BreakLoopException;let pxtcore;function getResume(){return pxsim.runtime.getResume()}(e=>{function t(e){var t=pxsim.runtime.currTryFrame(),r=(t||U.userError("unhandled exception: "+e),t.handlerFrame);throw(pxsim.runtime.currFrame=r).pc=t.handlerPC,r.tryFrame=t.parent,r.thrownValue=e,r.hasThrownValue=!0,new BreakLoopException}e.beginTry=function(e){pxsim.runtime.currFrame.tryFrame={parent:pxsim.runtime.currTryFrame(),handlerPC:e,handlerFrame:pxsim.runtime.currFrame}},e.endTry=function(){var e=pxsim.runtime.currFrame;e.tryFrame=e.tryFrame.parent},e.throwValue=t,e.getThrownValue=function(){var e=pxsim.runtime.currFrame;return U.assert(e.hasThrownValue),e.hasThrownValue=!1,e.thrownValue},e.endFinally=function(){var e=pxsim.runtime.currFrame;e.hasThrownValue&&(e.hasThrownValue=!1,t(e.thrownValue))}})(pxtcore=pxsim.pxtcore||(pxsim.pxtcore={})),pxsim.getResume=getResume;let SERIAL_BUFFER_LENGTH=16;class BaseBoard{constructor(){this.messageListeners=[],this.serialOutBuffer="",this.messages=[],this.lastSerialTime=0,this.debouncedPostAll=()=>{var e=Date.now();e-this.lastSerialTime>MIN_MESSAGE_WAIT_MS?(clearTimeout(this.serialTimeout),this.messages.length&&(Runtime.postMessage({type:"bulkserial",data:this.messages,id:pxsim.runtime.id,sim:!0}),this.messages=[],this.lastSerialTime=e)):this.serialTimeout=setTimeout(this.debouncedPostAll,50)},this.id=pxsim.Embed.frameid||"b"+Math.round(2147483647*Math.random()),this.bus=new pxsim.EventBus(pxsim.runtime,this)}updateView(){}receiveMessage(e){pxsim.runtime&&!pxsim.runtime.dead&&this.dispatchMessage(e)}dispatchMessage(e){for(var t of this.messageListeners)t(e)}addMessageListener(e){this.messageListeners.push(e)}get storedState(){return this.runOptions?(this.runOptions.storedState||(this.runOptions.storedState={}),this.runOptions.storedState):{}}initAsync(e){return this.runOptions=e,Promise.resolve()}setStoredState(e,t){null==t?delete this.storedState[e]:this.storedState[e]=t,Runtime.postMessage({type:"simulator",command:"setstate",stateKey:e,stateValue:t})}onDebuggerResume(){}screenshotAsync(e){return Promise.resolve(void 0)}kill(){}writeSerial(e){this.serialOutBuffer+=e,(/\n/.test(this.serialOutBuffer)||this.serialOutBuffer.length>SERIAL_BUFFER_LENGTH)&&(this.messages.push({time:Date.now(),data:this.serialOutBuffer}),this.debouncedPostAll(),this.serialOutBuffer="")}}pxsim.BaseBoard=BaseBoard;class CoreBoard extends BaseBoard{constructor(){super(),this.updateSubscribers=[],this.updateView=()=>{this.updateSubscribers.forEach(e=>e())},this.builtinParts={},this.builtinVisuals={},this.builtinPartVisuals={}}kill(){super.kill(),pxsim.codal.music.__stopSoundExpressions(),pxsim.AudioContextManager.stopAll()}}pxsim.CoreBoard=CoreBoard;class BareBoard extends BaseBoard{}function initBareRuntime(){pxsim.runtime.board=new BareBoard;var e=pxsim;e.basic={pause:pxsim.thread.pause,showNumber:e=>{var t=getResume();pxsim.log("SHOW NUMBER:",e),U.nextTick(t)}},e.serial={writeString:e=>pxsim.runtime.board.writeSerial(e)},e.pins={createBuffer:pxsim.BufferMethods.createBuffer},e.control={inBackground:pxsim.thread.runInBackground,createBuffer:pxsim.BufferMethods.createBuffer,dmesg:e=>pxsim.log("DMESG: "+e),deviceDalVersion:()=>"sim",__log:(e,t)=>pxsim.log("LOG: "+t.trim())}}pxsim.initBareRuntime=initBareRuntime;let LogType;(e=>{e[e.UserSet=0]="UserSet",e[e.BackAdd=1]="BackAdd",e[e.BackRemove=2]="BackRemove"})(LogType=LogType||{});class EventHandler{constructor(e,t){this.handler=e,this.flags=t,this.busy=0}async runAsync(e,t,r){var s=this.flags||MessageListenerFlags.MESSAGE_BUS_LISTENER_QUEUE_IF_BUSY;if(s!==MessageListenerFlags.MESSAGE_BUS_LISTENER_IMMEDIATE)return s===MessageListenerFlags.MESSAGE_BUS_LISTENER_QUEUE_IF_BUSY?this.runFiberAsync(e,t,r):void(s===MessageListenerFlags.MESSAGE_BUS_LISTENER_DROP_IF_BUSY&&this.busy||this.runFiberAsync(e,t,r));U.userError("MESSAGE_BUS_LISTENER_IMMEDIATE is not supported!")}async runFiberAsync(e,t,r){this.busy++,await t.runFiberAsync(this.handler,...r?r(e):[e]),this.busy--}}class EventQueue{constructor(e,t){this.runtime=e,this.valueToArgs=t,this.max=5,this.events=[],this.awaiters=[],this._handlers=[],this._addRemoveLog=[]}push(e,t){return 0<this.awaiters.length&&(t?(t=this.awaiters.shift())&&t():(t=this.awaiters.slice(),this.awaiters=[],t.forEach(e=>e()))),0==this.handlers.length||this.events.length>this.max||(this.events.push(e),this.lock)?Promise.resolve():this.poke()}async poke(){this.lock=!0;var e,t,r=this.events;this.events=[];for(e of r)for(var s of this.handlers)await s.runAsync(e,this.runtime,this.valueToArgs);if(0<this.events.length)return this.poke();this.lock=!1;for(t of this._addRemoveLog)t.log===LogType.BackAdd?this.addHandler(t.act,t.flags):t.log===LogType.BackRemove?this.removeHandler(t.act):this.setHandler(t.act,t.flags);this._addRemoveLog=[]}get handlers(){return this._handlers}setHandler(e,t=0){this.lock?this._addRemoveLog.push({act:e,log:LogType.UserSet,flags:t}):this._handlers=[new EventHandler(e,t)]}addHandler(t,e=0){this.lock?this._addRemoveLog.push({act:t,log:LogType.BackAdd,flags:e}):this._handlers.some(e=>e.handler===t)||this._handlers.push(new EventHandler(t,e))}removeHandler(t){var e;this.lock?this._addRemoveLog.push({act:t,log:LogType.BackRemove,flags:0}):-1!=(e=this._handlers.findIndex(e=>e.handler===t))&&this._handlers.splice(e,1)}addAwaiter(e){this.awaiters.push(e)}}function bind(e){let s=e.arg0,i=e.fn;return e=>{let t=0;for(;e.hasOwnProperty("arg"+t);)t++;var r=e;for(let e=t;0<e;e--)r["arg"+e]=r["arg"+(e-1)];return e.arg0=s,i(e)}}function _leave(e,t){return e.parent.retval=t,e.parent}function syntheticRefAction(t){return pxtcore.mkAction(0,e=>_leave(e,t(e)))}pxsim.EventQueue=EventQueue,pxsim.initCurrentRuntime=void 0,pxsim.handleCustomMessage=void 0,pxsim.syntheticRefAction=syntheticRefAction;class TimeoutScheduled{constructor(e,t,r,s){this.id=e,this.fn=t,this.totalRuntime=r,this.timestampCall=s}}pxsim.TimeoutScheduled=TimeoutScheduled;class PausedTimeout{constructor(e,t){this.fn=e,this.timeRemaining=t}}function mkVTable(e){return{name:e.name,numFields:e.numFields,classNo:e.classNo,methods:e.methods,iface:e.iface,lastSubtypeNo:e.lastSubtypeNo,toStringMethod:e.toStringMethod,maxBgInstances:e.maxBgInstances}}pxsim.PausedTimeout=PausedTimeout,pxsim.mkVTable=mkVTable;let mapVTable=null;function mkMapVTable(){return mapVTable=mapVTable||mkVTable({name:"_Map",numFields:0,classNo:0,lastSubtypeNo:0,methods:null})}function functionName(e){e=e.info;return e?`${e.functionName} (${e.fileName}:${e.line+1}:${e.column+1})`:"()"}pxsim.mkMapVTable=mkMapVTable,pxsim.functionName=functionName;class Runtime{constructor(msg){this.numGlobals=1e3,this.dead=!1,this.running=!1,this.idleTimer=void 0,this.recording=!1,this.recordingTimer=0,this.recordingLastImageData=void 0,this.recordingWidth=void 0,this.startTime=0,this.startTimeUs=0,this.pausedTime=0,this.lastPauseTimestamp=0,this.globals={},this.environmentGlobals={},this.otherFrames=[],this.loopLock=null,this.loopLockWaitList=[],this.heapSnapshots=[],this.timeoutsScheduled=[],this.timeoutsPausedOnBreakpoint=[],this.pausedOnBreakpoint=!1,this.traceDisabled=!1,this.perfOffset=0,this.perfElapsed=0,this.perfStack=0,this.refCountingDebug=!1,this.refObjId=1,this.numDisplayUpdates=0,U.assert(!!pxsim.initCurrentRuntime),this.id=msg.id,this.refCountingDebug=!!msg.refCountingDebug;let threadId=0,breakpoints=null,currResume,dbgHeap,dbgResume,breakFrame=null,lastYield=Date.now(),userGlobals,__this=this,yieldDelay=(this.traceDisabled=!!msg.traceDisabled,void 0!==msg.yieldDelay?msg.yieldDelay:5),evalIface={runtime:this,oops:oops,doNothing:doNothing,pxsim:pxsim,globals:this.globals,setupYield:setupYield,maybeYield:maybeYield,setupDebugger:setupDebugger,isBreakFrame:isBreakFrame,breakpoint:breakpoint,trace:trace,checkStack:checkStack,leave:_leave,checkResumeConsumed:checkResumeConsumed,setupResume:setupResume,setupLambda:setupLambda,checkSubtype:checkSubtype,failedCast:failedCast,buildResume:buildResume,mkVTable:mkVTable,bind:bind,leaveAccessor:leaveAccessor};function oops(e){throw new Error("sim error: "+e)}function doNothing(e){return e.pc=-1,_leave(e,e.parent.retval)}function flushLoopLock(){for(;0<__this.loopLockWaitList.length&&!__this.loopLock;)__this.loopLockWaitList.shift()()}let yieldReset=()=>{};function setupYield(e){yieldReset=e}function loopForSchedule(e){let t=new Object,r=e.pc;return __this.loopLock=t,__this.otherFrames.push(e),()=>{__this.dead||(U.assert(e.pc==r),U.assert(__this.loopLock===t),__this.loopLock=null,loop(e),flushLoopLock())}}function maybeYield(e,t,r){if(__this.pausedOnBreakpoint)return!1;__this.cleanScheduledExpired(),yieldReset();var s=Date.now();return 20<=s-lastYield&&(lastYield=s,e.pc=t,e.r0=r,setTimeout(loopForSchedule(e),yieldDelay),!0)}function setupDebugger(e,t){return(breakpoints=new Uint8Array(e))[0]=msg.breakOnStart?1:0,userGlobals=t,breakpoints}function isBreakFrame(t){if(!breakFrame)return!0;for(let e=breakFrame;e;e=e.parent)if(e==t)return!0;return!1}function breakpoint(t,r,e,s){let i={};__this.loopLock=i,U.assert(!dbgResume),U.assert(!dbgHeap),t.pc=r,t.r0=s;var{msg:s,heap:e}=pxsim.getBreakpointMsg(t,e,userGlobals);return dbgHeap=e,pxsim.injectEnvironmentGlobals(s,e),Runtime.postMessage(s),breakpoints[0]=0,breakFrame=null,__this.pauseScheduled(),dbgResume=e=>{if(dbgResume=null,dbgHeap=null,__this.dead)return null;switch(__this.resumeAllPausedScheduled(),__this.board.onDebuggerResume(),pxsim.runtime=__this,U.assert(t.pc==r),breakpoints[0]=0,breakFrame=null,e.subtype){case"resume":break;case"stepover":breakpoints[0]=1,breakFrame=t;break;case"stepinto":breakpoints[0]=1;break;case"stepout":breakpoints[0]=1,breakFrame=t.parent||t}U.assert(__this.loopLock==i),__this.loopLock=null,__this.otherFrames.push(t),loop(t),flushLoopLock()},null}function trace(e,t,r,s){setupResume(t,r),"<main>"===s.functionName||"main.ts"===s.fileName?(pxsim.runtime.traceDisabled||(r=pxsim.getBreakpointMsg(t,e,userGlobals).msg,r.subtype="trace",Runtime.postMessage(r)),pxsim.thread.pause(tracePauseMs||1)):pxsim.thread.pause(0),checkResumeConsumed()}function handleDebuggerMsg(t){switch(t.subtype){case"config":var r=t;if(r.setBreakpoints&&breakpoints){breakpoints.fill(0);for(var s of r.setBreakpoints)breakpoints[s]=1}break;case"traceConfig":r=t;tracePauseMs=r.interval;break;case"pause":breakpoints[0]=1,breakFrame=null;break;case"resume":case"stepover":case"stepinto":case"stepout":dbgResume&&dbgResume(t);break;case"variables":var i,r=t;let e=void 0;dbgHeap&&void 0!==(i=dbgHeap[r.variablesReference])&&(e=pxsim.dumpHeap(i,dbgHeap,r.fields,void 0,r.includeAll)),Runtime.postMessage({type:"debugger",subtype:"variables",req_seq:t.seq,variables:e})}}function removeFrame(t){var r=__this.otherFrames;for(let e=r.length-1;0<=e;--e)if(r[e]===t)return void r.splice(e,1);U.userError("frame cannot be removed!")}function loop(t){if(__this.dead)pxsim.log("Runtime terminated");else{U.assert(!__this.loopLock),__this.perfStartRuntime(),removeFrame(t);try{for(pxsim.runtime=__this;t;)__this.currFrame=t,__this.currFrame.overwrittenPC=!1,t=t.fn(t),__this.maybeUpdateDisplay(),__this.currFrame.overwrittenPC&&(t=__this.currFrame);__this.perfStopRuntime()}catch(e){var r,s;e instanceof BreakLoopException?U.nextTick(loopForSchedule(__this.currFrame)):(__this.perfStopRuntime(),__this.errorHandler?__this.errorHandler(e):(pxsim.error("Simulator crashed, no error handler",e.stack),{msg:r,heap:s}=pxsim.getBreakpointMsg(t,t.lastBrkId,userGlobals),pxsim.injectEnvironmentGlobals(r,s),r.exceptionMessage=e.message,r.exceptionStack=e.stack,Runtime.postMessage(r),__this.postError&&__this.postError(e)))}}}function checkStack(e){100<e&&U.userError("Stack overflow")}function actionCall(e){return e.depth=e.parent.depth+1,checkStack(e.depth),e.pc=0,e}function setupTop(e){e=setupTopCore(e);return setupResume(e,0),e}function setupTopCore(e){let t={parent:null,pc:0,depth:0,threadId:++threadId,fn:()=>(e&&e(t.retval),null)};return t}function topCall(e,t){U.assert(!!__this.board),U.assert(!__this.running),__this.setRunning(!0);t={parent:setupTopCore(t),fn:e,depth:0,pc:0};__this.otherFrames=[t],loop(actionCall(t))}function checkResumeConsumed(){currResume&&oops("getResume() not called")}function setupResume(e,t){currResume=buildResume(e,t)}function leaveAccessor(t,r){if(t.stage2Call){var s={pc:0,fn:null,depth:t.depth,parent:t.parent};let e=1;for(;t.hasOwnProperty("arg"+e);)s["arg"+(e-1)]=t["arg"+e],e++;return setupLambda(s,r),s}return t.parent.retval=r,t.parent}function setupLambda(e,t,r){if(r){var s=e;for(let e=1;e<r;++e)s["arg"+(e-1)]=s["arg"+e];delete s["arg"+(r-1)]}t instanceof pxsim.RefAction?(e.fn=t.func,e.caps=t.fields):"function"==typeof t?e.fn=t:oops("calling non-function")}function checkSubtype(e,t){return!!e&&(t===(e=e.vtable)||e&&t.classNo<=e.classNo&&e.classNo<=t.lastSubtypeNo)}function failedCast(e,t){pxsim.control&&pxsim.control.dmesgValue&&pxsim.control.dmesgValue(e),throwFailedCastError(e,null==t?void 0:t.name)}function buildResume(s,t){currResume&&oops("already has resume"),s.pc=t;let i=Date.now(),n=(__this.otherFrames.push(s),r=>{if(!__this.dead){if(!__this.loopLock){pxsim.runtime=__this;var e=Date.now();if(3<e-i&&(lastYield=e),U.assert(s.pc==t),r instanceof pxsim.FnWrapper){let e={parent:s,fn:r.func,lambdaArgs:r.args,pc:0,caps:r.caps,depth:s.depth+1},t={};return __this.loopLock=t,removeFrame(s),__this.otherFrames.push(e),U.nextTick(()=>{U.assert(__this.loopLock===t),__this.loopLock=null,loop(actionCall(e)),flushLoopLock()})}return s.retval=r,loop(s)}__this.loopLockWaitList.push(()=>n(r))}});return n}let entryPoint=msg.code&&eval(msg.code)(evalIface);this.run=e=>topCall(entryPoint,e),this.getResume=()=>{currResume||oops("noresume");var e=currResume;return currResume=null,e},this.setupTop=setupTop,this.handleDebuggerMsg=handleDebuggerMsg,this.entry=entryPoint,this.overwriteResume=e=>{currResume=null,0<=e&&(this.currFrame.pc=e),this.currFrame.overwrittenPC=!0},pxsim.runtime=this,pxsim.initCurrentRuntime(msg)}registerLiveObject(e){return this.refObjId++}runningTime(){return U.now()-this.startTime-this.pausedTime}runningTimeUs(){return 4294967295&U.perfNowUs()-this.startTimeUs>>0}runFiberAsync(r,s,i,n){return new Promise((e,t)=>U.nextTick(()=>{(pxsim.runtime=this).setupTop(e),pxtcore.runAction(r,[s,i,n])}))}currTryFrame(){for(let e=this.currFrame;e;e=e.parent)if(e.tryFrame)return e.tryFrame;return null}traceObjects(){let i={};for(;2<this.heapSnapshots.length;)this.heapSnapshots.shift();var e,t={count:0,size:0,name:"TOTAL"};let s={TOTAL:t};function n(e,t,s=null){if(t instanceof pxsim.RefObject)if(!t.gcIsStatic()){var r=i[t.id];if(r)s&&r.pointers.push([s,e]);else{let r={obj:t,path:null,pointers:[[s,e]]};i[t.id]=r,t.scan((e,t)=>{t instanceof pxsim.RefObject&&!i[t.id]&&n(e,t,r)})}}}this.heapSnapshots.push({visited:i,statsByType:s});for(e of Object.keys(this.globals))n(e.replace(/___\d+$/,""),this.globals[e]);var r,a=this.otherFrames.slice();this.currFrame&&a.indexOf(this.currFrame)<0&&a.unshift(this.currFrame);for(r of this.getThreads()){var o="Thread-"+this.rootFrame(r).threadId;for(let e=r;e;e=e.parent){var l,u,h=o+"."+functionName(e.fn);for(l of Object.keys(e))/^(r0|arg\d+|.*___\d+)/.test(l)&&(u=e[l])instanceof pxsim.RefObject&&n(h+"."+(l=l.replace(/___.*/,"")),u);if(e.caps)for(var c of e.caps)n(h+".cap",c)}}a=Object.keys(i).map(e=>i[e]);a.sort((e,t)=>t.obj.gcSize()-e.obj.gcSize());let d=t=>{if(null==t.path){let e="";t.path="(cycle)";for(var[r,s]of t.pointers){if(null==r)return void(t.path=s);d(r);r=r.path+"."+s;(!e||e.length>r.length)&&(e=r)}t.path=e}};a.forEach(d);var p,m,f=[t];for(p of a){var g=p.obj.gcSize(),v=p.obj.gcKey(),v=(s.hasOwnProperty(v)||f.push(s[v]={count:0,size:0,name:v}),s[v]);v.size+=g,v.count++,t.size+=g,t.count++}f.sort((e,t)=>e.size-t.size);let b="",y=e=>("        "+e.toString()).slice(-7);for(m of f)b+=y(4*m.size)+y(m.count)+" "+m.name+"\n";var w=e=>y(4*e.obj.gcSize())+" "+e.obj.gcKey()+" "+e.path,S=a.slice(0,20).map(w).join("\n");let E="";if(3<=this.heapSnapshots.length){let t=this.heapSnapshots[this.heapSnapshots.length-3].visited,r=this.heapSnapshots[this.heapSnapshots.length-2].visited;a=a.filter(e=>!t[e.obj.id]&&r[e.obj.id]).filter(e=>!((e=e.obj)instanceof pxsim.RefRecord&&!!(e.vtable&&e.vtable.maxBgInstances&&s[e.gcKey()].count<=e.vtable.maxBgInstances)));E=a.map(w).join("\n")}return"Threads:\n"+this.threadInfo()+"\n\nSummary:\n"+b+"\n\nLarge Objects:\n"+S+"\n\nNew Objects:\n"+E}getThreads(){var e=this.otherFrames.slice();return this.currFrame&&e.indexOf(this.currFrame)<0&&e.unshift(this.currFrame),e}rootFrame(e){let t=e;for(;t.parent;)t=t.parent;return t}threadInfo(){var e;let t="";for(e of this.getThreads()){t+=`Thread ${this.rootFrame(e).threadId}:
`;for(var r of pxsim.getBreakpointMsg(e,e.lastBrkId).msg.stackframes){r=r.funcInfo;t+=`   at ${r.functionName} (${r.fileName}:${r.line+1}:${r.column+1})
`}t+="\n"}return t}static postMessage(e){e&&("undefined"!=typeof window&&window.parent&&window.parent.postMessage&&window.parent.postMessage(e,"*"),Runtime.messagePosted)&&Runtime.messagePosted(e)}static async postScreenshotAsync(e){var t=pxsim.runtime&&pxsim.runtime.board;t&&(t=await t.screenshotAsync(),Runtime.postMessage({type:"screenshot",data:t,delay:e&&e.delay}))}static requestToggleRecording(){var e=pxsim.runtime;e&&Runtime.postMessage({type:"recorder",action:e.recording?"stop":"start"})}restart(){this.kill(),setTimeout(()=>pxsim.Runtime.postMessage({type:"simulator",command:"restart"}),500)}kill(){this.dead=!0,this.stopRecording(),this.stopIdle(),this.setRunning(!1)}updateDisplay(){this.board.updateView(),this.postFrame()}startRecording(e){!this.recording&&this.running&&(this.recording=!0,this.recordingTimer=setInterval(()=>this.postFrame(),66),this.recordingLastImageData=void 0,this.recordingWidth=e)}stopRecording(){this.recording&&(this.recordingTimer&&clearInterval(this.recordingTimer),this.recording=!1,this.recordingTimer=0,this.recordingLastImageData=void 0,this.recordingWidth=void 0)}postFrame(){if(this.recording&&this.running){let t=pxsim.U.now();this.board.screenshotAsync(this.recordingWidth).then(e=>{this.recordingLastImageData&&isImageDataEqual(this.recordingLastImageData,e)||(this.recordingLastImageData=e,Runtime.postMessage({type:"screenshot",data:e,time:t}))})}}queueDisplayUpdate(){this.numDisplayUpdates++}maybeUpdateDisplay(){this.numDisplayUpdates&&(this.numDisplayUpdates=0,this.updateDisplay())}setRunning(e){this.running!=e&&(this.running=e,this.running?(this.startTime=U.now(),this.startTimeUs=U.perfNowUs(),Runtime.postMessage({type:"status",frameid:pxsim.Embed.frameid,runtimeid:this.id,state:"running"})):(this.stopRecording(),this.stopIdle(),Runtime.postMessage({type:"status",frameid:pxsim.Embed.frameid,runtimeid:this.id,state:"killed"})),this.stateChanged)&&this.stateChanged()}dumpLivePointers(){}setupPerfCounters(e){e&&e.length&&(this.perfCounters=e.map(e=>new PerfCounter(e)))}perfStartRuntime(){0!==this.perfOffset?this.perfStack++:this.perfOffset=U.perfNowUs()-this.perfElapsed}perfStopRuntime(){this.perfStack?this.perfStack--:(this.perfElapsed=this.perfNow(),this.perfOffset=0)}perfNow(){return 0===this.perfOffset&&U.userError("bad time now"),U.perfNowUs()-this.perfOffset|0}startPerfCounter(e){this.perfCounters&&((e=this.perfCounters[e]).start&&U.userError("startPerf"),e.start=this.perfNow())}stopPerfCounter(t){if(this.perfCounters){var t=this.perfCounters[t],r=(t.start||U.userError("stopPerf"),this.perfNow()-t.start);t.start=0,t.value+=r,t.numstops++;let e=t.lastFewPtr++;e>=t.lastFew.length&&(e=0,t.lastFewPtr=1),t.lastFew[e]=r}}startIdle(){void 0===this.idleTimer&&(this.idleTimer=setInterval(()=>{var e;this.running&&!this.pausedOnBreakpoint&&(e=this.board.bus)&&e.queueIdle()},20))}stopIdle(){void 0!==this.idleTimer&&(clearInterval(this.idleTimer),this.idleTimer=void 0)}schedule(t,e){if(e<=0&&(e=0),this.pausedOnBreakpoint)return this.timeoutsPausedOnBreakpoint.push(new PausedTimeout(t,e)),-1;var r=U.now();let s=new TimeoutScheduled(-1,t,e,r);return s.id=setTimeout(()=>{var e=this.timeoutsScheduled.indexOf(s);0<=e&&this.timeoutsScheduled.splice(e,1),t()},e),this.timeoutsScheduled.push(s),s.id}pauseScheduled(){this.pausedOnBreakpoint=!0,this.timeoutsScheduled.forEach(e=>{clearTimeout(e.id);var t=U.now()-e.timestampCall;let r=e.totalRuntime-t;r<=0&&(r=1),this.timeoutsPausedOnBreakpoint.push(new PausedTimeout(e.fn,r))}),this.lastPauseTimestamp=U.now(),this.timeoutsScheduled=[]}resumeAllPausedScheduled(){this.pausedOnBreakpoint=!1,this.timeoutsPausedOnBreakpoint.forEach(e=>{this.schedule(e.fn,e.timeRemaining)}),this.lastPauseTimestamp&&(this.pausedTime+=U.now()-this.lastPauseTimestamp,this.lastPauseTimestamp=0),this.timeoutsPausedOnBreakpoint=[]}cleanScheduledExpired(){let t=U.now();this.timeoutsScheduled=this.timeoutsScheduled.filter(e=>t-e.timestampCall<e.totalRuntime)}registerUserInteraction(){this.lastInteractionTime=Date.now(),this.thumbnailRecordingIntervalRef||this.lastThumbnailTime&&this.lastInteractionTime-this.lastThumbnailTime<1e3||(this.thumbnailFrames=[],this.thumbnailRecordingIntervalRef=setInterval(async()=>{var e=await this.board.screenshotAsync();this.thumbnailFrames.length&&isImageDataEqual(e,this.thumbnailFrames[this.thumbnailFrames.length-1])||(this.thumbnailFrames.push(e),(1e4<Date.now()-this.lastInteractionTime||30<this.thumbnailFrames.length)&&(clearInterval(this.thumbnailRecordingIntervalRef),this.thumbnailRecordingIntervalRef=void 0,this.lastThumbnailTime=Date.now(),Runtime.postMessage({type:"thumbnail",frames:this.thumbnailFrames})))},66))}}function throwUserException(e){throw new Error(e)}function throwTypeError(e){throwUserException(pxsim.localization.lf("TypeError: {0}",e))}function throwFailedCastError(e,t){var r=getType(e);throwTypeError(t?null==e?pxsim.localization.lf("Expected type {0} but received type {1}. Did you forget to assign a variable?",t,r):pxsim.localization.lf("Expected type {0} but received type {1}",t,r):pxsim.localization.lf("Cannot read properties of {0}",r))}function throwFailedPropertyAccessError(e,t){e=getType(e);throwTypeError(t?pxsim.localization.lf("Cannot read properties of {0} (reading '{1}')",e,t):pxsim.localization.lf("Cannot read properties of {0}",e))}function throwNullUndefinedAsObjectError(){throwTypeError(pxsim.localization.lf("Cannot convert undefined or null to object"))}function getType(e){let t;var r=null==e?void 0:e.vtable;return t=r?r.name:null===e?"null":void 0===e?"undefined":e instanceof pxsim.RefCollection?"Array":e instanceof pxsim.RefBuffer?"Buffer":e instanceof pxsim.RefAction?"function":typeof e}function setParentMuteState(e){Runtime.postMessage({type:"setmutebuttonstate",state:e})}pxsim.Runtime=Runtime,pxsim.throwUserException=throwUserException,pxsim.throwTypeError=throwTypeError,pxsim.throwFailedCastError=throwFailedCastError,pxsim.throwFailedPropertyAccessError=throwFailedPropertyAccessError,pxsim.throwNullUndefinedAsObjectError=throwNullUndefinedAsObjectError,pxsim.setParentMuteState=setParentMuteState;class PerfCounter{constructor(e){this.name=e,this.start=0,this.numstops=0,this.value=0,this.lastFew=new Uint32Array(32),this.lastFewPtr=0}}function isImageDataEqual(t,r){if(t.data.byteLength===r.data.byteLength){var s=t.data.byteLength;let e=0;for(e=0;e<s&&t.data[e]==r.data[e];++e);return e===s}}pxsim.PerfCounter=PerfCounter}(pxsim=pxsim||{}),(h=>{let a;var e;(e=a=h.SimulatorState||(h.SimulatorState={}))[e.Unloaded=0]="Unloaded",e[e.Stopped=1]="Stopped",e[e.Pending=2]="Pending",e[e.Starting=3]="Starting",e[e.Running=4]="Running",e[e.Paused=5]="Paused",e[e.Suspended=6]="Suspended";let o,c=((e=o=h.SimulatorDebuggerCommand||(h.SimulatorDebuggerCommand={}))[e.StepInto=0]="StepInto",e[e.StepOver=1]="StepOver",e[e.StepOut=2]="StepOut",e[e.Resume=3]="Resume",e[e.Pause=4]="Pause","messagechannel"),d="aspectratio",i="pxtdriver",p="permanent";h.SimulatorDriver=class{constructor(e,t={}){this.container=e,this.options=t,this.themes=["blue","red","green","yellow"],this.runId="",this.nextFrameId=0,this.frameCounter=0,this.singleSimulator=!1,this.traceInterval=0,this.breakpointsSet=!1,this._runOptions={},this.state=a.Unloaded,this._allowedOrigins=[],this.newJacdacSimulator=!1,this.frameCleanupTimeout=void 0,this.debuggerSeq=1,this.debuggerResolvers={},this._allowedOrigins.push(window.location.origin),t.parentOrigin&&this._allowedOrigins.push(t.parentOrigin),this._allowedOrigins.push(this.getSimUrl().origin);let r=(null==t?void 0:t.messageSimulators)||{},s=(Object.keys(r).map(e=>r[e]).forEach(e=>{this._allowedOrigins.push(new URL(e.url).origin),e.localHostUrl&&this._allowedOrigins.push(new URL(e.localHostUrl).origin)}),h.U.isLocalHost()&&/[?&]simxdev(?:[=&#]|$)/i.test(window.location.href));Object.entries((null==t?void 0:t.simulatorExtensions)||{}).forEach(([e,t])=>{var r;t&&t.index&&t.aspectRatio&&void 0!==t.permanent&&(s&&t.devUrl?t.url=new URL(t.index,t.devUrl).toString():(e=[(r=this.getSimUrl()).pathname.replace(/---?.*/,""),"simx",e,"-",t.index].join("/"),t.url=new URL(e.replace(/^\/+/,""),r.origin).toString()),this._allowedOrigins.push(new URL(t.url).origin))}),this._allowedOrigins=h.U.unique(this._allowedOrigins,e=>e)}isDebug(){return this._runOptions&&!!this._runOptions.debug}isTracing(){return this._runOptions&&!!this._runOptions.trace}hasParts(){return this._runOptions&&this._runOptions.parts&&!!this._runOptions.parts.length}setDirty(){this.state==h.SimulatorState.Running&&this.suspend()}setPending(){this.setState(a.Pending)}focus(){var e=this.simFrames()[0];e&&e.focus()}registerDependentEditor(e){e&&(this._dependentEditors||(this._dependentEditors=[]),this._dependentEditors.push(e))}dependentEditors(){return this._dependentEditors&&(this._dependentEditors=this._dependentEditors.filter(e=>!!e.parent),this._dependentEditors.length||(this._dependentEditors=void 0)),this._dependentEditors}setStarting(){this.setState(a.Starting)}setHwDebugger(e){e?(this.hwdbg=e,this.setState(a.Running),this.container.style.opacity="0.3"):(delete this.container.style.opacity,this.hwdbg=null,this.setState(a.Running),this.stop())}handleHwDebuggerMsg(e){this.hwdbg&&this.handleMessage(e)}setThemes(e){h.U.assert(e&&0<e.length),this.themes=e}startRecording(e){this.simFrames()[0]&&this.postMessage({type:"recorder",action:"start",source:i,width:e})}stopRecording(){this.postMessage({type:"recorder",source:i,action:"stop"})}setFrameState(e){var t=e.nextElementSibling,r=t.nextElementSibling;switch(this.state){case a.Pending:case a.Starting:t.style.display="",t.className="",r.style.display="";break;case a.Stopped:case a.Suspended:h.U.addClass(e,this.state==a.Stopped||this._runOptions&&this._runOptions.autoRun?this.stoppedClass:this.invalidatedClass),this._runOptions&&this._runOptions.autoRun?t.style.display="none":(t.style.display="",t.className="videoplay xicon icon"),r.style.display="none",this.scheduleFrameCleanup();break;default:h.U.removeClass(e,this.stoppedClass),h.U.removeClass(e,this.invalidatedClass),t.style.display="none",r.style.display="none"}}setState(e){this.state!=e&&(this.state=e,this.freeze(this.state==a.Paused),this.simFrames().forEach(e=>this.setFrameState(e)),this.options.onStateChanged)&&this.options.onStateChanged(this.state)}freeze(e){let r="pause-overlay";e?h.util.toArray(this.container.querySelectorAll("div.simframe")).forEach(e=>{var t;e.querySelector("div."+r)||((t=document.createElement("div")).className=r,t.onclick=e=>(e.preventDefault(),!1),e.appendChild(t))}):h.util.toArray(this.container.querySelectorAll("div.simframe div."+r)).forEach(e=>e.parentElement.removeChild(e))}simFrames(e=!1){var t=h.util.toArray(this.container.getElementsByTagName("iframe")),r=this.loanedIFrame();return r&&!e&&t.unshift(r),t}getSimUrl(){var t=this.options.simUrl||(null==(t=window.pxtConfig)?void 0:t.simUrl)||(null==(t=pxt.webConfig)?void 0:t.simUrl)||location.origin+"/sim/simulator.html";try{return new URL(t)}catch(e){return new URL(t,location.origin)}}setSingleSimulator(){this.singleSimulator=!0}postMessage(r,s,i){if(this.hwdbg)this.hwdbg.postMessage(r);else{var e=this.dependentEditors();let n=this.simFrames(),t=(i&&(n=n.filter(e=>e.id===i)),!1);var a=r;if(s&&null!=a&&a.broadcast){a.srcFrameIndex=this.simFrames().findIndex(e=>e.contentWindow===s);var o=!(null==(o=this._currentRuntime)||!o.single),l=window.parent&&window.parent!==window.window?window.parent:window.opener;if(l&&s!==l&&l.postMessage(r,"*"),!(this.options.nestedEditorSim||null!=a&&a.toParentIFrameOnly))if(e)e.forEach(e=>{s!==e&&e.postMessage(r,window.location.origin)});else if(!o){let i="messagepacket"===r.type&&r.channel;var l=i&&this.options.messageSimulators&&this.options.messageSimulators[i],a=i&&this.options.simulatorExtensions&&this.options.simulatorExtensions[i],e=(e,t,r)=>{r=r||(null==(s=this._runOptions)?void 0:s.aspectRatio)||1.22;var s=this.createFrame(e),e=(this.container.appendChild(s),s.firstElementChild);e.dataset[c]=i,e.dataset[d]=r+"",h.U.addClass(s,"simmsg"),h.U.addClass(s,"simmsg"+h.U.sanitizeCssName(i)),t&&(e.dataset[p]="true"),this.startFrame(e),n=this.simFrames()};a?(o=n.find(e=>e.dataset[c]===i),"jacdac/pxt-jacdac"===i&&(this.newJacdacSimulator=!0),o?o.dataset.runid!=this.runId&&this.startFrame(o):(o=new URL(a.url),this.options.parentOrigin&&o.searchParams.set("parentOrigin",encodeURIComponent(this.options.parentOrigin)),this.options.userLanguage&&o.searchParams.set("language",encodeURIComponent(this.options.userLanguage)),e(o.toString(),a.permanent,a.aspectRatio))):l?(o=n.find(e=>e.dataset[c]===i))?o.dataset.runid!=this.runId&&this.startFrame(o):"jacdac"===i&&this.newJacdacSimulator||e((h.U.isLocalHost()&&/localhostmessagesims=1/i.test(window.location.href)&&l.localHostUrl||l.url).replace("$PARENT_ORIGIN$",encodeURIComponent(this.options.parentOrigin||"")).replace("$LANGUAGE$",encodeURIComponent(this.options.userLanguage)),l.permanent,l.aspectRatio):(t=!0,a=n.filter(e=>!e.dataset[c]),i||0!=a.length&&(1!=a.length||this.singleSimulator)?2==a.length&&a[1].dataset.runid!=this.runId&&this.startFrame(a[1]):(this.container.appendChild(this.createFrame()),n=this.simFrames()))}}for(let e=0;e<n.length;++e){var u=n[e];if((!s||u.contentWindow!=s)&&(u.contentWindow&&(t?this.postDeferrableMessage(u,r):this.postMessageCore(u,r),"recorder"==r.type)&&"start"==r.action))break}}}postDeferrableMessage(e,t){!e.dataset.loading?this.postMessageCore(e,t):(this.deferredMessages||(this.deferredMessages=[]),this.deferredMessages.push([e,t]))}postMessageCore(e,t){var r=h.U.isLocalHostDev()?"*":e.dataset.origin;e.contentWindow.postMessage(t,r)}setRunOptionQueryParams(e){var t,r=new URL(e);if(null!=(e=this._runOptions)&&e.hideSimButtons&&r.searchParams.set("hideSimButtons","1"),null!=(e=this._runOptions)&&e.queryParameters)for(t of this._runOptions.queryParameters.split("&")){var[s,i]=t.split(/[:=]/);s&&i&&r.searchParams.set(s,i)}return r.toString()}createFrame(e){var t=document.createElement("div");t.className="simframe ui embed";let r=document.createElement("iframe");r.id="sim-frame-"+this.nextId(),r.title=h.localization.lf("Simulator"),r.allowFullscreen=!0,r.setAttribute("allow","autoplay;microphone"),r.setAttribute("sandbox","allow-same-origin allow-scripts"),r.className="no-select";var e=this.setRunOptionQueryParams(e||this.getSimUrl().toString()),e=(e+="#"+r.id,r.src=e,r.frameBorder="0",r.dataset.runid=this.runId,r.dataset.origin=new URL(e).origin||"*",r.dataset.loading="true",null!=(e=this._runOptions)&&e.autofocus&&r.setAttribute("autofocus","true"),t.appendChild(r),document.createElement("i")),s=(e.className="videoplay xicon icon",e.style.display="none",e.onclick=e=>(e.preventDefault(),this.state!=a.Running&&this.state!=a.Starting&&(this.options.restart?this.options.restart():this.start()),r.focus(),!1),t.appendChild(e),document.createElement("div"));return s.className="ui active loader",e.style.display="none",t.appendChild(s),this._runOptions&&this.applyAspectRatioToFrame(r),t}preload(e,t){this.addEventListeners(),t&&(this._currentRuntime=void 0,this.container.textContent=""),this.simFrames().length||(this.container.appendChild(this.createFrame()),this.applyAspectRatio(e),this.setStarting())}stop(e=!1,t=!1){this.state!==a.Stopped&&this.state!==a.Unloaded&&(this.clearDebugger(),this.stopSound(),this.postMessage({type:"stop",source:i}),this.setState(t?a.Starting:a.Stopped)),e&&this.unload()}suspend(){this.stopSound(),this.postMessage({type:"stop",source:i}),this.setState(a.Suspended)}unload(){this.cancelFrameCleanup(),h.U.removeChildren(this.container),this.setState(a.Unloaded),this._runOptions=void 0,this._currentRuntime=void 0,this.runId=void 0,this.deferredMessages=void 0}mute(e){this._currentRuntime&&(this._currentRuntime.mute=e),this.postMessage({type:"mute",source:i,mute:e})}stopSound(){this.postMessage({type:"stopsound",source:i})}isLoanedSimulator(e){return!!this.loanedSimulator&&this.loanedIFrame()==e}loanSimulator(){return this.loanedSimulator||(this.loanedSimulator=this.container.firstElementChild||this.createFrame(),this.loanedSimulator.parentNode&&this.container.removeChild(this.loanedSimulator)),this.loanedSimulator}unloanSimulator(){this.loanedSimulator&&(this.loanedSimulator.parentNode&&this.loanedSimulator.parentNode.removeChild(this.loanedSimulator),this.container.insertBefore(this.loanedSimulator,this.container.firstElementChild),delete this.loanedSimulator)}loanedIFrame(){return this.loanedSimulator&&this.loanedSimulator.parentNode&&this.loanedSimulator.querySelector("iframe")}cancelFrameCleanup(){this.frameCleanupTimeout&&(clearTimeout(this.frameCleanupTimeout),this.frameCleanupTimeout=void 0)}scheduleFrameCleanup(){this.cancelFrameCleanup(),this.frameCleanupTimeout=setTimeout(()=>{this.frameCleanupTimeout=void 0,this.cleanupFrames()},5e3)}applyAspectRatio(t){(t||this._runOptions)&&this.simFrames().forEach(e=>this.applyAspectRatioToFrame(e,t))}applyAspectRatioToFrame(e,t){let r,s,i,n,a=t;void 0===a&&(t=parseFloat(e.dataset[d]),isNaN(t)||(a=t)),void 0===(a=void 0===a&&(t=e.dataset[c])&&(t=null==(i=null==(s=null==(r=this.options)?void 0:r.messageSimulators)?void 0:s[t])?void 0:i.aspectRatio)?t:a)&&(a=(null==(n=this._runOptions)?void 0:n.aspectRatio)||1.22),e.parentElement.style.paddingBottom=100/a+"%"}cleanupFrames(){var e=this.simFrames(!0);e.shift(),e.filter(e=>!e.dataset[p]).forEach(e=>{this.state!=a.Stopped&&e.dataset.runid==this.runId||(this.options.removeElement?this.options.removeElement(e.parentElement):e.parentElement.remove())})}hide(t){var e;this.suspend(),this.options.removeElement&&((e=this.simFrames()).forEach(e=>{this.options.removeElement(e.parentElement,t)}),0==e.length)&&t&&t()}unhide(){this.options.unhideElement&&this.simFrames().forEach(e=>{this.options.unhideElement(e.parentElement)})}setRunOptions(e={}){this._runOptions=e}run(e,t={}){this.setRunOptions(t),this.runId=this.nextId(),this._currentRuntime={type:"run",source:i,boardDefinition:t.boardDefinition,parts:t.parts,builtinParts:t.builtinParts,fnArgs:t.fnArgs,code:e,partDefinitions:t.partDefinitions,mute:t.mute,highContrast:t.highContrast,light:t.light,cdnUrl:t.cdnUrl,localizedStrings:t.localizedStrings,refCountingDebug:t.refCountingDebug,version:t.version,clickTrigger:t.clickTrigger,breakOnStart:t.breakOnStart,storedState:t.storedState,ipc:t.ipc,single:t.single,dependencies:t.dependencies,activePlayer:t.activePlayer,theme:t.theme},this.stopSound(),this.start()}restart(){this.stop(),this.cleanupFrames(),this.start()}areBreakpointsSet(){return this.breakpointsSet}start(){if(this.clearDebugger(),this.addEventListeners(),this.applyAspectRatio(),this.scheduleFrameCleanup(),this._currentRuntime){this.singleSimulator=!1,this.breakpointsSet=!1;let e=this.simFrames()[0];var t;e||(t=this.createFrame(),this.container.appendChild(t),e=t.firstElementChild),this.startFrame(e),this.debuggingFrame=e.id,this.setState(a.Running),this.setTraceInterval(this.traceInterval)}}startFrame(e){var t,r;return!(!this._currentRuntime||!e.contentWindow||((t=JSON.parse(JSON.stringify(this._currentRuntime))).frameCounter=++this.frameCounter,r=(null==(r=this._runOptions)?void 0:r.mpRole)||(null==(r=null==(r=/[\&\?]mp=(server|client)/i.exec(window.location.href))?void 0:r[1])?void 0:r.toLowerCase()),t.options={theme:this.themes[this.nextFrameId++%this.themes.length],mpRole:r},t.id=t.options.theme+"-"+this.nextId(),e.dataset.runid=this.runId,e.dataset.runtimeid=t.id,e.id!==this.debuggingFrame&&(t.traceDisabled=!0,t.breakOnStart=!1),this.postMessageCore(e,t),this.traceInterval&&this.setTraceInterval(this.traceInterval),this.applyAspectRatioToFrame(e),this.setFrameState(e),0))}handleDeferredMessages(t){var e;t.dataset.loading&&(delete t.dataset.loading,null!=(e=null==(e=this.deferredMessages)?void 0:e.filter(e=>e[0]===t))&&e.forEach(e=>{var[,e]=e;this.postMessageCore(t,e)}),this.deferredMessages=null==(e=this.deferredMessages)?void 0:e.filter(e=>e[0]!==t))}handleMessage(e,t){switch(e.type||""){case"ready":var r=e.frameid,r=document.getElementById(r);r&&(null!=(s=this._runOptions)&&s.autofocus&&r.focus(),this.startFrame(r),this.options.revealElement&&this.options.revealElement(r),this.handleDeferredMessages(r)),this.options.onSimulatorReady&&this.options.onSimulatorReady();break;case"status":var s=e.frameid,i=document.getElementById(s);if(i)if(e.runtimeid==i.dataset.runtimeid)switch(e.state){case"running":this.setState(a.Running),this.handleDeferredMessages(i);break;case"killed":this.setState(a.Stopped)}break;case"simulator":this.handleSimulatorCommand(e);break;case"serial":case"pxteditor":case"screenshot":case"custom":case"recorder":case"addextensions":break;case"aspectratio":var r=e,s=r.frameid,s=document.getElementById(s);s&&(s.dataset[d]=r.value+"",this.applyAspectRatioToFrame(s));break;case"debugger":this.handleDebuggerMessage(e);break;case"toplevelcodefinished":this.options.onTopLevelCodeEnd&&this.options.onTopLevelCodeEnd();break;case"setmutebuttonstate":null!=(s=(r=this.options).onMuteButtonStateChange)&&s.call(r,e.state);break;default:this.postMessage(e,t)}}addEventListeners(){this.listener||(this.listener=e=>{this.hwdbg||!h.U.isLocalHost()&&this._allowedOrigins.indexOf(e.origin)<0||this.handleMessage(e.data,e.source)},window.addEventListener("message",this.listener,!1))}removeEventListeners(){this.listener&&(window.removeEventListener("message",this.listener,!1),this.listener=void 0)}resume(e){let t;switch(e){case o.Resume:t="resume",this.setState(a.Running);break;case o.StepInto:t="stepinto",this.setState(a.Running);break;case o.StepOut:t="stepout",this.setState(a.Running);break;case o.StepOver:t="stepover",this.setState(a.Running);break;case o.Pause:t="pause";break;default:return void h.debug("unknown command")}this.postMessage({type:"debugger",subtype:t,source:i})}setBreakpoints(e){this.breakpointsSet=!0,this.postDebuggerMessage("config",{setBreakpoints:e},void 0,this.debuggingFrame)}setTraceInterval(e){this.traceInterval=e,this.postDebuggerMessage("traceConfig",{interval:e})}variablesAsync(e,t,r=!1){return this.postDebuggerMessageAsync("variables",{variablesReference:e,fields:t,includeAll:r},this.debuggingFrame).then(e=>e,e=>{})}handleSimulatorCommand(e){this.options.onSimulatorCommand&&this.options.onSimulatorCommand(e)}clearDebugger(){let t=new Error("Debugging cancelled");Object.keys(this.debuggerResolvers).forEach(e=>{e=this.debuggerResolvers[e].reject;e(t)}),this.debuggerResolvers={},this.debuggerSeq++}handleDebuggerMessage(e){var t;switch("trace"!==e.subtype&&h.log("DBG-MSG",e.subtype,e),e.seq&&(t=this.debuggerResolvers[e.seq].resolve,t)&&t(e),e.subtype){case"warning":this.options.onDebuggerWarning&&this.options.onDebuggerWarning(e);break;case"breakpoint":var r,s=e;if(this.state==a.Running){s.exceptionMessage?this.suspend():(this.setState(a.Paused),1<this.simFrames(!0).length&&this.resume(o.Pause)),this.options.onDebuggerBreakpoint&&this.options.onDebuggerBreakpoint(s);let e=s.exceptionMessage+"\n";for(r of s.stackframes){var i=r.funcInfo;e+=`   at ${i.functionName} (${i.fileName}:${i.line+1}:${i.column+1})
`}s.exceptionMessage&&h.error(e)}else h.error("debugger: trying to pause from "+this.state);break;case"trace":s=e;this.state==a.Running&&this.options.onTraceMessage&&this.options.onTraceMessage(s);break;default:var n,s=e.req_seq;s&&(n=this.debuggerResolvers[s].resolve,n)&&(delete this.debuggerResolvers[s],n(e))}}postDebuggerMessageAsync(s,i={},n){return new Promise((e,t)=>{var r=this.debuggerSeq++;this.debuggerResolvers[r.toString()]={resolve:e,reject:t},this.postDebuggerMessage(s,i,r,n)})}postDebuggerMessage(e,t={},r,s){t=JSON.parse(JSON.stringify(t));t.type="debugger",t.subtype=e,t.source=i,r&&(t.seq=r),this.postMessage(t,void 0,s)}nextId(){return this.nextFrameId+++(Math.random()+""+Math.random()).replace(/[^\d]/,"")}get stoppedClass(){return this.options&&this.options.stoppedClass||"grayscale"}get invalidatedClass(){return this.options&&this.options.invalidatedClass||"sepia"}}})(pxsim=pxsim||{}),(C=>{C.mkRange=function(e,t){for(var r=[];e<t;e++)r.push(e);return r},C.EventBus=class{constructor(e,t,r){this.runtime=e,this.board=t,this.valueToArgs=r,this.queues={},this.backgroundHandlerFlag=!1,this.nextNotifyEvent=1024,this.schedulerID=15,this.idleEventID=2,this.board.addMessageListener(this.handleMessage.bind(this))}handleMessage(e){"eventbus"===e.type&&this.queue(e.id,e.eventid,e.value)}setBackgroundHandlerFlag(){this.backgroundHandlerFlag=!0}setNotify(e,t){this.notifyID=e,this.notifyOneID=t}setIdle(e,t){this.schedulerID=e,this.idleEventID=t}start(e,t,r,s=!1){r=(r?"back":"fore")+":"+e+":"+t;return!this.queues[r]&&s&&(this.queues[r]=new C.EventQueue(this.runtime,this.valueToArgs)),this.queues[r]}listen(e,t,r,s=0){e==this.schedulerID&&t==this.idleEventID&&this.runtime.startIdle();e=this.start(e,t,this.backgroundHandlerFlag,!0);this.backgroundHandlerFlag?e.addHandler(r,s):e.setHandler(r,s),this.backgroundHandlerFlag=!1}removeBackgroundHandler(t){Object.keys(this.queues).forEach(e=>{e.startsWith("back:")&&this.queues[e].removeHandler(t)})}getQueues(e,t,r){var s=[this.start(0,0,r)];return 0==e&&0==t||(t&&s.push(this.start(0,t,r)),e&&s.push(this.start(e,0,r)),e&&t&&s.push(this.start(e,t,r))),s}queue(e,r,s=null){if(!C.runtime.pausedOnBreakpoint){let t=this.notifyID&&this.notifyOneID&&e==this.notifyOneID;t&&(e=this.notifyID);e=this.getQueues(e,r,!0).concat(this.getQueues(e,r,!1));this.lastEventValue=r,this.lastEventTimestampUs=C.U.perfNowUs(),C.U.promiseMapAllSeries(e,e=>e?e.push(s,t):Promise.resolve())}}queueIdle(){this.schedulerID&&this.idleEventID&&this.queue(this.schedulerID,this.idleEventID)}wait(e,t,r){this.start(e,t,!1,!0).addAwaiter(r)}getLastEventValue(){return this.lastEventValue}getLastEventTime(){return 4294967295&this.lastEventTimestampUs-C.runtime.startTimeUs}},C.AnimationQueue=class{constructor(r){this.runtime=r,this.queue=[],this.process=()=>{var e,t=this.queue[0];t&&!this.runtime.dead&&(r=this.runtime,e=t.frame(),r.queueDisplayUpdate(),r.maybeUpdateDisplay(),!1===e?(this.queue.shift(),this.queue[0]&&(this.queue[0].setTimeoutHandle=setTimeout(this.process,this.queue[0].interval)),t.whenDone(!1)):t.setTimeoutHandle=setTimeout(this.process,t.interval))}}cancelAll(){var e,t=this.queue;this.queue=[];for(e of t)e.whenDone(!0),e.setTimeoutHandle&&clearTimeout(e.setTimeoutHandle)}cancelCurrent(){var e=this.queue[0];e&&(this.queue.shift(),e.whenDone(!0),e.setTimeoutHandle)&&clearTimeout(e.setTimeoutHandle)}enqueue(e){e.whenDone||(e.whenDone=()=>{}),this.queue.push(e),1==this.queue.length&&this.process()}executeAsync(r){return C.U.assert(!r.whenDone),new Promise((e,t)=>{r.whenDone=e,this.enqueue(r)})}};{var e=C.AudioContextManager||(C.AudioContextManager={});let s=0,t,i,n,a=!1,o,r=[],l=[],u;function R(){return t||(t=(()=>{if(window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext)try{return new window.AudioContext}catch(e){}})())&&((u=t.createGain()).connect(t.destination),u.gain.setValueAtTime(1,0)),t}function g(){w(0),s=0,o&&o.pause()}function v(e,t){e.gain.value&&e.gain.setTargetAtTime(0,R().currentTime,.015),setTimeout(()=>{e.disconnect(),t&&t.disconnect()},450)}e.isAudioElementActive=function(){return!!n},e.mute=function(e){a=e;var t=R();e?u.gain.setTargetAtTime(0,t.currentTime,.015):u.gain.setTargetAtTime(1,t.currentTime,.015),!e&&t&&"suspended"===t.state&&t.resume()},e.isMuted=function(){return a},e.stopAll=function(){g(),b();for(var e of l)e()},e.stop=function(){if(g(),n){try{v(n,i)}catch(e){}n=void 0,i=void 0}},e.onStopAll=function(e){l.push(e)},e.frequency=function(){return s};let h=[null,"triangle","sawtooth","sine"],c,d,p=[],m=[];function k(e,t){var r=h[e];if(r)return(i=R().createOscillator()).type=r,i.frequency.value=t,i;let s;if(4==e)s=(()=>{if(!d){var r=(d=R().createBuffer(1,131072,R().sampleRate)).getChannelData(0);let t=251771520;for(let e=0;e<131072;e+=4)32768&(t=(t=(t^=t<<13)^t>>17)^t<<5)?(r[e]=1,r[e+1]=1,r[e+2]=-1,r[e+3]=-1):(r[e]=0,r[e+1]=0,r[e+2]=0,r[e+3]=0)}return d})();else if(5==e)s=(()=>{if(!c){var r=(c=R().createBuffer(1,1e5,R().sampleRate)).getChannelData(0);let t=251771520;for(let e=0;e<1e5;e++)t=(t=(t^=t<<13)^t>>17)^t<<5,r[e]=(1023&t)/512-1}return c})();else if(11<=e&&e<=15)s=(t=>{if(!m[t]){var e=R().createBuffer(1,1024,R().sampleRate),r=e.getChannelData(0);for(let e=0;e<1024;e++)r[e]=e<t/100*1024?1:-1;m[t]=e}return m[t]})(10*(e-10));else{if(!(16<=e&&e<=18))return null;s=(t=>{if(!p[t]){var e=R().createBuffer(1,1024,R().sampleRate),r=e.getChannelData(0),s=[770763591,3356908179],i=[15,31,63];for(let e=0;e<1024;e+=4){var n=e/4;0!=(s[(n&=i[t-4])>>5]&1<<(31&n))?(r[e]=1,r[e+1]=1,r[e+2]=-1,r[e+3]=-1):(r[e]=0,r[e+1]=0,r[e+2]=0,r[e+3]=0)}p[t]=e}return p[t]})(e-16+4)}var r=R().createBufferSource(),i=(r.buffer=s,r.loop=!0,4==e||16<=e&&e<=18);return i?r.playbackRate.value=t/(R().sampleRate/4):5!=e&&(r.playbackRate.value=t/(R().sampleRate/1024)),r}class E{constructor(){this.gain=R().createGain(),this.gain.connect(u),this.gain.gain.value=0}disconnectNodes(){this.gain?v(this.gain,this.generator):this.generator&&(this.generator.stop&&this.generator.stop(),this.generator.disconnect()),this.gain=null,this.generator=null}remove(){var e=r.indexOf(this);0<=e&&r.splice(e,1),this.disconnectNodes()}}let f=1;function b(){for(null!=e.soundEventCallback&&e.soundEventCallback("muteallchannels"),f++;r.length;)r[0].remove()}function y(e,t){if(!(e<0)){s=e;var r=R();if(r){t=Math.max(0,Math.min(1,t));try{i||(i=r.createOscillator(),(n=r.createGain()).gain.value=0,i.type="triangle",i.connect(n),n.connect(u),i.start(0)),w(t)}catch(e){return i=void 0,void(n=void 0)}i.frequency.value=e,w(t)}}}function w(e){null!=n&&n.gain&&n.gain.setTargetAtTime(e,t.currentTime,.015)}function S(E,x,I){return new Promise(async t=>{null!=e.soundEventCallback&&e.soundEventCallback("playinstructions",E);let r=!1,s=R(),i=_(),n=(i.gain.gain.value=1,{}),a={},o=s.currentTime,l=o,u=0,h=0;var c=(e,t)=>e/1024/4*(t?.5:1);let d=()=>{if(!r){r=!0,i.disconnectNodes();for(var e of Object.keys(n))n[e].stop(),n[e].disconnect(),a[e].disconnect();t()}};for(let e=0;e<E.length;e+=12){var p,m,f,g=E[e],v=T(E,e+2),b=T(E,e+4)/1e3,y=T(E,e+6),w=T(E,e+8),S=T(E,e+10);h+=b,0===g?l+=b:(p=11<=g&&g<=15,m=(n[g]||(n[g]=k(g,v),a[g]=s.createGain(),a[g].gain.value=0,a[g].connect(i.gain),n[g].connect(a[g]),n[g].start()),u&&g!==u&&a[u].gain.setTargetAtTime(0,l,.015),n[g]),f=a[g],m instanceof OscillatorNode?(m.frequency.setValueAtTime(v,l),m.frequency.linearRampToValueAtTime(S,l+b)):4==g||16<=g&&g<=18?m.playbackRate.linearRampToValueAtTime(S/(s.sampleRate/4),l+b):5!=g&&m.playbackRate.linearRampToValueAtTime(S/(s.sampleRate/1024),l+b),f.gain.setValueAtTime(c(y,p),l),f.gain.linearRampToValueAtTime(c(w,p),l+b),u=g,l+=b)}if(i.gain.gain.setTargetAtTime(0,l,.015),x||I){let r=()=>{var e,t=s.currentTime;t>o+h||(x&&x()?d():({frequency:t,volume:e}=((t,r)=>{let s=0;for(let e=0;e<r.length;e+=12){var i,n=T(r,e+2),a=T(r,e+4),o=T(r,e+6),l=T(r,e+8),u=T(r,e+10);if(!(s+a<t))return i=(t-s)/a,{frequency:n+(u-n)*i,volume:o+(l-o)*i};s+=a}return{frequency:-1,volume:-1}})(1e3*(t-o),E),I&&I(t,e/1024),requestAnimationFrame(r)))};requestAnimationFrame(r)}await C.U.delay(1e3*h),d()})}function T(e,t){var r=new Uint8Array(2);return r[0]=e[t],r[1]=e[t+1],new Uint16Array(r.buffer)[0]}function _(){20<r.length&&r[0].remove();var e=new E;return r.push(e),e}e.muteAllChannels=b,e.queuePlayInstructions=function(e,t){let r=f;C.U.delay(e).then(()=>r!=f?Promise.resolve():S(t.data))},e.tone=y,e.setCurrentToneGain=w,e.playBufferAsync=function(s){return s?new Promise(e=>{function t(){e&&e(),e=void 0}var r="data:audio/wav;base64,"+window.btoa((t=>{var r=t.length;let s="";for(let e=0;e<r;++e)s+=String.fromCharCode(t[e]);return s})(s.data));o=new Audio(r),a&&(o.volume=0),o.onended=()=>t(),o.onpause=()=>t(),o.onerror=()=>t(),o.play()}):Promise.resolve()},e.playPCMBufferStreamAsync=function(d,p,e=.3,t){return new Promise(n=>{let a=[],o=R().currentTime,l=!1,u=_(),h=(u.gain.gain.setValueAtTime(e,R().currentTime),()=>!!(t&&t()||!u.gain)&&(n&&n(),n=void 0,u.remove(),!0));function c(){for(;!l&&a.length<3&&!h();){var e=d();if(!e||!e.length){l=!0;break}s=i=r=t=void 0;var t=e;if(!h()){var r=R().createBuffer(1,t.length,p);if(r.copyToChannel)r.copyToChannel(t,0);else{var s=r.getChannelData(0);for(let e=0;e<t.length;e++)s[e]=t[e]}var i=R().createBufferSource();a.push(i),i.connect(u.gain),i.buffer=r,i.addEventListener("ended",()=>{a.shift().disconnect(),c()}),i.start(o),o+=r.duration}}l&&0===a.length&&(u.remove(),n&&n(),n=void 0)}c()})},e.playInstructionsAsync=S,e.sendMidiMessage=function(e){var t,r,s;(e=e.data).length&&(t=e[0]>>4,r=15&e[0],s=440*Math.pow(2,((e[1]||0)-69)/12),8==t||9==t&&0==(e[2]||0)?g():9==t&&(y(s,1),9==r)&&setTimeout(()=>g(),500))},e.startSamplePlayback=function(a,o,l,u,h){let c,d;return{promise:new Promise(e=>{d=e;let t=1;u<3e3?(t=u/3e3,u=3e3):768e3<u&&(t=u/768e3,u=768e3);var r=C.BufferMethods.fmtInfo(o).size,s=R().createBuffer(1,a.data.length/r,u),i=s.getChannelData(0);for(let e=0;e<s.length;e++)i[e]=C.BufferMethods.getNumber(a,o,e*r)/l*2-1;c=_();var n=R().createBufferSource();n.playbackRate.value=t,c.gain.gain.value=h,c.generator=n,c.generator.buffer=s,c.generator.connect(c.gain),c.generator.start(0),c.generator.addEventListener("ended",()=>{c.remove(),c=void 0,e()})}),cancel:()=>{c&&(c.remove(),c=void 0,d())}}},e.createAudioSourceNode=function(e,t,r){var e=new Audio(e),s=R().createMediaElementSource(e),i=R().createWaveShaper();return i.curve=(e=>{var t=new Float32Array(44100),r=1/(e=Math.max(.01,Math.min(1,e)));for(let e=0;e<44100;e++){var s=(2*e/44100-1)*r;t[e]=Math.max(-1,Math.min(1,s))}return t})(t),i.oversample="4x",(t=_()).generator=i,t.generator.connect(t.gain),s.connect(i),t.gain.gain.value=.1*r,e}}function t(){return"undefined"!=typeof window&&("ontouchstart"in window||navigator&&0<navigator.maxTouchPoints)}function r(){return"undefined"!=typeof window&&!!window.PointerEvent}C.isTouchEnabled=t,C.hasPointerEvents=r,C.pointerEvents=r()?{up:"pointerup",down:["pointerdown"],move:"pointermove",enter:"pointerenter",leave:"pointerleave"}:t()?{up:"mouseup",down:["mousedown","touchstart"],move:"touchmove",enter:"touchenter",leave:"touchend"}:{up:"mouseup",down:["mousedown"],move:"mousemove",enter:"mouseenter",leave:"mouseleave"}})(pxsim=pxsim||{}),(w=>{var t;function i(t,r){return e=>e*(r/t)}function r(e,t){var r=e[0]-t[0],e=e[1]-t[1];return r*r+e*e}(t=w.visuals||(w.visuals={})).translateEl=function(e,t){w.svg.hydrate(e,{transform:`translate(${t[0]} ${t[1]})`})},t.composeSVG=function(e){var[t,r]=[e.el1,e.el2],s=(w.U.assert(0==t.x&&0==t.y&&0==r.x&&0==r.y,"el1 and el2 x,y offsets not supported"),(e,t,r)=>w.svg.hydrate(e,{x:t,y:r})),i=(e,t,r)=>w.svg.hydrate(e,{width:t+"px",height:r+"px"}),n=e.scaleUnit2;let a=e.scaleUnit2/e.scaleUnit1;var o=t.w*a,l=t.h*a,u=(i(t.el,o,l),+r.w),h=+r.h,[i,c,d,p]=(i(r.el,u,h),e.margin),m=e.middleMargin,f=Math.max(o,u);let g=c+(f-o)/2,v=i,b=(s(t.el,g,v),c+(f-u)/2),y=v+l+m;return s(r.el,b,y),o=[v,v+l,y,y+h],u=w.svg.elt("svg",{version:"1.0",viewBox:`0 0 ${c+f+p} `+(i+l+m+h+d),class:"sim-bb"}),c=u,f=e.maxWidth,p=e.maxHeight,f&&w.svg.hydrate(c,{width:f}),p&&w.svg.hydrate(c,{height:p}),s(u,0,0),i=w.svg.child(u,"g"),u.appendChild(t.el),u.appendChild(r.el),l=w.svg.child(u,"g"),{under:i,over:l,host:u,edges:o,scaleUnit:n,toHostCoord1:e=>{var[e,t]=e;return[e*a+g,t*a+v]},toHostCoord2:e=>{var[e,t]=e;return[+e+b,+t+y]}}},t.mkScaleFn=i,t.mkImageSVG=function(e){var t=(r=i(e.imageUnitDist,e.targetUnitDist))(e.width),r=r(e.height),s=w.svg.elt("image",{width:t,height:r});return s.setAttributeNS("http://www.w3.org/1999/xlink","href",""+e.image),{el:s,w:t,h:r,x:0,y:0}},t.findDistSqrd=r,t.findClosestCoordIdx=function(t,e){return e.map(e=>r(t,e)).reduce((e,t,r,s)=>t<s[e]?r:e,0)},t.mkTxt=function(e,t,r,s,i,n,a){var o=w.svg.elt("text"),n=(n=n||-.33333)*r*i.length;return w.svg.hydrate(o,{style:`font-size:${r}px;`,transform:`translate(${e} ${t}) rotate(${s}) translate(${n} ${(a=a||.3)*r})`}),w.U.addClass(o,"noselect"),o.textContent=i,o},t.GPIO_WIRE_COLORS=["pink","orange","yellow","green","purple"],t.WIRE_COLOR_MAP={black:"#514f4d",white:"#fcfdfc",gray:"#acabab",purple:"#a772a1",blue:"#01a6e8",green:"#3cce73",yellow:"#ece600",orange:"#fdb262",red:"#f44f43",brown:"#c89764",pink:"#ff80fa"},t.mapWireColor=function(e){return t.WIRE_COLOR_MAP[e]||e},t.PIN_DIST=15,t.rgbToHsl=function(e){var[e,t,r]=e,[e,t,r]=[e/255,t/255,r/255],s=Math.min(e,t,r),i=Math.max(e,t,r),n=i-s;let a,o,l;return s=i+s,l=s/2*100,o=0==n?a=0:(i===e?a=(t-r)/n%6*60:i===t?a=60*((r-e)/n+2):i===r&&(a=60*((e-t)/n+4)),50<l?n/(2-s)*100:n/s*100),[Math.floor(a),Math.floor(o),Math.floor(l)]}})(pxsim=pxsim||{}),(o=>{var s,e;function i(e,t,r){e={class:e,d:t},r&&(e.title=r),t=s.elt("path");return s.hydrate(t,e),t}function n(e,t=!1){var r=s.elt("linearGradient");s.hydrate(r,{id:e,x1:"0%",y1:"0%",x2:t?"100%":"0%",y2:t?"0%":"100%"}),s.child(r,"stop",{offset:"0%"}),s.child(r,"stop",{offset:"100%"}),s.child(r,"stop",{offset:"100%"}),s.child(r,"stop",{offset:"100%"});return r}function r(e){var t=s.elt("title");return t.textContent=e,t}(e=s=o.svg||(o.svg={})).parseString=function(e){return(new DOMParser).parseFromString(e,"image/svg+xml").getElementsByTagName("svg").item(0)},e.toDataUri=function(e){return"data:image/svg+xml,"+encodeURI(e)},e.cursorPoint=function(e,t,r){return e.x=null!=r.clientX?r.clientX:r.pageX,e.y=null!=r.clientY?r.clientY:r.pageY,e.matrixTransform(t.getScreenCTM().inverse())},e.rotateElement=function(e,t,r,s){e.setAttribute("transform",`translate(${t},${r}) rotate(${s+90}) translate(${-t},${-r})`)},e.hydrate=function(e,t){for(var r in t)"title"==r?s.title(e,t[r]):e.setAttributeNS(null,r,t[r])},e.elt=function(e,t){return e=document.createElementNS("http://www.w3.org/2000/svg",e),t&&s.hydrate(e,t),e},e.child=function(e,t,r){return t=s.elt(t,r),e.appendChild(t),t},e.mkPath=i,e.path=function(e,t,r,s){return t=i(t,r,s),e.appendChild(t),t},e.fill=function(e,t){e.style.fill=t},e.filter=function(e,t){e.style.filter=t},e.fills=function(e,t){e.forEach(e=>e.style.fill=t)},e.isTouchEnabled=function(){return"undefined"!=typeof window&&("ontouchstart"in window||0<navigator.maxTouchPoints)},e.onClick=function(t,r){let s=!1;o.pointerEvents.down.forEach(e=>t.addEventListener(e,e=>s=!0,!1)),t.addEventListener(o.pointerEvents.up,e=>!s||(s=!1,r(e),e.preventDefault(),!1),!1)},e.buttonEvents=function(t,r,s,i,n){let a=!1;o.pointerEvents.down.forEach(e=>t.addEventListener(e,e=>(a=!0,s&&s(e),!0),!1)),t.addEventListener(o.pointerEvents.move,e=>!a||(r&&r(e),e.preventDefault(),!1),!1),t.addEventListener(o.pointerEvents.up,e=>{a=!1,i&&i(e)},!1),t.addEventListener(o.pointerEvents.leave,e=>{a=!1,i&&i(e)},!1),t.addEventListener("keydown",e=>{a=!1,n&&n(e)})},e.mkLinearGradient=n,e.linearGradient=function(e,t,r=!1){return t=n(t,r),e.appendChild(t),t},e.setGradientColors=function(e,t,r){e&&(e.childNodes[0].style.stopColor=t,e.childNodes[1].style.stopColor=t,e.childNodes[2].style.stopColor=r,e.childNodes[3].style.stopColor=r)},e.setGradientValue=function(e,t){e.childNodes[1].getAttribute("offset")!=t&&(e.childNodes[1].setAttribute("offset",t),e.childNodes[2].setAttribute("offset",t))},e.animate=function(e,t){o.U.addClass(e,t),(t=e.parentElement)&&(t.removeChild(e),t.appendChild(e))},e.mkTitle=r,e.title=function(e,t){return t=r(t),e.appendChild(t),t},e.toHtmlColor=function(e){return`rgba(${e>>16&255}, ${e>>8&255}, ${255&e}, ${e>>24&1})`}})(pxsim=pxsim||{}),(t=>{{(t.music||(t.music={})).Metronome=class{constructor(){this.tickListeners=[],this.onTick=()=>{for(var e of this.tickListeners)e()}}initAsync(){if(!this.metronomeLoadPromise){if(this.metronomeWorker)return this.metronomeWorker;this.metronomeLoadPromise=new Promise(t=>{this.metronomeWorker=new Worker("data:application/javascript,"+encodeURIComponent(e));let r=e=>{"ready"===e.data&&(t(this.metronomeWorker),this.metronomeWorker.removeEventListener("message",r),this.metronomeWorker.addEventListener("message",this.onTick))};this.metronomeWorker.addEventListener("message",r)})}return this.metronomeLoadPromise}stop(){this.postMessage({type:"stop"})}setInterval(e){this.currentInterval=e,this.postMessage({type:"set-interval",interval:e})}start(e){this.currentInterval=e,this.postMessage({type:"start",interval:e})}addTickListener(e){this.tickListeners.push(e)}removeTickListener(t){this.tickListeners=this.tickListeners.filter(e=>e!==t)}interval(){return this.currentInterval}dispose(){this.metronomeWorker?(this.metronomeWorker.terminate(),this.metronomeWorker=void 0,this.metronomeLoadPromise=void 0,this.tickListeners=[],this.interval=void 0):this.metronomeLoadPromise&&this.metronomeLoadPromise.then(()=>this.dispose())}postMessage(e){if(!this.metronomeWorker)throw new Error("initAsync not called on metronome");this.metronomeWorker.postMessage(e)}};let e=`
/**
 * Adpated from https://github.com/cwilso/metronome/
 */

let timerRef;
let interval;

addEventListener("message", ev => {
    const message = ev.data;

    if (message.type === "start") {
        updateInterval(message.interval, true);
    }
    else if (message.type === "stop") {
        clearInterval(timerRef);
        timerRef = undefined;
    }
    else if (message.type === "set-interval") {
        updateInterval(message.interval, false);
    }
})

postMessage("ready");

function updateInterval(interval, startIfStopped) {
    if (timerRef) {
        clearInterval(timerRef);
        startIfStopped = true;
    }
    interval = interval;

    if (startIfStopped) {
        timerRef = setInterval(() => postMessage("tick"), interval);
    }
}
`}})(pxsim=pxsim||{}),(e=>{(e=(e=(e=e.codal||(e.codal={})).music||(e.music={})).MusicalIntervals||(e.MusicalIntervals={})).chromaticInterval=[1,1.0417,1.125,1.2,1.25,1.3333,1.4063,1.5,1.6,1.6667,1.8,1.875],e.majorScaleInterval=[e.chromaticInterval[0],e.chromaticInterval[2],e.chromaticInterval[4],e.chromaticInterval[5],e.chromaticInterval[7],e.chromaticInterval[9],e.chromaticInterval[11]],e.minorScaleInterval=[e.chromaticInterval[0],e.chromaticInterval[2],e.chromaticInterval[3],e.chromaticInterval[5],e.chromaticInterval[7],e.chromaticInterval[8],e.chromaticInterval[10]],e.pentatonicScaleInterval=[e.chromaticInterval[0],e.chromaticInterval[2],e.chromaticInterval[4],e.chromaticInterval[7],e.chromaticInterval[9]],e.majorTriadInterval=[e.chromaticInterval[0],e.chromaticInterval[4],e.chromaticInterval[7]],e.minorTriadInterval=[e.chromaticInterval[0],e.chromaticInterval[3],e.chromaticInterval[7]],e.diminishedInterval=[e.chromaticInterval[0],e.chromaticInterval[3],e.chromaticInterval[6],e.chromaticInterval[9]],e.wholeToneInterval=[e.chromaticInterval[0],e.chromaticInterval[2],e.chromaticInterval[4],e.chromaticInterval[6],e.chromaticInterval[8],e.chromaticInterval[10]]})(pxsim=pxsim||{}),(e=>{var t;e=(e=e.codal||(e.codal={})).music||(e.music={}),(t=e.MusicalProgressions||(e.MusicalProgressions={})).chromatic={interval:e.MusicalIntervals.chromaticInterval,length:12},t.majorScale={interval:e.MusicalIntervals.majorScaleInterval,length:7},t.minorScale={interval:e.MusicalIntervals.minorScaleInterval,length:7},t.pentatonicScale={interval:e.MusicalIntervals.pentatonicScaleInterval,length:5},t.majorTriad={interval:e.MusicalIntervals.majorTriadInterval,length:3},t.minorTriad={interval:e.MusicalIntervals.minorTriadInterval,length:3},t.diminished={interval:e.MusicalIntervals.diminishedInterval,length:4},t.wholeTone={interval:e.MusicalIntervals.wholeToneInterval,length:6},t.calculateFrequencyFromProgression=function(e,t,r){var s=Math.floor(r/t.length),r=r%t.length;return e*Math.pow(2,s)*t.interval[r]}})(pxsim=pxsim||{}),(a=>{{var e=a.music||(a.music={});let n=[31,33,35,37,39,41,44,46,49,52,55,58,62,65,69,73,78,82,87,92,98,104,110,117,123,131,139,147,156,165,175,185,196,208,220,233,247,262,277,294,311,330,349,370,392,415,440,466,494,523,554,587,622,659,698,740,784,831,880,932,988,1047,1109,1175,1245,1319,1397,1480,1568,1661,1760,1865,1976,2093,2217,2349,2489,2637,2794,2960,3136,3322,3520,3729,3951,4186,4435,4699,4978,5274,5588,5920,6272,6645,7040,7459,7902];async function o(e,t,r,s,i=100){await a.AudioContextManager.playInstructionsAsync(a.music.renderInstrument(t,n[e],r,i),s)}async function l(e,t,r=100){await a.AudioContextManager.playInstructionsAsync(a.music.renderDrumInstrument(e,r),t)}function u(e,t,r){return 6e4/e/t*r}e.Sequencer=class{constructor(){this._currentTick=0,this._state="stop",this.listeners={},this.globalVolume=1024,this.trackVolumes=[],this.drumTrackVolumes=[],this.currentCancelToken={cancelled:!1},this.onTick=()=>{let t=this.currentCancelToken;for(let e=0;e<this.currentlyPlaying.tracks.length;e++){var r,s=this.currentlyPlaying.tracks[e];for(r of s.notes)if(r.startTick===this._currentTick)for(var i of r.notes)s.drums?l(s.drums[i.note],()=>t.cancelled,this.getDrumTrackVolume(e,i.note)):o(i.note,s.instrument,u(this.currentlyPlaying.beatsPerMinute,this.currentlyPlaying.ticksPerBeat,r.endTick-r.startTick),()=>t.cancelled,this.getMelodicTrackVolume(e));else if(r.startTick>this._currentTick)break}this.fireEvent("tick"),this._currentTick++,this._currentTick>=this.maxTick()&&("loop"===this._state?(this._currentTick=0,this.fireEvent("looped")):this.stop(!0))}}async initAsync(){this.metronome?await this.metronome.initAsync():(this.metronome=new e.Metronome,await this.metronome.initAsync(),this.metronome.addTickListener(this.onTick))}dispose(){this.metronome&&this.metronome.dispose(),this.metronome=void 0,this.stop(),this.currentlyPlaying=void 0,this.listeners={}}state(){return this._state}currentTick(){return this._currentTick}currentTime(){return 6e4/this.currentlyPlaying.beatsPerMinute/this.currentlyPlaying.ticksPerBeat*this.currentTick()}maxTick(){return this.currentlyPlaying?this.currentlyPlaying.measures*this.currentlyPlaying.beatsPerMeasure*this.currentlyPlaying.ticksPerBeat:0}duration(){return 6e4/this.currentlyPlaying.beatsPerMinute/this.currentlyPlaying.ticksPerBeat*this.maxTick()}start(e,t){this.startFrom(e,t,0)}startFrom(e,t,r){"stop"!==this._state&&this.stop(),void 0!==t&&(this.shouldLoop=t),this._currentTick=null!=r?r:0,this.currentlyPlaying=e,this.metronome.start(6e4/e.beatsPerMinute/e.ticksPerBeat*1),this._state=this.shouldLoop?"loop":"play",this.fireStateChange()}stop(e=!1){"stop"!==this._state&&(this._state="stop",this.metronome&&this.metronome.stop(),this.fireStateChange(),e||(this.currentCancelToken.cancelled=!0),this.currentCancelToken={cancelled:!1})}updateSong(e){this.currentlyPlaying=e,"stop"!==this._state&&this.metronome.setInterval(6e4/e.beatsPerMinute/e.ticksPerBeat*1)}setLooping(e){e&&"play"===this._state?(this._state="loop",this.fireStateChange()):e||"loop"!==this._state||(this._state="play",this.fireStateChange()),this.shouldLoop=e}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}removeEventListener(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(e=>e!==t))}setVolume(e){this.globalVolume=Math.min(Math.max(e,0),1024)}setTrackVolume(e,t){for(t=Math.min(Math.max(t,0),1024);this.trackVolumes.length<e;)this.trackVolumes.push(1024);this.trackVolumes[e]=t}setDrumTrackVolume(e,t,r){for(r=Math.min(Math.max(r,0),1024);this.drumTrackVolumes.length<e;)this.drumTrackVolumes.push([]);for(;this.drumTrackVolumes[e].length<t;)this.drumTrackVolumes[e].push(1024);this.drumTrackVolumes[e][t]=r}getMelodicTrackVolume(e){let t=1024;return e<this.trackVolumes.length&&(t=this.trackVolumes[e]),this.globalVolume*(t/1024)}getDrumTrackVolume(e,t){let r=1024;return this.getMelodicTrackVolume(e)*((r=e<this.drumTrackVolumes.length&&t<this.drumTrackVolumes[e].length?this.drumTrackVolumes[e][t]:r)/1024)}fireStateChange(){this.fireEvent(this._state),this.fireEvent("state-change")}fireEvent(e){if(this.listeners[e])for(var t of this.listeners[e])t()}},e.playNoteAsync=o,e.playDrumAsync=l,e.tickToMs=u}})(pxsim=pxsim||{}),(e=>{{e=e.music||(e.music={});let w=12;function S(e,t,r,s){let i,n,a=0;return null!=(i=e.pitchEnvelope)&&i.amplitude&&(a+=o(e.pitchEnvelope,s,r)),null!=(n=e.pitchLFO)&&n.amplitude&&(a+=l(e.pitchLFO,s)),Math.max(t+a,0)}function E(e,t,r,s){let i,n=0;return e.ampEnvelope.amplitude&&(n+=o(e.ampEnvelope,r,t)),null!=(i=e.ampLFO)&&i.amplitude&&(n+=l(e.ampLFO,r)),Math.max(Math.min(n,e.ampEnvelope.amplitude),0)/1024*s|0}function o(e,t,r){var s,i=e.sustain/1024*e.amplitude;return r<t?t-r>e.release?0:t<e.attack?(s=e.amplitude/e.attack*r)-s/e.release*(t-r):t<e.attack+e.decay?(s=e.amplitude-(e.amplitude-i)/e.decay*(r-e.attack))-s/e.release*(t-r):i-i/e.release*(t-r):t<e.attack?e.amplitude/e.attack*t:t<e.attack+e.decay?e.amplitude-(e.amplitude-i)/e.decay*(t-e.attack):i}function l(e,t){return Math.cos(t/1e3*e.frequency*2*Math.PI)*e.amplitude}function x(e,t,r,s,i,n,a,o){0<r&&(e[t]=n,e[t+1]=0,u(e,t+2,a),u(e,t+4,r),u(e,t+6,255*s>>6),u(e,t+8,255*i>>6),u(e,t+10,o),t+=w),e[t]=0}function u(e,t,r){var s=new Uint8Array(2);new Uint16Array(s.buffer)[0]=0|r,e[t]=s[0],e[t+1]=s[1]}function h(e,t){var r=new Uint8Array(2);return r[0]=e[t],r[1]=e[t+1],new Uint16Array(r.buffer)[0]}function c(t,r,s,i){var n={startTick:h(t,r),endTick:h(t,r+2),notes:[]};for(let e=0;e<t[r+4];e++)n.notes.push(((e,t,r)=>{var s=e>>6,r={note:r?e:(63&e)+12*(t-2),enharmonicSpelling:"normal"};return 1==s?r.enharmonicSpelling="flat":2==s&&(r.enharmonicSpelling="sharp"),r})(t[r+5+e],s,i));return n}e.renderInstrument=function(t,r,s,i){var e,n,a,o=s+t.ampEnvelope.release,l=null!=(e=t.ampLFO)&&e.amplitude?Math.max(500/t.ampLFO.frequency,50):50,u=null!=(e=t.pitchLFO)&&e.amplitude?Math.max(500/t.pitchLFO.frequency,50):50,h=[0];let c=t.ampEnvelope.attack,d=null!=(e=t.pitchEnvelope)&&e.amplitude?t.pitchEnvelope.attack:o,p=null!=(e=t.pitchLFO)&&e.amplitude?u:o,m=null!=(e=t.ampLFO)&&e.amplitude?l:o,f=0;for(;f<o&&(c<=d&&c<=p&&c<=m?(f=c,h.push(c),c=f<t.ampEnvelope.attack+t.ampEnvelope.decay&&t.ampEnvelope.attack+t.ampEnvelope.decay<s?t.ampEnvelope.attack+t.ampEnvelope.decay:f<s?s:o):d<=p&&d<=m&&d<o?(f=d,h.push(d),d=f<t.pitchEnvelope.attack+t.pitchEnvelope.decay&&t.pitchEnvelope.attack+t.pitchEnvelope.decay<s?t.pitchEnvelope.attack+t.pitchEnvelope.decay:f<s?s:f<s+t.pitchEnvelope.release?Math.min(o,s+t.pitchEnvelope.release):o):p<=m&&p<o?(f=p,h.push(p),p+=u):m<o&&(f=m,h.push(m),m+=l),!(f>=o));){for(c<=f&&(c=f<t.ampEnvelope.attack+t.ampEnvelope.decay&&t.ampEnvelope.attack+t.ampEnvelope.decay<s?t.ampEnvelope.attack+t.ampEnvelope.decay:f<s?s:o),d<=f&&(d=f<t.pitchEnvelope.attack+t.pitchEnvelope.decay&&t.pitchEnvelope.attack+t.pitchEnvelope.decay<s?t.pitchEnvelope.attack+t.pitchEnvelope.decay:f<s?s:f<s+t.pitchEnvelope.release?Math.min(o,s+t.pitchEnvelope.release):o);m<=f;)m+=l;for(;p<=f;)p+=u}let g=0|E(t,s,0,i),v=0|S(t,r,s,0),b=0;var y=new Uint8Array(w*(h.length+1));for(let e=1;e<h.length;e++)b=(h[e]-b<5||(n=0|E(t,s,h[e],i),a=0|S(t,r,s,h[e]),x(y,12*(e-1),h[e]-b|0,g,n,t.waveform,v,a),g=n,v=a),h[e]);return x(y,12*h.length,10,g,0,t.waveform,v,v),y},e.renderDrumInstrument=function(t,r){let s=t.startVolume,i=t.startFrequency;var n=e=>e/1024*r,a=new Uint8Array((t.steps.length+1)*w);for(let e=0;e<t.steps.length;e++)x(a,e*w,t.steps[e].duration,n(s),n(t.steps[e].volume),t.steps[e].waveform,i,t.steps[e].frequency),s=t.steps[e].volume,i=t.steps[e].frequency;return x(a,t.steps.length*w,10,n(s),0,t.steps[t.steps.length-1].waveform,i,i),a},e.decodeSong=function(e){var t={beatsPerMinute:h(e,1),beatsPerMeasure:e[3],ticksPerBeat:e[4],measures:e[5],tracks:[]};let r=7;for(;r<e.length;){var[s,i]=((i,n)=>{if(i[n+1]){var s=i,a=n;let e={id:s[a],instrument:{ampEnvelope:{attack:0,decay:0,sustain:0,release:0,amplitude:0},waveform:0},notes:[],drums:[]},t=h(s,a+2),r=a+4;for(;r<a+4+t;)e.drums.push(((t,r)=>{var s={startFrequency:h(t,r+1),startVolume:h(t,r+3),steps:[]};for(let e=0;e<t[r];e++){var i=r+5+7*e;s.steps.push({waveform:t[i],frequency:h(t,i+1),volume:h(t,i+3),duration:h(t,i+5)})}return s})(s,r)),r+=5+7*e.drums[e.drums.length-1].steps.length;var o=h(s,r);for(r+=2;r<a+4+t+o;)e.notes.push(c(s,r,0,!0)),r+=5+e.notes[e.notes.length-1].notes.length;return[e,r]}{var l=i,i=n;let e={id:l[i],instrument:((e,t)=>({waveform:e[t],ampEnvelope:{attack:h(e,t+1),decay:h(e,t+3),sustain:h(e,t+5),release:h(e,t+7),amplitude:h(e,t+9)},pitchEnvelope:{attack:h(e,t+11),decay:h(e,t+13),sustain:h(e,t+15),release:h(e,t+17),amplitude:h(e,t+19)},ampLFO:{frequency:e[t+21],amplitude:h(e,22)},pitchLFO:{frequency:e[t+24],amplitude:h(e,25)},octave:e[t+27]}))(l,i+4),notes:[]},t=i+4+h(l,i+2),r=h(l,t),s=t+2;for(;s<t+2+r;)e.notes.push(c(l,s,e.instrument.octave,!1)),s+=5+e.notes[e.notes.length-1].notes.length;return[e,s]}})(e,r);r=i,t.tracks.push(s)}return t}}})(pxsim=pxsim||{}),(e=>{var h;e=e.codal||(e.codal={}),(h=e.music||(e.music={})).EMOJI_SYNTHESIZER_SAMPLE_RATE=44100,h.EMOJI_SYNTHESIZER_TONE_WIDTH_F=1024,h.EMOJI_SYNTHESIZER_TONE_WIDTH=1024,h.EMOJI_SYNTHESIZER_BUFFER_SIZE=512,h.EMOJI_SYNTHESIZER_TONE_EFFECT_PARAMETERS=2,h.EMOJI_SYNTHESIZER_TONE_EFFECTS=3,h.EMOJI_SYNTHESIZER_STATUS_ACTIVE=1,h.EMOJI_SYNTHESIZER_STATUS_OUTPUT_SILENCE_AS_EMPTY=2,h.EMOJI_SYNTHESIZER_STATUS_STOPPING=4,h.SoundEmojiSynthesizer=class{constructor(e,t=h.EMOJI_SYNTHESIZER_SAMPLE_RATE){this.samplesPerStep=[],this.status=0,this.effectPointer=0,this.position=0,this.bufferSize=h.EMOJI_SYNTHESIZER_BUFFER_SIZE,this.sampleRate=t,this.samplesToWrite=0,this.samplesWritten=0,this.sampleRange=1023,this.orMask=0,this.effectPointer=-1,this.volume=1}get effect(){return this.effectBuffer[this.effectPointer]}play(e){this.effectBuffer=e,this.effectPointer=-1,this.nextSoundEffect()}nextSoundEffect(){var e=null!=this.effect;if(this.status&h.EMOJI_SYNTHESIZER_STATUS_STOPPING&&(this.effectPointer=null,this.effectBuffer=[]),this.effect?this.effectPointer++:this.effectPointer=0,this.effectPointer>=this.effectBuffer.length&&(this.effectPointer=0)<=this.effect.duration)return this.effectPointer=-1,this.effectBuffer=[],this.samplesWritten=0,this.samplesToWrite=0,this.position=0,e;this.samplesToWrite=this.determineSampleCount(this.effect.duration),this.frequency=this.effect.frequency,this.volume=this.effect.volume;for(let e=this.samplesWritten=0;e<h.EMOJI_SYNTHESIZER_TONE_EFFECTS;e++)this.effect.effects[e].step=0,this.effect.effects[e].steps=Math.max(this.effect.effects[e].steps,1),this.samplesPerStep[e]=Math.floor(this.samplesToWrite/this.effect.effects[e].steps);return!1}pull(){let e=!1,r,s;for(;!e;){var t;for((this.samplesWritten==this.samplesToWrite||this.status&h.EMOJI_SYNTHESIZER_STATUS_STOPPING)&&(t=this.nextSoundEffect(),0==this.samplesToWrite||this.status&h.EMOJI_SYNTHESIZER_STATUS_STOPPING)&&(e=!0,t||this.status&h.EMOJI_SYNTHESIZER_STATUS_STOPPING)&&(this.status&=~h.EMOJI_SYNTHESIZER_STATUS_STOPPING),!(this.samplesWritten<this.samplesToWrite)&&this.status&h.EMOJI_SYNTHESIZER_STATUS_OUTPUT_SILENCE_AS_EMPTY||null!=r||(this.buffer=new Array(this.bufferSize),r=0,s=this.buffer.length);this.samplesWritten<this.samplesToWrite;){var i=h.EMOJI_SYNTHESIZER_TONE_WIDTH_F*this.frequency/this.sampleRate,n=this.sampleRange*this.volume/1024,a=512-512*n,o=[];for(let e=0;e<h.EMOJI_SYNTHESIZER_TONE_EFFECTS;e++)o[e]=this.samplesPerStep[e]*this.effect.effects[e].step,this.effect.effects[e].step==this.effect.effects[e].steps-1&&(o[e]=this.samplesToWrite);let t=o[0];for(let e=1;e<h.EMOJI_SYNTHESIZER_TONE_EFFECTS;e++)t=Math.min(t,o[e]);for(;this.samplesWritten<t;){if(r==s)return this.buffer;var l=this.effect.tone.tonePrint(this.effect.tone.parameter,Math.max(this.position,0));for(this.buffer[r]=l*n+a,r++,this.samplesWritten++,this.position+=i;this.position>h.EMOJI_SYNTHESIZER_TONE_WIDTH_F;)this.position-=h.EMOJI_SYNTHESIZER_TONE_WIDTH_F}for(let e=0;e<h.EMOJI_SYNTHESIZER_TONE_EFFECTS;e++)this.samplesWritten==o[e]&&this.effect.effects[e].step<this.effect.effects[e].steps&&(this.effect.effects[e].effect&&this.effect.effects[e].effect(this,this.effect.effects[e]),this.effect.effects[e].step++)}}if(null==r)this.buffer=[];else for(var u=.5*this.sampleRange;r<s;)this.buffer[r]=u,r++;return this.buffer}determineSampleCount(e){return e<0&&(e=-e),Math.floor(this.sampleRate*(e/1e3))}totalDuration(){let e=0;for(var t of this.effectBuffer)e+=t.duration;return e}}})(pxsim=pxsim||{}),(e=>{e=(e=e.codal||(e.codal={})).music||(e.music={});{e=e.Synthesizer||(e.Synthesizer={});let s=[0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,3,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,11,11,12,13,13,14,15,16,16,17,18,19,20,21,22,22,23,24,25,26,27,28,29,30,32,33,34,35,36,37,38,40,41,42,43,45,46,47,49,50,51,53,54,56,57,58,60,61,63,64,66,68,69,71,72,74,76,77,79,81,82,84,86,87,89,91,93,95,96,98,100,102,104,106,108,110,112,114,116,118,120,122,124,126,128,130,132,134,136,138,141,143,145,147,149,152,154,156,158,161,163,165,167,170,172,175,177,179,182,184,187,189,191,194,196,199,201,204,206,209,211,214,216,219,222,224,227,229,232,235,237,240,243,245,248,251,253,256,259,262,264,267,270,273,275,278,281,284,287,289,292,295,298,301,304,307,309,312,315,318,321,324,327,330,333,336,339,342,345,348,351,354,357,360,363,366,369,372,375,378,381,384,387,390,393,396,399,402,405,408,411,414,417,420,424,427,430,433,436,439,442,445,448,452,455,458,461,464,467,470,473,477,480,483,486,489,492,495,498,502,505,508,511,514,517,520,524,527,530,533,536,539,542,545,549,552,555,558,561,564,567,570,574,577,580,583,586,589,592,595,598,602,605,608,611,614,617,620,623,626,629,632,635,638,641,644,647,650,653,656,659,662,665,668,671,674,677,680,683,686,689,692,695,698,701,704,707,710,713,715,718,721,724,727,730,733,735,738,741,744,747,749,752,755,758,760,763,766,769,771,774,777,779,782,785,787,790,793,795,798,800,803,806,808,811,813,816,818,821,823,826,828,831,833,835,838,840,843,845,847,850,852,855,857,859,861,864,866,868,870,873,875,877,879,881,884,886,888,890,892,894,896,898,900,902,904,906,908,910,912,914,916,918,920,922,924,926,927,929,931,933,935,936,938,940,941,943,945,946,948,950,951,953,954,956,958,959,961,962,964,965,966,968,969,971,972,973,975,976,977,979,980,981,982,984,985,986,987,988,989,990,992,993,994,995,996,997,998,999,1e3,1e3,1001,1002,1003,1004,1005,1006,1006,1007,1008,1009,1009,1010,1011,1011,1012,1013,1013,1014,1014,1015,1015,1016,1016,1017,1017,1018,1018,1019,1019,1019,1020,1020,1020,1021,1021,1021,1021,1022,1022,1022,1022,1022,1022,1022,1022,1022,1022,1023,1022];e.SineTone=function(e,t){var r=1024-(t|=0);return r<512&&(t=r),s[t]},e.SawtoothTone=function(e,t){return t},e.TriangleTone=function(e,t){return t<512?2*t:2*(1023-t)},e.NoiseTone=function(e,t){let r=e[0];return t*(r=0==r?7919:r)&1023},e.SquareWaveTone=function(e,t){return t<512?1023:0}}})(pxsim=pxsim||{}),(e=>{var r;e=e.codal||(e.codal={}),(e=(r=e.music||(e.music={})).SoundSynthesizerEffects||(r.SoundSynthesizerEffects={})).noInterpolation=function(e,t){},e.linearInterpolation=function(e,t){var r=(t.parameter[0]-e.effect.frequency)/t.steps;e.frequency=e.effect.frequency+r*t.step},e.logarithmicInterpolation=function(e,t){e.frequency=e.effect.frequency+Math.log10(Math.max(t.step,.1))*(t.parameter[0]-e.effect.frequency)/1.95},e.curveInterpolation=function(e,t){e.frequency=Math.sin(3.12159*t.step/180)*(t.parameter[0]-e.effect.frequency)+e.effect.frequency},e.slowVibratoInterpolation=function(e,t){e.frequency=Math.sin(t.step/10)*t.parameter[0]+e.effect.frequency},e.warbleInterpolation=function(e,t){e.frequency=Math.sin(t.step)*(t.parameter[0]-e.effect.frequency)+e.effect.frequency},e.vibratoInterpolation=function(e,t){e.frequency=e.effect.frequency+Math.sin(t.step)*t.parameter[0]},e.exponentialRisingInterpolation=function(e,t){e.frequency=e.effect.frequency+Math.sin(.01745329*t.step)*t.parameter[0]},e.exponentialFallingInterpolation=function(e,t){e.frequency=e.effect.frequency+Math.cos(.01745329*t.step)*t.parameter[0]},e.appregrioAscending=function(e,t){e.frequency=r.MusicalProgressions.calculateFrequencyFromProgression(e.effect.frequency,t.parameter_p[0],t.step)},e.appregrioDescending=function(e,t){e.frequency=r.MusicalProgressions.calculateFrequencyFromProgression(e.effect.frequency,t.parameter_p[0],t.steps-t.step-1)},e.frequencyVibratoEffect=function(e,t){0!=t.step&&(t.step%2==0?e.frequency/=t.parameter[0]:e.frequency*=t.parameter[0])},e.volumeVibratoEffect=function(e,t){0!=t.step&&(t.step%2==0?e.volume/=t.parameter[0]:e.volume*=t.parameter[0])},e.adsrVolumeEffect=function(e,t){var r,s=.5*t.steps;t.step<=s?(r=(t.parameter[0]-e.effect.volume)/s,e.volume=e.effect.volume+t.step*r):(r=(t.parameter[1]-t.parameter[0])/s,e.volume=t.parameter[0]+(t.step-s)*r)},e.volumeRampEffect=function(e,t){var r=(t.parameter[0]-e.effect.volume)/t.steps;e.volume=e.effect.volume+t.step*r}})(pxsim=pxsim||{}),(u=>{var e=u.codal||(u.codal={});{var m=e.music||(e.music={});(e=m.WaveShape||(m.WaveShape={}))[e.Sine=0]="Sine",e[e.Sawtooth=1]="Sawtooth",e[e.Triangle=2]="Triangle",e[e.Square=3]="Square",e[e.Noise=4]="Noise",(e=m.InterpolationEffect||(m.InterpolationEffect={}))[e.None=0]="None",e[e.Linear=1]="Linear",e[e.Curve=2]="Curve",e[e.ExponentialRising=5]="ExponentialRising",e[e.ExponentialFalling=6]="ExponentialFalling",e[e.ArpeggioRisingMajor=8]="ArpeggioRisingMajor",e[e.ArpeggioRisingMinor=10]="ArpeggioRisingMinor",e[e.ArpeggioRisingDiminished=12]="ArpeggioRisingDiminished",e[e.ArpeggioRisingChromatic=14]="ArpeggioRisingChromatic",e[e.ArpeggioRisingWholeTone=16]="ArpeggioRisingWholeTone",e[e.ArpeggioFallingMajor=9]="ArpeggioFallingMajor",e[e.ArpeggioFallingMinor=11]="ArpeggioFallingMinor",e[e.ArpeggioFallingDiminished=13]="ArpeggioFallingDiminished",e[e.ArpeggioFallingChromatic=15]="ArpeggioFallingChromatic",e[e.ArpeggioFallingWholeTone=17]="ArpeggioFallingWholeTone",e[e.Logarithmic=18]="Logarithmic",(e=m.Effect||(m.Effect={}))[e.None=0]="None",e[e.Vibrato=1]="Vibrato",e[e.Tremolo=2]="Tremolo",e[e.Warble=3]="Warble";class r{constructor(){this.src="000000000000000000000000000000000000000000000000000000000000000000000000"}get wave(){return this.getValue(0,1)}set wave(e){this.setValue(0,s(e,0,4),1)}get volume(){return this.getValue(1,4)}set volume(e){this.setValue(1,s(e,0,1023),4)}get frequency(){return this.getValue(5,4)}set frequency(e){this.setValue(5,e,4)}get duration(){return this.getValue(9,4)}set duration(e){this.setValue(9,e,4)}get shape(){return this.getValue(13,2)}set shape(e){this.setValue(13,e,2)}get endFrequency(){return this.getValue(18,4)}set endFrequency(e){this.setValue(18,e,4)}get endVolume(){return this.getValue(26,4)}set endVolume(e){this.setValue(26,s(e,0,1023),4)}get steps(){return this.getValue(30,4)}set steps(e){this.setValue(30,e,4)}get fx(){return this.getValue(34,2)}set fx(e){this.setValue(34,s(e,0,3),2)}get fxParam(){return this.getValue(36,4)}set fxParam(e){this.setValue(36,e,4)}get fxnSteps(){return this.getValue(40,4)}set fxnSteps(e){this.setValue(40,e,4)}get frequencyRandomness(){return this.getValue(44,4)}set frequencyRandomness(e){this.setValue(44,e,4)}get endFrequencyRandomness(){return this.getValue(48,4)}set endFrequencyRandomness(e){this.setValue(48,e,4)}get volumeRandomness(){return this.getValue(52,4)}set volumeRandomness(e){this.setValue(52,e,4)}get endVolumeRandomness(){return this.getValue(56,4)}set endVolumeRandomness(e){this.setValue(56,e,4)}get durationRandomness(){return this.getValue(60,4)}set durationRandomness(e){this.setValue(60,e,4)}get fxParamRandomness(){return this.getValue(64,4)}set fxParamRandomness(e){this.setValue(64,e,4)}get fxnStepsRandomness(){return this.getValue(68,4)}set fxnStepsRandomness(e){this.setValue(68,e,4)}copy(){var e=new r;return e.src=this.src.slice(0),e}setValue(e,t,r){t=s(0|t,0,Math.pow(10,r)-1),this.src=this.src.substr(0,e)+((e,t)=>{let r=e+"";for(;r.length<t;)r="0"+r;return r})(t,r)+this.src.substr(e+r)}getValue(e,t){return parseInt(this.src.substr(e,t))}}m.Sound=r;let a=!1,o,l={cancelled:!1};function t(){o=[],l.cancelled=!0,l={cancelled:!1}}function h(e,t,s,r=.03){let i=new m.SoundEmojiSynthesizer(0);var n,e=(t=>{var r=Math.floor((t.length+1)/73),e=73*r-1;if(t.length!=e)return[];var s=[];for(let e=0;e<r;++e){var i=72*e+e;if(0<i&&","!=t[i-1])return[];var n=(()=>{var t={frequency:0,volume:1,duration:0,tone:{tonePrint:void 0,parameter:[0]},effects:[]};for(let e=0;e<m.EMOJI_SYNTHESIZER_TONE_EFFECTS;e++)t.effects.push({effect:void 0,step:0,steps:0,parameter:[],parameter_p:[]});return t})();if(!c(t.substr(i),n))return[];s.push(n)}return s})(e);i.play(e);let a=!1;return Promise.race([(n=i.totalDuration(),new Promise(e=>setTimeout(e,n)).then(()=>{a=!0})),u.AudioContextManager.playPCMBufferStreamAsync(()=>{if(i.effect){var t=i.pull(),r=(s&&s(i.frequency,i.volume),new Float32Array(t.length));for(let e=0;e<t.length;e++)r[e]=(t[e]-512)/512;return r}},i.sampleRate,r,()=>a||t&&t())])}function c(e,t){var r=parseInt(e.substr(0,1)),s=parseInt(e.substr(1,4)),i=parseInt(e.substr(5,4)),n=parseInt(e.substr(9,4)),a=parseInt(e.substr(13,2)),o=parseInt(e.substr(18,4)),l=parseInt(e.substr(26,4)),u=parseInt(e.substr(30,4)),h=parseInt(e.substr(34,2)),c=parseInt(e.substr(36,4)),d=parseInt(e.substr(40,4)),i=g(i,parseInt(e.substr(44,4))),o=g(o,parseInt(e.substr(48,4))),s=g(s,parseInt(e.substr(52,4))),l=g(l,parseInt(e.substr(56,4))),n=g(n,parseInt(e.substr(60,4))),c=g(c,parseInt(e.substr(64,4))),d=g(d,parseInt(e.substr(68,4)));if(-1==i||-1==o||-1==s||-1==l||-1==n||-1==c||-1==d)return!1;switch(r){case 0:t.tone.tonePrint=m.Synthesizer.SineTone;break;case 1:t.tone.tonePrint=m.Synthesizer.SawtoothTone;break;case 2:t.tone.tonePrint=m.Synthesizer.TriangleTone;break;case 3:t.tone.tonePrint=m.Synthesizer.SquareWaveTone;break;case 4:t.tone.tonePrint=m.Synthesizer.NoiseTone}switch(t.frequency=i,t.duration=n,t.effects[0].steps=u,a){case 0:t.effects[0].effect=m.SoundSynthesizerEffects.noInterpolation;break;case 1:t.effects[0].effect=m.SoundSynthesizerEffects.linearInterpolation,t.effects[0].parameter[0]=o;break;case 2:t.effects[0].effect=m.SoundSynthesizerEffects.curveInterpolation,t.effects[0].parameter[0]=o;break;case 5:t.effects[0].effect=m.SoundSynthesizerEffects.exponentialRisingInterpolation,t.effects[0].parameter[0]=o;break;case 6:t.effects[0].effect=m.SoundSynthesizerEffects.exponentialFallingInterpolation,t.effects[0].parameter[0]=o;break;case 8:case 10:case 12:case 14:case 16:t.effects[0].effect=m.SoundSynthesizerEffects.appregrioAscending;break;case 9:case 11:case 13:case 15:case 17:t.effects[0].effect=m.SoundSynthesizerEffects.appregrioDescending;break;case 18:t.effects[0].effect=m.SoundSynthesizerEffects.logarithmicInterpolation,t.effects[0].parameter[0]=o}switch(a){case 8:case 9:t.effects[0].parameter_p[0]=m.MusicalProgressions.majorScale;break;case 10:case 11:t.effects[0].parameter_p[0]=m.MusicalProgressions.minorScale;break;case 12:case 13:t.effects[0].parameter_p[0]=m.MusicalProgressions.diminished;break;case 14:case 15:t.effects[0].parameter_p[0]=m.MusicalProgressions.chromatic;break;case 16:case 17:t.effects[0].parameter_p[0]=m.MusicalProgressions.wholeTone}var e=f(0,s,1023)/1023,r=f(0,l,1023)/1023,p=(t.volume=e,t.effects[1].effect=m.SoundSynthesizerEffects.volumeRampEffect,t.effects[1].steps=36,t.effects[1].parameter[0]=r,Math.round(t.duration/1e4*d));switch(h){case 1:t.effects[2].steps=p,t.effects[2].effect=m.SoundSynthesizerEffects.frequencyVibratoEffect,t.effects[2].parameter[0]=c;break;case 2:t.effects[2].steps=p,t.effects[2].effect=m.SoundSynthesizerEffects.volumeVibratoEffect,t.effects[2].parameter[0]=c;break;case 3:t.effects[2].steps=p,t.effects[2].effect=m.SoundSynthesizerEffects.warbleInterpolation,t.effects[2].parameter[0]=c}return!0}function f(e,t,r){return Math.min(r,Math.max(e,t))}function g(e,t){var r;return e<0||t<0?-1:(r=2*t+1,r=Math.floor(Math.random()*r)-t,Math.abs(e+r))}function s(e,t,r){return Math.min(Math.max(e,t),r)}m.isSoundExpPlaying=function(){return a},m.__playSoundExpression=function(r,s,i=.03){o=o||[];let n=u.getResume();var e=new Promise((e,t)=>{o.push({notes:r,volume:i,onStarted:()=>{s||n()},onFinished:e,onCancelled:e})});a||!async function r(){if(o.length){a=!0;let t=o.shift(),e=l;try{t.onStarted(),await h(t.notes,()=>e.cancelled,void 0,t.volume),e.cancelled?t.onCancelled():t.onFinished()}catch(e){t.onCancelled()}r()}else a=!1}(),s&&e.then(n)},m.clearSoundQueue=t,m.playSoundExpressionAsync=h,m.__stopSoundExpressions=function(){t(),u.AudioContextManager.stopAll()},m.parseSoundExpression=c}})(pxsim=pxsim||{}),(e=>{class t{constructor(e){this.id=e}}e.Button=t,e.ButtonPairState=class{constructor(e){this.props=e,this.usesButtonAB=!1,this.aBtn=new t(this.props.ID_BUTTON_A),this.bBtn=new t(this.props.ID_BUTTON_B),this.abBtn=new t(this.props.ID_BUTTON_AB),this.abBtn.virtual=!0}}})(pxsim=pxsim||{}),(pxsim||(pxsim={})).CompassState=class{constructor(){this.usesHeading=!1,this.heading=90}},(pxsim||(pxsim={})).FileSystemState=class{constructor(){this.files={}}append(e,t){this.files[e]=(this.files[e]||"")+t}remove(e){delete this.files[e]}},(pxsim||(pxsim={})).LightSensorState=class{constructor(){this.usesLightLevel=!1,this.lightLevel=128}},(o=>{var l=o.visuals||(o.visuals={});l.mkBoardView=e=>{var t=e.visual;return new l.GenericBoardSvg({visualDef:t,boardDef:e.boardDef,wireframe:e.wireframe})},l.BoardHost=class{constructor(e,t){this.parts=[],this.boardView=e,(this.opts=t).boardDef.pinStyles||(t.boardDef.pinStyles={}),this.state=t.state;var r,s,i,n,e=t.partsList;let a=0<e.length||t.forceBreadboardLayout;a&&(this.breadboard=new l.Breadboard({wireframe:t.wireframe}),i=t.boardDef.marginWhenBreadboarding||[0,0,40,0],n=(i=l.composeSVG({el1:this.boardView.getView(),scaleUnit1:this.boardView.getPinDist(),el2:this.breadboard.getSVGAndSize(),scaleUnit2:this.breadboard.getPinDist(),margin:[i[0],i[1],20,i[3]],middleMargin:i[2],maxWidth:t.maxWidth,maxHeight:t.maxHeight})).under,r=i.over,this.view=i.host,s=i.edges,this.fromMBCoord=i.toHostCoord1,this.fromBBCoord=i.toHostCoord2,this.partGroup=r,this.partOverGroup=o.svg.child(this.view,"g"),this.style=o.svg.child(this.view,"style",{}),this.defs=o.svg.child(this.view,"defs",{}),this.wireFactory=new l.WireFactory(n,r,s,this.style,this.getLocCoord.bind(this),this.getPinStyle.bind(this)),((i=o.allocateDefinitions({boardDef:t.boardDef,partDefs:t.partDefs,fnArgs:t.fnArgs,getBBCoord:this.breadboard.getCoord.bind(this.breadboard),partsList:e})).partsAndWires.length||t.forceBreadboardLayout)&&(this.addAll(i),i.requiresBreadboard||t.forceBreadboardRender)?i.hideBreadboard&&this.breadboard&&this.breadboard.hide():a=!1),a||(delete this.breadboard,delete this.wireFactory,delete this.partOverGroup,delete this.partGroup,delete this.style,delete this.defs,delete this.fromBBCoord,delete this.fromMBCoord,n=this.boardView.getView().el,this.view=n,this.partGroup=o.svg.child(this.view,"g"),this.partOverGroup=o.svg.child(this.view,"g"),t.maxWidth&&o.svg.hydrate(this.view,{width:t.maxWidth}),t.maxHeight&&o.svg.hydrate(this.view,{height:t.maxHeight})),this.state.updateSubscribers.push(()=>this.updateState())}highlightBoardPin(e){this.boardView.highlightPin(e)}removeEventListeners(){this.boardView.removeEventListeners&&this.boardView.removeEventListeners()}highlightBreadboardPin(e){this.breadboard.highlightLoc(e)}highlightWire(e){e.wires.forEach(e=>{o.U.addClass(e,"highlight"),e.style.visibility="visible"}),o.U.addClass(e.endG,"highlight")}getView(){return this.view}screenshotAsync(i){var e=this.view.classList.contains("sim")?this.view:this.view.querySelector(".sim"),e=(e||this.view).cloneNode(!0),e=(e.setAttribute("width",e.viewBox.baseVal.width+""),e.setAttribute("height",e.viewBox.baseVal.height+""),(new XMLSerializer).serializeToString(e));let t="data:image/svg+xml,"+encodeURIComponent(e.replace(/\s+/g," ").replace(/"/g,"'"));return new Promise((r,e)=>{let s=document.createElement("img");s.onload=()=>{var e=document.createElement("canvas"),t=(e.width=s.width,e.height=s.height,0<i?(e.width=i,e.height=s.height*i/s.width|0):e.width<200?(e.width*=2,e.height*=2):480<e.width&&(e.width/=2,e.height/=2),e.getContext("2d"));t.drawImage(s,0,0,e.width,e.height),r(t.getImageData(0,0,e.width,e.height))},s.onerror=e=>{o.log(e),r(void 0)},s.src=t})}updateState(){this.parts.forEach(e=>e.updateState())}getBBCoord(e){e=this.breadboard.getCoord(e);return this.fromBBCoord(e)}getPinCoord(e){var t=this.boardView.getCoord(e);if(t)return this.fromMBCoord(t);o.error("Unable to find coord for pin: "+e)}getLocCoord(e){let t;return(t="breadboard"===e.type?this.getBBCoord(e):(e=e.pin,this.getPinCoord(e)))||o.debug("Unknown location: "+name),t}getPinStyle(e){return"breadboard"!=e.type&&this.opts.boardDef.pinStyles[e.pin]||"female"}addPart(e){let t=null;e.simulationBehavior?(r=e.simulationBehavior,s=this.state.builtinVisuals[r],r=this.state.builtinParts[r],(t=s()).init(this.state.bus,r,this.view,e.params)):(s=e.visual,t=new l.GenericPart(s)),this.parts.push(t),this.partGroup.appendChild(t.element),t.overElement&&this.partOverGroup.appendChild(t.overElement),t.defs&&t.defs.forEach(e=>this.defs.appendChild(e)),this.style.textContent+=t.style||"";var r=e.startColumnIdx,s=l.getRowName(e.startRowIdx),r=l.getColumnName(r),i=e.bbFit.xOffset/e.visual.pinDistance,n=e.bbFit.yOffset/e.visual.pinDistance,s=this.getBBCoord({type:"breadboard",row:s,col:r,xOffset:i,yOffset:n}),r=(t.moveToCoord(s),`sim-${e.name}-cmp`);return o.U.addClass(t.element,r),o.U.addClass(t.element,"sim-cmp"),t.updateTheme(),t.updateState(),t}addWire(e){return this.wireFactory.addWire(e.start,e.end,e.color)}addAll(s){s.partsAndWires.forEach(e=>{var t=e.wires,r=t&&t.every(e=>this.wireFactory.checkWire(e.start,e.end)),e=(r&&t.forEach(e=>s.wires.push(this.addWire(e))),e.part);!e||t&&!r||s.parts.push(this.addPart(e))}),s.requiresBreadboard=!!s.wires.length||!!s.parts.length}}})(pxsim=pxsim||{}),(U=>{{var V=U.visuals||(U.visuals={});V.BREADBOARD_MID_ROWS=10,V.BREADBOARD_MID_COLS=30;let x=[4,4];var e=V.BREADBOARD_MID_ROWS+x.length;let I=[4,9,14,19];var t=25+I.length;let C=15*(V.BREADBOARD_MID_COLS+3),R=15*(e+4+5.5),k=R*(2/3),T=R*(.5*(1-2/3)),_=(C-15*(V.BREADBOARD_MID_COLS-1))/2,P=T+(k-15*(e-1))/2,A=15*(t-1),M=(C-A)/2,D=(T-15)/2,B=M,F=D+T+k,L=-90,O="abcdefghij".split("").reverse();function N(e){return""+(e+1)}function q(e){return O[e]}function W(i){var n=i.xOffset||0,t=i.yOffset||0,a=[];let o=U.svg.elt("g");var l=i.colStartIdx||0,u=i.rowStartIdx||0,h=e=>e?e.slice(0,e.length):[],c=(e,t)=>{let r=0;for(var s;0<=(s=e.indexOf(t));)e.splice(s,1),r+=1;return r};let d=0;var p=h(i.rowIdxsWithGap);for(let e=0;e<i.rowCount;e++){let r=0;var m=h(i.colIdxsWithGap);let s=t+e*i.pinDist+d*i.pinDist;var f=e+u;for(let e=0;e<i.colCount;e++){let t=n+e*i.pinDist+r*i.pinDist;var g=e+l,v=e=>(U.svg.hydrate(e.el,"circle"==e.el.tagName?{cx:t,cy:s}:{x:t-.5*e.w,y:s-.5*e.h}),o.appendChild(e.el),e.el),b=v(i.mkPin()),v=v(i.mkHoverPin()),y=i.getRowName(f),w=i.getColName(g),S=i.getGroupName?i.getGroupName(f,g):null,b={el:b,hoverEl:v,cx:t,cy:s,row:y,col:w,group:S};a.push(b),r+=c(m,g)}d+=c(p,f)}return{g:o,allPins:a}}function G(){var e=U.svg.elt("rect");return U.svg.hydrate(e,{class:"sim-bb-pin",rx:2,ry:2,width:6,height:6}),{el:e,w:6,h:6,x:0,y:0}}function j(){var e=U.svg.elt("rect"),t=6*1.3;return U.svg.hydrate(e,{class:"sim-bb-pin-hover",rx:2,ry:2,width:t,height:t}),{el:e,w:t,h:t,x:0,y:0}}function H(e,t,r,s,i,n,a){let o=V.mkTxt(e,t,r,s,i),l=(U.U.addClass(o,"sim-bb-label"),a&&a.forEach(e=>U.U.addClass(o,e)),V.mkTxt(e,t,1.3*r,s,i));return U.U.addClass(l,"sim-bb-label-hover"),a&&a.forEach(e=>U.U.addClass(l,e)),{el:o,hoverEl:l,txt:i,group:n}}V.getColumnName=N,V.getRowName=q,V.mkGrid=W,V.Breadboard=class{constructor(e){this.allPins=[],this.allLabels=[],this.allPowerBars=[],this.rowColToPin={},this.rowColToLbls={},this.buildDom(),e.wireframe&&U.U.addClass(this.bb,"sim-bb-outline")}hide(){this.bb.style.display="none"}updateLocation(e,t){U.svg.hydrate(this.bb,{x:e+"px",y:t+"px"})}getPin(e,t){e=this.rowColToPin[e];return e&&e[t]||null}getCoord(e){var{row:e,col:t,xOffset:r,yOffset:s}=e,e=this.getPin(e,t);return e?[e.cx+15*(r||0),e.cy+15*(s||0)]:null}getPinDist(){return 15}buildDom(){this.bb=U.svg.elt("svg",{version:"1.0",viewBox:`0 0 ${C} `+R,class:"sim-bb",width:C+"px",height:R+"px"}),this.styleEl=U.svg.child(this.bb,"style",{}),this.styleEl.textContent+='\n        /* bread board */\n        .sim-bb-background {\n            fill:#E0E0E0;\n        }\n        .sim-bb-pin {\n            fill:#999;\n        }\n        .sim-bb-pin-hover {\n            visibility: hidden;\n            pointer-events: all;\n            stroke-width: 7.5px;\n            stroke: transparent;\n            fill: #777;\n        }\n        .sim-bb-pin-hover:hover {\n            visibility: visible;\n            fill:#444;\n        }\n        .sim-bb-group-wire {\n            stroke: #999;\n            stroke-width: 3.75px;\n            visibility: hidden;\n        }\n        .sim-bb-pin-group {\n            pointer-events: all;\n        }\n        .sim-bb-label,\n        .sim-bb-label-hover {\n            font-family:"Lucida Console", Monaco, monospace;\n            fill:#555;\n            pointer-events: all;\n            stroke-width: 0;\n            cursor: default;\n        }\n        .sim-bb-label-hover {\n            visibility: hidden;\n            fill:#000;\n            font-weight: bold;\n        }\n        .sim-bb-bar {\n            stroke-width: 0;\n        }\n        .sim-bb-blue {\n            fill:#1AA5D7;\n            stroke:#1AA5D7\n        }\n        .sim-bb-red {\n            fill:#DD4BA0;\n            stroke:#DD4BA0;\n        }\n        .sim-bb-pin-group:hover .sim-bb-pin-hover,\n        .sim-bb-pin-group:hover .sim-bb-group-wire,\n        .sim-bb-pin-group:hover .sim-bb-label-hover {\n            visibility: visible;\n        }\n        .sim-bb-pin-group:hover .sim-bb-label {\n            visibility: hidden;\n        }\n        /* outline mode */\n        .sim-bb-outline .sim-bb-background {\n            stroke-width: 2.142857142857143px;\n            fill: #FFF;\n            stroke: #000;\n        }\n        .sim-bb-outline .sim-bb-mid-channel {\n            fill: #FFF;\n            stroke: #888;\n            stroke-width: 2px;\n        }\n        /* grayed out */\n        .grayed .sim-bb-background {\n            stroke-width: 3px;\n        }\n        .grayed .sim-bb-red,\n        .grayed .sim-bb-blue {\n            fill: #BBB;\n        }\n        .grayed .sim-bb-bar {\n            fill: #FFF;\n        }\n        .grayed .sim-bb-pin {\n            fill: #000;\n            stroke: #FFF;\n            stroke-width: 3px;\n        }\n        .grayed .sim-bb-label {\n            fill: none;\n        }\n        .grayed .sim-bb-background {\n            stroke-width: 7.5px;\n            stroke: #555;\n        }\n        .grayed .sim-bb-group-wire {\n            stroke: #DDD;\n        }\n        .grayed .sim-bb-channel {\n            visibility: hidden;\n        }\n        /* highlighted */\n        .sim-bb-label.highlight {\n            visibility: hidden;\n        }\n        .sim-bb-label-hover.highlight {\n            visibility: visible;\n        }\n        .sim-bb-blue.highlight {\n            fill:#1AA5D7;\n        }\n        .sim-bb-red.highlight {\n            fill:#DD4BA0;\n        }\n        .sim-bb-bar.highlight {\n            stroke-width: 0px;\n        }\n        ',this.defs=U.svg.child(this.bb,"defs",{}),U.svg.child(this.bb,"rect",{class:"sim-bb-background",width:C,height:R,rx:4.5,ry:4.5});let s="sim-bb-channel-grad";var e=U.svg.elt("linearGradient"),e=(U.svg.hydrate(e,{id:s,x1:"0%",y1:"0%",x2:"0%",y2:"100%"}),this.defs.appendChild(e),U.svg.child(e,"stop",{offset:"0%",style:"stop-color: #AAA;"}),U.svg.child(e,"stop",{offset:"20%",style:"stop-color: #CCC;"}),U.svg.child(e,"stop",{offset:"80%",style:"stop-color: #CCC;"}),U.svg.child(e,"stop",{offset:"100%",style:"stop-color: #AAA;"}),(e,t,r)=>{r=U.svg.child(this.bb,"rect",{class:"sim-bb-channel "+(r||""),y:e-t/2,width:C,height:t});return r.setAttribute("fill",`url(#${s})`),r});e(T+k/2,15,"sim-bb-mid-channel"),e(T,.75,"sim-bb-sml-channel"),e(T+k,.75,"sim-bb-sml-channel");let r=e=>e<V.BREADBOARD_MID_ROWS/2?"b":"t",i=e=>e<25?"b":"t";var t=(e,t)=>""+r(e)+N(t);let n=e=>0===e?"-":"+";var e=(e,t)=>{t=i(t);return""+n(e)+t},a=W({xOffset:_,yOffset:P,rowCount:V.BREADBOARD_MID_ROWS,colCount:V.BREADBOARD_MID_COLS,pinDist:15,mkPin:G,mkHoverPin:j,getRowName:q,getColName:N,getGroupName:t,rowIdxsWithGap:x}),a=(a.g,this.allPins=this.allPins.concat(a.allPins),W({xOffset:B,yOffset:F,rowCount:2,colCount:25,pinDist:15,mkPin:G,mkHoverPin:j,getRowName:n,getColName:N,getGroupName:e,colIdxsWithGap:I})),a=(a.g,this.allPins=this.allPins.concat(a.allPins),W({xOffset:M,yOffset:D,rowCount:2,colCount:25,colStartIdx:25,pinDist:15,mkPin:G,mkHoverPin:j,getRowName:n,getColName:N,getGroupName:e,colIdxsWithGap:I.map(e=>e+25)})),o=(a.g,this.allPins=this.allPins.concat(a.allPins),this.allPins.forEach(e=>{var{el:e,row:t,col:r,hoverEl:s}=e,t=`(${t},${r})`;U.svg.hydrate(e,{title:t}),U.svg.hydrate(s,{title:t})}),this.allPins.forEach(e=>{let t=this.rowColToPin[e.row];(t=t||(this.rowColToPin[e.row]={}))[e.col]=e}),(e,t,r,s,i,n)=>{L;var[e,t]=this.getCoord({type:"breadboard",row:e,col:t});return H(e+r,t+s,10.5,-90,i,n)});for(let e=0;e<V.BREADBOARD_MID_COLS;e++){var l=N(e),u=o(O[0],l,0,-15,l,t(0,e)),u=(this.allLabels.push(u),V.BREADBOARD_MID_ROWS-1),l=o(q(u),l,0,15,l,t(u,e));this.allLabels.push(l)}for(let e=0;e<V.BREADBOARD_MID_ROWS;e++){var h=q(e),c=o(h,"1",-15,0,h),c=(this.allLabels.push(c),V.BREADBOARD_MID_COLS-1),c=o(h,N(c),15,0,h);this.allLabels.push(c)}let d=[H(13.05,T+k+12,30,L,"-",e(0,0),["sim-bb-blue"]),H(12,T+k+T-12,25.5,L,"+",e(1,0),["sim-bb-red"]),H(C-12+1.05,T+k+12,30,L,"-",e(0,24),["sim-bb-blue"]),H(C-12,T+k+T-12,25.5,L,"+",e(1,24),["sim-bb-red"])],p=(this.allLabels=this.allLabels.concat(d),[H(13.05,12,30,L,"-",e(0,25),["sim-bb-blue"]),H(12,T-12,25.5,L,"+",e(1,25),["sim-bb-red"]),H(C-12+1.05,12,30,L,"-",e(0,49),["sim-bb-blue"]),H(C-12,T-12,25.5,L,"+",e(1,49),["sim-bb-red"])]),m=(this.allLabels=this.allLabels.concat(p),{}),f=(this.allLabels.forEach(e=>{var t=e.txt;(m[t]=m[t]||[]).push(e)}),this.allPins.forEach(t=>{var{row:e,col:r}=t,s=this.rowColToLbls[e]||(this.rowColToLbls[e]={});let i=s[r]||(s[r]=[]);"-"===(s=t).row||"+"===s.row?Number(r)<=25?d.filter(e=>e.group==t.group).forEach(e=>i.push(e)):p.filter(e=>e.group==t.group).forEach(e=>i.push(e)):(m[e].forEach(e=>i.push(e)),m[r].forEach(e=>i.push(e)))}),22.5+A),g=3;var a=(f-A)/2,v=(e,t,r,s)=>{var i=U.svg.elt("rect"),s=(U.svg.hydrate(i,{class:"sim-bb-bar "+s,x:e,y:t-g/2,width:f,height:g}),{el:i,group:r});return s},v=[v(B-a,F-9,e(0,49),"sim-bb-blue"),v(B-a,15+F+9,e(1,49),"sim-bb-red"),v(M-a,D-9,e(0,0),"sim-bb-blue"),v(M-a,15+D+9,e(1,0),"sim-bb-red")];this.allPowerBars=this.allPowerBars.concat(v),this.allPowerBars.forEach(e=>this.bb.appendChild(e.el));let b=this.allPins.map(e=>e.group).filter((e,t,r)=>r.indexOf(e)==t),y=b.map(e=>U.svg.elt("g")),w=(y.forEach(e=>U.U.addClass(e,"sim-bb-pin-group")),y.forEach((e,t)=>U.U.addClass(e,"group-"+b[t])),{}),S=(b.forEach((e,t)=>w[e]=y[t]),{}),E=(this.allPins.forEach((e,t)=>{var r=e.group;(S[r]||(S[r]=[])).push(e)}),b.forEach(e=>{var t=S[e],[t,r]=[t.map(e=>e.cx),t.map(e=>e.cy)],s=e=>e.reduce((e,t)=>e<t?e:t),i=e=>e.reduce((e,t)=>t<e?e:t),[t,s,i,r]=[s(t),i(t),s(r),i(r)],n=U.svg.elt("rect"),s=Math.max(s-t,1e-4),r=Math.max(r-i,1e-4);U.svg.hydrate(n,{x:t,y:i,width:s,height:r}),U.U.addClass(n,"sim-bb-group-wire"),w[e].appendChild(n)}),this.allPins.forEach(e=>{var t=w[e.group];t.appendChild(e.el),t.appendChild(e.hoverEl)}),U.svg.elt("g"));U.svg.hydrate(E,{class:"sim-bb-group-misc"}),y.push(E),this.allLabels.forEach(e=>{var t;(e.group?((t=w[e.group]).appendChild(e.el),t):(E.appendChild(e.el),E)).appendChild(e.hoverEl)}),y.forEach(e=>this.bb.appendChild(e))}getSVGAndSize(){return{el:this.bb,y:0,x:0,w:C,h:R}}highlightLoc(e){var{row:e,col:t}=e,{}=this.rowColToPin[e][t];this.rowColToLbls[e][t].forEach(e=>{U.U.addClass(e.el,"highlight"),U.U.addClass(e.hoverEl,"highlight")})}}}})(pxsim=pxsim||{}),(f=>{{var g=f.visuals||(f.visuals={});g.BOARD_SYTLE=`
        .noselect {
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none;   /* Chrome/Safari/Opera */
            -khtml-user-select: none;    /* Konqueror */
            -moz-user-select: none;      /* Firefox */
            -ms-user-select: none;       /* Internet Explorer/Microsoft Edge */
            user-select: none;           /* Non-prefixed version, currently
                                            not supported by any browser */
        }

        .sim-board-pin {
            fill:#999;
            stroke:#000;
            stroke-width:${g.PIN_DIST/3}px;
        }
        .sim-board-pin-lbl {
            fill: #333;
        }
        .gray-cover {
            fill:#FFF;
            opacity: 0.3;
            stroke-width:0;
            visibility: hidden;
        }
        .sim-board-pin-hover {
            visibility: hidden;
            pointer-events: all;
            stroke-width:${g.PIN_DIST/6}px;
        }
        .sim-board-pin-hover:hover {
            visibility: visible;
        }
        .sim-board-pin-lbl {
            visibility: hidden;
        }
        .sim-board-outline .sim-board-pin-lbl {
            visibility: visible;
        }
        .sim-board-pin-lbl {
            fill: #555;
        }
        .sim-board-pin-lbl-hover {
            fill: red;
        }
        .sim-board-outline .sim-board-pin-lbl-hover {
            fill: black;
        }
        .sim-board-pin-lbl,
        .sim-board-pin-lbl-hover {
            font-family:"Lucida Console", Monaco, monospace;
            pointer-events: all;
            stroke-width: 0;
        }
        .sim-board-pin-lbl-hover {
            visibility: hidden;
        }
        .sim-board-outline .sim-board-pin-hover:hover + .sim-board-pin-lbl,
        .sim-board-pin-lbl.highlight {
            visibility: hidden;
        }
        .sim-board-outline .sim-board-pin-hover:hover + * + .sim-board-pin-lbl-hover,
        .sim-board-pin-lbl-hover.highlight {
            visibility: visible;
        }
        /* Graying out */
        .grayed .sim-board-pin-lbl:not(.highlight) {
            fill: #AAA;
        }
        .grayed .sim-board-pin:not(.highlight) {
            fill:#BBB;
            stroke:#777;
        }
        .grayed .gray-cover {
            visibility: inherit;
        }
        .grayed .sim-cmp:not(.notgrayed) {
            opacity: 0.3;
        }
        /* Highlighting */
        .sim-board-pin-lbl.highlight {
            fill: #000;
            font-weight: bold;
        }
        .sim-board-pin.highlight {
            fill:#999;
            stroke:#000;
        }
        `;let p=.7*g.PIN_DIST,m=1.5*p,r=.66666*g.PIN_DIST,s=.66666*g.PIN_DIST+g.PIN_DIST/3,i=0;class e{constructor(e){this.props=e,this.allPins=[],this.allLabels=[],this.pinNmToLbl={},this.pinNmToPin={},this.id=i++;let n=e.visualDef;var t=e.wireframe&&n.outlineImage?n.outlineImage:n.image,t=g.mkImageSVG({image:t,width:n.width,height:n.height,imageUnitDist:n.pinDist,targetUnitDist:g.PIN_DIST});let a=g.mkScaleFn(n.pinDist,g.PIN_DIST);this.width=t.w,this.height=t.h;t=t.el;this.element=f.svg.elt("svg"),f.svg.hydrate(this.element,{version:"1.0",viewBox:`0 0 ${this.width} `+this.height,class:"sim sim-board-id-"+this.id,x:"0px",y:"0px"}),e.wireframe&&f.U.addClass(this.element,"sim-board-outline"),this.style=f.svg.child(this.element,"style",{}),this.style.textContent+=g.BOARD_SYTLE,this.defs=f.svg.child(this.element,"defs",{}),this.g=f.svg.elt("g"),this.element.appendChild(this.g),this.g.appendChild(t),this.background=t,f.svg.hydrate(t,{class:"sim-board"});let o=()=>{var e=f.svg.elt("circle"),t=r;return f.svg.hydrate(e,{class:"sim-board-pin",r:t/2}),{el:e,w:t,h:t,x:0,y:0}},l=()=>{var e=f.svg.elt("circle"),t=s;return f.svg.hydrate(e,{class:"sim-board-pin-hover",r:t/2}),{el:e,w:t,h:t,x:0,y:0}},u=()=>{var e=f.svg.elt("rect"),t=r;return f.svg.hydrate(e,{class:"sim-board-pin",width:t,height:t}),{el:e,w:t,h:t,x:0,y:0}},h=()=>{var e=f.svg.elt("rect"),t=s;return f.svg.hydrate(e,{class:"sim-board-pin-hover",width:t,height:t}),{el:e,w:t,h:t,x:0,y:0}};e=n.pinBlocks.map((t,e)=>{var r=a(t.x)+g.PIN_DIST/2,s=a(t.y)+g.PIN_DIST/2,i=t.labels.length,r=g.mkGrid({xOffset:r,yOffset:s,rowCount:1,colCount:i,pinDist:g.PIN_DIST,mkPin:n.useCrocClips?o:u,mkHoverPin:n.useCrocClips?l:h,getRowName:()=>""+(e+1),getColName:e=>t.labels[e],getGroupName:()=>t.labels.join(" ")});r.allPins;return f.U.addClass(r.g,"sim-board-pin-group"),r});let c=[],d=(e.forEach((e,r)=>e.allPins.forEach((e,t)=>{this.allPins.push(e),c.push(n.pinBlocks[r])})),this.allPins.forEach(e=>{var t=e.col;f.svg.hydrate(e.el,{title:t}),f.svg.hydrate(e.hoverEl,{title:t})}),this.allPins.forEach(e=>{this.pinNmToPin[e.col]=e}),(e,t,r,s,i)=>{let n,a;n="below"===i?(i=.25*r*s.length,a=e,t+12+i):(i=.32*r*s.length,a=e,t-11-i);e=g.mkTxt(a,n,r,-90,s);return e});this.allLabels=this.allPins.map((e,t)=>{var r,s,i,t=c[t];return r=e.cx,s=e.cy,e=e.col,t=t.labelPosition||"above",i=d(r,s,p,e,t),f.U.addClass(i,"sim-board-pin-lbl"),r=d(r,s,m,e,t),f.U.addClass(r,"sim-board-pin-lbl-hover"),s={el:i,hoverEl:r,txt:e}}),this.allPins.forEach((e,t)=>{t=this.allLabels[t];this.pinNmToLbl[e.col]=t}),this.allPins.forEach((e,t)=>{t=this.allLabels[t];this.g.appendChild(e.el),this.g.appendChild(e.hoverEl),this.g.appendChild(t.el),this.g.appendChild(t.hoverEl)})}findPin(e){let t=this.pinNmToPin[e];return t=!t&&this.props.boardDef.gpioPinMap&&(e=this.props.boardDef.gpioPinMap[e])?this.pinNmToPin[e]:t}findPinLabel(e){let t=this.pinNmToLbl[e];return t=!t&&this.props.boardDef.gpioPinMap&&(e=this.props.boardDef.gpioPinMap[e])?this.pinNmToLbl[e]:t}getCoord(e){e=this.findPin(e);return e?[e.cx,e.cy]:null}mkGrayCover(e,t,r,s){var i=f.svg.elt("rect");return f.svg.hydrate(i,{x:e,y:t,width:r,height:s,class:"gray-cover"}),i}getView(){return{el:this.element,w:this.width,h:this.height,x:0,y:0}}getPinDist(){return g.PIN_DIST}highlightPin(e){var t=this.findPinLabel(e),e=this.findPin(e);t&&e&&(f.U.addClass(t.el,"highlight"),f.U.addClass(t.hoverEl,"highlight"),f.U.addClass(e.el,"highlight"),f.U.addClass(e.hoverEl,"highlight"))}}g.GenericBoardSvg=e}})(pxsim=pxsim||{}),(t=>{var r=t.visuals||(t.visuals={});function s(e){return r.mkImageSVG({image:e.image,width:e.width,height:e.height,imageUnitDist:e.pinDistance,targetUnitDist:r.PIN_DIST})}r.mkGenericPartSVG=s,r.GenericPart=class{constructor(e){this.style="",this.defs=[];e=s(e).el;this.element=t.svg.elt("g"),this.element.appendChild(e)}moveToCoord(e){r.translateEl(this.element,e)}init(e,t,r){}updateState(){}updateTheme(){}}})(pxsim=pxsim||{}),(f=>{var e;{var g=f.visuals||(f.visuals={});let a=g.PIN_DIST/2.5;function v(e){return e.replace(/\#/g,"-").replace(/\(/g,"-").replace(/\)/g,"-").replace(/\,/g,"-").replace(/\./g,"-").replace(/\s/g,"")}function b(e,t,r,s){var i=e=>e[0]+", "+e[1],[n,a]=e,[o,l]=t,u=l-a,e=f.svg.mkPath("sim-bb-wire",`M${i(e)} C${i([n,a+u*r])} ${i([o,l-u*r])} `+i(t));return f.U.addClass(e,"wire-stroke-"+s),e}function y(e,t,r){var s=e=>e[0]+", "+e[1],e=f.svg.mkPath("sim-bb-wire",`M${s(e)} L`+s(t));return f.U.addClass(e,"wire-stroke-"+r),e}function w(e,t){var r=g.PIN_DIST/4,s=f.svg.elt("circle"),i=e[0],e=e[1],n=a/2+r/2;return f.svg.hydrate(s,{cx:i,cy:e,r:n,class:"sim-bb-wire-end"}),f.U.addClass(s,"wire-fill-"+t),s.style["stroke-width"]=r+"px",s}function o(e,t){var r=.24*g.PIN_DIST,s=10*r,i=2*r,n=6*r,a=g.PIN_DIST/4,[e,o]=e,t=t?-1:1,l=f.svg.elt("g"),u=f.svg.elt("rect"),h=e-i/2,c=o-s/2,d=(f.svg.hydrate(u,{x:h,y:c,width:i,height:s,rx:.5,ry:.5,class:"sim-bb-wire-end"}),u.style["stroke-width"]=a+"px",f.svg.elt("rect")),o=o+t*(s/2+n/2)-n/2;return f.svg.hydrate(d,{x:e-r/2,y:o,width:r,height:n,class:"sim-bb-wire-bare-end"}),d.style.fill="#bbb",l.appendChild(d),l.appendChild(u),{el:l,x:h-a,y:Math.min(c,o),w:i+2*a,h:s+n}}function S(e,t){var r=.24*g.PIN_DIST,s=4*r,i=10*r,n=3.5*r,r=3.5*r,a=g.PIN_DIST/4,[e,o]=e,l=t?-1:1,u=f.svg.elt("g"),h=f.svg.elt("polygon"),c=e-s/2,d=o-i/2;var p=t?.15:.3,m=t?.7:1-.7,t=t?.3:.15,p=(f.svg.hydrate(h,{points:[[c+s*p,d],[c+s*(1-p),d],[c+s,d+i*m],[c+s*(1-t),d+i],[c+s*t,d+i],[c,d+i*m]].map(e=>e[0]+","+e[1]).join(" ")}),f.svg.hydrate(h,{rx:.5,ry:.5,class:"sim-bb-wire-end"}),h.style["stroke-width"]=a+"px",f.svg.elt("rect")),t=n,m=o+l*(i/2+t/2)-t/2;return f.svg.hydrate(p,{x:e-r/2,y:m,width:r,height:t,class:"sim-bb-wire-bare-end"}),u.appendChild(p),u.appendChild(h),{el:u,x:c-a,y:Math.min(d,m),w:s+2*a,h:i+t}}g.WIRES_CSS=`
        .sim-bb-wire {
            fill:none;
            stroke-linecap: round;
            stroke-width:${a}px;
            pointer-events: none;
        }
        .sim-bb-wire-end {
            stroke:#333;
            fill:#333;
        }
        .sim-bb-wire-bare-end {
            fill: #ccc;
        }
        .sim-bb-wire-hover {
            stroke-width: ${a}px;
            visibility: hidden;
            stroke-dasharray: ${g.PIN_DIST/10},${g.PIN_DIST/1.5};
            /*stroke-opacity: 0.4;*/
        }
        .grayed .sim-bb-wire-ends-g:not(.highlight) .sim-bb-wire-end {
            stroke: #777;
            fill: #777;
        }
        .grayed .sim-bb-wire:not(.highlight) {
            stroke: #CCC;
        }
        .sim-bb-wire-ends-g:hover .sim-bb-wire-end {
            stroke: red;
            fill: red;
        }
        .sim-bb-wire-ends-g:hover .sim-bb-wire-bare-end {
            stroke: #FFF;
            fill: #FFF;
        }
        `,(e=g.WireEndStyle||(g.WireEndStyle={}))[e.BBJumper=0]="BBJumper",e[e.OpenJumper=1]="OpenJumper",e[e.Croc=2]="Croc",g.mkWirePart=function(e,t,r=!1){var s=f.svg.elt("g"),[e,i]=e,n=[e-15,i-50],e=[e+15,i+50];t=g.mapWireColor(t);let a;return a=(r?S:o)(n,!0,t),i=((e,t,r)=>{let s=e=>e[0]+", "+e[1],[i,n]=e,[a,o]=t,l=o-n,u=[i,n+.8*l],h=[a,o-.8*l],c=f.svg.mkPath("sim-bb-wire",`M${s(e)} C${s(u)} ${s(h)} `+s(t));return c.style.stroke=r,{el:c,x:Math.min(i,a),y:Math.min(n,o),w:Math.abs(i-a),h:Math.abs(n-o)}})(n,e,t),r=o(e,!1),s.appendChild(i.el),s.appendChild(a.el),s.appendChild(r.el),n=Math.min(a.x,r.x),e=Math.max(a.x+a.w,r.x+r.w),t=Math.min(a.y,r.y),{el:s,x:n,y:t,w:e-n,h:Math.max(a.y+a.h,r.y+r.h)-t}};class t{constructor(e,t,r,s,i,n){this.nextWireId=0,this.styleEl=s,this.styleEl.textContent+=g.WIRES_CSS,this.underboard=e,this.overboard=t,this.boardEdges=r,this.getLocCoord=i,this.getPinStyle=n}indexOfMin(t){let r=0,s=t[0];for(let e=1;e<t.length;e++)t[e]<s&&(s=t[e],r=e);return r}closestEdgeIdx(t){var e=this.boardEdges.map(e=>Math.abs(t[1]-e));return this.indexOfMin(e)}closestEdge(e){return this.boardEdges[this.closestEdgeIdx(e)]}drawWire(s,i,e){var n=[],a=f.svg.child(this.overboard,"g",{class:"sim-bb-wire-group"}),o=e=>{var t=g.PIN_DIST/2,r=this.closestEdge(e);let s;return s=r-e[1]<0?r-t:r+t,[e[0],s]},l=this.nextWireId++,u=v(e),t=w(s,u),r=w(i,u),h=f.svg.child(a,"g",{class:"sim-bb-wire-ends-g"}),c=(h.appendChild(t),h.appendChild(r),this.closestEdgeIdx(s)),d=this.closestEdgeIdx(i);if(c==d){var p=y(s,i,u);a.appendChild(p),n.push(p)}else{p=o(s),o=o(i),s=y(s,p,u),i=y(i,o,u);let e,t,r=(t=!(1!=c&&2!=c||1!=d&&2!=d)?(e=b(p,o,.7,u),b(p,o,.7,u)):(e=y(p,o,u),y(p,o,u)),f.U.addClass(t,"sim-bb-wire-hover"),a.appendChild(s),n.push(s),a.appendChild(i),n.push(i),this.underboard.appendChild(e),n.push(e),a.appendChild(t),n.push(t),"sim-bb-wire-id-"+l);c=e=>f.U.addClass(e,r);c(h),c(t),this.styleEl.textContent+=`
                    .${r}:hover ~ .${r}.sim-bb-wire-hover {
                        visibility: visible;
                    }`}d=`
                .wire-stroke-${u} {
                    stroke: ${g.mapWireColor(e)};
                }
                .wire-fill-${u} {
                    fill: ${g.mapWireColor(e)};
                }
                `;return this.styleEl.textContent+=d,{endG:h,end1:t,end2:r,wires:n}}drawWireWithCrocs(s,i,e,n=!1){var a=[],o=f.svg.child(this.overboard,"g",{class:"sim-bb-wire-group"}),l=e=>{var t=g.PIN_DIST/2,r=this.closestEdge(e);let s;return s=r-e[1]<0?r-t:r+t,[e[0],s]},u=this.nextWireId++,h=v(e),t=w(s,h),c=i,[d,r]=i,d=([d,r]=i=[d,r+40],[d,r+-17]);let p;r=(p=(n?(e,t)=>{var r=.24*g.PIN_DIST,s=4*r,i=1.2*r,n=10*r,a=g.PIN_DIST/4,[e,o]=e,t=t?-1:1,l=f.svg.elt("g"),u=f.svg.elt("rect"),h=e-i/2,c=o+10-s/2,d=(f.svg.hydrate(u,{x:h,y:c,width:i,height:s,rx:.5,ry:.5,class:"sim-bb-wire-end"}),u.style["stroke-width"]=a+"px",f.svg.elt("rect")),o=o+10+t*(s/2+n/2)-n/2;return f.svg.hydrate(d,{x:e-r/2,y:o,width:r,height:n,class:"sim-bb-wire-bare-end"}),d.style.fill="#bbb",l.appendChild(d),l.appendChild(u),{el:l,x:h-a,y:Math.min(c,o),w:i+2*a,h:s+n}}:S)(d,!0)).el,n=f.svg.child(o,"g",{class:"sim-bb-wire-ends-g"}),n.appendChild(t),d=this.closestEdgeIdx(s),c=this.closestEdgeIdx(c);if(d==c){var m=y(s,i,h);o.appendChild(m),a.push(m)}else{m=l(s),l=y(s,m,h);let e,t,r=(t=!(1!=d&&2!=d||1!=c&&2!=c)?(e=b(m,i,.7,h),b(m,i,.7,h)):(e=y(m,i,h),y(m,i,h)),f.U.addClass(t,"sim-bb-wire-hover"),o.appendChild(l),a.push(l),this.underboard.appendChild(e),a.push(e),"sim-bb-wire-id-"+u);s=e=>f.U.addClass(e,r);s(n),s(t),this.styleEl.textContent+=`
                    .${r}:hover ~ .${r}.sim-bb-wire-hover {
                        visibility: visible;
                    }`}n.appendChild(r);d=`
                .wire-stroke-${h} {
                    stroke: ${g.mapWireColor(e)};
                }
                .wire-fill-${h} {
                    fill: ${g.mapWireColor(e)};
                }
                `;return this.styleEl.textContent+=d,{endG:n,end1:t,end2:r,wires:a}}checkWire(e,t){e=this.getLocCoord(e),t=this.getLocCoord(t);return!!e&&!!t}addWire(e,t,r){var s=this.getLocCoord(e),i=this.getLocCoord(t);if(s&&i){var n=this.getPinStyle(t);let e;return e="dalboard"==t.type&&"croc"==n?this.drawWireWithCrocs(s,i,r):this.drawWire(s,i,r)}f.debug(`unable to allocate wire for ${e} or `+t)}}g.WireFactory=t}})(pxsim=pxsim||{});