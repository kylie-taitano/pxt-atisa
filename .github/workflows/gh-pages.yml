name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
      
      - name: Install PXT CLI
        run: |
          sudo npm install -g pxt
      
      - name: Install dependencies
        run: |
          npm install
      
      - name: Clone pxt-core
        run: |
          if [ ! -d ../pxt ]; then
            git clone --depth=1 https://github.com/microsoft/pxt.git ../pxt
            cd ../pxt
            npm install
            npm run build
          fi
        working-directory: .
      
      - name: Clone pxt-common-packages
        run: |
          if [ ! -d ../pxt-common-packages ]; then
            git clone --depth=1 https://github.com/microsoft/pxt-common-packages.git ../pxt-common-packages
            cd ../pxt-common-packages
            npm install
          fi
        working-directory: .
      
      - name: Link pxt dependencies
        run: |
          rm -rf node_modules/pxt-core
          rm -rf node_modules/pxt-common-packages
          pxt link ../pxt
          pxt link ../pxt-common-packages
      
      - name: Build static package
        run: |
          pxt staticpkg --route pxt-atisa || true
      
      - name: Deploy to gh-pages
        if: success()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Save source static files BEFORE switching branches (git reset --hard wipes them)
          if [ -d "docs/static" ]; then
            mkdir -p /tmp/source-static
            cp -r docs/static/* /tmp/source-static/ 2>/dev/null || true
          fi
          
          # Create or checkout gh-pages branch
          git checkout --orphan gh-pages || git checkout gh-pages
          git reset --hard
          
          # Copy built files
          if [ -d "built/packaged/pxt-atisa" ]; then
            cp -r built/packaged/pxt-atisa/* .
            
            # Copy source static files (pxt staticpkg doesn't include them)
            if [ -d "/tmp/source-static" ]; then
              mkdir -p docs/static
              cp -r /tmp/source-static/* docs/static/ 2>/dev/null || true
            fi
            
            # Remove source docs files but keep docs/static/ (now has both MakeCode's + our source files)
            if [ -d "docs" ]; then
              find docs -mindepth 1 -maxdepth 1 ! -name "static" -exec rm -rf {} + 2>/dev/null || true
            fi
            rm -rf built node_modules pxt_modules libs .github .vscode .pxt
            rm -f .gitignore .cursorrules LICENSE README.md SECURITY.md .travis.yml .clang-format .gitattributes
            find . -name "*.md" -not -path "./docs/*" -delete || true
          fi
          
          # Ensure .nojekyll exists to bypass Jekyll processing for static assets
          touch .nojekyll
          
          # Final verification before commit
          echo "=== Verification: Static files ==="
          ls -la docs/static/logo.svg 2>/dev/null && echo "✅ logo.svg exists" || echo "❌ logo.svg missing"
          ls -la docs/static/Microsoft-logo* 2>/dev/null && echo "✅ Microsoft-logo files exist" || echo "❌ Microsoft-logo files missing"
          
          # Commit and push
          git add -A
          git commit -m "Deploy to GitHub Pages [skip ci]" || exit 0
          git push -f origin gh-pages || exit 0
